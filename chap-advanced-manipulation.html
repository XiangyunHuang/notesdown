<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 7 章 高级数据操作 | R 语言学习笔记</title>
<meta name="author" content="黄湘云">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="第 7 章 高级数据操作 | R 语言学习笔记">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/cover.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第 7 章 高级数据操作 | R 语言学习笔记">
<meta name="twitter:image" content="/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap/bootstrap.bundle.min.js"></script><script src="libs/bs3compat/transition.js"></script><script src="libs/bs3compat/tabs.js"></script><script src="libs/bs3compat/bs3compat.js"></script><link href="libs/bs4_book/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book/bs4_book.js"></script><script src="libs/htmlwidgets/htmlwidgets.js"></script><script src="libs/plotly-binding/plotly.js"></script><script src="libs/typedarray/typedarray.min.js"></script><link href="libs/crosstalk/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main/plotly-latest.min.js"></script><script src="libs/plotly-locale-zh-CN/zh-cn.js"></script><script src="libs/mathjax/cdn.js"></script><script src="libs/echarts4r/echarts-en.min.js"></script><script src="libs/echarts4r/ecStat.min.js"></script><script src="libs/echarts4r/dataTool.min.js"></script><script src="libs/echarts4r-binding/echarts4r.js"></script><script src="libs/d3/d3.min.js"></script><script src="libs/forceNetwork-binding/forceNetwork.js"></script><link href="libs/vis/vis-network.min.css" rel="stylesheet">
<script src="libs/vis/vis-network.min.js"></script><script src="libs/visNetwork-binding/visNetwork.js"></script><script src="libs/FileSaver/FileSaver.min.js"></script><script src="libs/Blob/Blob.js"></script><script src="libs/canvas-toBlob/canvas-toBlob.js"></script><script src="libs/html2canvas/html2canvas.js"></script><script src="libs/jspdf/jspdf.debug.js"></script><link href="libs/jquery-sparkline/jquery.sparkline.css" rel="stylesheet">
<script src="libs/jquery-sparkline/jquery.sparkline.js"></script><script src="libs/sparkline-binding/sparkline.js"></script><script src="libs/r2d3-render/r2d3-render.js"></script><script src="libs/webcomponents/webcomponents.js"></script><script src="libs/r2d3-binding/r2d3.js"></script><script src="libs/d3v6/d3.min.js"></script><script src="libs/kePrint/kePrint.js"></script><link href="libs/lightable/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-54GQKWF7VP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-54GQKWF7VP');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
<meta name="description" content='library(data.table) 介绍 data.table 处理数据的方式，对标 dplyr 的基本操作  7.1 基础介绍 # 用一个真实的数据集替换，让每一个操作都有实际含义和价值 mtcars DT &lt;- data.table(  x = rep(c("b", "a", "c"), each = 3),  v = c(1, 1, 1, 2, 2, 1, 1, 2, 2), ...'>
<meta property="og:description" content='library(data.table) 介绍 data.table 处理数据的方式，对标 dplyr 的基本操作  7.1 基础介绍 # 用一个真实的数据集替换，让每一个操作都有实际含义和价值 mtcars DT &lt;- data.table(  x = rep(c("b", "a", "c"), each = 3),  v = c(1, 1, 1, 2, 2, 1, 1, 2, 2), ...'>
<meta name="twitter:description" content='library(data.table) 介绍 data.table 处理数据的方式，对标 dplyr 的基本操作  7.1 基础介绍 # 用一个真实的数据集替换，让每一个操作都有实际含义和价值 mtcars DT &lt;- data.table(  x = rep(c("b", "a", "c"), each = 3),  v = c(1, 1, 1, 2, 2, 1, 1, 2, 2), ...'>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R 语言学习笔记</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">欢迎</a></li>
<li><a class="" href="chap-preface.html"><span class="header-section-number">1</span> 前言</a></li>
<li class="book-part">数据整理</li>
<li><a class="" href="chap-data-wrangling.html">介绍</a></li>
<li><a class="" href="chap-data-structure.html"><span class="header-section-number">2</span> 数据结构</a></li>
<li><a class="" href="chap-data-transportation.html"><span class="header-section-number">3</span> 数据搬运</a></li>
<li><a class="" href="chap-string-operations.html"><span class="header-section-number">4</span> 字符串操作</a></li>
<li><a class="" href="chap-regular-expressions.html"><span class="header-section-number">5</span> 正则表达式</a></li>
<li><a class="" href="chap-data-manipulation.html"><span class="header-section-number">6</span> 数据操作</a></li>
<li><a class="active" href="chap-advanced-manipulation.html"><span class="header-section-number">7</span> 高级数据操作</a></li>
<li><a class="" href="chap-parallel-manipulation.html"><span class="header-section-number">8</span> 并行化操作</a></li>
<li><a class="" href="chap-dplyr-manipulation.html"><span class="header-section-number">9</span> 净土化操作</a></li>
<li class="book-part">统计图形</li>
<li><a class="" href="chap-statistical-graphics.html">介绍</a></li>
<li><a class="" href="chap-graphics-foundations.html"><span class="header-section-number">10</span> 图形基础</a></li>
<li><a class="" href="chap-data-visualization.html"><span class="header-section-number">11</span> 数据可视化</a></li>
<li><a class="" href="chap-interactive-web-graphics.html"><span class="header-section-number">12</span> 交互图形</a></li>
<li class="book-part">统计计算</li>
<li><a class="" href="chap-statistical-computation.html">介绍</a></li>
<li><a class="" href="chap-numerical-optimization.html"><span class="header-section-number">13</span> 数值优化</a></li>
<li class="book-part">附录</li>
<li><a class="" href="chap-linux-command-bash.html"><span class="header-section-number">A</span> 命令行操作</a></li>
<li><a class="" href="references.html">参考文献</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/XiangyunHuang/notesdown">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-advanced-manipulation" class="section level1" number="7">
<h1>
<span class="header-section-number">第 7 章</span> 高级数据操作<a class="anchor" aria-label="anchor" href="#chap-advanced-manipulation"><i class="fas fa-link"></i></a>
</h1>
<div class="sourceCode" id="cb1029"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></code></pre></div>
<p>介绍 data.table 处理数据的方式，对标 dplyr 的基本操作</p>
<div id="intro" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> 基础介绍<a class="anchor" aria-label="anchor" href="#intro"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb1030"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 用一个真实的数据集替换，让每一个操作都有实际含义和价值 mtcars</span>
<span class="va">DT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"c"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
  v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,
  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span>, a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, b <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">1</span>
<span class="op">)</span>
<span class="va">DT</span></code></pre></div>
<pre><code>##    x v y a b
## 1: b 1 1 1 9
## 2: b 1 3 2 8
## 3: b 1 6 3 7
## 4: a 2 1 4 6
## 5: a 2 3 5 5
## 6: a 1 6 6 4
## 7: c 1 1 7 3
## 8: c 2 3 8 2
## 9: c 2 6 9 1</code></pre>
<div class="sourceCode" id="cb1032"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组求和</span>
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">y</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    y V1
## 1: 1  9
## 2: 0  4</code></pre>
<div class="sourceCode" id="cb1034"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span>bool <span class="op">=</span> <span class="va">y</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    bool V1
## 1:    1  9
## 2:    0  4</code></pre>
<div class="sourceCode" id="cb1036"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="co"># 每组第二行</span></code></pre></div>
<pre><code>##    x v y a b
## 1: b 1 3 2 8
## 2: a 2 3 5 5
## 3: c 2 3 8 2</code></pre>
<div class="sourceCode" id="cb1038"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fl">2</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="co"># 每组最后两行</span></code></pre></div>
<pre><code>##    x v y a b
## 1: b 1 3 2 8
## 2: b 1 6 3 7
## 3: a 2 3 5 5
## 4: a 1 6 6 4
## 5: c 2 3 8 2
## 6: c 2 6 9 1</code></pre>
<div class="sourceCode" id="cb1040"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 除了 x 列外，所有列都按 x 分组求和</span>
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">sum</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span></code></pre></div>
<pre><code>##    x v  y  a  b
## 1: b 3 10  6 24
## 2: a 5 10 15 15
## 3: c 5 10 24  6</code></pre>
<div class="sourceCode" id="cb1042"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 各个列都按 x 分组取最小</span>
<span class="va">DT</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="co"># 分组嵌套查询</span></code></pre></div>
<pre><code>##    x v y a b
## 1: b 1 1 1 9
## 2: a 1 6 6 4
## 3: c 1 1 7 3</code></pre>
<div class="sourceCode" id="cb1044"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>MySum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, MyMin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, MyMax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="co"># 表达式嵌套</span></code></pre></div>
<pre><code>##    x y MySum MyMin MyMax
## 1: b 1     2     1     1
## 2: b 0     1     1     1
## 3: a 1     4     2     2
## 4: a 0     1     1     1
## 5: c 1     3     1     2
## 6: c 0     2     2     2</code></pre>
<div class="sourceCode" id="cb1046"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>a <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">a</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="co"># 按 x 分组，将 a,b 两列的值列出来</span></code></pre></div>
<pre><code>##    x     a     b
## 1: b 1,2,3 9,8,7
## 2: a 4,5,6 6,5,4
## 3: c 7,8,9 3,2,1</code></pre>
<div class="sourceCode" id="cb1048"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>seq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="co"># 列操作不仅仅是聚合</span></code></pre></div>
<pre><code>##     x seq
##  1: b   1
##  2: b   2
##  3: b   3
##  4: b   4
##  5: b   5
##  6: b   6
##  7: b   7
##  8: b   8
##  9: b   9
## 10: a   4
## 11: a   5
## 12: a   6
## 13: c   7
## 14: c   6
## 15: c   5
## 16: c   4
## 17: c   3</code></pre>
<div class="sourceCode" id="cb1050"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 按 x 分组对 v 求和，然后过滤出和小于 20 的行</span>
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span><span class="op">[</span><span class="va">V1</span> <span class="op">&lt;</span> <span class="fl">20</span><span class="op">]</span> <span class="co"># 组合查询</span></code></pre></div>
<pre><code>##    x V1
## 1: b  3
## 2: a  5
## 3: c  5</code></pre>
<div class="sourceCode" id="cb1052"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">V1</span><span class="op">)</span><span class="op">]</span> <span class="co"># 对结果排序</span></code></pre></div>
<pre><code>##    x V1
## 1: a  5
## 2: c  5
## 3: b  3</code></pre>
<div class="sourceCode" id="cb1054"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="co"># 计算每一组的和，每一组的观测数</span></code></pre></div>
<pre><code>##    x N v  y  a  b
## 1: b 3 3 10  6 24
## 2: a 3 5 10 15 15
## 3: c 3 5 10 24  6</code></pre>
<div class="sourceCode" id="cb1056"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 两个复杂的操作，还没弄清楚这个技术存在的意义</span>
<span class="va">DT</span><span class="op">[</span>,
  <span class="op">{</span>
    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
    <span class="fu">.</span><span class="op">(</span>a <span class="op">=</span> <span class="va">a</span> <span class="op">-</span> <span class="va">tmp</span>, b <span class="op">=</span> <span class="va">b</span> <span class="op">-</span> <span class="va">tmp</span><span class="op">)</span>
  <span class="op">}</span>,
  by <span class="op">=</span> <span class="va">x</span>
<span class="op">]</span> <span class="co"># anonymous lambda in 'j', j accepts any valid</span></code></pre></div>
<pre><code>##    x          a          b
## 1: b -2.3333333  5.6666667
## 2: b -1.3333333  4.6666667
## 3: b -0.3333333  3.6666667
## 4: a  0.6666667  2.6666667
## 5: a  1.6666667  1.6666667
## 6: a  2.6666667  0.6666667
## 7: c  3.6666667 -0.3333333
## 8: c  4.6666667 -1.3333333
## 9: c  5.6666667 -2.3333333</code></pre>
<div class="sourceCode" id="cb1058"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># using rleid, get max(y) and min of all cols in .SDcols for each consecutive run of 'v'</span>
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">min</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rleid.html">rleid</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="va">v</span><span class="op">:</span><span class="va">b</span><span class="op">]</span></code></pre></div>
<pre><code>##    rleid y v y a b
## 1:     1 6 1 1 1 7
## 2:     2 3 2 1 4 5
## 3:     3 6 1 1 6 3
## 4:     4 6 2 3 8 1</code></pre>
<div id="subsec-filter-i" class="section level3" number="7.1.1">
<h3>
<span class="header-section-number">7.1.1</span> 过滤<a class="anchor" aria-label="anchor" href="#subsec-filter-i"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1060"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></code></pre></div>
<p>过滤 cyl = 6 并且 gear = 4 的记录</p>
<div class="sourceCode" id="cb1061"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars_df</span><span class="op">[</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">gear</span> <span class="op">==</span> <span class="fl">4</span><span class="op">]</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4</code></pre>
<p>过滤操作是针对数据框的行（记录）</p>
<div class="sourceCode" id="cb1063"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars_df</span><span class="op">[</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">gear</span> <span class="op">==</span> <span class="fl">4</span>, <span class="fu">.</span><span class="op">(</span><span class="va">mpg</span>, <span class="va">disp</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##     mpg  disp
## 1: 21.0 160.0
## 2: 21.0 160.0
## 3: 19.2 167.6
## 4: 17.8 167.6</code></pre>
<div class="sourceCode" id="cb1065"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mtcars_df</span>, subset <span class="op">=</span> <span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">gear</span> <span class="op">==</span> <span class="fl">4</span>, select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">disp</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     mpg  disp
## 1: 21.0 160.0
## 2: 21.0 160.0
## 3: 19.2 167.6
## 4: 17.8 167.6</code></pre>
<div class="dplyr">
<div class="sourceCode" id="cb1067"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">gear</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">disp</span><span class="op">)</span></code></pre></div>
<pre><code>##                mpg  disp
## Mazda RX4     21.0 160.0
## Mazda RX4 Wag 21.0 160.0
## Merc 280      19.2 167.6
## Merc 280C     17.8 167.6</code></pre>
</div>
</div>
<div id="subsec-mutate-j" class="section level3" number="7.1.2">
<h3>
<span class="header-section-number">7.1.2</span> 变换<a class="anchor" aria-label="anchor" href="#subsec-mutate-j"><i class="fas fa-link"></i></a>
</h3>
<p>根据已有的列生成新的列，或者修改已有的列，一次只能修改一列</p>
<div class="sourceCode" id="cb1069"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars_df</span><span class="op">[</span>, <span class="va">mean_mpg</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="va">mean_disp</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">disp</span><span class="op">)</span><span class="op">]</span>
<span class="va">mtcars_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     mpg cyl disp  hp drat    wt  qsec vs am gear carb mean_mpg mean_disp
## 1: 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 20.09062  230.7219
## 2: 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 20.09062  230.7219
## 3: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 20.09062  230.7219
## 4: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 20.09062  230.7219
## 5: 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 20.09062  230.7219
## 6: 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 20.09062  230.7219</code></pre>
<div class="sourceCode" id="cb1071"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars_df</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>, mean_disp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">disp</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    mean_mpg mean_disp
## 1: 20.09062  230.7219</code></pre>
<div class="sourceCode" id="cb1073"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># mtcars_df[, .(mean_mpg := mean(mpg), mean_disp := mean(disp))] # 报错</span>
<span class="co"># 正确的姿势</span>
<span class="va">mtcars_df</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span>mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>, mean_disp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">disp</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">mpg</span>, <span class="va">disp</span>, <span class="va">mean_mpg</span>, <span class="va">mean_disp</span><span class="op">)</span><span class="op">]</span> |&gt;  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##     mpg disp mean_mpg mean_disp
## 1: 21.0  160 20.09062  230.7219
## 2: 21.0  160 20.09062  230.7219
## 3: 22.8  108 20.09062  230.7219
## 4: 21.4  258 20.09062  230.7219
## 5: 18.7  360 20.09062  230.7219
## 6: 18.1  225 20.09062  230.7219</code></pre>
<div class="sourceCode" id="cb1075"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>, mean_disp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">disp</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##   mean_mpg mean_disp
## 1 20.09062  230.7219</code></pre>
<div class="sourceCode" id="cb1077"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>, mean_disp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">disp</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">disp</span>, <span class="va">mean_mpg</span>, <span class="va">mean_disp</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##                    mpg disp mean_mpg mean_disp
## Mazda RX4         21.0  160 20.09062  230.7219
## Mazda RX4 Wag     21.0  160 20.09062  230.7219
## Datsun 710        22.8  108 20.09062  230.7219
## Hornet 4 Drive    21.4  258 20.09062  230.7219
## Hornet Sportabout 18.7  360 20.09062  230.7219
## Valiant           18.1  225 20.09062  230.7219</code></pre>
</div>
<div id="subsec-summarise-j" class="section level3" number="7.1.3">
<h3>
<span class="header-section-number">7.1.3</span> 聚合<a class="anchor" aria-label="anchor" href="#subsec-summarise-j"><i class="fas fa-link"></i></a>
</h3>
<p>分组统计 多个分组变量</p>
<div class="sourceCode" id="cb1079"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">mtcars_df</span>, <span class="va">cyl</span> <span class="op">~</span> <span class="va">gear</span>, value.var <span class="op">=</span> <span class="st">"mpg"</span>, fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##    cyl     3      4    5
## 1:   4 21.50 26.925 28.2
## 2:   6 19.75 19.750 19.7
## 3:   8 15.05    NaN 15.4</code></pre>
<div class="sourceCode" id="cb1081"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">gear</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##       3      4    5
## 4 21.50 26.925 28.2
## 6 19.75 19.750 19.7
## 8 15.05     NA 15.4</code></pre>
<div class="sourceCode" id="cb1083"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars_df</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cyl</span>, <span class="va">gear</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    cyl gear mean_mpg
## 1:   6    4   19.750
## 2:   4    4   26.925
## 3:   6    3   19.750
## 4:   8    3   15.050
## 5:   4    3   21.500
## 6:   4    5   28.200
## 7:   8    5   15.400
## 8:   6    5   19.700</code></pre>
<div class="sourceCode" id="cb1085"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mtcars_df</span>, <span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span> <span class="op">+</span> <span class="va">gear</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##   cyl gear    mpg
## 1   4    3 21.500
## 2   6    3 19.750
## 3   8    3 15.050
## 4   4    4 26.925
## 5   6    4 19.750
## 6   4    5 28.200
## 7   6    5 19.700
## 8   8    5 15.400</code></pre>
<div class="sourceCode" id="cb1087"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">gear</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 8 × 3
## # Groups:   cyl [3]
##     cyl  gear mean_mpg
##   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
## 1     4     3     21.5
## 2     4     4     26.9
## 3     4     5     28.2
## 4     6     3     19.8
## 5     6     4     19.8
## 6     6     5     19.7
## 7     8     3     15.0
## 8     8     5     15.4</code></pre>
</div>
<div id="subsec-setname" class="section level3" number="7.1.4">
<h3>
<span class="header-section-number">7.1.4</span> 命名<a class="anchor" aria-label="anchor" href="#subsec-setname"><i class="fas fa-link"></i></a>
</h3>
<p>修改列名，另存一份生效</p>
<div class="sourceCode" id="cb1089"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sub_mtcars_df</span> <span class="op">&lt;-</span> <span class="va">mtcars_df</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cyl</span>, <span class="va">gear</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">sub_mtcars_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"gear"</span>, <span class="st">"ave_mpg"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    cyl gear ave_mpg
## 1:   6    4  19.750
## 2:   4    4  26.925
## 3:   6    3  19.750
## 4:   8    3  15.050
## 5:   4    3  21.500
## 6:   4    5  28.200
## 7:   8    5  15.400
## 8:   6    5  19.700</code></pre>
<div class="sourceCode" id="cb1091"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 注意 sub_mtcars_df 并没有修改列名</span>
<span class="va">sub_mtcars_df</span></code></pre></div>
<pre><code>##    cyl gear mean_mpg
## 1:   6    4   19.750
## 2:   4    4   26.925
## 3:   6    3   19.750
## 4:   8    3   15.050
## 5:   4    3   21.500
## 6:   4    5   28.200
## 7:   8    5   15.400
## 8:   6    5   19.700</code></pre>
<p>修改列名并直接起作用，在原来的数据集上生效</p>
<div class="sourceCode" id="cb1093"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">sub_mtcars_df</span>, old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mean_mpg"</span><span class="op">)</span>, new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ave_mpg"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># sub_mtcars_df 已经修改了列名</span>
<span class="va">sub_mtcars_df</span></code></pre></div>
<pre><code>##    cyl gear ave_mpg
## 1:   6    4  19.750
## 2:   4    4  26.925
## 3:   6    3  19.750
## 4:   8    3  15.050
## 5:   4    3  21.500
## 6:   4    5  28.200
## 7:   8    5  15.400
## 8:   6    5  19.700</code></pre>
<p>修改列名最好使用 <strong>data.table</strong> 包的函数 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames()</a></code> 明确指出了要修改的列名，</p>
</div>
<div id="subsec-order-by-j" class="section level3" number="7.1.5">
<h3>
<span class="header-section-number">7.1.5</span> 排序<a class="anchor" aria-label="anchor" href="#subsec-order-by-j"><i class="fas fa-link"></i></a>
</h3>
<p>按照某（些）列从大到小或从小到大的顺序排列， 先按 cyl 升序，然后按 gear 降序</p>
<div class="sourceCode" id="cb1095"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars_df</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">mpg</span>, <span class="va">cyl</span>, <span class="va">gear</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">4</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="op">-</span><span class="va">gear</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##      mpg cyl gear
##  1: 26.0   4    5
##  2: 30.4   4    5
##  3: 22.8   4    4
##  4: 24.4   4    4
##  5: 22.8   4    4
##  6: 32.4   4    4
##  7: 30.4   4    4
##  8: 33.9   4    4
##  9: 27.3   4    4
## 10: 21.4   4    4
## 11: 21.5   4    3</code></pre>
<div class="sourceCode" id="cb1097"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">cyl</span>, <span class="va">gear</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">gear</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##                 mpg cyl gear
## Porsche 914-2  26.0   4    5
## Lotus Europa   30.4   4    5
## Datsun 710     22.8   4    4
## Merc 240D      24.4   4    4
## Merc 230       22.8   4    4
## Fiat 128       32.4   4    4
## Honda Civic    30.4   4    4
## Toyota Corolla 33.9   4    4
## Fiat X1-9      27.3   4    4
## Volvo 142E     21.4   4    4
## Toyota Corona  21.5   4    3</code></pre>
</div>
<div id="subsec-reshape" class="section level3" number="7.1.6">
<h3>
<span class="header-section-number">7.1.6</span> 变形<a class="anchor" aria-label="anchor" href="#subsec-reshape"><i class="fas fa-link"></i></a>
</h3>
<p>melt 宽的变长的</p>
<div class="sourceCode" id="cb1099"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  i_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="cn">NA</span><span class="op">)</span>,
  i_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">9</span>, <span class="fl">10</span><span class="op">)</span>,
  f_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="cn">NA</span><span class="op">)</span>, <span class="fl">6</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
  f_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"z"</span>, <span class="st">"a"</span>, <span class="st">"x"</span>, <span class="st">"c"</span>, <span class="st">"x"</span>, <span class="st">"x"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  c_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="cn">NA</span><span class="op">)</span>, <span class="fl">6</span>, <span class="cn">TRUE</span><span class="op">)</span>,
  d_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="cn">NA</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, origin <span class="op">=</span> <span class="st">"2013-09-01"</span><span class="op">)</span>,
  d_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">1</span>, origin <span class="op">=</span> <span class="st">"2012-01-01"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb1100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DT</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">i_1</span>, <span class="va">i_2</span>, <span class="va">f_1</span>, <span class="va">f_2</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    i_1 i_2  f_1 f_2
## 1:   1  NA    c   z
## 2:   2   6    b   a
## 3:   3   7 &lt;NA&gt;   x
## 4:   4   8    b   c
## 5:   5   9    a   x
## 6:  NA  10    a   x</code></pre>
<div class="sourceCode" id="cb1102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span><span class="va">DT</span>, id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, measure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"f_1"</span>, <span class="st">"f_2"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     i_1 i_2 variable value
##  1:   1  NA      f_1     c
##  2:   2   6      f_1     b
##  3:   3   7      f_1  &lt;NA&gt;
##  4:   4   8      f_1     b
##  5:   5   9      f_1     a
##  6:  NA  10      f_1     a
##  7:   1  NA      f_2     z
##  8:   2   6      f_2     a
##  9:   3   7      f_2     x
## 10:   4   8      f_2     c
## 11:   5   9      f_2     x
## 12:  NA  10      f_2     x</code></pre>
<p>dcast 长的变宽的</p>
<div class="sourceCode" id="cb1104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sleep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">sleep</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">sleep</span>, <span class="va">group</span> <span class="op">~</span> <span class="va">ID</span>, value.var <span class="op">=</span> <span class="st">"extra"</span><span class="op">)</span></code></pre></div>
<pre><code>##    group   1    2    3    4    5   6   7   8   9  10
## 1:     1 0.7 -1.6 -0.2 -1.2 -0.1 3.4 3.7 0.8 0.0 2.0
## 2:     2 1.9  0.8  1.1  0.1 -0.1 4.4 5.5 1.6 4.6 3.4</code></pre>
<div class="sourceCode" id="cb1106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 如果有多个值</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">mtcars_df</span>, <span class="va">cyl</span> <span class="op">~</span> <span class="va">gear</span>, value.var <span class="op">=</span> <span class="st">"mpg"</span><span class="op">)</span></code></pre></div>
<pre><code>##    cyl  3 4 5
## 1:   4  1 8 2
## 2:   6  2 4 1
## 3:   8 12 0 2</code></pre>
<div class="sourceCode" id="cb1108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">mtcars_df</span>, <span class="va">cyl</span> <span class="op">~</span> <span class="va">gear</span>, value.var <span class="op">=</span> <span class="st">"mpg"</span>, fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##    cyl     3      4    5
## 1:   4 21.50 26.925 28.2
## 2:   6 19.75 19.750 19.7
## 3:   8 15.05    NaN 15.4</code></pre>
<p>tidyr 包提供数据变形的函数 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">tidyr::pivot_longer()</a></code> 和 <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">tidyr::pivot_wider()</a></code> 相比于 Base R 提供的 <code><a href="https://rdrr.io/r/stats/reshape.html">reshape()</a></code> 和 data.table 提供的 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt()</a></code> 和 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast()</a></code> 更加形象的命名</p>
<div class="sourceCode" id="cb1110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sleep</span>, names_from <span class="op">=</span> <span class="st">"ID"</span>, values_from <span class="op">=</span> <span class="st">"extra"</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 11
##   group   `1`   `2`   `3`   `4`   `5`   `6`   `7`   `8`   `9`  `10`
##   &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 1       0.7  -1.6  -0.2  -1.2  -0.1   3.4   3.7   0.8   0     2  
## 2 2       1.9   0.8   1.1   0.1  -0.1   4.4   5.5   1.6   4.6   3.4</code></pre>
<div class="sourceCode" id="cb1112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sleep</span>, v.names <span class="op">=</span> <span class="st">"extra"</span>, idvar <span class="op">=</span> <span class="st">"group"</span>, timevar <span class="op">=</span> <span class="st">"ID"</span>, direction <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span></code></pre></div>
<pre><code>##    group extra.1 extra.2 extra.3 extra.4 extra.5 extra.6 extra.7 extra.8
## 1:     1     0.7    -1.6    -0.2    -1.2    -0.1     3.4     3.7     0.8
## 2:     2     1.9     0.8     1.1     0.1    -0.1     4.4     5.5     1.6
##    extra.9 extra.10
## 1:     0.0      2.0
## 2:     4.6      3.4</code></pre>
<ul>
<li>
<code>idvar</code> 分组变量</li>
<li>
<code>timevar</code> 组内编号</li>
<li>
<code>v.names</code> 个体观察值</li>
<li>
<code>sep</code> 新的列名是由参数 <code>v.names</code> (extra) 和参数值 <code>timevar</code> (ID) 拼接起来的，默认 <code>sep = "."</code> 推荐使用下划线来做分割 <code>sep = "_"</code>
</li>
</ul>
<div class="sourceCode" id="cb1114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ToothGrowth</span><span class="op">)</span></code></pre></div>
<pre><code>##    len supp dose
## 1  4.2   VC  0.5
## 2 11.5   VC  0.5
## 3  7.3   VC  0.5
## 4  5.8   VC  0.5
## 5  6.4   VC  0.5
## 6 10.0   VC  0.5</code></pre>
<div class="sourceCode" id="cb1116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ToothGrowth</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">6</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span><span class="va">ToothGrowth</span>,
  v.names <span class="op">=</span> <span class="st">"len"</span>, idvar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"supp"</span>, <span class="st">"dose"</span><span class="op">)</span>,
  timevar <span class="op">=</span> <span class="st">"time"</span>, direction <span class="op">=</span> <span class="st">"wide"</span>
<span class="op">)</span></code></pre></div>
<pre><code>##    supp dose len.1 len.2 len.3 len.4 len.5 len.6 len.7 len.8 len.9 len.10
## 1    VC  0.5   4.2  11.5   7.3   5.8   6.4  10.0  11.2  11.2   5.2    7.0
## 11   VC  1.0  16.5  16.5  15.2  17.3  22.5  17.3  13.6  14.5  18.8   15.5
## 21   VC  2.0  23.6  18.5  33.9  25.5  26.4  32.5  26.7  21.5  23.3   29.5
## 31   OJ  0.5  15.2  21.5  17.6   9.7  14.5  10.0   8.2   9.4  16.5    9.7
## 41   OJ  1.0  19.7  23.3  23.6  26.4  20.0  25.2  25.8  21.2  14.5   27.3
## 51   OJ  2.0  25.5  26.4  22.4  24.5  24.8  30.9  26.4  27.3  29.4   23.0</code></pre>
<p>以数据集 ToothGrowth 为例，变量 supp（大组），dose（小组） 和 time（组内个体编号） 一起决定唯一的一个数据 len，特别适合纵向数据的变形操作</p>
</div>
<div id="subsec-group-by" class="section level3" number="7.1.7">
<h3>
<span class="header-section-number">7.1.7</span> 分组<a class="anchor" aria-label="anchor" href="#subsec-group-by"><i class="fas fa-link"></i></a>
</h3>
<p>分组切片，取每组第一个和最后一个值</p>
<div class="sourceCode" id="cb1118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Loblolly</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Seed</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">age</span>, <span class="va">Seed</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 28 × 3
## # Groups:   Seed [14]
##    height   age Seed 
##     &lt;dbl&gt; &lt;dbl&gt; &lt;ord&gt;
##  1   3.93     3 329  
##  2  56.4     25 329  
##  3   4.12     3 327  
##  4  56.8     25 327  
##  5   4.38     3 325  
##  6  58.5     25 325  
##  7   3.91     3 307  
##  8  59.1     25 307  
##  9   3.46     3 331  
## 10  59.5     25 331  
## # … with 18 more rows</code></pre>
<p><code><a href="https://dplyr.tidyverse.org/reference/slice.html">dplyr::slice()</a></code> 和函数 <code><a href="https://rdrr.io/r/base/slice.index.html">slice.index()</a></code> 有关系吗？</p>
</div>
<div id="subsec-merge" class="section level3" number="7.1.8">
<h3>
<span class="header-section-number">7.1.8</span> 合并<a class="anchor" aria-label="anchor" href="#subsec-merge"><i class="fas fa-link"></i></a>
</h3>
<p>合并操作对应于数据库中的连接操作， dplyr 包的哲学就来源于对数据库操作的进一步抽象， data.table 包的 merge 函数就对应为 dplyr 包的 join 函数</p>
<p><code><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">data.table::merge</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::join</a></code></p>
<p>给出一个表格，数据操作， data.table 实现， dplyr 实现</p>
<div class="sourceCode" id="cb1120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, X <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, key <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>
<span class="va">dt2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">14</span><span class="op">]</span>, Y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, key <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span><span class="op">(</span><span class="va">dt1</span>, <span class="va">dt2</span><span class="op">)</span> <span class="co"># 内连接</span></code></pre></div>
<pre><code>##    A  X Y
## 1: e  5 1
## 2: f  6 2
## 3: g  7 3
## 4: h  8 4
## 5: i  9 5
## 6: j 10 6</code></pre>
<p>参数 key 的作用相当于建立一个索引，通过它实现更快的数据操作速度</p>
<p><code>key = c("x","y","z")</code> 或者 <code>key = "x,y,z"</code> 其中 x,y,z 是列名</p>
<div class="sourceCode" id="cb1122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">band_members</span>, <span class="va">band_instruments</span>, package <span class="op">=</span> <span class="st">"dplyr"</span><span class="op">)</span>
<span class="va">band_members</span></code></pre></div>
<pre><code>## # A tibble: 3 × 2
##   name  band   
##   &lt;chr&gt; &lt;chr&gt;  
## 1 Mick  Stones 
## 2 John  Beatles
## 3 Paul  Beatles</code></pre>
<div class="sourceCode" id="cb1124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">band_instruments</span></code></pre></div>
<pre><code>## # A tibble: 3 × 2
##   name  plays 
##   &lt;chr&gt; &lt;chr&gt; 
## 1 John  guitar
## 2 Paul  bass  
## 3 Keith guitar</code></pre>
<div class="sourceCode" id="cb1126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">band_members</span>, <span class="va">band_instruments</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 3
##   name  band    plays 
##   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; 
## 1 John  Beatles guitar
## 2 Paul  Beatles bass</code></pre>
<p>list 列表里每个元素都是 data.frame 时，最适合用 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">data.table::rbindlist</a></code> 合并</p>
<div class="sourceCode" id="cb1128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 合并列表 https://recology.info/2018/10/limiting-dependencies/</span>
<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDF.html">setDF</a></span><span class="op">(</span>
    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="va">x</span>, use.names <span class="op">=</span> <span class="cn">TRUE</span>, fill <span class="op">=</span> <span class="cn">TRUE</span>, idcol <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<pre><code>## function(x) {
##   tibble::as_tibble((x &lt;- data.table::setDF(
##     data.table::rbindlist(x, use.names = TRUE, fill = TRUE, idcol = "id")
##   )
##   ))
## }</code></pre>
</div>
</div>
<div id="chap:data-manipulation" class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> 高频操作<a class="anchor" aria-label="anchor" href="#chap:data-manipulation"><i class="fas fa-link"></i></a>
</h2>
<p>以面向问题的方式介绍 Base R 提供的数据操作，然后过渡到 data.table，它是加强版的 Base R。</p>
<!-- data.table 和 HiveSQL/HQL 的等价表示 -->
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:single-table-verbs">表 7.1: </span> 单表的操作</caption>
<thead><tr class="header">
<th>base</th>
<th>dplyr</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>df[order(x), , drop = FALSE]</code></td>
<td><code>arrange(df, x)</code></td>
</tr>
<tr class="even">
<td>
<code>df[!duplicated(x), , drop = FALSE]</code>, <code><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique()</a></code>
</td>
<td><code>distinct(df, x)</code></td>
</tr>
<tr class="odd">
<td>
<code>df[x &amp; !is.na(x), , drop = FALSE]</code>, <code><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset()</a></code>
</td>
<td><code>filter(df, x)</code></td>
</tr>
<tr class="even">
<td>
<code>df$z &lt;- df$x + df$y</code>, <code><a href="https://Rdatatable.gitlab.io/data.table/reference/transform.data.table.html">transform()</a></code>
</td>
<td><code>mutate(df, z = x + y)</code></td>
</tr>
<tr class="odd">
<td><code>df$x</code></td>
<td><code>pull(df, x)</code></td>
</tr>
<tr class="even">
<td>N/A</td>
<td><code>rename(df, y = x)</code></td>
</tr>
<tr class="odd">
<td>
<code>df[c("x", "y")]</code>, <code><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset()</a></code>
</td>
<td><code>select(df, x, y)</code></td>
</tr>
<tr class="even">
<td><code>df[grepl(names(df), "^x")]</code></td>
<td><code>select(df, starts_with("x")</code></td>
</tr>
<tr class="odd">
<td><code>mean(df$x)</code></td>
<td><code>summarise(df, mean(x))</code></td>
</tr>
<tr class="even">
<td><code>df[c(1, 2, 5), , drop = FALSE]</code></td>
<td><code>slice(df, c(1, 2, 5))</code></td>
</tr>
</tbody>
</table></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:two-table-verbs">表 7.2: </span> 两表的操作</caption>
<thead><tr class="header">
<th>base</th>
<th>dplyr</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>merge(df1, df2)</code></td>
<td><code>inner_join(df1, df2)</code></td>
</tr>
<tr class="even">
<td><code>merge(df1, df2, all.x = TRUE)</code></td>
<td><code>left_join(df1, df2)</code></td>
</tr>
<tr class="odd">
<td><code>merge(df1, df2, all.y = TRUE)</code></td>
<td><code>right_join(df1, df2)</code></td>
</tr>
<tr class="even">
<td><code>merge(df1, df2, all = TRUE)</code></td>
<td><code>full_join(df1, df2)</code></td>
</tr>
<tr class="odd">
<td><code>df1[df1$x %in% df2$x, , drop = FALSE]</code></td>
<td><code>semi_join(df1, df2)</code></td>
</tr>
<tr class="even">
<td><code>df1[!df1$x %in% df2$x, , drop = FALSE]</code></td>
<td><code>anti_join(df1, df2)</code></td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb1130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "data.frame"</code></pre>
<div class="sourceCode" id="cb1132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="va">mtcars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "data.table" "data.frame"</code></pre>
<div id="sec-select" class="section level3" number="7.2.1">
<h3>
<span class="header-section-number">7.2.1</span> 选择多列<a class="anchor" aria-label="anchor" href="#sec-select"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># base</span>
<span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"gear"</span><span class="op">)</span><span class="op">]</span> |&gt;  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4</code></pre>
<div class="sourceCode" id="cb1136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data.table</span>
<span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"gear"</span><span class="op">)</span><span class="op">]</span> |&gt;  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4</code></pre>
<div class="sourceCode" id="cb1138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span>, <span class="va">gear</span><span class="op">)</span> |&gt;  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4</code></pre>
<p>反选多列，选择除了 cyl 和 gear 的列</p>
<div class="sourceCode" id="cb1140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 或者 mtcars[, setdiff(names(mtcars), c("cyl", "gear"))]</span>
<span class="va">mtcars</span><span class="op">[</span>, <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"gear"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> |&gt;  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>## [1]  TRUE FALSE  TRUE</code></pre>
<div class="sourceCode" id="cb1142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">mtcars</span>, select <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">gear</span><span class="op">)</span><span class="op">)</span> |&gt;  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##     mpg disp  hp drat    wt  qsec vs am carb
## 1: 21.0  160 110 3.90 2.620 16.46  0  1    4
## 2: 21.0  160 110 3.90 2.875 17.02  0  1    4
## 3: 22.8  108  93 3.85 2.320 18.61  1  1    1</code></pre>
</div>
<div id="sec-filter" class="section level3" number="7.2.2">
<h3>
<span class="header-section-number">7.2.2</span> 过滤多行<a class="anchor" aria-label="anchor" href="#sec-filter"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># base</span>
<span class="va">mtcars</span><span class="op">[</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">mtcars</span><span class="op">$</span><span class="va">gear</span> <span class="op">==</span> <span class="fl">4</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4</code></pre>
<div class="sourceCode" id="cb1146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">mtcars</span>, subset <span class="op">=</span> <span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">gear</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4</code></pre>
<div class="sourceCode" id="cb1148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data.table</span>
<span class="va">mtcars</span><span class="op">[</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">gear</span> <span class="op">==</span> <span class="fl">4</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4</code></pre>
<div class="sourceCode" id="cb1150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">gear</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4</code></pre>
</div>
<div id="sec-duplicated" class="section level3" number="7.2.3">
<h3>
<span class="header-section-number">7.2.3</span> 去重多行<a class="anchor" aria-label="anchor" href="#sec-duplicated"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># base</span>
<span class="va">mtcars</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"gear"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6</code></pre>
<div class="sourceCode" id="cb1154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data.table</span>
<span class="va">mtcars</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">mtcars</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"gear"</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6</code></pre>
<div class="sourceCode" id="cb1156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">mtcars</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"gear"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6</code></pre>
<div class="sourceCode" id="cb1158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span>, <span class="va">gear</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6</code></pre>
</div>
<div id="sec-merge" class="section level3" number="7.2.4">
<h3>
<span class="header-section-number">7.2.4</span> 合并操作<a class="anchor" aria-label="anchor" href="#sec-merge"><i class="fas fa-link"></i></a>
</h3>
<p>在数据库的操作中，合并又称为连接</p>
<div id="subsec-left-join" class="section level4" number="7.2.4.1">
<h4>
<span class="header-section-number">7.2.4.1</span> 左合并<a class="anchor" aria-label="anchor" href="#subsec-left-join"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb1160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr::inner_join()</span>
<span class="co"># dplyr::left_join()</span>
<span class="co"># dplyr::right_join()</span>
<span class="co"># dplyr::full_join()</span></code></pre></div>
</div>
<div id="subsec-right-join" class="section level4" number="7.2.4.2">
<h4>
<span class="header-section-number">7.2.4.2</span> 右合并<a class="anchor" aria-label="anchor" href="#subsec-right-join"><i class="fas fa-link"></i></a>
</h4>
</div>
</div>
<div id="sec-add-columns" class="section level3" number="7.2.5">
<h3>
<span class="header-section-number">7.2.5</span> 新添多列<a class="anchor" aria-label="anchor" href="#sec-add-columns"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span><span class="op">[</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span>, <span class="fu">`:=`</span><span class="op">(</span>disp_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">disp</span><span class="op">)</span>, hp_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">hp</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">6</span>, <span class="fu">.</span><span class="op">(</span><span class="va">cyl</span>, <span class="va">disp</span>, <span class="va">hp</span>, <span class="va">disp_mean</span>, <span class="va">hp_mean</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    cyl  disp  hp disp_mean  hp_mean
## 1:   6 160.0 110  183.3143 122.2857
## 2:   6 160.0 110  183.3143 122.2857
## 3:   6 258.0 110  183.3143 122.2857
## 4:   6 225.0 105  183.3143 122.2857
## 5:   6 167.6 123  183.3143 122.2857
## 6:   6 167.6 123  183.3143 122.2857
## 7:   6 145.0 175  183.3143 122.2857</code></pre>
</div>
<div id="sec-delete-columns" class="section level3" number="7.2.6">
<h3>
<span class="header-section-number">7.2.6</span> 删除多列<a class="anchor" aria-label="anchor" href="#sec-delete-columns"><i class="fas fa-link"></i></a>
</h3>
<p>删除列就是将该列的值清空，置为 NULL，下面将新添的两个列删除，根据列名的特点用正则表达式匹配</p>
<div class="sourceCode" id="cb1163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"_mean$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></code></pre></div>
</div>
<div id="sec-select-columns" class="section level3" number="7.2.7">
<h3>
<span class="header-section-number">7.2.7</span> 筛选多列<a class="anchor" aria-label="anchor" href="#sec-select-columns"><i class="fas fa-link"></i></a>
</h3>
<p>按照某一规则筛选多列</p>
<div class="sourceCode" id="cb1164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="va">iris</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fl">6</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:          5.1         3.5          1.4         0.2
## 2:          4.9         3.0          1.4         0.2
## 3:          4.7         3.2          1.3         0.2
## 4:          4.6         3.1          1.5         0.2
## 5:          5.0         3.6          1.4         0.2
## 6:          5.4         3.9          1.7         0.4</code></pre>
</div>
<div id="sec-modify-columns-type" class="section level3" number="7.2.8">
<h3>
<span class="header-section-number">7.2.8</span> 修改多列类型<a class="anchor" aria-label="anchor" href="#sec-modify-columns-type"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span><span class="op">[</span>, <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"disp"</span><span class="op">)</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">as.integer</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"disp"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></code></pre></div>
<pre><code>## Classes 'data.table' and 'data.frame':   32 obs. of  11 variables:
##  $ mpg : num  21 21 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 ...
##  $ cyl : int  6 6 4 6 8 6 8 4 4 6 ...
##  $ disp: int  160 160 108 258 360 225 360 146 140 167 ...
##  $ hp  : num  110 110 93 110 175 105 245 62 95 123 ...
##  $ drat: num  3.9 3.9 3.85 3.08 3.15 2.76 3.21 3.69 3.92 3.92 ...
##  $ wt  : num  2.62 2.88 2.32 3.21 3.44 ...
##  $ qsec: num  16.5 17 18.6 19.4 17 ...
##  $ vs  : num  0 0 1 1 0 1 0 1 1 1 ...
##  $ am  : num  1 1 1 0 0 0 0 0 0 0 ...
##  $ gear: num  4 4 4 3 3 3 3 4 4 4 ...
##  $ carb: num  4 4 1 1 2 1 4 2 2 4 ...
##  - attr(*, ".internal.selfref")=&lt;externalptr&gt; 
##  - attr(*, "index")= int(0)</code></pre>
</div>
<div id="sec-select-first-row" class="section level3" number="7.2.9">
<h3>
<span class="header-section-number">7.2.9</span> 取每组第一行<a class="anchor" aria-label="anchor" href="#sec-select-first-row"><i class="fas fa-link"></i></a>
</h3>
<p>先将 mtcars 按 cyl 升序，gear 降序排列，然后按 cyl, gear 和 am 分组取第一行</p>
<div class="sourceCode" id="cb1168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="op">-</span><span class="va">gear</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fl">1</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">gear</span>, <span class="va">am</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##     cyl gear am  mpg disp  hp drat    wt  qsec vs carb
##  1:   4    5  1 26.0  120  91 4.43 2.140 16.70  0    2
##  2:   4    4  1 22.8  108  93 3.85 2.320 18.61  1    1
##  3:   4    4  0 24.4  146  62 3.69 3.190 20.00  1    2
##  4:   4    3  0 21.5  120  97 3.70 2.465 20.01  1    1
##  5:   6    5  1 19.7  145 175 3.62 2.770 15.50  0    6
##  6:   6    4  1 21.0  160 110 3.90 2.620 16.46  0    4
##  7:   6    4  0 19.2  167 123 3.92 3.440 18.30  1    4
##  8:   6    3  0 21.4  258 110 3.08 3.215 19.44  1    1
##  9:   8    5  1 15.8  351 264 4.22 3.170 14.50  0    4
## 10:   8    3  0 18.7  360 175 3.15 3.440 17.02  0    2</code></pre>
<div class="sourceCode" id="cb1170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 或者</span>
<span class="va">mtcars</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="op">-</span><span class="va">gear</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">gear</span>, <span class="va">am</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##     cyl gear am  mpg disp  hp drat    wt  qsec vs carb
##  1:   4    5  1 26.0  120  91 4.43 2.140 16.70  0    2
##  2:   4    4  1 22.8  108  93 3.85 2.320 18.61  1    1
##  3:   4    4  0 24.4  146  62 3.69 3.190 20.00  1    2
##  4:   4    3  0 21.5  120  97 3.70 2.465 20.01  1    1
##  5:   6    5  1 19.7  145 175 3.62 2.770 15.50  0    6
##  6:   6    4  1 21.0  160 110 3.90 2.620 16.46  0    4
##  7:   6    4  0 19.2  167 123 3.92 3.440 18.30  1    4
##  8:   6    3  0 21.4  258 110 3.08 3.215 19.44  1    1
##  9:   8    5  1 15.8  351 264 4.22 3.170 14.50  0    4
## 10:   8    3  0 18.7  360 175 3.15 3.440 17.02  0    2</code></pre>
</div>
<div id="subsec-mom-vs-yoy" class="section level3" number="7.2.10">
<h3>
<span class="header-section-number">7.2.10</span> 计算环比同比<a class="anchor" aria-label="anchor" href="#subsec-mom-vs-yoy"><i class="fas fa-link"></i></a>
</h3>
<p>以数据集 AirPassengers 为例，重新整理后见表 <a href="chap-advanced-manipulation.html#tab:air-passengers">7.3</a></p>
<div class="sourceCode" id="cb1172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1949</span><span class="op">:</span><span class="fl">1960</span>, each <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,
  month <span class="op">=</span> <span class="va">month.abb</span>, num <span class="op">=</span> <span class="va">AirPassengers</span>
<span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span><span class="va">.</span>,
    v.names <span class="op">=</span> <span class="st">"num"</span>, idvar <span class="op">=</span> <span class="st">"year"</span>, timevar <span class="op">=</span> <span class="st">"month"</span>,
    direction <span class="op">=</span> <span class="st">"wide"</span>, sep <span class="op">=</span> <span class="st">""</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"(num)"</span>, replacement <span class="op">=</span> <span class="st">""</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">dat</span>, select <span class="op">=</span> <span class="va">year</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">air_passengers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">dat</span>, select <span class="op">=</span> <span class="op">-</span><span class="va">year</span><span class="op">)</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">air_passengers</span>,
  caption <span class="op">=</span> <span class="st">"1949-1960年国际航班乘客数量变化"</span>,
  align <span class="op">=</span> <span class="st">"c"</span>, row.names <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:air-passengers">表 7.3: </span>1949-1960年国际航班乘客数量变化</caption>
<thead><tr class="header">
<th align="left"></th>
<th align="center">Jan</th>
<th align="center">Feb</th>
<th align="center">Mar</th>
<th align="center">Apr</th>
<th align="center">May</th>
<th align="center">Jun</th>
<th align="center">Jul</th>
<th align="center">Aug</th>
<th align="center">Sep</th>
<th align="center">Oct</th>
<th align="center">Nov</th>
<th align="center">Dec</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1949</td>
<td align="center">112</td>
<td align="center">118</td>
<td align="center">132</td>
<td align="center">129</td>
<td align="center">121</td>
<td align="center">135</td>
<td align="center">148</td>
<td align="center">148</td>
<td align="center">136</td>
<td align="center">119</td>
<td align="center">104</td>
<td align="center">118</td>
</tr>
<tr class="even">
<td align="left">1950</td>
<td align="center">115</td>
<td align="center">126</td>
<td align="center">141</td>
<td align="center">135</td>
<td align="center">125</td>
<td align="center">149</td>
<td align="center">170</td>
<td align="center">170</td>
<td align="center">158</td>
<td align="center">133</td>
<td align="center">114</td>
<td align="center">140</td>
</tr>
<tr class="odd">
<td align="left">1951</td>
<td align="center">145</td>
<td align="center">150</td>
<td align="center">178</td>
<td align="center">163</td>
<td align="center">172</td>
<td align="center">178</td>
<td align="center">199</td>
<td align="center">199</td>
<td align="center">184</td>
<td align="center">162</td>
<td align="center">146</td>
<td align="center">166</td>
</tr>
<tr class="even">
<td align="left">1952</td>
<td align="center">171</td>
<td align="center">180</td>
<td align="center">193</td>
<td align="center">181</td>
<td align="center">183</td>
<td align="center">218</td>
<td align="center">230</td>
<td align="center">242</td>
<td align="center">209</td>
<td align="center">191</td>
<td align="center">172</td>
<td align="center">194</td>
</tr>
<tr class="odd">
<td align="left">1953</td>
<td align="center">196</td>
<td align="center">196</td>
<td align="center">236</td>
<td align="center">235</td>
<td align="center">229</td>
<td align="center">243</td>
<td align="center">264</td>
<td align="center">272</td>
<td align="center">237</td>
<td align="center">211</td>
<td align="center">180</td>
<td align="center">201</td>
</tr>
<tr class="even">
<td align="left">1954</td>
<td align="center">204</td>
<td align="center">188</td>
<td align="center">235</td>
<td align="center">227</td>
<td align="center">234</td>
<td align="center">264</td>
<td align="center">302</td>
<td align="center">293</td>
<td align="center">259</td>
<td align="center">229</td>
<td align="center">203</td>
<td align="center">229</td>
</tr>
<tr class="odd">
<td align="left">1955</td>
<td align="center">242</td>
<td align="center">233</td>
<td align="center">267</td>
<td align="center">269</td>
<td align="center">270</td>
<td align="center">315</td>
<td align="center">364</td>
<td align="center">347</td>
<td align="center">312</td>
<td align="center">274</td>
<td align="center">237</td>
<td align="center">278</td>
</tr>
<tr class="even">
<td align="left">1956</td>
<td align="center">284</td>
<td align="center">277</td>
<td align="center">317</td>
<td align="center">313</td>
<td align="center">318</td>
<td align="center">374</td>
<td align="center">413</td>
<td align="center">405</td>
<td align="center">355</td>
<td align="center">306</td>
<td align="center">271</td>
<td align="center">306</td>
</tr>
<tr class="odd">
<td align="left">1957</td>
<td align="center">315</td>
<td align="center">301</td>
<td align="center">356</td>
<td align="center">348</td>
<td align="center">355</td>
<td align="center">422</td>
<td align="center">465</td>
<td align="center">467</td>
<td align="center">404</td>
<td align="center">347</td>
<td align="center">305</td>
<td align="center">336</td>
</tr>
<tr class="even">
<td align="left">1958</td>
<td align="center">340</td>
<td align="center">318</td>
<td align="center">362</td>
<td align="center">348</td>
<td align="center">363</td>
<td align="center">435</td>
<td align="center">491</td>
<td align="center">505</td>
<td align="center">404</td>
<td align="center">359</td>
<td align="center">310</td>
<td align="center">337</td>
</tr>
<tr class="odd">
<td align="left">1959</td>
<td align="center">360</td>
<td align="center">342</td>
<td align="center">406</td>
<td align="center">396</td>
<td align="center">420</td>
<td align="center">472</td>
<td align="center">548</td>
<td align="center">559</td>
<td align="center">463</td>
<td align="center">407</td>
<td align="center">362</td>
<td align="center">405</td>
</tr>
<tr class="even">
<td align="left">1960</td>
<td align="center">417</td>
<td align="center">391</td>
<td align="center">419</td>
<td align="center">461</td>
<td align="center">472</td>
<td align="center">535</td>
<td align="center">622</td>
<td align="center">606</td>
<td align="center">508</td>
<td align="center">461</td>
<td align="center">390</td>
<td align="center">432</td>
</tr>
</tbody>
</table></div>
<p>横向计算环比，如1949年2月相比1月增长多少、3月相比2月增长多少，以此类推，就是计算环比？纵向计算同比，如1950年1月相比1949年1月增长多少、1951年相比1950年1月增长多少？</p>
<div class="sourceCode" id="cb1173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 环比横向/同比纵向</span>
<span class="va">mom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">x</span>, lag <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span> <span class="co"># month to month</span>
<span class="co"># 格式化输出</span>
<span class="va">format_mom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span><span class="op">(</span><span class="fu">mom</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">"f"</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb1174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://renkun-ken.github.io/formattable/">formattable</a></span><span class="op">)</span>
<span class="co"># 同比变化</span>
<span class="va">air_passengers</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span>, <span class="va">format_mom</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/formattable.html">formattable</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    Jan <span class="op">=</span> <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/color_tile.html">color_tile</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"pink"</span><span class="op">)</span>,
    Feb <span class="op">=</span> <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/color_tile.html">color_tile</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"springgreen4"</span><span class="op">)</span>,
    Mar <span class="op">=</span> <span class="va">percent</span>
  <span class="op">)</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT">DT</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">air_passengers</span><span class="op">)</span></code></pre></div>
</div>
<div id="sec-merge-multi-dfs" class="section level3" number="7.2.11">
<h3>
<span class="header-section-number">7.2.11</span> 合并多个数据框<a class="anchor" aria-label="anchor" href="#sec-merge-multi-dfs"><i class="fas fa-link"></i></a>
</h3>
<p>将所有列都保留，以 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code> 方式合并</p>
<div class="sourceCode" id="cb1175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df1</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span>
<span class="va">df2</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">11</span><span class="op">:</span><span class="fl">15</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span>
<span class="va">df3</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">16</span><span class="op">:</span><span class="fl">30</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span>
<span class="va">all_dfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span>, <span class="va">df3</span><span class="op">)</span>
<span class="co"># base</span>
<span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="va">all_dfs</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          4.3  setosa         3.0           NA
##  2:          4.4  setosa          NA           NA
##  3:          4.6  setosa          NA          1.0
##  4:          4.6  setosa          NA          1.0
##  5:          4.7  setosa          NA          1.6
##  6:          4.8  setosa         3.4          1.9
##  7:          4.8  setosa         3.0          1.9
##  8:          4.9  setosa          NA           NA
##  9:          4.9  setosa          NA           NA
## 10:          5.0  setosa          NA          1.6
## 11:          5.0  setosa          NA          1.6
## 12:          5.0  setosa          NA          1.6
## 13:          5.0  setosa          NA          1.6
## 14:          5.1  setosa          NA          1.4
## 15:          5.1  setosa          NA          1.5
## 16:          5.1  setosa          NA          1.5
## 17:          5.1  setosa          NA          1.7
## 18:          5.2  setosa          NA          1.5
## 19:          5.2  setosa          NA          1.4
## 20:          5.4  setosa         3.7          1.3
## 21:          5.4  setosa         3.7          1.7
## 22:          5.7  setosa          NA          1.5
## 23:          5.7  setosa          NA          1.7
## 24:          5.8  setosa         4.0           NA
##     Sepal.Length Species Sepal.Width Petal.Length</code></pre>
<div class="sourceCode" id="cb1177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr</span>
<span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span>, <span class="va">all_dfs</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          5.1  setosa          NA          1.4
##  2:          5.1  setosa          NA          1.5
##  3:          5.1  setosa          NA          1.5
##  4:          5.1  setosa          NA          1.7
##  5:          4.9  setosa          NA           NA
##  6:          4.7  setosa          NA          1.6
##  7:          4.6  setosa          NA          1.0
##  8:          5.0  setosa          NA          1.6
##  9:          5.0  setosa          NA          1.6
## 10:          5.4  setosa         3.7          1.3
## 11:          5.4  setosa         3.7          1.7
## 12:          4.6  setosa          NA          1.0
## 13:          5.0  setosa          NA          1.6
## 14:          5.0  setosa          NA          1.6
## 15:          4.4  setosa          NA           NA
## 16:          4.9  setosa          NA           NA
## 17:          4.8  setosa         3.4          1.9
## 18:          4.8  setosa         3.0          1.9
## 19:          4.3  setosa         3.0           NA
## 20:          5.8  setosa         4.0           NA
## 21:          5.7  setosa          NA          1.5
## 22:          5.7  setosa          NA          1.7
## 23:          5.2  setosa          NA          1.5
## 24:          5.2  setosa          NA          1.4
##     Sepal.Length Species Sepal.Width Petal.Length</code></pre>
<p>合并完应该有30行，为啥只有24行？这是因为 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge()</a></code> 函数对主键 key 相同的记录会合并，要想不合并，需要调用 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist()</a></code> 函数 <a href="https://d.cosx.org/d/421235" class="uri">https://d.cosx.org/d/421235</a></p>
<p><code><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind()</a></code> 列数相同的两个 data.frame 按行合并，<code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code> 行数相同的两个 data.frame 按列合并，<code><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge()</a></code> 对行、列数没有要求</p>
<div class="sourceCode" id="cb1179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="va">all_dfs</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          5.1  setosa          NA           NA
##  2:          4.9  setosa          NA           NA
##  3:          4.7  setosa          NA           NA
##  4:          4.6  setosa          NA           NA
##  5:          5.0  setosa          NA           NA
##  6:          5.4  setosa          NA           NA
##  7:          4.6  setosa          NA           NA
##  8:          5.0  setosa          NA           NA
##  9:          4.4  setosa          NA           NA
## 10:          4.9  setosa          NA           NA
## 11:          5.4  setosa         3.7           NA
## 12:          4.8  setosa         3.4           NA
## 13:          4.8  setosa         3.0           NA
## 14:          4.3  setosa         3.0           NA
## 15:          5.8  setosa         4.0           NA
## 16:          5.7  setosa          NA          1.5
## 17:          5.4  setosa          NA          1.3
## 18:          5.1  setosa          NA          1.4
## 19:          5.7  setosa          NA          1.7
## 20:          5.1  setosa          NA          1.5
## 21:          5.4  setosa          NA          1.7
## 22:          5.1  setosa          NA          1.5
## 23:          4.6  setosa          NA          1.0
## 24:          5.1  setosa          NA          1.7
## 25:          4.8  setosa          NA          1.9
## 26:          5.0  setosa          NA          1.6
## 27:          5.0  setosa          NA          1.6
## 28:          5.2  setosa          NA          1.5
## 29:          5.2  setosa          NA          1.4
## 30:          4.7  setosa          NA          1.6
##     Sepal.Length Species Sepal.Width Petal.Length</code></pre>
<div class="sourceCode" id="cb1181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">all_dfs</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          5.1  setosa          NA           NA
##  2:          4.9  setosa          NA           NA
##  3:          4.7  setosa          NA           NA
##  4:          4.6  setosa          NA           NA
##  5:          5.0  setosa          NA           NA
##  6:          5.4  setosa          NA           NA
##  7:          4.6  setosa          NA           NA
##  8:          5.0  setosa          NA           NA
##  9:          4.4  setosa          NA           NA
## 10:          4.9  setosa          NA           NA
## 11:          5.4  setosa         3.7           NA
## 12:          4.8  setosa         3.4           NA
## 13:          4.8  setosa         3.0           NA
## 14:          4.3  setosa         3.0           NA
## 15:          5.8  setosa         4.0           NA
## 16:          5.7  setosa          NA          1.5
## 17:          5.4  setosa          NA          1.3
## 18:          5.1  setosa          NA          1.4
## 19:          5.7  setosa          NA          1.7
## 20:          5.1  setosa          NA          1.5
## 21:          5.4  setosa          NA          1.7
## 22:          5.1  setosa          NA          1.5
## 23:          4.6  setosa          NA          1.0
## 24:          5.1  setosa          NA          1.7
## 25:          4.8  setosa          NA          1.9
## 26:          5.0  setosa          NA          1.6
## 27:          5.0  setosa          NA          1.6
## 28:          5.2  setosa          NA          1.5
## 29:          5.2  setosa          NA          1.4
## 30:          4.7  setosa          NA          1.6
##     Sepal.Length Species Sepal.Width Petal.Length</code></pre>
</div>
<div id="sec-multiple-aggregations" class="section level3" number="7.2.12">
<h3>
<span class="header-section-number">7.2.12</span> 分组聚合多个指标<a class="anchor" aria-label="anchor" href="#sec-multiple-aggregations"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://stackoverflow.com/questions/24151602/calculate-multiple-aggregations-with-lapply-sd" class="uri">https://stackoverflow.com/questions/24151602/calculate-multiple-aggregations-with-lapply-sd</a></p>
<div class="sourceCode" id="cb1183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># base</span>
<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">hp</span><span class="op">)</span> <span class="op">~</span> <span class="va">cyl</span>,
  FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##   cyl mpg.mean mpg.median   hp.mean hp.median
## 1   4 26.66364   26.00000  82.63636  91.00000
## 2   6 19.74286   19.70000 122.28571 110.00000
## 3   8 15.10000   15.20000 209.21429 192.50000</code></pre>
<div class="sourceCode" id="cb1185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 数据一致性 https://d.cosx.org/d/420763-base-r</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">hp</span><span class="op">)</span> <span class="op">~</span> <span class="va">cyl</span>, <span class="va">mtcars</span>,
    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind.data.frame</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">mpg</span>, <span class="va">hp</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##   cyl     mean median      mean median
## 1   4 26.66364   26.0  82.63636   91.0
## 2   6 19.74286   19.7 122.28571  110.0
## 3   8 15.10000   15.2 209.21429  192.5</code></pre>
<div class="sourceCode" id="cb1187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data.table</span>
<span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
    median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
by <span class="op">=</span> <span class="st">"cyl"</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mpg"</span>, <span class="st">"hp"</span><span class="op">)</span>
<span class="op">]</span></code></pre></div>
<pre><code>##    cyl mpg.mean mpg.median   hp.mean hp.median
## 1:   6 19.74286       19.7 122.28571     110.0
## 2:   4 26.66364       26.0  82.63636      91.0
## 3:   8 15.10000       15.2 209.21429     192.5</code></pre>
<div class="sourceCode" id="cb1189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr</span>
<span class="va">mtcars</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>, mean_hp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">hp</span><span class="op">)</span>,
    median_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>, median_hp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">hp</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 5
##     cyl mean_mpg mean_hp median_mpg median_hp
##   &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
## 1     4     26.7    82.6       26.7      82.6
## 2     6     19.7   122.        19.7     122. 
## 3     8     15.1   209.        15.1     209.</code></pre>
</div>
<div id="sec-rename-multi-cols" class="section level3" number="7.2.13">
<h3>
<span class="header-section-number">7.2.13</span> 重命名多个列<a class="anchor" aria-label="anchor" href="#sec-rename-multi-cols"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">hp</span><span class="op">)</span> <span class="op">~</span> <span class="va">cyl</span>,
  FUN <span class="op">=</span> <span class="va">median</span>
<span class="op">)</span>
<span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">tmp</span>, old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mpg"</span>, <span class="st">"hp"</span><span class="op">)</span>, new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"median_mpg"</span>, <span class="st">"median_hp"</span><span class="op">)</span><span class="op">)</span>
<span class="va">tmp</span></code></pre></div>
<pre><code>##    cyl median_mpg median_hp
## 1:   4       26.0      91.0
## 2:   6       19.7     110.0
## 3:   8       15.2     192.5</code></pre>
</div>
<div id="sec-sort-multi-cols" class="section level3" number="7.2.14">
<h3>
<span class="header-section-number">7.2.14</span> 对多个列依次排序<a class="anchor" aria-label="anchor" href="#sec-sort-multi-cols"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns" class="uri">https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns</a></p>
<div class="sourceCode" id="cb1193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># base</span>
<span class="va">tmp</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">median_mpg</span>, <span class="op">-</span><span class="va">median_hp</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##    cyl median_mpg median_hp
## 1:   8       15.2     192.5
## 2:   6       19.7     110.0
## 3:   4       26.0      91.0</code></pre>
<div class="sourceCode" id="cb1195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data.table</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="va">median_mpg</span>, <span class="op">-</span><span class="va">median_hp</span><span class="op">)</span>
<span class="co"># dplyr</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="va">median_mpg</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">median_hp</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    cyl median_mpg median_hp
## 1:   8       15.2     192.5
## 2:   6       19.7     110.0
## 3:   4       26.0      91.0</code></pre>
</div>
<div id="sec-rearrange-position-multi-cols" class="section level3" number="7.2.15">
<h3>
<span class="header-section-number">7.2.15</span> 重排多个列的位置<a class="anchor" aria-label="anchor" href="#sec-rearrange-position-multi-cols"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># https://stackoverflow.com/questions/19619666/change-column-position-of-data-table</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setcolorder.html">setcolorder</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"median_mpg"</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>, <span class="st">"median_mpg"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">tmp</span></code></pre></div>
<pre><code>##    median_mpg cyl median_hp
## 1:       15.2   8     192.5
## 2:       19.7   6     110.0
## 3:       26.0   4      91.0</code></pre>
<div class="sourceCode" id="cb1199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"median_mpg"</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>, <span class="st">"median_mpg"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    median_mpg cyl median_hp
## 1:       15.2   8     192.5
## 2:       19.7   6     110.0
## 3:       26.0   4      91.0</code></pre>
</div>
<div id="sec-tidy-output" class="section level3" number="7.2.16">
<h3>
<span class="header-section-number">7.2.16</span> 整理回归结果<a class="anchor" aria-label="anchor" href="#sec-tidy-output"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/split.html">split</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">dat</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Petal.Length</span> <span class="op">~</span> <span class="va">Sepal.Length</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="va">x</span><span class="op">$</span><span class="va">Species</span> <span class="op">&lt;-</span> <span class="va">y</span>
  <span class="va">x</span>
<span class="op">}</span>, <span class="va">mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">mod</span><span class="op">)</span>
<span class="va">mod</span></code></pre></div>
<pre><code>##                          Estimate Std. Error    t value     Pr(&gt;|t|)    Species
## setosa.(Intercept)      0.8030518 0.34387807  2.3352806 2.375647e-02     setosa
## setosa.Sepal.Length     0.1316317 0.06852690  1.9208760 6.069778e-02     setosa
## versicolor.(Intercept)  0.1851155 0.51421351  0.3599974 7.204283e-01 versicolor
## versicolor.Sepal.Length 0.6864698 0.08630708  7.9538056 2.586190e-10 versicolor
## virginica.(Intercept)   0.6104680 0.41710685  1.4635770 1.498279e-01  virginica
## virginica.Sepal.Length  0.7500808 0.06302606 11.9011203 6.297786e-16  virginica</code></pre>
<div class="sourceCode" id="cb1203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 管道操作</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/split.html">split</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Petal.Length</span> <span class="op">~</span> <span class="va">Sepal.Length</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    <span class="va">x</span><span class="op">$</span><span class="va">Species</span> <span class="op">&lt;-</span> <span class="va">y</span>
    <span class="va">x</span>
  <span class="op">}</span>, <span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">.</span><span class="op">)</span></code></pre></div>
<pre><code>##                          Estimate Std. Error    t value     Pr(&gt;|t|)    Species
## setosa.(Intercept)      0.8030518 0.34387807  2.3352806 2.375647e-02     setosa
## setosa.Sepal.Length     0.1316317 0.06852690  1.9208760 6.069778e-02     setosa
## versicolor.(Intercept)  0.1851155 0.51421351  0.3599974 7.204283e-01 versicolor
## versicolor.Sepal.Length 0.6864698 0.08630708  7.9538056 2.586190e-10 versicolor
## virginica.(Intercept)   0.6104680 0.41710685  1.4635770 1.498279e-01  virginica
## virginica.Sepal.Length  0.7500808 0.06302606 11.9011203 6.297786e-16  virginica</code></pre>
<div class="sourceCode" id="cb1205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dplyr 操作，需要 dplyr &gt;= 1.0.0 </span>
<span class="va">iris</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Species</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Petal.Length</span> <span class="op">~</span> <span class="va">Sepal.Length</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 6
## # Groups:   Species [3]
##   Species    term         estimate std.error statistic  p.value
##   &lt;fct&gt;      &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 setosa     (Intercept)     0.803    0.344      2.34  2.38e- 2
## 2 setosa     Sepal.Length    0.132    0.0685     1.92  6.07e- 2
## 3 versicolor (Intercept)     0.185    0.514      0.360 7.20e- 1
## 4 versicolor Sepal.Length    0.686    0.0863     7.95  2.59e-10
## 5 virginica  (Intercept)     0.610    0.417      1.46  1.50e- 1
## 6 virginica  Sepal.Length    0.750    0.0630    11.9   6.30e-16</code></pre>
</div>
<div id="sec-assignment-by-reference" class="section level3" number="7.2.17">
<h3>
<span class="header-section-number">7.2.17</span> <code>:=</code> 和 <code>.()</code><a class="anchor" aria-label="anchor" href="#sec-assignment-by-reference"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span><span class="op">[</span>, <span class="va">mpg_rate</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span><span class="op">)</span><span class="op">]</span>
<span class="va">mtcars</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">mpg_rate</span>, <span class="va">mpg</span>, <span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##     mpg_rate  mpg cyl vs am
##  1:    34.04 21.0   6  0  1
##  2:    34.04 21.0   6  0  1
##  3:    11.48 22.8   4  1  1
##  4:    27.97 21.4   6  1  0
##  5:    10.35 18.7   8  0  0
##  6:    23.66 18.1   6  1  0
##  7:     7.92 14.3   8  0  0
##  8:    35.52 24.4   4  1  0
##  9:    33.19 22.8   4  1  0
## 10:    25.10 19.2   6  1  0
## 11:    23.27 17.8   6  1  0
## 12:     9.08 16.4   8  0  0
## 13:     9.58 17.3   8  0  0
## 14:     8.42 15.2   8  0  0
## 15:     5.76 10.4   8  0  0
## 16:     5.76 10.4   8  0  0
## 17:     8.14 14.7   8  0  0
## 18:    16.31 32.4   4  1  1
## 19:    15.31 30.4   4  1  1
## 20:    17.07 33.9   4  1  1
## 21:    31.30 21.5   4  1  0
## 22:     8.58 15.5   8  0  0
## 23:     8.42 15.2   8  0  0
## 24:     7.36 13.3   8  0  0
## 25:    10.63 19.2   8  0  0
## 26:    13.75 27.3   4  1  1
## 27:   100.00 26.0   4  0  1
## 28:    15.31 30.4   4  1  1
## 29:    51.30 15.8   8  0  1
## 30:    31.93 19.7   6  0  1
## 31:    48.70 15.0   8  0  1
## 32:    10.78 21.4   4  1  1
##     mpg_rate  mpg cyl vs am</code></pre>
<div class="sourceCode" id="cb1209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mpg_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##     cyl vs am mpg_rate
##  1:   6  0  1    34.04
##  2:   6  0  1    34.04
##  3:   6  0  1    31.93
##  4:   4  1  1    11.48
##  5:   4  1  1    16.31
##  6:   4  1  1    15.31
##  7:   4  1  1    17.07
##  8:   4  1  1    13.75
##  9:   4  1  1    15.31
## 10:   4  1  1    10.78
## 11:   6  1  0    27.97
## 12:   6  1  0    23.66
## 13:   6  1  0    25.10
## 14:   6  1  0    23.27
## 15:   8  0  0    10.35
## 16:   8  0  0     7.92
## 17:   8  0  0     9.08
## 18:   8  0  0     9.58
## 19:   8  0  0     8.42
## 20:   8  0  0     5.76
## 21:   8  0  0     5.76
## 22:   8  0  0     8.14
## 23:   8  0  0     8.58
## 24:   8  0  0     8.42
## 25:   8  0  0     7.36
## 26:   8  0  0    10.63
## 27:   4  1  0    35.52
## 28:   4  1  0    33.19
## 29:   4  1  0    31.30
## 30:   4  0  1   100.00
## 31:   8  0  1    51.30
## 32:   8  0  1    48.70
##     cyl vs am mpg_rate</code></pre>
</div>
<div id="sec-remove-na" class="section level3" number="7.2.18">
<h3>
<span class="header-section-number">7.2.18</span> 去掉含有缺失值的记录<a class="anchor" aria-label="anchor" href="#sec-remove-na"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>, <span class="op">]</span> |&gt;  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 7    23     299  8.6   65     5   7
## 8    19      99 13.8   59     5   8</code></pre>
<div class="sourceCode" id="cb1213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 或着</span>
<span class="va">airquality</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="fl">1</span>, <span class="va">anyNA</span><span class="op">)</span>, <span class="op">]</span> |&gt;  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 7    23     299  8.6   65     5   7
## 8    19      99 13.8   59     5   8</code></pre>
</div>
<div id="sec-match-set" class="section level3" number="7.2.19">
<h3>
<span class="header-section-number">7.2.19</span> 集合操作<a class="anchor" aria-label="anchor" href="#sec-match-set"><i class="fas fa-link"></i></a>
</h3>
<p>match 和 <code>%in%</code>
<a href="https://d.cosx.org/d/421314" class="uri">https://d.cosx.org/d/421314</a></p>
<div class="sourceCode" id="cb1215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">`%nin%`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Negate</a></span><span class="op">(</span><span class="st">"%in%"</span><span class="op">)</span>
<span class="co"># `%in%` &lt;- function(x, table) match(x, table, nomatch = 0) &gt; 0 # %in% 函数的定义</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">letters</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>

<span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">y</span></code></pre></div>
<pre><code>## [1] FALSE FALSE  TRUE  TRUE  TRUE</code></pre>
<div class="sourceCode" id="cb1217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">%nin%</span> <span class="va">y</span></code></pre></div>
<pre><code>## [1]  TRUE  TRUE FALSE FALSE FALSE</code></pre>
<p>返回一个逻辑向量，x 中的元素匹配到了就返回 TRUE，否则 FALSE， <code>%nin%</code> 是 <code>%in%</code> 的取反效果</p>
<div class="sourceCode" id="cb1219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] NA NA  1  2  3</code></pre>
<p>x 在 y 中的匹配情况，匹配到了，就返回在 y 中匹配的位置，没有匹配到就返回 NA</p>
<div class="sourceCode" id="cb1221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "a" "b"</code></pre>
<div class="sourceCode" id="cb1223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html">intersect</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "c" "d" "e"</code></pre>
<div class="sourceCode" id="cb1225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html">union</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "a" "b" "c" "d" "e" "f" "g" "h"</code></pre>
</div>
<div id="transform-cut-aggregate" class="section level3" number="7.2.20">
<h3>
<span class="header-section-number">7.2.20</span> 对数值向量按既定分组计数<a class="anchor" aria-label="anchor" href="#transform-cut-aggregate"><i class="fas fa-link"></i></a>
</h3>
<p>此数据处理过程陆续使用了 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/transform.data.table.html">transform()</a></code>、<code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> 和 <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> 三个函数</p>
<div class="sourceCode" id="cb1227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 对数值向量按既定分组计数</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/transform.data.table.html">transform</a></span><span class="op">(</span><span class="va">dat</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">y</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, FUN <span class="op">=</span> <span class="va">length</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb1228"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/transform.data.table.html">transform</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">y</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span>, <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, FUN <span class="op">=</span> <span class="va">length</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/DT/man/DT-imports.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>对数值向量按分位数分组计数</p>
<div class="sourceCode" id="cb1229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/transform.data.table.html">transform</a></span><span class="op">(</span><span class="va">dat</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">y</span>,
  breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">y</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.25</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>

<span class="co"># dat &lt;- transform(dat, x = cut(</span>
<span class="co">#   x = y,</span>
<span class="co">#   breaks = quantile(y, prob = seq(0, 1, 0.25)),</span>
<span class="co">#   include.lowest = T</span>
<span class="co"># ))</span>

<span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, FUN <span class="op">=</span> <span class="va">length</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb1230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="aggregate-order" class="section level3" number="7.2.21">
<h3>
<span class="header-section-number">7.2.21</span> 分组排序<a class="anchor" aria-label="anchor" href="#aggregate-order"><i class="fas fa-link"></i></a>
</h3>
<p>按变量 a 分组计算，之后按变量 b 降序排列</p>
<div class="sourceCode" id="cb1231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">Sepal.Width</span>, <span class="va">Sepal.Length</span><span class="op">)</span> <span class="op">~</span> <span class="va">Species</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>
<span class="co"># 按 Species 降序排列</span>
<span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Species</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##      Species Sepal.Width Sepal.Length
## 3  virginica       2.974        6.588
## 2 versicolor       2.770        5.936
## 1     setosa       3.428        5.006</code></pre>
</div>
<div id="lapply-split-order" class="section level3" number="7.2.22">
<h3>
<span class="header-section-number">7.2.22</span> 分组获取 Top 值<a class="anchor" aria-label="anchor" href="#lapply-split-order"><i class="fas fa-link"></i></a>
</h3>
<p>分组按既定规律取数，比如按 Species 分组取 Top 6</p>
<div class="sourceCode" id="cb1233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组取前6个</span>
<span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind.data.frame"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iris</span>, <span class="op">~</span><span class="va">Species</span><span class="op">)</span>, <span class="va">head</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb1234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组取 Top 6</span>
<span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/split.html">split</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>,
  FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">Sepal.Length</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="op">]</span>, <span class="fl">6</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
##  1:          5.8         4.0          1.2         0.2     setosa
##  2:          5.7         4.4          1.5         0.4     setosa
##  3:          5.7         3.8          1.7         0.3     setosa
##  4:          5.5         4.2          1.4         0.2     setosa
##  5:          5.5         3.5          1.3         0.2     setosa
##  6:          5.4         3.9          1.7         0.4     setosa
##  7:          7.0         3.2          4.7         1.4 versicolor
##  8:          6.9         3.1          4.9         1.5 versicolor
##  9:          6.8         2.8          4.8         1.4 versicolor
## 10:          6.7         3.1          4.4         1.4 versicolor
## 11:          6.7         3.0          5.0         1.7 versicolor
## 12:          6.7         3.1          4.7         1.5 versicolor
## 13:          7.9         3.8          6.4         2.0  virginica
## 14:          7.7         3.8          6.7         2.2  virginica
## 15:          7.7         2.6          6.9         2.3  virginica
## 16:          7.7         2.8          6.7         2.0  virginica
## 17:          7.7         3.0          6.1         2.3  virginica
## 18:          7.6         3.0          6.6         2.1  virginica</code></pre>
</div>
<div id="lapply-split-sample" class="section level3" number="7.2.23">
<h3>
<span class="header-section-number">7.2.23</span> 分组抽样<a class="anchor" aria-label="anchor" href="#lapply-split-sample"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组抽样</span>
<span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/split.html">split</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>,
  FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>, <span class="op">]</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
##  1:          5.2         3.5          1.5         0.2     setosa
##  2:          5.1         3.8          1.9         0.4     setosa
##  3:          4.9         3.1          1.5         0.1     setosa
##  4:          5.1         3.4          1.5         0.2     setosa
##  5:          5.1         3.5          1.4         0.2     setosa
##  6:          5.0         3.4          1.5         0.2     setosa
##  7:          5.6         2.5          3.9         1.1 versicolor
##  8:          6.6         3.0          4.4         1.4 versicolor
##  9:          6.7         3.1          4.7         1.5 versicolor
## 10:          5.7         2.9          4.2         1.3 versicolor
## 11:          4.9         2.4          3.3         1.0 versicolor
## 12:          6.3         2.3          4.4         1.3 versicolor
## 13:          6.4         2.8          5.6         2.2  virginica
## 14:          7.1         3.0          5.9         2.1  virginica
## 15:          7.7         2.8          6.7         2.0  virginica
## 16:          6.1         2.6          5.6         1.4  virginica
## 17:          6.4         3.1          5.5         1.8  virginica
## 18:          6.9         3.1          5.4         2.1  virginica</code></pre>
</div>
<div id="lapply-split-quantile" class="section level3" number="7.2.24">
<h3>
<span class="header-section-number">7.2.24</span> 分组计算分位数<a class="anchor" aria-label="anchor" href="#lapply-split-quantile"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组计算分位数，如何分组呢</span>
<span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">class</span><span class="op">)</span> <span class="op">==</span> <span class="st">"numeric"</span><span class="op">]</span>, <span class="va">quantile</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##              0% 25% 50% 75% 100%
## Sepal.Length  1   1   1   1    1
## Sepal.Width   1   1   1   1    1
## Petal.Length  1   1   1   1    1
## Petal.Width   1   1   1   1    1
## Species       0   0   0   0    0</code></pre>
<div class="sourceCode" id="cb1240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, <span class="va">Sepal.Width</span><span class="op">)</span> <span class="op">~</span> <span class="va">Species</span>, FUN <span class="op">=</span> <span class="va">quantile</span><span class="op">)</span></code></pre></div>
<pre><code>##      Species Sepal.Length.0% Sepal.Length.25% Sepal.Length.50% Sepal.Length.75%
## 1     setosa           4.300            4.800            5.000            5.200
## 2 versicolor           4.900            5.600            5.900            6.300
## 3  virginica           4.900            6.225            6.500            6.900
##   Sepal.Length.100% Sepal.Width.0% Sepal.Width.25% Sepal.Width.50%
## 1             5.800          2.300           3.200           3.400
## 2             7.000          2.000           2.525           2.800
## 3             7.900          2.200           2.800           3.000
##   Sepal.Width.75% Sepal.Width.100%
## 1           3.675            4.400
## 2           3.000            3.400
## 3           3.175            3.800</code></pre>
<div class="sourceCode" id="cb1242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 对 Sepal.Length 按 Species 分组计算分位数</span>
<span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">quantile</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##             0%   25% 50% 75% 100%
## setosa     4.3 4.800 5.0 5.2  5.8
## versicolor 4.9 5.600 5.9 6.3  7.0
## virginica  4.9 6.225 6.5 6.9  7.9</code></pre>
<div class="sourceCode" id="cb1244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组取平均 mean /中位数 median</span>
<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">Species</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##      Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        5.006       3.428        1.462       0.246
## 2 versicolor        5.936       2.770        4.260       1.326
## 3  virginica        6.588       2.974        5.552       2.026</code></pre>
</div>
<div id="shift-lag" class="section level3" number="7.2.25">
<h3>
<span class="header-section-number">7.2.25</span> 计算日粒度的 DoD/WoW/MoM/YoY<a class="anchor" aria-label="anchor" href="#shift-lag"><i class="fas fa-link"></i></a>
</h3>
<p>截止写作时间，data.table 提供的滑动窗口聚合统计函数 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/froll.html">frollmean()</a></code>、<code><a href="https://Rdatatable.gitlab.io/data.table/reference/froll.html">frollsum()</a></code> 和 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/froll.html">frollapply()</a></code> 还处于实验阶段。 shift 提供漂移功能，向前前置 lead 或向后延迟 lag。</p>
<p><a href="https://r-norberg.blogspot.com/2016/06/understanding-datatable-rolling-joins.html">移动平均、求和和计算</a></p>
<div class="sourceCode" id="cb1246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>
  from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-01"</span><span class="op">)</span>,
  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"1 day"</span>
<span class="op">)</span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/transform.data.table.html">within</a></span><span class="op">(</span><span class="va">dat</span>, <span class="op">{</span>
  <span class="va">uv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1000</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">uv_dod_d</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1</span>, <span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">uv</span>, lag <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">uv_wow_d</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">7</span>, <span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">7</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">uv</span>, lag <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">uv_mom_d</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">30</span>, <span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">30</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">uv</span>, lag <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">uv_yoy_d</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">365</span>, <span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">365</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">uv</span>, lag <span class="op">=</span> <span class="fl">365</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="sec-adm-sessioninfo" class="section level2" number="7.3">
<h2>
<span class="header-section-number">7.3</span> 运行环境<a class="anchor" aria-label="anchor" href="#sec-adm-sessioninfo"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb1247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] magrittr_2.0.3    data.table_1.14.2
## 
## loaded via a namespace (and not attached):
##  [1] highr_0.9        bslib_0.3.1      compiler_4.2.0   pillar_1.7.0    
##  [5] jquerylib_0.1.4  tools_4.2.0      sysfonts_0.8.8   digest_0.6.29   
##  [9] downlit_0.4.0    jsonlite_1.8.0   evaluate_0.15    memoise_2.0.1   
## [13] lifecycle_1.0.1  tibble_3.1.7     pkgconfig_2.0.3  rlang_1.0.2     
## [17] DBI_1.1.2        cli_3.3.0        curl_4.3.2       yaml_2.3.5      
## [21] xfun_0.31        fastmap_1.1.0    stringr_1.4.0    dplyr_1.0.9     
## [25] xml2_1.3.3       knitr_1.39       generics_0.1.2   fs_1.5.2        
## [29] sass_0.4.1       vctrs_0.4.1      tidyselect_1.1.2 glue_1.6.2      
## [33] R6_2.5.1         fansi_1.0.3      rmarkdown_2.14   bookdown_0.26   
## [37] tidyr_1.2.0      purrr_0.3.4      backports_1.4.1  htmltools_0.5.2 
## [41] ellipsis_0.3.2   assertthat_0.2.1 utf8_1.2.2       stringi_1.7.6   
## [45] broom_0.8.0      cachem_1.0.6     crayon_1.5.1</code></pre>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="chap-data-manipulation.html"><span class="header-section-number">6</span> 数据操作</a></div>
<div class="next"><a href="chap-parallel-manipulation.html"><span class="header-section-number">8</span> 并行化操作</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-advanced-manipulation"><span class="header-section-number">7</span> 高级数据操作</a></li>
<li>
<a class="nav-link" href="#intro"><span class="header-section-number">7.1</span> 基础介绍</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#subsec-filter-i"><span class="header-section-number">7.1.1</span> 过滤</a></li>
<li><a class="nav-link" href="#subsec-mutate-j"><span class="header-section-number">7.1.2</span> 变换</a></li>
<li><a class="nav-link" href="#subsec-summarise-j"><span class="header-section-number">7.1.3</span> 聚合</a></li>
<li><a class="nav-link" href="#subsec-setname"><span class="header-section-number">7.1.4</span> 命名</a></li>
<li><a class="nav-link" href="#subsec-order-by-j"><span class="header-section-number">7.1.5</span> 排序</a></li>
<li><a class="nav-link" href="#subsec-reshape"><span class="header-section-number">7.1.6</span> 变形</a></li>
<li><a class="nav-link" href="#subsec-group-by"><span class="header-section-number">7.1.7</span> 分组</a></li>
<li><a class="nav-link" href="#subsec-merge"><span class="header-section-number">7.1.8</span> 合并</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#chap:data-manipulation"><span class="header-section-number">7.2</span> 高频操作</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec-select"><span class="header-section-number">7.2.1</span> 选择多列</a></li>
<li><a class="nav-link" href="#sec-filter"><span class="header-section-number">7.2.2</span> 过滤多行</a></li>
<li><a class="nav-link" href="#sec-duplicated"><span class="header-section-number">7.2.3</span> 去重多行</a></li>
<li><a class="nav-link" href="#sec-merge"><span class="header-section-number">7.2.4</span> 合并操作</a></li>
<li><a class="nav-link" href="#sec-add-columns"><span class="header-section-number">7.2.5</span> 新添多列</a></li>
<li><a class="nav-link" href="#sec-delete-columns"><span class="header-section-number">7.2.6</span> 删除多列</a></li>
<li><a class="nav-link" href="#sec-select-columns"><span class="header-section-number">7.2.7</span> 筛选多列</a></li>
<li><a class="nav-link" href="#sec-modify-columns-type"><span class="header-section-number">7.2.8</span> 修改多列类型</a></li>
<li><a class="nav-link" href="#sec-select-first-row"><span class="header-section-number">7.2.9</span> 取每组第一行</a></li>
<li><a class="nav-link" href="#subsec-mom-vs-yoy"><span class="header-section-number">7.2.10</span> 计算环比同比</a></li>
<li><a class="nav-link" href="#sec-merge-multi-dfs"><span class="header-section-number">7.2.11</span> 合并多个数据框</a></li>
<li><a class="nav-link" href="#sec-multiple-aggregations"><span class="header-section-number">7.2.12</span> 分组聚合多个指标</a></li>
<li><a class="nav-link" href="#sec-rename-multi-cols"><span class="header-section-number">7.2.13</span> 重命名多个列</a></li>
<li><a class="nav-link" href="#sec-sort-multi-cols"><span class="header-section-number">7.2.14</span> 对多个列依次排序</a></li>
<li><a class="nav-link" href="#sec-rearrange-position-multi-cols"><span class="header-section-number">7.2.15</span> 重排多个列的位置</a></li>
<li><a class="nav-link" href="#sec-tidy-output"><span class="header-section-number">7.2.16</span> 整理回归结果</a></li>
<li><a class="nav-link" href="#sec-assignment-by-reference"><span class="header-section-number">7.2.17</span> := 和 .()</a></li>
<li><a class="nav-link" href="#sec-remove-na"><span class="header-section-number">7.2.18</span> 去掉含有缺失值的记录</a></li>
<li><a class="nav-link" href="#sec-match-set"><span class="header-section-number">7.2.19</span> 集合操作</a></li>
<li><a class="nav-link" href="#transform-cut-aggregate"><span class="header-section-number">7.2.20</span> 对数值向量按既定分组计数</a></li>
<li><a class="nav-link" href="#aggregate-order"><span class="header-section-number">7.2.21</span> 分组排序</a></li>
<li><a class="nav-link" href="#lapply-split-order"><span class="header-section-number">7.2.22</span> 分组获取 Top 值</a></li>
<li><a class="nav-link" href="#lapply-split-sample"><span class="header-section-number">7.2.23</span> 分组抽样</a></li>
<li><a class="nav-link" href="#lapply-split-quantile"><span class="header-section-number">7.2.24</span> 分组计算分位数</a></li>
<li><a class="nav-link" href="#shift-lag"><span class="header-section-number">7.2.25</span> 计算日粒度的 DoD/WoW/MoM/YoY</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec-adm-sessioninfo"><span class="header-section-number">7.3</span> 运行环境</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/XiangyunHuang/notesdown/blob/devel/advanced-manipulation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/XiangyunHuang/notesdown/edit/devel/advanced-manipulation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R 语言学习笔记</strong>" was written by 黄湘云. It was last built on 2022-06-10.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
