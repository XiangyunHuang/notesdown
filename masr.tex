% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode,linktoc=all,pdfstartview=FitH,bookmarksnumbered=true}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  10pt,
  b5paper,
  UTF8,twoside,openany,table]{book}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \ifXeTeX
    \usepackage{mathspec}
  \else
    \usepackage{unicode-math}
  \fi
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={现代应用统计与 R 语言},
  pdfauthor={黄湘云},
  pdfsubject={现代应用统计与 R 语言},
  pdfkeywords={现代统计, 机器学习, 深度学习, 抽样分布, 参数估计, 假设检验, 预测, 线性模型, 极大似然估计, 最小二乘估计, 矩估计, 似然比检验 Wilks, Wald 检验, Score 检验 Rao, R 语言},
  colorlinks=true,
  linkcolor={Maroon},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[tmargin=2.5cm,bmargin=2.5cm,lmargin=3.0cm,rmargin=2.0cm]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% \usepackage[cam,a4,center]{crop}

\usepackage[fontset=adobe, heading=true, UTF8]{ctex}
\usepackage[lotdepth=2, lofdepth=2]{subfig}

\usepackage[rmdefault,semibold]{sourceserifpro}
\usepackage[sfdefault,semibold]{sourcesanspro}
\usepackage[scale=0.85,semibold]{sourcecodepro}

\usepackage{float,animate,awesomebox}

\usepackage[skins]{tcolorbox}

\definecolor{colortip}{RGB}{81,183,73}
\definecolor{colornote}{RGB}{251,188,5}
\definecolor{colorwarn}{RGB}{255,83,59}
\definecolor{colorinfo}{RGB}{204,204,204}

\tcbset{
  colbacktitle=white,
  enhanced,
  attach boxed title to top center={yshift=-2mm},
  colback=white, % 背景色
  coltext=black, % 文本色
  leftrule=1mm,
  rightrule=.25mm,
  bottomrule=.25mm,
  toprule=.25mm,
  boxsep=1pt, % 文字和边框的空隙
  arc=1pt % 圆角
}

\newtcolorbox{rmdtip}[1]{
  title=#1,
  coltitle=colortip,
  colframe=colortip, % 边框色
}

\newtcolorbox{rmdnote}[1]{
  title=#1,
  coltitle=colornote,
  colframe=colornote % 边框色
}

\newtcolorbox{rmdwarn}[1]{
  title=#1,
  coltitle=colorwarn,
  colframe=colorwarn % 边框色
}

\newtcolorbox{rmdinfo}{
  colframe=colorinfo % 边框色
}

\newenvironment{columns}[1][]{}{}

\newenvironment{column}[1]{\begin{minipage}{#1}\ignorespaces}{%
\end{minipage}
\ifhmode\unskip\fi
\aftergroup\useignorespacesandallpars}

\def\useignorespacesandallpars#1\ignorespaces\fi{%
#1\fi\ignorespacesandallpars}

\makeatletter
\def\ignorespacesandallpars{%
  \@ifnextchar\par
    {\expandafter\ignorespacesandallpars\@gobble}%
    {}%
}
\makeatother

% 添加版权水印
% https://github.com/callegar/LaTeX-draftwatermark
% https://github.com/callegar/LaTeX-everypage
% https://ctan.org/pkg/draftwatermark
% draftwatermark 依赖 everypage
\usepackage[angle=90,text=\textcopyright 黄湘云,color=gray,pos={0.5in,1.5in},scale=0.25]{draftwatermark}
% draftwatermark 和 everypage 由同一个人维护，后者将停止维护
% https://github.com/CTeX-org/ctex-kit/issues/331
\RecustomVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\},formatcom=\xeCJKVerbAddon}

\usepackage{bm,mathrsfs} % \mathcal \mathbb \mathscr \boldsymbol \bm

\usepackage{makeidx}
\makeindex

\frontmatter
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{plainnat}

\title{现代应用统计与 R 语言}
\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother
\subtitle{Modern Applied Statistics with R}
\author{黄湘云}
\date{2021-10-05}

\begin{document}
\maketitle

{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}
\listoffigures
\listoftables
\mainmatter

\hypertarget{welcome}{%
\chapter*{欢迎}\label{welcome}}
\addcontentsline{toc}{chapter}{欢迎}

\chaptermark{欢迎}

\begin{rmdwarn}{警告}
Book in early development. Planned release in 202X.

\end{rmdwarn}

\hypertarget{sec-style}{%
\section*{本书风格}\label{sec-style}}
\addcontentsline{toc}{section}{本书风格}

\index{置信区间} \index{信仰区间} \index{统计功效}

可以说，点估计、区间估计、假设检验、统计功效是每一个学数理统计的学生都绕不过去的坎，离开学校从事数据相关的工作，它们仍然是必备的工具。所以，本书会覆盖相关内容，但是和高校的教材最大的区别是更加注重它们之间的区别和联系，毕竟每一个统计概念都是经过了千锤百炼，而我们的主流教材始终如一地遵循的一个基本套路，就是突然给出一大堆定义、命题或定理，紧接着冗长的证明过程，然后给出一些难以找到实际应用背景的例子。三板斧抡完后就是给学生布置大量的习题，这种教学方式无论对于立志从事理论工作的还是将来投身于工业界的学生都是不合适的。

\begin{quote}
极大似然估计最初由德国数据学家 Gauss 于 1821 年提出，但未得到重视，后来， R. A. Fisher 在 1922 年再次提出极大似然的思想，探讨了它的性质，使它得到广泛的研究和应用。\citep{Prob_2006_Mao}
\end{quote}

这是国内某著名数理统计教材在极大似然估计开篇第一段的内容，后面是各种定义、定理、公式推导。教材简短一句话，这里面有很多信息值得发散，一个数学家提出了统计学领域极其重要的一个核心思想，他是在研究什么的时候提出了这个想法，为什么后来没有得到重视，整整 100 年以后，Fisher 又是怎么提出这一思想的呢？他做了什么使得这个思想被广泛接受和应用？虽然这可能有点离题，但是读者可以获得很多别的启迪，要知道统计领域核心概念的形成绝不是一蹴而就的，这一点也绝不局限于统计科学，任何一门科学都是这样的，比如物理学之于光的波粒二象性。历史上，各门各派的学者历经多年的思想碰撞才最终沉淀出现在的结晶。笔者认为，学校要想培养出有原创理论创新的人才，在对待前辈的成果上，我们要不吝笔墨和口水，传道不等于满堂灌和刷分机，用寥寥数节课或者数页纸来梳理学者们几十年乃至上百年的智慧结晶是非常值得的，我们甚至可以从当时的社会、人文去剖析。非常欣赏有人在收集关于统计学历史的材料，读者不妨去看看 \url{https://github.com/sctyner/history_of_statistics}。 另一个不得不提的人是 \href{https://www.allisonhorst.com/}{Allison Horst}，她以风趣幽默的漫画形式，以画龙点睛之手法勾勒出基本的统计概念和思想，详见 \url{https://github.com/allisonhorst/stats-illustrations}，是我见过最好的科普读物。

\index{统计分布}

Bradley Efron 在他的课程中谈及现代统计的研究层次，第一层次是基于正态分布假设的，这种类型已经研究的很清楚了，往往可以得到精确的结果，第二层次是将正态分布推广到指数族，这种类型的也研究的比较多了，常见的情况都研究的比较清楚，罕见的情况也是大量存在的，特别是在实际应用当中，总的来说只能得到部分精确的结果，第三层次对分布没有任何限定，只要满足成为一个统计分布的条件，这种情况下就只能求助于一般的数学工具和渐进理论。

\begin{figure}

{\centering \includegraphics{index_files/figure-latex/stats-level-1} 

}

\caption[现代统计建模的三重境界]{现代统计建模的三重境界：修改自 2019 年冬季 Bradley Efron 的课程笔记（第一部分） \url{http://statweb.stanford.edu/~ckirby/brad/STATS305B_Part-1_corrected-2.pdf}}\label{fig:stats-level}
\end{figure}





\index{区间估计}

下面以区间估计为例，希望能为传道做一点事情。区间估计的意义是解决点估计可靠性问题，它用置信系数解决了对估计结果的信心问题，弥补了点估计的不足。置信系数是最大的置信水平。

区间半径这么长，区间估计的意义何在？增加样本量可以使得半径更短，那么至少应该有多少样本量才可以让估计变得有意义呢？就是说用估计比不用估计更好呢？答案是 39 个，留给读者思考一下为什么？读者可能已经注意到，置信带是关于点 \((5, 0.5)\) 中心对称的，这又是为什么，并且两头窄中间胖，像个酒桶？

\begin{rmdtip}{提示}
Base R 提供的 \texttt{uniroot()} 函数只能求取一元非线性方程的一个根，而 \textbf{rootSolve} 包提供的 \texttt{uniroot.all()} 函数可以求取所有的根。在给定分位点下，我们需要满足方程的最小的概率值。

\end{rmdtip}

Base R 提供的 \texttt{binom.test()} 函数可以精确计算置信区间，而 \texttt{prop.test()} 函数可近似计算置信区间。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 近似计算 Wilson 区间}
\FunctionTok{prop.test}\NormalTok{(}\AttributeTok{x =} \DecValTok{2}\NormalTok{, }\AttributeTok{n =} \DecValTok{10}\NormalTok{, }\AttributeTok{p =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{correct =} \ConstantTok{TRUE}\NormalTok{)}
\DocumentationTok{\#\# Warning in prop.test(x = 2, n = 10, p = 0.95, conf.level = 0.95, correct =}
\DocumentationTok{\#\# TRUE): Chi{-}squared approximation may be incorrect}
\DocumentationTok{\#\# }
\DocumentationTok{\#\#  1{-}sample proportions test with continuity correction}
\DocumentationTok{\#\# }
\DocumentationTok{\#\# data:  2 out of 10, null probability 0.95}
\DocumentationTok{\#\# X{-}squared = 103.16, df = 1, p{-}value \textless{} 2.2e{-}16}
\DocumentationTok{\#\# alternative hypothesis: true p is not equal to 0.95}
\DocumentationTok{\#\# 95 percent confidence interval:}
\DocumentationTok{\#\#  0.03542694 0.55781858}
\DocumentationTok{\#\# sample estimates:}
\DocumentationTok{\#\#   p }
\DocumentationTok{\#\# 0.2}
\CommentTok{\# 精确计算}
\FunctionTok{binom.test}\NormalTok{(}\AttributeTok{x =} \DecValTok{2}\NormalTok{, }\AttributeTok{n =} \DecValTok{10}\NormalTok{, }\AttributeTok{p =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{)}
\DocumentationTok{\#\# }
\DocumentationTok{\#\#  Exact binomial test}
\DocumentationTok{\#\# }
\DocumentationTok{\#\# data:  2 and 10}
\DocumentationTok{\#\# number of successes = 2, number of trials = 10, p{-}value = 1.605e{-}09}
\DocumentationTok{\#\# alternative hypothesis: true probability of success is not equal to 0.95}
\DocumentationTok{\#\# 95 percent confidence interval:}
\DocumentationTok{\#\#  0.02521073 0.55609546}
\DocumentationTok{\#\# sample estimates:}
\DocumentationTok{\#\# probability of success }
\DocumentationTok{\#\#                    0.2}
\end{Highlighting}
\end{Shaded}



\begin{figure}

{\centering \includegraphics{index_files/figure-latex/pbinom-1} 

}

\caption{二项分布 \(B(n,\theta)\) 成功概率 \(\theta\)，固定样本量 \(n = 10\)，分不同的分位点 \(q = 2, 4, 6\) 绘制概率随成功概率 \(\theta\) 的变化}\label{fig:pbinom}
\end{figure}

实际达到的置信度水平随真实的未知参数值和样本量的变化而\textbf{剧烈}波动，这意味着这种参数估计方法在实际应用中不可靠、真实场景中参数真值是永远未知的，样本量是可控的，并且是可以变化的。根本原因在于这类分布是离散的，比如这里的二项分布。当数据 \(x\) 是离散的情况，置信区间的端点\(\ell(x)\) 和 \(u(x)\) 也是离散的。这种缺陷是无法避免的，清晰的置信区间和离散的数据之间存在无法调和的冲突。

覆盖概率 \(P_{\theta}(X = x)\) 和参数真值 \(\theta\) 的关系 \citep{Lawrence2001, Geyer2005}

以抛硬币为例，我来做这个实验，抛10次，7 次正面朝上，他做这个实验，也抛10 次，4 次正面朝上。换不同的人来做这个实验，结果会有所不同，实际上，总共有 2\^{}10 = 1024 个结果，每个结果都可以用来估计未知的参数 \(p\) 及其置信区间、覆盖概率。假设参数 \(p\) 的真值是 0.7，抛10次，6 次正面朝上。先来模拟这个抛硬币的过程，重复抛了10次，是 10 重伯努利实验，正面朝上的累计次数服从二项分布 \(B(10, 0.7)\)，从此二项分布里抽样一次，相当于抛10次硬币，R 提供了模拟二项分布的函数 \texttt{rbinom()}，实现起来非常方便，为了模拟过程可重复，设置随机数种子为 2019。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.7}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6
\end{verbatim}

假设只知道抛了 10 次硬币，有 6 次正面朝上的结果，并不知道参数 \(p\) 的真实值，现在做个假设，假设 \(p = 0.7\)，我们看看基于这样一次实验的数据，检验一下该假设是否成立。这是一个典型的二项检验，R 已经提供内置的函数 \texttt{binom.test()} 来实现，经计算，检验的 P 值，即样本落在拒绝域的概率是 0.4997，大于 0.05，所以原假设有一定合理性，不能拒绝。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{binom.test}\NormalTok{(}\AttributeTok{x =} \DecValTok{6}\NormalTok{, }\AttributeTok{n =} \DecValTok{10}\NormalTok{, }\AttributeTok{p =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Exact binomial test
## 
## data:  6 and 10
## number of successes = 6, number of trials = 10, p-value = 0.4997
## alternative hypothesis: true probability of success is not equal to 0.7
## 95 percent confidence interval:
##  0.2623781 0.8784477
## sample estimates:
## probability of success 
##                    0.6
\end{verbatim}

比例的真实值 \(p\) 落在区间 \((\hat{p} - Z_{1-\alpha/2} * \sqrt{\frac{\hat{p}(1-\hat{p})}{n}}, \hat{p} + Z_{1-\alpha/2} * \sqrt{\frac{\hat{p}(1-\hat{p})}{n}})\) 的概率是 0.95。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{c}\NormalTok{(}
  \FloatTok{0.6} \SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\AttributeTok{p =} \DecValTok{1} \SpecialCharTok{{-}} \FloatTok{0.05} \SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\AttributeTok{mean =} \DecValTok{0}\NormalTok{, }\AttributeTok{sd =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\FloatTok{0.6} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FloatTok{0.6}\NormalTok{) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{),}
  \FloatTok{0.6} \SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\AttributeTok{p =} \DecValTok{1} \SpecialCharTok{{-}} \FloatTok{0.05} \SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\AttributeTok{mean =} \DecValTok{0}\NormalTok{, }\AttributeTok{sd =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\FloatTok{0.6} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FloatTok{0.6}\NormalTok{) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.2963637 0.9036363
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pnorm}\NormalTok{(}\AttributeTok{q =} \FloatTok{0.9036363}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{pnorm}\NormalTok{(}\AttributeTok{q =} \FloatTok{0.2963637}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.200382
\end{verbatim}

\textcolor{red}{\textbf{TODO: }{多重比较与检验}}

多重比较 \texttt{p.adjust()} 函数 Adjust P-values for Multiple Comparisons 单因素多重比较 \texttt{oneway.test()}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{50}\NormalTok{, }\AttributeTok{mean =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{25}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{)))}
\NormalTok{p }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{*} \FunctionTok{pnorm}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{abs}\NormalTok{(x)))}
\CommentTok{\# ?p.adjust}
\FunctionTok{round}\NormalTok{(p, }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.001 0.002
## [13] 0.003 0.004 0.005 0.007 0.007 0.009 0.009 0.011 0.021 0.049 0.061 0.063
## [25] 0.074 0.083 0.086 0.119 0.189 0.206 0.221 0.286 0.305 0.466 0.483 0.492
## [37] 0.532 0.575 0.578 0.619 0.636 0.645 0.656 0.689 0.719 0.818 0.827 0.897
## [49] 0.912 0.944
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# round(p.adjust(p), 3)}
\CommentTok{\# round(p.adjust(p, "BH"), 3)}
\end{Highlighting}
\end{Shaded}

\textcolor{red}{\textbf{TODO: }{混合正态分布的参数估计}}

标准正态分布的概率密度函数 \(f(x) = \frac{1}{\sqrt{2\pi}}e^{-\frac{x^2}{2}}\) 的图像见图\ref{fig:god-play-games} 中的红线，非常的优美，然而，现实中的数据所呈现出来的却是另一翻景象，它们只是近似却永远也不会严丝合缝，这又是大自然神奇的地方，整体似乎有某种确定性的规律，局部又有不确定的随机扰动，横看成岭侧成峰，远近高低各不同。

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{index_files/figure-latex/god-play-games-1} 

}

\caption{上帝在掷骰子吗？}\label{fig:god-play-games}
\end{figure}

\textcolor{red}{\textbf{TODO: }{统计检验，决策风险，显著性水平}}

\begin{center}\includegraphics{index_files/figure-latex/ab-test-1} \end{center}

Charles J. Geyer 的文章 Fuzzy and Randomized Confidence Intervals and P-Values \citep{Geyer2005} 文章中的图 1 名义覆盖概率的计算见 \citep{Blyth1960}

\hypertarget{sec-audience}{%
\section*{本书定位}\label{sec-audience}}
\addcontentsline{toc}{section}{本书定位}

学习本书需要读者具备基本的概率、统计知识，比如上过一学期的概率论和数理统计学，也需要读者接触过编程知识，比如至少上过一学期的 C 语言、Python 语言或 Matlab 语言。了解基本的线性代数，比如矩阵的加、减、乘、逆四则运算、线性子空间、矩阵的 LU、SVD、Eigen 等分解。

\hypertarget{sec-abstract}{%
\section*{内容概要}\label{sec-abstract}}
\addcontentsline{toc}{section}{内容概要}

第 \ref{chap-preface} 章介绍本书的写作背景、语言环境、全书的记号约定、如何获取帮助、作者简介等信息。

第 \ref{chap-notations} 章介绍全书的数学公式符号。

第 \ref{chap-file-operations} 章介绍文件操作。

第 \ref{chap-data-structure} 章介绍 R 语言的数据结构。

第 \ref{chap-data-manipulation} 章介绍数据操作，包括 Base R 、\textbf{data.table} 和 \textbf{magrittr}。

第 \ref{chap-data-transportation} 章介绍数据导入导出， \textbf{data.table} 之于 csv 文件， \textbf{openxlsx} 之于 xlsx 文件。

第 \ref{chap-data-visualization} 章介绍数据可视化，分四个部分，基础元素、常用图形、字体和颜色设置。

第 \ref{chap-document-elements} 章介绍动态文档，即 R Markdown 及其生态系统。

第 \ref{chap-interactive-web-graphics} 章介绍交互图形，以常用的 \textbf{plotly} 和 \textbf{highcharter} 为主，重点介绍 R 和 JavaScript 库的对应关系。

第 \ref{chap-interactive-data-tables} 章介绍交互表格，分两节介绍交互式的 \textbf{DT} 和 \textbf{reactable}，静态的 \textbf{gt} 和 \textbf{kableExtra}，掌握这几个 R 包足以应付日常工作。

第 \ref{chap-interactive-shiny-app} 章介绍交互报表开发，符合工业标准的最佳实践。

\hypertarget{sec-acknowledgments}{%
\section*{致谢名单}\label{sec-acknowledgments}}
\addcontentsline{toc}{section}{致谢名单}

特别感谢 XX，还有很多人通过提交 PR 或 Issues 的方式参与了本书的创作过程，没有这一点一滴的持续改进，本书不会达到现在的样子，所以我将他们列在致谢名单中，详见表 \ref{tab:acknowledgments}，人名按照提交量（commit 的个数）降序排列。

\begin{longtable}[]{@{}lc@{}}
\caption{\label{tab:acknowledgments} 致谢名单}\tabularnewline
\toprule
贡献者 & 提交量 \\
\midrule
\endfirsthead
\toprule
贡献者 & 提交量 \\
\midrule
\endhead
Yadong Liu & 1 \\
Yihui Xie & 1 \\
\bottomrule
\end{longtable}

\begin{flushright}
黄湘云\\
于北京

\end{flushright}

\hypertarget{sec-licenses}{%
\section*{授权说明}\label{sec-licenses}}
\addcontentsline{toc}{section}{授权说明}

\begin{rmdwarn}{警告}
本书采用 \href{https://creativecommons.org/licenses/by-nc-nd/4.0/}{知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议} 许可，请君自重，别没事儿拿去传个什么新浪爱问、百度文库以及 XX 经济论坛，项目中代码使用 \href{https://github.com/XiangyunHuang/masr/blob/master/LICENSE}{MIT 协议} 开源

\end{rmdwarn}

\begin{flushleft}\includegraphics[width=0.15\linewidth]{images/cc-by-nc-nd} \end{flushleft}

\hypertarget{sec-session-welcome}{%
\section*{运行信息}\label{sec-session-welcome}}
\addcontentsline{toc}{section}{运行信息}

书籍在 R version 4.1.1 (2021-08-10) 下编译，Pandoc 版本 2.14.1，最新一次编译发生在 2021-10-05 16:57:54。

\hypertarget{chap-preface}{%
\chapter{前言}\label{chap-preface}}

\begin{quote}
荃者所以在鱼，得鱼而忘荃；蹄者所以在兔；得兔而忘蹄；言者所以在意，得意而忘言。吾安得夫忘言之人而与之言哉！

\hspace*{\fill} --- 摘自 《庄子·杂篇·物》
\end{quote}

庄子谈学习，余深以为然，故引之。

\begin{quote}
The fish trap exists because of the fish; once you've gotten the fish, you can forget the trap. The rabbit snare exists because of the rabbit; once you've gotten the rabbit, you can forget the snare. Words exist because of meaning; once you've gotten the meaning, you can forget the words. Where can I find a man who has forgotten words so I can have a word with him ? \footnote{译文摘自 \href{http://math.bu.edu/people/kolaczyk/teach.html}{Eric D. Kolaczyk}}

\hspace*{\fill} --- Chuang Tzu
\end{quote}

\hypertarget{sec-r-or-python}{%
\section{语言抉择}\label{sec-r-or-python}}

\index{Octave} \index{Python}

行业内可以做统计分析和建模的软件汗牛充栋，比较顶级的收费产品有 SAS 和 SPSS，在科学计算领域的 Matlab 和 Mathematica 也有相当强的统计功能，而用户基数最大的是微软 Excel，抛开微软公司的商业手段不说，Excel 的市场份额却是既成事实。 Brian D. Ripley 20 多年前的一句话很有意思，放在当下也是适用的。

\begin{quote}
Let's not kid ourselves: the most widely used piece of software for statistics is Excel.

\hspace*{\fill} --- Brian D. Ripley \citep{Ripley_2002_SS}
\end{quote}

有鉴于 Excel 在人文、社会、经济和管理等领域的影响力，熟悉 R 语言的人把它看作超级收费版的 Excel，这实在是一点也不过分。事实上，我司就是一个很好的明证，一个在线教育类的互联网公司，各大业务部门都在使用 Excel 作为主要的数据分析工具。然而，Excel 的不足也十分突出，工作过程无法保存和重复利用，Excel 也不是数据库，数据集稍大，操作起来愈发困难，对于复杂的展示，需要借助内嵌的 VBA，由于缺乏版本控制，随着时间的推移，几乎不可维护。所以，我们还是放弃 Excel 吧，Jenny Bryan 更在 2016 年国际 R 语言大会上的直截了当地喊出了这句话\footnote{\url{https://channel9.msdn.com/Events/useR-international-R-User-conference/useR2016/jailbreakr-Get-out-of-Excel-free}}。Nathan Stephens 对 Excel 的缺陷不足做了全面的总结\footnote{\url{https://resources.rstudio.com/wistia-rstudio-essentials-2/how-to-excel-without-using-excel}}。

\begin{quote}
Some people familiar with R describe it as a supercharged version of Microsoft's Excel spreadsheet software.

\hspace*{\fill} --- Ashlee Vance \footnote{\url{https://www.nytimes.com/2009/01/07/technology/business-computing/07program.html}}
\end{quote}

另一方面，我们谈谈开源领域的佼佼者 --- R (\url{https://cran.r-project.org/})，Python (\url{https://www.python.org/}) 和 Octave (\url{http://www.gnu.org/software/octave/})。Python 号称万能的胶水语言，从系统运维到深度学习都有它的广泛存在，它被各大主流 Linux 系统内置，语言风格上更接近于基数庞大的开发人员，形成了强大的生态平台。 Octave 号称是可以替代 Matlab 的科学计算软件，在兼容 Matlab 的方面确实做的很不错，然而，根据 Julia 官网给出的各大编程语言的测试 \url{https://julialang.org/benchmarks/}，性能上不能相提并论。

\begin{figure}

{\centering \includegraphics[width=0.85\linewidth]{preface_files/figure-latex/r-eco-system-1} 

}

\caption{R 语言扩展包生态系统}\label{fig:r-eco-system}
\end{figure}

R 提供了丰富的图形接口，包括 Tcl/Tk , Gtk, Shiny 等，以及基于它们的衍生品 rattle（\href{http://www.ggobi.org/rgtk2/}{RGtk2}）、\href{https://CRAN.R-project.org/package=Rcmdr}{Rcmdr}（tcl/tk）、\href{https://github.com/radiant-rstats/radiant}{radiant}（shiny）。更多底层介绍，见 John Chamber 的著作《Extending R》。

\href{https://www.eviews.com}{Eviews} 时间序列和计量经济模型，相比于 Eviews， \href{https://www.stata.com/}{Stata} 是综合型的统计软件，提供丰富的统计模型， \href{https://www.ibm.com/cn-zh/products/spss-statistics}{SPSS} 同 Stata 类似，\href{https://www.minitab.com/zh-cn/}{Minitab}， \href{https://jasp-stats.org/}{JASP} 是开源的软件， \href{https://www.gnu.org/software/octave/}{Octave} 是对标 Matlab 的工程计算软件， 有丰富的优化功能，是一门编程语言兼软件，为求解统计模型的参数提供了广泛的基础能力。\href{https://www.tableau.com/zh-cn}{Tableau} 提供强大的分析和打造数据产品的能力。TikZ 在绘制示意图方面有很大优势，特别是示意图里包含数学公式，这更是 LaTeX 所擅长的方面。

JASP \url{https://jasp-stats.org} 是一款免费的统计软件，源代码托管在 Github 上 \url{https://github.com/jasp-stats/jasp-desktop}，主要由阿姆斯特丹大学 E. J. Wagenmakers 教授 \url{https://www.ejwagenmakers.com/} 领导的团队维护开发，实现了很多贝叶斯和频率统计方法，相似的图形用户界面使得 JASP 可以作为 SPSS 的替代，目前实现的功能见 \url{https://jasp-stats.org/current-functionality/}，统计方法见博客 \url{https://www.bayesianspectacles.org/}。

国内可视化分析平台，比如 \href{https://github.com/hiplot}{hiplot} 基于 R 语言实现可视化分析，各类图形的介绍见\href{https://hiplot.com.cn/docs/zh/}{文档}，极大地降低数据分析人员探索分析的门槛，节省了时间，同时非专业内的人也可借助其完成分析探索的过程，只需明白各类图形的含义即可。美团也建设了自己的可视化分析平台帮助运营人员，详见\href{https://tech.meituan.com/2018/08/02/mt-r-practice.html}{文档}

\href{https://www.burns-stat.com/}{Patrick Burns} 收集整理了 R 语言中奇葩的现象，写成 \href{https://www.burns-stat.com/pages/Tutor/R_inferno.pdf}{The R Inferno} 直译过来就是《R 之炼狱》。这些奇葩的怪现象可以看做是 R 风格的一部分，对于编程人员来说就是一些建议和技巧，参考之可以避开某些坑。 Paul E. Johnson 整理了一份真正的 R 语言建议，记录了他自己从 SAS 转换到 R 的过程中遇到的各种问题 \url{http://pj.freefaculty.org/R/Rtips.html}。Michail Tsagris 和 Manos Papadakis 也收集了 70 多条 R 编程的技巧和建议，力求以更加 R 范地将语言特性发挥到极致 \citep{Rfast_2018_Tsagris}，Martin Mächler 提供了一份 \href{https://stat.ethz.ch/Teaching/maechler/R/useR_2014/}{Good Practices in R Programming}。 Python 社区广泛流传着 Tim Peters 的 《Python 之禅》，它已经整合进每一版 Python 软件中，只需在 Python 控制台里执行 \texttt{import\ this} 可以获得。

\begin{quote}
\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Beautiful is better than ugly.
\item
  Explicit is better than implicit.
\item
  Simple is better than complex.
\item
  Complex is better than complicated.
\item
  Flat is better than nested.
\item
  Sparse is better than dense.
\item
  Readability counts.
\item
  Special cases aren't special enough to break the rules.
\item
  Although practicality beats purity.
\item
  Errors should never pass silently.
\item
  Unless explicitly silenced.
\item
  In the face of ambiguity, refuse the temptation to guess.
\item
  There should be one-- and preferably only one --obvious way to do it.
\item
  Although that way may not be obvious at first unless you're Dutch.
\item
  Now is better than never.
\item
  Although never is often better than \emph{right} now.
\item
  If the implementation is hard to explain, it's a bad idea.
\item
  If the implementation is easy to explain, it may be a good idea.
\item
  Namespaces are one honking great idea -- let's do more of those!
\end{enumerate}

\hspace*{\fill} --- The Zen of Python
\end{quote}

总之，编程语言到一定境界都是殊途同归的，对美的认识也是趋同的，道理更是相通的，Python 社区的 Pandas \url{https://github.com/pandas-dev/pandas} 和 Matplotlib \url{https://github.com/matplotlib/matplotlib} 也有数据框和图形语法的影子。Pandas \url{https://github.com/pandas-dev/pandas} 明确说了要提供与 data.frame 类似的数据结构和对应统计函数等，而 Matplotlib 偷了 ggplot2 绘图样式 \url{https://matplotlib.org/3.2.2/gallery/style_sheets/ggplot.html}。

\hypertarget{sec-data-science}{%
\section{数据科学}\label{sec-data-science}}

John M. Chambers 谈了数据科学的源起以及和 S、R 语言的渊源 \citep{RS_2020_John}。

\hypertarget{sec-r-help}{%
\section{获取帮助}\label{sec-r-help}}

R 社区提供了丰富的帮助资源，可以在 R 官网搜集的高频问题 \url{https://cran.r-project.org/faqs.html} 中查找，也可在线搜索 \url{https://cran.r-project.org/search.html} 或 \url{https://rseek.org/} ，更多获取帮助方式见 \url{https://www.r-project.org/help.html}。爆栈网问题以标签分类，比如 \href{https://stackoverflow.com/questions/tagged/r-plotly}{r-plotly}、\href{https://stackoverflow.com/questions/tagged/r-markdown}{r-markdown}、 \href{https://stackoverflow.com/questions/tagged/data.table}{data.table} 和 \href{https://stackoverflow.com/questions/tagged/ggplot2}{ggplot2}，还可以关注一些活跃的社区大佬，比如 \href{https://stackoverflow.com/users/559676/yihui-xie}{谢益辉}。

\hypertarget{sec-writing-details}{%
\section{写作环境}\label{sec-writing-details}}

\index{bookdown} \index{Pandoc}

\begin{figure}

{\centering \includegraphics{preface_files/figure-latex/book-workflow-1} 

}

\caption{书籍项目架构图}\label{fig:book-workflow}
\end{figure}

本书 R Markdown 源文件托管在 Github 仓库里，本地使用 RStudio IDE 编辑，bookdown 组织各个章节的 Rmd 文件和输出格式，使用 Git 进行版本控制。每次提交修改到 Github 上都会触发 Travis 自动编译书籍，将一系列 Rmd 文件经 knitr 调用 R 解释器执行里面的代码块，并将输出结果返回，Pandoc 将 Rmd 文件转化为 md 、 html 或者 tex 文件。若想输出 pdf 文件，还需要准备 TeX 排版环境，最后使用 Netlify 托管书籍网站，和 Travis 一起实现连续部署，使得每次修改都会同步到网站。最近一次编译时间 2021年10月05日08时57分57秒，本书用 R version 4.1.1 (2021-08-10) 编译，完整运行环境如下：

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{(}\AttributeTok{packages =} \FunctionTok{c}\NormalTok{(}
  \StringTok{"knitr"}\NormalTok{, }\StringTok{"rmarkdown"}\NormalTok{, }\StringTok{"bookdown"}
\NormalTok{), }\AttributeTok{dependencies =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   bookdown_0.24  knitr_1.36     rmarkdown_2.11
## 
## Pandoc version: 2.14.1
\end{verbatim}

借助 \textbf{bookdown} \citep{xie2016} 可以将 Rmd 文件组织起来， \textbf{rmarkdown} \citep{rmarkdown}和 \textbf{knitr} \citep{xie2015} 将源文件编译成 Markdown 文件， \href{https://pandoc.org/}{Pandoc} 将 Markdown 文件转化成 HTML 和 TeX 文件， \href{https://yihui.name/tinytex/}{TinyTeX} \citep{xie2019} 可以将 TeX 文件进一步编译成 PDF 文档，书中大量的图形在用 \textbf{ggplot2} 包制作 \citep{Wickham_2016_ggplot2}，而统计理论相关的示意图用 Base R 创作。

\begin{rmdtip}{提示}
得益于 Github Action 提供的测试服务，\href{https://pages.github.com/}{Github Pages}、\href{https://bookdown.org}{Bookdown} 和 \href{https://netlify.com/}{Netlify} 提供的部署服务，鉴于国内的网络环境，本书托管在三个地方，分别是 \url{https://xiangyunhuang.github.io/masr/}， \url{https://bookdown.org/xiangyun/masr/} ， \url{https://masr.netlify.app/}。

\end{rmdtip}

\hypertarget{sec-conventions}{%
\section{记号约定}\label{sec-conventions}}

正文中的代码、函数、参数及参数值以等宽正体表示，如 \VERB|\FunctionTok{data}\NormalTok{(}\AttributeTok{list =} \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}iris\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}BOD\textquotesingle{}}\NormalTok{))}|， 其中函数名称 \texttt{data()}，参数及参数值 \VERB|\NormalTok{list }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}iris\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}BOD\textquotesingle{}}\NormalTok{)}| ，R 程序包用粗体表示，如 \textbf{graphics}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ruler}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
----+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8
12345678901234567890123456789012345678901234567890123456789012345678901234567890
\end{verbatim}

\hypertarget{sec-contribute}{%
\section{复现环境}\label{sec-contribute}}

\begin{quote}
构建容器
\end{quote}

本书借助 Github Action 从 Dockerfile 构建容器镜像，然后将镜像文件推送到 Github Package。完成这些操作首先需要从 \url{https://github.com/settings/tokens} 新建拥有 GitHub Package \footnote{\url{https://docs.github.com/en/packages/using-github-packages-with-your-projects-ecosystem/configuring-docker-for-use-with-github-packages}} 读写删的权限的 TOKEN（俗称访问令牌或密钥），命名为 \texttt{GITHUB\_PKG}，并将此令牌保存到本地 TOKEN.txt 文件中，以备后用。

镜像内默认暴露 8181 端口供外部连接使用，进入容器后，默认工作路径是 \texttt{/home/docker/}。创建好镜像后，要先登陆 GitHub Package 然后才有权限将镜像拉取下来

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 登陆 GitHub Package}
\FunctionTok{cat}\NormalTok{ \textasciitilde{}/TOKEN.txt }\KeywordTok{|} \ExtensionTok{docker}\NormalTok{ login https://docker.pkg.github.com }\AttributeTok{{-}u}\NormalTok{ XiangyunHuang }\AttributeTok{{-}{-}password{-}stdin}
\CommentTok{\# 拉取镜像}
\ExtensionTok{docker}\NormalTok{ pull docker.pkg.github.com/xiangyunhuang/masr/masr{-}book:devel}
\end{Highlighting}
\end{Shaded}

读者可以先查看下容器内的信息

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}{-}rm} \AttributeTok{{-}u}\NormalTok{ root }\AttributeTok{{-}v} \StringTok{"/}\VariableTok{$\{PWD\}}\StringTok{://home/docker/"} \DataTypeTok{\textbackslash{}}
\NormalTok{  docker.pkg.github.com/xiangyunhuang/masr/masr{-}book:devel }\DataTypeTok{\textbackslash{}}
\NormalTok{  bash }\AttributeTok{{-}c} \StringTok{"locale; fc{-}list | sort"}
\end{Highlighting}
\end{Shaded}

\begin{quote}
运行容器
\end{quote}

下面从镜像创建一个叫 masr-book 的容器，并让它在后台运行，允许以真正的 root 账户权限交互式执行命令，停止容器后，自动销毁容器。 此处，不再介绍 Docker 容器的使用，用容器打包本书所有软件环境仅供读者完整复现本书之用，感兴趣的读者可以去参考书籍\href{https://vuepress.mirror.docker-practice.com/}{Docker 从入门到实践}。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}itd} \AttributeTok{{-}p}\NormalTok{ 8282:8787 }\AttributeTok{{-}{-}rm} \AttributeTok{{-}{-}name}\OperatorTok{=}\NormalTok{masr{-}book }\AttributeTok{{-}{-}privileged}\OperatorTok{=}\NormalTok{true }\DataTypeTok{\textbackslash{}}
\NormalTok{  docker.pkg.github.com/xiangyunhuang/masr/masr{-}book:devel /sbin/init}
\end{Highlighting}
\end{Shaded}

接着登陆进入 masr-book 容器，

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ exec }\AttributeTok{{-}it}\NormalTok{ masr{-}book bash}
\end{Highlighting}
\end{Shaded}

一番骚操作后，用户退出容器，然后停止容器。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ stop masr{-}book}
\end{Highlighting}
\end{Shaded}

\begin{quote}
使用 RStudio Server
\end{quote}

启动容器后，接着获取容器 masr-book 的 IP 地址，然后依据端口号 8282 从网页进入 RStudio Sever，比如 \url{http://192.168.100.23:8282}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ inspect }\AttributeTok{{-}{-}format}\OperatorTok{=}\StringTok{\textquotesingle{}\{\{.NetworkSettings.IPAddress\}\}\textquotesingle{}}\NormalTok{ masr{-}book}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-help-me}{%
\section{如何发问}\label{sec-help-me}}

\begin{quote}
The phrase ``does not work'' is not very helpful, it can mean quite a few things including:

\begin{itemize}
\tightlist
\item
  Your computer exploded.
\item
  No explosion, but smoke is pouring out the back and microsoft's ``NoSmoke'' utility is not compatible with your power supply.
\item
  The computer stopped working.
\item
  The computer sits around on the couch all day eating chips and watching talk shows.
\item
  The computer has started picketing your house shouting catchy slogans and demanding better working conditions and an increase in memory.
\item
  Everything went dark and you cannot check the cables on the back of the computer because the lights are off due to the power outage.
\item
  R crashed, but the other programs are still working.
\item
  R gave an error message and stopped processing your code after running for a while.
\item
  R gave an error message without running any of your code (and is waiting for your next command).
\item
  R is still running your code and the time has exceeded your patience so you think it has hung.
\item
  R completed and returned a result, but also gave warnings.
\item
  R completed your command, but gave an incorrect answer.
\item
  R completed your command but the answer is different from what you expect (but is correct according to the documentation).
\end{itemize}

There are probably others. Running your code I think the answer is the last one.

\hspace*{\fill} --- Greg Snow \footnote{来自 R 社区论坛收集的智语 \texttt{fortunes::fortune(324)}。}
\end{quote}

\hypertarget{sec-about-author}{%
\section{作者简介}\label{sec-about-author}}

热心开源事业，统计之都副主编，经常混迹于统计之都论坛、Github 和爆栈网。个人主页 \url{https://xiangyun.rbind.io/}

\hypertarget{part-ux6570ux636eux6574ux7406}{%
\part{数据整理}\label{part-ux6570ux636eux6574ux7406}}

\hypertarget{chap-data-wrangling}{%
\chapter*{介绍}\label{chap-data-wrangling}}
\addcontentsline{toc}{chapter}{介绍}

数据整理

\hypertarget{chap-data-structure}{%
\chapter{数据结构}\label{chap-data-structure}}

网站 \url{https://r-coder.com/} 主要介绍 Base R，特点是全面细致，排版精美

\begin{quote}
可用于绘图的数据对象，向量 vector 等，只涉及基础操作和绘图，关键在入门引导式的介绍，点到即止
\end{quote}

数据类型：字符、数值：字符数据操作：按数据类型介绍各类数据操作，重复之处如前所述，数据处理的分类：按数据类型来，一共是 table matrix data.frame 和 vector

\begin{quote}
The trouble with nonstandard evaluation is that it doesn't follow standard evaluation rules\ldots{}

\hspace*{\fill} --- Peter Dalgaard (about nonstandard evaluation in the \texttt{curve()} function) R-help (June 2011)
\end{quote}

向量，列表，

数据框 data frame 在 R 里面可以用三种不同类型的数据对象来表达

\begin{quote}
从历史脉络来看，为什么会出现三种不同的东西，它们之间的区别和联系是什么，能否用一张表来描述
\end{quote}

data.frame 设计的历史，首次包含在 R 里面是什么时候，R 是否一发布就包含了这个数据类型

The function \texttt{data.frame()} creates data frames, tightly coupled collections of variables which share many of the properties of matrices and of lists, used as the fundamental data structure by most of R's modeling software.

\textbf{data.table} 2006 年 4 月 15 日首次登陆 CRAN 发布 1.0 版本，差不多恰好 10 年后

\textbf{tibble} 在 2016 年 3 月 23 日首次登陆 CRAN 发布 1.0 版本

\texttt{data.frame()}， \texttt{tibble()} 和 \texttt{data.table()} 的区别，去看函数的帮助文档

Provides a `tbl\_df' class (the `tibble') that provides stricter checking and better formatting than the traditional data frame.

\href{https://github.com/r-lib/vctrs}{vctrs} 和 \href{https://github.com/r-lib/rlang}{rlang} 包 R 内置的 \href{https://cran.r-project.org/doc/manuals/r-release/R-lang.html}{R Language Definition}

\hypertarget{subsec:typeof}{%
\section{类型}\label{subsec:typeof}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"abc"} \CommentTok{\# 数据对象}
\FunctionTok{typeof}\NormalTok{(x) }\CommentTok{\# 数据类型}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "character"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mode}\NormalTok{(x) }\CommentTok{\# 存储模式}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "character"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{storage.mode}\NormalTok{(x) }\CommentTok{\# 存储类型}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "character"
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\caption[\label{tab:all-data-type} 函数 \texttt{typeof()} 返回的数据类型 ]{\label{tab:all-data-type} 函数 \texttt{typeof()} 返回的数据类型 \footnote{表格中带 *** 标记的类型，用户不能轻易获得}}\tabularnewline
\toprule
符号 & 含义 \\
\midrule
\endfirsthead
\toprule
符号 & 含义 \\
\midrule
\endhead
\texttt{NULL} & 空值 \\
\texttt{symbol} & 可变的名称/变量 \\
\texttt{pairlist} & pairlist 对象*** \\
\texttt{closure} & 函数闭包 \\
\texttt{environment} & 环境 \\
\texttt{promise} & 实现惰性求值的对象 \\
\texttt{language} & R 语言构造 \\
\texttt{special} & 内部函数，不计算参数 \\
\texttt{builtin} & 内部函数，计算参数 \\
\texttt{char} & scalar 型字符对象*** \\
\texttt{logical} & 逻辑向量 \\
\texttt{integer} & 整数向量 \\
\texttt{double} & 实值向量 \\
\texttt{complex} & 复值向量 \\
\texttt{character} & 字符向量 \\
\texttt{...} & 可变长度的参数*** \\
\texttt{any} & 匹配任意类型 \\
\texttt{expression} & 表达式对象 \\
\texttt{list} & 列表 \\
\texttt{bytecode} & 位代码*** \\
\texttt{externalptr} & 外部指针对象 \\
\texttt{weakref} & 弱引用对象 \\
\texttt{raw} & 位向量 \\
\texttt{S4} & S4 对象 \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.07}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.10}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.31}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.31}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.10}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.09}}@{}}
\caption{\label{tab:basic-data-type} R/Rcpp 提供的基本数据类型}\tabularnewline
\toprule
\begin{minipage}[b]{\linewidth}\centering
Value
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
R vector
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp vector
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp matrix
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp scalar
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
C++ scalar
\end{minipage} \\
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{\linewidth}\centering
Value
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
R vector
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp vector
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp matrix
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp scalar
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
C++ scalar
\end{minipage} \\
\midrule
\endhead
Logical & \texttt{logical} & \texttt{LogicalVector} & \texttt{LogicalMatrix} & - & \texttt{bool} \\
Integer & \texttt{integer} & \texttt{IntegerVector} & \texttt{IntegerMatrix} & - & \texttt{int} \\
Real & \texttt{numeric} & \texttt{NumericVector} & \texttt{NumericMatrix} & - & \texttt{double} \\
Complex & \texttt{complex} & \texttt{ComplexVector} & \texttt{ComplexMatrix} & \texttt{Rcomplex} & \texttt{complex} \\
String & \texttt{character} & \texttt{CharacterVector} (\texttt{StringVector}) & \texttt{CharacterMatrix} (\texttt{StringMatrix}) & \texttt{String} & \texttt{string} \\
Date & \texttt{Date} & \texttt{DateVector} & - & \texttt{Date} & - \\
Datetime & \texttt{POSIXct} & \texttt{DatetimeVector} & - & \texttt{Datetime} & \texttt{time\_t} \\
\bottomrule
\end{longtable}

\hypertarget{sec-character}{%
\section{字符}\label{sec-character}}

\hypertarget{sec-vector}{%
\section{向量}\label{sec-vector}}

\hypertarget{sec-matrix}{%
\section{矩阵}\label{sec-matrix}}

\hypertarget{sec-array}{%
\section{数组}\label{sec-array}}

更多数组操作 \href{https://github.com/r-lib/rray}{rray}

\hypertarget{sec-expression}{%
\section{表达式}\label{sec-expression}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# \%||\% 中缀符}
\CommentTok{\# x 是空值或者长度为 0 则保留 y 否则保留 x}
\ControlFlowTok{function}\NormalTok{(x, y) }\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(x) }\SpecialCharTok{||} \FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) y }\ControlFlowTok{else}\NormalTok{ x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function(x, y) if (is.null(x) || length(x) == 0) y else x
\end{verbatim}

\hypertarget{sec-list}{%
\section{列表}\label{sec-list}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{a =} \DecValTok{1}\NormalTok{, }\AttributeTok{b =} \DecValTok{2}\NormalTok{, }\AttributeTok{c =} \FunctionTok{list}\NormalTok{(}\AttributeTok{d =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{e =} \StringTok{"hello"}\NormalTok{))}
\FunctionTok{print}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $a
## [1] 1
## 
## $b
## [1] 2
## 
## $c
## $c$d
## [1] 1 2 3
## 
## $c$e
## [1] "hello"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{base}\SpecialCharTok{::}\FunctionTok{print.simple.list}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      _    
## a    1    
## b    2    
## c.d1 1    
## c.d2 2    
## c.d3 3    
## c.e  hello
\end{verbatim}

\hypertarget{sec-date}{%
\section{日期}\label{sec-date}}

注意观察时间转化

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.Date}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.time}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 08:57:58 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{c}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\FunctionTok{Sys.Date}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 08:57:58 UTC" "2021-10-05 00:00:00 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2021
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2021
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\FunctionTok{Sys.Date}\NormalTok{()))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2021 2021
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{Sys.time}\NormalTok{()}
\FunctionTok{class}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "POSIXct" "POSIXt"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"2019{-}12{-}21"}\NormalTok{, }\StringTok{"2019/12/21"}\NormalTok{)}
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\StringTok{"2019{-}12{-}21"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2019
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\StringTok{"2019/12/21"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2019
\end{verbatim}

但是，下面这样会报错

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in as.POSIXlt.character(x): character string is not in a standard unambiguous format
\end{verbatim}

正确的姿势是首先将表示日期的字符串格式统一

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"/"}\NormalTok{, }\AttributeTok{replacement =} \StringTok{"{-}"}\NormalTok{, x) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2019 2019
\end{verbatim}

date-times 表示 POSIXct 和 POSIXlt 类型的日期对象

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(x }\OtherTok{\textless{}{-}} \FunctionTok{Sys.time}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 08:57:58 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "POSIXct" "POSIXt"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{second}\NormalTok{(x) }\CommentTok{\# 取秒}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 58
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%S"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "58"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{minute}\NormalTok{(x) }\CommentTok{\# 取分}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 57
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%M"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "57"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{hour}\NormalTok{(x) }\CommentTok{\# 取时}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%H"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "08"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{yday}\NormalTok{(x) }\CommentTok{\# 此刻在一年的第几天}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 278
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{wday}\NormalTok{(x) }\CommentTok{\# 此刻在一周的第几天，星期日是第1天，星期六是第7天}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{mday}\NormalTok{(x) }\CommentTok{\# 此刻在当月第几天}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "05"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{weekdays}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Tuesday"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{weekdays}\NormalTok{(x, }\AttributeTok{abbreviate =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Tue"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{week}\NormalTok{(x) }\CommentTok{\# 此刻在第几周}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 40
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{isoweek}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 40
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{month}\NormalTok{(x) }\CommentTok{\# 此刻在第几月}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%m"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "10"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{months}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "October"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{months}\NormalTok{(x, }\AttributeTok{abbreviate =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Oct"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{quarter}\NormalTok{(x) }\CommentTok{\# 此刻在第几季度}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{quarters}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Q4"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(x) }\CommentTok{\# 取年}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2021
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%Y"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021"
\end{verbatim}

\begin{rmdtip}{提示}
\texttt{format()} 是一个泛型函数，此刻命名空间有 81 方法。 \texttt{format.Date()}， \texttt{format.difftime()}， \texttt{format.POSIXct()} 和 \texttt{format.POSIXlt()} 四个函数通过格式化不同类型的日期数据对象抽取指定部分。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{difftime}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), x, }\AttributeTok{units =} \StringTok{"secs"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "0.04712653 secs"
\end{verbatim}

日期转化详见 \citep{Brian_2001_date, Gabor_2004_date}

\end{rmdtip}

上个季度最后一天

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://d.cosx.org/d/421162/16}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\StringTok{"quarter"}\NormalTok{)) }\SpecialCharTok{{-}} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2019-12-31" "2020-03-31"
\end{verbatim}

本季度第一天

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\StringTok{"quarter"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2020-01-01" "2020-04-01"
\end{verbatim}

类似地，本月第一天和上月最后一天

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 本月第一天}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\StringTok{"month"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2020-02-01" "2020-05-01"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 上月最后一天}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{{-}} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2020-01-31" "2020-04-30"
\end{verbatim}

\textbf{timeDate} 提供了很多日期计算函数，比如季初、季末、月初、月末等

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(timeDate) }
\CommentTok{\# 季初}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{timeFirstDayInQuarter}\NormalTok{(}\AttributeTok{charvec =} \FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)) }
\CommentTok{\# 季末}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{timeLastDayInQuarter}\NormalTok{(}\AttributeTok{charvec =} \FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{))}
\CommentTok{\# 月初}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{timeFirstDayInMonth}\NormalTok{(}\AttributeTok{charvec =} \FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)) }
\CommentTok{\# 月末}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{timeLastDayInMonth}\NormalTok{(}\AttributeTok{charvec =} \FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)) }
\end{Highlighting}
\end{Shaded}

\texttt{cut.Date()} 是一个泛型函数，查看它的所有 S3 方法

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{methods}\NormalTok{(cut)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] cut.Date        cut.default     cut.dendrogram* cut.IDate*     
## [5] cut.POSIXt     
## see '?methods' for accessing help and source code
\end{verbatim}

格式化输出日期类型数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{formatC}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e8}\NormalTok{, }\FloatTok{1e9}\NormalTok{)), }\AttributeTok{digits =} \DecValTok{10}\NormalTok{, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "523,110,691"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Sys.setlocale(locale = "C") \# 如果是 Windows 系统，必须先设置，否则转化结果是 NA}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"1990{-}January"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{sep =} \StringTok{"{-}"}\NormalTok{), }\AttributeTok{format =} \StringTok{"\%Y{-}\%B{-}\%d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1990-01-01"
\end{verbatim}

获取当日零点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{as.POSIXlt}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{()), }\StringTok{"\%Y{-}\%m{-}\%d \%H:\%M:\%S"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 00:00:00"
\end{verbatim}

从 POSIXt 数据对象中，抽取小时和分钟部分，返回字符串

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strftime}\NormalTok{(}\AttributeTok{x =} \FunctionTok{Sys.time}\NormalTok{(), }\AttributeTok{format =} \StringTok{"\%H:\%M"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "08:57"
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.05}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.35}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.05}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.55}}@{}}
\caption{\label{tab:table-of-date} 日期表格}\tabularnewline
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
代码
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
代码
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} \\
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
代码
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
代码
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} \\
\midrule
\endhead
\texttt{\%a} & Abbreviated weekday & \texttt{\%A} & Full weekday \\
\texttt{\%b} & Abbreviated month & \texttt{\%B} & Full month \\
\texttt{\%c} & Locale-specific date and time & \texttt{\%d} & Decimal date \\
\texttt{\%H} & Decimal hours (24 hour) & \texttt{\%I} & Decimal hours (12 hour) \\
\texttt{\%j} & Decimal day of the year & \texttt{\%m} & Decimal month \\
\texttt{\%M} & Decimal minute & \texttt{\%p} & Locale-specific AM/PM \\
\texttt{\%S} & Decimal second & \texttt{\%U} & Decimal week of the year (starting on Sunday) \\
\texttt{\%w} & Decimal Weekday (0=Sunday) & \texttt{\%W} & Decimal week of the year (starting on Monday) \\
\texttt{\%x} & Locale-specific Date & \texttt{\%X} & Locale-specific Time \\
\texttt{\%y} & 2-digit year & \texttt{\%Y} & 4-digit year \\
\texttt{\%z} & Offset from GMT & \texttt{\%Z} & Time zone (character) \\
\bottomrule
\end{longtable}

本节介绍了 R 本身提供的基础日期操作，第\ref{chap-time-series-analysis}章着重介绍一般的时间序列类型的数据对象及其操作。

\href{https://blog.revolutionanalytics.com/2011/07/the-r-files-jeff-ryan.html}{Jeffrey A. Ryan} 开发的 \href{https://github.com/joshuaulrich/xts}{xts} 和 \href{https://github.com/joshuaulrich/quantmod}{quantmod} 包，Joshua M. Ulrich 开发的 \href{https://r-forge.r-project.org/projects/zoo/}{zoo} 是处理时间序列数据的主要工具

Jeffrey A. Ryan 在开设了一门免费课程教大家如何在 R 语言中使用 xts 和 zoo 包操作时间序列数据 \footnote{\url{https://www.datacamp.com/courses/manipulating-time-series-data-in-r-with-xts-zoo}}

xts (eXtensible Time Series) 扩展的 zoo 对象

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xts}\NormalTok{(}\AttributeTok{x =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{order.by =} \FunctionTok{index}\NormalTok{(x),}
    \AttributeTok{frequency =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{unique =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{tzone =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"TZ"}\NormalTok{),}
\NormalTok{    ...)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(zoo)}
\FunctionTok{library}\NormalTok{(xts)}
\NormalTok{x }\OtherTok{=} \FunctionTok{matrix}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{,}\AttributeTok{nrow =} \DecValTok{2}\NormalTok{)}
\NormalTok{idx }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2018{-}01{-}01"}\NormalTok{, }\StringTok{"2019{-}12{-}12"}\NormalTok{))}
\CommentTok{\# xts = matrix + index}
\FunctionTok{xts}\NormalTok{(x, }\AttributeTok{order.by =}\NormalTok{ idx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            [,1] [,2]
## 2018-01-01    1    3
## 2019-12-12    2    4
\end{verbatim}

Date，POSIX times，timeDate，chron 等各种各样处理日期数据的对象

\hypertarget{sec-null}{%
\section{空值}\label{sec-null}}

移除\texttt{list()} 列表里的为 \texttt{NULL} 元素

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rm\_null }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(l) }\FunctionTok{Filter}\NormalTok{(}\FunctionTok{Negate}\NormalTok{(is.null), l)}
\end{Highlighting}
\end{Shaded}

\hypertarget{chap-data-transportation}{%
\chapter{数据搬运}\label{chap-data-transportation}}

导入数据与导出数据，各种数据格式，数据库

处理 Excel 2003 (XLS) 和 Excel 2007 (XLSX) 文件还可以使用 \href{https://github.com/marcschwartz/WriteXLS}{WriteXLS} 包，不过它依赖于 Perl，另一个 R 包 \href{https://github.com/dragua/rexcel}{xlsx} 与之功能类似，依赖 Java 环境。Jennifer Bryan 和 Hadley Wickham 开发的 \href{https://github.com/tidyverse/readxl}{readxl} 包和 Jeroen Ooms 开发的 \href{https://github.com/ropensci/writexl}{writexl} 包专门处理 xlsx 格式并且无任何系统依赖。

\hypertarget{import-data}{%
\section{导入数据}\label{import-data}}

Base R 针对不同的数据格式文件，提供了大量的数据导入和导出函数，不愧是专注数据分析20余年的优秀统计软件。 除了函数 \texttt{write.ftable} 和 \texttt{read.ftable} 来自 stats 包，都来自 base 和 utils 包

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 当前环境的搜索路径}
\FunctionTok{searchpaths}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] ".GlobalEnv"                          
## [2] "/opt/R/4.1.1/lib/R/library/stats"    
## [3] "/opt/R/4.1.1/lib/R/library/graphics" 
## [4] "/opt/R/4.1.1/lib/R/library/grDevices"
## [5] "/opt/R/4.1.1/lib/R/library/utils"    
## [6] "/opt/R/4.1.1/lib/R/library/datasets" 
## [7] "/opt/R/4.1.1/lib/R/library/methods"  
## [8] "Autoloads"                           
## [9] "/opt/R/4.1.1/lib/R/library/base"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 返回匹配结果及其所在路径的编号}
\FunctionTok{apropos}\NormalTok{(}\StringTok{"\^{}(read|write)"}\NormalTok{, }\AttributeTok{where =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{mode =} \StringTok{"function"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  5                  5                  9                  5 
##         "read.csv"        "read.csv2"         "read.dcf"       "read.delim" 
##                  5                  5                  5                  2 
##      "read.delim2"         "read.DIF"     "read.fortran"      "read.ftable" 
##                  5                  5                  5                  9 
##         "read.fwf"      "read.socket"       "read.table"          "readBin" 
##                  9                  5                  9                  9 
##         "readChar" "readCitationFile"         "readline"        "readLines" 
##                  9                  9                  9                  5 
##          "readRDS"     "readRenviron"            "write"        "write.csv" 
##                  5                  9                  2                  5 
##       "write.csv2"        "write.dcf"     "write.ftable"     "write.socket" 
##                  5                  9                  9                  9 
##      "write.table"         "writeBin"        "writeChar"       "writeLines"
\end{verbatim}

\hypertarget{scan-file}{%
\subsection{\texorpdfstring{\texttt{scan}}{scan}}\label{scan-file}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\AttributeTok{file =} \StringTok{""}\NormalTok{, }\AttributeTok{what =} \FunctionTok{double}\NormalTok{(), }\AttributeTok{nmax =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{n =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{,}
     \AttributeTok{quote =} \ControlFlowTok{if}\NormalTok{(}\FunctionTok{identical}\NormalTok{(sep, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)) }\StringTok{""} \ControlFlowTok{else} \StringTok{"\textquotesingle{}}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\AttributeTok{dec =} \StringTok{"."}\NormalTok{,}
     \AttributeTok{skip =} \DecValTok{0}\NormalTok{, }\AttributeTok{nlines =} \DecValTok{0}\NormalTok{, }\AttributeTok{na.strings =} \StringTok{"NA"}\NormalTok{,}
     \AttributeTok{flush =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{strip.white =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{quiet =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{blank.lines.skip =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{multi.line =} \ConstantTok{TRUE}\NormalTok{,}
     \AttributeTok{comment.char =} \StringTok{""}\NormalTok{, }\AttributeTok{allowEscapes =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{fileEncoding =} \StringTok{""}\NormalTok{, }\AttributeTok{encoding =} \StringTok{"unknown"}\NormalTok{, text, }\AttributeTok{skipNul =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

首先让我们用 \texttt{cat} 函数创建一个练习数据集 \texttt{ex.data}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"TITLE extra line"}\NormalTok{, }\StringTok{"2 3 5 7"}\NormalTok{, }\StringTok{"11 13 17"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## TITLE extra line 2 3 5 7 11 13 17
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"TITLE extra line"}\NormalTok{, }\StringTok{"2 3 5 7"}\NormalTok{, }\StringTok{"11 13 17"}\NormalTok{, }\AttributeTok{file =} \StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

以此练习数据集，介绍 \texttt{scan} 函数最常用的参数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in scan("data/ex.data"): scan() expected 'a real', got 'TITLE'
\end{verbatim}

从上面的报错信息，我们发现 \texttt{scan} 函数只能读取同一类型的数据，如布尔型 logical， 整型 integer，数值型 numeric(double)， 复数型 complex，字符型 character，raw 和列表 list。所以我们设置参数 \texttt{skip\ =\ 1} 把第一行跳过，就成功读取了数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{skip =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  2  3  5  7 11 13 17
\end{verbatim}

如果设置参数 \texttt{quiet\ =\ TRUE} 就不会报告读取的数据量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{skip =} \DecValTok{1}\NormalTok{, }\AttributeTok{quiet =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  2  3  5  7 11 13 17
\end{verbatim}

参数 \texttt{nlines\ =\ 1} 表示只读取一行数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{skip =} \DecValTok{1}\NormalTok{, }\AttributeTok{nlines =} \DecValTok{1}\NormalTok{) }\CommentTok{\# only 1 line after the skipped one}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2 3 5 7
\end{verbatim}

默认参数 \texttt{flush\ =\ TRUE} 表示读取最后一个请求的字段后，刷新到行尾，下面对比一下读取的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{what =} \FunctionTok{list}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{)) }\CommentTok{\# flush is F {-}\textgreater{} read "7"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in scan("data/ex.data", what = list("", "", "")): number of items read
## is not a multiple of the number of columns
\end{verbatim}

\begin{verbatim}
## [[1]]
## [1] "TITLE" "2"     "7"     "17"   
## 
## [[2]]
## [1] "extra" "3"     "11"    ""     
## 
## [[3]]
## [1] "line" "5"    "13"   ""
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{what =} \FunctionTok{list}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{), }\AttributeTok{flush =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "TITLE" "2"     "11"   
## 
## [[2]]
## [1] "extra" "3"     "13"   
## 
## [[3]]
## [1] "line" "5"    "17"
\end{verbatim}

临时文件 ex.data 用完了，我们调用 \texttt{unlink} 函数将其删除，以免留下垃圾文件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlink}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{) }\CommentTok{\# tidy up}
\end{Highlighting}
\end{Shaded}

\hypertarget{read-write-table}{%
\subsection{\texorpdfstring{\texttt{read.table}}{read.table}}\label{read-write-table}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read.table}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{\textquotesingle{}"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{"."}\NormalTok{, }\AttributeTok{numerals =} \FunctionTok{c}\NormalTok{(}\StringTok{"allow.loss"}\NormalTok{, }\StringTok{"warn.loss"}\NormalTok{, }\StringTok{"no.loss"}\NormalTok{),}
\NormalTok{  row.names, col.names, }\AttributeTok{as.is =} \SpecialCharTok{!}\NormalTok{stringsAsFactors,}
  \AttributeTok{na.strings =} \StringTok{"NA"}\NormalTok{, }\AttributeTok{colClasses =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{nrows =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
  \AttributeTok{skip =} \DecValTok{0}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fill =} \SpecialCharTok{!}\NormalTok{blank.lines.skip,}
  \AttributeTok{strip.white =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{blank.lines.skip =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{comment.char =} \StringTok{"\#"}\NormalTok{,}
  \AttributeTok{allowEscapes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{flush =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{stringsAsFactors =} \FunctionTok{default.stringsAsFactors}\NormalTok{(),}
  \AttributeTok{fileEncoding =} \StringTok{""}\NormalTok{, }\AttributeTok{encoding =} \StringTok{"unknown"}\NormalTok{, text, }\AttributeTok{skipNul =} \ConstantTok{FALSE}
\NormalTok{)}

\FunctionTok{read.csv}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sep =} \StringTok{","}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{"."}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, ...}
\NormalTok{)}

\FunctionTok{read.csv2}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sep =} \StringTok{";"}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{","}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, ...}
\NormalTok{)}

\FunctionTok{read.delim}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{"."}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, ...}
\NormalTok{)}

\FunctionTok{read.delim2}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{","}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, ...}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

变量名是不允许以下划线开头的，同样在数据框里，列名也不推荐使用下划线开头。默认情况下，\texttt{read.table} 都会通过参数 \texttt{check.names} 检查列名的有效性，该参数实际调用了函数 \texttt{make.names} 去检查。如果想尽量保持数据集原来的样子可以设置参数 \texttt{check.names\ =\ FALSE,\ stringsAsFactors\ =\ FALSE}。 默认情形下，\texttt{read.table} 还会将字符串转化为因子变量，这是 R 的历史原因，作为一门统计学家的必备语言，在统计模型中，字符常用来描述类别，而类别变量在 R 环境中常用因子类型来表示，而且大量内置的统计模型也是将它们视为因子变量，如 \texttt{lm} 、\texttt{glm} 等

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat1 }\OtherTok{=} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{text =} \StringTok{"}
\StringTok{\_a \_b \_c}
\StringTok{1 2 a1}
\StringTok{3 4 a2}
\StringTok{"}\NormalTok{)}
\NormalTok{dat1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   X_a X_b X_c
## 1   1   2  a1
## 2   3   4  a2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat2 }\OtherTok{=} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{text =} \StringTok{"}
\StringTok{\_a \_b \_c}
\StringTok{1 2 a1}
\StringTok{3 4 a2}
\StringTok{"}\NormalTok{)}
\NormalTok{dat2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   _a _b _c
## 1  1  2 a1
## 2  3  4 a2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat3 }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{text =} \StringTok{"}
\StringTok{\_a \_b \_c}
\StringTok{1 2 a1}
\StringTok{3 4 a2}
\StringTok{"}
\NormalTok{)}
\NormalTok{dat3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   _a _b _c
## 1  1  2 a1
## 2  3  4 a2
\end{verbatim}

\hypertarget{read-write-lines}{%
\subsection{\texorpdfstring{\texttt{readLines}}{readLines}}\label{read-write-lines}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{readLines}\NormalTok{(}\AttributeTok{con =} \FunctionTok{stdin}\NormalTok{(), }\AttributeTok{n =} \SpecialCharTok{{-}}\NormalTok{1L, }\AttributeTok{ok =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{warn =} \ConstantTok{TRUE}\NormalTok{,}
          \AttributeTok{encoding =} \StringTok{"unknown"}\NormalTok{, }\AttributeTok{skipNul =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

让我们折腾一波，读进来又写出去，只有 R 3.5.3 以上才能保持原样的正确输入输出，因为这里有一个之前版本包含的 BUG

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"DESCRIPTION"}\NormalTok{, }\AttributeTok{package =} \StringTok{"splines"}\NormalTok{)), }\StringTok{"data/DESCRIPTION"}\NormalTok{)}
\CommentTok{\# 比较一下}
\FunctionTok{identical}\NormalTok{(}
  \FunctionTok{readLines}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"DESCRIPTION"}\NormalTok{, }\AttributeTok{package =} \StringTok{"splines"}\NormalTok{)),}
  \FunctionTok{readLines}\NormalTok{(}\StringTok{"data/DESCRIPTION"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

这次我们创建一个真的临时文件，因为重新启动 R 这个文件和文件夹就没有了，回收掉了

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fil }\OtherTok{\textless{}{-}} \FunctionTok{tempfile}\NormalTok{(}\AttributeTok{fileext =} \StringTok{".data"}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"TITLE extra line"}\NormalTok{, }\StringTok{"2 3 5 7"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"11 13 17"}\NormalTok{, }\AttributeTok{file =}\NormalTok{ fil,}
    \AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{fil}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/tmp/RtmpVDylq1/filedb2f4a186843.data"
\end{verbatim}

设置参数 \texttt{n\ =\ -1} 表示将文件 fil 的内容从头读到尾

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{readLines}\NormalTok{(fil, }\AttributeTok{n =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "TITLE extra line" "2 3 5 7"          ""                 "11 13 17"
\end{verbatim}

作为拥有良好习惯的 R 用户，这种垃圾文件最好用后即焚

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlink}\NormalTok{(fil) }\CommentTok{\# tidy up}
\end{Highlighting}
\end{Shaded}

再举个例子，我们创建一个新的临时文件 \texttt{fil}，文件内容只有

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"123}\SpecialCharTok{\textbackslash{}n}\StringTok{abc"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 123
## abc
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fil }\OtherTok{\textless{}{-}} \FunctionTok{tempfile}\NormalTok{(}\StringTok{"test"}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"123}\SpecialCharTok{\textbackslash{}n}\StringTok{abc}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{file =}\NormalTok{ fil, }\AttributeTok{append =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{fil}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/tmp/RtmpVDylq1/testdb2f32ef29ea"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{readLines}\NormalTok{(fil)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "123" "abc"
\end{verbatim}

这次读取文件的过程给出了警告，原因是 fil 没有以空行结尾，\texttt{warn\ =\ TRUE} 表示这种情况要给出警告，如果设置参数 \texttt{warn\ =\ FALSE} 就没有警告。我们还是建议大家尽量遵循规范。

再举一个例子，从一个连接读取数据，建立连接的方式有很多，参见 \texttt{?file}，下面设置参数 \texttt{blocking}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{con }\OtherTok{\textless{}{-}} \FunctionTok{file}\NormalTok{(fil, }\StringTok{"r"}\NormalTok{, }\AttributeTok{blocking =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{readLines}\NormalTok{(con)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "123" "abc"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{" def}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{file =}\NormalTok{ fil, }\AttributeTok{append =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{readLines}\NormalTok{(con)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] " def"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 关闭连接}
\FunctionTok{close}\NormalTok{(con)}
\CommentTok{\# 清理垃圾文件}
\FunctionTok{unlink}\NormalTok{(fil)}
\end{Highlighting}
\end{Shaded}

\hypertarget{read-save-rds}{%
\subsection{\texorpdfstring{\texttt{readRDS}}{readRDS}}\label{read-save-rds}}

序列化数据操作，Mark Klik 开发的 \href{https://github.com/fstpackage/fst}{fst} 和 \href{https://travers.im/}{Travers Ching} 开发的 \href{https://github.com/traversc/qs}{qs}， Hadley Wickham 开发的 \href{https://github.com/wesm/feather/tree/master/R}{feather} 包实现跨语言环境快速的读写数据

\begin{longtable}[]{@{}llllll@{}}
\caption[\label{tab:fst-vs-others} fst 序列化数据框对象性能比较 BaseR、 data.table 和 feather ]{\label{tab:fst-vs-others} fst 序列化数据框对象性能比较 BaseR、 data.table 和 feather \footnote{\url{https://www.fstpackage.org/}}}\tabularnewline
\toprule
Method & Format & Time (ms) & Size (MB) & Speed (MB/s) & N \\
\midrule
\endfirsthead
\toprule
Method & Format & Time (ms) & Size (MB) & Speed (MB/s) & N \\
\midrule
\endhead
readRDS & bin & 1577 & 1000 & 633 & 112 \\
saveRDS & bin & 2042 & 1000 & 489 & 112 \\
fread & csv & 2925 & 1038 & 410 & 232 \\
fwrite & csv & 2790 & 1038 & 358 & 241 \\
read\_feather & bin & 3950 & 813 & 253 & 112 \\
write\_feather & bin & 1820 & 813 & 549 & 112 \\
\textbf{read\_fst} & \textbf{bin} & \textbf{457} & \textbf{303} & \textbf{2184} & \textbf{282} \\
\textbf{write\_fst} & \textbf{bin} & \textbf{314} & \textbf{303} & \textbf{3180} & \textbf{291} \\
\bottomrule
\end{longtable}

目前比较好的是 qs 和 fst 包

\hypertarget{other-data-source}{%
\section{其它数据格式}\label{other-data-source}}

来自其它格式的数据形式，如 JSON、XML、YAML 需要转化清理成 R 中数据框的形式 data.frame

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \href{https://www.carlboettiger.info/2017/12/11/data-rectangling-with-jq/}{Data Rectangling with jq}
\item
  \href{https://jeroen.github.io/mongolite/}{Mongolite User Manual} introduction to using MongoDB with the mongolite client in R
\end{enumerate}

\href{https://github.com/jeroen/jsonlite}{jsonlite} 读取 \texttt{*.json} 格式的文件，\texttt{jsonlite::write\_json} 函数将 R对象保存为 JSON 文件，\texttt{jsonlite::fromJSON} 将 json 字符串或文件转化为 R 对象，\texttt{jsonlite::toJSON} 函数正好与之相反

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(jsonlite)}
\CommentTok{\# 从 json 格式的文件导入}
\CommentTok{\# jsonlite::read\_json(path = "path/to/filename.json")}
\CommentTok{\# A JSON array of primitives}
\NormalTok{json }\OtherTok{\textless{}{-}} \StringTok{\textquotesingle{}["Mario", "Peach", null, "Bowser"]\textquotesingle{}}

\CommentTok{\# 简化为原子向量atomic vector}
\FunctionTok{fromJSON}\NormalTok{(json)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Mario"  "Peach"  NA       "Bowser"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 默认返回一个列表}
\FunctionTok{fromJSON}\NormalTok{(json, }\AttributeTok{simplifyVector =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "Mario"
## 
## [[2]]
## [1] "Peach"
## 
## [[3]]
## NULL
## 
## [[4]]
## [1] "Bowser"
\end{verbatim}

yaml 包读取 \texttt{*.yml} 格式文件，返回一个列表，\texttt{yaml::write\_yaml} 函数将 R 对象写入 yaml 格式

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(yaml)}
\NormalTok{yaml}\SpecialCharTok{::}\FunctionTok{read\_yaml}\NormalTok{(}\AttributeTok{file =} \StringTok{\textquotesingle{}\_bookdown.yml\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $book_filename
## [1] "masr"
## 
## $delete_merged_file
## [1] TRUE
## 
## $language
## $language$label
## $language$label$fig
## [1] "图 "
## 
## $language$label$tab
## [1] "表 "
## 
## 
## $language$ui
## $language$ui$edit
## [1] "编辑"
## 
## $language$ui$chapter_name
## [1] "第 " " 章"
## 
## $language$ui$appendix_name
## [1] "附录 "
## 
## 
## 
## $new_session
## [1] TRUE
## 
## $before_chapter_script
## [1] "_common.R"
## 
## $rmd_files
##  [1] "index.Rmd"                       "preface.Rmd"                    
##  [3] "data-wrangling.Rmd"              "data-structure.Rmd"             
##  [5] "data-transportation.Rmd"         "string-operations.Rmd"          
##  [7] "regular-expressions.Rmd"         "data-manipulation.Rmd"          
##  [9] "advanced-manipulation.Rmd"       "parallel-manipulation.Rmd"      
## [11] "other-manipulation.Rmd"          "statistical-graphics.Rmd"       
## [13] "graphics-foundations.Rmd"        "data-visualization.Rmd"         
## [15] "interactive-web-graphics.Rmd"    "dynamic-documents.Rmd"          
## [17] "document-elements.Rmd"           "portable-documents.Rmd"         
## [19] "web-documents.Rmd"               "office-documents.Rmd"           
## [21] "reproducible-workflows.Rmd"      "advanced-documents.Rmd"         
## [23] "data-product.Rmd"                "interactive-data-tables.Rmd"    
## [25] "interactive-shiny-app.Rmd"       "statistical-foundations.Rmd"    
## [27] "sampling-distributions.Rmd"      "parameter-estimators.Rmd"       
## [29] "hypothesis-test.Rmd"             "power-analysis.Rmd"             
## [31] "experimental-design.Rmd"         "statistical-models.Rmd"         
## [33] "linear-models.Rmd"               "generalized-linear-models.Rmd"  
## [35] "bayesian-models.Rmd"             "data-modeling.Rmd"              
## [37] "text-analysis.Rmd"               "survival-analysis.Rmd"          
## [39] "time-series-analysis.Rmd"        "spatio-temporal-data.Rmd"       
## [41] "spatial-analysis.Rmd"            "spatial-modeling.Rmd"           
## [43] "spatial-viz.Rmd"                 "case-study.Rmd"                 
## [45] "data-explorer.Rmd"               "machine-learning.Rmd"           
## [47] "gradient-boosting-machine.Rmd"   "numerical-optimization.Rmd"     
## [49] "appendix.Rmd"                    "matrix-operations.Rmd"          
## [51] "symbolic-computation.Rmd"        "mixed-programming.Rmd"          
## [53] "object-oriented-programming.Rmd" "file-operations.Rmd"            
## [55] "other-softwares.Rmd"             "notations.Rmd"                  
## [57] "references.Rmd"
\end{verbatim}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:other-softwares} 导入来自其它数据分析软件产生的数据集}\tabularnewline
\toprule
统计软件 & R函数 & R包 \\
\midrule
\endfirsthead
\toprule
统计软件 & R函数 & R包 \\
\midrule
\endhead
ERSI ArcGIS & \texttt{read.shapefile} & shapefiles \\
Matlab & \texttt{readMat} & R.matlab \\
minitab & \texttt{read.mtp} & foreign \\
SAS (permanent data) & \texttt{read.ssd} & foreign \\
SAS (XPORT format) & \texttt{read.xport} & foreign \\
SPSS & \texttt{read.spss} & foreign \\
Stata & \texttt{read.dta} & foreign \\
Systat & \texttt{read.systat} & foreign \\
Octave & \texttt{read.octave} & foreign \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:other-read-functions} 导入来自其它格式的数据集}\tabularnewline
\toprule
文件格式 & R函数 & R包 \\
\midrule
\endfirsthead
\toprule
文件格式 & R函数 & R包 \\
\midrule
\endhead
列联表数据 & \texttt{read.ftable} & stats \\
二进制数据 & \texttt{readBin} & base \\
字符串数据 & \texttt{readChar} & base \\
剪贴板数据 & \texttt{readClipboard} & utils \\
\bottomrule
\end{longtable}

\texttt{read.dcf} 函数读取 Debian 控制格式文件，这种类型的文件以人眼可读的形式在存储数据，如 R 包的 DESCRIPTION 文件或者包含所有 CRAN 上 R 包描述的文件 \url{https://cran.r-project.org/src/contrib/PACKAGES}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.dcf}\NormalTok{(}\AttributeTok{file =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"DESCRIPTION"}\NormalTok{, }\AttributeTok{package =} \StringTok{"splines"}\NormalTok{),}
              \AttributeTok{fields =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Version"}\NormalTok{, }\StringTok{"Title"}\NormalTok{))}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Package   Version Title                                    
## [1,] "splines" "4.1.1" "Regression Spline Functions and Classes"
\end{verbatim}

最后要提及拥有瑞士军刀之称的 \href{https://github.com/leeper/rio}{rio} 包，它集合了当前 R 可以读取的所有统计分析软件导出的数据。

\hypertarget{import-large-dataset}{%
\section{导入大数据集}\label{import-large-dataset}}

在不使用数据库的情况下，从命令行导入大数据集，如几百 M 或几个 G 的 csv 文件。利用 data.table 包的 \texttt{fread} 去读取

\url{https://stackoverflow.com/questions/1727772/}

\hypertarget{import-data-from-database}{%
\section{从数据库导入}\label{import-data-from-database}}

\href{https://rstudio-education.github.io/hopr}{Hands-On Programming with R} 数据读写章节\footnote{\url{https://rstudio-education.github.io/hopr/dataio.html}} 以及 \href{https://smithjd.github.io/sql-pet/}{R, Databases and Docker}

将大量的 txt 文本存进 MySQL 数据库中，通过操作数据库来聚合文本，极大降低内存消耗 \footnote{\url{https://brucezhaor.github.io/blog/2016/08/04/batch-process-txt-to-mysql}}，而 ODBC 与 DBI 包是其它数据库接口的基础，knitr 提供了一个支持 SQL 代码的引擎，它便是基于 DBI，因此可以在 R Markdown 文档中直接使用 SQL 代码块 \footnote{\url{https://bookdown.org/yihui/rmarkdown/language-engines.html\#sql} {[}rstudio-spark{]}: \url{https://spark.rstudio.com/} {[}rmarkdown-teaching-demo{]}: \url{https://stackoverflow.com/questions/35459166}}。这里制作一个归纳表格，左边数据库右边对应其 R 接口，两边都包含链接，如表 \ref{tab:dbi} 所示

\begin{table}

\caption{\label{tab:dbi}数据库接口}
\centering
\begin{tabular}[t]{l|l|l|l}
\hline
数据库 & 官网 & R接口 & 开发仓\\
\hline
MySQL & https://www.mysql.com/ & RMySQL & https://github.com/r-dbi/RMySQL\\
\hline
SQLite & https://www.sqlite.org & RSQLite & https://github.com/r-dbi/RSQLite\\
\hline
PostgreSQL & https://www.postgresql.org/ & RPostgres & https://github.com/r-dbi/RPostgres\\
\hline
MariaDB & https://mariadb.org/ & RMariaDB & https://github.com/r-dbi/RMariaDB\\
\hline
\end{tabular}
\end{table}

\hypertarget{postgresql}{%
\subsection{PostgreSQL}\label{postgresql}}

\href{https://github.com/r-dbi/odbc}{odbc} 可以支持很多数据库，下面以连接 \href{https://www.postgresql.org/}{PostgreSQL} 数据库为例介绍其过程

首先在某台机器上，拉取 PostgreSQL 的 Docker 镜像

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ pull postgres}
\end{Highlighting}
\end{Shaded}

在 Docker 上运行 PostgreSQL，主机端口号 8181 映射给数据库 PostgreSQL 的默认端口号 5432（或其它你的 DBA 分配给你的端口）

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}{-}name}\NormalTok{ psql }\AttributeTok{{-}d} \AttributeTok{{-}p}\NormalTok{ 8181:5432 }\AttributeTok{{-}e}\NormalTok{ ROOT=TRUE }\DataTypeTok{\textbackslash{}}
   \AttributeTok{{-}e}\NormalTok{ USER=xiangyun }\AttributeTok{{-}e}\NormalTok{ PASSWORD=cloud postgres}
\end{Highlighting}
\end{Shaded}

在主机 Ubuntu 上配置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install unixodbc unixodbc{-}dev odbc{-}postgresql}
\end{Highlighting}
\end{Shaded}

端口 5432 是分配给 PostgreSQL 的默认端口，\texttt{host} 可以是云端的地址，如 你的亚马逊账户下的 PostgreSQL 数据库地址 \texttt{\textless{}ec2-54-83-201-96.compute-1.amazonaws.com\textgreater{}}，也可以是本地局域网IP地址，如\texttt{\textless{}192.168.1.200\textgreater{}}。通过参数 \texttt{dbname} 连接到指定的 PostgreSQL 数据库，如 Heroku，这里作为演示就以默认的数据库 \texttt{postgres} 为例

查看配置系统文件路径

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{odbcinst} \AttributeTok{{-}j} 
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
unixODBC 2.3.6
DRIVERS............: /etc/odbcinst.ini
SYSTEM DATA SOURCES: /etc/odbc.ini
FILE DATA SOURCES..: /etc/ODBCDataSources
USER DATA SOURCES..: /root/.odbc.ini
SQLULEN Size.......: 8
SQLLEN Size........: 8
SQLSETPOSIROW Size.: 8
\end{verbatim}

不推荐修改全局配置文件，可设置 \texttt{ODBCSYSINI} 环境变量指定配置文件路径，如 \texttt{ODBCSYSINI=\textasciitilde{}/ODBC} \url{http://www.unixodbc.org/odbcinst.html}

安装完驱动程序，\texttt{/etc/odbcinst.ini} 文件内容自动更新，我们可以不必修改，如果你想自定义不妨手动修改，我们查看在 R 环境中注册的数据库，可以看到 PostgreSQL 的驱动已经配置好

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{odbc}\SpecialCharTok{::}\FunctionTok{odbcListDrivers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                 name   attribute                                    value
1     PostgreSQL ANSI Description    PostgreSQL ODBC driver (ANSI version)
2     PostgreSQL ANSI      Driver                             psqlodbca.so
3     PostgreSQL ANSI       Setup                          libodbcpsqlS.so
4     PostgreSQL ANSI       Debug                                        0
5     PostgreSQL ANSI     CommLog                                        1
6     PostgreSQL ANSI  UsageCount                                        1
7  PostgreSQL Unicode Description PostgreSQL ODBC driver (Unicode version)
8  PostgreSQL Unicode      Driver                             psqlodbcw.so
9  PostgreSQL Unicode       Setup                          libodbcpsqlS.so
10 PostgreSQL Unicode       Debug                                        0
11 PostgreSQL Unicode     CommLog                                        1
12 PostgreSQL Unicode  UsageCount                                        1
\end{verbatim}

系统配置文件 \texttt{/etc/odbcinst.ini} 已经包含有 PostgreSQL 的驱动配置，无需再重复配置

\begin{verbatim}
[PostgreSQL ANSI]
Description=PostgreSQL ODBC driver (ANSI version)
Driver=psqlodbca.so
Setup=libodbcpsqlS.so
Debug=0
CommLog=1
UsageCount=1

[PostgreSQL Unicode]
Description=PostgreSQL ODBC driver (Unicode version)
Driver=psqlodbcw.so
Setup=libodbcpsqlS.so
Debug=0
CommLog=1
UsageCount=1
\end{verbatim}

只需将如下内容存放在 \texttt{\textasciitilde{}/.odbc.ini} 文件中，

\begin{verbatim}
[PostgreSQL]
Driver              = PostgreSQL Unicode
Database            = postgres
Servername          = 172.17.0.1
UserName            = postgres
Password            = default
Port                = 8080
\end{verbatim}

最后，一行命令 DNS 配置连接 \url{https://github.com/r-dbi/odbc} 这样就实现了代码中无任何敏感信息，这里为了展示这个配置过程故而把相关信息公开。

\begin{quote}
注意下面的内容需要在容器中运行， Windows 环境下的配置 PostgreSQL 的驱动有点麻烦就不搞了，意义也不大，现在数据库基本都是跑在 Linux 系统上
\end{quote}

\texttt{docker-machine.exe\ ip\ default} 可以获得本地 Docker 的 IP，比如 192.168.99.101。 Travis 上 \texttt{ip\ addr} 可以查看 Docker 的 IP，如 172.17.0.1

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\NormalTok{con }\OtherTok{\textless{}{-}} \FunctionTok{dbConnect}\NormalTok{(RPostgres}\SpecialCharTok{::}\FunctionTok{Postgres}\NormalTok{(),}
  \AttributeTok{dbname =} \StringTok{"postgres"}\NormalTok{,}
  \AttributeTok{host =} \FunctionTok{ifelse}\NormalTok{(is\_on\_travis, }\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"DOCKER\_HOST\_IP"}\NormalTok{), }\StringTok{"192.168.99.101"}\NormalTok{),}
  \AttributeTok{port =} \DecValTok{8080}\NormalTok{,}
  \AttributeTok{user =} \StringTok{"postgres"}\NormalTok{,}
  \AttributeTok{password =} \StringTok{"default"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\NormalTok{con }\OtherTok{\textless{}{-}} \FunctionTok{dbConnect}\NormalTok{(odbc}\SpecialCharTok{::}\FunctionTok{odbc}\NormalTok{(), }\StringTok{"PostgreSQL"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

列出数据库中的所有表

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbListTables}\NormalTok{(con)}
\end{Highlighting}
\end{Shaded}

第一次启动从 Docker Hub 上下载的镜像，默认的数据库是 postgres 里面没有任何表，所以将 R 环境中的 mtcars 数据集写入 postgres 数据库

将数据集 mtcars 写入 PostgreSQL 数据库中，基本操作，写入表的操作也不能缓存，即不能缓存数据库中的表 mtcars

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbWriteTable}\NormalTok{(con, }\StringTok{"mtcars"}\NormalTok{, mtcars, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

现在可以看到数据表 mtcars 的各个字段

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbListFields}\NormalTok{(con, }\StringTok{"mtcars"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

最后执行一条 SQL 语句

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{dbSendQuery}\NormalTok{(con, }\StringTok{"SELECT * FROM mtcars WHERE cyl = 4"}\NormalTok{) }\CommentTok{\# 发送 SQL 语句}
\FunctionTok{dbFetch}\NormalTok{(res) }\CommentTok{\# 获取查询结果}
\FunctionTok{dbClearResult}\NormalTok{(res) }\CommentTok{\# 清理查询通道}
\end{Highlighting}
\end{Shaded}

或者一条命令搞定

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbGetQuery}\NormalTok{(con, }\StringTok{"SELECT * FROM mtcars WHERE cyl = 4"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

再复杂一点的 SQL 查询操作

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbGetQuery}\NormalTok{(con, }\StringTok{"SELECT cyl, AVG(mpg) AS mpg FROM mtcars GROUP BY cyl ORDER BY cyl"}\NormalTok{)}
\FunctionTok{aggregate}\NormalTok{(mpg }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl, }\AttributeTok{data =}\NormalTok{ mtcars, mean)}
\end{Highlighting}
\end{Shaded}

得益于 knitr \citep{xie2015} 开发的钩子，这里直接写 SQL 语句块，值得注意的是 SQL 代码块不能启用缓存，数据库连接通道也不能缓存，如果数据库中还没有写入表，那么写入表的操作也不能缓存， \texttt{tab.cap\ =\ "表格标题"} 输出的内容是一个表格

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{SELECT}\NormalTok{ cyl, }\FunctionTok{AVG}\NormalTok{(mpg) }\KeywordTok{AS}\NormalTok{ mpg }\KeywordTok{FROM}\NormalTok{ mtcars }\KeywordTok{GROUP} \KeywordTok{BY}\NormalTok{ cyl }\KeywordTok{ORDER} \KeywordTok{BY}\NormalTok{ cyl}
\end{Highlighting}
\end{Shaded}

如果将查询结果导出到变量，在 Chunk 设置 \texttt{output.var\ =\ "agg\_cyl"} 可以使用缓存，下面将 mpg 按 cyl 分组聚合的结果打印出来，\texttt{ref.label\ =\ "mtcars"} 引用上一个 SQL 代码块的内容

这种基于 odbc 的方式的好处就不需要再安装 R 包 RPostgres 和相关系统依赖，最后关闭连接通道

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbDisconnect}\NormalTok{(con)}
\end{Highlighting}
\end{Shaded}

\hypertarget{mysql}{%
\subsection{MySQL}\label{mysql}}

MySQL 是一个很常见，应用也很广泛的数据库，数据分析的常见环境是在一个R Notebook 里，我们可以在正文之前先设定数据库连接信息

\begin{verbatim}
```{r setup}
library(DBI)
# 指定数据库连接信息
db <- dbConnect(RMySQL::MySQL(),
  dbname = 'dbtest',
  username = 'user_test',
  password = 'password',
  host = '10.10.101.10',
  port = 3306
)
# 创建默认连接
knitr::opts_chunk$set(connection = 'db')
# 设置字符编码，以免中文查询乱码
DBI::dbSendQuery(db, 'SET NAMES utf8')
# 设置日期变量，以运用在SQL中
idate <- '2019-05-03'
```
\end{verbatim}

SQL 代码块中使用 R 环境中的变量，并将查询结果输出为R环境中的数据框

\begin{verbatim}
```{sql, output.var='data_output'}
SELECT * FROM user_table where date_format(created_date,'%Y-%m-%d')>=?idate
```
\end{verbatim}

以上代码会将 SQL 的运行结果存在 \texttt{data\_output} 这是数据库中，idate 取之前设置的日期\texttt{2019-05-03}，\texttt{user\_table} 是 MySQL 数据库中的表名，\texttt{created\_date} 是创建\texttt{user\_table}时，指定的日期名。

如果 SQL 比较长，为了代码美观，把带有变量的 SQL 保存为\texttt{demo.sql}脚本，只需要在 SQL 的 chunk 中直接读取 SQL 文件\footnote{\url{https://d.cosx.org/d/419974}}。

\begin{verbatim}
```{sql, code=readLines('demo.sql'), output.var='data_output'}
```
\end{verbatim}

如果我们需要每天或者按照指定的日期重复地运行这个 R Markdown 文件，可以在 YAML 部分引入参数\footnote{\url{https://bookdown.org/yihui/rmarkdown/params-knit.html}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{{-}{-}{-}}
\AnnotationTok{params:}
\CommentTok{  date: "2019{-}05{-}03"  \# 参数化日期}
\CommentTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
```{r setup, include=FALSE}
idate = params$date # 将参数化日期传递给 idate 变量
```
\end{verbatim}

我们将这个 Rmd 文件命名为 \texttt{MyDocument.Rmd}，运行这个文件可以从 R 控制台执行或在 RStudio 点击 knit。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rmarkdown}\SpecialCharTok{::}\FunctionTok{render}\NormalTok{(}\StringTok{"MyDocument.Rmd"}\NormalTok{, }\AttributeTok{params =} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{date =} \StringTok{"2019{-}05{-}03"}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

如果在文档的 YAML 位置已经指定日期，这里可以不指定。注意在这里设置日期会覆盖 YAML 处指定的参数值，这样做的好处是可以批量化操作。

\hypertarget{spark}{%
\subsection{Spark}\label{spark}}

当数据分析报告遇上 Spark 时，就需要 \href{https://github.com/apache/spark/tree/master/R}{SparkR}、 \href{https://github.com/rstudio/sparklyr}{sparklyr}、 \href{https://github.com/apache/arrow/tree/master/r}{arrow} 或 \href{https://github.com/h2oai/sparkling-water/tree/master/r}{rsparking} 接口了， Javier Luraschi 写了一本书 \href{https://therinspark.com/}{The R in Spark: Learning Apache Spark with R} 详细介绍了相关扩展和应用

首先安装 sparklyr 包，RStudio 公司 Javier Lurasch 开发了 sparklyr 包，作为 Spark 与 R 语言之间的接口，安装完 sparklyr 包，还是需要 Spark 和 Hadoop 环境

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}sparklyr\textquotesingle{}}\NormalTok{)}
\FunctionTok{library}\NormalTok{(sparklyr)}
\FunctionTok{spark\_install}\NormalTok{()}
\CommentTok{\# Installing Spark 2.4.0 for Hadoop 2.7 or later.}
\CommentTok{\# Downloading from:}
\CommentTok{\# {-} \textquotesingle{}https://archive.apache.org/dist/spark/spark{-}2.4.0/spark{-}2.4.0{-}bin{-}hadoop2.7.tgz\textquotesingle{}}
\CommentTok{\# Installing to:}
\CommentTok{\# {-} \textquotesingle{}\textasciitilde{}/spark/spark{-}2.4.0{-}bin{-}hadoop2.7\textquotesingle{}}
\CommentTok{\# trying URL \textquotesingle{}https://archive.apache.org/dist/spark/spark{-}2.4.0/spark{-}2.4.0{-}bin{-}hadoop2.7.tgz\textquotesingle{}}
\CommentTok{\# Content type \textquotesingle{}application/x{-}gzip\textquotesingle{} length 227893062 bytes (217.3 MB)}
\CommentTok{\# ==================================================}
\CommentTok{\# downloaded 217.3 MB}
\CommentTok{\# }
\CommentTok{\# Installation complete.}
\end{Highlighting}
\end{Shaded}

既然 sparklyr 已经安装了 Spark 和 Hadoop 环境，安装 SparkR 后，只需配置好路径，就可以加载 SparkR 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}SparkR\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nchar}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{)) }\SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{) \{}
  \FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{SPARK\_HOME =} \StringTok{"\textasciitilde{}/spark/spark{-}2.4.0{-}bin{-}hadoop2.7"}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{library}\NormalTok{(SparkR, }\AttributeTok{lib.loc =} \FunctionTok{c}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{), }\StringTok{"R"}\NormalTok{, }\StringTok{"lib"}\NormalTok{)))}
\FunctionTok{sparkR.session}\NormalTok{(}\AttributeTok{master =} \StringTok{"local[*]"}\NormalTok{, }\AttributeTok{sparkConfig =} \FunctionTok{list}\NormalTok{(}\AttributeTok{spark.driver.memory =} \StringTok{"2g"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/dbdahl/rscala}{rscala} 架起了 R 和 Scala 两门语言之间交流的桥梁，使得彼此之间可以互相调用

\begin{quote}
是否存在这样的可能， Spark 提供了大量的 MLib 库的调用接口，R 的功能支持是最少的，Java/Scala 是原生的，那么要么自己开发新的功能整合到 SparkR 中，要么借助 rscala 将 scala 接口代码封装进来
\end{quote}

在本地，Windows 主机上，可以在 \texttt{.Rprofile} 中给 Spark 添加环境变量 \texttt{SPARK\_HOME} 指定其安装路径，

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Windows 平台默认安装路径}
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{SPARK\_HOME =} \StringTok{"C:/Users/XiangYun/AppData/Local/spark/spark{-}2.4.3{-}bin{-}hadoop2.7"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(sparklyr)}
\NormalTok{sc }\OtherTok{\textless{}{-}} \FunctionTok{spark\_connect}\NormalTok{(}\AttributeTok{master =} \StringTok{"local"}\NormalTok{, }\AttributeTok{version =} \StringTok{"2.4"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

将 R 环境中的数据集 mtcars 传递到 Spark 上

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cars }\OtherTok{\textless{}{-}} \FunctionTok{copy\_to}\NormalTok{(sc, mtcars)}
\NormalTok{cars}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# Source: spark<mtcars> [?? x 11]
    mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
1  21       6   160   110  3.9   2.62  16.5     0     1     4     4
2  21       6   160   110  3.9   2.88  17.0     0     1     4     4
3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1
4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1
5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1
# ... with more rows
\end{verbatim}

监控和分析命令执行的情况，可以在浏览器中，见图 \ref{fig:spark-web}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{spark\_web}\NormalTok{(sc)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=6.4in]{screenshots/spark-start} 

}

\caption{Spark Web 接口}\label{fig:spark-web}
\end{figure}

传递 SQL 查询语句，比如数据集 mtcars 有多少行

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT count(*) FROM mtcars"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  count(1)
1       32
\end{verbatim}

进一步地，我们可以调用 dplyr 包来写数据操作，避免写复杂逻辑的 SQL 语句，

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# library(dplyr) \# 数据操作}
\FunctionTok{library}\NormalTok{(tidyverse) }\CommentTok{\# 提供更多功能，包括数据可视化}
\FunctionTok{count}\NormalTok{(cars)}
\end{Highlighting}
\end{Shaded}

再举一个稍复杂的操作，先从数据集 cars 中选择两个字段 hp 和 mpg

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{select}\NormalTok{(cars, hp, mpg) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{100}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 随机选择 100 行}
  \FunctionTok{collect}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 执行 SQL 查询，将结果返回到本地}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(hp, mpg)) }\SpecialCharTok{+} \CommentTok{\# 绘图}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

数据查询和结果可视化，见图 \ref{fig:spark-mtcars}

\begin{figure}

{\centering \includegraphics[width=1.6in]{screenshots/spark-mtcars} 

}

\caption{数据聚合和可视化}\label{fig:spark-mtcars}
\end{figure}

用完要记得关闭连接

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{spark\_disconnect}\NormalTok{(sc)}
\end{Highlighting}
\end{Shaded}

不要使用 SparkR 接口，要使用 sparklyr， 后者的功能已经全面覆盖前者，生态方面更是更是已经远远超越，它有大厂 RStudio 支持，是公司支持的旗舰项目。但是 sparklyr 的版本稍微比最新的 Spark 低一两个版本，这是开发周期和出于稳定性的考虑，无伤大雅！

Spark 提供了官方 R 语言接口 SparkR。Spark JVM 和 SparkR 包版本要匹配，比如从 CRAN 上安装了最新版的 SparkR，比如版本 2.4.4 就要去 Spark 官网下载最新版的预编译文件 spark-2.4.4-bin-hadoop2.7，解压到本地磁盘，比如 \texttt{D:/spark-2.4.4-bin-hadoop2.7}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{SPARK\_HOME =} \StringTok{"D:/spark{-}2.4.4{-}bin{-}hadoop2.7"}\NormalTok{)}
\CommentTok{\# Sys.setenv(R\_HOME = "C:/Program Files/R/R{-}3.6.1/")}
\FunctionTok{library}\NormalTok{(SparkR, }\AttributeTok{lib.loc =} \FunctionTok{c}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{), }\StringTok{"R"}\NormalTok{, }\StringTok{"lib"}\NormalTok{)))}
\FunctionTok{sparkR.session}\NormalTok{(}\AttributeTok{master =} \StringTok{"local[*]"}\NormalTok{, }
               \AttributeTok{sparkConfig =} \FunctionTok{list}\NormalTok{(}\AttributeTok{spark.driver.memory =} \StringTok{"4g"}\NormalTok{), }
               \AttributeTok{enableHiveSupport =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

从数据集 mtcars（数据类型是 R 的 data.frame） 创建 Spark 的 DataFrame 类型数据

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cars }\OtherTok{\textless{}{-}} \FunctionTok{as.DataFrame}\NormalTok{(mtcars)}
\CommentTok{\# 显示 SparkDataFrame 的前几行}
\FunctionTok{head}\NormalTok{(cars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 mpg cyl disp  hp drat    wt  qsec vs am gear carb
1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1
\end{verbatim}

打印数据集 cars 的 schema 各个字段的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{printSchema}\NormalTok{(cars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
root
 |-- mpg: double (nullable = true)
 |-- cyl: double (nullable = true)
 |-- disp: double (nullable = true)
 |-- hp: double (nullable = true)
 |-- drat: double (nullable = true)
 |-- wt: double (nullable = true)
 |-- qsec: double (nullable = true)
 |-- vs: double (nullable = true)
 |-- am: double (nullable = true)
 |-- gear: double (nullable = true)
 |-- carb: double (nullable = true)
\end{verbatim}

从本地 JSON 文件创建 DataFrame

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path }\OtherTok{\textless{}{-}} \FunctionTok{file.path}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{), }\StringTok{"examples/src/main/resources/people.json"}\NormalTok{)}
\NormalTok{peopleDF }\OtherTok{\textless{}{-}} \FunctionTok{read.json}\NormalTok{(path)}
\FunctionTok{printSchema}\NormalTok{(peopleDF)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
root
 |-- age: long (nullable = true)
 |-- name: string (nullable = true)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{peopleDF}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
SparkDataFrame[age:bigint, name:string]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{showDF}\NormalTok{(peopleDF)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
+----+-------+
| age|   name|
+----+-------+
|null|Michael|
|  30|   Andy|
|  19| Justin|
+----+-------+
\end{verbatim}

peopleDF 转成 Hive 中的表 people

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{createOrReplaceTempView}\NormalTok{(peopleDF, }\StringTok{"people"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调用 \texttt{sql} 传递 SQL 语句查询数据，启动 \texttt{sparkR.session} 时，设置 \texttt{enableHiveSupport\ =\ TRUE}，就是执行不出来，报错，不知道哪里配置存在问题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{teenagers }\OtherTok{\textless{}{-}}\NormalTok{ SparkR}\SpecialCharTok{::}\FunctionTok{sql}\NormalTok{(}\StringTok{"SELECT name FROM people WHERE age \textgreater{}= 13 AND age \textless{}= 19"}\NormalTok{)}
\FunctionTok{show}\NormalTok{(people)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Error in handleErrors(returnStatus, conn) : 
  org.apache.spark.sql.AnalysisException: java.lang.RuntimeException: java.io.IOException: (null) entry in command string: null chmod 0733 F:\tmp\hive;
    at org.apache.spark.sql.hive.HiveExternalCatalog.withClient(HiveExternalCatalog.scala:106)
    at org.apache.spark.sql.hive.HiveExternalCatalog.databaseExists(HiveExternalCatalog.scala:214)
    at org.apache.spark.sql.internal.SharedState.externalCatalog$lzycompute(SharedState.scala:114)
    at org.apache.spark.sql.internal.SharedState.externalCatalog(SharedState.scala:102)
    at org.apache.spark.sql.internal.SharedState.globalTempViewManager$lzycompute(SharedState.scala:141)
    at org.apache.spark.sql.internal.SharedState.globalTempViewManager(SharedState.scala:136)
    at org.apache.spark.sql.hive.HiveSessionStateBuilder$$anonfun$2.apply(HiveSessionStateBuilder.scala:55)
    at org.apache.spark.sql.hive.HiveSessionStateBuilder$$anonfun$2.apply(HiveSessionStateBuilder.scala:55)
    at org.apache.spark.sql.catalyst.catalog.SessionCatalog.gl
\end{verbatim}

调用 \texttt{collect} 函数执行查询，并将结果返回到本地 \texttt{data.frame} 类型

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{teenagersLocalDF }\OtherTok{\textless{}{-}} \FunctionTok{collect}\NormalTok{(teenagers)}
\end{Highlighting}
\end{Shaded}

查看数据集 teenagersLocalDF 的属性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(teenagersLocalDF)}
\end{Highlighting}
\end{Shaded}

最后，关闭 SparkSession 会话

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sparkR.session.stop}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{batch-import-data}{%
\section{批量导入数据}\label{batch-import-data}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{read\_list }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(list\_of\_datasets, read\_func) \{}
\NormalTok{  read\_and\_assign }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dataset, read\_func) \{}
\NormalTok{    dataset\_name }\OtherTok{\textless{}{-}} \FunctionTok{as.name}\NormalTok{(dataset)}
\NormalTok{    dataset\_name }\OtherTok{\textless{}{-}} \FunctionTok{read\_func}\NormalTok{(dataset)}
\NormalTok{  \}}

  \CommentTok{\# invisible is used to suppress the unneeded output}
\NormalTok{  output }\OtherTok{\textless{}{-}} \FunctionTok{invisible}\NormalTok{(}
    \FunctionTok{sapply}\NormalTok{(list\_of\_datasets,}
\NormalTok{      read\_and\_assign,}
      \AttributeTok{read\_func =}\NormalTok{ read\_func, }\AttributeTok{simplify =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{USE.NAMES =} \ConstantTok{TRUE}
\NormalTok{    )}
\NormalTok{  )}

  \CommentTok{\# Remove the extension at the end of the data set names}
\NormalTok{  names\_of\_datasets }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(list\_of\_datasets, }\StringTok{"[.]"}\NormalTok{))[}\FunctionTok{c}\NormalTok{(T, F)])}
  \FunctionTok{names}\NormalTok{(output) }\OtherTok{\textless{}{-}}\NormalTok{ names\_of\_datasets}
  \FunctionTok{return}\NormalTok{(output)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

批量导入文件扩展名为 \texttt{.csv} 的数据文件，即逗号分割的文件

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data\_files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"path/to/csv/dir"}\NormalTok{,}
                         \AttributeTok{pattern =} \StringTok{".csv"}\NormalTok{, }\AttributeTok{full.names =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{print}\NormalTok{(data\_files)}
\end{Highlighting}
\end{Shaded}

相比于 Base R 提供的 \texttt{read.csv} 函数，使用 readr 包的 \texttt{read\_csv} 函数可以更快地读取csv格式文件，特别是在读取GB级数据文件时，效果特别明显。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{list\_of\_data\_sets }\OtherTok{\textless{}{-}} \FunctionTok{read\_list}\NormalTok{(data\_files, readr}\SpecialCharTok{::}\NormalTok{read\_csv)}
\end{Highlighting}
\end{Shaded}

使用 tibble 包的\texttt{glimpse}函数可以十分方便地对整个数据集有一个大致的了解，展示方式和信息量相当于 \texttt{str} 加 \texttt{head} 函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tibble}\SpecialCharTok{::}\FunctionTok{glimpse}\NormalTok{(list\_of\_data\_sets)}
\end{Highlighting}
\end{Shaded}

\hypertarget{batch-export-data}{%
\section{批量导出数据}\label{batch-export-data}}

假定我们有一个列表，其每个元素都是一个数据框，现在要把每个数据框分别存入 xlsx 表的工作薄中，以 mtcars 数据集为例，将其按分类变量 cyl 分组拆分，获得一个列表 list

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(mtcars, mtcars}\SpecialCharTok{$}\NormalTok{cyl)}
\NormalTok{dat}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $`4`
##                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Datsun 710     22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## Merc 240D      24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## Merc 230       22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## Fiat 128       32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## Honda Civic    30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## Toyota Corolla 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## Toyota Corona  21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## Fiat X1-9      27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## Porsche 914-2  26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## Lotus Europa   30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## Volvo 142E     21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
## 
## $`6`
##                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4      21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag  21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## Hornet 4 Drive 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## Valiant        18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## Merc 280       19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## Merc 280C      17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## Ferrari Dino   19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
## 
## $`8`
##                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
## Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
\end{verbatim}

将 xlsx 表格初始化，创建空白的工作薄， \href{https://github.com/awalker89/openxlsx}{openxlsx} 包不依赖 Java 环境，读写效率也高

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 加载 openxlsx 包}
\FunctionTok{library}\NormalTok{(openxlsx)}
\DocumentationTok{\#\# 创建空白的工作薄}
\NormalTok{wb }\OtherTok{\textless{}{-}} \FunctionTok{createWorkbook}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

将列表里的每张表分别存入 xlsx 表格的每个 worksheet，worksheet 的名字就是分组变量的名字

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Map}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(data, name)\{}
    \FunctionTok{addWorksheet}\NormalTok{(wb, name)}
    \FunctionTok{writeData}\NormalTok{(wb, name, data)}
 
\NormalTok{\}, dat, }\FunctionTok{names}\NormalTok{(dat))}
\end{Highlighting}
\end{Shaded}

最后保存数据到磁盘，见图 \ref{fig:batch-export-xlsx}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{saveWorkbook}\NormalTok{(wb, }\AttributeTok{file =} \StringTok{"data/matcars.xlsx"}\NormalTok{, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=4.1in]{screenshots/dm-batch-export-xlsx} 

}

\caption{批量导出数据}\label{fig:batch-export-xlsx}
\end{figure}

\hypertarget{export-data}{%
\section{导出数据}\label{export-data}}

\hypertarget{export-output}{%
\subsection{导出运行结果}\label{export-output}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{capture.output}\NormalTok{(..., }\AttributeTok{file =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{,}
               \AttributeTok{type =} \FunctionTok{c}\NormalTok{(}\StringTok{"output"}\NormalTok{, }\StringTok{"message"}\NormalTok{), }\AttributeTok{split =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{capture.output} 将一段R代码执行结果，保存到文件，参数为表达式。\texttt{capture.output} 和 \texttt{sink} 的关系相当于 \texttt{with} 和 \texttt{attach} 的关系。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{glmout }\OtherTok{\textless{}{-}} \FunctionTok{capture.output}\NormalTok{(}\FunctionTok{summary}\NormalTok{(}\FunctionTok{glm}\NormalTok{(case }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spontaneous }\SpecialCharTok{+}\NormalTok{ induced,}
  \AttributeTok{data =}\NormalTok{ infert, }\AttributeTok{family =} \FunctionTok{binomial}\NormalTok{()}
\NormalTok{)), }\AttributeTok{file =} \StringTok{"data/capture.txt"}\NormalTok{)}
\FunctionTok{capture.output}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+} \DecValTok{1}\NormalTok{, }\DecValTok{2} \SpecialCharTok{+} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "[1] 2" "[1] 4"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{capture.output}\NormalTok{(\{}
  \DecValTok{1} \SpecialCharTok{+} \DecValTok{1}
  \DecValTok{2} \SpecialCharTok{+} \DecValTok{2}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "[1] 4"
\end{verbatim}

\texttt{sink} 函数将控制台输出结果保存到文件，只将 \texttt{outer} 函数运行的结果保存到 \texttt{ex-sink.txt} 文件，outer 函数计算的是直积，在这里相当于 \texttt{seq(10)\ \%*\%\ t(seq(10))}，而在 R 语言中，更加有效的计算方式是 \texttt{tcrossprod(seq(10),seq(10))}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sink}\NormalTok{(}\StringTok{"data/ex{-}sink.txt"}\NormalTok{)}
\NormalTok{i }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}
\FunctionTok{outer}\NormalTok{(i, i, }\StringTok{"*"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
##  [1,]    1    2    3    4    5    6    7    8    9    10
##  [2,]    2    4    6    8   10   12   14   16   18    20
##  [3,]    3    6    9   12   15   18   21   24   27    30
##  [4,]    4    8   12   16   20   24   28   32   36    40
##  [5,]    5   10   15   20   25   30   35   40   45    50
##  [6,]    6   12   18   24   30   36   42   48   54    60
##  [7,]    7   14   21   28   35   42   49   56   63    70
##  [8,]    8   16   24   32   40   48   56   64   72    80
##  [9,]    9   18   27   36   45   54   63   72   81    90
## [10,]   10   20   30   40   50   60   70   80   90   100
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sink}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{export-data-object}{%
\subsection{导出数据对象}\label{export-data-object}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(file, }\AttributeTok{envir =} \FunctionTok{parent.frame}\NormalTok{(), }\AttributeTok{verbose =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{save}\NormalTok{(..., }\AttributeTok{list =} \FunctionTok{character}\NormalTok{(),}
     \AttributeTok{file =} \FunctionTok{stop}\NormalTok{(}\StringTok{"\textquotesingle{}file\textquotesingle{} must be specified"}\NormalTok{),}
     \AttributeTok{ascii =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{version =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{parent.frame}\NormalTok{(),}
     \AttributeTok{compress =} \FunctionTok{isTRUE}\NormalTok{(}\SpecialCharTok{!}\NormalTok{ascii), compression\_level,}
     \AttributeTok{eval.promises =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{precheck =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{save.image}\NormalTok{(}\AttributeTok{file =} \StringTok{".RData"}\NormalTok{, }\AttributeTok{version =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{ascii =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{compress =} \SpecialCharTok{!}\NormalTok{ascii, }\AttributeTok{safe =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{load} 和\texttt{save} 函数加载或保存包含工作环境信息的数据对象，\texttt{save.image} 保存当前工作环境到磁盘，即保存工作空间中所有数据对象，数据格式为 \texttt{.RData}，即相当于

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(}\AttributeTok{list =} \FunctionTok{ls}\NormalTok{(}\AttributeTok{all.names =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{file =} \StringTok{".RData"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
\end{Highlighting}
\end{Shaded}

\texttt{dump} 保存数据对象 AirPassengers 到文件 \texttt{AirPassengers.txt}，文件内容是 R 命令，可把\texttt{AirPassengers.txt}看作代码文档执行，dput 保存数据对象内容到文件\texttt{AirPassengers.dat}，文件中不包含变量名 AirPassengers。注意到 \texttt{dump} 输入是一个字符串，而 \texttt{dput} 要求输入数据对象的名称，\texttt{source} 函数与 \texttt{dump} 对应，而 \texttt{dget} 与 \texttt{dput}对应。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载数据}
\FunctionTok{data}\NormalTok{(AirPassengers, }\AttributeTok{package =} \StringTok{"datasets"}\NormalTok{)}
\CommentTok{\# 将数据以R代码块的形式保存到文件}
\FunctionTok{dump}\NormalTok{(}\StringTok{\textquotesingle{}AirPassengers\textquotesingle{}}\NormalTok{, }\AttributeTok{file =} \StringTok{\textquotesingle{}data/AirPassengers.txt\textquotesingle{}}\NormalTok{) }
\CommentTok{\# source(file = \textquotesingle{}data/AirPassengers.txt\textquotesingle{})}
\end{Highlighting}
\end{Shaded}

接下来，我们读取 \texttt{AirPassengers.txt} 的文件内容，可见它是一段完整的 R 代码，可以直接复制到 R 的控制台中运行，并且得到一个与原始 AirPassengers 变量一样的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(}\StringTok{\textquotesingle{}data/AirPassengers.txt\textquotesingle{}}\NormalTok{), }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## AirPassengers <-
## structure(c(112, 118, 132, 129, 121, 135, 148, 148, 136, 119, 
## 104, 118, 115, 126, 141, 135, 125, 149, 170, 170, 158, 133, 114, 
## 140, 145, 150, 178, 163, 172, 178, 199, 199, 184, 162, 146, 166, 
## 171, 180, 193, 181, 183, 218, 230, 242, 209, 191, 172, 194, 196, 
## 196, 236, 235, 229, 243, 264, 272, 237, 211, 180, 201, 204, 188, 
## 235, 227, 234, 264, 302, 293, 259, 229, 203, 229, 242, 233, 267, 
## 269, 270, 315, 364, 347, 312, 274, 237, 278, 284, 277, 317, 313, 
## 318, 374, 413, 405, 355, 306, 271, 306, 315, 301, 356, 348, 355, 
## 422, 465, 467, 404, 347, 305, 336, 340, 318, 362, 348, 363, 435, 
## 491, 505, 404, 359, 310, 337, 360, 342, 406, 396, 420, 472, 548, 
## 559, 463, 407, 362, 405, 417, 391, 419, 461, 472, 535, 622, 606, 
## 508, 461, 390, 432), .Tsp = c(1949, 1960.9166666666699, 12), class = "ts")
\end{verbatim}

\texttt{dput} 函数类似 \texttt{dump} 函数，保存数据对象到磁盘文件

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 将 R 对象保存/导出到磁盘}
\FunctionTok{dput}\NormalTok{(AirPassengers, }\AttributeTok{file =} \StringTok{\textquotesingle{}data/AirPassengers.dat\textquotesingle{}}\NormalTok{)}
\NormalTok{AirPassengers}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
1949 112 118 132 129 121 135 148 148 136 119 104 118
1950 115 126 141 135 125 149 170 170 158 133 114 140
1951 145 150 178 163 172 178 199 199 184 162 146 166
1952 171 180 193 181 183 218 230 242 209 191 172 194
1953 196 196 236 235 229 243 264 272 237 211 180 201
1954 204 188 235 227 234 264 302 293 259 229 203 229
1955 242 233 267 269 270 315 364 347 312 274 237 278
1956 284 277 317 313 318 374 413 405 355 306 271 306
1957 315 301 356 348 355 422 465 467 404 347 305 336
1958 340 318 362 348 363 435 491 505 404 359 310 337
1959 360 342 406 396 420 472 548 559 463 407 362 405
1960 417 391 419 461 472 535 622 606 508 461 390 432
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dget 作用与 dput 相反}
\NormalTok{AirPassengers2 }\OtherTok{\textless{}{-}} \FunctionTok{dget}\NormalTok{(}\AttributeTok{file =} \StringTok{\textquotesingle{}data/AirPassengers.dat\textquotesingle{}}\NormalTok{)}
\NormalTok{AirPassengers2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
1949 112 118 132 129 121 135 148 148 136 119 104 118
1950 115 126 141 135 125 149 170 170 158 133 114 140
1951 145 150 178 163 172 178 199 199 184 162 146 166
1952 171 180 193 181 183 218 230 242 209 191 172 194
1953 196 196 236 235 229 243 264 272 237 211 180 201
1954 204 188 235 227 234 264 302 293 259 229 203 229
1955 242 233 267 269 270 315 364 347 312 274 237 278
1956 284 277 317 313 318 374 413 405 355 306 271 306
1957 315 301 356 348 355 422 465 467 404 347 305 336
1958 340 318 362 348 363 435 491 505 404 359 310 337
1959 360 342 406 396 420 472 548 559 463 407 362 405
1960 417 391 419 461 472 535 622 606 508 461 390 432
\end{verbatim}

同样地，现在我们观察 \texttt{dput} 函数保存的文件 \texttt{AirPassengers.dat} 内容，和\texttt{dump} 函数保存的文件 \texttt{AirPassengers.txt}相比，就缺一个赋值变量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(}\StringTok{\textquotesingle{}data/AirPassengers.dat\textquotesingle{}}\NormalTok{), }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
structure(c(112, 118, 132, 129, 121, 135, 148, 148, 136, 119, 
104, 118, 115, 126, 141, 135, 125, 149, 170, 170, 158, 133, 114, 
140, 145, 150, 178, 163, 172, 178, 199, 199, 184, 162, 146, 166, 
171, 180, 193, 181, 183, 218, 230, 242, 209, 191, 172, 194, 196, 
196, 236, 235, 229, 243, 264, 272, 237, 211, 180, 201, 204, 188, 
235, 227, 234, 264, 302, 293, 259, 229, 203, 229, 242, 233, 267, 
269, 270, 315, 364, 347, 312, 274, 237, 278, 284, 277, 317, 313, 
318, 374, 413, 405, 355, 306, 271, 306, 315, 301, 356, 348, 355, 
422, 465, 467, 404, 347, 305, 336, 340, 318, 362, 348, 363, 435, 
491, 505, 404, 359, 310, 337, 360, 342, 406, 396, 420, 472, 548, 
559, 463, 407, 362, 405, 417, 391, 419, 461, 472, 535, 622, 606, 
508, 461, 390, 432), .Tsp = c(1949, 1960.91666666667, 12), class = "ts")
\end{verbatim}

\href{https://github.com/ycphs/openxlsx}{openxlsx} 可以读写 XLSX 文档

美团使用的大数据工具有很多，最常用的 Hive、Spark、Kylin、Impala、Presto 等，详见 \url{https://tech.meituan.com/2018/08/02/mt-r-practice.html}。下面主要介绍如何在 R 中连接 MySQL、Presto 和 Spark。

\href{https://github.com/r-spark/sparklyr.flint}{sparklyr.flint} 支持 Spark 的时间序列库 \href{https://github.com/twosigma/flint}{flint}，\href{https://github.com/rstudio/sparkxgb}{sparkxgb} 为 Spark 上的 XGBoost 提供 R 接口，\href{https://github.com/r-spark/sparkwarc}{sparkwarc} 支持加载 Web ARChive 文件到 Spark 里 \href{https://github.com/chezou/sparkavro}{sparkavro} 支持从 Apache Avro (\url{https://avro.apache.org/}) 读取文件到 Spark 里，\href{https://github.com/miraisolutions/sparkbq}{sparkbq} 是一个 sparkly 扩展包，集成 Google BigQuery 服务，\href{https://github.com/harryprince/geospark}{geospark} 提供 GeoSpark 库的 R 接口，并且以 sf 的数据操作方式，\href{https://github.com/h2oai/sparkling-water/tree/master/r}{rsparkling} H2O Sparkling Water 机器学习库的 R 接口。

Spark 性能优化，参考三篇博文

\begin{itemize}
\tightlist
\item
  \href{https://tech.meituan.com/2016/03/31/spark-in-meituan.html}{Spark在美团的实践}
\item
  \href{https://tech.meituan.com/2016/04/29/spark-tuning-basic.html}{Spark性能优化指南------基础篇}
\item
  \href{https://tech.meituan.com/2016/05/12/spark-tuning-pro.html}{Spark性能优化指南------高级篇}
\end{itemize}

其他材料

\begin{itemize}
\tightlist
\item
  朱俊晖收集的 Spark 资源列表 \url{https://github.com/harryprince/awesome-sparklyr}，推荐使用 sparklyr \url{https://github.com/sparklyr/sparklyr} 连接 Spark
\item
  Spark 与 R 语言 \url{https://docs.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/}
\item
  Mastering Spark with R \url{https://therinspark.com/}
\end{itemize}

\hypertarget{sec-spark-with-r}{%
\section{Spark 与 R 语言}\label{sec-spark-with-r}}

\hypertarget{subsec-sparklyr}{%
\subsection{sparklyr}\label{subsec-sparklyr}}

\begin{rmdwarn}{警告}
Spark 依赖特定版本的 Java、Hadoop，三者之间的版本应该要相融。

\end{rmdwarn}

在 MacOS 上配置 Java 环境，注意 Spark 仅支持 Java 8 至 11，所以安装指定版本的 Java 开发环境

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 安装 openjdk 11}
\ExtensionTok{brew}\NormalTok{ install openjdk@11}
\CommentTok{\# 全局设置 JDK 11}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}sfn}\NormalTok{ /usr/local/opt/openjdk@11/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk{-}11.jdk}
\CommentTok{\# Java 11 JDK 添加到 .zshrc }
\BuiltInTok{export} \VariableTok{CPPFLAGS}\OperatorTok{=}\StringTok{"{-}I/usr/local/opt/openjdk@11/include"}
\BuiltInTok{export} \VariableTok{PATH}\OperatorTok{=}\StringTok{"/usr/local/opt/openjdk@11/bin:}\VariableTok{$PATH}\StringTok{"}
\end{Highlighting}
\end{Shaded}

配置 R 环境，让 R 能够识别 Java 环境，再安装 \textbf{rJava} 包

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 配置}
\FunctionTok{sudo}\NormalTok{ R CMD javareconf}
\CommentTok{\# 系统软件依赖}
\ExtensionTok{brew}\NormalTok{ install pcre2}
\CommentTok{\# 安装 rJava}
\ExtensionTok{Rscript} \AttributeTok{{-}e} \StringTok{\textquotesingle{}install.packages("rJava", type="source")\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

最后安装 \textbf{sparklyr} 包，以及 Spark 环境，可以借助 \texttt{spark\_install()} 安装 Spark，比如下面 Spark 3.0 连同 hadoop 2.7 一起安装。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}sparklyr\textquotesingle{}}\NormalTok{)}
\NormalTok{sparklyr}\SpecialCharTok{::}\FunctionTok{spark\_install}\NormalTok{(}\AttributeTok{version =} \StringTok{\textquotesingle{}3.0\textquotesingle{}}\NormalTok{, }\AttributeTok{hadoop\_version =} \StringTok{\textquotesingle{}2.7\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

也可以先手动下载 Spark 软件环境，建议选择就近镜像站点下载，比如在北京选择清华站点 \url{https://mirrors.tuna.tsinghua.edu.cn/apache/spark/spark-3.0.1/spark-3.0.1-bin-hadoop2.7.tgz}，此环境自带 R 和 Python 接口。为了供 sparklyr 调用，先设置 \texttt{SPARK\_HOME} 环境变量指向 Spark 安装位置，再连接单机版 Spark。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 排错 https://github.com/sparklyr/sparklyr/issues/2827}
\FunctionTok{options}\NormalTok{(}\AttributeTok{sparklyr.log.console =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# 连接 Spark }
\FunctionTok{library}\NormalTok{(sparklyr)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{sc }\OtherTok{\textless{}{-}} \FunctionTok{spark\_connect}\NormalTok{(}
  \AttributeTok{master =} \StringTok{"local"}\NormalTok{,}
  \CommentTok{\# config = list(sparklyr.gateway.address = "127.0.0.1"),}
  \AttributeTok{spark\_home =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# diamonds 数据集导入 Spark}
\NormalTok{diamonds\_tbl }\OtherTok{\textless{}{-}} \FunctionTok{copy\_to}\NormalTok{(sc, ggplot2}\SpecialCharTok{::}\NormalTok{diamonds, }\StringTok{"diamonds"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

做数据的聚合统计，有两种方式。一种是使用用 R 包 dplyr 提供的数据操作语法，下面以按 cut 分组统计钻石的数量为例，说明 dplyr 提供的数据操作方式。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\CommentTok{\# 列出数据源下所有的表 tbls}
\FunctionTok{src\_tbls}\NormalTok{(sc)}

\NormalTok{diamonds\_tbl }\OtherTok{\textless{}{-}}\NormalTok{ diamonds\_tbl }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(cut) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{cnt =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  collect}
\end{Highlighting}
\end{Shaded}

另一种是使用结构化查询语言 SQL，这自不必说，大多数情况下，使用和一般的 SQL 没什么两样。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\NormalTok{diamonds\_preview }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT count(*) as cnt, cut FROM diamonds GROUP BY cut"}\NormalTok{)}
\NormalTok{diamonds\_preview}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cnt       cut
## 1 21551     Ideal
## 2 13791   Premium
## 3  4906      Good
## 4  1610      Fair
## 5 12082 Very Good
\end{verbatim}

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# SQL 中的 AVG 和 R 中的 mean 函数是类似的}
\NormalTok{diamonds\_price }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT AVG(price) as mean\_price, cut FROM diamonds GROUP BY cut"}\NormalTok{)}
\NormalTok{diamonds\_price}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   mean_price       cut
## 1   3457.542     Ideal
## 2   4584.258   Premium
## 3   3928.864      Good
## 4   4358.758      Fair
## 5   3981.760 Very Good
\end{verbatim}

\end{column}

\begin{column}{0.05\textwidth}
~

\end{column}

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{diamonds }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(diamonds)}
\NormalTok{diamonds[,.(}\AttributeTok{mean\_price =} \FunctionTok{mean}\NormalTok{(price)), by }\OtherTok{=}\NormalTok{ .(cut)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          cut mean_price
## 1:     Ideal   3457.542
## 2:   Premium   4584.258
## 3:      Good   3928.864
## 4: Very Good   3981.760
## 5:      Fair   4358.758
\end{verbatim}

\end{column}

将结果数据用 ggplot2 呈现出来

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds\_preview, }\FunctionTok{aes}\NormalTok{(cut, cnt)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-transportation_files/figure-latex/unnamed-chunk-75-1} \end{center}

diamonds 数据集总共 53940 条数据，下面用 BUCKET 分桶抽样，将原数据随机分成 1000 个桶，取其中的一个桶，由于是随机分桶，所以每次的结果都不一样，解释详见\url{https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-sampling.html}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds\_sample }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT * FROM diamonds TABLESAMPLE (BUCKET 1 OUT OF 1000) LIMIT 6"}\NormalTok{)}
\NormalTok{diamonds\_sample}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   carat       cut color clarity depth table price    x    y    z
## 1  0.73 Very Good     E     VS2  63.1    55  3066 5.77 5.71 3.62
## 2  0.68 Very Good     G      IF  62.7    56  3143 5.56 5.60 3.50
## 3  0.90      Fair     G     SI1  65.2    59  3250 6.05 6.01 3.93
## 4  0.83     Ideal     F     SI1  62.8    56  3482 5.97 6.01 3.76
## 5  1.03   Premium     D     SI2  62.3    58  3675 6.50 6.40 4.03
## 6  1.03 Very Good     J     SI2  58.0    60  3729 6.64 6.67 3.86
\end{verbatim}

将抽样的结果用窗口函数 \texttt{RANK()} 排序，详见 \url{https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html}

窗口函数 \url{https://www.cnblogs.com/ZackSun/p/9713435.html}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds\_rank }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"}
\StringTok{  SELECT cut, price, RANK() OVER (PARTITION BY cut ORDER BY price) AS rank }
\StringTok{  FROM diamonds TABLESAMPLE (BUCKET 1 OUT OF 1000)}
\StringTok{  LIMIT 6}
\StringTok{"}\NormalTok{)}
\NormalTok{diamonds\_rank}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cut price rank
## 1 Fair  3011    1
## 2 Fair  4277    2
## 3 Good  1316    1
## 4 Good  1613    2
## 5 Good  2281    3
## 6 Good  2318    4
\end{verbatim}

LATERAL VIEW 把一列拆成多行

\url{https://liam.page/2020/03/09/LATERAL-VIEW-in-Hive-SQL/} \url{https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-lateral-view.html}

创建数据集

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 先删除存在的表 person}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"DROP TABLE IF EXISTS person"}\NormalTok{)}
\CommentTok{\# 创建表 person}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"CREATE TABLE IF NOT EXISTS person (id INT, name STRING, age INT, class INT, address STRING)"}\NormalTok{)}
\CommentTok{\# 插入数据到表 person}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"}
\StringTok{INSERT INTO person VALUES}
\StringTok{    (100, \textquotesingle{}John\textquotesingle{}, 30, 1, \textquotesingle{}Street 1\textquotesingle{}),}
\StringTok{    (200, \textquotesingle{}Mary\textquotesingle{}, NULL, 1, \textquotesingle{}Street 2\textquotesingle{}),}
\StringTok{    (300, \textquotesingle{}Mike\textquotesingle{}, 80, 3, \textquotesingle{}Street 3\textquotesingle{}),}
\StringTok{    (400, \textquotesingle{}Dan\textquotesingle{}, 50, 4, \textquotesingle{}Street 4\textquotesingle{})}
\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

查看数据集

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT * FROM person"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    id name age class  address
## 1 100 John  30     1 Street 1
## 2 200 Mary  NA     1 Street 2
## 3 300 Mike  80     3 Street 3
## 4 400  Dan  50     4 Street 4
\end{verbatim}

行列转换 \url{https://www.cnblogs.com/kimbo/p/6208973.html}，LATERAL VIEW 展开

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbGetQuery}\NormalTok{(sc,}\StringTok{"}
\StringTok{SELECT * FROM person}
\StringTok{    LATERAL VIEW EXPLODE(ARRAY(30, 60)) tabelName AS c\_age}
\StringTok{    LATERAL VIEW EXPLODE(ARRAY(40, 80)) AS d\_age}
\StringTok{LIMIT 6}
\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    id name age class  address c_age d_age
## 1 100 John  30     1 Street 1    30    40
## 2 100 John  30     1 Street 1    30    80
## 3 100 John  30     1 Street 1    60    40
## 4 100 John  30     1 Street 1    60    80
## 5 200 Mary  NA     1 Street 2    30    40
## 6 200 Mary  NA     1 Street 2    30    80
\end{verbatim}

日期相关的函数 \url{https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html\#date-and-timestamp-functions}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 今天}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"select current\_date"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   current_date()
## 1     2021-10-05
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 昨天}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"select date\_sub(current\_date, 1)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   date_sub(current_date(), 1)
## 1                  2021-10-04
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 本月最后一天 current\_date 所属月份的最后一天}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"select last\_day(current\_date)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   last_day(current_date())
## 1               2021-10-31
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 星期几}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"select dayofweek(current\_date)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   dayofweek(current_date())
## 1                         3
\end{verbatim}

最后，使用完记得关闭 Spark 连接

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{spark\_disconnect}\NormalTok{(sc)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-sparkr}{%
\subsection{SparkR}\label{subsec-sparkr}}

\begin{rmdnote}{注意}
考虑到和第\ref{subsec-sparklyr}节的重合性，以及 sparklyr 的优势，本节代码都不会执行，仅作为补充信息予以描述。完整的介绍见 \href{https://spark.apache.org/docs/latest/sparkr.html\#running-sql-queries-from-sparkr}{SparkR 包}

\end{rmdnote}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nchar}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{)) }\SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{) \{}
  \FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{SPARK\_HOME =} \StringTok{"/opt/spark/spark{-}3.0.1{-}bin{-}hadoop2.7"}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{library}\NormalTok{(SparkR, }\AttributeTok{lib.loc =} \FunctionTok{c}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{), }\StringTok{"R"}\NormalTok{, }\StringTok{"lib"}\NormalTok{)))}
\FunctionTok{sparkR.session}\NormalTok{(}\AttributeTok{master =} \StringTok{"local[*]"}\NormalTok{, }\AttributeTok{sparkConfig =} \FunctionTok{list}\NormalTok{(}\AttributeTok{spark.driver.memory =} \StringTok{"2g"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{rmdwarn}{警告}

\textbf{SparkR} 要求 Java 版本满足：大于等于8，而小于12，本地 MacOS 安装高版本，比如 oracle-jdk 16.0.1 会报不兼容的错误。

\begin{verbatim}
Spark package found in SPARK_HOME: /opt/spark/spark-3.1.1-bin-hadoop3.2
Error in checkJavaVersion() : 
  Java version, greater than or equal to 8 and less than 12, is required for this package; found version: 16.0.1
\end{verbatim}

\end{rmdwarn}

\texttt{sparkConfig} 有哪些参数可以传递

\begin{longtable}[]{@{}lll@{}}
\toprule
Property Name & Property group & \texttt{spark-submit} equivalent \\
\midrule
\endhead
\texttt{spark.master} & Application Properties & \texttt{-\/-master} \\
\texttt{spark.kerberos.keytab} & Application Properties & \texttt{-\/-keytab} \\
\texttt{spark.kerberos.principal} & Application Properties & \texttt{-\/-principal} \\
\texttt{spark.driver.memory} & Application Properties & \texttt{-\/-driver-memory} \\
\texttt{spark.driver.extraClassPath} & Runtime Environment & \texttt{-\/-driver-class-path} \\
\texttt{spark.driver.extraJavaOptions} & Runtime Environment & \texttt{-\/-driver-java-options} \\
\texttt{spark.driver.extraLibraryPath} & Runtime Environment & \texttt{-\/-driver-library-path} \\
\bottomrule
\end{longtable}

将 data.frame 转化为 SparkDataFrame

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{faithful\_sdf }\OtherTok{\textless{}{-}} \FunctionTok{as.DataFrame}\NormalTok{(faithful)}
\end{Highlighting}
\end{Shaded}

SparkDataFrame

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(faithful\_sdf)}
\end{Highlighting}
\end{Shaded}

查看结构

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(faithful\_sdf)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-database-with-r}{%
\section{数据库与 R 语言}\label{sec-database-with-r}}

\href{https://github.com/prestodb/presto}{Presto} 的 R 接口 \url{https://github.com/prestodb/RPresto} 和文档 \url{https://prestodb.io/docs/current/index.html}，Presto 数据库

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}RPresto\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

MySQL 为例介绍 odbc 的连接和使用，详见 \href{https://cosx.org/2020/06/connect-mysql-from-r/}{从 R 连接 MySQL}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{{-}{-} !preview conn=DBI::dbConnect(odbc::odbc(),  driver = "MariaDB", database = "demo", }
\CommentTok{{-}{-}                              uid = "root", pwd = "cloud", host = "localhost", port = 3306)}

\KeywordTok{SELECT} \OperatorTok{*} \KeywordTok{FROM}\NormalTok{ mtcars}
\KeywordTok{LIMIT} \DecValTok{10}
\end{Highlighting}
\end{Shaded}

我的系统已经安装了多款数据库的 ODBC 驱动

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{dnf}\NormalTok{ install }\AttributeTok{{-}y}\NormalTok{ unixODBC unixODBC{-}devel mariadb mariadb{-}server mariadb{-}devel mariadb{-}connector{-}odbc}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{odbc}\SpecialCharTok{::}\FunctionTok{odbcListDrivers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# Driver from the mariadb-connector-odbc package
# Setup from the unixODBC package
[MariaDB]
Description     = ODBC for MariaDB
Driver          = /usr/lib/libmaodbc.so
Driver64        = /usr/lib64/libmaodbc.so
FileUsage       = 1
\end{verbatim}

\hypertarget{sec-batch-import-csv}{%
\section{批量读取 csv 文件}\label{sec-batch-import-csv}}

iris 数据转化为 data.table 类型，按照 Species 分组拆成单独的 csv 文件，各个文件的文件名用鸢尾花的类别名表示

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 批量分组导出}
\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{as.data.table}\NormalTok{(iris)[, }\FunctionTok{fwrite}\NormalTok{(.SD, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"data/user\_"}\NormalTok{, }\FunctionTok{unique}\NormalTok{(Species), }\StringTok{".csv"}\NormalTok{)), by }\OtherTok{=}\NormalTok{ Species, .SDcols }\OtherTok{=} \FunctionTok{colnames}\NormalTok{(iris)]}
\end{Highlighting}
\end{Shaded}

读取文件夹 \texttt{data/} 所有 csv 数据文件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{merged\_df }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\StringTok{\textquotesingle{}rbind\textquotesingle{}}\NormalTok{, }\FunctionTok{lapply}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"*.csv"}\NormalTok{, }\AttributeTok{path =} \StringTok{"data/"}\NormalTok{), fread ) )}
\CommentTok{\# 或者}
\NormalTok{merged\_df }\OtherTok{\textless{}{-}} \FunctionTok{rbindlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"*.csv"}\NormalTok{, }\AttributeTok{path =} \StringTok{"data/"}\NormalTok{), fread ))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xdf}\SpecialCharTok{$}\NormalTok{date }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(xdf}\SpecialCharTok{$}\NormalTok{date)}
\NormalTok{xdf}\SpecialCharTok{$}\NormalTok{ts }\OtherTok{\textless{}{-}} \FunctionTok{as.POSIXct}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(xdf}\SpecialCharTok{$}\NormalTok{ts), }\AttributeTok{origin =} \StringTok{"1978{-}01{-}01"}\NormalTok{)}
\FunctionTok{split}\NormalTok{(xdf[}\FunctionTok{order}\NormalTok{(xdf}\SpecialCharTok{$}\NormalTok{ts), ], }\FunctionTok{interaction}\NormalTok{(xdf}\SpecialCharTok{$}\NormalTok{study, xdf}\SpecialCharTok{$}\NormalTok{port)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(.x) \{}
\NormalTok{    .x[}\FunctionTok{nrow}\NormalTok{(.x), ]}
\NormalTok{  \}) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{unname}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{Filter}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(.x) \{}
    \FunctionTok{nrow}\NormalTok{(.x) }\SpecialCharTok{\textgreater{}} \DecValTok{0}
\NormalTok{  \}, .) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{do.call}\NormalTok{(rbind.data.frame, .)}

\FunctionTok{library}\NormalTok{(dplyr)}
\NormalTok{xdf }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{date =} \FunctionTok{as.Date}\NormalTok{(date),}
    \AttributeTok{ts =}\NormalTok{ anytime}\SpecialCharTok{::}\FunctionTok{anytime}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(ts))}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{arrange}\NormalTok{(ts) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(study, port) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{slice}\NormalTok{(}\FunctionTok{n}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tibble)}
\FunctionTok{library}\NormalTok{(magrittr)}

\NormalTok{mtcars }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(mtcars)}

\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{print}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\AttributeTok{width =} \DecValTok{69}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 32 x 11
##      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##    <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
##  1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
##  2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
##  3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
##  4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
##  5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
##  6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
##  7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
##  8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
##  9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
## 10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
## 11  17.8     6  168.   123  3.92  3.44  18.9     1     0     4     4
## 12  16.4     8  276.   180  3.07  4.07  17.4     0     0     3     3
## 13  17.3     8  276.   180  3.07  3.73  17.6     0     0     3     3
## 14  15.2     8  276.   180  3.07  3.78  18       0     0     3     3
## 15  10.4     8  472    205  2.93  5.25  18.0     0     0     3     4
## 16  10.4     8  460    215  3     5.42  17.8     0     0     3     4
## # ... with 16 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{print}\NormalTok{(., }\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(.)}\SpecialCharTok{/}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 32 x 11
##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
## 2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
## 3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
## 4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
## 5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
## 6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
## 7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
## 8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
## # ... with 24 more rows
\end{verbatim}

\hypertarget{sec-batch-export-xlsx}{%
\section{批量导出 xlsx 文件}\label{sec-batch-export-xlsx}}

将 R 环境中的数据集导出为 xlsx 表格

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 加载 openxlsx 包}
\FunctionTok{library}\NormalTok{(openxlsx)}
\DocumentationTok{\#\# 创建空白的工作薄，标题为鸢尾花数据集}
\NormalTok{wb }\OtherTok{\textless{}{-}} \FunctionTok{createWorkbook}\NormalTok{(}\AttributeTok{title =} \StringTok{"鸢尾花数据集"}\NormalTok{)}
\DocumentationTok{\#\# 添加 sheet 页}
\FunctionTok{addWorksheet}\NormalTok{(wb, }\AttributeTok{sheetName =} \StringTok{"iris"}\NormalTok{)}
\CommentTok{\# 将数据写进 sheet 页}
\FunctionTok{writeData}\NormalTok{(wb, }\AttributeTok{sheet =} \StringTok{"iris"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ iris, }\AttributeTok{colNames =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 导出数据到本地}
\FunctionTok{saveWorkbook}\NormalTok{(wb, }\AttributeTok{file =} \StringTok{"iris.xlsx"}\NormalTok{, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(openxlsx)}
\NormalTok{xlsxFile }\OtherTok{\textless{}{-}} \FunctionTok{system.file}\NormalTok{(}\StringTok{"extdata"}\NormalTok{, }\StringTok{"readTest.xlsx"}\NormalTok{, }\AttributeTok{package =} \StringTok{"openxlsx"}\NormalTok{)}
\CommentTok{\# 导入}
\NormalTok{dat }\OtherTok{=} \FunctionTok{read.xlsx}\NormalTok{(}\AttributeTok{xlsxFile =}\NormalTok{ xlsxFile)}
\CommentTok{\# 导出}
\FunctionTok{write.xlsx}\NormalTok{(dat, xlsxfile)}
\end{Highlighting}
\end{Shaded}

\hypertarget{dm-session-info}{%
\section{运行环境}\label{dm-session-info}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   askpass_1.1        assertthat_0.2.1   base64enc_0.1-3    blob_1.2.2        
##   bookdown_0.24      cli_3.0.1          codetools_0.2.18   colorspace_2.0-2  
##   compiler_4.1.1     config_0.3.1       cpp11_0.4.0        crayon_1.4.1      
##   curl_4.3.2         data.table_1.14.2  DBI_1.1.1          dbplyr_2.1.1      
##   digest_0.6.28      dplyr_1.0.7        ellipsis_0.3.2     evaluate_0.14     
##   fansi_0.5.0        farver_2.1.0       fastmap_1.1.0      forge_0.2.0       
##   generics_0.1.0     ggplot2_3.3.5      globals_0.14.0     glue_1.4.2        
##   graphics_4.1.1     grDevices_4.1.1    grid_4.1.1         gtable_0.3.0      
##   highr_0.9          htmltools_0.5.2    htmlwidgets_1.5.4  httr_1.4.2        
##   isoband_0.2.5      jquerylib_0.1.4    jsonlite_1.7.2     knitr_1.36        
##   labeling_0.4.2     lattice_0.20.45    lifecycle_1.0.1    magrittr_2.0.1    
##   MASS_7.3.54        Matrix_1.3.4       methods_4.1.1      mgcv_1.8.37       
##   mime_0.12          munsell_0.5.0      nlme_3.1.153       openssl_1.4.5     
##   parallel_4.1.1     pillar_1.6.3       pkgconfig_2.0.3    png_0.1-7         
##   purrr_0.3.4        r2d3_0.2.5         R6_2.5.1           rappdirs_0.3.3    
##   RColorBrewer_1.1.2 rlang_0.4.11       rmarkdown_2.11     rprojroot_2.0.2   
##   rstudioapi_0.13    scales_1.1.1       sparklyr_1.7.2     splines_4.1.1     
##   stats_4.1.1        stringi_1.7.4      stringr_1.4.0      sys_3.4           
##   tibble_3.1.5       tidyr_1.1.4        tidyselect_1.1.1   tinytex_0.34      
##   tools_4.1.1        utf8_1.2.2         utils_4.1.1        uuid_0.1.4        
##   vctrs_0.3.8        viridisLite_0.4.0  withr_2.4.2        xfun_0.26         
##   xml2_1.3.2         yaml_2.2.1
\end{verbatim}

\hypertarget{chap-string-operations}{%
\chapter{字符串操作}\label{chap-string-operations}}

\href{https://www.gastonsanchez.com/r4strings/}{Handling Strings with R} 和 \href{https://r4ds.had.co.nz/strings.html}{R for Data Science} 提供字符串入门介绍 ，Sara Stoudt 整理了 stringr 包与 Base R 正则表达式函数的对应表 \url{https://stringr.tidyverse.org/articles/from-base.html}

\href{https://stringr.tidyverse.org/}{stringr} 基于 \href{https://github.com/gagolews/stringi}{stringi} 包字符串处理包， \href{https://github.com/qinwf/re2r/}{re2r} 包基于 Google 开发的 C++ 库 \href{https://github.com/google/re2}{re2}，Google 编程之夏项目提供了一份 \href{https://github.com/rstats-gsoc/gsoc2016/wiki/re2-regular-expressions}{正则表达式性能综述}， \href{https://github.com/markvanderloo/stringdist}{stringdist} Approximate String Matching and String Distance Functions 近似字符串匹配和字符串距离计算函数 \citep{stringdist2014}

\begin{itemize}
\tightlist
\item
  \href{https://github.com/sfirke/janitor}{janitor}
\item
  \href{https://www.brodrigues.co/blog/2019-02-10-stringr_package/}{Manipulating strings with the stringr package}
\item
  \href{https://github.com/rorynolan/filesstrings}{filesstrings} 基于 stringr 操作字符串
\item
  \href{https://github.com/rorynolan/strex}{strex} 一些没有包含在 stringr 或者 stringi 中的字符串操作函数
\item
  \href{https://github.com/juliasilge/tidytext}{tidytext} Text mining using dplyr, ggplot2, and other tidy tools
\end{itemize}

\href{https://github.com/markvanderloo/stringdist}{stringdist} \href{https://github.com/traversc/stringfish}{stringfish} \href{https://github.com/hadley/stringb}{stringb} \href{https://github.com/gagolews/stringi}{stringi} \href{https://github.com/tidyverse/stringr}{stringr}

字符和字符串类型的数据值得单独拿出来讲，不仅因为内容多，而且比较难，应用范围最广，特别是面对文本类型的数据时，几乎是避不开的！R 的前身是 S，S 的前身是一些 Fortran 和 C 子程序，最早在贝尔实验室是用于文本分析领域，因此在 R 基础包中提供了丰富的字符串处理函数，你可以在R控制台中执行如下一行命令查看

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{help.search}\NormalTok{(}\AttributeTok{keyword =} \StringTok{"character"}\NormalTok{, }\AttributeTok{package =} \StringTok{"base"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

本章主要介绍 R 内置的字符串操作函数

\hypertarget{base-count}{%
\section{字符数统计}\label{base-count}}

\texttt{nchar} 函数统计字符串向量中每个元素的字符个数，注意与函数\texttt{length} 的差别，它统计向量中元素的个数，即向量的长度。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Hello"}\NormalTok{, }\StringTok{"world"}\NormalTok{, }\StringTok{"!"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 5 5 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R.version.string}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "R version 4.1.1 (2021-08-10)"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(R.version.string)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 28
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{deparse}\NormalTok{(base}\SpecialCharTok{::}\NormalTok{mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "function (x, ...) "  "UseMethod(\"mean\")"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\FunctionTok{deparse}\NormalTok{(base}\SpecialCharTok{::}\NormalTok{mean))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 18 17
\end{verbatim}

一些特殊的情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\ConstantTok{NULL}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## integer(0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pi}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.141593
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(pi)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{exp}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.718282
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\FunctionTok{exp}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

\hypertarget{base-translations}{%
\section{字符串翻译}\label{base-translations}}

\texttt{tolower} 将字符串或字符串向量中含有的大写字母全都转化为小写， \texttt{toupper} 函数正好与之相反.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tolower}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"HELLO"}\NormalTok{, }\StringTok{"Hello, R"}\NormalTok{, }\StringTok{"hello"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "hello"    "hello, r" "hello"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{toupper}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"HELLO"}\NormalTok{, }\StringTok{"Hello, R"}\NormalTok{, }\StringTok{"hello"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "HELLO"    "HELLO, R" "HELLO"
\end{verbatim}

\hypertarget{base-concatenate}{%
\section{字符串连接}\label{base-concatenate}}

\texttt{paste} 函数设置参数 sep 作为连接符，设置参数 collapse 可以将字符串拼接后连成一个字符串

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "AB"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{sep =} \StringTok{"{-}"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A-1" "B-2" "C-3"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{sep =} \StringTok{"{-}"}\NormalTok{, }\AttributeTok{collapse =} \StringTok{";"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A-1;B-2;C-3"
\end{verbatim}

\texttt{paste0} 相当于 sep 设为空，没有连接符

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste0}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "AB"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste0}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A1" "B2" "C3"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste0}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{collapse =} \StringTok{";"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A1;B2;C3"
\end{verbatim}

\hypertarget{base-strsplit}{%
\section{字符串拆分}\label{base-strsplit}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strsplit}\NormalTok{(x, split, }\AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{strsplit} 函数用于字符串拆分，参数 x 是被拆分的字符串向量，其每个元素都会被拆分，而参数 split 表示拆分的位置，可以用正则表达式来描述位置，拆分的结果是一个列表。

参数 fixed 默认设置 \texttt{fixed\ =\ FALSE} 表示正则表达式匹配，而 \texttt{fixed\ =\ TRUE} 表示正则表达式的精确匹配或者按文本字符的字面意思匹配，即按普通文本匹配。我们知道按普通文本匹配速度快。

当启用 \texttt{perl\ =\ TRUE} 时，由 \texttt{PCRE\_use\_JIT} 控制细节。\texttt{perl} 参数的设置与 Perl 软件版本有关，如果正则表达式很长，除了正确设置正则表达式，使用 \texttt{perl\ =\ TRUE} 可以提高运算速度

参数 useBytes 设置是否按照逐个字节地进行匹配，默认设置为 FALSE，即按照字符而不是字节进行匹配

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{as =} \StringTok{"asfef"}\NormalTok{, }\AttributeTok{qu =} \StringTok{"qwerty"}\NormalTok{, }\StringTok{"yuiop["}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"stuff.blah.yech"}\NormalTok{)}
\CommentTok{\# 按字母 e 拆分字符串向量 x}
\FunctionTok{strsplit}\NormalTok{(x, }\StringTok{"e"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $as
## [1] "asf" "f"  
## 
## $qu
## [1] "qw"  "rty"
## 
## [[3]]
## [1] "yuiop["
## 
## [[4]]
## [1] "b"
## 
## [[5]]
## [1] "stuff.blah.y" "ch"
\end{verbatim}

参数 split 支持通过正则表达式的方式指明拆分位置

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 默认将点号 . 看作一个正则表达式，它是一个元字符，匹配任意字符}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{"a.b.c"}\NormalTok{, }\StringTok{"."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "" "" "" "" ""
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 这才是按点号拆分}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{"a.b.c"}\NormalTok{, }\StringTok{"."}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "a" "b" "c"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{"a.b.c"}\NormalTok{, }\StringTok{"[.]"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "a" "b" "c"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者转义点号，去掉元字符的特殊意义}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{"a.b.c"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "a" "b" "c"
\end{verbatim}

这里介绍一个将字符串逆序的函数 \texttt{str\_rev}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{str\_rev }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)}
        \FunctionTok{sapply}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(x, }\ConstantTok{NULL}\NormalTok{), rev), paste, }\AttributeTok{collapse =} \StringTok{""}\NormalTok{)}
\FunctionTok{str\_rev}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"abc"}\NormalTok{, }\StringTok{"Statistics"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "cba"        "scitsitatS"
\end{verbatim}

为了加深理解，再举几个例子

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 最后一个空字符没有产生}
\FunctionTok{strsplit}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{""}\NormalTok{), }\AttributeTok{collapse=}\StringTok{"\#"}\NormalTok{), }\AttributeTok{split=}\StringTok{"\#"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] ""  "a"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 空字符只有有定义的时候才会产生}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{" "}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## character(0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strsplit}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{" "}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] ""
\end{verbatim}

\hypertarget{base-match}{%
\section{字符串匹配}\label{base-match}}

\texttt{agrep} 和 \texttt{agrepl} 函数做近似（模糊）匹配 (Approximate Matching or Fuzzy Matching) ，对于匹配，考虑到参数 pattern 在参数 x 中匹配时，允许参数值x存在最小可能的插入、删除和替换，这种修改叫做Levenshtein 编辑距离，\texttt{max.distance} 控制其细节

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(pattern, x, }\AttributeTok{max.distance =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{costs =} \ConstantTok{NULL}\NormalTok{,}
      \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{value =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{agrepl}\NormalTok{(pattern, x, }\AttributeTok{max.distance =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{costs =} \ConstantTok{NULL}\NormalTok{,}
       \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{agrep} 函数返回 pattern 在 x 中匹配到的一个位置向量，\texttt{agrepl} 返回一个逻辑向量，这一点类似 \texttt{grep} 和 \texttt{grepl} 这对函数，下面举例子说明

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\StringTok{"1 lazy 2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# sub = 0 表示匹配时不考虑替换}
\FunctionTok{agrep}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{" 1 lazy 2"}\NormalTok{, }\StringTok{"1 lasy 2"}\NormalTok{), }\AttributeTok{max =} \FunctionTok{list}\NormalTok{(}\AttributeTok{sub =} \DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 默认设置下，匹配时区分大小写}
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 返回匹配到值，而不是位置下标，类似 grep(..., value = TRUE) 的返回值}
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1 lazy"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 不区分大小写}
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{, }\AttributeTok{ignore.case =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{startsWith}\NormalTok{(x, prefix)}
  \FunctionTok{endsWith}\NormalTok{(x, suffix)}
\end{Highlighting}
\end{Shaded}

\texttt{startsWith} 和 \texttt{endsWith} 函数用来匹配字符串的前缀和后缀，返回值是一个逻辑向量，参数 prefix 和 suffix 不要包含特殊的正则表达式字符，如点号\texttt{.}，举例子

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 字符串向量}
\FunctionTok{search}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] ".GlobalEnv"        "package:stats"     "package:graphics" 
## [4] "package:grDevices" "package:utils"     "package:datasets" 
## [7] "package:methods"   "Autoloads"         "package:base"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 匹配以 package: 开头的字符串}
\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{search}\NormalTok{(), }\StringTok{"package:"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者}
\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}package:"}\NormalTok{, }\FunctionTok{search}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE
\end{verbatim}

当前目录下，列出扩展名为 \texttt{.Rmd} 的文件

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# list.files(path = ".", pattern = "\textbackslash{}\textbackslash{}.Rmd$")}
\CommentTok{\# 而不是 endsWith(list.files(), "\textbackslash{}\textbackslash{}.Rmd")}
\FunctionTok{endsWith}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(), }\StringTok{".Rmd"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE
##  [13]  TRUE  TRUE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE
##  [25] FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE
##  [37] FALSE FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE
##  [49] FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE  TRUE
##  [61]  TRUE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE
##  [73] FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE  TRUE
##  [85]  TRUE FALSE  TRUE  TRUE FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE
##  [97]  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
## [109]  TRUE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE FALSE FALSE  TRUE
## [121]  TRUE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE
## [133]  TRUE FALSE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE
## [145] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE
## [157]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE FALSE  TRUE FALSE
## [169]  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者}
\FunctionTok{grepl}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.Rmd$"}\NormalTok{, }\FunctionTok{list.files}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE
##  [13]  TRUE  TRUE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE
##  [25] FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE
##  [37] FALSE FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE
##  [49] FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE  TRUE
##  [61]  TRUE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE
##  [73] FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE  TRUE
##  [85]  TRUE FALSE  TRUE  TRUE FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE
##  [97]  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
## [109]  TRUE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE FALSE FALSE  TRUE
## [121]  TRUE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE
## [133]  TRUE FALSE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE
## [145] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE
## [157]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE FALSE  TRUE FALSE
## [169]  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE  TRUE
\end{verbatim}

部分匹配(Partial String Matching)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{match}\NormalTok{(x, table, }\AttributeTok{nomatch =} \ConstantTok{NA\_integer\_}\NormalTok{, }\AttributeTok{incomparables =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{x }\SpecialCharTok{\%in\%}\NormalTok{ table}
\FunctionTok{charmatch}\NormalTok{(x, table, }\AttributeTok{nomatch =} \ConstantTok{NA\_integer\_}\NormalTok{)}
\FunctionTok{pmatch}\NormalTok{(x, table, }\AttributeTok{nomatch =} \ConstantTok{NA\_integer\_}\NormalTok{, }\AttributeTok{duplicates.ok =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

这几个 \texttt{match} 函数的返回值都是一个向量，每个元素是参数x在参数table中第一次匹配到的位置，\texttt{charmatch} 与 \texttt{pmatch(x,\ table,\ nomatch\ =\ NA\_integer\_,\ duplicates.ok\ =\ TRUE)} 类似，所以 \texttt{pmatch} 在默认 \texttt{duplicates.ok\ =\ FALSE} 的情况下，若x在第二个参数table中有多次匹配就会返回 NA，因此，实际上 \texttt{pmatch} 只允许在第二个参数中匹配一次

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{match}\NormalTok{(}\StringTok{"xx"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"abc"}\NormalTok{, }\StringTok{"xx"}\NormalTok{, }\StringTok{"xxx"}\NormalTok{, }\StringTok{"xx"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\SpecialCharTok{:}\DecValTok{10} \SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# charmatch 就比较奇怪，规则太多}
\FunctionTok{charmatch}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{)                             }\CommentTok{\# returns 1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 多个精确匹配到，或者多个部分匹配到，则返回 0}
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"m"}\NormalTok{,   }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"median"}\NormalTok{, }\StringTok{"mode"}\NormalTok{, }\StringTok{"quantile"}\NormalTok{)) }\CommentTok{\# returns 0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# med 只在table参数值的第二个位置部分匹配到，所以返回2}
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"med"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"median"}\NormalTok{, }\StringTok{"mode"}\NormalTok{, }\StringTok{"quantile"}\NormalTok{)) }\CommentTok{\# returns 2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"xx"}\NormalTok{, }\StringTok{"xx"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"xx"}\NormalTok{, }\StringTok{"xxa"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"xx"}\NormalTok{, }\StringTok{"axx"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 注意比较与 charmatch 的不同}
\FunctionTok{pmatch}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{)                             }\CommentTok{\# returns NA}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pmatch}\NormalTok{(}\StringTok{"m"}\NormalTok{,   }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"median"}\NormalTok{, }\StringTok{"mode"}\NormalTok{)) }\CommentTok{\# returns NA}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pmatch}\NormalTok{(}\StringTok{"med"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"median"}\NormalTok{, }\StringTok{"mode"}\NormalTok{)) }\CommentTok{\# returns 2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\hypertarget{base-search}{%
\section{字符串查询}\label{base-search}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(pattern, x,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{value =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{invert =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{grepl}\NormalTok{(pattern, x,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{grep} 和 \texttt{grepl} 是一对字符串查询函数，查看字符串向量 x 中是否包含正则表达式 pattern 描述的内容

\begin{itemize}
\tightlist
\item
  \texttt{ignore.case}: \texttt{TRUE} 表示忽略大小写，\texttt{FALSE} 表示匹配的时候区分大小写
\item
  \texttt{fixed\ =\ TRUE} 表示启用 literal regular expression 字面正则表达式，默认情况下\texttt{fixed\ =\ FALSE}
\item
  \texttt{grep} 函数返回匹配到的字符串向量x的元素的下标，如果 \texttt{value=TRUE} 则返回下标对应的值
\item
  \texttt{grepl} 函数返回一个逻辑向量，检查字符串向量x中的每个元素是否匹配到，匹配到返回 \texttt{TRUE}，没有匹配到返回 \texttt{FALSE}
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 返回下标位置}
\FunctionTok{grep}\NormalTok{(}\StringTok{"[a{-}z]"}\NormalTok{, letters)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
## [26] 26
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 返回查询到的值}
\FunctionTok{grep}\NormalTok{(}\StringTok{"[a{-}z]"}\NormalTok{, letters, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
## [20] "t" "u" "v" "w" "x" "y" "z"
\end{verbatim}

继续举例子

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"a"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"b"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"a"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "apple"  "banana"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"b"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "banana"
\end{verbatim}

关于 \texttt{grepl} 函数的使用例子

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"a"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"b"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE  TRUE
\end{verbatim}

R 语言是用字符串来表示正则表达式的，但是正则表达式不是字符串，字符串的构造类似算术表达式

在 R 里面分别表示 \texttt{a\textbackslash{}\textbackslash{}b} 和 \texttt{a\textbackslash{}b}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a\\b
## a\b
\end{verbatim}

下面在 R 里面分别匹配字符串 \texttt{a\textbackslash{}\textbackslash{}b} 和 \texttt{a\textbackslash{}b} 中的 \texttt{\textbackslash{}\textbackslash{}} 和 \texttt{\textbackslash{}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 匹配字符串中的一个反斜杠}
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a\\\\b" "a\\b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a\\\\b" "a\\b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 匹配字符串中的两个反斜杠}
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a\\\\b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a\\\\b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 匹配字符串中的两个反斜杠 \textbackslash{}\textbackslash{}}
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regexpr}\NormalTok{(pattern, text,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{gregexpr}\NormalTok{(pattern, text,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{regexec}\NormalTok{(pattern, text,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}
\NormalTok{)       }
\end{Highlighting}
\end{Shaded}

当启用 \texttt{perl=TRUE} 时， 函数 \texttt{regexpr} 和 \texttt{gregexpr} 支持 Python 环境下的命名捕获(named captures)，但是不支持长向量的输入。如果一个分组被命名了，如 \texttt{(?\textless{}first\textgreater{}{[}A-Z{]}{[}a-z{]}+)} 那么匹配到的位置按命名返回。函数 \texttt{sub} 不支持命名反向引用 (Named backreferences)

函数 \texttt{regmatches} 用来提取函数\texttt{regexpr}, \texttt{gregexpr} 和 \texttt{regexec} 匹配到的子字符串

\texttt{useBytes\ =\ FALSE} 匹配位置和长度默认是按照字符级别来的，如果 \texttt{useBytes\ =\ TRUE} 则是按照逐个字节的匹配结果

如果使用到了 \textbf{命名捕获} 则会返回更多的属性 ``capture.start''，``capture.length'' 和 ``capture.names''，分别表示捕获的起始位置、捕获的长度和捕获的命名。

\begin{itemize}
\tightlist
\item
  \texttt{regexpr} 函数返回一个整型向量，第一次匹配的初始位置，-1 表示没有匹配到，返回的属性 \texttt{match.length} 表示匹配的字符数量，是一个整型向量，向量长度是匹配的文本的长度，-1 表示没有匹配到
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{text }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Hellow, Adam!"}\NormalTok{, }\StringTok{"Hi, Adam!"}\NormalTok{, }\StringTok{"How are you, Adam."}\NormalTok{)}
\FunctionTok{regexpr}\NormalTok{(}\StringTok{"Adam"}\NormalTok{, text)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  9  5 14
## attr(,"match.length")
## [1] 4 4 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{txt }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"The"}\NormalTok{, }\StringTok{"licenses"}\NormalTok{, }\StringTok{"for"}\NormalTok{, }\StringTok{"most"}\NormalTok{, }\StringTok{"software"}\NormalTok{, }\StringTok{"are"}\NormalTok{,}
  \StringTok{"designed"}\NormalTok{, }\StringTok{"to"}\NormalTok{, }\StringTok{"take"}\NormalTok{, }\StringTok{"away"}\NormalTok{, }\StringTok{"your"}\NormalTok{, }\StringTok{"freedom"}\NormalTok{,}
  \StringTok{"to"}\NormalTok{, }\StringTok{"share"}\NormalTok{, }\StringTok{"and"}\NormalTok{, }\StringTok{"change"}\NormalTok{, }\StringTok{"it."}\NormalTok{,}
  \StringTok{""}\NormalTok{, }\StringTok{"By"}\NormalTok{, }\StringTok{"contrast,"}\NormalTok{, }\StringTok{"the"}\NormalTok{, }\StringTok{"GNU"}\NormalTok{, }\StringTok{"General"}\NormalTok{, }\StringTok{"Public"}\NormalTok{, }\StringTok{"License"}\NormalTok{,}
  \StringTok{"is"}\NormalTok{, }\StringTok{"intended"}\NormalTok{, }\StringTok{"to"}\NormalTok{, }\StringTok{"guarantee"}\NormalTok{, }\StringTok{"your"}\NormalTok{, }\StringTok{"freedom"}\NormalTok{, }\StringTok{"to"}\NormalTok{,}
  \StringTok{"share"}\NormalTok{, }\StringTok{"and"}\NormalTok{, }\StringTok{"change"}\NormalTok{, }\StringTok{"free"}\NormalTok{, }\StringTok{"software"}\NormalTok{, }\StringTok{"{-}{-}"}\NormalTok{,}
  \StringTok{"to"}\NormalTok{, }\StringTok{"make"}\NormalTok{, }\StringTok{"sure"}\NormalTok{, }\StringTok{"the"}\NormalTok{, }\StringTok{"software"}\NormalTok{, }\StringTok{"is"}\NormalTok{,}
  \StringTok{"free"}\NormalTok{, }\StringTok{"for"}\NormalTok{, }\StringTok{"all"}\NormalTok{, }\StringTok{"its"}\NormalTok{, }\StringTok{"users"}
\NormalTok{)}
\CommentTok{\# gregexpr("en", txt)}
\FunctionTok{regexpr}\NormalTok{(}\StringTok{"en"}\NormalTok{, txt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] -1  4 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1  2 -1  4
## [26] -1  4 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
## attr(,"match.length")
##  [1] -1  2 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1  2 -1  2
## [26] -1  2 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{gregexpr} 函数返回一个列表，返回列表的长度与字符串向量的长度一样，列表中每个元素的形式与 \texttt{regexpr} 的返回值一样, except that the starting positions of every (disjoint) match are given.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gregexpr}\NormalTok{(}\StringTok{"Adam"}\NormalTok{, text)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 9
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## 
## [[2]]
## [1] 5
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## 
## [[3]]
## [1] 14
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{regexec} 函数返回一个列表，类似函数\texttt{gregexpr}的返回结果，长度与字符串向量的长度一样，如果没有匹配到就返回 -1，匹配到了就返回一个匹配的初值位置的整型序列，所有子字符串与括号分组的正则表达式的子表达式对应，属性 ``match.length'' 是一个表示匹配的长度的向量，如果是 -1 表示没有匹配到。位置、长度和属性的解释与 \texttt{regexpr} 一致
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regexec}\NormalTok{(}\StringTok{"Adam"}\NormalTok{, text)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 9
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## 
## [[2]]
## [1] 5
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## 
## [[3]]
## [1] 14
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

由于资源限制（特别是 PCRE）导致的匹配失败，会视为没有匹配，通常伴随一个警告

下面这个将链接分解的例子由 Luke Tierney 提供\footnote{\url{https://homepage.divms.uiowa.edu/~luke/R/regexp.html}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"http://stat.umn.edu:80/xyz"}
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{regexec}\NormalTok{(}\StringTok{"\^{}(([\^{}:]+)://)?([\^{}:/]+)(:([0{-}9]+))?(/.*)"}\NormalTok{, x)}
\NormalTok{m}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1]  1  1  1  8 20 21 23
## attr(,"match.length")
## [1] 26  7  4 12  3  2  4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

这里 x 是一个字符串，所以函数 \texttt{regexec} 返回的列表长度为1，正则表达式 \texttt{\^{}(({[}\^{}:{]}+)://)?({[}\^{}:/{]}+)(:({[}0-9{]}+))?(/.*)} 括号分组匹配到了7次，第一次匹配整个字符串，所以起始位置是1，而匹配长度是26，即整个字符串的长度，读者可以调用函数 \texttt{nchar(x)} 算一下，如果你愿意手动数一下也可以哈！余下不一一介绍，可以根据返回结果和图\ref{fig:regex101}一起看，最后还可以调用\texttt{regmatches}函数抽取匹配到的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regmatches}\NormalTok{(x, m)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "http://stat.umn.edu:80/xyz" "http://"                   
## [3] "http"                       "stat.umn.edu"              
## [5] ":80"                        "80"                        
## [7] "/xyz"
\end{verbatim}

我们可以在 \url{https://regex101.com/} 上测试表达式，如图\ref{fig:regex101}所示，表达式 \texttt{\^{}(({[}\^{}:{]}+)://)?({[}\^{}:/{]}+)(:({[}0-9{]}+))?(/.*)} 包含7个组，每个组的匹配结果见图的右下角，这样我们不难理解，函数 \texttt{regmatches} 返回的第列表中，第3个位置是传输协议 protocol \texttt{http} ，第4个位置是主机 host \texttt{stat.umn.edu}， 第6个位置是端口 port \texttt{80} ，第7个位置是路径 path \texttt{/xyz}，所以函数 \texttt{regmatches} 的作用就是根据函数 \texttt{regexec} 匹配的结果抽取子字符串。

\begin{figure}

{\centering \href{https://regex101.com/}{\includegraphics[width=0.75\linewidth]{screenshots/regexp-name-group} }

}

\caption{正则表达式匹配结果}\label{fig:regex101}
\end{figure}

进一步，我们可以用 \texttt{regmatches} 函数抽取 URL 的部分内容，如前面提到的传输协议，主机等

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{URL\_parts }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  m }\OtherTok{\textless{}{-}} \FunctionTok{regexec}\NormalTok{(}\StringTok{"\^{}(([\^{}:]+)://)?([\^{}:/]+)(:([0{-}9]+))?(/.*)"}\NormalTok{, x)}
\NormalTok{  parts }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}
\NormalTok{    rbind,}
    \FunctionTok{lapply}\NormalTok{(}\FunctionTok{regmatches}\NormalTok{(x, m), }\StringTok{\textasciigrave{}}\AttributeTok{[}\StringTok{\textasciigrave{}}\NormalTok{, }\FunctionTok{c}\NormalTok{(3L, 4L, 6L, 7L))}
    \CommentTok{\# 3,4,6,7是索引位置}
\NormalTok{  )}
  \FunctionTok{colnames}\NormalTok{(parts) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"protocol"}\NormalTok{, }\StringTok{"host"}\NormalTok{, }\StringTok{"port"}\NormalTok{, }\StringTok{"path"}\NormalTok{)}
\NormalTok{  parts}
\NormalTok{\}}
\FunctionTok{URL\_parts}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      protocol host           port path  
## [1,] "http"   "stat.umn.edu" "80" "/xyz"
\end{verbatim}

目前还没有 \texttt{gregexec} 函数，但是可以模拟一个，首先用 \texttt{gregexpr} 函数返回匹配的位置，\texttt{regmatches} 抽取相应的值，然后用 \texttt{regexec} 作用到每一个提取的值，做再一次匹配和值的抽取，实现了全部的匹配。另一个例子

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# There is no gregexec() yet, but one can emulate it by running}
\DocumentationTok{\#\# regexec() on the regmatches obtained via gregexpr().  E.g.:}
\NormalTok{pattern }\OtherTok{\textless{}{-}} \StringTok{"([[:alpha:]]+)([[:digit:]]+)"}
\NormalTok{s }\OtherTok{\textless{}{-}} \StringTok{"Test: A1 BC23 DEF456"}
\FunctionTok{gregexpr}\NormalTok{(pattern, s)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1]  7 10 15
## attr(,"match.length")
## [1] 2 4 6
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regmatches}\NormalTok{(s, }\FunctionTok{gregexpr}\NormalTok{(pattern, s))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "A1"     "BC23"   "DEF456"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lapply}\NormalTok{(}
  \FunctionTok{regmatches}\NormalTok{(s, }\FunctionTok{gregexpr}\NormalTok{(pattern, s)),}
  \ControlFlowTok{function}\NormalTok{(e) }\FunctionTok{regmatches}\NormalTok{(e, }\FunctionTok{regexec}\NormalTok{(pattern, e))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [[1]][[1]]
## [1] "A1" "A"  "1" 
## 
## [[1]][[2]]
## [1] "BC23" "BC"   "23"  
## 
## [[1]][[3]]
## [1] "DEF456" "DEF"    "456"
\end{verbatim}

\hypertarget{base-replacement}{%
\section{字符串替换}\label{base-replacement}}

\texttt{chartr} 支持正则表达式的替换，\texttt{chartr} 是对应字符的替换操作

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"MiXeD cAsE 123"}
\CommentTok{\# 将字符 iXs 替换为 why}
\FunctionTok{chartr}\NormalTok{(}\StringTok{"iXs"}\NormalTok{, }\StringTok{"why"}\NormalTok{, x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "MwheD cAyE 123"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 将字符串 a{-}cX 中的字符挨个对应地替换为 D{-}Fw}
\FunctionTok{chartr}\NormalTok{(}\StringTok{"a{-}cX"}\NormalTok{, }\StringTok{"D{-}Fw"}\NormalTok{, x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "MiweD FAsE 123"
\end{verbatim}

两个 \texttt{*sub} 函数的区别：\texttt{sub} 替换第一次匹配到的结果，\texttt{gsub} 替换所有匹配的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sub}\NormalTok{(}\StringTok{" .*"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{extSoftVersion}\NormalTok{()[}\StringTok{"PCRE"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    PCRE 
## "10.34"
\end{verbatim}

参数 replacement 的值是正则表达式，其包含反向引用的用法， \texttt{\textbackslash{}\textbackslash{}1} 即引用表达式 \texttt{({[}ab{]})}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern =}  \StringTok{"([ab])"}\NormalTok{, }\AttributeTok{replacement =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1\_}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1\_"}\NormalTok{, }\AttributeTok{x =} \StringTok{"abc and ABC"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a_a_b_b_c a_a_nd ABC"
\end{verbatim}

\hypertarget{base-extract}{%
\section{字符串提取}\label{base-extract}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substr}\NormalTok{(x, start, stop)}
\FunctionTok{substring}\NormalTok{(text, first, }\AttributeTok{last =}\NormalTok{ 1000000L)}
\end{Highlighting}
\end{Shaded}

\texttt{substr} 和 \texttt{substring} 函数通过位置进行字符串的拆分和提取，它们本身不使用正则表达式，结合其他正则表达式函数\texttt{regexpr}, \texttt{gregexpr} 和 \texttt{regexec}，可以很方便地从大量文本中提取所需的信息。作用类似之前提到的 \texttt{regmatches} 函数

参数设置基本相同

\begin{itemize}
\tightlist
\item
  x/text 是要拆分的字符串向量
\item
  start/first 截取的起始位置向量
\item
  stop/last 截取的终止位置向量
\end{itemize}

返回值有差别

\begin{itemize}
\tightlist
\item
  \texttt{substr} 返回的字串个数等于第一个参数 x 的长度
\item
  \texttt{substring} 返回字串个数等于三个参数中最长向量长度，短向量循环使用。
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"123456789"}
\FunctionTok{substr}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "234"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substring}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "234"     "45"      "2345678"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substr}\NormalTok{(}\StringTok{"abcdef"}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "bcd"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substring}\NormalTok{(}\StringTok{"abcdef"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a" "b" "c" "d" "e" "f"
\end{verbatim}

因为 x 的向量长度为1，所以 \texttt{substr} 获得的结果只有1个字串，即第2和第3个参数向量只用了第一个组合：起始位置2，终止位置4。而 \texttt{substring} 的语句三个参数中最长的向量为 \texttt{c(4,5,8)}，执行时按短向量循环使用的规则第一个参数事实上就是\texttt{c(x,x,x)}，第二个参数就成了\texttt{c(2,4,2)}，最终截取的字串起始位置组合为：2-4, 4-5和2-8。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"123456789"}\NormalTok{, }\StringTok{"abcdefghijklmnopq"}\NormalTok{)}
\FunctionTok{substr}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "234" "de"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substring}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "234"     "de"      "2345678"
\end{verbatim}

更加高级的字符串抽取

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 从字符串中抽取固定模式的文本，替代 stringr::str\_extract}
\CommentTok{\# 只抽取一个匹配的}
\NormalTok{extract\_str }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, pattern) }\FunctionTok{regmatches}\NormalTok{(text, }\FunctionTok{regexpr}\NormalTok{(pattern, text))}
\CommentTok{\# 符合模式的全部抽取}
\NormalTok{gextract\_str }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, pattern) }\FunctionTok{regmatches}\NormalTok{(text, }\FunctionTok{gregexpr}\NormalTok{(pattern, text))}
\end{Highlighting}
\end{Shaded}

举例子，抽取连续的数字

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个例子}
\FunctionTok{extract\_str}\NormalTok{(}\AttributeTok{text =} \StringTok{"abd123da345das"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)\{3\}"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "123"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gextract\_str}\NormalTok{(}\AttributeTok{text =} \StringTok{"abd123da345das"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)\{3\}"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "123" "345"
\end{verbatim}

例子来自于 \url{https://recology.info/2018/10/limiting-dependencies/}

\hypertarget{string-named-capture}{%
\section{命名捕捉}\label{string-named-capture}}

函数 \texttt{regexpr(...,\ perl\ =\ TRUE)} 和 \texttt{gregexpr(...,\ perl\ =\ TRUE)} 支持命名捕捉

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# named capture}
\NormalTok{notables }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"  Ben Franklin and Jefferson Davis"}\NormalTok{,}
              \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{Millard Fillmore"}\NormalTok{)}
\CommentTok{\# name groups \textquotesingle{}first\textquotesingle{} and \textquotesingle{}last\textquotesingle{}}
\NormalTok{name.rex }\OtherTok{\textless{}{-}} \StringTok{"(?\textless{}first\textgreater{}[[:upper:]][[:lower:]]+) (?\textless{}last\textgreater{}[[:upper:]][[:lower:]]+)"}

\NormalTok{(parsed }\OtherTok{\textless{}{-}} \FunctionTok{regexpr}\NormalTok{(name.rex, notables, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3 2
## attr(,"match.length")
## [1] 12 16
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## attr(,"capture.start")
##      first last
## [1,]     3    7
## [2,]     2   10
## attr(,"capture.length")
##      first last
## [1,]     3    8
## [2,]     7    8
## attr(,"capture.names")
## [1] "first" "last"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attr}\NormalTok{(parsed, }\StringTok{\textquotesingle{}capture.names\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "first" "last"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regmatches}\NormalTok{(notables, parsed)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Ben Franklin"     "Millard Fillmore"
\end{verbatim}

希望返回一个 data.frame，列名是指定的 named group 名字

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 有多个结果}
\NormalTok{(idx }\OtherTok{\textless{}{-}} \FunctionTok{gregexpr}\NormalTok{(name.rex, notables, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1]  3 20
## attr(,"match.length")
## [1] 12 15
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## attr(,"capture.start")
##      first last
## [1,]     3    7
## [2,]    20   30
## attr(,"capture.length")
##      first last
## [1,]     3    8
## [2,]     9    5
## attr(,"capture.names")
## [1] "first" "last" 
## 
## [[2]]
## [1] 2
## attr(,"match.length")
## [1] 16
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## attr(,"capture.start")
##      first last
## [1,]     2   10
## attr(,"capture.length")
##      first last
## [1,]     7    8
## attr(,"capture.names")
## [1] "first" "last"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regmatches}\NormalTok{(notables, idx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "Ben Franklin"    "Jefferson Davis"
## 
## [[2]]
## [1] "Millard Fillmore"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attr}\NormalTok{(idx[[}\DecValTok{1}\NormalTok{]], }\StringTok{\textquotesingle{}capture.names\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "first" "last"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{notable =}\NormalTok{ notables) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{tidyr}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(}
\NormalTok{    notable, }\FunctionTok{c}\NormalTok{(}\StringTok{"first"}\NormalTok{, }\StringTok{"last"}\NormalTok{), name.rex, }
    \AttributeTok{remove =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                              notable   first     last
## 1   Ben Franklin and Jefferson Davis     Ben Franklin
## 2                 \tMillard Fillmore Millard Fillmore
\end{verbatim}

\hypertarget{exact-match}{%
\section{精确匹配}\label{exact-match}}

\texttt{fixed\ =\ TRUE}

\hypertarget{fuzzy-match}{%
\section{模糊匹配}\label{fuzzy-match}}

近似字符串匹配 (Approximate String Matching) 也叫模糊匹配 (Fuzzy Matching)

\texttt{agrep()} \texttt{agrepl()} \texttt{aregexec()} \texttt{adist()}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"lasy"}\NormalTok{, }\AttributeTok{x =} \StringTok{"1 lazy 2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{" 1 lazy 2"}\NormalTok{, }\StringTok{"1 lasy 2"}\NormalTok{), }\AttributeTok{max =} \FunctionTok{list}\NormalTok{(}\AttributeTok{sub =} \DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1 lazy"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{, }\AttributeTok{ignore.case =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrepl}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"lasy"}\NormalTok{, }\AttributeTok{x =} \StringTok{"1 lazy 2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Cf. the examples for agrep.}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{)}

\FunctionTok{aregexec}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, x, }\AttributeTok{max.distance =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 3
## attr(,"match.length")
## [1] 4
## 
## [[2]]
## [1] -1
## attr(,"match.length")
## [1] -1
## 
## [[3]]
## [1] -1
## attr(,"match.length")
## [1] -1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aregexec}\NormalTok{(}\StringTok{"(lay)(sy)"}\NormalTok{, x, }\AttributeTok{max.distance =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 3 3 5
## attr(,"match.length")
## [1] 4 2 2
## 
## [[2]]
## [1] -1
## attr(,"match.length")
## [1] -1
## 
## [[3]]
## [1] -1
## attr(,"match.length")
## [1] -1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aregexec}\NormalTok{(}\StringTok{"(lay)(sy)"}\NormalTok{, x, }\AttributeTok{max.distance =} \DecValTok{2}\NormalTok{, }\AttributeTok{ignore.case =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 3 3 6
## attr(,"match.length")
## [1] 4 3 1
## 
## [[2]]
## [1] -1
## attr(,"match.length")
## [1] -1
## 
## [[3]]
## [1] 3 3 6
## attr(,"match.length")
## [1] 4 3 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{aregexec}\NormalTok{(}\StringTok{"(lay)(sy)"}\NormalTok{, x, }\AttributeTok{max.distance =} \DecValTok{2}\NormalTok{)}
\FunctionTok{regmatches}\NormalTok{(x, m)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "lazy" "la"   "zy"  
## 
## [[2]]
## character(0)
## 
## [[3]]
## character(0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Cf. https://en.wikipedia.org/wiki/Levenshtein\_distance}
\FunctionTok{adist}\NormalTok{(}\StringTok{"kitten"}\NormalTok{, }\StringTok{"sitting"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]
## [1,]    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# To see the transformation counts for the Levenshtein distance:}
\FunctionTok{drop}\NormalTok{(}\FunctionTok{attr}\NormalTok{(}\FunctionTok{adist}\NormalTok{(}\StringTok{"kitten"}\NormalTok{, }\StringTok{"sitting"}\NormalTok{, }\AttributeTok{counts =} \ConstantTok{TRUE}\NormalTok{), }\StringTok{"counts"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ins del sub 
##   1   0   2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# To see the transformation sequences:}
\FunctionTok{attr}\NormalTok{(}\FunctionTok{adist}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"kitten"}\NormalTok{, }\StringTok{"sitting"}\NormalTok{), }\AttributeTok{counts =} \ConstantTok{TRUE}\NormalTok{), }\StringTok{"trafos"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]      [,2]     
## [1,] "MMMMMM"  "SMMMSMI"
## [2,] "SMMMSMD" "MMMMMMM"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Cf. the examples for agrep:}
\FunctionTok{adist}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\StringTok{"1 lazy 2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]
## [1,]    5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# For a "partial approximate match" (as used for agrep):}
\FunctionTok{adist}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\StringTok{"1 lazy 2"}\NormalTok{, }\AttributeTok{partial =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]
## [1,]    1
\end{verbatim}

案例

\texttt{help.search()}

\hypertarget{replace}{%
\section{高级的替换}\label{replace}}

相比于 \texttt{sprintf()} 格式化输出字符串的方式替换，它的优势在于提示性，或者说代码的可读性

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{glue\_data }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(param, text) \{}
\NormalTok{  idx }\OtherTok{\textless{}{-}} \FunctionTok{gregexpr}\NormalTok{(}\StringTok{\textquotesingle{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{[\^{}\}]*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}\textquotesingle{}}\NormalTok{, text)[[1L]]}
\NormalTok{  keys }\OtherTok{\textless{}{-}} \FunctionTok{substring}\NormalTok{(text, idx, idx }\SpecialCharTok{+} \FunctionTok{attr}\NormalTok{(idx, }\StringTok{\textquotesingle{}match.length\textquotesingle{}}\NormalTok{) }\SpecialCharTok{{-}}\NormalTok{ 1L)}
  \ControlFlowTok{for}\NormalTok{ (key }\ControlFlowTok{in}\NormalTok{ keys) \{}
\NormalTok{    text }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(key, param[[}\FunctionTok{gsub}\NormalTok{(}\StringTok{\textquotesingle{}[\{\}]\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{, key)]], text, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  text}
\NormalTok{\}}
\FunctionTok{cat}\NormalTok{(}\FunctionTok{glue\_data}\NormalTok{(}
  \AttributeTok{param =} \FunctionTok{list}\NormalTok{(}\AttributeTok{table =} \StringTok{\textquotesingle{}flights\textquotesingle{}}\NormalTok{, }\AttributeTok{origin =} \StringTok{\textquotesingle{}JFK\textquotesingle{}}\NormalTok{),}
  \AttributeTok{text =} \StringTok{"}
\StringTok{  select count(*) as n}
\StringTok{  from \{table\}}
\StringTok{  where origin = \textquotesingle{}\{origin\}\textquotesingle{}}
\StringTok{  "}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##   select count(*) as n
##   from flights
##   where origin = 'JFK'
## 
\end{verbatim}

\hypertarget{extract}{%
\section{高级的提取}\label{extract}}

从 text 中抽取给定模式 pattern 的字符串

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{str\_extract }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, pattern, ...) }\FunctionTok{regmatches}\NormalTok{(text, }\FunctionTok{regexpr}\NormalTok{(pattern, text, ...))}
\end{Highlighting}
\end{Shaded}

举个栗子，比如提取数字

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{shopping\_list }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"apples x4"}\NormalTok{, }\StringTok{"bag of flour"}\NormalTok{, }\StringTok{"bag of sugar"}\NormalTok{, }\StringTok{"milk x2"}\NormalTok{)}
\NormalTok{stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(shopping\_list, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "4" NA  NA  "2"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 注意二者的差别}
\FunctionTok{str\_extract}\NormalTok{(shopping\_list, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "4" "2"
\end{verbatim}

提取所有符合匹配模式的字符串

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{str\_extract\_all }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, pattern, ...) }\FunctionTok{regmatches}\NormalTok{(text, }\FunctionTok{gregexpr}\NormalTok{(pattern, text, ...))}
\end{Highlighting}
\end{Shaded}

举个栗子，提取其中的英文字母

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str\_extract\_all}\NormalTok{(shopping\_list, }\StringTok{"[a{-}z]+"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "apples" "x"     
## 
## [[2]]
## [1] "bag"   "of"    "flour"
## 
## [[3]]
## [1] "bag"   "of"    "sugar"
## 
## [[4]]
## [1] "milk" "x"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(shopping\_list, }\StringTok{"[a{-}z]+"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "apples" "x"     
## 
## [[2]]
## [1] "bag"   "of"    "flour"
## 
## [[3]]
## [1] "bag"   "of"    "sugar"
## 
## [[4]]
## [1] "milk" "x"
\end{verbatim}

\hypertarget{other-string-op}{%
\section{其它操作}\label{other-string-op}}

\hypertarget{strwrap}{%
\subsection{strwrap}\label{strwrap}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{width =} \FloatTok{0.9} \SpecialCharTok{*} \FunctionTok{getOption}\NormalTok{(}\StringTok{"width"}\NormalTok{), }\AttributeTok{indent =} \DecValTok{0}\NormalTok{,}
        \AttributeTok{exdent =} \DecValTok{0}\NormalTok{, }\AttributeTok{prefix =} \StringTok{""}\NormalTok{, }\AttributeTok{simplify =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{initial =}\NormalTok{ prefix)}
\end{Highlighting}
\end{Shaded}

该函数把一个字符串当成一个段落的文字（不管字符串中是否有换行符），按照段落的格式（缩进和长度）和断字方式进行分行，每一行是结果中的一个字符串。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 读取一段文本}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(}\StringTok{"doc"}\NormalTok{), }\StringTok{"THANKS"}\NormalTok{)), }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\DocumentationTok{\#\# 将文本拆分为段落，且移除前三段}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(x, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{[ }\SpecialCharTok{\textbackslash{}t\textbackslash{}n}\StringTok{]*}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)]}
\CommentTok{\# 每一段换两行}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(x, }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
\CommentTok{\# 每一行的宽度设定为60个字符}
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{width =} \DecValTok{60}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## J. D. Beasley, David J. Best, Richard Brent, Kevin Buhr,
## Michael A. Covington, Bill Cleveland, Robert Cleveland,, G.
## W. Cran, C. G. Ding, Ulrich Drepper, Paul Eggert, J. O.
## Evans, David M. Gay, H. Frick, G. W. Hill, Richard H.
## Jones, Eric Grosse, Shelby Haberman, Bruno Haible, John
## Hartigan, Andrew Harvey, Trevor Hastie, Min Long Lam,
## George Marsaglia, K. J. Martin, Gordon Matzigkeit, C. R.
## Mckenzie, Jean McRae, Cyrus Mehta, Fionn Murtagh, John C.
## Nash, Finbarr O'Sullivan, R. E. Odeh, William Patefield,
## Nitin Patel, Alan Richardson, D. E. Roberts, Patrick
## Royston, Russell Lenth, Ming-Jen Shyu, Richard C.
## Singleton, S. G. Springer, Supoj Sutanthavibul, Irma
## Terpenning, G. E. Thomas, Rob Tibshirani, Wai Wan Tsang,
## Berwin Turlach, Gary V. Vaughan, Michael Wichura, Jingbo
## Wang, M. A. Wong, and the Free Software Foundation (for
## autoconf code and utilities). See also files under
## src/extras.
## 
## Many more, too numerous to mention here, have contributed
## by sending bug reports and suggesting various improvements.
## 
## Simon Davies whilst at the University of Auckland wrote the
## original version of glm().
## 
## Julian Harris and Wing Kwong (Tiki) Wan whilst at the
## University of Auckland assisted Ross Ihaka with the
## original Macintosh port.
## 
## R was inspired by the S environment which has been
## principally developed by John Chambers, with substantial
## input from Douglas Bates, Rick Becker, Bill Cleveland,
## Trevor Hastie, Daryl Pregibon and Allan Wilks.
## 
## A special debt is owed to John Chambers who has graciously
## contributed advice and encouragement in the early days of R
## and later became a member of the core team.
## 
## Stefano Iacus (a former member of R Core) and Simon Urbanek
## developed the macOS port, including the R.app GUI,
## toolchains and packaging.
## 
## The Windows port was developed by Guido Masarotto (for a
## while a member of R Core) and Brian Ripley, then Duncan
## Murdoch (a former member of R Core) and currently by Jeroen
## Ooms (base) and Uwe Ligges (packages).
## 
## Tomas Kalibera's work has been sponsored by Jan Vitek and
## funded by his European Research Council grant "Evolving
## Language Ecosystems (ELE)".
## 
## Computing support (including hardware, hosting and
## infrastructure) has been provided/funded by the R
## Foundation, employers of R-Core members (notably WU Wien,
## ETH Zurich, U Oxford and U Iowa) and by Northeastern
## University and the University of Kent.
## 
## Distributions of R contain the recommended packages, whose
## authors/contributors are listed in their DESCRIPTION files.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 每一段的段首缩进5个字符}
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{width =} \DecValTok{60}\NormalTok{, }\AttributeTok{indent =} \DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      J. D. Beasley, David J. Best, Richard Brent, Kevin
## Buhr, Michael A. Covington, Bill Cleveland, Robert
## Cleveland,, G. W. Cran, C. G. Ding, Ulrich Drepper, Paul
## Eggert, J. O. Evans, David M. Gay, H. Frick, G. W. Hill,
## Richard H. Jones, Eric Grosse, Shelby Haberman, Bruno
## Haible, John Hartigan, Andrew Harvey, Trevor Hastie, Min
## Long Lam, George Marsaglia, K. J. Martin, Gordon
## Matzigkeit, C. R. Mckenzie, Jean McRae, Cyrus Mehta, Fionn
## Murtagh, John C. Nash, Finbarr O'Sullivan, R. E. Odeh,
## William Patefield, Nitin Patel, Alan Richardson, D. E.
## Roberts, Patrick Royston, Russell Lenth, Ming-Jen Shyu,
## Richard C. Singleton, S. G. Springer, Supoj Sutanthavibul,
## Irma Terpenning, G. E. Thomas, Rob Tibshirani, Wai Wan
## Tsang, Berwin Turlach, Gary V. Vaughan, Michael Wichura,
## Jingbo Wang, M. A. Wong, and the Free Software Foundation
## (for autoconf code and utilities). See also files under
## src/extras.
## 
##      Many more, too numerous to mention here, have
## contributed by sending bug reports and suggesting various
## improvements.
## 
##      Simon Davies whilst at the University of Auckland
## wrote the original version of glm().
## 
##      Julian Harris and Wing Kwong (Tiki) Wan whilst at the
## University of Auckland assisted Ross Ihaka with the
## original Macintosh port.
## 
##      R was inspired by the S environment which has been
## principally developed by John Chambers, with substantial
## input from Douglas Bates, Rick Becker, Bill Cleveland,
## Trevor Hastie, Daryl Pregibon and Allan Wilks.
## 
##      A special debt is owed to John Chambers who has
## graciously contributed advice and encouragement in the
## early days of R and later became a member of the core team.
## 
##      Stefano Iacus (a former member of R Core) and Simon
## Urbanek developed the macOS port, including the R.app GUI,
## toolchains and packaging.
## 
##      The Windows port was developed by Guido Masarotto (for
## a while a member of R Core) and Brian Ripley, then Duncan
## Murdoch (a former member of R Core) and currently by Jeroen
## Ooms (base) and Uwe Ligges (packages).
## 
##      Tomas Kalibera's work has been sponsored by Jan Vitek
## and funded by his European Research Council grant "Evolving
## Language Ecosystems (ELE)".
## 
##      Computing support (including hardware, hosting and
## infrastructure) has been provided/funded by the R
## Foundation, employers of R-Core members (notably WU Wien,
## ETH Zurich, U Oxford and U Iowa) and by Northeastern
## University and the University of Kent.
## 
##      Distributions of R contain the recommended packages,
## whose authors/contributors are listed in their DESCRIPTION
## files.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 除了段首，每一段的余下诸行都缩进5个字符}
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{width =} \DecValTok{60}\NormalTok{, }\AttributeTok{exdent =} \DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## J. D. Beasley, David J. Best, Richard Brent, Kevin Buhr,
##      Michael A. Covington, Bill Cleveland, Robert
##      Cleveland,, G. W. Cran, C. G. Ding, Ulrich Drepper,
##      Paul Eggert, J. O. Evans, David M. Gay, H. Frick, G.
##      W. Hill, Richard H. Jones, Eric Grosse, Shelby
##      Haberman, Bruno Haible, John Hartigan, Andrew Harvey,
##      Trevor Hastie, Min Long Lam, George Marsaglia, K. J.
##      Martin, Gordon Matzigkeit, C. R. Mckenzie, Jean McRae,
##      Cyrus Mehta, Fionn Murtagh, John C. Nash, Finbarr
##      O'Sullivan, R. E. Odeh, William Patefield, Nitin
##      Patel, Alan Richardson, D. E. Roberts, Patrick
##      Royston, Russell Lenth, Ming-Jen Shyu, Richard C.
##      Singleton, S. G. Springer, Supoj Sutanthavibul, Irma
##      Terpenning, G. E. Thomas, Rob Tibshirani, Wai Wan
##      Tsang, Berwin Turlach, Gary V. Vaughan, Michael
##      Wichura, Jingbo Wang, M. A. Wong, and the Free
##      Software Foundation (for autoconf code and utilities).
##      See also files under src/extras.
## 
## Many more, too numerous to mention here, have contributed
##      by sending bug reports and suggesting various
##      improvements.
## 
## Simon Davies whilst at the University of Auckland wrote the
##      original version of glm().
## 
## Julian Harris and Wing Kwong (Tiki) Wan whilst at the
##      University of Auckland assisted Ross Ihaka with the
##      original Macintosh port.
## 
## R was inspired by the S environment which has been
##      principally developed by John Chambers, with
##      substantial input from Douglas Bates, Rick Becker,
##      Bill Cleveland, Trevor Hastie, Daryl Pregibon and
##      Allan Wilks.
## 
## A special debt is owed to John Chambers who has graciously
##      contributed advice and encouragement in the early days
##      of R and later became a member of the core team.
## 
## Stefano Iacus (a former member of R Core) and Simon Urbanek
##      developed the macOS port, including the R.app GUI,
##      toolchains and packaging.
## 
## The Windows port was developed by Guido Masarotto (for a
##      while a member of R Core) and Brian Ripley, then
##      Duncan Murdoch (a former member of R Core) and
##      currently by Jeroen Ooms (base) and Uwe Ligges
##      (packages).
## 
## Tomas Kalibera's work has been sponsored by Jan Vitek and
##      funded by his European Research Council grant
##      "Evolving Language Ecosystems (ELE)".
## 
## Computing support (including hardware, hosting and
##      infrastructure) has been provided/funded by the R
##      Foundation, employers of R-Core members (notably WU
##      Wien, ETH Zurich, U Oxford and U Iowa) and by
##      Northeastern University and the University of Kent.
## 
## Distributions of R contain the recommended packages, whose
##      authors/contributors are listed in their DESCRIPTION
##      files.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 在输出的每一行前面添加前缀}
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{prefix =} \StringTok{"THANKS\textgreater{} "}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## THANKS> J. D. Beasley, David J. Best, Richard Brent, Kevin Buhr,
## THANKS> Michael A. Covington, Bill Cleveland, Robert Cleveland,, G. W.
## THANKS> Cran, C. G. Ding, Ulrich Drepper, Paul Eggert, J. O. Evans,
## THANKS> David M. Gay, H. Frick, G. W. Hill, Richard H. Jones, Eric
## THANKS> Grosse, Shelby Haberman, Bruno Haible, John Hartigan, Andrew
## THANKS> Harvey, Trevor Hastie, Min Long Lam, George Marsaglia, K. J.
## THANKS> Martin, Gordon Matzigkeit, C. R. Mckenzie, Jean McRae, Cyrus
## THANKS> Mehta, Fionn Murtagh, John C. Nash, Finbarr O'Sullivan, R. E.
## THANKS> Odeh, William Patefield, Nitin Patel, Alan Richardson, D. E.
## THANKS> Roberts, Patrick Royston, Russell Lenth, Ming-Jen Shyu, Richard
## THANKS> C. Singleton, S. G. Springer, Supoj Sutanthavibul, Irma
## THANKS> Terpenning, G. E. Thomas, Rob Tibshirani, Wai Wan Tsang, Berwin
## THANKS> Turlach, Gary V. Vaughan, Michael Wichura, Jingbo Wang, M. A.
## THANKS> Wong, and the Free Software Foundation (for autoconf code and
## THANKS> utilities). See also files under src/extras.
## THANKS> 
## THANKS> Many more, too numerous to mention here, have contributed by
## THANKS> sending bug reports and suggesting various improvements.
## THANKS> 
## THANKS> Simon Davies whilst at the University of Auckland wrote the
## THANKS> original version of glm().
## THANKS> 
## THANKS> Julian Harris and Wing Kwong (Tiki) Wan whilst at the
## THANKS> University of Auckland assisted Ross Ihaka with the original
## THANKS> Macintosh port.
## THANKS> 
## THANKS> R was inspired by the S environment which has been principally
## THANKS> developed by John Chambers, with substantial input from Douglas
## THANKS> Bates, Rick Becker, Bill Cleveland, Trevor Hastie, Daryl
## THANKS> Pregibon and Allan Wilks.
## THANKS> 
## THANKS> A special debt is owed to John Chambers who has graciously
## THANKS> contributed advice and encouragement in the early days of R and
## THANKS> later became a member of the core team.
## THANKS> 
## THANKS> Stefano Iacus (a former member of R Core) and Simon Urbanek
## THANKS> developed the macOS port, including the R.app GUI, toolchains
## THANKS> and packaging.
## THANKS> 
## THANKS> The Windows port was developed by Guido Masarotto (for a while
## THANKS> a member of R Core) and Brian Ripley, then Duncan Murdoch (a
## THANKS> former member of R Core) and currently by Jeroen Ooms (base)
## THANKS> and Uwe Ligges (packages).
## THANKS> 
## THANKS> Tomas Kalibera's work has been sponsored by Jan Vitek and
## THANKS> funded by his European Research Council grant "Evolving
## THANKS> Language Ecosystems (ELE)".
## THANKS> 
## THANKS> Computing support (including hardware, hosting and
## THANKS> infrastructure) has been provided/funded by the R Foundation,
## THANKS> employers of R-Core members (notably WU Wien, ETH Zurich, U
## THANKS> Oxford and U Iowa) and by Northeastern University and the
## THANKS> University of Kent.
## THANKS> 
## THANKS> Distributions of R contain the recommended packages, whose
## THANKS> authors/contributors are listed in their DESCRIPTION files.
\end{verbatim}

再举一个烧脑的例子

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(}
  \FunctionTok{sample}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{), }\CommentTok{\# 从1{-}10个数字中有放回的随机抽取100个数}
  \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{substring}\NormalTok{(}\StringTok{"aaaaaaaaaa"}\NormalTok{, }\DecValTok{1}\NormalTok{, x)}
\NormalTok{), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{)}
\FunctionTok{sapply}\NormalTok{(}
  \DecValTok{10}\SpecialCharTok{:}\DecValTok{40}\NormalTok{,}
  \ControlFlowTok{function}\NormalTok{(m)}
    \FunctionTok{c}\NormalTok{(}\AttributeTok{target =}\NormalTok{ m, }\AttributeTok{actual =} \FunctionTok{max}\NormalTok{(}\FunctionTok{nchar}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, m))))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]
## target   10   11   12   13   14   15   16   17   18    19    20    21    22
## actual   10   10   11   12   13   14   15   16   17    18    19    20    21
##        [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24] [,25]
## target    23    24    25    26    27    28    29    30    31    32    33    34
## actual    22    23    24    25    26    27    28    29    30    31    32    33
##        [,26] [,27] [,28] [,29] [,30] [,31]
## target    35    36    37    38    39    40
## actual    34    35    36    37    38    39
\end{verbatim}

\hypertarget{strtrim}{%
\subsection{strtrim}\label{strtrim}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strtrim}\NormalTok{(x, width)}
\end{Highlighting}
\end{Shaded}

\texttt{strtrim} 函数将字符串x修剪到特定的显示宽度，返回的字符串向量的长度等于字符串向量 x 的长度，如果 width 的参数值（它是一个整型向量）的长度小于 x 的，就循环补齐。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strtrim}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"abcdef"}\NormalTok{, }\StringTok{"abcdef"}\NormalTok{, }\StringTok{"abcdef"}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a"      "abcde"  "abcdef"
\end{verbatim}

\hypertarget{strrep}{%
\subsection{strrep}\label{strrep}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strrep}\NormalTok{(x, times)}
\end{Highlighting}
\end{Shaded}

以给定的次数重复字符串向量中每个元素的个数，并连接字符串的各个副本

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strrep}\NormalTok{(}\StringTok{"ABC"}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ABCABC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strrep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1} \SpecialCharTok{:} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A"   "BB"  "CCC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 创建一个字符串向量，指定每个元素中空格的数量}
\FunctionTok{strrep}\NormalTok{(}\StringTok{" "}\NormalTok{, }\DecValTok{1} \SpecialCharTok{:} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] " "     "  "    "   "   "    "  "     "
\end{verbatim}

\hypertarget{trimws}{%
\subsection{trimws}\label{trimws}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trimws}\NormalTok{(x, }\AttributeTok{which =} \FunctionTok{c}\NormalTok{(}\StringTok{"both"}\NormalTok{, }\StringTok{"left"}\NormalTok{, }\StringTok{"right"}\NormalTok{), }\AttributeTok{whitespace =} \StringTok{"[ }\SpecialCharTok{\textbackslash{}t\textbackslash{}r\textbackslash{}n}\StringTok{]"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{trimws} 函数用于移除字符串中的空格，这种空格可以来自制表符、回车符和换行符，位置可以位于字符串的开头或者结尾，\texttt{which} 参数指定空格的大致位置。举例如下

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"  Some text. "}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "  Some text. "
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trimws}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Some text."
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trimws}\NormalTok{(x, }\StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Some text. "
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trimws}\NormalTok{(x, }\StringTok{"r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "  Some text."
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{shopping\_list }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"apples x4"}\NormalTok{, }\StringTok{"bag of flour"}\NormalTok{, }\StringTok{"bag of sugar"}\NormalTok{, }\StringTok{"milk x2"}\NormalTok{)}

\NormalTok{stringr}\SpecialCharTok{::}\FunctionTok{str\_replace}\NormalTok{(}\AttributeTok{string =}\NormalTok{ shopping\_list, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{, }\AttributeTok{replacement =} \StringTok{"aa"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "apples xaa"   "bag of flour" "bag of sugar" "milk xaa"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://github.com/hadley/stringb/issues/5}
\CommentTok{\# x is vector}
\NormalTok{str\_replace }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, pattern, fun, ...) \{}
\NormalTok{  loc }\OtherTok{\textless{}{-}} \FunctionTok{gregexpr}\NormalTok{(pattern, }\AttributeTok{text =}\NormalTok{ x, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  matches }\OtherTok{\textless{}{-}} \FunctionTok{regmatches}\NormalTok{(x, loc)}
\NormalTok{  out }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(matches, fun, ...)}

  \FunctionTok{regmatches}\NormalTok{(x, loc) }\OtherTok{\textless{}{-}}\NormalTok{ out}
\NormalTok{  x}
\NormalTok{\}}


\NormalTok{loc }\OtherTok{\textless{}{-}} \FunctionTok{gregexpr}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{, }\AttributeTok{text =}\NormalTok{ shopping\_list, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{)}

\NormalTok{matches }\OtherTok{=} \FunctionTok{regmatches}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shopping\_list, loc)}

\NormalTok{matches}

\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(matches, transform, }\StringTok{"aa"}\NormalTok{)}

\FunctionTok{regmatches}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shopping\_list, loc) }\OtherTok{\textless{}{-}}\NormalTok{ out}


\NormalTok{shopping\_list}


\FunctionTok{str\_replace}\NormalTok{(shopping\_list, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{, }\AttributeTok{replace =} \StringTok{"aa"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{tolower}{%
\subsection{tolower}\label{tolower}}

tolower 和 toupper 是一对，将大写转小写，小写转大写

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{simpleCap }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{tolower}\NormalTok{(x)}
\NormalTok{  s }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(x, }\StringTok{" "}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
  \FunctionTok{paste}\NormalTok{(}\FunctionTok{toupper}\NormalTok{(}\FunctionTok{substring}\NormalTok{(s, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)), }\FunctionTok{substring}\NormalTok{(s, }\DecValTok{2}\NormalTok{),}
    \AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{collapse =} \StringTok{" "}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 参考文献条目里需要将每个英文单词的首字母大写}
\FunctionTok{simpleCap}\NormalTok{(}\AttributeTok{x =} \StringTok{"THE USE OF MULTIPLE MEASUREMENTS IN TAXONOMIC PROBLEMS"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "The Use Of Multiple Measurements In Taxonomic Problems"
\end{verbatim}

\hypertarget{encode-string}{%
\section{字符串加密}\label{encode-string}}

字符串编码加密， \textbf{openssl} 包提供了 sha1 函数 \footnote{参考刘思喆的两篇博文： \href{http://bjt.name/2019/09/28/secure-hash.html}{利用 R 函数生成差异化密码} 和 \href{http://bjt.name/2019/10/21/url-handle.html}{在 R 中各种码的转换}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(openssl)}
\NormalTok{encode\_mobile }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(phone\_number) }\FunctionTok{paste}\NormalTok{(}\StringTok{"*"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(}\FunctionTok{toupper}\NormalTok{(}\FunctionTok{sha1}\NormalTok{(}\FunctionTok{sha1}\NormalTok{(}\FunctionTok{charToRaw}\NormalTok{(}\FunctionTok{paste}\NormalTok{(phone\_number, }\StringTok{"$1$mobile$"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{))))), }\AttributeTok{collapse =} \StringTok{""}\NormalTok{), }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\CommentTok{\# 随意模拟两个手机号}
\NormalTok{mobile\_vec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"18601013453"}\NormalTok{, }\StringTok{"13811674545"}\NormalTok{)}
\FunctionTok{sapply}\NormalTok{(mobile\_vec, encode\_mobile)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                 18601013453 
## "*B1D46D1D62C7280137F0E14249EE500865247B7B" 
##                                 13811674545 
## "*0554DA6E403491F58F1567DF2EDEB19186B77173"
\end{verbatim}

\hypertarget{performance}{%
\section{处理性能}\label{performance}}

当你对一个很长的字符串进行大量的正则表达式匹配的时候，你需要考虑性能问题了，这时候该考虑启用合适的选项，一般来讲， PCRE 比默认的正则表达式引擎快，\texttt{fixed=TRUE} 可以继续加快匹配速度，特别是当每个模式只匹配少量次数时。

连接字符串，\texttt{paste/c/bfile/bracket} 函数性能比较 \url{https://wch.github.io/string_builder/index.html}

R 内置的默认正则表达式匹配方式是基于 PCRE 的匹配，\texttt{options} 控制 PCRE 默认的三个选项 \texttt{PCRE\_limit\_recursion=NA} 、\texttt{PCRE\_study=10} 和 \texttt{PCRE\_use\_JIT=TRUE}，当前系统环境下 PCRE 的支持情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pcre\_config}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              UTF-8 Unicode properties                JIT              stack 
##               TRUE               TRUE               TRUE              FALSE
\end{verbatim}

查看R环境的 PCRE 配置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sapply}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"PCRE\_limit\_recursion"}\NormalTok{, }\StringTok{"PCRE\_study"}\NormalTok{, }\StringTok{"PCRE\_use\_JIT"}\NormalTok{), getOption)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## PCRE_limit_recursion           PCRE_study         PCRE_use_JIT 
##                   NA                FALSE                 TRUE
\end{verbatim}

\hypertarget{web-crawler}{%
\section{网络爬虫}\label{web-crawler}}

用 R 语言写爬虫 \href{https://github.com/jeroen/curl}{curl}、\href{https://github.com/r-lib/httr}{httr}、 \href{https://github.com/r-lib/xml2}{xml2}、\href{https://CRAN.R-project.org/package=XML}{XML} 和 \href{https://github.com/tidyverse/rvest}{rvest} 解析网页\footnote{Jeroen Ooms 已经确认 RCurl 早已经不再维护，取代它的是 curl/httr，不要使用不再维护的 R 包 \url{https://frie.codes/curl-vs-rcurl/}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看 libcurl 库的版本}
\FunctionTok{libcurlVersion}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "7.68.0"
## attr(,"ssl_version")
## [1] "OpenSSL/1.1.1f"
## attr(,"libssh_version")
## [1] "libssh/0.9.3/openssl/zlib"
## attr(,"protocols")
##  [1] "dict"   "file"   "ftp"    "ftps"   "gopher" "http"   "https"  "imap"  
##  [9] "imaps"  "ldap"   "ldaps"  "pop3"   "pop3s"  "rtmp"   "rtsp"   "scp"   
## [17] "sftp"   "smb"    "smbs"   "smtp"   "smtps"  "telnet" "tftp"
\end{verbatim}

于主编利用 \href{https://github.com/RobertMyles/tidyRSS}{tidyRSS} 包 抓取解析博客站点的订阅信息，并将此设置为定时任务，创建自动更新内容的博客聚合网站 \href{https://dailyr.netlify.com/}{Daily R}

抓取地震台信息

\href{https://d.cosx.org/d/420739}{一个爬网页的练习：看看 R 邮件列表中最热门的讨论是什么}

\hypertarget{text-mining}{%
\section{文本挖掘}\label{text-mining}}

\href{https://masalmon.eu/2019/02/11/trump-schedule/}{How did Axios rectangle Trump's PDF schedule? A try with R} 使用 pdftools 和 magick 处理表格，这两个 R 包分别依赖 Poppler C++ 和 ImageMagick++，在 Ubuntu 上安装 pdftools 和 magick 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install libpoppler{-}cpp{-}dev libmagick++{-}dev}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"pdftools"}\NormalTok{, }\StringTok{"magick"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

除了 pdftools 包外，PDF 文档中表格抽取工具还有 \href{https://github.com/ropensci/tabulizer}{tabulizer}。扫描版 PDF 文档需要OCR识别技术支持的 tesseract 包

\hypertarget{string-session-info}{%
\section{运行环境}\label{string-session-info}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   askpass_1.1      assertthat_0.2.1 base64enc_0.1.3  bookdown_0.24   
##   cli_3.0.1        compiler_4.1.1   cpp11_0.4.0      crayon_1.4.1    
##   curl_4.3.2       DBI_1.1.1        digest_0.6.28    dplyr_1.0.7     
##   ellipsis_0.3.2   evaluate_0.14    fansi_0.5.0      fastmap_1.1.0   
##   generics_0.1.0   glue_1.4.2       graphics_4.1.1   grDevices_4.1.1 
##   highr_0.9        htmltools_0.5.2  jquerylib_0.1.4  jsonlite_1.7.2  
##   knitr_1.36       lifecycle_1.0.1  magrittr_2.0.1   methods_4.1.1   
##   openssl_1.4.5    pillar_1.6.3     pkgconfig_2.0.3  purrr_0.3.4     
##   R6_2.5.1         rlang_0.4.11     rmarkdown_2.11   stats_4.1.1     
##   stringi_1.7.4    stringr_1.4.0    sys_3.4          tibble_3.1.5    
##   tidyr_1.1.4      tidyselect_1.1.1 tinytex_0.34     tools_4.1.1     
##   utf8_1.2.2       utils_4.1.1      vctrs_0.3.8      xfun_0.26       
##   yaml_2.2.1
\end{verbatim}

\hypertarget{chap-regular-expressions}{%
\chapter{正则表达式}\label{chap-regular-expressions}}

\begin{quote}
Douglas Bates: If you really want to be cautious you could use an octal representation like \texttt{sep="\textbackslash{}\textbackslash{}007"} to get a character that is very unlikely to occur in a factor level.

Ed L. Cashin: I definitely want to be cautious. Instead of the bell character I think I'll use the field separator character, \texttt{"\textbackslash{}\textbackslash{}034"}, just because this is the first time I've been able to use it for it's intended purpose! ;)

Douglas Bates: Yes, but with \texttt{"\textbackslash{}\textbackslash{}034"} you don't get to make obscure James Bond references :-)

\hspace*{\fill} --- Douglas Bates and Ed L. Cashin R-help (April 2004)
\end{quote}

维基百科关于 \href{https://www.wikiwand.com/en/Regular_expression}{正则表达式的描述}， \href{https://github.com/ziishaned/learn-regex/blob/master/translations/README-cn.md}{学习正则表达式}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 毒鸡汤用来做文本分析}
\CommentTok{\# https://github.com/egotong/nows/blob/master/soul.sql}
\end{Highlighting}
\end{Shaded}

R 内置的三种匹配模式

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{fixed\ =\ TRUE}: 字面意思匹配 exact matching.
\item
  \texttt{perl\ =\ TRUE}: 使用 Perl 正则表达式.
\item
  \texttt{fixed\ =\ FALSE,\ perl\ =\ FALSE}: 使用 POSIX 1003.2 extended 正则表达式 (默认设置).
\end{enumerate}

不要拘泥于一种解决方案，比如清理数据中正则表达式有 Base R 提供的一套，stringr 又一套，提高效率的工具 RStudio 插件 \href{https://github.com/gadenbuie/regexplain}{regexplain} 和辅助创建正则表达式 \href{https://github.com/VerbalExpressions/RVerbalExpressions}{RVerbalExpressions} 包。

有几个名词需要单独拎出来解释的

\begin{itemize}
\tightlist
\item
  literal character strings 字面字符串
\item
  metacharacters 元字符
\item
  extended regular expressions 在下文中约定翻译为默认正则表达式
\item
  character class 字符集 \texttt{{[}abc{]}}
\item
  Perl-like regular expressions Perl 风格的正则表达式
\end{itemize}

以下所述，都不考虑函数中参数 \texttt{perl=TRUE} 的情况，R 语言中提供了扩展的（默认的）和 Perl 风格 的两套正则表达式。作为入门，我们这里只关注前者，启用 Perl 正则表达式只需在函数如 \texttt{grep} 中将选项 \texttt{perl\ =\ TRUE} 即可，并将后者统一命名为 Perl 正则表达式\footnote{推荐的学习正则表达式的路径可以见统计之都论坛 \url{https://d.cosx.org/d/420410}}。

正则表达式 (\textbf{reg}ular \textbf{exp}ression，简称 regexp)， 函数 \texttt{regexpr} 和 \texttt{gregexpr} 的名称就好理解了，在控制台输入 \texttt{?regex} 查看 R 支持的正则表达式，这个文档看上百八十回也不过分。R 内支持正则表达式的函数有 \texttt{grep}、\texttt{grepl}、\texttt{sub}、\texttt{gsub}、\texttt{regexpr}、\texttt{gregexpr} 、 \texttt{regexec} 和 \texttt{strsplit}。函数 \texttt{apropos}，\texttt{browseEnv}，\texttt{help.search}，\texttt{list.files} 和 \texttt{ls} 是通过函数 \texttt{grep} 来使用正则表达式的，它们全都使用 extended regular expressions

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(pattern, x, }\AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{value =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{invert =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

匹配模式 pattern 的内容 可以用函数 \texttt{cat} 打印出来，注意反斜杠进入 R 字符串中时，需要用两个，反斜杠 \texttt{\textbackslash{}} 本身是转义符，否则会报错。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{) }\CommentTok{\# \textbackslash{} 反斜杠是转义字符}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## \
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## \.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}n}\StringTok{"}\NormalTok{) }\CommentTok{\# 注意 \textbackslash{}n 表示换行}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## \
\end{verbatim}

\hypertarget{character-constants}{%
\section{字符常量}\label{character-constants}}

单引号 \texttt{\textquotesingle{}} 双引号 \texttt{"} 和反引号 ` 三种类型的引用 (quotes) 是 R 语法的一部分\footnote{\url{https://stat.ethz.ch/R-manual/R-devel/library/base/html/Quotes.html}}，此外反斜杠 \texttt{\textbackslash{}} 用来转义下面的字符

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:character-constants} 字符常量表}\tabularnewline
\toprule
字符常量 & 含义 \\
\midrule
\endfirsthead
\toprule
字符常量 & 含义 \\
\midrule
\endhead
\texttt{\textbackslash{}n} & 换行 newline \\
\texttt{\textbackslash{}r} & 回车 carriage return \\
\texttt{\textbackslash{}t} & 制表符 tab \\
\texttt{\textbackslash{}b} & 退格 backspace \\
\texttt{\textbackslash{}a} & 警报（铃）alert (bell) \\
\texttt{\textbackslash{}f} & 换页 form feed \\
\texttt{\textbackslash{}v} & 垂直制表符 vertical tab \\
\texttt{\textbackslash{}\textbackslash{}} & 反斜杠 backslash \texttt{\textbackslash{}} \\
\texttt{\textbackslash{}\textquotesingle{}} & 单引号 ASCII apostrophe \texttt{\textquotesingle{}} \\
\texttt{\textbackslash{}"} & 双引号 ASCII quotation mark \texttt{"} \\
\texttt{\textbackslash{}\textasciigrave{}} & 反引号或沉音符 ASCII grave accent (backtick) ` \\
\texttt{\textbackslash{}nnn} & 八进制 character with given octal code (1, 2 or 3 digits) \\
\texttt{\textbackslash{}xnn} & 十六进制 character with given hex code (1 or 2 hex digits) \\
\texttt{\textbackslash{}unnnn} & Unicode character with given code (1--4 hex digits) \\
\texttt{\textbackslash{}Unnnnnnnn} & Unicode character with given code (1--8 hex digits) \\
\bottomrule
\end{longtable}

\hypertarget{environments}{%
\section{软件环境}\label{environments}}

R 内置的正则表达式实现是基于 PCRE ICU TRE iconv 等第三方库，搞清楚自己使用的版本信息是重要的，一些字符集的解释与区域环境有关，如 \texttt{{[}:alnum:{]}} 和 \texttt{{[}:alpha:{]}}等，所以获取当前的区域设置也很重要

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# find a suitable coding for the current locale}
\FunctionTok{localeToCharset}\NormalTok{(}\AttributeTok{locale =} \FunctionTok{Sys.getlocale}\NormalTok{(}\StringTok{"LC\_CTYPE"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "UTF-8"     "ISO8859-1"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 软件版本信息}
\FunctionTok{extSoftVersion}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                              zlib 
##                                          "1.2.11" 
##                                             bzlib 
##                              "1.0.8, 13-Jul-2019" 
##                                                xz 
##                                           "5.2.4" 
##                                              PCRE 
##                                "10.34 2019-11-21" 
##                                               ICU 
##                                            "66.1" 
##                                               TRE 
##                         "TRE 0.8.0 R_fixes (BSD)" 
##                                             iconv 
##                                      "glibc 2.31" 
##                                          readline 
##                                             "8.0" 
##                                              BLAS 
## "/usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 区域及其编码信息}
\FunctionTok{l10n\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $MBCS
## [1] TRUE
## 
## $`UTF-8`
## [1] TRUE
## 
## $`Latin-1`
## [1] FALSE
## 
## $codeset
## [1] "UTF-8"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 表示数字、货币的细节}
\FunctionTok{Sys.localeconv}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     decimal_point     thousands_sep          grouping   int_curr_symbol 
##               "."                ""                ""            "USD " 
##   currency_symbol mon_decimal_point mon_thousands_sep      mon_grouping 
##               "$"               "."               ","        "\003\003" 
##     positive_sign     negative_sign   int_frac_digits       frac_digits 
##                ""               "-"               "2"               "2" 
##     p_cs_precedes    p_sep_by_space     n_cs_precedes    n_sep_by_space 
##               "1"               "0"               "1"               "0" 
##       p_sign_posn       n_sign_posn 
##               "1"               "1"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# PCRE 启用的配置选项}
\FunctionTok{pcre\_config}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              UTF-8 Unicode properties                JIT              stack 
##               TRUE               TRUE               TRUE              FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 比较全的字符信息}
\NormalTok{stringi}\SpecialCharTok{::}\FunctionTok{stri\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $Unicode.version
## [1] "13.0"
## 
## $ICU.version
## [1] "66.1"
## 
## $Locale
## $Locale$Language
## [1] "en"
## 
## $Locale$Country
## [1] "US"
## 
## $Locale$Variant
## [1] ""
## 
## $Locale$Name
## [1] "en_US"
## 
## 
## $Charset.internal
## [1] "UTF-8"  "UTF-16"
## 
## $Charset.native
## $Charset.native$Name.friendly
## [1] "UTF-8"
## 
## $Charset.native$Name.ICU
## [1] "UTF-8"
## 
## $Charset.native$Name.UTR22
## [1] NA
## 
## $Charset.native$Name.IBM
## [1] "ibm-1208"
## 
## $Charset.native$Name.WINDOWS
## [1] "windows-65001"
## 
## $Charset.native$Name.JAVA
## [1] "UTF-8"
## 
## $Charset.native$Name.IANA
## [1] "UTF-8"
## 
## $Charset.native$Name.MIME
## [1] "UTF-8"
## 
## $Charset.native$ASCII.subset
## [1] TRUE
## 
## $Charset.native$Unicode.1to1
## [1] NA
## 
## $Charset.native$CharSize.8bit
## [1] FALSE
## 
## $Charset.native$CharSize.min
## [1] 1
## 
## $Charset.native$CharSize.max
## [1] 3
## 
## 
## $ICU.system
## [1] TRUE
## 
## $ICU.UTF8
## [1] TRUE
\end{verbatim}

需要临时改变区域环境设置，配合特殊的画图和文本输出要求。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 获取当前默认的区域设置}
\FunctionTok{Sys.getlocale}\NormalTok{()}
\NormalTok{foo }\OtherTok{\textless{}{-}} \FunctionTok{Sys.getlocale}\NormalTok{()}
\CommentTok{\# 恢复默认的区域设置}
\FunctionTok{Sys.setlocale}\NormalTok{(}\StringTok{"LC\_ALL"}\NormalTok{, }\AttributeTok{locale =}\NormalTok{ foo)}
\end{Highlighting}
\end{Shaded}

\hypertarget{foundations}{%
\section{基本概念}\label{foundations}}

正则表达式的构造方式类似算术表达式，通过各种操作组合子（更小的）表达式，整个表达式匹配一个或多个字符\footnote{\texttt{useBytes\ =\ TRUE} 表示把字符看作字节。字符、字节和比特的关系是，一个字节 byte 八个比特 bit，一个英文字符 character 用一个字节表示，而一个中、日、韩文字符需要两个字节表示}。大多数字符，包括所有的字母和数字，是匹配自身的正则表达式。元字符 \texttt{.\ \textbackslash{}\ \textbar{}\ (\ )\ {[}\ \{\ \^{}\ \$\ *\ +\ ?} 需要转义才能表达其自身的含义，转义的方式是在元字符前面添加反斜杠，如要表达点号 \texttt{.} 需要使用 \texttt{\textbackslash{}.}。要注意，它们是否有特殊意义取决于所在的内容。

一个字符集 (character class) 是用一对中括号\texttt{{[}{]}}括起来的字符列表，用来匹配列表中的任意单个字符，除非列表中的第一个字符是 \texttt{\^{}}，它用来匹配不在这个列表中的字符。 \texttt{{[}0123456789{]}} 用来匹配任意单个数字，\texttt{{[}\^{}abc{]}} 用来匹配除字符 \texttt{a,b,c} 以外的任意字符。字符范围 (character ranges) 可以通过第一个和最后一个字符指定， 中间用连字符 (hyphen) 连接， 由于这种解释依赖于区域和具体实现，所以指定字符范围的使用方式最好避免。唯一可移植（便携，通用）的方式是作为字符集，在列表中列出所有的 ASCII 字母， \texttt{{[}ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz{]}}.

预定义的一些字符类，它们的解释依赖于当前的语言区域，下面是 POSIX locale 环境下的解释

\begin{itemize}
\item
  \texttt{{[}:alnum:{]}} 表示 \texttt{{[}:alpha:{]}} 和 \texttt{{[}:digit:{]}}，含义是 \texttt{{[}0-9A-Za-z{]}}，但是前者与区域和字符集无关，后者依赖于当前的区域设置和字符编码。要注意在这些字符集名 class names 中，中括号 \texttt{{[}{]}} 是符号名的一部分，是必须要包含的。在字符集中，大多数元字符失去它们特殊的意义。
\item
  \texttt{{[}:alpha:{]}} 表示 \texttt{{[}:lower:{]}} 和 \texttt{{[}:upper:{]}}
\item
  \texttt{{[}:blank:{]}} 表示 空格 space 制表符 tab
\item
  \texttt{{[}:cntrl:{]}} 表示控制符，在 ASCII 字符集里里，这些字符有八进制代码，从 000 到 037，和 177(DEL)。
\item
  \texttt{{[}:digit:{]}} 表示数字 0,1,2,3,4,5,6,7,8,9
\item
  \texttt{{[}:graph:{]}} 表示 \texttt{{[}:alnum:{]}} 和 \texttt{{[}:punct:{]}}.
\item
  \texttt{{[}:lower:{]}} 表示当前区域下的小写字母
\item
  \texttt{{[}:print:{]}} 表示可打印的字符 \texttt{{[}:alnum:{]}}, \texttt{{[}:punct:{]}} 和空格.
\item
  \texttt{{[}:punct:{]}} 表示标点字符

\begin{verbatim}
! " # $ % & ' ( ) * + , - . / : ; < = > ? @ [ \ ] ^ _ ` { | } ~`
\end{verbatim}
\item
  \texttt{{[}:space:{]}} 表示空格字符： 水平制表符 tab， 换行符 newline，垂直制表符 vertical tab，换页符 form feed，回车符 carriage return，空格符 space
\item
  \texttt{{[}:xdigit:{]}} 表示 16 进制数字 0 1 2 3 4 5 6 7 8 9 A B C D E F a b c d e f.
\end{itemize}

要包含字面的 \texttt{{]}} 就把它放在列表的开头，类似地，要包含字面 \texttt{\^{}}，除了开头可以放在任意位置。要包含字面 \texttt{-} 把它放在开头或者结尾。只有 \texttt{\^{}\ -\ \textbackslash{}\ {]}} 在字符集内是有特殊的含义

点号 \texttt{.} 匹配任意单个字符，\texttt{\textbackslash{}w} 匹配一个词 word 字符(是\texttt{{[}{[}:alnum:{]}\_{]}}的同义词，一个扩展) ，而 \texttt{\textbackslash{}W} 是 \texttt{\textbackslash{}w} 取反，意味着 \texttt{{[}\^{}{[}:alnum:{]}\_{]}}。 \texttt{\textbackslash{}d}, \texttt{\textbackslash{}s}, \texttt{\textbackslash{}D} 和 \texttt{\textbackslash{}S} 表示数字和空格类和它们的取反

脱字符 caret \texttt{\^{}} 和美元符号 \texttt{\$} 是元字符，分别匹配一行的开头和结尾。符号 \texttt{\textbackslash{}\textless{}} 和 \texttt{\textbackslash{}\textgreater{}} 分别匹配一个词的开头和结尾的空字符串。\texttt{\textbackslash{}b} 匹配词边缘的空字符串，\texttt{\textbackslash{}B} 匹配不在词边缘的空字符串。 词 word 的解释依赖于区域和实现。

\hypertarget{match}{%
\section{字符串匹配}\label{match}}

默认的匹配方式是贪婪的，会使用尽可能多的匹配次数，这个可以变为最小的匹配次数，通过在其之后添加 \texttt{?}，一个正则表达式可能跟着重复量词，下面的限定符都是限定在它前面的正则表达式

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:repetition-quantifiers} 贪婪匹配限定符}\tabularnewline
\toprule
符号 & 描述 \\
\midrule
\endfirsthead
\toprule
符号 & 描述 \\
\midrule
\endhead
\texttt{?} & 匹配至多 1 次 \\
\texttt{*} & 匹配 0 次或多次 \\
\texttt{+} & 匹配至少 1 次 \\
\texttt{\{n\}} & 匹配 n 次 \\
\texttt{\{n,\}} & 匹配至少 n 次 \\
\texttt{\{n,m\}} & 匹配至少 n 次，至多 m 次 \\
\bottomrule
\end{longtable}

\hypertarget{concatenation}{%
\section{级联表达式}\label{concatenation}}

\begin{quote}
Regular expressions may be concatenated; the resulting regular expression matches any string formed by concatenating the substrings that match the concatenated subexpressions.
\end{quote}

正则表达式可以是级联 concatenation 的，是不是在讲一个正则表达式里面嵌套一个正则表达式？

两个正则表达式可以通过中缀符号 \texttt{\textbar{}} 联合，用两个子表达式的任意一个去匹配字符串，例如 \texttt{abba\ \textbar{}\ cde} 要么匹配字符串 \texttt{abba} 要么匹配字符串 \texttt{cde}，要注意在字符集内，即 \texttt{abba\textbar{}cde}，二选一的匹配不凑效，因为中缀符 \texttt{\textbar{}} 有它的字面意思。

重复匹配 Repetition 的优先级高于级联，级联高于 \texttt{\textbar{}} 。 整个子表达式可以括号括起来覆盖这些优先级规则。

\hypertarget{backreference}{%
\section{反向引用}\label{backreference}}

反向引用 \texttt{\textbackslash{}N} 这里 N 可取 1,2,\ldots,9 匹配被之前第 N 个括起来的子表达式匹配的子字符串，例子见 COS 论坛 \url{https://d.cosx.org/d/420570/5}

\hypertarget{regexp-named-capture}{%
\section{命名捕捉}\label{regexp-named-capture}}

模式 \texttt{(?:...)} 包住的字符就是括号分组，但是不做反向查找。模式 \texttt{(?\textless{}=...)} 和 \texttt{(?\textless{}!...)} 都是反向查找，它们不允许跟限制符，在 \texttt{...} 也不允许出现 \texttt{\textbackslash{}C}。表 \ref{tab:group-lookaround} 展示四个反向引用

\begin{longtable}[]{@{}cc@{}}
\caption{\label{tab:group-lookaround} 环顾四周查找}\tabularnewline
\toprule
符号 & 描述 \\
\midrule
\endfirsthead
\toprule
符号 & 描述 \\
\midrule
\endhead
\texttt{?=} & 正向肯定查找 \\
\texttt{?!} & 正向否定查找 \\
\texttt{?\textless{}=} & 反向肯定查找 \\
\texttt{?\textless{}!} & 反向否定查找 \\
\bottomrule
\end{longtable}

函数 \texttt{regexpr} 和 \texttt{gregexpr} 支持命名捕捉 (named capture). 如果一个组被命名了，如 \texttt{(?\textless{}first\textgreater{}{[}A-Z{]}{[}a-z{]}+)} 那么，匹配的位置是按名字返回。

下面举个例子说明，从字符串向量 \texttt{notables} 中获得了三组匹配 \texttt{name.rex} 是一段正则表达式，描述的模式是人名

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# named capture}
\NormalTok{notables }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"  Ben Franklin and Jefferson Davis"}\NormalTok{,}
              \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{Millard Fillmore"}\NormalTok{)}
\CommentTok{\# name groups \textquotesingle{}first\textquotesingle{} and \textquotesingle{}last\textquotesingle{}}
\NormalTok{name.rex }\OtherTok{\textless{}{-}} \StringTok{"(?\textless{}first\textgreater{}[[:upper:]][[:lower:]]+) (?\textless{}last\textgreater{}[[:upper:]][[:lower:]]+)"}
\NormalTok{parsed }\OtherTok{\textless{}{-}} \FunctionTok{regexpr}\NormalTok{(name.rex, notables, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{parsed}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3 2
## attr(,"match.length")
## [1] 12 16
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## attr(,"capture.start")
##      first last
## [1,]     3    7
## [2,]     2   10
## attr(,"capture.length")
##      first last
## [1,]     3    8
## [2,]     7    8
## attr(,"capture.names")
## [1] "first" "last"
\end{verbatim}

\texttt{notables} 是一个长度为2的字符串向量，所以获得两组匹配，捕捉到匹配开始的位置 \texttt{capture.start} 和匹配的长度 \texttt{capture.length} 都是两组，按列来看，字符 B 出现在字符串 \texttt{Ben\ Franklin\ and\ Jefferson\ Davis} 的第三个位置，匹配的长度 Ben 是三个字符，长度是 3，如图 \ref{fig:name-capture} 所示，需要注意的是一定要设置 \texttt{perl\ =\ TRUE} 才能使用命名捕捉功能，函数 \texttt{sub} 不支持命名反向引用 Named backreferences

\begin{figure}

{\centering \includegraphics[width=4.51in]{screenshots/regexp-name-capture} 

}

\caption{命名捕捉}\label{fig:name-capture}
\end{figure}

Atomic grouping 原子分组, possessive qualifiers 占有限定 and conditional 条件 and recursive 递归等模式超出介绍的范围，不在此处详述，感兴趣的读者可参考，此外，插播一条漫画 \ref{fig:regex-xkcd}

\begin{figure}

{\centering \href{https://imgs.xkcd.com/comics/regular_expressions.png}{\includegraphics[width=2in]{screenshots/regexp-comics} }

}

\caption{正则表达式漫画}\label{fig:regex-xkcd}
\end{figure}

正则表达式的直观解释 \url{https://github.com/gadenbuie/regexplain}

\hypertarget{comment}{%
\section{表达式注释}\label{comment}}

The sequence \texttt{(?\#} marks the start of a comment which continues up to the next closing parenthesis. Nested parentheses are not permitted. The characters that make up a comment play no part at all in the pattern matching.

If the extended option is set, an unescaped \texttt{\#} character outside a character class introduces a comment that continues up to the next newline character in the pattern.

批量转换驼峰式命名

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{old\_name }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}[A{-}Z].*.Rmd$"}\NormalTok{)}
\NormalTok{new\_name }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"rmd"}\NormalTok{, }\StringTok{"Rmd"}\NormalTok{, }\FunctionTok{tolower}\NormalTok{(old\_name))}
\FunctionTok{file.rename}\NormalTok{(}\AttributeTok{from =}\NormalTok{ old\_name, }\AttributeTok{to =}\NormalTok{ new\_name)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{html\_lines }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(}\StringTok{"https://movie.douban.com/top250"}\NormalTok{)}
\NormalTok{doc }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(html\_lines, }\AttributeTok{collapse =} \StringTok{""}\NormalTok{)}

\NormalTok{title\_lines }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{\textquotesingle{}class="title"\textquotesingle{}}\NormalTok{, html\_lines, }\AttributeTok{value =}\NormalTok{ T)}
\NormalTok{titles }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{".*\textgreater{}(.*?)\textless{}.*"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, title\_lines, }\AttributeTok{perl =}\NormalTok{ T)}

\FunctionTok{gsub}\NormalTok{(}\StringTok{".*\textgreater{}(.*?)\textless{}.*"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, }\StringTok{\textquotesingle{}\textless{}span class="title"\textgreater{}肖生克的救赎\textless{}/span\textgreater{}\textquotesingle{}}\NormalTok{, }\AttributeTok{perl =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

解析术之 XPath

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(xml2)}
\NormalTok{dom }\OtherTok{=} \FunctionTok{read\_html}\NormalTok{(doc)}
\NormalTok{title\_nodes }\OtherTok{=} \FunctionTok{xml\_find\_all}\NormalTok{(dom, }\StringTok{\textquotesingle{}.//span[@class="title"]\textquotesingle{}}\NormalTok{)}
\FunctionTok{xml\_text}\NormalTok{(title\_nodes)}
\end{Highlighting}
\end{Shaded}

解析术之 CSS Selector

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rvest)}
\FunctionTok{read\_html}\NormalTok{(doc) }\SpecialCharTok{\%\textgreater{}\%}
\FunctionTok{html\_nodes}\NormalTok{(}\StringTok{\textquotesingle{}.title\textquotesingle{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# class="title"的标签}
\FunctionTok{html\_text}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{chap-data-manipulation}{%
\chapter{数据操作}\label{chap-data-manipulation}}

data.table 诞生于2006年4月15日（以在 CRAN 上发布的第一个版本时间为准），是基于 \texttt{data.frame} 的扩展和 Base R 的数据操作连贯一些，dplyr 诞生于2014年1月29日，号称数据操作的语法，其实二者套路一致，都是借用 SQL 语言的设计，实现方式不同罢了，前者主要依靠 C 语言完成底层数据操作，总代码量1.29M，C 占65.6\%，后者主要依靠 C++ 语言完成底层数据操作，总代码量1.2M，C++ 占34.4\%，上层的高级操作接口都是 R 语言。像这样的大神在写代码，码力应该差不多，编程语言会对数据操作的性能有比较大的影响，我想这也是为什么在很多场合下 data.table 霸榜！

关于 data.table 和 dplyr 的对比，参看爆栈网的帖子 \url{https://stackoverflow.com/questions/21435339}

\begin{rmdtip}{提示}
学习 data.table 包最快的方式就是在 R 控制台运行 \texttt{example(data.table)} 并研究其输出。

\end{rmdtip}

\href{https://github.com/Rdatatable/data.table}{data.table} 大大加强了 \href{https://github.com/wch/r-source}{Base R} 提供的数据操作，\href{https://github.com/nathaneastwood/poorman}{poorman} 提供最常用的数据操作，但是不依赖 dplyr，\href{https://github.com/fstpackage/fst}{fst}，\href{https://github.com/apache/arrow/tree/master/r}{arrow} 和 \href{https://github.com/wesm/feather/tree/master/R}{feather} 提供更加高效的数据读写性能。

\href{https://github.com/SebKrantz/collapse}{collapse} 提供一系列高级和快速的数据操作，支持 Base R、dplyr、tibble、data.table、plm 和 sf 数据框结构类型。关键的特点有：1. 高级的统计编程，提供一系列统计函数支持在向量、矩阵和数据框上做分组和带权计算。\href{https://github.com/SebKrantz/fastverse}{fastverse} 提供丰富的数据操作和统计计算功能，意图打造一个 tidyverse 替代品。

更多参考材料见\href{https://atrebas.github.io/post/2019-03-03-datatable-dplyr/}{A data.table and dplyr tour}， \href{https://raw.githack.com/uo-ec510-2020-spring/lectures/master/05-datatable/05-datatable.html}{Big Data in Economics: Data cleaning and wrangling} 和 \href{https://s3.amazonaws.com/assets.datacamp.com/img/blog/data+table+cheat+sheet.pdf}{DataCamp's data.table cheatsheet}，关于采用 Base R 还是 tidyverse 做数据操作的 \href{https://d.cosx.org/d/420697}{讨论}，数据操作的动画展示参考 \url{https://github.com/gadenbuie/tidyexplain}。

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{diagrams/tidyverse-vs-base-r} 

}

\caption{Tidyverse 和 Base R 的关系}\label{fig:tidyverse-vs-base-r}
\end{figure}

什么是 Base R? Base R 指的是 R 语言/软件的核心组件，由 R Core Team 维护

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Pkgs }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(}\StringTok{"library"}\NormalTok{)), }\ControlFlowTok{function}\NormalTok{(x)}
  \FunctionTok{packageDescription}\NormalTok{(}\AttributeTok{pkg =}\NormalTok{ x, }\AttributeTok{fields =} \StringTok{"Priority"}\NormalTok{))}
\FunctionTok{names}\NormalTok{(Pkgs[Pkgs }\SpecialCharTok{==} \StringTok{"base"} \SpecialCharTok{\&} \SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(Pkgs)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "base"      "compiler"  "datasets"  "graphics"  "grDevices" "grid"     
##  [7] "methods"   "parallel"  "splines"   "stats"     "stats4"    "tcltk"    
## [13] "tools"     "utils"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(Pkgs[Pkgs }\SpecialCharTok{==} \StringTok{"recommended"} \SpecialCharTok{\&} \SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(Pkgs)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "boot"       "class"      "cluster"    "codetools"  "foreign"   
##  [6] "KernSmooth" "lattice"    "MASS"       "Matrix"     "mgcv"      
## [11] "nlme"       "nnet"       "rpart"      "spatial"    "survival"
\end{verbatim}

数据变形，分组统计聚合等，用以作为模型的输入，绘图的对象，操作的数据对象是数据框(data.frame)类型的，而且如果没有特别说明，文中出现的数据集都是 Base R 内置的，第三方 R 包或者来源于网上的数据集都会加以说明。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 给定一个/些 R 包名，返回该 R 包存放的位置}
\FunctionTok{sapply}\NormalTok{(}\FunctionTok{.libPaths}\NormalTok{(), }\ControlFlowTok{function}\NormalTok{(pkg\_path) \{}
  \FunctionTok{c}\NormalTok{(}\StringTok{"survival"}\NormalTok{, }\StringTok{"ggplot2"}\NormalTok{) }\SpecialCharTok{\%in\%} \FunctionTok{.packages}\NormalTok{(T, }\AttributeTok{lib.loc =}\NormalTok{ pkg\_path)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      /home/runner/work/_temp/Library /opt/R/4.1.1/lib/R/library
## [1,]                            TRUE                       TRUE
## [2,]                            TRUE                      FALSE
\end{verbatim}

\hypertarget{dm-view}{%
\section{查看数据}\label{dm-view}}

查看属性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    150 obs. of  5 variables:
##  $ Sepal.Length: num  5.1 4.9 4.7 4.6 5 5.4 4.6 5 4.4 4.9 ...
##  $ Sepal.Width : num  3.5 3 3.2 3.1 3.6 3.9 3.4 3.4 2.9 3.1 ...
##  $ Petal.Length: num  1.4 1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.4 1.5 ...
##  $ Petal.Width : num  0.2 0.2 0.2 0.2 0.2 0.4 0.3 0.2 0.2 0.1 ...
##  $ Species     : Factor w/ 3 levels "setosa","versicolor",..: 1 1 1 1 1 1 1 1 1 1 ...
\end{verbatim}

查看部分数据集

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(iris, }\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tail}\NormalTok{(iris, }\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 146          6.7         3.0          5.2         2.3 virginica
## 147          6.3         2.5          5.0         1.9 virginica
## 148          6.5         3.0          5.2         2.0 virginica
## 149          6.2         3.4          5.4         2.3 virginica
## 150          5.9         3.0          5.1         1.8 virginica
\end{verbatim}

查看文件前（后）5行

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head} \AttributeTok{{-}n}\NormalTok{ 5 test.csv}
\FunctionTok{tail} \AttributeTok{{-}n}\NormalTok{ 5 test.csv}
\end{Highlighting}
\end{Shaded}

对象的类型，存储方式

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mode}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "list"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{typeof}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "list"
\end{verbatim}

查看对象在R环境中所占空间的大小

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{object.size}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 7256 bytes
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{object.size}\NormalTok{(letters)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 1712 bytes
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{object.size}\NormalTok{(ls)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 89880 bytes
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{object.size}\NormalTok{(library), }\AttributeTok{units =} \StringTok{"auto"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1.8 Mb"
\end{verbatim}

\hypertarget{dm-subset}{%
\section{提取子集}\label{dm-subset}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(x, subset, select, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{, ...)}
\end{Highlighting}
\end{Shaded}

参数 \texttt{subset}代表行操作，\texttt{select} 代表列操作，函数 \texttt{subset} 从数据框中提取部分数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(iris, }\AttributeTok{subset =}\NormalTok{ Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{7.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 106          7.6         3.0          6.6         2.1 virginica
## 118          7.7         3.8          6.7         2.2 virginica
## 119          7.7         2.6          6.9         2.3 virginica
## 123          7.7         2.8          6.7         2.0 virginica
## 132          7.9         3.8          6.4         2.0 virginica
## 136          7.7         3.0          6.1         2.3 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# summary(iris$Sepal.Length)  mean(iris$Sepal.Length)}
\CommentTok{\# 且的逻辑}
\CommentTok{\# subset(iris, Species == "virginica" \& Sepal.Length \textgreater{} 5.8)}
\FunctionTok{subset}\NormalTok{(iris, Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}
\NormalTok{  Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(Sepal.Length))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 102          5.8         2.7          5.1         1.9 virginica
## 115          5.8         2.8          5.1         2.4 virginica
## 143          5.8         2.7          5.1         1.9 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 在行的子集范围内}
\FunctionTok{subset}\NormalTok{(iris, Species }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"virginica"}\NormalTok{, }\StringTok{"versicolor"}\NormalTok{) }\SpecialCharTok{\&}
\NormalTok{  Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(Sepal.Length))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 68           5.8         2.7          4.1         1.0 versicolor
## 83           5.8         2.7          3.9         1.2 versicolor
## 93           5.8         2.6          4.0         1.2 versicolor
## 102          5.8         2.7          5.1         1.9  virginica
## 115          5.8         2.8          5.1         2.4  virginica
## 143          5.8         2.7          5.1         1.9  virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 在列的子集内 先选中列}
\FunctionTok{subset}\NormalTok{(iris, Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(Sepal.Length),}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Sepal.Length"}\NormalTok{, }\StringTok{"Species"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length    Species
## 15           5.8     setosa
## 68           5.8 versicolor
## 83           5.8 versicolor
## 93           5.8 versicolor
## 102          5.8  virginica
## 115          5.8  virginica
## 143          5.8  virginica
\end{verbatim}

高级操作：加入正则表达式筛选

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# sometimes requiring a logical \textquotesingle{}subset\textquotesingle{} argument is a nuisance}
\NormalTok{nm }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(state.x77)}
\NormalTok{start\_with\_M }\OtherTok{\textless{}{-}}\NormalTok{ nm }\SpecialCharTok{\%in\%} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}M"}\NormalTok{, nm, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{subset}\NormalTok{(state.x77, start\_with\_M, Illiteracy}\SpecialCharTok{:}\NormalTok{Murder)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 简化}
\FunctionTok{subset}\NormalTok{(state.x77, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}M"}\NormalTok{, }\FunctionTok{rownames}\NormalTok{(state.x77)), }\AttributeTok{select =}\NormalTok{ Illiteracy}\SpecialCharTok{:}\NormalTok{Murder)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 继续简化}
\FunctionTok{subset}\NormalTok{(state.x77, }\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}M"}\NormalTok{, }\FunctionTok{rownames}\NormalTok{(state.x77)), Illiteracy}\SpecialCharTok{:}\NormalTok{Murder)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0
\end{verbatim}

\begin{rmdnote}{注意}
警告：这是一个为了交互使用打造的便捷函数。对于编程，最好使用标准的子集函数，如 \texttt{{[}}，特别地，参数 \texttt{subset} 的非标准计算(non-standard evaluation)\footnote{Thomas Lumley (2003) Standard nonstandard evaluation rules. \url{https://developer.r-project.org/nonstandard-eval.pdf}} 可能带来意想不到的后果。

\end{rmdnote}

使用索引 \texttt{{[}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}\NormalTok{ iris}\SpecialCharTok{$}\NormalTok{Sepal.Length }\SpecialCharTok{==} \FloatTok{5.8}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 102          5.8         2.7          5.1         1.9 virginica
## 115          5.8         2.8          5.1         2.4 virginica
## 143          5.8         2.7          5.1         1.9 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}
\NormalTok{  iris}\SpecialCharTok{$}\NormalTok{Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 102          5.8         2.7          5.1         1.9 virginica
## 115          5.8         2.8          5.1         2.4 virginica
## 143          5.8         2.7          5.1         1.9 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[}
\NormalTok{  iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}
\NormalTok{    iris}\SpecialCharTok{$}\NormalTok{Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length),}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sepal.Length"}\NormalTok{, }\StringTok{"Species"}\NormalTok{)}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length   Species
## 102          5.8 virginica
## 115          5.8 virginica
## 143          5.8 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ iris}\SpecialCharTok{$}\NormalTok{Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{, }\FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris))]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 15          5.8         4.0
## 16          5.7         4.4
## 19          5.7         3.8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(iris,}
  \AttributeTok{subset =}\NormalTok{ Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{,}
  \AttributeTok{select =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 15          5.8         4.0
## 16          5.7         4.4
## 19          5.7         3.8
\end{verbatim}

选择操作是针对数据框的列（变量/特征/字段）

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{mtcars}\SpecialCharTok{$}\NormalTok{cars }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(mtcars)}
\NormalTok{mtcars\_df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, .(mpg, disp)] }\SpecialCharTok{|}\ErrorTok{\textgreater{}} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg disp
## 1: 21.0  160
## 2: 21.0  160
## 3: 22.8  108
## 4: 21.4  258
## 5: 18.7  360
## 6: 18.1  225
\end{verbatim}

\begin{rmdtip}{dplyr 版}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, disp) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg disp
## Mazda RX4         21.0  160
## Mazda RX4 Wag     21.0  160
## Datsun 710        22.8  108
## Hornet 4 Drive    21.4  258
## Hornet Sportabout 18.7  360
## Valiant           18.1  225
\end{verbatim}

\end{rmdtip}

\hypertarget{dm-reshape}{%
\section{数据重塑}\label{dm-reshape}}

重复测量数据的变形 Reshape Grouped Data，将宽格式 wide 的数据框变长格式 long的，反之也行。reshape 还支持正则表达式

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(Indometh)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   66 obs. of  3 variables:
##  $ Subject: Ord.factor w/ 6 levels "1"<"4"<"2"<"5"<..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ time   : num  0.25 0.5 0.75 1 1.25 2 3 4 5 6 ...
##  $ conc   : num  1.5 0.94 0.78 0.48 0.37 0.19 0.12 0.11 0.08 0.07 ...
##  - attr(*, "formula")=Class 'formula'  language conc ~ time | Subject
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Time since drug administration"
##   ..$ y: chr "Indomethacin concentration"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(hr)"
##   ..$ y: chr "(mcg/ml)"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(Indometh)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  Subject      time            conc       
##  1:11    Min.   :0.250   Min.   :0.0500  
##  4:11    1st Qu.:0.750   1st Qu.:0.1100  
##  2:11    Median :2.000   Median :0.3400  
##  5:11    Mean   :2.886   Mean   :0.5918  
##  6:11    3rd Qu.:5.000   3rd Qu.:0.8325  
##  3:11    Max.   :8.000   Max.   :2.7200
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 长的变宽}
\NormalTok{wide }\OtherTok{\textless{}{-}} \FunctionTok{reshape}\NormalTok{(Indometh,}
  \AttributeTok{v.names =} \StringTok{"conc"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"Subject"}\NormalTok{,}
  \AttributeTok{timevar =} \StringTok{"time"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}
\NormalTok{)}
\NormalTok{wide[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Subject conc.0.25 conc.0.5 conc.0.75 conc.1 conc.1.25
## 1        1      1.50     0.94      0.78   0.48      0.37
## 12       2      2.03     1.63      0.71   0.70      0.64
## 23       3      2.72     1.49      1.16   0.80      0.80
## 34       4      1.85     1.39      1.02   0.89      0.59
## 45       5      2.05     1.04      0.81   0.39      0.30
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 宽的变长}
\FunctionTok{reshape}\NormalTok{(wide, }\AttributeTok{direction =} \StringTok{"long"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Subject time conc
## 1.0.25       1 0.25 1.50
## 2.0.25       2 0.25 2.03
## 3.0.25       3 0.25 2.72
## 4.0.25       4 0.25 1.85
## 5.0.25       5 0.25 2.05
....
\end{verbatim}

宽的格式变成长的格式 \url{https://stackoverflow.com/questions/2185252} 或者长的格式变成宽的格式 \url{https://stackoverflow.com/questions/5890584/}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{45}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{name =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Orange"}\NormalTok{, }\StringTok{"Apple"}\NormalTok{), }\AttributeTok{each=}\DecValTok{4}\NormalTok{),}
    \AttributeTok{numbers =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{),}
    \AttributeTok{value =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{8}\NormalTok{))}
\NormalTok{dat}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     name numbers      value
## 1 Orange       1  0.3407997
## 2 Orange       2 -0.7033403
## 3 Orange       3 -0.3795377
## 4 Orange       4 -0.7460474
## 5  Apple       1 -0.8981073
## 6  Apple       2 -0.3347941
## 7  Apple       3 -0.5013782
## 8  Apple       4 -0.1745357
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(dat, }\AttributeTok{idvar =} \StringTok{"name"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"numbers"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     name    value.1    value.2    value.3    value.4
## 1 Orange  0.3407997 -0.7033403 -0.3795377 -0.7460474
## 5  Apple -0.8981073 -0.3347941 -0.5013782 -0.1745357
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# times need not be numeric}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{id =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)),}
                 \AttributeTok{visit =} \FunctionTok{I}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Before"}\NormalTok{,}\StringTok{"After"}\NormalTok{), }\DecValTok{4}\NormalTok{)),}
                 \AttributeTok{x =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{y =} \FunctionTok{runif}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   id  visit          x          y
## 1  1 Before  1.8090374 0.89106978
## 2  1  After -0.2301050 0.06920426
## 3  2 Before -1.1304182 0.94623103
## 4  2  After  0.2159889 0.74850150
## 5  3 Before  1.8090374 0.89106978
## 6  3  After -0.2301050 0.06920426
## 7  4 Before -1.1304182 0.94623103
## 8  4  After  0.2159889 0.74850150
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(df, }\AttributeTok{timevar =} \StringTok{"visit"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"id"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   id  x.Before  y.Before    x.After    y.After
## 1  1  1.809037 0.8910698 -0.2301050 0.06920426
## 3  2 -1.130418 0.9462310  0.2159889 0.74850150
## 5  3  1.809037 0.8910698 -0.2301050 0.06920426
## 7  4 -1.130418 0.9462310  0.2159889 0.74850150
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# warns that y is really varying}
\FunctionTok{reshape}\NormalTok{(df, }\AttributeTok{timevar =} \StringTok{"visit"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"id"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{v.names =} \StringTok{"x"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in reshapeWide(data, idvar = idvar, timevar = timevar, varying =
## varying, : some constant variables (y) are really varying
\end{verbatim}

\begin{verbatim}
##   id         y  x.Before    x.After
## 1  1 0.8910698  1.809037 -0.2301050
## 3  2 0.9462310 -1.130418  0.2159889
## 5  3 0.8910698  1.809037 -0.2301050
## 7  4 0.9462310 -1.130418  0.2159889
\end{verbatim}

更加复杂的例子， gambia 数据集，重塑的效果是使得个体水平的长格式变为村庄水平的宽格式

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data(gambia, package = "geoR")}
\CommentTok{\# 在线下载数据集}
\NormalTok{gambia }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}
  \AttributeTok{file =}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"http://www.leg.ufpr.br/lib/exe/fetch.php"}\NormalTok{,}
      \StringTok{"pessoais:paulojus:mbgbook:datasets:gambia.txt"}\NormalTok{,}
      \AttributeTok{sep =} \StringTok{"/"}
\NormalTok{    ), }\AttributeTok{header =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{head}\NormalTok{(gambia)}
\CommentTok{\# Building a "village{-}level" data frame}
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"x"}\NormalTok{, gambia[, }\DecValTok{1}\NormalTok{], }\StringTok{"y"}\NormalTok{, gambia[, }\DecValTok{2}\NormalTok{], }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{village }\OtherTok{\textless{}{-}}\NormalTok{ gambia[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(ind), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\DecValTok{7}\SpecialCharTok{:}\DecValTok{8}\NormalTok{)]}
\NormalTok{village}\SpecialCharTok{$}\NormalTok{prev }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(}\FunctionTok{tapply}\NormalTok{(gambia}\SpecialCharTok{$}\NormalTok{pos, ind, mean))}
\FunctionTok{head}\NormalTok{(village)}
\end{Highlighting}
\end{Shaded}

\hypertarget{dm-transform}{%
\section{数据转换}\label{dm-transform}}

transform 对数据框中的某些列做计算，取对数，将计算的结果单存一列加到数据框中

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{transform}\NormalTok{(iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, ], }\AttributeTok{scale.sl =}\NormalTok{ (}\FunctionTok{max}\NormalTok{(Sepal.Length) }\SpecialCharTok{{-}}\NormalTok{ Sepal.Length) }\SpecialCharTok{/}\NormalTok{ (}\FunctionTok{max}\NormalTok{(Sepal.Length) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(Sepal.Length)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species scale.sl
## 1          5.1         3.5          1.4         0.2  setosa    0.375
## 2          4.9         3.0          1.4         0.2  setosa    0.625
## 3          4.7         3.2          1.3         0.2  setosa    0.875
## 4          4.6         3.1          1.5         0.2  setosa    1.000
## 5          5.0         3.6          1.4         0.2  setosa    0.500
## 6          5.4         3.9          1.7         0.4  setosa    0.000
\end{verbatim}

验证一下 \texttt{scale.sl} 变量的第一个值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\FunctionTok{max}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length) }\SpecialCharTok{{-}} \FloatTok{5.1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\FunctionTok{max}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.7777778
\end{verbatim}

\begin{rmdnote}{注意}
Warning: This is a convenience function intended for use interactively. For programming it is better to use the standard subsetting arithmetic functions, and in particular the non-standard evaluation of argument \texttt{transform} can have unanticipated consequences.

\end{rmdnote}

\hypertarget{dm-order}{%
\section{按列排序}\label{dm-order}}

在数据框内，根据(order)某一列或几列对行进行排序(sort)，根据鸢尾花(iris)的类别(Species)对萼片(sepal)的长度进行排序，其余的列随之变化

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 先对花瓣的宽度排序，再对花瓣的长度排序}
\FunctionTok{head}\NormalTok{(iris[}\FunctionTok{order}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species, iris}\SpecialCharTok{$}\NormalTok{Petal.Width, iris}\SpecialCharTok{$}\NormalTok{Petal.Length), ]) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 14          4.3         3.0          1.1         0.1  setosa
## 13          4.8         3.0          1.4         0.1  setosa
## 38          4.9         3.6          1.4         0.1  setosa
## 10          4.9         3.1          1.5         0.1  setosa
## 33          5.2         4.1          1.5         0.1  setosa
## 23          4.6         3.6          1.0         0.2  setosa
\end{verbatim}

sort/ordered 排序， 默认是升序

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dd }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{b =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Hi"}\NormalTok{, }\StringTok{"Med"}\NormalTok{, }\StringTok{"Hi"}\NormalTok{, }\StringTok{"Low"}\NormalTok{),}
    \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Low"}\NormalTok{, }\StringTok{"Med"}\NormalTok{, }\StringTok{"Hi"}\NormalTok{), }\AttributeTok{ordered =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"D"}\NormalTok{, }\StringTok{"A"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{8}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{9}\NormalTok{),}
  \AttributeTok{z =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{)}
\FunctionTok{str}\NormalTok{(dd)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    4 obs. of  4 variables:
##  $ b: Ord.factor w/ 3 levels "Low"<"Med"<"Hi": 3 2 3 1
##  $ x: chr  "A" "D" "A" "C"
##  $ y: num  8 3 9 9
##  $ z: num  1 1 1 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dd[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{dd[,}\DecValTok{4}\NormalTok{], dd[,}\DecValTok{1}\NormalTok{]), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     b x y z
## 4 Low C 9 2
## 2 Med D 3 1
## 1  Hi A 8 1
## 3  Hi A 9 1
\end{verbatim}

根据变量 z

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dd[}\FunctionTok{order}\NormalTok{(dd}\SpecialCharTok{$}\NormalTok{z, dd}\SpecialCharTok{$}\NormalTok{b), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     b x y z
## 2 Med D 3 1
## 1  Hi A 8 1
## 3  Hi A 9 1
## 4 Low C 9 2
\end{verbatim}

\hypertarget{dm-split}{%
\section{数据拆分}\label{dm-split}}

数据拆分通常是按找某一个分类变量分组，分完组就是计算，计算完就把结果按照原来的分组方式合并

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Notice that assignment form is not used since a variable is being added}
\NormalTok{g }\OtherTok{\textless{}{-}}\NormalTok{ airquality}\SpecialCharTok{$}\NormalTok{Month}
\NormalTok{l }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(airquality, g) }\CommentTok{\# 分组}
\NormalTok{l }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(l, transform, }\AttributeTok{Oz.Z =} \FunctionTok{scale}\NormalTok{(Ozone)) }\CommentTok{\# 计算：按月对 Ozone 标准化}
\NormalTok{aq2 }\OtherTok{\textless{}{-}} \FunctionTok{unsplit}\NormalTok{(l, g) }\CommentTok{\# 合并}
\FunctionTok{head}\NormalTok{(aq2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day       Oz.Z
## 1    41     190  7.4   67     5   1  0.7822293
## 2    36     118  8.0   72     5   2  0.5572518
## 3    12     149 12.6   74     5   3 -0.5226399
## 4    18     313 11.5   62     5   4 -0.2526670
## 5    NA      NA 14.3   56     5   5         NA
## 6    28      NA 14.9   66     5   6  0.1972879
\end{verbatim}

tapply 自带分组的功能，按月份 Month 对 Ozone 中心标准化，其返回一个列表

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(airquality, }\FunctionTok{tapply}\NormalTok{(Ozone, Month, scale))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $`5`
##              [,1]
##  [1,]  0.78222929
##  [2,]  0.55725184
##  [3,] -0.52263993
##  [4,] -0.25266698
##  [5,]          NA
##  [6,]  0.19728792
##  [7,] -0.02768953
##  [8,] -0.20767149
....
\end{verbatim}

上面的过程等价于

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{do.call}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, }\FunctionTok{lapply}\NormalTok{(}\FunctionTok{split}\NormalTok{(airquality, airquality}\SpecialCharTok{$}\NormalTok{Month), transform, }\AttributeTok{Oz.Z =} \FunctionTok{scale}\NormalTok{(Ozone)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Ozone Solar.R Wind Temp Month Day         Oz.Z
## 5.1      41     190  7.4   67     5   1  0.782229293
## 5.2      36     118  8.0   72     5   2  0.557251841
## 5.3      12     149 12.6   74     5   3 -0.522639926
## 5.4      18     313 11.5   62     5   4 -0.252666984
## 5.5      NA      NA 14.3   56     5   5           NA
## 5.6      28      NA 14.9   66     5   6  0.197287919
## 5.7      23     299  8.6   65     5   7 -0.027689532
## 5.8      19      99 13.8   59     5   8 -0.207671494
## 5.9       8      19 20.1   61     5   9 -0.702621887
....
\end{verbatim}

由于上面对 Ozone 正态标准化，所以标准化后的 \texttt{Oz.z} 再按月分组计算方差自然每个月都是 1，而均值都是 0。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(aq2, }\FunctionTok{tapply}\NormalTok{(Oz.Z, Month, sd, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 5 6 7 8 9 
## 1 1 1 1 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(aq2, }\FunctionTok{tapply}\NormalTok{(Oz.Z, Month, mean, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             5             6             7             8             9 
## -4.240273e-17  1.052760e-16  5.841432e-17  5.898060e-17  2.571709e-17
\end{verbatim}

\begin{quote}
循着这个思路，我们可以用 tapply 实现分组计算，上面函数 \texttt{sd} 和 \texttt{mean} 完全可以用自定义的更加复杂的函数替代
\end{quote}

\texttt{cut} 函数可以将连续型变量划分为分类变量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{Z }\OtherTok{\textless{}{-}}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\FunctionTok{cut}\NormalTok{(Z, }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{6}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] (0,1]   (-1,0]  (-2,-1] (0,1]   (-2,-1] (0,1]   (-1,0]  (0,1]   (-2,-1]
## [10] (-1,0] 
## 12 Levels: (-6,-5] (-5,-4] (-4,-3] (-3,-2] (-2,-1] (-1,0] (0,1] (1,2] ... (5,6]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# labels = FALSE 返回每个数所落的区间位置}
\FunctionTok{cut}\NormalTok{(Z, }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{6}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\AttributeTok{labels =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 7 6 5 7 5 7 6 7 5 6
\end{verbatim}

我们还可以指定参数 \texttt{dig.lab} 设置分组的精度，\texttt{ordered} 将分组变量看作是有序的，\texttt{breaks} 传递单个数时，表示分组数，而不是断点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cut}\NormalTok{(Z, }\AttributeTok{breaks =} \DecValTok{3}\NormalTok{, }\AttributeTok{dig.lab =} \DecValTok{4}\NormalTok{, }\AttributeTok{ordered =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] (0.06396,0.9186]  (-0.7881,0.06396] (-1.643,-0.7881]  (0.06396,0.9186] 
##  [5] (-1.643,-0.7881]  (0.06396,0.9186]  (-0.7881,0.06396] (0.06396,0.9186] 
##  [9] (-1.643,-0.7881]  (-0.7881,0.06396]
## Levels: (-1.643,-0.7881] < (-0.7881,0.06396] < (0.06396,0.9186]
\end{verbatim}

此时，统计每组的频数，如图 \ref{fig:cut}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 条形图}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{cut}\NormalTok{(Z, }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{6}\SpecialCharTok{:}\DecValTok{6}\NormalTok{))}
\CommentTok{\# 直方图}
\FunctionTok{hist}\NormalTok{(Z, }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{6}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[条形图\label{fig:cut-1}]{\includegraphics[width=0.45\linewidth]{data-manipulation_files/figure-latex/cut-1} }\subfloat[直方图\label{fig:cut-2}]{\includegraphics[width=0.45\linewidth]{data-manipulation_files/figure-latex/cut-2} }

}

\caption{连续型变量分组统计}\label{fig:cut}
\end{figure}

在指定分组数的情况下，我们还想获取分组的断点

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{labs }\OtherTok{\textless{}{-}} \FunctionTok{levels}\NormalTok{(}\FunctionTok{cut}\NormalTok{(Z, }\DecValTok{3}\NormalTok{))}
\NormalTok{labs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "(-1.64,-0.788]" "(-0.788,0.064]" "(0.064,0.919]"
\end{verbatim}

用正则表达式抽取断点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cbind}\NormalTok{(}
  \AttributeTok{lower =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{((.+),.*"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, labs)),}
  \AttributeTok{upper =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{sub}\NormalTok{(}\StringTok{"[\^{},]*,([\^{}]]*)}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, labs))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       lower  upper
## [1,] -1.640 -0.788
## [2,] -0.788  0.064
## [3,]  0.064  0.919
\end{verbatim}

更多相关函数可以参考 \texttt{findInterval} 和 \texttt{embed}

tabulate 和 table 有所不同，它表示排列，由 0 和 1 组成的一个长度为 5 数组，其中 1 有 3 个，则排列组合为

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{combn}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{, tabulate, }\AttributeTok{nbins =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,]    1    1    1    1    1    1    0    0    0     0
## [2,]    1    1    1    0    0    0    1    1    1     0
## [3,]    1    0    0    1    1    0    1    1    0     1
## [4,]    0    1    0    1    0    1    1    0    1     1
## [5,]    0    0    1    0    1    1    0    1    1     1
\end{verbatim}

\hypertarget{dm-merge}{%
\section{数据合并}\label{dm-merge}}

merge 合并两个数据框

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{authors }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \DocumentationTok{\#\# I(*) : use character columns of names to get sensible sort order}
  \AttributeTok{surname =} \FunctionTok{I}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Tukey"}\NormalTok{, }\StringTok{"Venables"}\NormalTok{, }\StringTok{"Tierney"}\NormalTok{, }\StringTok{"Ripley"}\NormalTok{, }\StringTok{"McNeil"}\NormalTok{)),}
  \AttributeTok{nationality =} \FunctionTok{c}\NormalTok{(}\StringTok{"US"}\NormalTok{, }\StringTok{"Australia"}\NormalTok{, }\StringTok{"US"}\NormalTok{, }\StringTok{"UK"}\NormalTok{, }\StringTok{"Australia"}\NormalTok{),}
  \AttributeTok{deceased =} \FunctionTok{c}\NormalTok{(}\StringTok{"yes"}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\StringTok{"no"}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\NormalTok{)}
\NormalTok{authorN }\OtherTok{\textless{}{-}} \FunctionTok{within}\NormalTok{(authors, \{}
\NormalTok{  name }\OtherTok{\textless{}{-}}\NormalTok{ surname}
  \FunctionTok{rm}\NormalTok{(surname)}
\NormalTok{\})}
\NormalTok{books }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{name =} \FunctionTok{I}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \StringTok{"Tukey"}\NormalTok{, }\StringTok{"Venables"}\NormalTok{, }\StringTok{"Tierney"}\NormalTok{,}
    \StringTok{"Ripley"}\NormalTok{, }\StringTok{"Ripley"}\NormalTok{, }\StringTok{"McNeil"}\NormalTok{, }\StringTok{"R Core"}
\NormalTok{  )),}
  \AttributeTok{title =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Exploratory Data Analysis"}\NormalTok{,}
    \StringTok{"Modern Applied Statistics ..."}\NormalTok{,}
    \StringTok{"LISP{-}STAT"}\NormalTok{,}
    \StringTok{"Spatial Statistics"}\NormalTok{, }\StringTok{"Stochastic Simulation"}\NormalTok{,}
    \StringTok{"Interactive Data Analysis"}\NormalTok{,}
    \StringTok{"An Introduction to R"}
\NormalTok{  ),}
  \AttributeTok{other.author =} \FunctionTok{c}\NormalTok{(}
    \ConstantTok{NA}\NormalTok{, }\StringTok{"Ripley"}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{,}
    \StringTok{"Venables \& Smith"}
\NormalTok{  )}
\NormalTok{)}

\NormalTok{authors}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    surname nationality deceased
## 1    Tukey          US      yes
## 2 Venables   Australia       no
## 3  Tierney          US       no
## 4   Ripley          UK       no
## 5   McNeil   Australia       no
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{authorN}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   nationality deceased     name
## 1          US      yes    Tukey
## 2   Australia       no Venables
## 3          US       no  Tierney
## 4          UK       no   Ripley
## 5   Australia       no   McNeil
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{books}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       name                         title     other.author
## 1    Tukey     Exploratory Data Analysis             <NA>
## 2 Venables Modern Applied Statistics ...           Ripley
## 3  Tierney                     LISP-STAT             <NA>
## 4   Ripley            Spatial Statistics             <NA>
## 5   Ripley         Stochastic Simulation             <NA>
## 6   McNeil     Interactive Data Analysis             <NA>
## 7   R Core          An Introduction to R Venables & Smith
\end{verbatim}

默认找到同名的列，然后是同名的行合并，多余的没有匹配到的就丢掉

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(authorN, books)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       name nationality deceased                         title other.author
## 1   McNeil   Australia       no     Interactive Data Analysis         <NA>
## 2   Ripley          UK       no            Spatial Statistics         <NA>
## 3   Ripley          UK       no         Stochastic Simulation         <NA>
## 4  Tierney          US       no                     LISP-STAT         <NA>
## 5    Tukey          US      yes     Exploratory Data Analysis         <NA>
## 6 Venables   Australia       no Modern Applied Statistics ...       Ripley
\end{verbatim}

还可以指定合并的列，先按照 surname 合并，留下 surname

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(authors, books, }\AttributeTok{by.x =} \StringTok{"surname"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"name"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    surname nationality deceased                         title other.author
## 1   McNeil   Australia       no     Interactive Data Analysis         <NA>
## 2   Ripley          UK       no            Spatial Statistics         <NA>
## 3   Ripley          UK       no         Stochastic Simulation         <NA>
## 4  Tierney          US       no                     LISP-STAT         <NA>
## 5    Tukey          US      yes     Exploratory Data Analysis         <NA>
## 6 Venables   Australia       no Modern Applied Statistics ...       Ripley
\end{verbatim}

留下的是 name

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(books, authors, }\AttributeTok{by.x =} \StringTok{"name"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"surname"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       name                         title other.author nationality deceased
## 1   McNeil     Interactive Data Analysis         <NA>   Australia       no
## 2   Ripley            Spatial Statistics         <NA>          UK       no
## 3   Ripley         Stochastic Simulation         <NA>          UK       no
## 4  Tierney                     LISP-STAT         <NA>          US       no
## 5    Tukey     Exploratory Data Analysis         <NA>          US      yes
## 6 Venables Modern Applied Statistics ...       Ripley   Australia       no
\end{verbatim}

为了比较清楚地观察几种合并的区别，这里提供对应的动画展示 \url{https://github.com/gadenbuie/tidyexplain}

(inner, outer, left, right, cross) join 共5种合并方式详情请看 \url{https://stackoverflow.com/questions/1299871}

cbind 和 rbind 分别是按列和行合并数据框

\hypertarget{dm-duplicated}{%
\section{数据去重}\label{dm-duplicated}}

单个数值型向量去重，此时和 unique 函数作用一样

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{9}\SpecialCharTok{:}\DecValTok{20}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{3}\SpecialCharTok{:}\DecValTok{7}\NormalTok{, }\DecValTok{0}\SpecialCharTok{:}\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  3  4  5  6  7  0  1  2
## [26]  3  4  5  6  7  8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# extract unique elements}
\NormalTok{x[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(x)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  6  7  0  8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unique}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  6  7  0  8
\end{verbatim}

数据框类型数据中，去除重复的行，这个重复可以是多个变量对应的向量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{y =} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{z =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}
\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y  z
## 1  0 0  1
## 2  0 1  2
## 3  1 0  3
## 4  0 0  4
## 5  0 1  5
## 6  0 1  6
## 7  1 0  7
## 8  0 1  8
## 9  0 0  9
## 10 1 0 10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(df[, }\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{)]), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   x y z
## 1 0 0 1
## 2 0 1 2
## 3 1 0 3
\end{verbatim}

\begin{rmdtip}{提示}

去掉字段 cyl 和 gear 有重复的记录，data.table 方式

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(mtcars\_df, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{))][,.(mpg, cyl, gear)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl gear
## 1: 21.0   6    4
## 2: 22.8   4    4
## 3: 21.4   6    3
## 4: 18.7   8    3
## 5: 21.5   4    3
## 6: 26.0   4    5
## 7: 15.8   8    5
## 8: 19.7   6    5
\end{verbatim}

dplyr 方式

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(cyl, gear, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, cyl, gear)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg cyl gear
## Mazda RX4         21.0   6    4
## Datsun 710        22.8   4    4
## Hornet 4 Drive    21.4   6    3
## Hornet Sportabout 18.7   8    3
## Toyota Corona     21.5   4    3
## Porsche 914-2     26.0   4    5
## Ford Pantera L    15.8   8    5
## Ferrari Dino      19.7   6    5
\end{verbatim}

dplyr 的去重操作不需要拷贝一个新的数据对象 mtcars\_df，并且可以以管道的方式将后续的选择操作连接起来，代码更加具有可读性。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(mtcars\_df[, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)]), }\FunctionTok{c}\NormalTok{(}\StringTok{"mpg"}\NormalTok{,}\StringTok{"cyl"}\NormalTok{,}\StringTok{"gear"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl gear
## 1: 21.0   6    4
## 2: 22.8   4    4
## 3: 21.4   6    3
## 4: 18.7   8    3
## 5: 21.5   4    3
## 6: 26.0   4    5
## 7: 15.8   8    5
## 8: 19.7   6    5
\end{verbatim}

Base R 和 data.table 提供的 \texttt{duplicated()} 函数和 \texttt{{[}} 函数一起实现去重的操作，选择操作放在 \texttt{{[}} 实现，\texttt{{[}} 其实是一个函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{2}\SpecialCharTok{:}\DecValTok{4}
\NormalTok{x[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\StringTok{\textasciigrave{}}\AttributeTok{[}\StringTok{\textasciigrave{}}\NormalTok{(x, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\end{rmdtip}

\hypertarget{dm-missing}{%
\section{数据缺失}\label{dm-missing}}

缺失数据操作

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"airquality"}\NormalTok{)}
\FunctionTok{head}\NormalTok{(airquality)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 5    NA      NA 14.3   56     5   5
## 6    28      NA 14.9   66     5   6
\end{verbatim}

对缺失值的处理默认是 \texttt{na.action\ =\ na.omit}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Ozone 最高的那天}
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ airquality, Ozone }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Month, max)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Month Ozone
## 1     5   115
## 2     6    71
## 3     7   135
## 4     8   168
## 5     9    96
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 每月 Ozone, Solar.R, Wind, Temp 平均值}
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ airquality, Ozone }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Month, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Month    Ozone
## 1     5 23.61538
## 2     6 29.44444
## 3     7 59.11538
## 4     8 59.96154
## 5     9 31.44828
\end{verbatim}

缺失值处理

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DataExplorer)}
\FunctionTok{plot\_missing}\NormalTok{(airquality)}
\end{Highlighting}
\end{Shaded}

查看包含缺失的记录，不完整的记录

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality[}\SpecialCharTok{!}\FunctionTok{complete.cases}\NormalTok{(airquality), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Ozone Solar.R Wind Temp Month Day
## 5      NA      NA 14.3   56     5   5
## 6      28      NA 14.9   66     5   6
## 10     NA     194  8.6   69     5  10
## 11      7      NA  6.9   74     5  11
## 25     NA      66 16.6   57     5  25
## 26     NA     266 14.9   58     5  26
## 27     NA      NA  8.0   57     5  27
## 32     NA     286  8.6   78     6   1
## 33     NA     287  9.7   74     6   2
## 34     NA     242 16.1   67     6   3
## 35     NA     186  9.2   84     6   4
## 36     NA     220  8.6   85     6   5
## 37     NA     264 14.3   79     6   6
## 39     NA     273  6.9   87     6   8
## 42     NA     259 10.9   93     6  11
## 43     NA     250  9.2   92     6  12
## 45     NA     332 13.8   80     6  14
## 46     NA     322 11.5   79     6  15
## 52     NA     150  6.3   77     6  21
## 53     NA      59  1.7   76     6  22
## 54     NA      91  4.6   76     6  23
## 55     NA     250  6.3   76     6  24
## 56     NA     135  8.0   75     6  25
## 57     NA     127  8.0   78     6  26
## 58     NA      47 10.3   73     6  27
## 59     NA      98 11.5   80     6  28
## 60     NA      31 14.9   77     6  29
## 61     NA     138  8.0   83     6  30
## 65     NA     101 10.9   84     7   4
## 72     NA     139  8.6   82     7  11
## 75     NA     291 14.9   91     7  14
## 83     NA     258  9.7   81     7  22
## 84     NA     295 11.5   82     7  23
## 96     78      NA  6.9   86     8   4
## 97     35      NA  7.4   85     8   5
## 98     66      NA  4.6   87     8   6
## 102    NA     222  8.6   92     8  10
## 103    NA     137 11.5   86     8  11
## 107    NA      64 11.5   79     8  15
## 115    NA     255 12.6   75     8  23
## 119    NA     153  5.7   88     8  27
## 150    NA     145 13.2   77     9  27
\end{verbatim}

Ozone 和 Solar.R 同时包含缺失值的行

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality[}\FunctionTok{is.na}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Ozone) }\SpecialCharTok{\&} \FunctionTok{is.na}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Solar.R), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Ozone Solar.R Wind Temp Month Day
## 5     NA      NA 14.3   56     5   5
## 27    NA      NA  8.0   57     5  27
\end{verbatim}

\hypertarget{dm-aggregate}{%
\section{数据聚合}\label{dm-aggregate}}

分组求和 \url{https://stackoverflow.com/questions/1660124}

主要是分组统计

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{apropos}\NormalTok{(}\StringTok{"apply"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "apply"      "dendrapply" "eapply"     "frollapply" "kernapply" 
##  [6] "lapply"     "mapply"     "rapply"     "sapply"     "tapply"    
## [11] "vapply"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和 colSums colMeans max}
\FunctionTok{unique}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] setosa     versicolor virginica 
## Levels: setosa versicolor virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分类求和}
\CommentTok{\# colSums(iris[iris$Species == "setosa", {-}5])}
\CommentTok{\# colSums(iris[iris$Species == "virginica", {-}5])}
\FunctionTok{colSums}\NormalTok{(iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"versicolor"}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
##        296.8        138.5        213.0         66.3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# apply(iris[iris$Species == "setosa", {-}5], 2, sum)}
\CommentTok{\# apply(iris[iris$Species == "setosa", {-}5], 2, mean)}
\CommentTok{\# apply(iris[iris$Species == "setosa", {-}5], 2, min)}
\CommentTok{\# apply(iris[iris$Species == "setosa", {-}5], 2, max)}
\FunctionTok{apply}\NormalTok{(iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"setosa"}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{], }\DecValTok{2}\NormalTok{, quantile)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Sepal.Length Sepal.Width Petal.Length Petal.Width
## 0%            4.3       2.300        1.000         0.1
## 25%           4.8       3.200        1.400         0.2
## 50%           5.0       3.400        1.500         0.2
## 75%           5.2       3.675        1.575         0.3
## 100%          5.8       4.400        1.900         0.6
\end{verbatim}

aggregate: Compute Summary Statistics of Data Subsets

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 按分类变量 Species 分组求和}
\CommentTok{\# aggregate(subset(iris, select = {-}Species), by = list(iris[, "Species"]), FUN = sum)}
\FunctionTok{aggregate}\NormalTok{(iris[, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{], }\FunctionTok{list}\NormalTok{(iris[, }\DecValTok{5}\NormalTok{]), sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Group.1 Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        250.3       171.4         73.1        12.3
## 2 versicolor        296.8       138.5        213.0        66.3
## 3  virginica        329.4       148.7        277.6       101.3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 先确定位置，假设有很多分类变量}
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(}\StringTok{"Species"} \SpecialCharTok{==} \FunctionTok{colnames}\NormalTok{(iris))}
\CommentTok{\# 分组统计}
\FunctionTok{aggregate}\NormalTok{(iris[, }\SpecialCharTok{{-}}\NormalTok{ind], }\FunctionTok{list}\NormalTok{(iris[, ind]), sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Group.1 Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        250.3       171.4         73.1        12.3
## 2 versicolor        296.8       138.5        213.0        66.3
## 3  virginica        329.4       148.7        277.6       101.3
\end{verbatim}

按照 Species 划分的类别，分组计算，使用公式表示形式，右边一定是分类变量，否则会报错误或者警告，输出奇怪的结果，请读者尝试运行\texttt{aggregate(Species\ \textasciitilde{}\ Sepal.Length,\ data\ =\ iris,\ mean)}。公式法表示分组计算，\texttt{\textasciitilde{}} 左手边可以做加 \texttt{+} 减 \texttt{-} 乘 \texttt{*} 除 \texttt{/} 取余 \texttt{\%\%} 等数学运算。下面以数据集 iris 为例，只对 Sepal.Length 按 Species 分组计算

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{data =}\NormalTok{ iris, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length
## 1     setosa        5.006
## 2 versicolor        5.936
## 3  virginica        6.588
\end{verbatim}

与上述分组统计结果一样的命令，在大数据集上， 与 aggregate 相比，tapply 要快很多，by 是 tapply 的包裹，处理速度差不多。读者可以构造伪随机数据集验证。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# tapply(iris$Sepal.Length, list(iris$Species), mean)}
\FunctionTok{with}\NormalTok{(iris, }\FunctionTok{tapply}\NormalTok{(Sepal.Length, Species, mean))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     setosa versicolor  virginica 
##      5.006      5.936      6.588
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length, iris}\SpecialCharTok{$}\NormalTok{Species, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## iris$Species: setosa
## [1] 5.006
## ------------------------------------------------------------ 
## iris$Species: versicolor
## [1] 5.936
## ------------------------------------------------------------ 
## iris$Species: virginica
## [1] 6.588
\end{verbatim}

对所有变量按 Species 分组计算

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(. }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{data =}\NormalTok{ iris, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        5.006       3.428        1.462       0.246
## 2 versicolor        5.936       2.770        4.260       1.326
## 3  virginica        6.588       2.974        5.552       2.026
\end{verbatim}

对变量 Sepal.Length 和 Sepal.Width 求和后，按 Species 分组计算

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(Sepal.Length }\SpecialCharTok{+}\NormalTok{ Sepal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{data =}\NormalTok{ iris, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length + Sepal.Width
## 1     setosa                      8.434
## 2 versicolor                      8.706
## 3  virginica                      9.562
\end{verbatim}

对多个分类变量做分组计算，在数据集 ChickWeight 中 Chick和Diet都是数字编码的分类变量，其中 Chick 是有序的因子变量，Diet 是无序的因子变量，而 Time 是数值型的变量，表示小鸡出生的天数。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看数据}
\FunctionTok{str}\NormalTok{(ChickWeight)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   578 obs. of  4 variables:
##  $ weight: num  42 51 59 64 76 93 106 125 149 171 ...
##  $ Time  : num  0 2 4 6 8 10 12 14 16 18 ...
##  $ Chick : Ord.factor w/ 50 levels "18"<"16"<"15"<..: 15 15 15 15 15 15 15 15 15 15 ...
##  $ Diet  : Factor w/ 4 levels "1","2","3","4": 1 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "formula")=Class 'formula'  language weight ~ Time | Chick
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "outer")=Class 'formula'  language ~Diet
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Time"
##   ..$ y: chr "Body weight"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(days)"
##   ..$ y: chr "(gm)"
\end{verbatim}

查看数据集ChickWeight的前几行

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(ChickWeight)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   weight Time Chick Diet
## 1     42    0     1    1
## 2     51    2     1    1
## 3     59    4     1    1
## 4     64    6     1    1
## 5     76    8     1    1
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(ChickWeight)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   578 obs. of  4 variables:
##  $ weight: num  42 51 59 64 76 93 106 125 149 171 ...
##  $ Time  : num  0 2 4 6 8 10 12 14 16 18 ...
##  $ Chick : Ord.factor w/ 50 levels "18"<"16"<"15"<..: 15 15 15 15 15 15 15 15 15 15 ...
##  $ Diet  : Factor w/ 4 levels "1","2","3","4": 1 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "formula")=Class 'formula'  language weight ~ Time | Chick
....
\end{verbatim}

对于数据集ChickWeight中的有序变量Chick，aggregate 会按照既定顺序返回分组计算的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Chick, }\AttributeTok{data =}\NormalTok{ ChickWeight, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Chick    weight
## 1     18  37.00000
## 2     16  49.71429
## 3     15  60.12500
## 4     13  67.83333
## 5      9  81.16667
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Diet, }\AttributeTok{data =}\NormalTok{ ChickWeight, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Diet   weight
## 1    1 102.6455
## 2    2 122.6167
## 3    3 142.9500
## 4    4 135.2627
\end{verbatim}

分类变量没有用数字编码，以 CO2 数据集为例，该数据集描述草植对二氧化碳的吸收情况，Plant 是具有12个水平的有序的因子变量，Type表示植物的源头分别是魁北克(Quebec)和密西西比(Mississippi)，Treatment表示冷却(chilled)和不冷却(nonchilled)两种处理方式，conc表示周围环境中二氧化碳的浓度，uptake表示植物吸收二氧化碳的速率。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看数据集}
\FunctionTok{head}\NormalTok{(CO2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Plant   Type  Treatment conc uptake
## 1   Qn1 Quebec nonchilled   95   16.0
## 2   Qn1 Quebec nonchilled  175   30.4
## 3   Qn1 Quebec nonchilled  250   34.8
## 4   Qn1 Quebec nonchilled  350   37.2
## 5   Qn1 Quebec nonchilled  500   35.3
## 6   Qn1 Quebec nonchilled  675   39.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(CO2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   84 obs. of  5 variables:
##  $ Plant    : Ord.factor w/ 12 levels "Qn1"<"Qn2"<"Qn3"<..: 1 1 1 1 1 1 1 2 2 2 ...
##  $ Type     : Factor w/ 2 levels "Quebec","Mississippi": 1 1 1 1 1 1 1 1 1 1 ...
##  $ Treatment: Factor w/ 2 levels "nonchilled","chilled": 1 1 1 1 1 1 1 1 1 1 ...
##  $ conc     : num  95 175 250 350 500 675 1000 95 175 250 ...
##  $ uptake   : num  16 30.4 34.8 37.2 35.3 39.2 39.7 13.6 27.3 37.1 ...
##  - attr(*, "formula")=Class 'formula'  language uptake ~ conc | Plant
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "outer")=Class 'formula'  language ~Treatment * Type
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Ambient carbon dioxide concentration"
##   ..$ y: chr "CO2 uptake rate"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(uL/L)"
##   ..$ y: chr "(umol/m^2 s)"
\end{verbatim}

对单个变量分组统计

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(uptake }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Plant, }\AttributeTok{data =}\NormalTok{ CO2, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Plant   uptake
## 1    Qn1 33.22857
## 2    Qn2 35.15714
## 3    Qn3 37.61429
## 4    Qc1 29.97143
## 5    Qc3 32.58571
## 6    Qc2 32.70000
## 7    Mn3 24.11429
## 8    Mn2 27.34286
## 9    Mn1 26.40000
## 10   Mc2 12.14286
## 11   Mc3 17.30000
## 12   Mc1 18.00000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(uptake }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Type, }\AttributeTok{data =}\NormalTok{ CO2, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          Type   uptake
## 1      Quebec 33.54286
## 2 Mississippi 20.88333
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(uptake }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Treatment, }\AttributeTok{data =}\NormalTok{ CO2, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Treatment   uptake
## 1 nonchilled 30.64286
## 2    chilled 23.78333
\end{verbatim}

对多个变量分组统计，查看二氧化碳吸收速率uptake随类型Type和处理方式Treatment

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(uptake }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Type }\SpecialCharTok{+}\NormalTok{ Treatment, }\AttributeTok{data =}\NormalTok{ CO2, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          Type  Treatment   uptake
## 1      Quebec nonchilled 35.33333
## 2 Mississippi nonchilled 25.95238
## 3      Quebec    chilled 31.75238
## 4 Mississippi    chilled 15.81429
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tapply}\NormalTok{(CO2}\SpecialCharTok{$}\NormalTok{uptake, }\FunctionTok{list}\NormalTok{(CO2}\SpecialCharTok{$}\NormalTok{Type, CO2}\SpecialCharTok{$}\NormalTok{Treatment), mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             nonchilled  chilled
## Quebec        35.33333 31.75238
## Mississippi   25.95238 15.81429
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(CO2}\SpecialCharTok{$}\NormalTok{uptake, }\FunctionTok{list}\NormalTok{(CO2}\SpecialCharTok{$}\NormalTok{Type, CO2}\SpecialCharTok{$}\NormalTok{Treatment), mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : Quebec
## : nonchilled
## [1] 35.33333
## ------------------------------------------------------------ 
## : Mississippi
## : nonchilled
## [1] 25.95238
## ------------------------------------------------------------ 
## : Quebec
## : chilled
## [1] 31.75238
## ------------------------------------------------------------ 
## : Mississippi
## : chilled
## [1] 15.81429
\end{verbatim}

在这个例子中 tapply 和 by 的输出结果的表示形式不一样，aggregate 返回一个 data.frame 数据框，tapply 返回一个表格 table，by 返回特殊的数据类型 by。

Function \texttt{by} is an object-oriented wrapper for \texttt{tapply} applied to data frames.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和}
\CommentTok{\# by(iris[, 1], INDICES = list(iris$Species), FUN = sum)}
\CommentTok{\# by(iris[, 2], INDICES = list(iris$Species), FUN = sum)}
\FunctionTok{by}\NormalTok{(iris[, }\DecValTok{3}\NormalTok{], }\AttributeTok{INDICES =} \FunctionTok{list}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{FUN =}\NormalTok{ sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : setosa
## [1] 73.1
## ------------------------------------------------------------ 
## : versicolor
## [1] 213
## ------------------------------------------------------------ 
## : virginica
## [1] 277.6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\AttributeTok{INDICES =} \FunctionTok{list}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{FUN =}\NormalTok{ sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : setosa
## [1] 494.8
## ------------------------------------------------------------ 
## : versicolor
## [1] 648.3
## ------------------------------------------------------------ 
## : virginica
## [1] 755.7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\AttributeTok{INDICES =} \FunctionTok{list}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{FUN =}\NormalTok{ summary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : setosa
##   Sepal.Length    Sepal.Width     Petal.Length  
##  Min.   :4.300   Min.   :2.300   Min.   :1.000  
##  1st Qu.:4.800   1st Qu.:3.200   1st Qu.:1.400  
##  Median :5.000   Median :3.400   Median :1.500  
##  Mean   :5.006   Mean   :3.428   Mean   :1.462  
##  3rd Qu.:5.200   3rd Qu.:3.675   3rd Qu.:1.575  
##  Max.   :5.800   Max.   :4.400   Max.   :1.900  
## ------------------------------------------------------------ 
## : versicolor
##   Sepal.Length    Sepal.Width     Petal.Length 
##  Min.   :4.900   Min.   :2.000   Min.   :3.00  
##  1st Qu.:5.600   1st Qu.:2.525   1st Qu.:4.00  
##  Median :5.900   Median :2.800   Median :4.35  
##  Mean   :5.936   Mean   :2.770   Mean   :4.26  
##  3rd Qu.:6.300   3rd Qu.:3.000   3rd Qu.:4.60  
##  Max.   :7.000   Max.   :3.400   Max.   :5.10  
## ------------------------------------------------------------ 
## : virginica
##   Sepal.Length    Sepal.Width     Petal.Length  
##  Min.   :4.900   Min.   :2.200   Min.   :4.500  
##  1st Qu.:6.225   1st Qu.:2.800   1st Qu.:5.100  
##  Median :6.500   Median :3.000   Median :5.550  
##  Mean   :6.588   Mean   :2.974   Mean   :5.552  
##  3rd Qu.:6.900   3rd Qu.:3.175   3rd Qu.:5.875  
##  Max.   :7.900   Max.   :3.800   Max.   :6.900
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(iris, }\AttributeTok{INDICES =} \FunctionTok{list}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{FUN =}\NormalTok{ summary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : setosa
##   Sepal.Length    Sepal.Width     Petal.Length    Petal.Width   
##  Min.   :4.300   Min.   :2.300   Min.   :1.000   Min.   :0.100  
##  1st Qu.:4.800   1st Qu.:3.200   1st Qu.:1.400   1st Qu.:0.200  
##  Median :5.000   Median :3.400   Median :1.500   Median :0.200  
##  Mean   :5.006   Mean   :3.428   Mean   :1.462   Mean   :0.246  
##  3rd Qu.:5.200   3rd Qu.:3.675   3rd Qu.:1.575   3rd Qu.:0.300  
##  Max.   :5.800   Max.   :4.400   Max.   :1.900   Max.   :0.600  
##        Species  
##  setosa    :50  
##  versicolor: 0  
##  virginica : 0  
##                 
##                 
##                 
## ------------------------------------------------------------ 
## : versicolor
##   Sepal.Length    Sepal.Width     Petal.Length   Petal.Width          Species  
##  Min.   :4.900   Min.   :2.000   Min.   :3.00   Min.   :1.000   setosa    : 0  
##  1st Qu.:5.600   1st Qu.:2.525   1st Qu.:4.00   1st Qu.:1.200   versicolor:50  
##  Median :5.900   Median :2.800   Median :4.35   Median :1.300   virginica : 0  
##  Mean   :5.936   Mean   :2.770   Mean   :4.26   Mean   :1.326                  
##  3rd Qu.:6.300   3rd Qu.:3.000   3rd Qu.:4.60   3rd Qu.:1.500                  
##  Max.   :7.000   Max.   :3.400   Max.   :5.10   Max.   :1.800                  
## ------------------------------------------------------------ 
## : virginica
##   Sepal.Length    Sepal.Width     Petal.Length    Petal.Width   
##  Min.   :4.900   Min.   :2.200   Min.   :4.500   Min.   :1.400  
##  1st Qu.:6.225   1st Qu.:2.800   1st Qu.:5.100   1st Qu.:1.800  
##  Median :6.500   Median :3.000   Median :5.550   Median :2.000  
##  Mean   :6.588   Mean   :2.974   Mean   :5.552   Mean   :2.026  
##  3rd Qu.:6.900   3rd Qu.:3.175   3rd Qu.:5.875   3rd Qu.:2.300  
##  Max.   :7.900   Max.   :3.800   Max.   :6.900   Max.   :2.500  
##        Species  
##  setosa    : 0  
##  versicolor: 0  
##  virginica :50  
##                 
##                 
## 
\end{verbatim}

Group Averages Over Level Combinations of Factors 分组平均

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(warpbreaks)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    54 obs. of  3 variables:
##  $ breaks : num  26 30 54 25 70 52 51 26 67 18 ...
##  $ wool   : Factor w/ 2 levels "A","B": 1 1 1 1 1 1 1 1 1 1 ...
##  $ tension: Factor w/ 3 levels "L","M","H": 1 1 1 1 1 1 1 1 1 2 ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(warpbreaks)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   breaks wool tension
## 1     26    A       L
## 2     30    A       L
## 3     54    A       L
## 4     25    A       L
## 5     70    A       L
## 6     52    A       L
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ave}\NormalTok{(warpbreaks}\SpecialCharTok{$}\NormalTok{breaks, warpbreaks}\SpecialCharTok{$}\NormalTok{wool)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
##  [9] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
## [17] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
## [25] 31.03704 31.03704 31.03704 25.25926 25.25926 25.25926 25.25926 25.25926
## [33] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926
## [41] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926
## [49] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(warpbreaks, }\FunctionTok{ave}\NormalTok{(breaks, tension, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{mean}\NormalTok{(x, }\AttributeTok{trim =} \FloatTok{0.1}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875
## [10] 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125
## [19] 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625
## [28] 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875
## [37] 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125
## [46] 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和}
\FunctionTok{with}\NormalTok{(warpbreaks, }\FunctionTok{ave}\NormalTok{(breaks, tension, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{sum}\NormalTok{(x)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 655 655 655 655 655 655 655 655 655 475 475 475 475 475 475 475 475 475 390
## [20] 390 390 390 390 390 390 390 390 655 655 655 655 655 655 655 655 655 475 475
## [39] 475 475 475 475 475 475 475 390 390 390 390 390 390 390 390 390
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和}
\FunctionTok{with}\NormalTok{(iris, }\FunctionTok{ave}\NormalTok{(Sepal.Length, Species, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{sum}\NormalTok{(x)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [13] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [25] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [37] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [49] 250.3 250.3 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [61] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [73] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [85] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [97] 296.8 296.8 296.8 296.8 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [109] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [121] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [133] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [145] 329.4 329.4 329.4 329.4 329.4 329.4
\end{verbatim}

\hypertarget{dm-table}{%
\section{表格统计}\label{dm-table}}

\begin{quote}
介绍操作表格的 table, addmargins, prop.table, xtabs, margin.table, ftabe 等函数
\end{quote}

table 多个分类变量分组计数统计

\begin{itemize}
\tightlist
\item
  介绍 warpbreaks 和 airquality 纽约空气质量监测数据集 二维的数据框
\item
  UCBAdmissions 1973 年加州大学伯克利分校的院系录取数据集 3维的列联表
\item
  Titanic 4维的列联表数据 泰坦尼克号幸存者数据集
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(warpbreaks, }\FunctionTok{table}\NormalTok{(wool, tension))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     tension
## wool L M H
##    A 9 9 9
##    B 9 9 9
\end{verbatim}

以 iris 数据集为例，table 的第一个参数是自己制造的第二个分类变量，原始分类变量是 Species

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(iris, }\FunctionTok{table}\NormalTok{(}\AttributeTok{Sepal.check =}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{7}\NormalTok{, Species))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Species
## Sepal.check setosa versicolor virginica
##       FALSE     50         50        38
##       TRUE       0          0        12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(iris, }\FunctionTok{table}\NormalTok{(}\AttributeTok{Sepal.check =}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FunctionTok{mean}\NormalTok{(Sepal.Length), Species))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Species
## Sepal.check setosa versicolor virginica
##       FALSE     50         24         6
##       TRUE       0         26        44
\end{verbatim}

以 airquality 数据集为例，看看月份中臭氧含量比较高的几天

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aiq.tab }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(airquality, }\FunctionTok{table}\NormalTok{(}\AttributeTok{Oz.high =}\NormalTok{ Ozone }\SpecialCharTok{\textgreater{}} \DecValTok{80}\NormalTok{, Month))}
\NormalTok{aiq.tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high  5  6  7  8  9
##   FALSE 25  9 20 19 27
##   TRUE   1  0  6  7  2
\end{verbatim}

对表格按行和列求和，即求表格的边际，查看总体情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{addmargins}\NormalTok{(aiq.tab, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high   5   6   7   8   9 Sum
##   FALSE  25   9  20  19  27 100
##   TRUE    1   0   6   7   2  16
##   Sum    26   9  26  26  29 116
\end{verbatim}

臭氧含量超 80 的天数在每个月的占比，\texttt{addmargins} 的第二个参数 1 表示对列求和

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aiq.prop }\OtherTok{\textless{}{-}} \FunctionTok{prop.table}\NormalTok{(aiq.tab, }\DecValTok{2}\NormalTok{)}
\NormalTok{aiq.prop}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high          5          6          7          8          9
##   FALSE 0.96153846 1.00000000 0.76923077 0.73076923 0.93103448
##   TRUE  0.03846154 0.00000000 0.23076923 0.26923077 0.06896552
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aiq.marprop }\OtherTok{\textless{}{-}} \FunctionTok{addmargins}\NormalTok{(aiq.prop, }\DecValTok{1}\NormalTok{)}
\NormalTok{aiq.marprop}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high          5          6          7          8          9
##   FALSE 0.96153846 1.00000000 0.76923077 0.73076923 0.93103448
##   TRUE  0.03846154 0.00000000 0.23076923 0.26923077 0.06896552
##   Sum   1.00000000 1.00000000 1.00000000 1.00000000 1.00000000
\end{verbatim}

转换成百分比，将小数四舍五入转化为百分数，保留两位小数点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{round}\NormalTok{(}\DecValTok{100} \SpecialCharTok{*}\NormalTok{ aiq.marprop, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high      5      6      7      8      9
##   FALSE  96.15 100.00  76.92  73.08  93.10
##   TRUE    3.85   0.00  23.08  26.92   6.90
##   Sum   100.00 100.00 100.00 100.00 100.00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pairs}\NormalTok{(airquality, }\AttributeTok{panel =}\NormalTok{ panel.smooth, }\AttributeTok{main =} \StringTok{"airquality data"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

以 UCBAdmissions 数据集为例，使用 \texttt{xtabs} 函数把数据组织成列联表，先查看数据的内容

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{UCBAdmissions}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , Dept = A
## 
##           Gender
## Admit      Male Female
##   Admitted  512     89
##   Rejected  313     19
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{UCBA2DF }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(UCBAdmissions)}
\NormalTok{UCBA2DF}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Admit Gender Dept Freq
## 1  Admitted   Male    A  512
## 2  Rejected   Male    A  313
## 3  Admitted Female    A   89
## 4  Rejected Female    A   19
## 5  Admitted   Male    B  353
....
\end{verbatim}

接着将 \texttt{UCBA2DF} 数据集转化为表格的形式

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{UCBA2DF.tab }\OtherTok{\textless{}{-}} \FunctionTok{xtabs}\NormalTok{(Freq }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Gender }\SpecialCharTok{+}\NormalTok{ Admit }\SpecialCharTok{+}\NormalTok{ Dept, }\AttributeTok{data =}\NormalTok{ UCBA2DF)}
\FunctionTok{ftable}\NormalTok{(UCBA2DF.tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                 Dept   A   B   C   D   E   F
## Gender Admit                                
## Male   Admitted      512 353 120 138  53  22
##        Rejected      313 207 205 279 138 351
## Female Admitted       89  17 202 131  94  24
##        Rejected       19   8 391 244 299 317
\end{verbatim}

将录取性别和院系进行对比

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prop.table}\NormalTok{(}\FunctionTok{margin.table}\NormalTok{(UCBA2DF.tab, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{)), }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         Dept
## Gender            A          B          C          D          E          F
##   Male   0.30657748 0.20810108 0.12077295 0.15496098 0.07097733 0.13861018
##   Female 0.05885559 0.01362398 0.32316076 0.20435967 0.21416894 0.18583106
\end{verbatim}

男生倾向于申请院系 A 和 B，女生倾向于申请院系 C 到 F，院系 A 和 B 是最容易录取的。

\hypertarget{dm-index}{%
\section{索引访问}\label{dm-index}}

which 与引用 \texttt{{[}} 性能比较，在区间 \([0,1]\) 上生成 10 万个服从均匀分布的随机数，随机抽取其中\(\frac{1}{4}\)。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{100000}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(n)}
\NormalTok{i }\OtherTok{\textless{}{-}} \FunctionTok{logical}\NormalTok{(n)}
\NormalTok{i[}\FunctionTok{sample}\NormalTok{(n, n }\SpecialCharTok{/} \DecValTok{4}\NormalTok{)] }\OtherTok{\textless{}{-}} \ConstantTok{TRUE}
\NormalTok{microbenchmark}\SpecialCharTok{::}\FunctionTok{microbenchmark}\NormalTok{(x[i], x[}\FunctionTok{which}\NormalTok{(i)], }\AttributeTok{times =} \DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textcolor{red}{\textbf{TODO: }{使用 \texttt{subset} 函数与 \texttt{{[}} 比较}}

\hypertarget{dm-array}{%
\section{多维数组}\label{dm-array}}

多维数组的行列是怎么定义的 \texttt{?array} 轴的概念，画个图表示数组

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{array}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{27}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , 1
## 
##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9
## 
## , , 2
## 
##      [,1] [,2] [,3]
## [1,]   10   13   16
## [2,]   11   14   17
## [3,]   12   15   18
## 
## , , 3
## 
##      [,1] [,2] [,3]
## [1,]   19   22   25
## [2,]   20   23   26
## [3,]   21   24   27
\end{verbatim}

垂直于Z轴的平面去截三维立方体，3 代表 z 轴，得到三个截面（二维矩阵）

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{asplit}\NormalTok{(}\FunctionTok{array}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{27}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)), }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9
## 
## [[2]]
##      [,1] [,2] [,3]
## [1,]   10   13   16
## [2,]   11   14   17
## [3,]   12   15   18
## 
## [[3]]
##      [,1] [,2] [,3]
## [1,]   19   22   25
## [2,]   20   23   26
## [3,]   21   24   27
\end{verbatim}

对每个二维矩阵按列求和

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lapply}\NormalTok{(}\FunctionTok{asplit}\NormalTok{(}\FunctionTok{array}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{27}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)), }\DecValTok{3}\NormalTok{), apply, }\DecValTok{2}\NormalTok{, sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1]  6 15 24
## 
## [[2]]
## [1] 33 42 51
## 
## [[3]]
## [1] 60 69 78
\end{verbatim}

\texttt{asplit} 和 \texttt{lapply} 组合处理多维数组的\href{https://www.brodieg.com/2018/11/23/is-your-matrix-running-slow-try-lists}{计算问题}

\href{https://d.cosx.org/d/107493}{三维数组的矩阵运算} \href{https://CRAN.R-project.org/package=abind}{abind} 包提供更多的数组操作，如合并，替换

数组操作 aperm 数组转置 Array Transposition

asplit 数组拆分 其后接 lapply 或者 vapply

apply 数组计算

rray 包 \url{https://github.com/r-lib/rray}

\hypertarget{dm-others}{%
\section{其它操作}\label{dm-others}}

成对的数据操作有 \texttt{list} 与 \texttt{unlist}、\texttt{stack} 与 \texttt{unstack}、\texttt{class} 与 \texttt{unclass}、\texttt{attach} 与 \texttt{detach} 以及 \texttt{with} 和 \texttt{within}，它们在数据操作过程中有时会起到一定的补充作用。

\hypertarget{relist-or-unlist}{%
\subsection{列表属性}\label{relist-or-unlist}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 创建列表}
\FunctionTok{list}\NormalTok{(...)}
\FunctionTok{pairlist}\NormalTok{(...)}
\CommentTok{\# 转化列表}
\FunctionTok{as.list}\NormalTok{(x, ...)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}environment\textquotesingle{}}
\FunctionTok{as.list}\NormalTok{(x, }\AttributeTok{all.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sorted =} \ConstantTok{FALSE}\NormalTok{, ...)}
\FunctionTok{as.pairlist}\NormalTok{(x)}
\CommentTok{\# 检查列表}
\FunctionTok{is.list}\NormalTok{(x)}
\FunctionTok{is.pairlist}\NormalTok{(x)}

\FunctionTok{alist}\NormalTok{(...)}
\end{Highlighting}
\end{Shaded}

\texttt{list} 函数用来构造、转化和检查 R 列表对象。下面创建一个临时列表对象 tmp ，它包含两个元素 A 和 B，两个元素都是向量，前者是数值型，后者是字符型

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(tmp }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{A =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{B =} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $A
## [1] 1 2 3
## 
## $B
## [1] "a" "b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlist}\NormalTok{(x, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{use.names =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{unlist} 函数将给定的列表对象 \texttt{x} 简化为原子向量 (atomic vector)，我们发现简化之后变成一个字符型向量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlist}\NormalTok{(tmp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  A1  A2  A3  B1  B2 
## "1" "2" "3" "a" "b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlist}\NormalTok{(tmp, }\AttributeTok{use.names =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1" "2" "3" "a" "b"
\end{verbatim}

unlist 的逆操作是 relist

\hypertarget{stack-or-unstack}{%
\subsection{堆叠向量}\label{stack-or-unstack}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stack}\NormalTok{(x, ...)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{stack}\NormalTok{(x, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{, ...)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}data.frame\textquotesingle{}}
\FunctionTok{stack}\NormalTok{(x, select, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{, ...)}

\FunctionTok{unstack}\NormalTok{(x, ...)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{unstack}\NormalTok{(x, form, ...)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}data.frame\textquotesingle{}}
\FunctionTok{unstack}\NormalTok{(x, form, ...)}
\end{Highlighting}
\end{Shaded}

\texttt{stack} 与 \texttt{unstack} 将多个向量堆在一起组成一个向量

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看数据集 PlantGrowth}
\FunctionTok{class}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   weight group
## 1   4.17  ctrl
## 2   5.58  ctrl
## 3   5.18  ctrl
## 4   6.11  ctrl
## 5   4.50  ctrl
## 6   4.61  ctrl
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 检查默认的公式}
\FunctionTok{formula}\NormalTok{(PlantGrowth) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## weight ~ group
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 根据公式解除堆叠}
\CommentTok{\# 下面等价于 unstack(PlantGrowth, form = weight \textasciitilde{} group)}
\NormalTok{(pg }\OtherTok{\textless{}{-}} \FunctionTok{unstack}\NormalTok{(PlantGrowth)) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    ctrl trt1 trt2
## 1  4.17 4.81 6.31
## 2  5.58 4.17 5.12
## 3  5.18 4.41 5.54
## 4  6.11 3.59 5.50
## 5  4.50 5.87 5.37
## 6  4.61 3.83 5.29
## 7  5.17 6.03 4.92
## 8  4.53 4.89 6.15
## 9  5.33 4.32 5.80
## 10 5.14 4.69 5.26
\end{verbatim}

现在再将变量 pg 堆叠起来，还可以指定要堆叠的列

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stack}\NormalTok{(pg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    values  ind
## 1    4.17 ctrl
## 2    5.58 ctrl
## 3    5.18 ctrl
## 4    6.11 ctrl
## 5    4.50 ctrl
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stack}\NormalTok{(pg, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{ctrl)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    values  ind
## 1    4.81 trt1
## 2    4.17 trt1
## 3    4.41 trt1
## 4    3.59 trt1
## 5    5.87 trt1
....
\end{verbatim}

形式上和 reshape 有一些相似之处，数据框可以由长变宽或由宽变长

\hypertarget{class-or-unclass}{%
\subsection{属性转化}\label{class-or-unclass}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(x)}
\FunctionTok{class}\NormalTok{(x) }\OtherTok{\textless{}{-}}\NormalTok{ value}
\FunctionTok{unclass}\NormalTok{(x)}
\FunctionTok{inherits}\NormalTok{(x, what, }\AttributeTok{which =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{oldClass}\NormalTok{(x)}
\FunctionTok{oldClass}\NormalTok{(x) }\OtherTok{\textless{}{-}}\NormalTok{ value}
\end{Highlighting}
\end{Shaded}

\texttt{class} 和 \texttt{unclass} 函数用来查看、设置类属性和取消类属性，常用于面向对象的编程设计中

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "factor"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unclass}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
##  [38] 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [75] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3
## [112] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3
## [149] 3 3
## attr(,"levels")
....
\end{verbatim}

\hypertarget{attach-or-detach}{%
\subsection{绑定环境}\label{attach-or-detach}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attach}\NormalTok{(what,}
  \AttributeTok{pos =}\NormalTok{ 2L, }\AttributeTok{name =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(what), }\AttributeTok{backtick =} \ConstantTok{FALSE}\NormalTok{),}
  \AttributeTok{warn.conflicts =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{detach}\NormalTok{(name,}
  \AttributeTok{pos =}\NormalTok{ 2L, }\AttributeTok{unload =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{character.only =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{force =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{attach} 和 \texttt{detach} 是否绑定数据框的列名，不推荐操作，推荐使用 \texttt{with}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attach}\NormalTok{(iris)}
\FunctionTok{head}\NormalTok{(Species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] setosa setosa setosa setosa setosa setosa
## Levels: setosa versicolor virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{detach}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\hypertarget{with-or-within}{%
\subsection{数据环境}\label{with-or-within}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(data, expr, ...)}
\FunctionTok{within}\NormalTok{(data, expr, ...)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}list\textquotesingle{}}
\FunctionTok{within}\NormalTok{(data, expr, }\AttributeTok{keepAttrs =} \ConstantTok{TRUE}\NormalTok{, ...)}
\end{Highlighting}
\end{Shaded}

\begin{description}
\item[\texttt{data}]
参数 \texttt{data} 用来构造表达式计算的环境。其默认值可以是一个环境，列表，数据框。在 \texttt{within} 函数中 \texttt{data} 参数只能是列表或数据框。
\item[\texttt{expr}]
参数 \texttt{expr} 包含要计算的表达式。在 \texttt{within} 中通常包含一个复合表达式，比如

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\{}
\NormalTok{  a }\OtherTok{\textless{}{-}} \FunctionTok{somefun}\NormalTok{()}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{otherfun}\NormalTok{()}
\NormalTok{  ...}
  \FunctionTok{rm}\NormalTok{(unused1, temp)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}
\end{description}

\texttt{with} 和 \texttt{within} 计算一组表达式，计算的环境是由数据构造的，后者可以修改原始的数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(mtcars, mpg[cyl }\SpecialCharTok{==} \DecValTok{8} \SpecialCharTok{\&}\NormalTok{ disp }\SpecialCharTok{\textgreater{}} \DecValTok{350}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 18.7 14.3 10.4 10.4 14.7 19.2 15.8
\end{verbatim}

和下面计算的结果一样，但是更加简洁漂亮

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars}\SpecialCharTok{$}\NormalTok{mpg[mtcars}\SpecialCharTok{$}\NormalTok{cyl }\SpecialCharTok{==} \DecValTok{8} \SpecialCharTok{\&}\NormalTok{ mtcars}\SpecialCharTok{$}\NormalTok{disp }\SpecialCharTok{\textgreater{}} \DecValTok{350}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 18.7 14.3 10.4 10.4 14.7 19.2 15.8
\end{verbatim}

\texttt{within} 函数可以修改原数据环境中的多个变量，比如删除、修改和添加等

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 原数据集 airquality}
\FunctionTok{head}\NormalTok{(airquality)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 5    NA      NA 14.3   56     5   5
## 6    28      NA 14.9   66     5   6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aq }\OtherTok{\textless{}{-}} \FunctionTok{within}\NormalTok{(airquality, \{}
\NormalTok{  lOzone }\OtherTok{\textless{}{-}} \FunctionTok{log}\NormalTok{(Ozone) }\CommentTok{\# 取对数}
\NormalTok{  Month }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(month.abb[Month]) }\CommentTok{\# 字符串型转因子型}
\NormalTok{  cTemp }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{((Temp }\SpecialCharTok{{-}} \DecValTok{32}\NormalTok{) }\SpecialCharTok{*} \DecValTok{5} \SpecialCharTok{/} \DecValTok{9}\NormalTok{, }\DecValTok{1}\NormalTok{) }\CommentTok{\# 从华氏温度到摄氏温度转化}
\NormalTok{  S.cT }\OtherTok{\textless{}{-}}\NormalTok{ Solar.R }\SpecialCharTok{/}\NormalTok{ cTemp }\CommentTok{\# 使用新创建的变量}
  \FunctionTok{rm}\NormalTok{(Day, Temp)}
\NormalTok{\})}
\CommentTok{\# 修改后的数据集}
\FunctionTok{head}\NormalTok{(aq)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Month      S.cT cTemp   lOzone
## 1    41     190  7.4   May  9.793814  19.4 3.713572
## 2    36     118  8.0   May  5.315315  22.2 3.583519
## 3    12     149 12.6   May  6.394850  23.3 2.484907
## 4    18     313 11.5   May 18.742515  16.7 2.890372
## 5    NA      NA 14.3   May        NA  13.3       NA
## 6    28      NA 14.9   May        NA  18.9 3.332205
\end{verbatim}

下面再举一个复杂的绘图例子，这个例子来自 \texttt{boxplot} 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(ToothGrowth, \{}
  \FunctionTok{boxplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose,}
    \AttributeTok{boxwex =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{{-}} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{subset =}\NormalTok{ (supp }\SpecialCharTok{==} \StringTok{"VC"}\NormalTok{), }\AttributeTok{col =} \StringTok{"\#4285f4"}\NormalTok{,}
    \AttributeTok{main =} \StringTok{"Guinea Pigs\textquotesingle{} Tooth Growth"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"Vitamin C dose mg"}\NormalTok{,}
    \AttributeTok{ylab =} \StringTok{"tooth length"}\NormalTok{, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{35}\NormalTok{)}
\NormalTok{  )}
  \FunctionTok{boxplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose,}
    \AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{boxwex =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{+} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{subset =}\NormalTok{ supp }\SpecialCharTok{==} \StringTok{"OJ"}\NormalTok{, }\AttributeTok{col =} \StringTok{"\#EA4335"}
\NormalTok{  )}
  \FunctionTok{legend}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{9}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"Ascorbic acid"}\NormalTok{, }\StringTok{"Orange juice"}\NormalTok{),}
    \AttributeTok{fill =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4285f4"}\NormalTok{, }\StringTok{"\#EA4335"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/subset-in-boxplot-1} \end{center}

将 \texttt{boxplot} 函数的 \texttt{subset} 参数单独提出来，调用数据子集选择函数 \texttt{subset} ，这里 \texttt{with} 中只包含一个表达式，所以也可以不用大括号

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{subset}\NormalTok{(ToothGrowth, supp }\SpecialCharTok{==} \StringTok{"VC"}\NormalTok{),}
  \FunctionTok{boxplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose,}
    \AttributeTok{boxwex =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{{-}} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{col =} \StringTok{"\#4285f4"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Guinea Pigs\textquotesingle{} Tooth Growth"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"Vitamin C dose mg"}\NormalTok{,}
    \AttributeTok{ylab =} \StringTok{"tooth length"}\NormalTok{, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{35}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{subset}\NormalTok{(ToothGrowth, supp }\SpecialCharTok{==} \StringTok{"OJ"}\NormalTok{),}
  \FunctionTok{boxplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose,}
    \AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{boxwex =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{+} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{col =} \StringTok{"\#EA4335"}
\NormalTok{  )}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{9}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"Ascorbic acid"}\NormalTok{, }\StringTok{"Orange juice"}\NormalTok{),}
  \AttributeTok{fill =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4285f4"}\NormalTok{, }\StringTok{"\#EA4335"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/subset-out-boxplot-1} \end{center}

可以作为数据变换 \texttt{transform} 的一种替代，它也比较像 \textbf{dplyr} 包的 \texttt{mutate} 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{within}\NormalTok{(mtcars[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{],\{}
\NormalTok{  disp.cc }\OtherTok{\textless{}{-}}\NormalTok{ disp }\SpecialCharTok{*} \FloatTok{2.54}\SpecialCharTok{\^{}}\DecValTok{3}
\NormalTok{  disp.l }\OtherTok{\textless{}{-}}\NormalTok{ disp.cc }\SpecialCharTok{/} \FloatTok{1e3}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg cyl disp   disp.l  disp.cc
## Mazda RX4         21.0   6  160 2.621930 2621.930
## Mazda RX4 Wag     21.0   6  160 2.621930 2621.930
## Datsun 710        22.8   4  108 1.769803 1769.803
## Hornet 4 Drive    21.4   6  258 4.227863 4227.863
## Hornet Sportabout 18.7   8  360 5.899343 5899.343
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 只能使用已有的列，刚生成的列不能用}
\CommentTok{\# transform(}
\CommentTok{\#   mtcars[1:5, 1:3],}
\CommentTok{\#   disp.cc = disp * 2.54\^{}3,}
\CommentTok{\#   disp.l = disp.cc / 1e3}
\CommentTok{\# )}
\FunctionTok{transform}\NormalTok{(}
\NormalTok{  mtcars[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{],}
  \AttributeTok{disp.cc =}\NormalTok{ disp }\SpecialCharTok{*} \FloatTok{2.54}\SpecialCharTok{\^{}}\DecValTok{3}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg cyl disp  disp.cc
## Mazda RX4         21.0   6  160 2621.930
## Mazda RX4 Wag     21.0   6  160 2621.930
## Datsun 710        22.8   4  108 1769.803
## Hornet 4 Drive    21.4   6  258 4227.863
## Hornet Sportabout 18.7   8  360 5899.343
\end{verbatim}

\texttt{transform} 只能使用已有的列，变换中间生成的列不能用，所以相比于 \texttt{transform} 函数， \texttt{within} 显得更为灵活

\hypertarget{dm-apply-family}{%
\section{apply 族}\label{dm-apply-family}}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:apply-functions} apply 函数}\tabularnewline
\toprule
函数 & 输入 & 输出 \\
\midrule
\endfirsthead
\toprule
函数 & 输入 & 输出 \\
\midrule
\endhead
\texttt{apply()} & 矩阵、数据框 & 向量 \\
\texttt{lapply()} & 向量、列表 & 列表 \\
\texttt{sapply()} & 向量、列表 & 向量、矩阵 \\
\texttt{mapply()} & 多个向量 & 列表 \\
\texttt{tapply()} & 数据框、数组 & 向量 \\
\texttt{vapply()} & 列表 & 矩阵 \\
\texttt{eapply()} & 列表 & 列表 \\
\texttt{rapply()} & 嵌套列表 & 嵌套列表 \\
\bottomrule
\end{longtable}

除此之外，还有 \texttt{dendrapply()} 专门处理层次聚类或分类回归树型结构， 而函数 \texttt{kernapply()} 用于时间序列的平滑处理

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Reproduce example 10.4.3 from Brockwell and Davis (1991) [@Brockwell\_1991\_Time]}
\FunctionTok{spectrum}\NormalTok{(sunspot.year, }\AttributeTok{kernel =} \FunctionTok{kernel}\NormalTok{(}\StringTok{"daniell"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{11}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{3}\NormalTok{)), }\AttributeTok{log =} \StringTok{"no"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/spectrum-sunspot-year-1} 

}

\caption{太阳黑子的频谱}\label{fig:spectrum-sunspot-year}
\end{figure}

将函数应用到多个向量，返回一个列表，生成四组服从正态分布 \(\mathcal{N}(\mu_i,\sigma_i)\) 的随机数，它们的均值和方差依次是 \(\mu_i = \sigma_i = 1 \ldots 4\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{means }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\NormalTok{sds }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{samples }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(rnorm,}
  \AttributeTok{mean =}\NormalTok{ means, }\AttributeTok{sd =}\NormalTok{ sds,}
  \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{n =} \DecValTok{10}\NormalTok{), }\AttributeTok{SIMPLIFY =} \ConstantTok{FALSE}
\NormalTok{)}
\NormalTok{samples}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
##  [1]  1.37697212  1.30154837 -0.09802317 -0.13040590 -1.79653432  1.72057350
##  [7]  1.93912102  0.77062225  2.75913135  1.11736679
## 
## [[2]]
##  [1]  0.2937544  3.8185184  4.3927459  1.2568322  1.7534795  5.6000862
##  [7]  5.4079918 -4.0775292 -2.5779499  2.1166070
## 
## [[3]]
##  [1] 9.523096 6.294548 3.954661 2.780557 5.502806 3.596252 6.893524 5.810155
##  [9] 2.557700 3.331296
## 
## [[4]]
##  [1]  0.7499813  1.0251913  8.3813803 13.7414948  5.5524739  5.1625107
##  [7]  2.8576069  4.3040589  1.7588056  5.7887535
\end{verbatim}

我们借用图\ref{fig:mapply-lapply}来看一下 mapply 的效果，多组随机数生成非常有助于快速模拟。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{invisible}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(samples, }\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{plot}\NormalTok{(x, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \StringTok{"grey"}\NormalTok{)}
  \FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"darkorange"}\NormalTok{)}
\NormalTok{\}))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/mapply-lapply-1} 

}

\caption{ lapply 函数}\label{fig:mapply-lapply}
\end{figure}

分别计算每个样本的平均值

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sapply}\NormalTok{(samples, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.8960372 1.7984536 5.0244596 4.9322257
\end{verbatim}

分别计算每个样本的1，2，3 分位点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lapply}\NormalTok{(samples, quantile, }\AttributeTok{probs =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{/} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
##       25%       50%       75% 
## 0.1191382 1.2094576 1.6346732 
## 
## [[2]]
##       25%       50%       75% 
## 0.5345238 1.9350433 4.2491890 
## 
## [[3]]
##      25%      50%      75% 
## 3.397535 4.728734 6.173450 
## 
## [[4]]
##      25%      50%      75% 
## 2.033506 4.733285 5.729684
\end{verbatim}

仅用 \texttt{sapply()} 函数替换上面的 \texttt{lapply()}，我们可以得到一个矩阵，值得注意的是函数 \texttt{quantile()} 和 \texttt{fivenum()} 算出来的结果有一些差异

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sapply}\NormalTok{(samples, quantile, }\AttributeTok{probs =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{/} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          [,1]      [,2]     [,3]     [,4]
## 25% 0.1191382 0.5345238 3.397535 2.033506
## 50% 1.2094576 1.9350433 4.728734 4.733285
## 75% 1.6346732 4.2491890 6.173450 5.729684
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{vapply}\NormalTok{(samples, fivenum, }\FunctionTok{c}\NormalTok{(}\AttributeTok{Min. =} \DecValTok{0}\NormalTok{, }\StringTok{"1st Qu."} \OtherTok{=} \DecValTok{0}\NormalTok{, }\AttributeTok{Median =} \DecValTok{0}\NormalTok{, }\StringTok{"3rd Qu."} \OtherTok{=} \DecValTok{0}\NormalTok{, }\AttributeTok{Max. =} \DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                [,1]       [,2]     [,3]       [,4]
## Min.    -1.79653432 -4.0775292 2.557700  0.7499813
## 1st Qu. -0.09802317  0.2937544 3.331296  1.7588056
## Median   1.20945758  1.9350433 4.728734  4.7332848
## 3rd Qu.  1.72057350  4.3927459 6.294548  5.7887535
## Max.     2.75913135  5.6000862 9.523096 13.7414948
\end{verbatim}

vapply 和 sapply 类似，但是预先指定返回值类型，这样可以更加安全，有时也更快。

以数据集 presidents 为例，它是一个 ts 对象类型的时间序列数据，记录了 1945 年至 1974 年每个季度美国总统的支持率，这组数据中存在缺失值，以 NA 表示。支持率的变化趋势见图 \ref{fig:usa-presidents}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(presidents)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/usa-presidents-1} 

}

\caption{1945-1974美国总统的支持率}\label{fig:usa-presidents}
\end{figure}

计算这 30 年每个季度的平均支持率

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tapply}\NormalTok{(presidents, }\FunctionTok{cycle}\NormalTok{(presidents), mean, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        1        2        3        4 
## 58.44828 56.43333 57.22222 53.07143
\end{verbatim}

\texttt{cycle()} 函数计算序列中每个观察值在周期中的位置，presidents 的周期为 4，根据位置划分组，然后分组求平均，也可以化作如下计算步骤，虽然看起来复杂，但是数据操作的过程很清晰，不再看起来像是一个黑箱。

tapply 函数来做分组求和

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 一个变量分组求和}
\FunctionTok{tapply}\NormalTok{(warpbreaks}\SpecialCharTok{$}\NormalTok{breaks, warpbreaks[, }\DecValTok{3}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{], sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## tension
##   L   M   H 
## 655 475 390
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个变量分组计数}
\FunctionTok{with}\NormalTok{(warpbreaks, }\FunctionTok{table}\NormalTok{(wool, tension))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     tension
## wool L M H
##    A 9 9 9
##    B 9 9 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个变量分组求和}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(breaks }\SpecialCharTok{\textasciitilde{}}\NormalTok{ wool }\SpecialCharTok{+}\NormalTok{ tension, }\AttributeTok{data =}\NormalTok{ warpbreaks, sum) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{reshape}\NormalTok{(}\AttributeTok{v.names =} \StringTok{"breaks"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"wool"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"tension"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}

\StringTok{\textasciigrave{}}\AttributeTok{colnames\textless{}{-}}\StringTok{\textasciigrave{}}\NormalTok{(dat, }\FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"(breaks)"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{colnames}\NormalTok{(dat), }\AttributeTok{replacement =} \StringTok{""}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   wool   L   M   H
## 1    A 401 216 221
## 2    B 254 259 169
\end{verbatim}

\hypertarget{sec-option-with}{%
\section{with 选项}\label{sec-option-with}}

注意 data.table 与 Base R 不同的地方

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://github.com/Rdatatable/data.table/issues/4513}
\CommentTok{\# https://d.cosx.org/d/421532{-}datatable{-}base{-}r}
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{iris }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{, }\FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris))]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  TRUE  TRUE FALSE FALSE FALSE
\end{verbatim}

需要使用 \texttt{with\ =\ FALSE} 选项

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{,}
  \FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris)),}
\NormalTok{  with }\OtherTok{=} \ConstantTok{FALSE}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8
\end{verbatim}

不使用 with 选项，用函数 \texttt{mget()} 将字符串转变量

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[}
\NormalTok{  Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{,}
  \FunctionTok{mget}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris), }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{))}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8
\end{verbatim}

更加 data.table 风格的方式见

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{, .SD, .SDcols }\OtherTok{=} \FunctionTok{patterns}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8
\end{verbatim}

with 还可以这样用，直接修改、添加一列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(df, x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df, z }\SpecialCharTok{\textless{}} \DecValTok{100}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{sample}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df)), ]}
\FunctionTok{head}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y  z
## 7  7 1 50
## 8  8 1 65
## 65 5 7 74
## 14 4 2 20
## 37 7 4 65
## 5  5 1 26
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(x, y, }\AttributeTok{z =}\NormalTok{ z)) }\SpecialCharTok{+}
  \FunctionTok{geom\_contour}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/with-op-1} 

}

\caption{with 操作}\label{fig:with-op}
\end{figure}

\hypertarget{sec-aggregate}{%
\section{分组聚合}\label{sec-aggregate}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{methods}\NormalTok{(}\StringTok{"aggregate"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] aggregate.data.frame aggregate.default*   aggregate.formula*  
## [4] aggregate.ts        
## see '?methods' for accessing help and source code
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{args}\NormalTok{(}\StringTok{"aggregate.data.frame"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (x, by, FUN, ..., simplify = TRUE, drop = TRUE) 
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{args}\NormalTok{(}\StringTok{"aggregate.ts"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (x, nfrequency = 1, FUN = sum, ndeltat = 1, ts.eps = getOption("ts.eps"), 
##     ...) 
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# getAnywhere(aggregate.formula)}
\end{Highlighting}
\end{Shaded}

按 Species 分组，对 Sepal.Length 中大于平均值的数取平均

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, iris, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{mean}\NormalTok{(x[x }\SpecialCharTok{\textgreater{}} \FunctionTok{mean}\NormalTok{(x)]))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length
## 1     setosa     5.313636
## 2 versicolor     6.375000
## 3  virginica     7.159091
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}

\NormalTok{dt }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{each =} \DecValTok{3}\NormalTok{), }\AttributeTok{y =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{),}
  \AttributeTok{z =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{3}\NormalTok{), }\AttributeTok{w =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"a"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{)}
\NormalTok{)}

\NormalTok{dt[, .(}\AttributeTok{x\_sum =} \FunctionTok{sum}\NormalTok{(x), }\AttributeTok{y\_sum =} \FunctionTok{sum}\NormalTok{(y)), by }\OtherTok{=}\NormalTok{ .(z, w)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    z w x_sum y_sum
## 1: A a     4     2
## 2: B a     4     4
## 3: C a     4     6
## 4: A b     2     1
## 5: B b     2     2
## 6: C b     2     3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dt[, .(}\AttributeTok{x\_sum =} \FunctionTok{sum}\NormalTok{(x), }\AttributeTok{y\_sum =} \FunctionTok{sum}\NormalTok{(y)), by }\OtherTok{=} \FunctionTok{mget}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"z"}\NormalTok{, }\StringTok{"w"}\NormalTok{))]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    z w x_sum y_sum
## 1: A a     4     2
## 2: B a     4     4
## 3: C a     4     6
## 4: A b     2     1
## 5: B b     2     2
## 6: C b     2     3
\end{verbatim}

shiny 前端传递字符串向量，借助 \texttt{mget()} 函数根据选择的变量分组统计计算，只有一个变量可以使用 \texttt{get()} 传递变量给 data.table

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{fluidPage}\NormalTok{(}
  \FunctionTok{fluidRow}\NormalTok{(}
    \FunctionTok{column}\NormalTok{(}
      \DecValTok{6}\NormalTok{,}
      \FunctionTok{selectInput}\NormalTok{(}\StringTok{"input\_vars"}\NormalTok{,}
        \AttributeTok{label =} \StringTok{"变量"}\NormalTok{, }\CommentTok{\# 给筛选框取名}
        \AttributeTok{choices =} \FunctionTok{c}\NormalTok{(}\AttributeTok{z =} \StringTok{"z"}\NormalTok{, }\AttributeTok{w =} \StringTok{"w"}\NormalTok{), }\CommentTok{\# 待选的值}
        \AttributeTok{selected =} \StringTok{"z"}\NormalTok{, }\CommentTok{\# 指定默认值}
        \AttributeTok{multiple =} \ConstantTok{TRUE} \CommentTok{\# 允许多选}
\NormalTok{      ),}
\NormalTok{      DT}\SpecialCharTok{::}\FunctionTok{dataTableOutput}\NormalTok{(}\StringTok{"output\_table"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{)}

\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{library}\NormalTok{(magrittr)}

\NormalTok{dt }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{each =} \DecValTok{3}\NormalTok{), }\AttributeTok{y =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{),}
  \AttributeTok{z =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{3}\NormalTok{), }\AttributeTok{w =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"a"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{)}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output, session) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{output\_table }\OtherTok{\textless{}{-}}\NormalTok{ DT}\SpecialCharTok{::}\FunctionTok{renderDataTable}\NormalTok{(}
\NormalTok{    \{}
\NormalTok{      dt[, .(}\AttributeTok{x\_sum =} \FunctionTok{sum}\NormalTok{(x), }\AttributeTok{y\_sum =} \FunctionTok{sum}\NormalTok{(y)), by }\OtherTok{=} \FunctionTok{mget}\NormalTok{(input}\SpecialCharTok{$}\NormalTok{input\_vars)] }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
\NormalTok{        DT}\SpecialCharTok{::}\FunctionTok{datatable}\NormalTok{()}
\NormalTok{    \},}
    \AttributeTok{server =} \ConstantTok{FALSE}
\NormalTok{  )}
\NormalTok{\}}

\CommentTok{\# 执行}
\FunctionTok{shinyApp}\NormalTok{(}\AttributeTok{ui =}\NormalTok{ ui, }\AttributeTok{server =}\NormalTok{ server)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-merge-two-tables}{%
\section{合并操作}\label{sec-merge-two-tables}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat1 }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\NormalTok{dat2 }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{z =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{))}

\FunctionTok{data.frame}\NormalTok{(dat1, }\AttributeTok{z =}\NormalTok{ dat2}\SpecialCharTok{$}\NormalTok{z[}\FunctionTok{match}\NormalTok{(dat1}\SpecialCharTok{$}\NormalTok{x, dat2}\SpecialCharTok{$}\NormalTok{x)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y z
## 1  0 1 3
## 2  0 1 3
## 3 10 2 4
## 4 10 2 4
## 5 20 3 5
## 6 20 3 5
## 7 30 4 6
## 8 30 4 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(dat1, dat2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y z
## 1  0 1 3
## 2  0 1 3
## 3 10 2 4
## 4 10 2 4
## 5 20 3 5
## 6 20 3 5
## 7 30 4 6
## 8 30 4 6
\end{verbatim}

保留两个数据集中的所有行

\hypertarget{sec-reshape}{%
\section{长宽转换}\label{sec-reshape}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{args}\NormalTok{(}\StringTok{"reshape"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (data, varying = NULL, v.names = NULL, timevar = "time", 
##     idvar = "id", ids = 1L:NROW(data), times = seq_along(varying[[1L]]), 
##     drop = NULL, direction, new.row.names = NULL, sep = ".", 
##     split = if (sep == "") {
##         list(regexp = "[A-Za-z][0-9]", include = TRUE)
##     } else {
##         list(regexp = sep, include = FALSE, fixed = TRUE)
##     }) 
## NULL
\end{verbatim}

PlantGrowth 数据集的重塑操作也可以使用内置的函数 \texttt{reshape()} 实现

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{PlantGrowth}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{reshape}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{idvar =} \StringTok{"group"}\NormalTok{, }\AttributeTok{v.names =} \StringTok{"weight"}\NormalTok{,}
  \AttributeTok{timevar =} \StringTok{"id"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{,}
  \AttributeTok{sep =} \StringTok{""}
\NormalTok{)}
\NormalTok{knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(dat,}
  \AttributeTok{caption =} \StringTok{"不同生长环境下植物的干重"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{col.names =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(weight)"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{names}\NormalTok{(dat)),}
  \AttributeTok{align =} \StringTok{"c"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:data-frame-PlantGrowth}不同生长环境下植物的干重}
\centering
\begin{tabular}[t]{c|c|c|c|c|c|c|c|c|c|c}
\hline
group & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10\\
\hline
ctrl & 4.17 & 5.58 & 5.18 & 6.11 & 4.50 & 4.61 & 5.17 & 4.53 & 5.33 & 5.14\\
\hline
trt1 & 4.81 & 4.17 & 4.41 & 3.59 & 5.87 & 3.83 & 6.03 & 4.89 & 4.32 & 4.69\\
\hline
trt2 & 6.31 & 5.12 & 5.54 & 5.50 & 5.37 & 5.29 & 4.92 & 6.15 & 5.80 & 5.26\\
\hline
\end{tabular}
\end{table}

或者，我们也可以使用 \textbf{tidyr} 包提供的 \texttt{pivot\_wider()} 函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{id\_cols =}\NormalTok{ id,}
  \AttributeTok{names\_from =}\NormalTok{ group, }\AttributeTok{values\_from =}\NormalTok{ weight}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 10 x 4
##       id  ctrl  trt1  trt2
##    <int> <dbl> <dbl> <dbl>
##  1     1  4.17  4.81  6.31
##  2     2  5.58  4.17  5.12
##  3     3  5.18  4.41  5.54
##  4     4  6.11  3.59  5.5 
##  5     5  4.5   5.87  5.37
##  6     6  4.61  3.83  5.29
##  7     7  5.17  6.03  4.92
##  8     8  4.53  4.89  6.15
##  9     9  5.33  4.32  5.8 
## 10    10  5.14  4.69  5.26
\end{verbatim}

或者，我们还可以使用 \textbf{data.table} 包提供的 \texttt{dcast()} 函数，用于将长格式的数据框重塑为宽格式的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{PlantGrowth\_DT }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(PlantGrowth)}
\CommentTok{\# 纵}
\FunctionTok{dcast}\NormalTok{(PlantGrowth\_DT, id }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{value.var =} \StringTok{"weight"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     id ctrl trt1 trt2
##  1:  1 4.17 4.81 6.31
##  2:  2 5.58 4.17 5.12
##  3:  3 5.18 4.41 5.54
##  4:  4 6.11 3.59 5.50
##  5:  5 4.50 5.87 5.37
##  6:  6 4.61 3.83 5.29
##  7:  7 5.17 6.03 4.92
##  8:  8 4.53 4.89 6.15
##  9:  9 5.33 4.32 5.80
## 10: 10 5.14 4.69 5.26
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 横}
\FunctionTok{dcast}\NormalTok{(PlantGrowth\_DT, group }\SpecialCharTok{\textasciitilde{}}\NormalTok{ id, }\AttributeTok{value.var =} \StringTok{"weight"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group    1    2    3    4    5    6    7    8    9   10
## 1:  ctrl 4.17 5.58 5.18 6.11 4.50 4.61 5.17 4.53 5.33 5.14
## 2:  trt1 4.81 4.17 4.41 3.59 5.87 3.83 6.03 4.89 4.32 4.69
## 3:  trt2 6.31 5.12 5.54 5.50 5.37 5.29 4.92 6.15 5.80 5.26
\end{verbatim}

\hypertarget{sec-filter-columns}{%
\section{对符合条件的列操作}\label{sec-filter-columns}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数值型变量的列的位置}
\FunctionTok{which}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(iris, is.numeric))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
##            1            2            3            4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[, }\FunctionTok{sapply}\NormalTok{(iris, is.numeric), with }\OtherTok{=}\NormalTok{ F][Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{7.5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:          7.6         3.0          6.6         2.1
## 2:          7.7         3.8          6.7         2.2
## 3:          7.7         2.6          6.9         2.3
## 4:          7.7         2.8          6.7         2.0
## 5:          7.9         3.8          6.4         2.0
## 6:          7.7         3.0          6.1         2.3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.table" "data.frame"
\end{verbatim}

用 Base R 提供的管道符号 \textbar\textgreater{} 将 data.table 数据操作与 ggplot2 数据可视化连接起来

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{iris }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{subset}\NormalTok{(Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \CommentTok{\# 行过滤}
  \CommentTok{\# subset(select = grep("Sepal", colnames(iris), value = TRUE)) |\textgreater{} \# 列过滤}
  \FunctionTok{subset}\NormalTok{(}\AttributeTok{select =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris))) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width)) }\SpecialCharTok{+} \CommentTok{\# 绘图}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/pipe-dataframe-ggplot2-1} 

}

\caption{管道连接数据操作和可视化}\label{fig:pipe-dataframe-ggplot2}
\end{figure}

\hypertarget{sec-case-when}{%
\section{\texorpdfstring{\texttt{CASE\ WHEN} 和 \texttt{fcase}}{CASE WHEN 和 fcase}}\label{sec-case-when}}

\texttt{CASE\ WHEN} 是 SQL 中的条件判断语句，\textbf{data.table} 中的函数 \texttt{fcase()} 可与之等价。值得注意的是，\texttt{fcase()} 需要 \textbf{data.table} 版本 1.13.0 及以上。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{weights =} \FunctionTok{c}\NormalTok{(}\FloatTok{56.8}\NormalTok{, }\FloatTok{57.2}\NormalTok{, }\FloatTok{46.3}\NormalTok{, }\FloatTok{38.5}\NormalTok{),}
  \AttributeTok{gender =} \FunctionTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"0"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"0"}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# 1 表示男，0表示女，空表示未知}
\FunctionTok{transform}\NormalTok{(dat, }\AttributeTok{gender\_cn =} \FunctionTok{fcase}\NormalTok{(}
\NormalTok{  gender }\SpecialCharTok{==} \StringTok{"1"}\NormalTok{, }\StringTok{"男"}\NormalTok{,}
\NormalTok{  gender }\SpecialCharTok{==} \StringTok{"0"}\NormalTok{, }\StringTok{"女"}\NormalTok{,}
\NormalTok{  gender }\SpecialCharTok{==} \StringTok{""}\NormalTok{, }\StringTok{"未知"}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    weights gender gender_cn
## 1:    56.8      1        男
## 2:    57.2      0        女
## 3:    46.3             未知
## 4:    38.5      0        女
\end{verbatim}

\hypertarget{sec-datatable-in-action}{%
\section{数据操作实战}\label{sec-datatable-in-action}}

\href{https://tdhock.github.io/}{Toby Dylan Hocking} 在 useR! 2020 大会上分享的幻灯片 \url{https://github.com/tdhock/r-devel-emails}

\hypertarget{sec-faq-operations}{%
\section{高频数据操作}\label{sec-faq-operations}}

以数据集 dat 为例介绍常用的数据操作

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{num\_a =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{each =} \DecValTok{4}\NormalTok{), }\AttributeTok{num\_b =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{times =} \DecValTok{4}\NormalTok{),}
  \AttributeTok{group\_a =} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\AttributeTok{size =} \DecValTok{16}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{group\_b =} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ LETTERS[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\AttributeTok{size =} \DecValTok{16}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T)}
\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(dat)}
\NormalTok{dat}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     num_a num_b group_a group_b
##  1:     1     1       c       B
##  2:     1     2       b       B
##  3:     1     3       a       B
##  4:     1     4       a       C
##  5:     2     1       b       B
##  6:     2     2       b       C
##  7:     2     3       a       B
##  8:     2     4       a       A
##  9:     3     1       b       C
## 10:     3     2       b       B
## 11:     3     3       b       B
## 12:     3     4       a       B
## 13:     4     1       b       C
## 14:     4     2       c       B
## 15:     4     3       b       C
## 16:     4     4       a       C
\end{verbatim}

\hypertarget{subsec-reduce-merge}{%
\subsection{循环合并}\label{subsec-reduce-merge}}

\begin{itemize}
\tightlist
\item
  问题来源 \href{https://github.com/Rdatatable/data.table/issues/599}{Faster version of Reduce(merge, list(DT1,DT2,DT3,\ldots)) called mergelist (a la rbindlist)}
\end{itemize}

\hypertarget{subsec-count-by-group}{%
\subsection{分组计数}\label{subsec-count-by-group}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(num\_a)), by }\OtherTok{=}\NormalTok{ .(group\_a)] }\CommentTok{\# dat[, .N , by = .(group\_a)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_a V1
## 1:       c  2
## 2:       b  8
## 3:       a  6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(num\_a)), by }\OtherTok{=}\NormalTok{ .(group\_b)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_b V1
## 1:       B  9
## 2:       C  6
## 3:       A  1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(num\_a)), by }\OtherTok{=}\NormalTok{ .(group\_a, group\_b)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_a group_b V1
## 1:       c       B  2
## 2:       b       B  4
## 3:       a       B  3
## 4:       a       C  2
## 5:       b       C  4
## 6:       a       A  1
\end{verbatim}

\hypertarget{subsec-sample-by-group}{%
\subsection{分组抽样}\label{subsec-sample-by-group}}

以 \texttt{group\_a} 为组别， a、 b、 c 分别有 6、 8、 2 条记录

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 无放回的抽样}
\NormalTok{dt\_sample\_1 }\OtherTok{\textless{}{-}}\NormalTok{ dat[, .SD[}\FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .N, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{)], by }\OtherTok{=}\NormalTok{ group\_a]}
\CommentTok{\# 有放回的随机抽样}
\NormalTok{dt\_sample\_2 }\OtherTok{\textless{}{-}}\NormalTok{ dat[, .SD[}\FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .N, }\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{)], by }\OtherTok{=}\NormalTok{ group\_a]}
\end{Highlighting}
\end{Shaded}

可能存在该组样本不平衡，有的组的样本量不足你想要的样本量。每个组无放回地抽取 4 个样本，如果该组样本量不足 4，则全部抽取全部样本量。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .SD[}\FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .N, }\AttributeTok{size =} \FunctionTok{min}\NormalTok{(}\DecValTok{4}\NormalTok{, .N))], by }\OtherTok{=}\NormalTok{ group\_a]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     group_a num_a num_b group_b
##  1:       c     1     1       B
##  2:       c     4     2       B
##  3:       b     3     2       B
##  4:       b     2     2       C
##  5:       b     2     1       B
##  6:       b     3     3       B
##  7:       a     1     3       B
##  8:       a     2     3       B
##  9:       a     2     4       A
## 10:       a     1     4       C
\end{verbatim}

还可以按照指定的比例抽取样本量 \footnote{\url{https://stackoverflow.com/questions/18258690/take-randomly-sample-based-on-groups}}

\hypertarget{subsec-order-by-group}{%
\subsection{分组排序}\label{subsec-order-by-group}}

data.table 包的分组排序问题 \url{https://d.cosx.org/d/421650-datatable/3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[}\FunctionTok{with}\NormalTok{(dat, }\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{ave}\NormalTok{(num\_a, group\_a, }\AttributeTok{FUN =}\NormalTok{ max), }\SpecialCharTok{{-}}\NormalTok{num\_a)), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     num_a num_b group_a group_b
##  1:     4     1       b       C
##  2:     4     2       c       B
##  3:     4     3       b       C
##  4:     4     4       a       C
##  5:     3     1       b       C
##  6:     3     2       b       B
##  7:     3     3       b       B
##  8:     3     4       a       B
##  9:     2     1       b       B
## 10:     2     2       b       C
## 11:     2     3       a       B
## 12:     2     4       a       A
## 13:     1     1       c       B
## 14:     1     2       b       B
## 15:     1     3       a       B
## 16:     1     4       a       C
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# num\_a 降序排列，然后对 group\_a 升序排列}
\NormalTok{dat[}\FunctionTok{with}\NormalTok{(dat, }\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{num\_a, group\_a)), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     num_a num_b group_a group_b
##  1:     4     4       a       C
##  2:     4     1       b       C
##  3:     4     3       b       C
##  4:     4     2       c       B
##  5:     3     4       a       B
##  6:     3     1       b       C
##  7:     3     2       b       B
##  8:     3     3       b       B
##  9:     2     3       a       B
## 10:     2     4       a       A
## 11:     2     1       b       B
## 12:     2     2       b       C
## 13:     1     3       a       B
## 14:     1     4       a       C
## 15:     1     2       b       B
## 16:     1     1       c       B
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 简写}
\NormalTok{dat[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{num\_a, group\_a)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     num_a num_b group_a group_b
##  1:     4     4       a       C
##  2:     4     1       b       C
##  3:     4     3       b       C
##  4:     4     2       c       B
##  5:     3     4       a       B
##  6:     3     1       b       C
##  7:     3     2       b       B
##  8:     3     3       b       B
##  9:     2     3       a       B
## 10:     2     4       a       A
## 11:     2     1       b       B
## 12:     2     2       b       C
## 13:     1     3       a       B
## 14:     1     4       a       C
## 15:     1     2       b       B
## 16:     1     1       c       B
\end{verbatim}

\texttt{setorder()} 函数直接修改原始数据记录的排序

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{setorder}\NormalTok{(dat, }\SpecialCharTok{{-}}\NormalTok{num\_a, group\_a)}
\end{Highlighting}
\end{Shaded}

参考多个列分组排序 \footnote{\url{https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns}}

\begin{rmdtip}{提示}

如果数据集 dat 包含缺失值，考虑去掉缺失值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(num\_a))), by }\OtherTok{=}\NormalTok{ .(group\_a)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_a V1
## 1:       c  2
## 2:       b  8
## 3:       a  6
\end{verbatim}

如果数据集 dat 包含重复值，考虑去掉重复值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(num\_a))), by }\OtherTok{=}\NormalTok{ .(group\_a)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_a V1
## 1:       c  2
## 2:       b  4
## 3:       a  4
\end{verbatim}

\end{rmdtip}

按 Species 分组，对 Sepal.Length 降序排列，取 Top 3

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(iris)}
\NormalTok{iris[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Sepal.Length), .SD[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], by }\OtherTok{=} \StringTok{"Species"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:  virginica          7.9         3.8          6.4         2.0
## 2:  virginica          7.7         3.8          6.7         2.2
## 3:  virginica          7.7         2.6          6.9         2.3
## 4: versicolor          7.0         3.2          4.7         1.4
## 5: versicolor          6.9         3.1          4.9         1.5
## 6: versicolor          6.8         2.8          4.8         1.4
## 7:     setosa          5.8         4.0          1.2         0.2
## 8:     setosa          5.7         4.4          1.5         0.4
## 9:     setosa          5.7         3.8          1.7         0.3
\end{verbatim}

对 iris 各个列排序

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(iris)}
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\AttributeTok{what =} \StringTok{"order"}\NormalTok{, }\AttributeTok{args =}\NormalTok{ dat[, }\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)])}
\NormalTok{dat[ind, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1:          4.6         3.1          1.5         0.2  setosa
## 2:          4.7         3.2          1.3         0.2  setosa
## 3:          4.9         3.0          1.4         0.2  setosa
## 4:          5.0         3.6          1.4         0.2  setosa
## 5:          5.1         3.5          1.4         0.2  setosa
## 6:          5.4         3.9          1.7         0.4  setosa
\end{verbatim}

按 Species 分组，对 Sepal.Length 降序排列，取 Top 3

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\OtherTok{=} \FunctionTok{as.data.table}\NormalTok{(iris)}
\NormalTok{iris[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Sepal.Length), .SD[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], by}\OtherTok{=}\StringTok{"Species"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:  virginica          7.9         3.8          6.4         2.0
## 2:  virginica          7.7         3.8          6.7         2.2
## 3:  virginica          7.7         2.6          6.9         2.3
## 4: versicolor          7.0         3.2          4.7         1.4
## 5: versicolor          6.9         3.1          4.9         1.5
## 6: versicolor          6.8         2.8          4.8         1.4
## 7:     setosa          5.8         4.0          1.2         0.2
## 8:     setosa          5.7         4.4          1.5         0.4
## 9:     setosa          5.7         3.8          1.7         0.3
\end{verbatim}

对 iris 各个列排序，依次对第 5、1、2、3 列升序排列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\AttributeTok{what =} \StringTok{"order"}\NormalTok{, }\AttributeTok{args =}\NormalTok{ iris[,}\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{)])}
\FunctionTok{head}\NormalTok{(iris[ind, ])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1:          4.3         3.0          1.1         0.1  setosa
## 2:          4.4         2.9          1.4         0.2  setosa
## 3:          4.4         3.0          1.3         0.2  setosa
## 4:          4.4         3.2          1.3         0.2  setosa
## 5:          4.5         2.3          1.3         0.3  setosa
## 6:          4.6         3.1          1.5         0.2  setosa
\end{verbatim}

\begin{table}
\caption{\label{tab:column-order}iris 数据集原顺序（左）和新顺序（右）}

\centering
\begin{tabular}[t]{rrrrl}
\toprule
Sepal.Length & Sepal.Width & Petal.Length & Petal.Width & Species\\
\midrule
5.1 & 3.5 & 1.4 & 0.2 & setosa\\
4.9 & 3.0 & 1.4 & 0.2 & setosa\\
4.7 & 3.2 & 1.3 & 0.2 & setosa\\
4.6 & 3.1 & 1.5 & 0.2 & setosa\\
5.0 & 3.6 & 1.4 & 0.2 & setosa\\
\addlinespace
5.4 & 3.9 & 1.7 & 0.4 & setosa\\
\bottomrule
\end{tabular}
\centering
\begin{tabular}[t]{rrrrl}
\toprule
Sepal.Length & Sepal.Width & Petal.Length & Petal.Width & Species\\
\midrule
4.3 & 3.0 & 1.1 & 0.1 & setosa\\
4.4 & 2.9 & 1.4 & 0.2 & setosa\\
4.4 & 3.0 & 1.3 & 0.2 & setosa\\
4.4 & 3.2 & 1.3 & 0.2 & setosa\\
4.5 & 2.3 & 1.3 & 0.3 & setosa\\
\addlinespace
4.6 & 3.1 & 1.5 & 0.2 & setosa\\
\bottomrule
\end{tabular}
\end{table}

\hypertarget{chap-advanced-manipulation}{%
\chapter{高级数据操作}\label{chap-advanced-manipulation}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{library}\NormalTok{(magrittr)}
\end{Highlighting}
\end{Shaded}

介绍 data.table 处理数据的方式，对标 dplyr 的基本操作

\hypertarget{intro}{%
\section{基础介绍}\label{intro}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 用一个真实的数据集替换，让每一个操作都有实际含义和价值 mtcars}
\NormalTok{DT }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"b"}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{"c"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{),}
  \AttributeTok{v =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{6}\NormalTok{), }\AttributeTok{a =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{, }\AttributeTok{b =} \DecValTok{9}\SpecialCharTok{:}\DecValTok{1}
\NormalTok{)}
\NormalTok{DT}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v y a b
## 1: b 1 1 1 9
## 2: b 1 3 2 8
## 3: b 1 6 3 7
## 4: a 2 1 4 6
## 5: a 2 3 5 5
## 6: a 1 6 6 4
## 7: c 1 1 7 3
## 8: c 2 3 8 2
## 9: c 2 6 9 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和}
\NormalTok{DT[, }\FunctionTok{sum}\NormalTok{(v), by }\OtherTok{=}\NormalTok{ .(y }\SpecialCharTok{\%\%} \DecValTok{2}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    y V1
## 1: 1  9
## 2: 0  4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{sum}\NormalTok{(v), by }\OtherTok{=}\NormalTok{ .(}\AttributeTok{bool =}\NormalTok{ y }\SpecialCharTok{\%\%} \DecValTok{2}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    bool V1
## 1:    1  9
## 2:    0  4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, .SD[}\DecValTok{2}\NormalTok{], by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 每组第二行}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v y a b
## 1: b 1 3 2 8
## 2: a 2 3 5 5
## 3: c 2 3 8 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{tail}\NormalTok{(.SD, }\DecValTok{2}\NormalTok{), by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 每组最后两行}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v y a b
## 1: b 1 3 2 8
## 2: b 1 6 3 7
## 3: a 2 3 5 5
## 4: a 1 6 6 4
## 5: c 2 3 8 2
## 6: c 2 6 9 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 除了 x 列外，所有列都按 x 分组求和}
\NormalTok{DT[, }\FunctionTok{lapply}\NormalTok{(.SD, sum), by }\OtherTok{=}\NormalTok{ x] }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v  y  a  b
## 1: b 3 10  6 24
## 2: a 5 10 15 15
## 3: c 5 10 24  6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 各个列都按 x 分组取最小}
\NormalTok{DT[, .SD[}\FunctionTok{which.min}\NormalTok{(v)], by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 分组嵌套查询}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v y a b
## 1: b 1 1 1 9
## 2: a 1 6 6 4
## 3: c 1 1 7 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{list}\NormalTok{(}\AttributeTok{MySum =} \FunctionTok{sum}\NormalTok{(v), }\AttributeTok{MyMin =} \FunctionTok{min}\NormalTok{(v), }\AttributeTok{MyMax =} \FunctionTok{max}\NormalTok{(v)), by }\OtherTok{=}\NormalTok{ .(x, y }\SpecialCharTok{\%\%} \DecValTok{2}\NormalTok{)] }\CommentTok{\# 表达式嵌套}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y MySum MyMin MyMax
## 1: b 1     2     1     1
## 2: b 0     1     1     1
## 3: a 1     4     2     2
## 4: a 0     1     1     1
## 5: c 1     3     1     2
## 6: c 0     2     2     2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, .(}\AttributeTok{a =}\NormalTok{ .(a), }\AttributeTok{b =}\NormalTok{ .(b)), by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 按 x 分组，将 a,b 两列的值列出来}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x     a     b
## 1: b 1,2,3 9,8,7
## 2: a 4,5,6 6,5,4
## 3: c 7,8,9 3,2,1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, .(}\AttributeTok{seq =} \FunctionTok{min}\NormalTok{(a)}\SpecialCharTok{:}\FunctionTok{max}\NormalTok{(b)), by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 列操作不仅仅是聚合}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     x seq
##  1: b   1
##  2: b   2
##  3: b   3
##  4: b   4
##  5: b   5
##  6: b   6
##  7: b   7
##  8: b   8
##  9: b   9
## 10: a   4
## 11: a   5
## 12: a   6
## 13: c   7
## 14: c   6
## 15: c   5
## 16: c   4
## 17: c   3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 按 x 分组对 v 求和，然后过滤出和小于 20 的行}
\NormalTok{DT[, }\FunctionTok{sum}\NormalTok{(v), by }\OtherTok{=}\NormalTok{ x][V1 }\SpecialCharTok{\textless{}} \DecValTok{20}\NormalTok{] }\CommentTok{\# 组合查询}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x V1
## 1: b  3
## 2: a  5
## 3: c  5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{sum}\NormalTok{(v), by }\OtherTok{=}\NormalTok{ x][}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{V1)] }\CommentTok{\# 对结果排序}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x V1
## 1: a  5
## 2: c  5
## 3: b  3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{c}\NormalTok{(.N, }\FunctionTok{lapply}\NormalTok{(.SD, sum)), by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 计算每一组的和，每一组的观测数}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x N v  y  a  b
## 1: b 3 3 10  6 24
## 2: a 3 5 10 15 15
## 3: c 3 5 10 24  6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个复杂的操作，还没弄清楚这个技术存在的意义}
\NormalTok{DT[,}
\NormalTok{  \{}
\NormalTok{    tmp }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(y)}
\NormalTok{    .(}\AttributeTok{a =}\NormalTok{ a }\SpecialCharTok{{-}}\NormalTok{ tmp, }\AttributeTok{b =}\NormalTok{ b }\SpecialCharTok{{-}}\NormalTok{ tmp)}
\NormalTok{  \},}
\NormalTok{  by }\OtherTok{=}\NormalTok{ x}
\NormalTok{] }\CommentTok{\# anonymous lambda in \textquotesingle{}j\textquotesingle{}, j accepts any valid}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x          a          b
## 1: b -2.3333333  5.6666667
## 2: b -1.3333333  4.6666667
## 3: b -0.3333333  3.6666667
## 4: a  0.6666667  2.6666667
## 5: a  1.6666667  1.6666667
## 6: a  2.6666667  0.6666667
## 7: c  3.6666667 -0.3333333
## 8: c  4.6666667 -1.3333333
## 9: c  5.6666667 -2.3333333
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# using rleid, get max(y) and min of all cols in .SDcols for each consecutive run of \textquotesingle{}v\textquotesingle{}}
\NormalTok{DT[, }\FunctionTok{c}\NormalTok{(.(}\AttributeTok{y =} \FunctionTok{max}\NormalTok{(y)), }\FunctionTok{lapply}\NormalTok{(.SD, min)), by }\OtherTok{=} \FunctionTok{rleid}\NormalTok{(v), .SDcols }\OtherTok{=}\NormalTok{ v}\SpecialCharTok{:}\NormalTok{b]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    rleid y v y a b
## 1:     1 6 1 1 1 7
## 2:     2 3 2 1 4 5
## 3:     3 6 1 1 6 3
## 4:     4 6 2 3 8 1
\end{verbatim}

\hypertarget{subsec-filter-i}{%
\subsection{过滤}\label{subsec-filter-i}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df }\OtherTok{=} \FunctionTok{as.data.table}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

过滤 cyl = 6 并且 gear = 4 的记录

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

过滤操作是针对数据框的行（记录）

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{, .(mpg, disp)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg  disp
## 1: 21.0 160.0
## 2: 21.0 160.0
## 3: 19.2 167.6
## 4: 17.8 167.6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mtcars\_df, }\AttributeTok{subset =}\NormalTok{ cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(mpg, disp))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg  disp
## 1: 21.0 160.0
## 2: 21.0 160.0
## 3: 19.2 167.6
## 4: 17.8 167.6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{)  }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, disp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                mpg  disp
## Mazda RX4     21.0 160.0
## Mazda RX4 Wag 21.0 160.0
## Merc 280      19.2 167.6
## Merc 280C     17.8 167.6
\end{verbatim}

\hypertarget{subsec-mutate-j}{%
\subsection{变换}\label{subsec-mutate-j}}

根据已有的列生成新的列，或者修改已有的列，一次只能修改一列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, mean\_mpg }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{mean}\NormalTok{(mpg)}
\NormalTok{          ][, mean\_disp }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{mean}\NormalTok{(disp)]}
\NormalTok{mtcars\_df[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl disp  hp drat    wt  qsec vs am gear carb mean_mpg mean_disp
## 1: 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 20.09062  230.7219
## 2: 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 20.09062  230.7219
## 3: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 20.09062  230.7219
## 4: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 20.09062  230.7219
## 5: 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 20.09062  230.7219
## 6: 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 20.09062  230.7219
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, .(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_disp =} \FunctionTok{mean}\NormalTok{(disp))]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    mean_mpg mean_disp
## 1: 20.09062  230.7219
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# mtcars\_df[, .(mean\_mpg := mean(mpg), mean\_disp := mean(disp))] \# 报错}
\CommentTok{\# 正确的姿势}
\NormalTok{mtcars\_df[, }\StringTok{\textasciigrave{}}\AttributeTok{:=}\StringTok{\textasciigrave{}}\NormalTok{(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_disp =} \FunctionTok{mean}\NormalTok{(disp))          }
\NormalTok{          ][, .(mpg, disp, mean\_mpg, mean\_disp)] }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg disp mean_mpg mean_disp
## 1: 21.0  160 20.09062  230.7219
## 2: 21.0  160 20.09062  230.7219
## 3: 22.8  108 20.09062  230.7219
## 4: 21.4  258 20.09062  230.7219
## 5: 18.7  360 20.09062  230.7219
## 6: 18.1  225 20.09062  230.7219
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_disp =} \FunctionTok{mean}\NormalTok{(disp))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   mean_mpg mean_disp
## 1 20.09062  230.7219
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_disp =} \FunctionTok{mean}\NormalTok{(disp)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, disp, mean\_mpg, mean\_disp) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg disp mean_mpg mean_disp
## Mazda RX4         21.0  160 20.09062  230.7219
## Mazda RX4 Wag     21.0  160 20.09062  230.7219
## Datsun 710        22.8  108 20.09062  230.7219
## Hornet 4 Drive    21.4  258 20.09062  230.7219
## Hornet Sportabout 18.7  360 20.09062  230.7219
## Valiant           18.1  225 20.09062  230.7219
\end{verbatim}

\hypertarget{subsec-summarise-j}{%
\subsection{聚合}\label{subsec-summarise-j}}

分组统计 多个分组变量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dcast}\NormalTok{(mtcars\_df, cyl }\SpecialCharTok{\textasciitilde{}}\NormalTok{ gear, }\AttributeTok{value.var =} \StringTok{"mpg"}\NormalTok{, }\AttributeTok{fun =}\NormalTok{ mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl     3      4    5
## 1:   4 21.50 26.925 28.2
## 2:   6 19.75 19.750 19.7
## 3:   8 15.05    NaN 15.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tapply}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{mpg, }\FunctionTok{list}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{cyl, mtcars}\SpecialCharTok{$}\NormalTok{gear), mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       3      4    5
## 4 21.50 26.925 28.2
## 6 19.75 19.750 19.7
## 8 15.05     NA 15.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, .(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg)), by }\OtherTok{=}\NormalTok{ .(cyl, gear)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear mean_mpg
## 1:   6    4   19.750
## 2:   4    4   26.925
## 3:   6    3   19.750
## 4:   8    3   15.050
## 5:   4    3   21.500
## 6:   4    5   28.200
## 7:   8    5   15.400
## 8:   6    5   19.700
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ mtcars\_df, mpg }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl }\SpecialCharTok{+}\NormalTok{ gear, }\AttributeTok{FUN =}\NormalTok{ mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   cyl gear    mpg
## 1   4    3 21.500
## 2   6    3 19.750
## 3   8    3 15.050
## 4   4    4 26.925
## 5   6    4 19.750
## 6   4    5 28.200
## 7   6    5 19.700
## 8   8    5 15.400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(cyl, gear) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 8 x 3
## # Groups:   cyl [3]
##     cyl  gear mean_mpg
##   <dbl> <dbl>    <dbl>
## 1     4     3     21.5
## 2     4     4     26.9
## 3     4     5     28.2
## 4     6     3     19.8
## 5     6     4     19.8
## 6     6     5     19.7
## 7     8     3     15.0
## 8     8     5     15.4
\end{verbatim}

\hypertarget{subsec-setname}{%
\subsection{命名}\label{subsec-setname}}

修改列名，另存一份生效

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sub\_mtcars\_df }\OtherTok{\textless{}{-}}\NormalTok{ mtcars\_df[, .(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg)), by }\OtherTok{=}\NormalTok{ .(cyl, gear)] }
\FunctionTok{setNames}\NormalTok{(sub\_mtcars\_df, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{, }\StringTok{"ave\_mpg"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear ave_mpg
## 1:   6    4  19.750
## 2:   4    4  26.925
## 3:   6    3  19.750
## 4:   8    3  15.050
## 5:   4    3  21.500
## 6:   4    5  28.200
## 7:   8    5  15.400
## 8:   6    5  19.700
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 注意 sub\_mtcars\_df 并没有修改列名}
\NormalTok{sub\_mtcars\_df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear mean_mpg
## 1:   6    4   19.750
## 2:   4    4   26.925
## 3:   6    3   19.750
## 4:   8    3   15.050
## 5:   4    3   21.500
## 6:   4    5   28.200
## 7:   8    5   15.400
## 8:   6    5   19.700
\end{verbatim}

修改列名并直接起作用，在原来的数据集上生效

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{setnames}\NormalTok{(sub\_mtcars\_df, }\AttributeTok{old =} \FunctionTok{c}\NormalTok{(}\StringTok{"mean\_mpg"}\NormalTok{), }\AttributeTok{new =} \FunctionTok{c}\NormalTok{(}\StringTok{"ave\_mpg"}\NormalTok{))}
\CommentTok{\# sub\_mtcars\_df 已经修改了列名}
\NormalTok{sub\_mtcars\_df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear ave_mpg
## 1:   6    4  19.750
## 2:   4    4  26.925
## 3:   6    3  19.750
## 4:   8    3  15.050
## 5:   4    3  21.500
## 6:   4    5  28.200
## 7:   8    5  15.400
## 8:   6    5  19.700
\end{verbatim}

修改列名最好使用 \textbf{data.table} 包的函数 \texttt{setnames()} 明确指出了要修改的列名，

\hypertarget{subsec-order-by-j}{%
\subsection{排序}\label{subsec-order-by-j}}

按照某（些）列从大到小或从小到大的顺序排列， 先按 cyl 升序，然后按 gear 降序

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, .(mpg, cyl, gear)          }
\NormalTok{          ][cyl }\SpecialCharTok{==} \DecValTok{4}            
\NormalTok{            ][}\FunctionTok{order}\NormalTok{(cyl, }\SpecialCharTok{{-}}\NormalTok{gear)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      mpg cyl gear
##  1: 26.0   4    5
##  2: 30.4   4    5
##  3: 22.8   4    4
##  4: 24.4   4    4
##  5: 22.8   4    4
##  6: 32.4   4    4
##  7: 30.4   4    4
##  8: 33.9   4    4
##  9: 27.3   4    4
## 10: 21.4   4    4
## 11: 21.5   4    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, cyl, gear) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(cyl }\SpecialCharTok{==} \DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(cyl, }\FunctionTok{desc}\NormalTok{(gear))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                 mpg cyl gear
## Porsche 914-2  26.0   4    5
## Lotus Europa   30.4   4    5
## Datsun 710     22.8   4    4
## Merc 240D      24.4   4    4
## Merc 230       22.8   4    4
## Fiat 128       32.4   4    4
## Honda Civic    30.4   4    4
## Toyota Corolla 33.9   4    4
## Fiat X1-9      27.3   4    4
## Volvo 142E     21.4   4    4
## Toyota Corona  21.5   4    3
\end{verbatim}

\hypertarget{subsec-reshape}{%
\subsection{变形}\label{subsec-reshape}}

melt 宽的变长的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{i\_1 =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\ConstantTok{NA}\NormalTok{),}
  \AttributeTok{i\_2 =} \FunctionTok{c}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{10}\NormalTok{),}
  \AttributeTok{f\_1 =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{sample}\NormalTok{(}\FunctionTok{c}\NormalTok{(letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\ConstantTok{NA}\NormalTok{), }\DecValTok{6}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{)),}
  \AttributeTok{f\_2 =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"z"}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"x"}\NormalTok{), }\AttributeTok{ordered =} \ConstantTok{TRUE}\NormalTok{),}
  \AttributeTok{c\_1 =} \FunctionTok{sample}\NormalTok{(}\FunctionTok{c}\NormalTok{(letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\ConstantTok{NA}\NormalTok{), }\DecValTok{6}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{),}
  \AttributeTok{d\_1 =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\DecValTok{4}\SpecialCharTok{:}\DecValTok{5}\NormalTok{), }\AttributeTok{origin =} \StringTok{"2013{-}09{-}01"}\NormalTok{),}
  \AttributeTok{d\_2 =} \FunctionTok{as.Date}\NormalTok{(}\DecValTok{6}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\AttributeTok{origin =} \StringTok{"2012{-}01{-}01"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, .(i\_1, i\_2, f\_1, f\_2)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    i_1 i_2  f_1 f_2
## 1:   1  NA <NA>   z
## 2:   2   6    b   a
## 3:   3   7    c   x
## 4:   4   8    a   c
## 5:   5   9 <NA>   x
## 6:  NA  10    b   x
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{melt}\NormalTok{(DT, }\AttributeTok{id =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\AttributeTok{measure =} \FunctionTok{c}\NormalTok{(}\StringTok{"f\_1"}\NormalTok{, }\StringTok{"f\_2"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     i_1 i_2 variable value
##  1:   1  NA      f_1  <NA>
##  2:   2   6      f_1     b
##  3:   3   7      f_1     c
##  4:   4   8      f_1     a
##  5:   5   9      f_1  <NA>
##  6:  NA  10      f_1     b
##  7:   1  NA      f_2     z
##  8:   2   6      f_2     a
##  9:   3   7      f_2     x
## 10:   4   8      f_2     c
## 11:   5   9      f_2     x
## 12:  NA  10      f_2     x
\end{verbatim}

dcast 长的变宽的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sleep }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(sleep)}
\FunctionTok{dcast}\NormalTok{(sleep, group }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ID, }\AttributeTok{value.var =} \StringTok{"extra"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group   1    2    3    4    5   6   7   8   9  10
## 1:     1 0.7 -1.6 -0.2 -1.2 -0.1 3.4 3.7 0.8 0.0 2.0
## 2:     2 1.9  0.8  1.1  0.1 -0.1 4.4 5.5 1.6 4.6 3.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 如果有多个值}
\FunctionTok{dcast}\NormalTok{(mtcars\_df, cyl }\SpecialCharTok{\textasciitilde{}}\NormalTok{ gear, }\AttributeTok{value.var =} \StringTok{"mpg"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl  3 4 5
## 1:   4  1 8 2
## 2:   6  2 4 1
## 3:   8 12 0 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dcast}\NormalTok{(mtcars\_df, cyl }\SpecialCharTok{\textasciitilde{}}\NormalTok{ gear, }\AttributeTok{value.var =} \StringTok{"mpg"}\NormalTok{, }\AttributeTok{fun =}\NormalTok{ mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl     3      4    5
## 1:   4 21.50 26.925 28.2
## 2:   6 19.75 19.750 19.7
## 3:   8 15.05    NaN 15.4
\end{verbatim}

tidyr 包提供数据变形的函数 \texttt{tidyr::pivot\_longer()} 和 \texttt{tidyr::pivot\_wider()} 相比于 Base R 提供的 \texttt{reshape()} 和 data.table 提供的 \texttt{melt()} 和 \texttt{dcast()} 更加形象的命名

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sleep, }\AttributeTok{names\_from =} \StringTok{"ID"}\NormalTok{, }\AttributeTok{values\_from =} \StringTok{"extra"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 11
##   group   `1`   `2`   `3`   `4`   `5`   `6`   `7`   `8`   `9`  `10`
##   <fct> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1 1       0.7  -1.6  -0.2  -1.2  -0.1   3.4   3.7   0.8   0     2  
## 2 2       1.9   0.8   1.1   0.1  -0.1   4.4   5.5   1.6   4.6   3.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sleep, }\AttributeTok{v.names =} \StringTok{"extra"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"group"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"ID"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group extra.1 extra.2 extra.3 extra.4 extra.5 extra.6 extra.7 extra.8
## 1:     1     0.7    -1.6    -0.2    -1.2    -0.1     3.4     3.7     0.8
## 2:     2     1.9     0.8     1.1     0.1    -0.1     4.4     5.5     1.6
##    extra.9 extra.10
## 1:     0.0      2.0
## 2:     4.6      3.4
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{idvar} 分组变量
\item
  \texttt{timevar} 组内编号
\item
  \texttt{v.names} 个体观察值
\end{itemize}

\begin{rmdnote}{注意}
\texttt{sep} 新的列名是由参数 \texttt{v.names} (extra) 和参数值 \texttt{timevar} (ID) 拼接起来的，默认 \texttt{sep\ =\ "."} 推荐使用下划线来做分割 \texttt{sep\ =\ "\_"}

\end{rmdnote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ToothGrowth }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ head}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    len supp dose
## 1  4.2   VC  0.5
## 2 11.5   VC  0.5
## 3  7.3   VC  0.5
## 4  5.8   VC  0.5
## 5  6.4   VC  0.5
## 6 10.0   VC  0.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ToothGrowth}\SpecialCharTok{$}\NormalTok{time }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\FunctionTok{reshape}\NormalTok{(ToothGrowth, }\AttributeTok{v.names =} \StringTok{"len"}\NormalTok{, }\AttributeTok{idvar =} \FunctionTok{c}\NormalTok{(}\StringTok{"supp"}\NormalTok{, }\StringTok{"dose"}\NormalTok{),}
        \AttributeTok{timevar =} \StringTok{"time"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    supp dose len.1 len.2 len.3 len.4 len.5 len.6 len.7 len.8 len.9 len.10
## 1    VC  0.5   4.2  11.5   7.3   5.8   6.4  10.0  11.2  11.2   5.2    7.0
## 11   VC  1.0  16.5  16.5  15.2  17.3  22.5  17.3  13.6  14.5  18.8   15.5
## 21   VC  2.0  23.6  18.5  33.9  25.5  26.4  32.5  26.7  21.5  23.3   29.5
## 31   OJ  0.5  15.2  21.5  17.6   9.7  14.5  10.0   8.2   9.4  16.5    9.7
## 41   OJ  1.0  19.7  23.3  23.6  26.4  20.0  25.2  25.8  21.2  14.5   27.3
## 51   OJ  2.0  25.5  26.4  22.4  24.5  24.8  30.9  26.4  27.3  29.4   23.0
\end{verbatim}

以数据集 ToothGrowth 为例，变量 supp（大组），dose（小组） 和 time（组内个体编号） 一起决定唯一的一个数据 len，特别适合纵向数据的变形操作

\hypertarget{subsec-group-by}{%
\subsection{分组}\label{subsec-group-by}}

分组切片，取每组第一个和最后一个值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Loblolly }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(Seed) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(height, age, Seed) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(}\DecValTok{1}\NormalTok{, dplyr}\SpecialCharTok{::}\FunctionTok{n}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 28 x 3
## # Groups:   Seed [14]
##    height   age Seed 
##     <dbl> <dbl> <ord>
##  1   3.93     3 329  
##  2  56.4     25 329  
##  3   4.12     3 327  
##  4  56.8     25 327  
##  5   4.38     3 325  
##  6  58.5     25 325  
##  7   3.91     3 307  
##  8  59.1     25 307  
##  9   3.46     3 331  
## 10  59.5     25 331  
## # ... with 18 more rows
\end{verbatim}

\texttt{dplyr::slice()} 和函数 \texttt{slice.index()} 有关系吗？

\hypertarget{subsec-merge}{%
\subsection{合并}\label{subsec-merge}}

合并操作对应于数据库中的连接操作， dplyr 包的哲学就来源于对数据库操作的进一步抽象， data.table 包的 merge 函数就对应为 dplyr 包的 join 函数

\texttt{data.table::merge} 和 \texttt{dplyr::join}

给出一个表格，数据操作， data.table 实现， dplyr 实现

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dt1 }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}\AttributeTok{A =}\NormalTok{ letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{], }\AttributeTok{X =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{key =} \StringTok{"A"}\NormalTok{)}
\NormalTok{dt2 }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}\AttributeTok{A =}\NormalTok{ letters[}\DecValTok{5}\SpecialCharTok{:}\DecValTok{14}\NormalTok{], }\AttributeTok{Y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{key =} \StringTok{"A"}\NormalTok{)}
\FunctionTok{merge}\NormalTok{(dt1, dt2) }\CommentTok{\# 内连接}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    A  X Y
## 1: e  5 1
## 2: f  6 2
## 3: g  7 3
## 4: h  8 4
## 5: i  9 5
## 6: j 10 6
\end{verbatim}

参数 key 的作用相当于建立一个索引，通过它实现更快的数据操作速度

\texttt{key\ =\ c("x","y","z")} 或者 \texttt{key\ =\ "x,y,z"} 其中 x,y,z 是列名

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(band\_members, band\_instruments, }\AttributeTok{package =} \StringTok{"dplyr"}\NormalTok{)}
\NormalTok{band\_members}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 2
##   name  band   
##   <chr> <chr>  
## 1 Mick  Stones 
## 2 John  Beatles
## 3 Paul  Beatles
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{band\_instruments}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 2
##   name  plays 
##   <chr> <chr> 
## 1 John  guitar
## 2 Paul  bass  
## 3 Keith guitar
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{inner\_join}\NormalTok{(band\_members, band\_instruments)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 3
##   name  band    plays 
##   <chr> <chr>   <chr> 
## 1 John  Beatles guitar
## 2 Paul  Beatles bass
\end{verbatim}

list 列表里每个元素都是 data.frame 时，最适合用 \texttt{data.table::rbindlist} 合并

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 合并列表 https://recology.info/2018/10/limiting{-}dependencies/}
\ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  tibble}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{((x }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{setDF}\NormalTok{(}
\NormalTok{    data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(x, }\AttributeTok{use.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{idcol =} \StringTok{"id"}\NormalTok{))}
\NormalTok{  ))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function(x) {
##   tibble::as_tibble((x <- data.table::setDF(
##     data.table::rbindlist(x, use.names = TRUE, fill = TRUE, idcol = "id"))
##   ))
## }
\end{verbatim}

\hypertarget{chap:data-manipulation}{%
\section{高频操作}\label{chap:data-manipulation}}

以面向问题的方式介绍 Base R 提供的数据操作，然后过渡到 data.table，它是加强版的 Base R。

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:single-table-verbs} 单表的操作}\tabularnewline
\toprule
base & dplyr \\
\midrule
\endfirsthead
\toprule
base & dplyr \\
\midrule
\endhead
\texttt{df{[}order(x),\ ,\ drop\ =\ FALSE{]}} & \texttt{arrange(df,\ x)} \\
\texttt{df{[}!duplicated(x),\ ,\ drop\ =\ FALSE{]}}, \texttt{unique()} & \texttt{distinct(df,\ x)} \\
\texttt{df{[}x\ \&\ !is.na(x),\ ,\ drop\ =\ FALSE{]}}, \texttt{subset()} & \texttt{filter(df,\ x)} \\
\texttt{df\$z\ \textless{}-\ df\$x\ +\ df\$y}, \texttt{transform()} & \texttt{mutate(df,\ z\ =\ x\ +\ y)} \\
\texttt{df\$x} & \texttt{pull(df,\ x)} \\
N/A & \texttt{rename(df,\ y\ =\ x)} \\
\texttt{df{[}c("x",\ "y"){]}}, \texttt{subset()} & \texttt{select(df,\ x,\ y)} \\
\texttt{df{[}grepl(names(df),\ "\^{}x"){]}} & \texttt{select(df,\ starts\_with("x")} \\
\texttt{mean(df\$x)} & \texttt{summarise(df,\ mean(x))} \\
\texttt{df{[}c(1,\ 2,\ 5),\ ,\ drop\ =\ FALSE{]}} & \texttt{slice(df,\ c(1,\ 2,\ 5))} \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:two-table-verbs} 两表的操作}\tabularnewline
\toprule
base & dplyr \\
\midrule
\endfirsthead
\toprule
base & dplyr \\
\midrule
\endhead
\texttt{merge(df1,\ df2)} & \texttt{inner\_join(df1,\ df2)} \\
\texttt{merge(df1,\ df2,\ all.x\ =\ TRUE)} & \texttt{left\_join(df1,\ df2)} \\
\texttt{merge(df1,\ df2,\ all.y\ =\ TRUE)} & \texttt{right\_join(df1,\ df2)} \\
\texttt{merge(df1,\ df2,\ all\ =\ TRUE)} & \texttt{full\_join(df1,\ df2)} \\
\texttt{df1{[}df1\$x\ \%in\%\ df2\$x,\ ,\ drop\ =\ FALSE{]}} & \texttt{semi\_join(df1,\ df2)} \\
\texttt{df1{[}!df1\$x\ \%in\%\ df2\$x,\ ,\ drop\ =\ FALSE{]}} & \texttt{anti\_join(df1,\ df2)} \\
\bottomrule
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{class}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{mtcars }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(mtcars)}
\FunctionTok{class}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.table" "data.frame"
\end{verbatim}

\hypertarget{sec-select}{%
\subsection{选择多列}\label{sec-select}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\NormalTok{mtcars[, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)] }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\NormalTok{mtcars[, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)] }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mtcars, cyl, gear) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4
\end{verbatim}

反选多列，选择除了 cyl 和 gear 的列

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 或者 mtcars[, setdiff(names(mtcars), c("cyl", "gear"))]}
\NormalTok{mtcars[ , }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{names}\NormalTok{(mtcars) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{,}\StringTok{"gear"}\NormalTok{))]  }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  TRUE FALSE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(mtcars, }\AttributeTok{select =} \SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(cyl, gear)) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg disp  hp drat    wt  qsec vs am carb
## 1: 21.0  160 110 3.90 2.620 16.46  0  1    4
## 2: 21.0  160 110 3.90 2.875 17.02  0  1    4
## 3: 22.8  108  93 3.85 2.320 18.61  1  1    1
\end{verbatim}

\hypertarget{sec-filter}{%
\subsection{过滤多行}\label{sec-filter}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\NormalTok{mtcars[mtcars}\SpecialCharTok{$}\NormalTok{cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ mtcars}\SpecialCharTok{$}\NormalTok{gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{,]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(mtcars, }\AttributeTok{subset =}\NormalTok{ cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\NormalTok{mtcars[cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{,]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(mtcars, cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

\hypertarget{sec-duplicated}{%
\subsection{去重多行}\label{sec-duplicated}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\NormalTok{mtcars[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(mtcars[, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)])]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\NormalTok{mtcars[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(mtcars, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unique}\NormalTok{(mtcars, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(mtcars, cyl, gear, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
\end{verbatim}

\hypertarget{sec-merge}{%
\subsection{合并操作}\label{sec-merge}}

在数据库的操作中，合并又称为连接

\hypertarget{subsec-left-join}{%
\subsubsection{左合并}\label{subsec-left-join}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr::inner\_join()}
\CommentTok{\# dplyr::left\_join()}
\CommentTok{\# dplyr::right\_join()}
\CommentTok{\# dplyr::full\_join()}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-right-join}{%
\subsubsection{右合并}\label{subsec-right-join}}

\hypertarget{sec-add-columns}{%
\subsection{新添多列}\label{sec-add-columns}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[cyl }\SpecialCharTok{==} \DecValTok{6}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{:=}\StringTok{\textasciigrave{}}\NormalTok{(}\AttributeTok{disp\_mean =} \FunctionTok{mean}\NormalTok{(disp), }\AttributeTok{hp\_mean =} \FunctionTok{mean}\NormalTok{(hp))][cyl }\SpecialCharTok{==} \DecValTok{6}\NormalTok{, .(cyl, disp, hp, disp\_mean, hp\_mean)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl  disp  hp disp_mean  hp_mean
## 1:   6 160.0 110  183.3143 122.2857
## 2:   6 160.0 110  183.3143 122.2857
## 3:   6 258.0 110  183.3143 122.2857
## 4:   6 225.0 105  183.3143 122.2857
## 5:   6 167.6 123  183.3143 122.2857
## 6:   6 167.6 123  183.3143 122.2857
## 7:   6 145.0 175  183.3143 122.2857
\end{verbatim}

\hypertarget{sec-delete-columns}{%
\subsection{删除多列}\label{sec-delete-columns}}

删除列就是将该列的值清空，置为 NULL，下面将新添的两个列删除，根据列名的特点用正则表达式匹配

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[, }\FunctionTok{colnames}\NormalTok{(mtcars)[}\FunctionTok{grep}\NormalTok{(}\StringTok{\textquotesingle{}\_mean$\textquotesingle{}}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(mtcars))] }\SpecialCharTok{:}\ErrorTok{=} \ConstantTok{NULL}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-modify-columns-type}{%
\subsection{修改多列类型}\label{sec-modify-columns-type}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[, (}\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"disp"}\NormalTok{)) }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{lapply}\NormalTok{(.SD, as.integer), .SDcols }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"disp"}\NormalTok{)]}
\FunctionTok{str}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'data.table' and 'data.frame':   32 obs. of  11 variables:
##  $ mpg : num  21 21 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 ...
##  $ cyl : int  6 6 4 6 8 6 8 4 4 6 ...
##  $ disp: int  160 160 108 258 360 225 360 146 140 167 ...
##  $ hp  : num  110 110 93 110 175 105 245 62 95 123 ...
##  $ drat: num  3.9 3.9 3.85 3.08 3.15 2.76 3.21 3.69 3.92 3.92 ...
##  $ wt  : num  2.62 2.88 2.32 3.21 3.44 ...
##  $ qsec: num  16.5 17 18.6 19.4 17 ...
##  $ vs  : num  0 0 1 1 0 1 0 1 1 1 ...
##  $ am  : num  1 1 1 0 0 0 0 0 0 0 ...
##  $ gear: num  4 4 4 3 3 3 3 4 4 4 ...
##  $ carb: num  4 4 1 1 2 1 4 2 2 4 ...
##  - attr(*, ".internal.selfref")=<externalptr> 
##  - attr(*, "index")= int(0)
\end{verbatim}

\hypertarget{sec-select-first-row}{%
\subsection{取每组第一行}\label{sec-select-first-row}}

先将 mtcars 按 cyl 升序，gear 降序排列，然后按 cyl, gear 和 am 分组取第一行

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[}\FunctionTok{order}\NormalTok{(cyl, }\SpecialCharTok{{-}}\NormalTok{ gear)][, }\FunctionTok{head}\NormalTok{(.SD, }\DecValTok{1}\NormalTok{), by }\OtherTok{=} \FunctionTok{list}\NormalTok{(cyl, gear, am)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cyl gear am  mpg disp  hp drat    wt  qsec vs carb
##  1:   4    5  1 26.0  120  91 4.43 2.140 16.70  0    2
##  2:   4    4  1 22.8  108  93 3.85 2.320 18.61  1    1
##  3:   4    4  0 24.4  146  62 3.69 3.190 20.00  1    2
##  4:   4    3  0 21.5  120  97 3.70 2.465 20.01  1    1
##  5:   6    5  1 19.7  145 175 3.62 2.770 15.50  0    6
##  6:   6    4  1 21.0  160 110 3.90 2.620 16.46  0    4
##  7:   6    4  0 19.2  167 123 3.92 3.440 18.30  1    4
##  8:   6    3  0 21.4  258 110 3.08 3.215 19.44  1    1
##  9:   8    5  1 15.8  351 264 4.22 3.170 14.50  0    4
## 10:   8    3  0 18.7  360 175 3.15 3.440 17.02  0    2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者}
\NormalTok{mtcars[}\FunctionTok{order}\NormalTok{(cyl, }\SpecialCharTok{{-}}\NormalTok{ gear)][, .SD[}\DecValTok{1}\NormalTok{], by }\OtherTok{=} \FunctionTok{list}\NormalTok{(cyl, gear, am)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cyl gear am  mpg disp  hp drat    wt  qsec vs carb
##  1:   4    5  1 26.0  120  91 4.43 2.140 16.70  0    2
##  2:   4    4  1 22.8  108  93 3.85 2.320 18.61  1    1
##  3:   4    4  0 24.4  146  62 3.69 3.190 20.00  1    2
##  4:   4    3  0 21.5  120  97 3.70 2.465 20.01  1    1
##  5:   6    5  1 19.7  145 175 3.62 2.770 15.50  0    6
##  6:   6    4  1 21.0  160 110 3.90 2.620 16.46  0    4
##  7:   6    4  0 19.2  167 123 3.92 3.440 18.30  1    4
##  8:   6    3  0 21.4  258 110 3.08 3.215 19.44  1    1
##  9:   8    5  1 15.8  351 264 4.22 3.170 14.50  0    4
## 10:   8    3  0 18.7  360 175 3.15 3.440 17.02  0    2
\end{verbatim}

\hypertarget{subsec-mom-vs-yoy}{%
\subsection{计算环比同比}\label{subsec-mom-vs-yoy}}

以数据集 AirPassengers 为例，重新整理后见表 \ref{tab:air-passengers}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{year =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}\NormalTok{, }\AttributeTok{each =} \DecValTok{12}\NormalTok{),}
  \AttributeTok{month =}\NormalTok{ month.abb, }\AttributeTok{num =}\NormalTok{ AirPassengers}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{reshape}\NormalTok{(.,}
    \AttributeTok{v.names =} \StringTok{"num"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"year"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"month"}\NormalTok{,}
    \AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{setNames}\NormalTok{(., }\FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"(num)"}\NormalTok{, }\AttributeTok{replacement =} \StringTok{""}\NormalTok{, }\AttributeTok{x =} \FunctionTok{colnames}\NormalTok{(.)))}

\FunctionTok{rownames}\NormalTok{(dat) }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(dat, }\AttributeTok{select =}\NormalTok{ year, }\AttributeTok{drop =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{air\_passengers }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(dat, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{year)}

\NormalTok{knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(air\_passengers,}
    \AttributeTok{caption =} \StringTok{"1949{-}1960年国际航班乘客数量变化"}\NormalTok{,}
    \AttributeTok{align =} \StringTok{"c"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:air-passengers}1949-1960年国际航班乘客数量变化}
\centering
\begin{tabular}[t]{l|c|c|c|c|c|c|c|c|c|c|c|c}
\hline
  & Jan & Feb & Mar & Apr & May & Jun & Jul & Aug & Sep & Oct & Nov & Dec\\
\hline
1949 & 112 & 118 & 132 & 129 & 121 & 135 & 148 & 148 & 136 & 119 & 104 & 118\\
\hline
1950 & 115 & 126 & 141 & 135 & 125 & 149 & 170 & 170 & 158 & 133 & 114 & 140\\
\hline
1951 & 145 & 150 & 178 & 163 & 172 & 178 & 199 & 199 & 184 & 162 & 146 & 166\\
\hline
1952 & 171 & 180 & 193 & 181 & 183 & 218 & 230 & 242 & 209 & 191 & 172 & 194\\
\hline
1953 & 196 & 196 & 236 & 235 & 229 & 243 & 264 & 272 & 237 & 211 & 180 & 201\\
\hline
1954 & 204 & 188 & 235 & 227 & 234 & 264 & 302 & 293 & 259 & 229 & 203 & 229\\
\hline
1955 & 242 & 233 & 267 & 269 & 270 & 315 & 364 & 347 & 312 & 274 & 237 & 278\\
\hline
1956 & 284 & 277 & 317 & 313 & 318 & 374 & 413 & 405 & 355 & 306 & 271 & 306\\
\hline
1957 & 315 & 301 & 356 & 348 & 355 & 422 & 465 & 467 & 404 & 347 & 305 & 336\\
\hline
1958 & 340 & 318 & 362 & 348 & 363 & 435 & 491 & 505 & 404 & 359 & 310 & 337\\
\hline
1959 & 360 & 342 & 406 & 396 & 420 & 472 & 548 & 559 & 463 & 407 & 362 & 405\\
\hline
1960 & 417 & 391 & 419 & 461 & 472 & 535 & 622 & 606 & 508 & 461 & 390 & 432\\
\hline
\end{tabular}
\end{table}

横向计算环比，如1949年2月相比1月增长多少、3月相比2月增长多少，以此类推，就是计算环比？纵向计算同比，如1950年1月相比1949年1月增长多少、1951年相比1950年1月增长多少？

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 环比横向/同比纵向}
\NormalTok{mom }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{diff}\NormalTok{(x, }\AttributeTok{lag =} \DecValTok{1}\NormalTok{)}\SpecialCharTok{/}\NormalTok{x[}\SpecialCharTok{{-}}\FunctionTok{length}\NormalTok{(x)] }\CommentTok{\# month to month}
\CommentTok{\# 格式化输出}
\NormalTok{format\_mom }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{formatC}\NormalTok{(}\FunctionTok{mom}\NormalTok{(x), }\AttributeTok{format =} \StringTok{"f"}\NormalTok{, }\AttributeTok{digits =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(formattable)}
\CommentTok{\# 同比变化}
\NormalTok{air\_passengers }\SpecialCharTok{\%\textgreater{}\%}  
  \FunctionTok{apply}\NormalTok{(., }\DecValTok{2}\NormalTok{, format\_mom) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as.data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{formattable}\NormalTok{(., }\FunctionTok{list}\NormalTok{(}
        \AttributeTok{Jan =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"pink"}\NormalTok{),}
        \AttributeTok{Feb =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"springgreen4"}\NormalTok{),}
        \AttributeTok{Mar =}\NormalTok{ percent}
\NormalTok{      ))}

\FunctionTok{library}\NormalTok{(DT)}
\FunctionTok{datatable}\NormalTok{(air\_passengers)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-merge-multi-dfs}{%
\subsection{合并多个数据框}\label{sec-merge-multi-dfs}}

将所有列都保留，以 \texttt{full\_join()} 方式合并

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OtherTok{\textless{}{-}}\NormalTok{ iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{)]}
\NormalTok{df2 }\OtherTok{\textless{}{-}}\NormalTok{ iris[}\DecValTok{11}\SpecialCharTok{:}\DecValTok{15}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{)]}
\NormalTok{df3 }\OtherTok{\textless{}{-}}\NormalTok{ iris[}\DecValTok{16}\SpecialCharTok{:}\DecValTok{30}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{5}\NormalTok{)]}
\NormalTok{all\_dfs }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(df1, df2, df3)}
\CommentTok{\# base}
\FunctionTok{Reduce}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x, y, ...) }\FunctionTok{merge}\NormalTok{(x, y, ..., }\AttributeTok{all =} \ConstantTok{TRUE}\NormalTok{), all\_dfs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Species Sepal.Width Petal.Length
## 1           4.3  setosa         3.0           NA
## 2           4.4  setosa          NA           NA
## 3           4.6  setosa          NA          1.0
## 4           4.6  setosa          NA          1.0
## 5           4.7  setosa          NA          1.6
## 6           4.8  setosa         3.0          1.9
## 7           4.8  setosa         3.4          1.9
## 8           4.9  setosa          NA           NA
## 9           4.9  setosa          NA           NA
## 10          5.0  setosa          NA          1.6
## 11          5.0  setosa          NA          1.6
## 12          5.0  setosa          NA          1.6
## 13          5.0  setosa          NA          1.6
## 14          5.1  setosa          NA          1.5
## 15          5.1  setosa          NA          1.4
## 16          5.1  setosa          NA          1.7
## 17          5.1  setosa          NA          1.5
## 18          5.2  setosa          NA          1.4
## 19          5.2  setosa          NA          1.5
## 20          5.4  setosa         3.7          1.3
## 21          5.4  setosa         3.7          1.7
## 22          5.7  setosa          NA          1.5
## 23          5.7  setosa          NA          1.7
## 24          5.8  setosa         4.0           NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\FunctionTok{Reduce}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x, y, ...) dplyr}\SpecialCharTok{::}\FunctionTok{full\_join}\NormalTok{(x, y, ...), all\_dfs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Species Sepal.Width Petal.Length
## 1           5.1  setosa          NA          1.4
## 2           5.1  setosa          NA          1.5
## 3           5.1  setosa          NA          1.5
## 4           5.1  setosa          NA          1.7
## 5           4.9  setosa          NA           NA
## 6           4.7  setosa          NA          1.6
## 7           4.6  setosa          NA          1.0
## 8           5.0  setosa          NA          1.6
## 9           5.0  setosa          NA          1.6
## 10          5.4  setosa         3.7          1.3
## 11          5.4  setosa         3.7          1.7
## 12          4.6  setosa          NA          1.0
## 13          5.0  setosa          NA          1.6
## 14          5.0  setosa          NA          1.6
## 15          4.4  setosa          NA           NA
## 16          4.9  setosa          NA           NA
## 17          4.8  setosa         3.4          1.9
## 18          4.8  setosa         3.0          1.9
## 19          4.3  setosa         3.0           NA
## 20          5.8  setosa         4.0           NA
## 21          5.7  setosa          NA          1.5
## 22          5.7  setosa          NA          1.7
## 23          5.2  setosa          NA          1.5
## 24          5.2  setosa          NA          1.4
\end{verbatim}

合并完应该有30行，为啥只有24行？这是因为 \texttt{merge()} 函数对主键 key 相同的记录会合并，要想不合并，需要调用 \texttt{rbindlist()} 函数 \url{https://d.cosx.org/d/421235}

\texttt{rbind()} 列数相同的两个 data.frame 按行合并，\texttt{cbind()} 行数相同的两个 data.frame 按列合并，\texttt{merge()} 对行、列数没有要求

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rbindlist}\NormalTok{(all\_dfs, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          5.1  setosa          NA           NA
##  2:          4.9  setosa          NA           NA
##  3:          4.7  setosa          NA           NA
##  4:          4.6  setosa          NA           NA
##  5:          5.0  setosa          NA           NA
##  6:          5.4  setosa          NA           NA
##  7:          4.6  setosa          NA           NA
##  8:          5.0  setosa          NA           NA
##  9:          4.4  setosa          NA           NA
## 10:          4.9  setosa          NA           NA
## 11:          5.4  setosa         3.7           NA
## 12:          4.8  setosa         3.4           NA
## 13:          4.8  setosa         3.0           NA
## 14:          4.3  setosa         3.0           NA
## 15:          5.8  setosa         4.0           NA
## 16:          5.7  setosa          NA          1.5
## 17:          5.4  setosa          NA          1.3
## 18:          5.1  setosa          NA          1.4
## 19:          5.7  setosa          NA          1.7
## 20:          5.1  setosa          NA          1.5
## 21:          5.4  setosa          NA          1.7
## 22:          5.1  setosa          NA          1.5
## 23:          4.6  setosa          NA          1.0
## 24:          5.1  setosa          NA          1.7
## 25:          4.8  setosa          NA          1.9
## 26:          5.0  setosa          NA          1.6
## 27:          5.0  setosa          NA          1.6
## 28:          5.2  setosa          NA          1.5
## 29:          5.2  setosa          NA          1.4
## 30:          4.7  setosa          NA          1.6
##     Sepal.Length Species Sepal.Width Petal.Length
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(all\_dfs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Species Sepal.Width Petal.Length
## 1           5.1  setosa          NA           NA
## 2           4.9  setosa          NA           NA
## 3           4.7  setosa          NA           NA
## 4           4.6  setosa          NA           NA
## 5           5.0  setosa          NA           NA
## 6           5.4  setosa          NA           NA
## 7           4.6  setosa          NA           NA
## 8           5.0  setosa          NA           NA
## 9           4.4  setosa          NA           NA
## 10          4.9  setosa          NA           NA
## 11          5.4  setosa         3.7           NA
## 12          4.8  setosa         3.4           NA
## 13          4.8  setosa         3.0           NA
## 14          4.3  setosa         3.0           NA
## 15          5.8  setosa         4.0           NA
## 16          5.7  setosa          NA          1.5
## 17          5.4  setosa          NA          1.3
## 18          5.1  setosa          NA          1.4
## 19          5.7  setosa          NA          1.7
## 20          5.1  setosa          NA          1.5
## 21          5.4  setosa          NA          1.7
## 22          5.1  setosa          NA          1.5
## 23          4.6  setosa          NA          1.0
## 24          5.1  setosa          NA          1.7
## 25          4.8  setosa          NA          1.9
## 26          5.0  setosa          NA          1.6
## 27          5.0  setosa          NA          1.6
## 28          5.2  setosa          NA          1.5
## 29          5.2  setosa          NA          1.4
## 30          4.7  setosa          NA          1.6
\end{verbatim}

\hypertarget{sec-multiple-aggregations}{%
\subsection{分组聚合多个指标}\label{sec-multiple-aggregations}}

\url{https://stackoverflow.com/questions/24151602/calculate-multiple-aggregations-with-lapply-sd}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\FunctionTok{aggregate}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ mtcars, }\FunctionTok{cbind}\NormalTok{(mpg, hp) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl,}
  \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{c}\NormalTok{(}\AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{median =} \FunctionTok{median}\NormalTok{(x))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   cyl mpg.mean mpg.median   hp.mean hp.median
## 1   4 26.66364   26.00000  82.63636  91.00000
## 2   6 19.74286   19.70000 122.28571 110.00000
## 3   8 15.10000   15.20000 209.21429 192.50000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据一致性 https://d.cosx.org/d/420763{-}base{-}r}
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{aggregate}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(mpg, hp) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl, mtcars,}
    \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{c}\NormalTok{(}\AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{median =} \FunctionTok{median}\NormalTok{(x))}
\NormalTok{  ),}
  \FunctionTok{cbind.data.frame}\NormalTok{(cyl, mpg, hp)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   cyl     mean median      mean median
## 1   4 26.66364   26.0  82.63636   91.0
## 2   6 19.74286   19.7 122.28571  110.0
## 3   8 15.10000   15.2 209.21429  192.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\NormalTok{mtcars[, }\FunctionTok{as.list}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(.SD, }\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(x),}
    \AttributeTok{median =} \FunctionTok{median}\NormalTok{(x)}
\NormalTok{  )}
\NormalTok{\}))),}
\NormalTok{by }\OtherTok{=} \StringTok{"cyl"}\NormalTok{, .SDcols }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{"mpg"}\NormalTok{, }\StringTok{"hp"}\NormalTok{)}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl mpg.mean mpg.median   hp.mean hp.median
## 1:   6 19.74286       19.7 122.28571     110.0
## 2:   4 26.66364       26.0  82.63636      91.0
## 3:   8 15.10000       15.2 209.21429     192.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(cyl) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_hp =} \FunctionTok{mean}\NormalTok{(hp),}
    \AttributeTok{median\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{median\_hp =} \FunctionTok{mean}\NormalTok{(hp)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 5
##     cyl mean_mpg mean_hp median_mpg median_hp
##   <int>    <dbl>   <dbl>      <dbl>     <dbl>
## 1     4     26.7    82.6       26.7      82.6
## 2     6     19.7   122.        19.7     122. 
## 3     8     15.1   209.        15.1     209.
\end{verbatim}

\hypertarget{sec-rename-multi-cols}{%
\subsection{重命名多个列}\label{sec-rename-multi-cols}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tmp }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ mtcars, }\FunctionTok{cbind}\NormalTok{(mpg, hp) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl,}
          \AttributeTok{FUN =}\NormalTok{ median)}
\NormalTok{tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(tmp)}
\FunctionTok{setnames}\NormalTok{(tmp, }\AttributeTok{old =} \FunctionTok{c}\NormalTok{(}\StringTok{"mpg"}\NormalTok{, }\StringTok{"hp"}\NormalTok{), }\AttributeTok{new =} \FunctionTok{c}\NormalTok{(}\StringTok{"median\_mpg"}\NormalTok{, }\StringTok{"median\_hp"}\NormalTok{))}
\NormalTok{tmp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl median_mpg median_hp
## 1:   4       26.0      91.0
## 2:   6       19.7     110.0
## 3:   8       15.2     192.5
\end{verbatim}

\hypertarget{sec-sort-multi-cols}{%
\subsection{对多个列依次排序}\label{sec-sort-multi-cols}}

\url{https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\NormalTok{tmp[}\FunctionTok{order}\NormalTok{(median\_mpg, }\SpecialCharTok{{-}}\NormalTok{median\_hp), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl median_mpg median_hp
## 1:   8       15.2     192.5
## 2:   6       19.7     110.0
## 3:   4       26.0      91.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\FunctionTok{setorder}\NormalTok{(tmp, median\_mpg, }\SpecialCharTok{{-}}\NormalTok{median\_hp)}
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(tmp, median\_mpg, }\FunctionTok{desc}\NormalTok{(median\_hp))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl median_mpg median_hp
## 1:   8       15.2     192.5
## 2:   6       19.7     110.0
## 3:   4       26.0      91.0
\end{verbatim}

\hypertarget{sec-rearrange-position-multi-cols}{%
\subsection{重排多个列的位置}\label{sec-rearrange-position-multi-cols}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://stackoverflow.com/questions/19619666/change{-}column{-}position{-}of{-}data{-}table}
\FunctionTok{setcolorder}\NormalTok{(tmp, }\FunctionTok{c}\NormalTok{(}\StringTok{"median\_mpg"}\NormalTok{, }\FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), }\StringTok{"median\_mpg"}\NormalTok{)))}
\NormalTok{tmp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    median_mpg cyl median_hp
## 1:       15.2   8     192.5
## 2:       19.7   6     110.0
## 3:       26.0   4      91.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(tmp, }\StringTok{"median\_mpg"}\NormalTok{, }\FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), }\StringTok{"median\_mpg"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    median_mpg cyl median_hp
## 1:       15.2   8     192.5
## 2:       19.7   6     110.0
## 3:       26.0   4      91.0
\end{verbatim}

\hypertarget{sec-tidy-output}{%
\subsection{整理回归结果}\label{sec-tidy-output}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(iris, iris}\SpecialCharTok{$}\NormalTok{Species)}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(dat, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{lm}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length, x))}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(mod, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(x)))}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{Map}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x, y) \{x }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(x) ; x}\SpecialCharTok{$}\NormalTok{Species }\OtherTok{=}\NormalTok{ y; x\}, mod, }\FunctionTok{names}\NormalTok{(dat))}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, mod)}
\NormalTok{mod}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                          Estimate Std. Error    t value     Pr(>|t|)    Species
## setosa.(Intercept)      0.8030518 0.34387807  2.3352806 2.375647e-02     setosa
## setosa.Sepal.Length     0.1316317 0.06852690  1.9208760 6.069778e-02     setosa
## versicolor.(Intercept)  0.1851155 0.51421351  0.3599974 7.204283e-01 versicolor
## versicolor.Sepal.Length 0.6864698 0.08630708  7.9538056 2.586190e-10 versicolor
## virginica.(Intercept)   0.6104680 0.41710685  1.4635770 1.498279e-01  virginica
## virginica.Sepal.Length  0.7500808 0.06302606 11.9011203 6.297786e-16  virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 管道操作}
\FunctionTok{split}\NormalTok{(iris, iris}\SpecialCharTok{$}\NormalTok{Species) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{lapply}\NormalTok{(., }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(}\FunctionTok{lm}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length, x)))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{Map}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{    x }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(x)}
\NormalTok{    x}\SpecialCharTok{$}\NormalTok{Species }\OtherTok{\textless{}{-}}\NormalTok{ y}
\NormalTok{    x}
\NormalTok{  \}, ., }\FunctionTok{levels}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{do.call}\NormalTok{(rbind, .)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                          Estimate Std. Error    t value     Pr(>|t|)    Species
## setosa.(Intercept)      0.8030518 0.34387807  2.3352806 2.375647e-02     setosa
## setosa.Sepal.Length     0.1316317 0.06852690  1.9208760 6.069778e-02     setosa
## versicolor.(Intercept)  0.1851155 0.51421351  0.3599974 7.204283e-01 versicolor
## versicolor.Sepal.Length 0.6864698 0.08630708  7.9538056 2.586190e-10 versicolor
## virginica.(Intercept)   0.6104680 0.41710685  1.4635770 1.498279e-01  virginica
## virginica.Sepal.Length  0.7500808 0.06302606 11.9011203 6.297786e-16  virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr 操作，需要 dplyr \textgreater{}= 1.0.0 或者开发版}
\NormalTok{iris }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(Species) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(broom}\SpecialCharTok{::}\FunctionTok{tidy}\NormalTok{(}\FunctionTok{lm}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 6
## # Groups:   Species [3]
##   Species    term         estimate std.error statistic  p.value
##   <fct>      <chr>           <dbl>     <dbl>     <dbl>    <dbl>
## 1 setosa     (Intercept)     0.803    0.344      2.34  2.38e- 2
## 2 setosa     Sepal.Length    0.132    0.0685     1.92  6.07e- 2
## 3 versicolor (Intercept)     0.185    0.514      0.360 7.20e- 1
## 4 versicolor Sepal.Length    0.686    0.0863     7.95  2.59e-10
## 5 virginica  (Intercept)     0.610    0.417      1.46  1.50e- 1
## 6 virginica  Sepal.Length    0.750    0.0630    11.9   6.30e-16
\end{verbatim}

\hypertarget{sec-assignment-by-reference}{%
\subsection{\texorpdfstring{\texttt{:=} 和 \texttt{.()}}{:= 和 .()}}\label{sec-assignment-by-reference}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[, mpg\_rate }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{round}\NormalTok{(mpg}\SpecialCharTok{/}\FunctionTok{sum}\NormalTok{(mpg) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{), by }\OtherTok{=}\NormalTok{ .(cyl, vs, am)]}
\NormalTok{mtcars[, .(mpg\_rate, mpg, cyl, vs, am)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg_rate  mpg cyl vs am
##  1:    34.04 21.0   6  0  1
##  2:    34.04 21.0   6  0  1
##  3:    11.48 22.8   4  1  1
##  4:    27.97 21.4   6  1  0
##  5:    10.35 18.7   8  0  0
##  6:    23.66 18.1   6  1  0
##  7:     7.92 14.3   8  0  0
##  8:    35.52 24.4   4  1  0
##  9:    33.19 22.8   4  1  0
## 10:    25.10 19.2   6  1  0
## 11:    23.27 17.8   6  1  0
## 12:     9.08 16.4   8  0  0
## 13:     9.58 17.3   8  0  0
## 14:     8.42 15.2   8  0  0
## 15:     5.76 10.4   8  0  0
## 16:     5.76 10.4   8  0  0
## 17:     8.14 14.7   8  0  0
## 18:    16.31 32.4   4  1  1
## 19:    15.31 30.4   4  1  1
## 20:    17.07 33.9   4  1  1
## 21:    31.30 21.5   4  1  0
## 22:     8.58 15.5   8  0  0
## 23:     8.42 15.2   8  0  0
## 24:     7.36 13.3   8  0  0
## 25:    10.63 19.2   8  0  0
## 26:    13.75 27.3   4  1  1
## 27:   100.00 26.0   4  0  1
## 28:    15.31 30.4   4  1  1
## 29:    51.30 15.8   8  0  1
## 30:    31.93 19.7   6  0  1
## 31:    48.70 15.0   8  0  1
## 32:    10.78 21.4   4  1  1
##     mpg_rate  mpg cyl vs am
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[, .(}\AttributeTok{mpg\_rate =} \FunctionTok{round}\NormalTok{(mpg}\SpecialCharTok{/}\FunctionTok{sum}\NormalTok{(mpg) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{)), by }\OtherTok{=}\NormalTok{ .(cyl, vs, am)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cyl vs am mpg_rate
##  1:   6  0  1    34.04
##  2:   6  0  1    34.04
##  3:   6  0  1    31.93
##  4:   4  1  1    11.48
##  5:   4  1  1    16.31
##  6:   4  1  1    15.31
##  7:   4  1  1    17.07
##  8:   4  1  1    13.75
##  9:   4  1  1    15.31
## 10:   4  1  1    10.78
## 11:   6  1  0    27.97
## 12:   6  1  0    23.66
## 13:   6  1  0    25.10
## 14:   6  1  0    23.27
## 15:   8  0  0    10.35
## 16:   8  0  0     7.92
## 17:   8  0  0     9.08
## 18:   8  0  0     9.58
## 19:   8  0  0     8.42
## 20:   8  0  0     5.76
## 21:   8  0  0     5.76
## 22:   8  0  0     8.14
## 23:   8  0  0     8.58
## 24:   8  0  0     8.42
## 25:   8  0  0     7.36
## 26:   8  0  0    10.63
## 27:   4  1  0    35.52
## 28:   4  1  0    33.19
## 29:   4  1  0    31.30
## 30:   4  0  1   100.00
## 31:   8  0  1    51.30
## 32:   8  0  1    48.70
##     cyl vs am mpg_rate
\end{verbatim}

\hypertarget{sec-remove-na}{%
\subsection{去掉含有缺失值的记录}\label{sec-remove-na}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality[}\FunctionTok{complete.cases}\NormalTok{(airquality), ] }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ head}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 7    23     299  8.6   65     5   7
## 8    19      99 13.8   59     5   8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或着}
\NormalTok{airquality[}\SpecialCharTok{!}\FunctionTok{apply}\NormalTok{(airquality, }\DecValTok{1}\NormalTok{, anyNA), ] }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{  head}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 7    23     299  8.6   65     5   7
## 8    19      99 13.8   59     5   8
\end{verbatim}

\hypertarget{sec-match-set}{%
\subsection{集合操作}\label{sec-match-set}}

match 和 \texttt{\%in\%} \url{https://d.cosx.org/d/421314}

\begin{Shaded}
\begin{Highlighting}[]
\StringTok{\textasciigrave{}}\AttributeTok{\%nin\%}\StringTok{\textasciigrave{}} \OtherTok{\textless{}{-}} \FunctionTok{Negate}\NormalTok{(}\StringTok{\textquotesingle{}\%in\%\textquotesingle{}}\NormalTok{)}
\CommentTok{\# \textasciigrave{}\%in\%\textasciigrave{} \textless{}{-} function(x, table) match(x, table, nomatch = 0) \textgreater{} 0 \# \%in\% 函数的定义}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{]}
\NormalTok{y }\OtherTok{\textless{}{-}}\NormalTok{ letters[}\DecValTok{3}\SpecialCharTok{:}\DecValTok{8}\NormalTok{]}

\NormalTok{x }\SpecialCharTok{\%in\%}\NormalTok{ y}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE FALSE  TRUE  TRUE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{\%nin\%}\NormalTok{ y}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  TRUE  TRUE FALSE FALSE FALSE
\end{verbatim}

返回一个逻辑向量，x 中的元素匹配到了就返回 TRUE，否则 FALSE， \texttt{\%nin\%} 是 \texttt{\%in\%} 的取反效果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{match}\NormalTok{(x,y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA NA  1  2  3
\end{verbatim}

x 在 y 中的匹配情况，匹配到了，就返回在 y 中匹配的位置，没有匹配到就返回 NA

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{setdiff}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a" "b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{intersect}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "c" "d" "e"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{union}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a" "b" "c" "d" "e" "f" "g" "h"
\end{verbatim}

\hypertarget{sec-adm-sessioninfo}{%
\section{运行环境}\label{sec-adm-sessioninfo}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] magrittr_2.0.1    data.table_1.14.2
## 
## loaded via a namespace (and not attached):
##  [1] knitr_1.36       tidyselect_1.1.1 R6_2.5.1         rlang_0.4.11    
##  [5] fastmap_1.1.0    fansi_0.5.0      stringr_1.4.0    dplyr_1.0.7     
##  [9] tools_4.1.1      broom_0.7.9      xfun_0.26        utf8_1.2.2      
## [13] cli_3.0.1        DBI_1.1.1        htmltools_0.5.2  ellipsis_0.3.2  
## [17] assertthat_0.2.1 yaml_2.2.1       digest_0.6.28    tibble_3.1.5    
## [21] lifecycle_1.0.1  crayon_1.4.1     bookdown_0.24    tidyr_1.1.4     
## [25] purrr_0.3.4      vctrs_0.3.8      curl_4.3.2       glue_1.4.2      
## [29] evaluate_0.14    rmarkdown_2.11   stringi_1.7.4    compiler_4.1.1  
## [33] pillar_1.6.3     backports_1.2.1  generics_0.1.0   pkgconfig_2.0.3
\end{verbatim}

\hypertarget{chap-parallel-manipulation}{%
\chapter{并行化操作}\label{chap-parallel-manipulation}}

向量化运算、并行运算和分布式运算

\begin{itemize}
\tightlist
\item
  \href{https://github.com/HenrikBengtsson/future}{future} 在 R 语言中提供统一的并行和分布式处理框架
\item
  \href{https://github.com/HenrikBengtsson/future.apply}{future.apply} 可以替代 base R 提供的 apply 族函数
\item
  \href{https://github.com/HenrikBengtsson/future.batchtools}{future.batchtools} 使用 batchtools 实现并行和分布式处理
\item
  \href{https://github.com/mllg/batchtools}{batchtools} Map 函数的并行实现，用于高性能计算系统和分布式处理，可以单机多核并行也可以多机并行，还提供了一种抽象的机制去定义大规模计算机实验。
\item
  \href{https://github.com/hadley/multidplyr}{multidplyr} 是 dplyr 的后端，多核环境下实现数据分块，提高并行处理性能
\item
  \href{https://github.com/xiaodaigh/disk.frame}{disk.frame} 是基于磁盘的超出内存容量的快速并行数据操作框架
\item
  \href{https://github.com/berndbischl/parallelMap}{parallelMap} R package to interface some popular parallelization back-ends with a unified interface
\item
  \href{https://github.com/jangorecki/big.data.table}{big.data.table} 基于 data.table 的分布式并行计算
\end{itemize}

\hypertarget{apply}{%
\section{apply}\label{apply}}

apply 家族和 \texttt{do.call}

\hypertarget{map-reduce}{%
\section{MapReduce}\label{map-reduce}}

高阶函数，简单来说，就是参数为函数，返回值也是函数。Base R 提供了 \texttt{Reduce} 、\texttt{Filter} 、\texttt{Find} 、\texttt{Map} 、\texttt{Negate} 和 \texttt{Position} 等常用函数，此外还有 \texttt{*apply} 族。

与 \texttt{purrr::map} 比较

在 R 语言里玩转\texttt{apply}， \texttt{Map()} 和 \texttt{Reduce()}\footnote{\url{https://stackoverflow.com/questions/3505701/grouping-functions-tapply-by-aggregate-and-the-apply-family}}，下面分别以提取合并多张 XLSX 表格\footnote{\url{https://trinkerrstuff.wordpress.com/2018/02/14/easily-make-multi-tabbed-xlsx-files-with-openxlsx/}}，分组计算\footnote{\url{https://statcompute.wordpress.com/2018/09/03/playing-map-and-reduce-in-r-by-group-calculation/}} 和子集操作 \footnote{\url{https://statcompute.wordpress.com/2018/09/08/playing-map-and-reduce-in-r-subsetting/}} 为例，从函数式编程到 MapReduce \footnote{\url{https://cartesianfaith.com/2015/09/17/from-functional-programming-to-mapreduce-in-r/}}，制作数据透视表\footnote{\url{https://digitheadslabnotebook.blogspot.com/2010/01/pivot-tables-in-r.html}}，用于数据处理的函数式编程和单元测试 Functional programming and unit testing for data munging with R 特别是第三章 \url{https://b-rodrigues.github.io/fput/}，然后是函数式编程与数据建模 Modeling data with functional programming in R\footnote{\url{https://cartesianfaith.files.wordpress.com/2015/12/rowe-modeling-data-with-functional-programming-in-r.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{add }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{Reduce}\NormalTok{(}\StringTok{"+"}\NormalTok{, x)}
\FunctionTok{add}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{add\_accuml }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{Reduce}\NormalTok{(}\StringTok{"+"}\NormalTok{, x, }\AttributeTok{accumulate =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{add\_accuml}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3 6
\end{verbatim}

\hypertarget{parallel}{%
\section{parallel}\label{parallel}}

\href{https://github.com/ardeeshany/Parallel_Computing}{并行计算小抄} 将共享内存的 R 包整理在一起

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(parallel)}
\end{Highlighting}
\end{Shaded}

\hypertarget{rmpi}{%
\section{Rmpi}\label{rmpi}}

\href{http://fisher.stats.uwo.ca/faculty/yu/Rmpi/}{Rmpi} 由卡尔顿大学的 \href{https://www.uwo.ca/stats/people/bios/hao-yu.html}{Hao Yu} 开发和维护

首先安装 openmpi-devel 开发环境（以 Fedora 30 为例）

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{yum}\NormalTok{ install }\AttributeTok{{-}y}\NormalTok{ openmpi{-}devel}
\BuiltInTok{echo} \StringTok{"export ORTED=/usr/lib64/openmpi/bin"} \OperatorTok{\textgreater{}\textgreater{}}\NormalTok{ \textasciitilde{}/.bashrc}
\CommentTok{\# 或者}
\BuiltInTok{echo} \StringTok{"PATH=/usr/lib64/openmpi/bin:}\VariableTok{$PATH}\StringTok{; export PATH"} \KeywordTok{|} \FunctionTok{tee} \AttributeTok{{-}a}\NormalTok{ \textasciitilde{}/.bashrc}
\BuiltInTok{source}\NormalTok{ \textasciitilde{}/.bashrc}
\end{Highlighting}
\end{Shaded}

然后进入 R 安装 R 包 Rmpi

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}Rmpi\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

使用 Rmpi 包生成两组服从均匀分布的随机数

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载 R 包}
\FunctionTok{library}\NormalTok{(Rmpi)}
\CommentTok{\# 检测可用的逻辑 CPU 核心数}
\NormalTok{parallel}\SpecialCharTok{::}\FunctionTok{detectCores}\NormalTok{()}
\CommentTok{\# 虚拟机分配四个逻辑CPU核 }
\CommentTok{\# 1个 master 2个 worker 主机 cloud}
\FunctionTok{mpi.spawn.Rslaves}\NormalTok{(}\AttributeTok{nslaves=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
#         2 slaves are spawned successfully. 0 failed.
# master (rank 0, comm 1) of size 3 is running on: cloud
# slave1 (rank 1, comm 1) of size 3 is running on: cloud
# slave2 (rank 2, comm 1) of size 3 is running on: cloud
\end{verbatim}

调用 \texttt{mpi.apply} 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\FunctionTok{mpi.apply}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{), runif)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[[1]]
 [1] 0.33684269 0.84638494 0.82776590 0.23707947 0.07593769 0.27981368
 [7] 0.45307675 0.02878214 0.32807421 0.92854275

[[2]]
 [1] 0.63474442 0.04025071 0.01996498 0.01922093 0.41258827 0.84150414
 [7] 0.74705002 0.07635368 0.32807392 0.94570363 0.89187667 0.67069020
[13] 0.92996997 0.22486589 0.22118236 0.15807970 0.65619450 0.16473730
[19] 0.85833484 0.11416449
\end{verbatim}

用完要关闭

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mpi.close.Rslaves}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

pbdMPI 包处于活跃维护状态，是 \href{https://github.com/RBigData}{pbdR 项目} 的核心组件，能够以分布式计算的方式轻松处理 TB 级数据\footnote{2016年国际 R 语言大会上的介绍\url{https://github.com/snoweye/user2016.demo} 和2018年 JSM 会 上的介绍 \url{https://github.com/RBigData/R_JSM2018}}

\href{https://prs.ism.ac.jp/~nakama/Rhpc/}{Rhpc} 包同样基于 MPI 方式，但是集 Rmpi 和 snow 两个包的优点于一身，在保持 apply 编程风格的同时，能够提供更好的高性能计算环境，支持长向量，能够处理一些大数据。

\hypertarget{gpur}{%
\section{gpuR}\label{gpur}}

Charles Determan 开发的 \href{https://github.com/cdeterman/gpuR}{gpuR} 基于 OpenCL 加速，目前处于活跃维护状态。而 Charles Determan 开发的另一个 \href{https://github.com/gpuRcore/gpuRcuda}{gpuRcuda} 包是基于 CUDA 加速

\href{https://github.com/PatricZhao}{赵鹏} 的博客 \href{http://www.parallelr.com/}{ParallelR} 关注基于 \href{https://devblogs.nvidia.com/accelerate-r-applications-cuda/}{CUDA 的 GPU 加速}

此外还有 \href{https://github.com/nullsatz/gputools}{gputools}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gpuR)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{gpuA }\OtherTok{\textless{}{-}} \FunctionTok{gpuMatrix}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{4}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{4}\NormalTok{)}
\NormalTok{gpuA}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
An object of class "fgpuMatrix"
Slot "address":
<pointer: 0x000000000fbe9760>

Slot ".context_index":
[1] 1

Slot ".platform_index":
[1] 1

Slot ".platform":
[1] "Intel(R) OpenCL"

Slot ".device_index":
[1] 1

Slot ".device":
[1] "Intel(R) HD Graphics 4600"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gpuB }\OtherTok{\textless{}{-}}\NormalTok{ gpuA }\SpecialCharTok{\%*\%}\NormalTok{ gpuA}
\FunctionTok{print}\NormalTok{(gpuB)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Source: gpuR Matrix [4 x 4]

            [,1]      [,2]      [,3]       [,4]
[1,]  2.61787200 -1.274909 -2.150301 -2.0073860
[2,] -0.02231596  1.566433  0.986027  0.7339008
[3,] -0.12862393  1.848340  3.261899  1.6919358
[4,] -1.90084898 -1.863014 -1.312350 -0.2553876
\end{verbatim}

\hypertarget{parallel-sessioninfo}{%
\section{运行环境}\label{parallel-sessioninfo}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   base64enc_0.1.3 bookdown_0.24   compiler_4.1.1  curl_4.3.2     
##   digest_0.6.28   evaluate_0.14   fastmap_1.1.0   glue_1.4.2     
##   graphics_4.1.1  grDevices_4.1.1 highr_0.9       htmltools_0.5.2
##   jquerylib_0.1.4 jsonlite_1.7.2  knitr_1.36      magrittr_2.0.1 
##   methods_4.1.1   rlang_0.4.11    rmarkdown_2.11  stats_4.1.1    
##   stringi_1.7.4   stringr_1.4.0   tinytex_0.34    tools_4.1.1    
##   utils_4.1.1     xfun_0.26       yaml_2.2.1
\end{verbatim}

\href{https://stackoverflow.com/questions/10689055}{create-an-empty-data-frame} \href{https://www.datacamp.com/community/tutorials/pipe-r-tutorial}{pipe-r}

\hypertarget{chap-dplyr-manipulation}{%
\chapter{净土化操作}\label{chap-dplyr-manipulation}}

\begin{quote}
常用操作和高频问题需要合并进之前的 data-manipulation，本章只介绍向量化计算 以 dplyr 为核心的 tidyverse 风数据操作 管道风操作
\end{quote}

在不同规模的数据集上，Base R，dplyr 和 data.table 的处理性能应该属于低、中、高档搭配的情形

更加高级的数据变形操作，特别是数据类型的一致性，方便后续的可视化和建模，引入 tidyverse，数据处理或者叫特征工程 Base R vs data.table vs dplyr 它们各有优点，所以都加以介绍 参考 \href{https://jozef.io/categories/rcase4base/}{Jozef Hajnala} 博文。

关于 tidyverse 提供的数据操作不要移动到 Base R 对应的章节，这二者已经越行越远，本章主要讲并行或分布式数据操作工具，如 sparklyr 针对大数据集上的操

Base R 的数据操作的一致性问题参见统计之都帖子 \url{https://d.cosx.org/d/420763}

\href{https://malco.io/}{Malcolm Barrett} 以幻灯片的形式呈现 \href{https://malco.io/slides/hs_dplyr/}{dplyr} 和 \href{https://malco.io/slides/hs_purrr/}{purrr} 的基础用法

Charlotte Wickham 的课程 A introduction to purrr \href{https://github.com/cwickham/purrr-tutorial}{purrr-tutorial}

关于引用 \href{https://github.com/cwickham/quotation}{quotation}

相比于 SQL， dplyr 在数据库操作的不足，这是一些比较难的部分 \url{https://dbi.r-dbi.org/articles/dbi-1\#sec:open-issues}

函数式编程 Functional Programming Languages 用于数据处理

\begin{itemize}
\tightlist
\item
  \href{https://github.com/smartinsightsfromdata/rpivotTable}{rpivotTable} 动态数据透视表
\item
  \href{https://github.com/dgrtwo/fuzzyjoin}{fuzzyjoin} Join tables together on inexact matching
\item
  \href{https://github.com/hadley/dtplyr}{dtplyr} dtplyr is the data.table backend for dplyr. It provides S3 methods for data.table objects so that dplyr works the way you expect.
\item
  \href{https://github.com/yonicd/bplyr}{bplyr} basic dplyr and tidyr functionality without the tidyverse dependencies
\item
  \href{https://github.com/OHDSI/SqlRender}{SqlRender} 基于 Java 语言，借助 rJava 包支持参数化的 SQL 语句，并且可以将一种 SQL 语句（如 Microsoft SQL Server）转化为多种SQL语句（如Oracle, PostgreSQL, Amazon RedShift, Impala, IBM Netezza, Google BigQuery, Microsoft PDW, and SQLite）
\item
  \href{https://github.com/wch/fastmap}{fastmap} 实现键值存储，提供新的数据结构
\item
  \href{https://github.com/RoaringBitmap/CRoaring}{Roaring bitmaps} Bitsets, also called bitmaps, are commonly used as fast data structures.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

数据操作的语法

第一代

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Base R 数据操作已在第 \ref{data-manipulator} 章详细介绍
\end{enumerate}

第二代

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  reshape （退休）使用函数 \texttt{melt} 和 \texttt{cast} 重构(restructure)和聚合(aggregate)数据
\item
  reshape2 （退休）是 reshape 的继任者，功能和 reshape 类似，提供两个函数 \texttt{melt} 和 \texttt{cast} 聚合数据，因此不再介绍 reshape，而鉴于 reshape2 还在活跃使用中，故而以它为例介绍 \texttt{melt} 和 \texttt{cast} 函数
\item
  plyr （退休）统一拆分(split)，计算(apply)，合并(combine)的数据处理流，由 dplyr（用于data.frame） 和 purrr （用于 list）继任
\end{enumerate}

第三代

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  dplyr 操作数据的语法及其扩展
\item
  sparklyr 给 dplyr 提供 Spark 接口支持
\item
  dbplyr 给 dplyr 提供 DBI 数据库接口支持
\item
  dtplyr 给 dplyr 提供 data.table 支持
\item
  tidyr 提供 \texttt{spread} 和 \texttt{gather} 两个函数清洗数据
\end{enumerate}

Garrett Grolemund 在 RStudio 主要从事教育教学，参考 \href{https://github.com/rstudio-education/teach-tidy}{Materials for the Tidyverse Train-the-trainer workshop} 和 \href{https://rstudio-education.github.io/tidyverse-cookbook/}{The Tidyverse Cookbook}

Dirk Eddelbuettel 的 \href{https://github.com/eddelbuettel/gsir-te}{Getting Started in R -- Tinyverse Edition}

\hypertarget{common-operations}{%
\section{常用操作}\label{common-operations}}

dplyr 由 Hadley Wickham 主要由开发和维护，是Rstudio公司开源的用于数据处理的一大利器，该包号称``数据操作的语法''，与 ggplot2 对应，也就是说数据处理那一套已经建立完整的和SQL一样的功能。它们都遵循同样的处理逻辑，只不过一个用SQL写，一个用R语言写，处理效率差不多，R语言写的 SQL 会被翻译为 SQL 语句，再传至数据库查询，当然它也支持内存内的数据操作。目前 dplyr 以 dbplyr 为后端支持的数据库有：MySQL、PostgreSQL，SQLite等，完整的支持列表请看 \href{https://dplyr.tidyverse.org}{这里}，连接特定数据库，都是基于 DBI，DBI 即 Database Interface， 是使用C/C++开发的底层数据库接口，是一个统一的关系型数据库连接框架，需要根据不同的具体的数据库进行实例化，才可使用。

dplyr 常用的函数是 7 个： \texttt{arrange} 排序 \texttt{filter} 过滤行 \texttt{select} 选择列 \texttt{mutate} 变换 \texttt{summarise} 汇总 \texttt{group\_by} 分组 \texttt{distinct} 去重

以 ggplot2 包自带的钻石数据集 diamonds 为例介绍

\hypertarget{tibble-show}{%
\subsection{查看}\label{tibble-show}}

除了直接打印数据集的前几行，tibble 包还提供 glimpse 函数查看数据集，而 Base R 默认查看方式是调用 str 函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 53,940 x 10
##    carat cut       color clarity depth table price     x     y     z
##    <dbl> <ord>     <ord> <ord>   <dbl> <dbl> <int> <dbl> <dbl> <dbl>
##  1  0.23 Ideal     E     SI2      61.5    55   326  3.95  3.98  2.43
##  2  0.21 Premium   E     SI1      59.8    61   326  3.89  3.84  2.31
##  3  0.23 Good      E     VS1      56.9    65   327  4.05  4.07  2.31
##  4  0.29 Premium   I     VS2      62.4    58   334  4.2   4.23  2.63
##  5  0.31 Good      J     SI2      63.3    58   335  4.34  4.35  2.75
##  6  0.24 Very Good J     VVS2     62.8    57   336  3.94  3.96  2.48
##  7  0.24 Very Good I     VVS1     62.3    57   336  3.95  3.98  2.47
##  8  0.26 Very Good H     SI1      61.9    55   337  4.07  4.11  2.53
##  9  0.22 Fair      E     VS2      65.1    61   337  3.87  3.78  2.49
## 10  0.23 Very Good H     VS1      59.4    61   338  4     4.05  2.39
## # ... with 53,930 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{glimpse}\NormalTok{(diamonds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Rows: 53,940
## Columns: 10
## $ carat   <dbl> 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.~
## $ cut     <ord> Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver~
## $ color   <ord> E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,~
## $ clarity <ord> SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, ~
## $ depth   <dbl> 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64~
## $ table   <dbl> 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58~
## $ price   <int> 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34~
## $ x       <dbl> 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.~
## $ y       <dbl> 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.~
## $ z       <dbl> 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.~
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:dplyr-object-type} dplyr 定义的数据对象类型}\tabularnewline
\toprule
类型 & 含义 \\
\midrule
\endfirsthead
\toprule
类型 & 含义 \\
\midrule
\endhead
int & 整型 integer \\
dbl & （单）双精度浮点类型 \\
chr & 字符（串）类型 \\
dttm & data-time 类型 \\
lgl & 布尔类型 \\
fctr & 因子类型 factor \\
date & 日期类型 \\
\bottomrule
\end{longtable}

表 \ref{tab:dplyr-object-type} 中 dttm 和 date 类型代指 lubridate 包指定的日期对象 POSIXct、 POSIXlt、 Date、 chron、 yearmon、 yearqtr、 zoo、 zooreg、 timeDate、 xts、 its、 ti、 jul、 timeSeries 和 fts。

\hypertarget{dplyr-filter}{%
\subsection{筛选}\label{dplyr-filter}}

按条件筛选数据的子集，按行筛选

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(cut }\SpecialCharTok{==} \StringTok{"Ideal"}\NormalTok{ , carat }\SpecialCharTok{\textgreater{}=} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 10
##   carat cut   color clarity depth table price     x     y     z
##   <dbl> <ord> <ord> <ord>   <dbl> <dbl> <int> <dbl> <dbl> <dbl>
## 1  3.22 Ideal I     I1       62.6    55 12545  9.49  9.42  5.92
## 2  3.5  Ideal H     I1       62.8    57 12587  9.65  9.59  6.03
## 3  3.01 Ideal J     SI2      61.7    58 16037  9.25  9.2   5.69
## 4  3.01 Ideal J     I1       65.4    60 16538  8.99  8.93  5.86
\end{verbatim}

先按行，再按列筛选

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(carat }\SpecialCharTok{\textgreater{}=} \DecValTok{3}\NormalTok{, color }\SpecialCharTok{==} \StringTok{"I"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select}\NormalTok{(cut, carat)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 16 x 2
##    cut       carat
##    <ord>     <dbl>
##  1 Premium    3.01
##  2 Fair       3.02
##  3 Good       3   
##  4 Ideal      3.22
##  5 Premium    4.01
##  6 Very Good  3.04
##  7 Very Good  4   
##  8 Premium    3.67
##  9 Premium    3   
## 10 Fair       3   
## 11 Premium    3.01
## 12 Fair       3.01
## 13 Fair       3.01
## 14 Good       3.01
## 15 Good       3.01
## 16 Premium    3.04
\end{verbatim}

\hypertarget{dplyr-arrange}{%
\subsection{排序}\label{dplyr-arrange}}

arrange 默认升序排列，按钻石重量升序，按价格降序

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(cut }\SpecialCharTok{==} \StringTok{"Ideal"}\NormalTok{ , carat }\SpecialCharTok{\textgreater{}=} \DecValTok{3}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{arrange}\NormalTok{(carat, }\FunctionTok{desc}\NormalTok{(price))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 10
##   carat cut   color clarity depth table price     x     y     z
##   <dbl> <ord> <ord> <ord>   <dbl> <dbl> <int> <dbl> <dbl> <dbl>
## 1  3.01 Ideal J     I1       65.4    60 16538  8.99  8.93  5.86
## 2  3.01 Ideal J     SI2      61.7    58 16037  9.25  9.2   5.69
## 3  3.22 Ideal I     I1       62.6    55 12545  9.49  9.42  5.92
## 4  3.5  Ideal H     I1       62.8    57 12587  9.65  9.59  6.03
\end{verbatim}

\hypertarget{dplyr-summarise}{%
\subsection{聚合}\label{dplyr-summarise}}

分组求和，求平均，计数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(carat }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{, color }\SpecialCharTok{==} \StringTok{"I"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{group\_by}\NormalTok{(cut, clarity) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{sum\_carat =} \FunctionTok{sum}\NormalTok{(carat), }\AttributeTok{mean\_carat =} \FunctionTok{mean}\NormalTok{(carat), }\AttributeTok{n\_count =} \FunctionTok{n}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 8 x 5
## # Groups:   cut [5]
##   cut       clarity sum_carat mean_carat n_count
##   <ord>     <ord>       <dbl>      <dbl>   <int>
## 1 Fair      I1           3.02       3.02       1
## 2 Fair      SI2          6.02       3.01       2
## 3 Good      SI2          6.02       3.01       2
## 4 Very Good I1           4          4          1
## 5 Very Good SI2          3.04       3.04       1
## 6 Premium   I1          10.7        3.56       3
## 7 Premium   SI2          6.05       3.02       2
## 8 Ideal     I1           3.22       3.22       1
\end{verbatim}

\hypertarget{dplyr-merge}{%
\subsection{合并}\label{dplyr-merge}}

按行合并

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2018}\NormalTok{)}
\NormalTok{one }\OtherTok{\textless{}{-}}\NormalTok{ diamonds }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(color }\SpecialCharTok{==} \StringTok{"I"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\NormalTok{two }\OtherTok{\textless{}{-}}\NormalTok{ diamonds }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(color }\SpecialCharTok{==} \StringTok{"J"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\CommentTok{\# 按行合并数据框 one 和 two}
\FunctionTok{bind\_rows}\NormalTok{(one, two)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 10 x 10
##    carat cut       color clarity depth table price     x     y     z
##    <dbl> <ord>     <ord> <ord>   <dbl> <dbl> <int> <dbl> <dbl> <dbl>
##  1  0.42 Ideal     I     VVS1     62.5  57     884  4.77  4.8   2.99
##  2  0.3  Ideal     I     VVS2     62.5  53.6   532  4.29  4.33  2.69
##  3  2.02 Good      I     VS1      57.9  63   17533  8.13  8.21  4.73
##  4  0.9  Premium   I     VS2      61.9  58    3398  6.18  6.23  3.84
##  5  1.98 Very Good I     VS2      62.7  60   15083  7.9   7.96  4.98
##  6  1.51 Very Good J     VVS2     62.6  63    8706  7.29  7.24  4.55
##  7  0.7  Very Good J     SI1      61.7  57    1979  5.65  5.69  3.5 
##  8  1.16 Premium   J     VS2      62.2  59    4702  6.74  6.69  4.18
##  9  1.5  Premium   J     VVS2     61.8  60    8760  7.36  7.33  4.54
## 10  1.51 Premium   J     SI1      60.4  62    6680  7.42  7.32  4.45
\end{verbatim}

按列合并

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2018}\NormalTok{)}
\NormalTok{three }\OtherTok{\textless{}{-}}\NormalTok{ diamonds }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select}\NormalTok{(carat, color) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\NormalTok{four }\OtherTok{\textless{}{-}}\NormalTok{ diamonds }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select}\NormalTok{(carat, color) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\FunctionTok{bind\_cols}\NormalTok{(three, four)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 4
##   carat...1 color...2 carat...3 color...4
##       <dbl> <ord>         <dbl> <ord>    
## 1      0.33 H              0.52 F        
## 2      1.09 F              0.51 F        
## 3      1.52 I              0.5  G        
## 4      0.95 G              0.38 E        
## 5      0.35 E              0.51 J
\end{verbatim}

\hypertarget{dplyr-mutate}{%
\subsection{变换}\label{dplyr-mutate}}

添加一列，新的列或者改变原来的列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(carat }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{, color }\SpecialCharTok{==} \StringTok{"I"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select}\NormalTok{(cut, carat) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{vol =} \FunctionTok{if\_else}\NormalTok{(carat }\SpecialCharTok{\textgreater{}} \FloatTok{3.5}\NormalTok{, }\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 13 x 3
##    cut       carat vol  
##    <ord>     <dbl> <chr>
##  1 Premium    3.01 B    
##  2 Fair       3.02 B    
##  3 Ideal      3.22 B    
##  4 Premium    4.01 A    
##  5 Very Good  3.04 B    
##  6 Very Good  4    A    
##  7 Premium    3.67 A    
##  8 Premium    3.01 B    
##  9 Fair       3.01 B    
## 10 Fair       3.01 B    
## 11 Good       3.01 B    
## 12 Good       3.01 B    
## 13 Premium    3.04 B
\end{verbatim}

\hypertarget{dplyr-duplicated}{%
\subsection{去重}\label{dplyr-duplicated}}

数据去重在 dplyr 中的实现\footnote{\url{https://stackoverflow.com/questions/22959635/}}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{y =} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{z =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}
\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y  z
## 1  0 1  1
## 2  0 1  2
## 3  0 1  3
## 4  1 0  4
## 5  0 1  5
## 6  1 0  6
## 7  1 1  7
## 8  1 0  8
## 9  0 0  9
## 10 0 0 10
\end{verbatim}

去掉列重复的数据点 (x, y)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(x, y) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{row\_number}\NormalTok{(z) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 3
## # Groups:   x, y [4]
##       x     y     z
##   <int> <int> <int>
## 1     0     1     1
## 2     1     0     4
## 3     1     1     7
## 4     0     0     9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 此处不对，没有了 z }
\NormalTok{df }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   x y
## 1 0 1
## 2 1 0
## 3 1 1
## 4 0 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 应该为}
\NormalTok{df }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{(x, y, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   x y z
## 1 0 1 1
## 2 1 0 4
## 3 1 1 7
## 4 0 0 9
\end{verbatim}

\hypertarget{common-dataframe-operations}{%
\section{高频问题}\label{common-dataframe-operations}}

常用的数据操作包含

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  创建空的数据框或者说初始化一个数据框，
\item
  按指定的列对数据框排序，
\item
  选择特定的一些列，复杂情况是可能需要正则表达式从列名或者值中筛选
\item
  合并两个数据框，分为 (inner outer left right) 四种情况
\item
  宽格式和长格式互相转换，即重塑操作 reshape，单独的 tidyr 包操作，是 reshape2 包的进化版，提供 \texttt{spread} 和 \texttt{gather} 两个主要函数
\end{enumerate}

\hypertarget{create-empty-dataframe}{%
\subsection{初始化数据框}\label{create-empty-dataframe}}

创建空的数据框，就是不包含任何行、记录

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{empty\_df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Doubles =} \FunctionTok{double}\NormalTok{(),}
  \AttributeTok{Ints =} \FunctionTok{integer}\NormalTok{(),}
  \AttributeTok{Factors =} \FunctionTok{factor}\NormalTok{(),}
  \AttributeTok{Logicals =} \FunctionTok{logical}\NormalTok{(),}
  \AttributeTok{Characters =} \FunctionTok{character}\NormalTok{(),}
  \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{str}\NormalTok{(empty\_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    0 obs. of  5 variables:
##  $ Doubles   : num 
##  $ Ints      : int 
##  $ Factors   : Factor w/ 0 levels: 
##  $ Logicals  : logi 
##  $ Characters: chr
\end{verbatim}

如果数据框 df 包含数据，现在要依据它创建一个空的数据框

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{empty\_df }\OtherTok{=}\NormalTok{ df[}\ConstantTok{FALSE}\NormalTok{,]}
\end{Highlighting}
\end{Shaded}

还可以使用 structure 构造一个数据框，并且我们发现它的效率更高

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() }\FunctionTok{structure}\NormalTok{(}\FunctionTok{list}\NormalTok{(}
    \AttributeTok{Date =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{character}\NormalTok{()),}
    \AttributeTok{File =} \FunctionTok{character}\NormalTok{(),}
    \AttributeTok{User =} \FunctionTok{character}\NormalTok{()}
\NormalTok{  ),}
  \AttributeTok{class =} \StringTok{"data.frame"}
\NormalTok{  )}
\NormalTok{d }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() }\FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{Date =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{character}\NormalTok{()),}
    \AttributeTok{File =} \FunctionTok{character}\NormalTok{(),}
    \AttributeTok{User =} \FunctionTok{character}\NormalTok{(),}
    \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{  )}
\NormalTok{microbenchmark}\SpecialCharTok{::}\FunctionTok{microbenchmark}\NormalTok{(}\FunctionTok{s}\NormalTok{(), }\FunctionTok{d}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Unit: microseconds
##  expr   min     lq    mean median     uq    max neval
##   s()  19.6  22.50  61.094  27.35  31.35 3165.2   100
##   d() 210.3 214.75 247.504 217.00 221.80 2797.8   100
\end{verbatim}

\hypertarget{remove-missing-values}{%
\subsection{移除缺失记录}\label{remove-missing-values}}

只要行中包含缺失值，我们就把这样的行移除出去

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality[}\FunctionTok{complete.cases}\NormalTok{(airquality), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Ozone Solar.R Wind Temp Month Day
## 1      41     190  7.4   67     5   1
## 2      36     118  8.0   72     5   2
## 3      12     149 12.6   74     5   3
## 4      18     313 11.5   62     5   4
## 7      23     299  8.6   65     5   7
## 8      19      99 13.8   59     5   8
## 9       8      19 20.1   61     5   9
## 12     16     256  9.7   69     5  12
## 13     11     290  9.2   66     5  13
## 14     14     274 10.9   68     5  14
## 15     18      65 13.2   58     5  15
## 16     14     334 11.5   64     5  16
## 17     34     307 12.0   66     5  17
## 18      6      78 18.4   57     5  18
## 19     30     322 11.5   68     5  19
## 20     11      44  9.7   62     5  20
## 21      1       8  9.7   59     5  21
## 22     11     320 16.6   73     5  22
## 23      4      25  9.7   61     5  23
## 24     32      92 12.0   61     5  24
## 28     23      13 12.0   67     5  28
## 29     45     252 14.9   81     5  29
## 30    115     223  5.7   79     5  30
## 31     37     279  7.4   76     5  31
## 38     29     127  9.7   82     6   7
## 40     71     291 13.8   90     6   9
## 41     39     323 11.5   87     6  10
## 44     23     148  8.0   82     6  13
## 47     21     191 14.9   77     6  16
## 48     37     284 20.7   72     6  17
## 49     20      37  9.2   65     6  18
## 50     12     120 11.5   73     6  19
## 51     13     137 10.3   76     6  20
## 62    135     269  4.1   84     7   1
## 63     49     248  9.2   85     7   2
## 64     32     236  9.2   81     7   3
## 66     64     175  4.6   83     7   5
## 67     40     314 10.9   83     7   6
## 68     77     276  5.1   88     7   7
## 69     97     267  6.3   92     7   8
## 70     97     272  5.7   92     7   9
## 71     85     175  7.4   89     7  10
## 73     10     264 14.3   73     7  12
## 74     27     175 14.9   81     7  13
## 76      7      48 14.3   80     7  15
## 77     48     260  6.9   81     7  16
## 78     35     274 10.3   82     7  17
## 79     61     285  6.3   84     7  18
## 80     79     187  5.1   87     7  19
## 81     63     220 11.5   85     7  20
## 82     16       7  6.9   74     7  21
## 85     80     294  8.6   86     7  24
## 86    108     223  8.0   85     7  25
## 87     20      81  8.6   82     7  26
## 88     52      82 12.0   86     7  27
## 89     82     213  7.4   88     7  28
## 90     50     275  7.4   86     7  29
## 91     64     253  7.4   83     7  30
## 92     59     254  9.2   81     7  31
## 93     39      83  6.9   81     8   1
## 94      9      24 13.8   81     8   2
## 95     16      77  7.4   82     8   3
## 99    122     255  4.0   89     8   7
## 100    89     229 10.3   90     8   8
## 101   110     207  8.0   90     8   9
## 104    44     192 11.5   86     8  12
## 105    28     273 11.5   82     8  13
## 106    65     157  9.7   80     8  14
## 108    22      71 10.3   77     8  16
## 109    59      51  6.3   79     8  17
## 110    23     115  7.4   76     8  18
## 111    31     244 10.9   78     8  19
## 112    44     190 10.3   78     8  20
## 113    21     259 15.5   77     8  21
## 114     9      36 14.3   72     8  22
## 116    45     212  9.7   79     8  24
## 117   168     238  3.4   81     8  25
## 118    73     215  8.0   86     8  26
## 120    76     203  9.7   97     8  28
## 121   118     225  2.3   94     8  29
## 122    84     237  6.3   96     8  30
## 123    85     188  6.3   94     8  31
## 124    96     167  6.9   91     9   1
## 125    78     197  5.1   92     9   2
## 126    73     183  2.8   93     9   3
## 127    91     189  4.6   93     9   4
## 128    47      95  7.4   87     9   5
## 129    32      92 15.5   84     9   6
## 130    20     252 10.9   80     9   7
## 131    23     220 10.3   78     9   8
## 132    21     230 10.9   75     9   9
## 133    24     259  9.7   73     9  10
## 134    44     236 14.9   81     9  11
## 135    21     259 15.5   76     9  12
## 136    28     238  6.3   77     9  13
## 137     9      24 10.9   71     9  14
## 138    13     112 11.5   71     9  15
## 139    46     237  6.9   78     9  16
## 140    18     224 13.8   67     9  17
## 141    13      27 10.3   76     9  18
## 142    24     238 10.3   68     9  19
## 143    16     201  8.0   82     9  20
## 144    13     238 12.6   64     9  21
## 145    23      14  9.2   71     9  22
## 146    36     139 10.3   81     9  23
## 147     7      49 10.3   69     9  24
## 148    14      20 16.6   63     9  25
## 149    30     193  6.9   70     9  26
## 151    14     191 14.3   75     9  28
## 152    18     131  8.0   76     9  29
## 153    20     223 11.5   68     9  30
\end{verbatim}

\hypertarget{coerce-data-type}{%
\subsection{数据类型转化}\label{coerce-data-type}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    30 obs. of  2 variables:
##  $ weight: num  4.17 5.58 5.18 6.11 4.5 4.61 5.17 4.53 5.33 5.14 ...
##  $ group : Factor w/ 3 levels "ctrl","trt1",..: 1 1 1 1 1 1 1 1 1 1 ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bob }\OtherTok{\textless{}{-}}\NormalTok{ PlantGrowth}
\NormalTok{i }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(bob, is.factor)}
\NormalTok{bob[i] }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(bob[i], as.character)}
\FunctionTok{str}\NormalTok{(bob)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    30 obs. of  2 variables:
##  $ weight: num  4.17 5.58 5.18 6.11 4.5 4.61 5.17 4.53 5.33 5.14 ...
##  $ group : chr  "ctrl" "ctrl" "ctrl" "ctrl" ...
\end{verbatim}

\hypertarget{cross-group-by}{%
\subsection{跨列分组求和}\label{cross-group-by}}

输入是一个数据框 data.frame，按照其中某一变量分组，然后计算任意数量的变量的行和和列和。

空气质量数据集 airquality 按月份 Month 分组，然后求取满足条件的列的和

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Reduce}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(}\FunctionTok{unique}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Month), }\ControlFlowTok{function}\NormalTok{(gv) \{}
\NormalTok{  subdta }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(airquality, }\AttributeTok{subset =}\NormalTok{ Month }\SpecialCharTok{==}\NormalTok{ gv)}
  \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{Colsum =} \FunctionTok{as.numeric}\NormalTok{(}
      \FunctionTok{colSums}\NormalTok{(subdta[, }\FunctionTok{grepl}\NormalTok{(}\StringTok{"[mM]"}\NormalTok{, }\FunctionTok{names}\NormalTok{(airquality))], }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{Month =}\NormalTok{ gv}
\NormalTok{  )}
\NormalTok{\}))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Colsum Month
## 1    2032     5
## 2     155     5
## 3    2373     6
## 4     180     6
## 5    2601     7
## 6     217     7
## 7    2603     8
## 8     248     8
## 9    2307     9
## 10    270     9
\end{verbatim}

什么是函数式编程，R 语言环境下的函数式编程是如何操作的

\hypertarget{pipe-manipulation}{%
\section{管道操作}\label{pipe-manipulation}}

\href{http://stefanbache.dk/}{Stefan Milton Bache} 开发了 \href{https://github.com/tidyverse/magrittr}{magrittr} 包实现管道操作，增加代码的可读性和维护性，但是这个 R 包的名字取的太奇葩，因为 \href{https://d.cosx.org/d/420697/21}{记不住}，它其实是一个复杂的\href{https://magrittr.tidyverse.org/articles/magrittr.html}{法语发音}，中式英语就叫它马格里特吧！这下应该好记多了吧！

我要查看是否需要新添加一个 R 包依赖，假设该 R 包是 reticulate 没有出现在 DESCRIPTION 文件中，但是可能已经被其中某（个）些 R 包依赖了

\begin{Shaded}
\begin{Highlighting}[]
\StringTok{"reticulate"} \SpecialCharTok{\%in\%} \FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(desc}\SpecialCharTok{::}\FunctionTok{desc\_get\_deps}\NormalTok{()}\SpecialCharTok{$}\NormalTok{package, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{))))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

安装 pkg 的依赖

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pkg }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"bookdown"}\NormalTok{,}
  \StringTok{"e1071"}\NormalTok{,}
  \StringTok{"formatR"}\NormalTok{,}
  \StringTok{"lme4"}\NormalTok{,}
  \StringTok{"mvtnorm"}\NormalTok{,}
  \StringTok{"prettydoc"}\NormalTok{, }\StringTok{"psych"}\NormalTok{,}
  \StringTok{"reticulate"}\NormalTok{, }\StringTok{"rstan"}\NormalTok{, }\StringTok{"rstanarm"}\NormalTok{, }\StringTok{"rticles"}\NormalTok{,}
  \StringTok{"svglite"}\NormalTok{,}
  \StringTok{"TMB"}\NormalTok{, }\StringTok{"glmmTMB"}
\NormalTok{)}
\CommentTok{\# 获取 pkg 的所有依赖}
\NormalTok{dep\_pkg }\OtherTok{\textless{}{-}}\NormalTok{ tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(pkg, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 将列表 list 合并为向量 vector}
\NormalTok{merge\_pkg }\OtherTok{\textless{}{-}} \FunctionTok{Reduce}\NormalTok{(}\StringTok{"c"}\NormalTok{, dep\_pkg, }\AttributeTok{accumulate =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# 所有未安装的 R 包}
\NormalTok{miss\_pkg }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{unique}\NormalTok{(merge\_pkg), }\FunctionTok{unique}\NormalTok{(}\FunctionTok{.packages}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)))}
\CommentTok{\# 除了 pkg 外，未安装的 R 包，安装 pkg 的依赖}
\FunctionTok{sort}\NormalTok{(}\FunctionTok{setdiff}\NormalTok{(miss\_pkg, pkg))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## character(0)
\end{verbatim}

转化为管道操作，增加可读性

\begin{quote}
再举一个关于数据模拟的例子
\end{quote}

模拟 0-1 序列，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{binom\_sample }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n) \{}
  \FunctionTok{sum}\NormalTok{(}\FunctionTok{sample}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\AttributeTok{size =}\NormalTok{ n, }\AttributeTok{prob =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\FloatTok{0.2}\NormalTok{), }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{))}\SpecialCharTok{/}\NormalTok{n}
\NormalTok{\}}
\CommentTok{\# 频率估计概率}
\NormalTok{one\_prob }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{8}\NormalTok{)), binom\_sample)}
\CommentTok{\# 估计的误差}
\NormalTok{one\_abs }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(one\_prob }\SpecialCharTok{{-}} \FloatTok{0.2}\NormalTok{)}
\NormalTok{one\_abs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.000e-01 1.000e-02 1.100e-02 4.400e-03 1.460e-03 3.980e-04 4.700e-06
## [8] 9.552e-05
\end{verbatim}

似然估计

\hypertarget{dm-dplyr-rsession}{%
\section{运行环境}\label{dm-dplyr-rsession}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   askpass_1.1          assertthat_0.2.1     backports_1.2.1     
##   base64enc_0.1.3      bit_4.0.4            bit64_4.0.5         
##   blob_1.2.2           bookdown_0.24        broom_0.7.9         
##   callr_3.7.0          cellranger_1.1.0     cli_3.0.1           
##   clipr_0.7.1          colorspace_2.0-2     compiler_4.1.1      
##   cpp11_0.4.0          crayon_1.4.1         curl_4.3.2          
##   data.table_1.14.2    DBI_1.1.1            dbplyr_2.1.1        
##   desc_1.4.0           digest_0.6.28        dplyr_1.0.7         
##   dtplyr_1.1.0         ellipsis_0.3.2       evaluate_0.14       
##   fansi_0.5.0          farver_2.1.0         fastmap_1.1.0       
##   forcats_0.5.1        fs_1.5.0             gargle_1.2.0        
##   generics_0.1.0       ggplot2_3.3.5        glue_1.4.2          
##   googledrive_2.0.0    googlesheets4_1.0.0  graphics_4.1.1      
##   grDevices_4.1.1      grid_4.1.1           gtable_0.3.0        
##   haven_2.4.3          highr_0.9            hms_1.1.1           
##   htmltools_0.5.2      httr_1.4.2           ids_1.0.1           
##   isoband_0.2.5        jquerylib_0.1.4      jsonlite_1.7.2      
##   knitr_1.36           labeling_0.4.2       lattice_0.20.45     
##   lifecycle_1.0.1      lubridate_1.7.10     magrittr_2.0.1      
##   MASS_7.3.54          Matrix_1.3.4         methods_4.1.1       
##   mgcv_1.8.37          microbenchmark_1.4-7 mime_0.12           
##   modelr_0.1.8         munsell_0.5.0        nlme_3.1.153        
##   openssl_1.4.5        pillar_1.6.3         pkgconfig_2.0.3     
##   prettyunits_1.1.1    processx_3.5.2       progress_1.2.2      
##   ps_1.6.0             purrr_0.3.4          R6_2.5.1            
##   rappdirs_0.3.3       RColorBrewer_1.1.2   Rcpp_1.0.7          
##   readr_2.0.2          readxl_1.3.1         rematch_1.0.1       
##   rematch2_2.1.2       reprex_2.0.1         rlang_0.4.11        
##   rmarkdown_2.11       rprojroot_2.0.2      rstudioapi_0.13     
##   rvest_1.0.1          scales_1.1.1         selectr_0.4.2       
##   splines_4.1.1        stats_4.1.1          stringi_1.7.4       
##   stringr_1.4.0        sys_3.4              tibble_3.1.5        
##   tidyr_1.1.4          tidyselect_1.1.1     tidyverse_1.3.1     
##   tinytex_0.34         tools_4.1.1          tzdb_0.1.2          
##   utf8_1.2.2           utils_4.1.1          uuid_0.1.4          
##   vctrs_0.3.8          viridisLite_0.4.0    vroom_1.5.5         
##   withr_2.4.2          xfun_0.26            xml2_1.3.2          
##   yaml_2.2.1
\end{verbatim}

\hypertarget{part-ux7edfux8ba1ux56feux5f62}{%
\part{统计图形}\label{part-ux7edfux8ba1ux56feux5f62}}

\hypertarget{chap-statistical-graphics}{%
\chapter*{介绍}\label{chap-statistical-graphics}}
\addcontentsline{toc}{chapter}{介绍}

统计图形

\hypertarget{chap-graphics-foundations}{%
\chapter{图形基础}\label{chap-graphics-foundations}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(survival)}
\FunctionTok{library}\NormalTok{(lattice)}
\FunctionTok{library}\NormalTok{(nlme)}
\FunctionTok{library}\NormalTok{(MASS)}
\FunctionTok{library}\NormalTok{(RColorBrewer)}
\FunctionTok{library}\NormalTok{(latticeExtra)}
\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{library}\NormalTok{(splines)}
\FunctionTok{library}\NormalTok{(mgcv)}
\FunctionTok{library}\NormalTok{(maps)}
\FunctionTok{library}\NormalTok{(mapproj)}
\end{Highlighting}
\end{Shaded}

数据可视化是一种重要的数据分析手段， R 提供了两套图形系统，分别是 graphics 包提供的基础绘图系统和 grid 包提供的栅格绘图系统，后者主要以两个 R 包为大家所熟知，一个是 lattice 包，另一个是 ggplot2 包。

Base 图形系统的扩展包 \href{https://github.com/KKPMW/basetheme}{basetheme} 可以设置主题，\href{https://github.com/jumpingrivers/prettyB}{prettyB} 和 \href{https://github.com/pmur002/gridgraphics}{gridGraphics}

为了方便记忆函数 \texttt{par} 的各个参数，Paul Murrell 整理了一份 \href{https://www.stat.auckland.ac.nz/~paul/R/parMemnonics.html}{助记符}，此外，LaTeX 宏包 \href{https://github.com/latexstudio/LaTeXPackages-CN}{geometry} 对版面设置有很多专业的说明

\hypertarget{graphics-elements}{%
\section{绘图基本要素}\label{graphics-elements}}

\hypertarget{base-points}{%
\subsection{点线}\label{base-points}}

点和线是最常见的画图元素，在 \texttt{plot} 函数中，分别用参数 \texttt{pch} 和 \texttt{lty} 来设定类型，点的大小、线的宽度分别用参数 \texttt{cex} 和 \texttt{lwd} 来指定，颜色由参数 \texttt{col} 设置。参数 \texttt{type} 不同的值设置如下，\texttt{p} 显示点，\texttt{l} 绘制线，\texttt{b} 同时绘制空心点，并用线连接，\texttt{c} 只有线，\texttt{o} 在线上绘制点，\texttt{s} 和 \texttt{S} 点线连接绘制阶梯图，\texttt{h} 绘制类似直方图一样的垂线，最后 \texttt{n} 表示什么也不画。

点 points 、线 grid 背景线 abline lines rug 刻度线（线段segments、箭头arrows）、

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-} Showing all the extra \& some char graphics symbols {-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{pchShow }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{extras =} \FunctionTok{c}\NormalTok{(}\StringTok{"*"}\NormalTok{, }\StringTok{"."}\NormalTok{, }\StringTok{"o"}\NormalTok{, }\StringTok{"O"}\NormalTok{, }\StringTok{"0"}\NormalTok{, }\StringTok{"+"}\NormalTok{, }\StringTok{"{-}"}\NormalTok{, }\StringTok{"|"}\NormalTok{, }\StringTok{"\%"}\NormalTok{, }\StringTok{"\#"}\NormalTok{),}
             \AttributeTok{cex =} \DecValTok{2}\NormalTok{, }\DocumentationTok{\#\# good for both .Device=="postscript" and "x11"}
             \AttributeTok{col =} \StringTok{"red3"}\NormalTok{, }\AttributeTok{bg =} \StringTok{"gold"}\NormalTok{, }\AttributeTok{coltext =} \StringTok{"brown"}\NormalTok{, }\AttributeTok{cextext =} \FloatTok{1.2}\NormalTok{,}
             \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}
               \StringTok{"plot symbols :  points (...  pch = *, cex ="}\NormalTok{,}
\NormalTok{               cex, }\StringTok{")"}
\NormalTok{             )) \{}
\NormalTok{    nex }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(extras)}
\NormalTok{    np }\OtherTok{\textless{}{-}} \DecValTok{26} \SpecialCharTok{+}\NormalTok{ nex}
\NormalTok{    ipch }\OtherTok{\textless{}{-}} \DecValTok{0}\SpecialCharTok{:}\NormalTok{(np }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{    k }\OtherTok{\textless{}{-}} \FunctionTok{floor}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(np))}
\NormalTok{    dd }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{    rx }\OtherTok{\textless{}{-}}\NormalTok{ dd }\SpecialCharTok{+} \FunctionTok{range}\NormalTok{(ix }\OtherTok{\textless{}{-}}\NormalTok{ ipch }\SpecialCharTok{\%/\%}\NormalTok{ k)}
\NormalTok{    ry }\OtherTok{\textless{}{-}}\NormalTok{ dd }\SpecialCharTok{+} \FunctionTok{range}\NormalTok{(iy }\OtherTok{\textless{}{-}} \DecValTok{3} \SpecialCharTok{+}\NormalTok{ (k }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{{-}}\NormalTok{ ipch }\SpecialCharTok{\%\%}\NormalTok{ k)}
\NormalTok{    pch }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(ipch) }\CommentTok{\# list with integers \& strings}
    \ControlFlowTok{if}\NormalTok{ (nex }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) pch[}\DecValTok{26} \SpecialCharTok{+} \DecValTok{1}\SpecialCharTok{:}\NormalTok{nex] }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(extras)}
    \FunctionTok{plot}\NormalTok{(rx, ry, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =}\NormalTok{ main)}
    \FunctionTok{abline}\NormalTok{(}\AttributeTok{v =}\NormalTok{ ix, }\AttributeTok{h =}\NormalTok{ iy, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{, }\AttributeTok{lty =} \StringTok{"dotted"}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{np) \{}
\NormalTok{      pc }\OtherTok{\textless{}{-}}\NormalTok{ pch[[i]]}
      \DocumentationTok{\#\# \textquotesingle{}col\textquotesingle{} symbols with a \textquotesingle{}bg\textquotesingle{}{-}colored interior (where available) :}
      \FunctionTok{points}\NormalTok{(ix[i], iy[i], }\AttributeTok{pch =}\NormalTok{ pc, }\AttributeTok{col =}\NormalTok{ col, }\AttributeTok{bg =}\NormalTok{ bg, }\AttributeTok{cex =}\NormalTok{ cex)}
      \ControlFlowTok{if}\NormalTok{ (cextext }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
        \FunctionTok{text}\NormalTok{(ix[i] }\SpecialCharTok{{-}} \FloatTok{0.3}\NormalTok{, iy[i], pc, }\AttributeTok{col =}\NormalTok{ coltext, }\AttributeTok{cex =}\NormalTok{ cextext)}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}

\FunctionTok{pchShow}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-2-1} 

}

\caption{不同的 pch 参数值}\label{fig:unnamed-chunk-2}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} test code for various pch specifications {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Try this in various font families (including Hershey)}
\CommentTok{\# and locales.  Use sign = {-}1 asserts we want Latin{-}1.}
\CommentTok{\# Standard cases in a MBCS locale will not plot the top half.}
\NormalTok{TestChars }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{sign =} \DecValTok{1}\NormalTok{, }\AttributeTok{font =} \DecValTok{1}\NormalTok{, ...) \{}
\NormalTok{  MB }\OtherTok{\textless{}{-}} \FunctionTok{l10n\_info}\NormalTok{()}\SpecialCharTok{$}\NormalTok{MBCS}
\NormalTok{  r }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (font }\SpecialCharTok{==} \DecValTok{5}\NormalTok{) \{}
\NormalTok{    sign }\OtherTok{\textless{}{-}} \DecValTok{1}
    \FunctionTok{c}\NormalTok{(}\DecValTok{32}\SpecialCharTok{:}\DecValTok{126}\NormalTok{, }\DecValTok{160}\SpecialCharTok{:}\DecValTok{254}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (MB) }\DecValTok{32}\SpecialCharTok{:}\DecValTok{126} \ControlFlowTok{else} \DecValTok{32}\SpecialCharTok{:}\DecValTok{255}
  \ControlFlowTok{if}\NormalTok{ (sign }\SpecialCharTok{==} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) r }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{32}\SpecialCharTok{:}\DecValTok{126}\NormalTok{, }\DecValTok{160}\SpecialCharTok{:}\DecValTok{255}\NormalTok{)}
  \FunctionTok{par}\NormalTok{(}\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{16}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{16}\NormalTok{),}
    \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
    \AttributeTok{xaxs =} \StringTok{"i"}\NormalTok{, }\AttributeTok{yaxs =} \StringTok{"i"}\NormalTok{,}
    \AttributeTok{main =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"sign = \%d, font = \%d"}\NormalTok{, sign, font)}
\NormalTok{  )}
  \FunctionTok{grid}\NormalTok{(}\DecValTok{17}\NormalTok{, }\DecValTok{17}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{)}
  \FunctionTok{mtext}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"MBCS:"}\NormalTok{, MB))}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in}\NormalTok{ r) }\FunctionTok{try}\NormalTok{(}\FunctionTok{points}\NormalTok{(i }\SpecialCharTok{\%\%} \DecValTok{16}\NormalTok{, i }\SpecialCharTok{\%/\%} \DecValTok{16}\NormalTok{, }\AttributeTok{pch =}\NormalTok{ sign }\SpecialCharTok{*}\NormalTok{ i, }\AttributeTok{font =}\NormalTok{ font, ...))}
\NormalTok{\}}
\FunctionTok{TestChars}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-3-1} 

}

\caption{pch 支持的字符}\label{fig:unnamed-chunk-3-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{try}\NormalTok{(}\FunctionTok{TestChars}\NormalTok{(}\AttributeTok{sign =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-3-2} 

}

\caption{pch 支持的字符}\label{fig:unnamed-chunk-3-2}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{TestChars}\NormalTok{(}\AttributeTok{font =} \DecValTok{5}\NormalTok{) }\CommentTok{\# Euro might be at 160 (0+10*16).}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-3-3} 

}

\caption{pch 支持的字符}\label{fig:unnamed-chunk-3-3}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# macOS has apple at 240 (0+15*16).}
\FunctionTok{try}\NormalTok{(}\FunctionTok{TestChars}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{font =} \DecValTok{2}\NormalTok{)) }\CommentTok{\# bold}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-3-4} 

}

\caption{pch 支持的字符}\label{fig:unnamed-chunk-3-4}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{0}\SpecialCharTok{:}\DecValTok{12}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(pi }\SpecialCharTok{/} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ x)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{mar =}\NormalTok{ .}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\ControlFlowTok{for}\NormalTok{ (tp }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\StringTok{"p"}\NormalTok{, }\StringTok{"l"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{"o"}\NormalTok{, }\StringTok{"h"}\NormalTok{, }\StringTok{"s"}\NormalTok{, }\StringTok{"S"}\NormalTok{, }\StringTok{"n"}\NormalTok{)) \{}
  \FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =}\NormalTok{ tp, }\AttributeTok{main =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"plot(*, type = }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, tp, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{)"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (tp }\SpecialCharTok{==} \StringTok{"S"}\NormalTok{) \{}
    \FunctionTok{lines}\NormalTok{(x, y, }\AttributeTok{type =} \StringTok{"s"}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
    \FunctionTok{mtext}\NormalTok{(}\StringTok{"lines(*, type = }\SpecialCharTok{\textbackslash{}"}\StringTok{s}\SpecialCharTok{\textbackslash{}"}\StringTok{, ...)"}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.8}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-4-1} 

}

\caption{不同的 type 参数值}\label{fig:unnamed-chunk-4}
\end{figure}

颜色 col 连续型和离散型

线帽/端和字体的样式

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 合并为一个图 三条粗横线 横线上三种字形}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{20}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{20}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{15}\NormalTok{, }\AttributeTok{lend =} \StringTok{"round"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{, }\StringTok{"Hello, Helvetica"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"sans"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{1}\NormalTok{, }\AttributeTok{offset =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\StringTok{"sans"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"sans"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{2}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{5}\NormalTok{, }\StringTok{"lend = round"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}

\FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{15}\NormalTok{, }\AttributeTok{lend =} \StringTok{"butt"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\StringTok{"Hello, Helvetica"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"mono"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{1}\NormalTok{, }\AttributeTok{offset =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\StringTok{"mono"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"mono"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{2}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{10}\NormalTok{, }\StringTok{"lend = butt"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}

\FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{15}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{15}\NormalTok{, }\AttributeTok{lend =} \StringTok{"square"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\StringTok{"Hello, Helvetica"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"serif"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{1}\NormalTok{, }\AttributeTok{offset =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{, }\StringTok{"serif"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"serif"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{2}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{15}\NormalTok{, }\StringTok{"lend = square"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-5-1} 

}

\caption{不同的线端样式}\label{fig:unnamed-chunk-5}
\end{figure}

lend：线端的样式，可用一个整数或字符串指定：

\begin{itemize}
\tightlist
\item
  0 或 ``round'' 圆形（默认）
\item
  1 或 ``butt'' 对接形
\item
  2 或 ``square'' 方形
\end{itemize}

\hypertarget{base-rect}{%
\subsection{区域}\label{base-rect}}

矩形，多边形，曲线交汇出来的区域 面（矩形rect，多边形polygon）、路径 polypath 面/多边形 rect 颜色填充

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# From the manual}
\NormalTok{ch.col }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"rainbow(n, start=.7, end=.1)"}\NormalTok{,}
  \StringTok{"heat.colors(n)"}\NormalTok{,}
  \StringTok{"terrain.colors(n)"}\NormalTok{,}
  \StringTok{"topo.colors(n)"}\NormalTok{,}
  \StringTok{"cm.colors(n)"}
\NormalTok{) }\CommentTok{\# 选择颜色}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{16}
\NormalTok{nt }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(ch.col)}
\NormalTok{i }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n}
\NormalTok{j }\OtherTok{\textless{}{-}}\NormalTok{ n }\SpecialCharTok{/}\NormalTok{ nt}
\NormalTok{d }\OtherTok{\textless{}{-}}\NormalTok{ j }\SpecialCharTok{/} \DecValTok{6}
\NormalTok{dy }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ d}
\FunctionTok{plot}\NormalTok{(i, i }\SpecialCharTok{+}\NormalTok{ d,}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"color palettes; n="}\NormalTok{, n)}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{nt) \{}
  \FunctionTok{rect}\NormalTok{(i }\SpecialCharTok{{-}}\NormalTok{ .}\DecValTok{5}\NormalTok{, (k }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ j }\SpecialCharTok{+}\NormalTok{ dy, i }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{4}\NormalTok{, k }\SpecialCharTok{*}\NormalTok{ j,}
    \AttributeTok{col =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ ch.col[k]))}
\NormalTok{  ) }\CommentTok{\# 咬人的函数/字符串解析为/转函数}
  \FunctionTok{text}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ j, k }\SpecialCharTok{*}\NormalTok{ j }\SpecialCharTok{+}\NormalTok{ dy }\SpecialCharTok{/} \DecValTok{4}\NormalTok{, ch.col[k])}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-6-1} 

}

\caption{rect 函数画长方形}\label{fig:unnamed-chunk-6}
\end{figure}

\texttt{clip(x1,\ x2,\ y1,\ y2)} 在用户坐标中设置剪切区域

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{1000}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(x, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\NormalTok{usr }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)}
\FunctionTok{clip}\NormalTok{(usr[}\DecValTok{1}\NormalTok{], }\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, usr[}\DecValTok{3}\NormalTok{], usr[}\DecValTok{4}\NormalTok{])}
\FunctionTok{hist}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{clip}\NormalTok{(}\DecValTok{2}\NormalTok{, usr[}\DecValTok{2}\NormalTok{], usr[}\DecValTok{3}\NormalTok{], usr[}\DecValTok{4}\NormalTok{])}
\FunctionTok{hist}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-7-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{do.call}\NormalTok{(}\StringTok{"clip"}\NormalTok{, }\FunctionTok{as.list}\NormalTok{(usr)) }\CommentTok{\# reset to plot region}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my.col }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(f, g, xmin, xmax, col, }\AttributeTok{N =} \DecValTok{200}\NormalTok{,}
                   \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{) \{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(xmin, xmax, }\AttributeTok{length =}\NormalTok{ N)}
\NormalTok{  fx }\OtherTok{\textless{}{-}} \FunctionTok{f}\NormalTok{(x)}
\NormalTok{  gx }\OtherTok{\textless{}{-}} \FunctionTok{g}\NormalTok{(x)}
  \FunctionTok{plot}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
    \AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(xmin, xmax),}
    \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(fx, gx), }\FunctionTok{max}\NormalTok{(fx, gx)),}
    \AttributeTok{xlab =}\NormalTok{ xlab, }\AttributeTok{ylab =}\NormalTok{ ylab, }\AttributeTok{main =}\NormalTok{ main}
\NormalTok{  )}
  \FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(x, }\FunctionTok{rev}\NormalTok{(x)), }\FunctionTok{c}\NormalTok{(fx, }\FunctionTok{rev}\NormalTok{(gx)),}
    \AttributeTok{col =} \StringTok{"\#EA4335"}\NormalTok{, }\AttributeTok{border =} \DecValTok{0}
\NormalTok{  )}
  \FunctionTok{lines}\NormalTok{(x, fx, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"\#34A853"}\NormalTok{)}
  \FunctionTok{lines}\NormalTok{(x, gx, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"\#4285f4"}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{my.col}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \DecValTok{10} \SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(x),}
  \SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\DecValTok{6}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"The }\SpecialCharTok{\textbackslash{}"}\StringTok{polygon}\SpecialCharTok{\textbackslash{}"}\StringTok{ function"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-8-1} 

}

\caption{区域重叠 polygon 函数}\label{fig:unnamed-chunk-8}
\end{figure}

各种符号 \ref{fig:cex-symbol}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{),}
  \AttributeTok{axes =}\NormalTok{ F,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{0}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{) \{}
\NormalTok{    n }\OtherTok{\textless{}{-}} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ i }\SpecialCharTok{+}\NormalTok{ j}
    \FunctionTok{points}\NormalTok{(j, i,}
      \AttributeTok{pch =}\NormalTok{ n,}
      \AttributeTok{cex =} \DecValTok{3}
\NormalTok{    )}
    \FunctionTok{text}\NormalTok{(j, i }\SpecialCharTok{{-}}\NormalTok{ .}\DecValTok{3}\NormalTok{, }\FunctionTok{as.character}\NormalTok{(n))}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/cex-symbol-1} 

}

\caption{cex 支持的符号}\label{fig:cex-symbol}
\end{figure}

点、线、多边形和圆聚集在图 \ref{fig:symbols} 中

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://jeroen.github.io/uros2018/\#23}
\FunctionTok{plot.new}\NormalTok{()}
\FunctionTok{plot.window}\NormalTok{(}\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{))}
\FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{80}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{col =} \StringTok{"hotpink"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{90}\NormalTok{, }\AttributeTok{labels =} \StringTok{"My drawing"}\NormalTok{, }\AttributeTok{col =} \StringTok{"navyblue"}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3}\NormalTok{)}
\FunctionTok{symbols}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{90}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{80}\NormalTok{),}
  \AttributeTok{circles =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{10}\NormalTok{),}
  \AttributeTok{bg =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4285f4"}\NormalTok{, }\StringTok{"\#EA4335"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{lty =} \StringTok{"dashed"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/symbols-1} 

}

\caption{多边形和符号元素}\label{fig:symbols}
\end{figure}

在介绍各种统计图形之前，先介绍几个绘图函数 \texttt{plot} 和 \texttt{text} 还有 \texttt{par} 参数设置， 作为最简单的开始，尽量依次介绍其中的每个参数的含义并附上图形对比。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y }\OtherTok{\textless{}{-}}\NormalTok{ x }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{ann =}\NormalTok{ F, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{)}
\FunctionTok{text}\NormalTok{(x, y,}
  \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"1st"}\NormalTok{, }\StringTok{"2nd"}\NormalTok{, }\StringTok{"3rd"}\NormalTok{, }\StringTok{"4th"}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pos =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{offset =} \FloatTok{0.6}
\NormalTok{)}
\NormalTok{ahat }\OtherTok{\textless{}{-}} \StringTok{"sigma"}
\CommentTok{\# title(substitute(hat(a) == ahat, list(ahat = ahat)))}
\FunctionTok{title}\NormalTok{(}\FunctionTok{bquote}\NormalTok{(}\FunctionTok{hat}\NormalTok{(a) }\SpecialCharTok{==}\NormalTok{ .(ahat)))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/pos-1} 

}

\caption{pos 位置参数}\label{fig:pos}
\end{figure}

其中 labels， pos 都是向量化的参数

\hypertarget{base-lines}{%
\subsection{参考线}\label{base-lines}}

矩形网格线是用做背景参考线的，常常是淡灰色的细密虚线，\texttt{plot} 函数的 \texttt{panel.first} 参数和 \texttt{grid} 函数常用来画这种参考线

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# modified from https://yihui.name/cn/2018/02/cohen{-}s{-}d/}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{30} \CommentTok{\# 样本量（只是一个例子）}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.1}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(x }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n), }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{pt}\NormalTok{(x, n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)),}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(}\AttributeTok{d =}\NormalTok{ x }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n)),}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{()}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/bg-grid-lines-1} 

}

\caption{添加背景参考线}\label{fig:bg-grid-lines}
\end{figure}

\hypertarget{base-axis}{%
\subsection{坐标轴}\label{base-axis}}

图形控制参数默认设置下 \texttt{par} 通常的一幅图形，改变坐标轴标签是很简单的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{100}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{100}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-9-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlab =} \StringTok{"Index"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Uniform draws"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-9-2} \end{center}

改变坐标轴标签和标题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{no.readonly =} \ConstantTok{TRUE}\NormalTok{) }\CommentTok{\# 保存默认的 par 设置}
\FunctionTok{par}\NormalTok{(}\AttributeTok{cex.lab =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex.axis =} \FloatTok{1.3}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlab =} \StringTok{"Index"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Uniform draws"}\NormalTok{)}

\CommentTok{\# 设置更大的坐标轴标签内容}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{cex.axis =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex.lab =} \DecValTok{2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlab =} \StringTok{"Index"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Uniform draws"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-10-1} \end{center}

使用 axis 函数可以更加精细地控制坐标轴

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op) }\CommentTok{\# 恢复默认的 par 设置}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{) }\CommentTok{\# 去掉 x 轴}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{)) }\CommentTok{\# 添加指定的刻度标签}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-11-1} \end{center}

指定刻度标签的内容

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Small"}\NormalTok{, }\StringTok{"Medium"}\NormalTok{, }\StringTok{"Big"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-12-1} \end{center}

控制刻度线和轴线和刻度标签

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(x, y)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{75}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{4}\NormalTok{, }\AttributeTok{lwd.ticks =} \DecValTok{2}\NormalTok{, }\AttributeTok{col.ticks =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-13-1} \end{center}

还可以把 box 移除，绘图区域的边框去掉，只保留坐标轴

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{bty =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{20}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-14-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 双Y轴}
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length =}\NormalTok{ N)}
\NormalTok{y1 }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x)}
\NormalTok{y2 }\OtherTok{\textless{}{-}} \FunctionTok{cos}\NormalTok{(x)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)) }\CommentTok{\# Add some space in the right margin}
\CommentTok{\# The default is c(5,4,4,2) + .1}
\NormalTok{xlim }\OtherTok{\textless{}{-}} \FunctionTok{range}\NormalTok{(x)}
\NormalTok{ylim }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.1}\NormalTok{, }\FloatTok{1.1}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y1,}
  \AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
  \AttributeTok{xlim =}\NormalTok{ xlim, }\AttributeTok{ylim =}\NormalTok{ ylim,}
  \AttributeTok{axes =}\NormalTok{ F, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{"Title"}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y2,}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
  \AttributeTok{xlim =}\NormalTok{ xlim, }\AttributeTok{ylim =}\NormalTok{ ylim,}
  \AttributeTok{axes =}\NormalTok{ F, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{4}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"First Y axis"}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{line =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.2}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Second Y axis"}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{line =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.65\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-15-1} 

}

\caption{两个 Y 轴}\label{fig:unnamed-chunk-15}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1,2,3,4 分别代表下左上右四个位置}
\end{Highlighting}
\end{Shaded}

调整坐标轴标签的距离

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Changing default gap between labels:}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\FunctionTok{quote}\NormalTok{(}\StringTok{"axis(1, .., gap.axis = f),"} \SpecialCharTok{\textasciitilde{}} \ErrorTok{\textasciitilde{}}\NormalTok{ f }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{))}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{at =} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{0}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{gap.axis =} \DecValTok{1} \SpecialCharTok{/} \DecValTok{4}\NormalTok{)}
\NormalTok{gaps }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1} \SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{1} \SpecialCharTok{/} \DecValTok{4}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{chG }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}
  \FunctionTok{ifelse}\NormalTok{(gaps }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"default:  "}\NormalTok{, }\StringTok{""}\NormalTok{),}
  \StringTok{"gap.axis="}\NormalTok{, }\FunctionTok{formatC}\NormalTok{(gaps)}
\NormalTok{)}
\NormalTok{jj }\OtherTok{\textless{}{-}} \FunctionTok{seq\_along}\NormalTok{(gaps)}
\NormalTok{linG }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FloatTok{2.5} \SpecialCharTok{*}\NormalTok{ (jj }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in}\NormalTok{ jj) \{}
\NormalTok{  isD }\OtherTok{\textless{}{-}}\NormalTok{ gaps[j] }\SpecialCharTok{==} \DecValTok{1} \CommentTok{\# is default}
  \FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
    \AttributeTok{at =} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{0}\SpecialCharTok{:}\DecValTok{20}\NormalTok{), }\AttributeTok{gap.axis =}\NormalTok{ gaps[j], }\AttributeTok{padj =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{line =}\NormalTok{ linG[j],}
    \AttributeTok{col.axis =} \ControlFlowTok{if}\NormalTok{ (isD) }\StringTok{"forest green"} \ControlFlowTok{else} \DecValTok{1}\NormalTok{, }\AttributeTok{font.axis =} \DecValTok{1} \SpecialCharTok{+}\NormalTok{ isD}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{mtext}\NormalTok{(chG,}
  \AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{padj =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{line =}\NormalTok{ linG }\SpecialCharTok{{-}} \DecValTok{1} \SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3} \SpecialCharTok{/} \DecValTok{4}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{ifelse}\NormalTok{(gaps }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"forest green"}\NormalTok{, }\StringTok{"blue3"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/gap-axis-1} 

}

\caption{gap.axis用法}\label{fig:gap-axis}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# now shrink the window (in x{-} and y{-}direction) and observe the axis labels drawn}
\end{Highlighting}
\end{Shaded}

旋转坐标轴标签

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Rotated axis labels in R plots}
\CommentTok{\# https://menugget.blogspot.com/2014/08/rotated{-}axis{-}labels{-}in{-}r{-}plots.html}
\CommentTok{\# Example data}
\NormalTok{tmin }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2000{-}01{-}01"}\NormalTok{)}
\NormalTok{tmax }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2001{-}01{-}01"}\NormalTok{)}
\NormalTok{tlab }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(tmin, tmax, }\AttributeTok{by =} \StringTok{"month"}\NormalTok{)}
\NormalTok{lab }\OtherTok{\textless{}{-}} \FunctionTok{format}\NormalTok{(tlab, }\AttributeTok{format =} \StringTok{"\%Y{-}\%b"}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{111}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(tmin, tmax, }\AttributeTok{length.out =} \DecValTok{100}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{cumsum}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{))}

\CommentTok{\# Plot}
\CommentTok{\# png("plot\_w\_rotated\_axis\_labels.png", height = 3,}
\CommentTok{\#     width = 6, units = "in", res = 300)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{t =} \StringTok{"l"}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{at =}\NormalTok{ tlab, }\AttributeTok{labels =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ tlab, }\AttributeTok{y =} \FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{usr[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \FloatTok{0.1} \SpecialCharTok{*}\NormalTok{ (}\FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{usr[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{usr[}\DecValTok{3}\NormalTok{]),}
  \AttributeTok{labels =}\NormalTok{ lab, }\AttributeTok{srt =} \DecValTok{45}\NormalTok{, }\AttributeTok{adj =} \DecValTok{1}\NormalTok{, }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-16-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\CommentTok{\# dev.off()}
\end{Highlighting}
\end{Shaded}

旋转坐标抽标签的例子来自手册《R FAQ》的第7章第27个问题 \citep{R-FAQ}，在基础图形中，旋转坐标轴标签需要 \texttt{text()} 而不是 \texttt{mtext()}，因为后者不支持\texttt{par("srt")}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Increase bottom margin to make room for rotated labels}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\DecValTok{2}\NormalTok{) }\SpecialCharTok{+} \FloatTok{0.1}\NormalTok{)}
\DocumentationTok{\#\# Create plot with no x axis and no x axis label}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{)}
\DocumentationTok{\#\# Set up x axis with tick marks alone}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \ConstantTok{FALSE}\NormalTok{)}
\DocumentationTok{\#\# Create some text labels}
\NormalTok{labels }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Label"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
\DocumentationTok{\#\# Plot x axis labels at default tick marks}
\FunctionTok{text}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{,}
  \AttributeTok{srt =} \DecValTok{45}\NormalTok{, }\AttributeTok{adj =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{labels =}\NormalTok{ labels, }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\DocumentationTok{\#\# Plot x axis label at line 6 (of 7)}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{text =} \StringTok{"X Axis Label"}\NormalTok{, }\AttributeTok{line =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/rotate-axis-labels-1} 

}

\caption{旋转坐标轴标签}\label{fig:rotate-axis-labels}
\end{figure}

\texttt{srt\ =\ 45} 表示文本旋转角度， \texttt{xpd\ =\ TRUE} 允许文本越出绘图区域，\texttt{adj\ =\ 1} to place the right end of text at the tick marks；You can adjust the value of the 0.5 offset as required to move the axis labels up or down relative to the x axis. 详细地参考 \citep{Paul_2003_Integrating}

\hypertarget{base-tick}{%
\subsection{刻度线}\label{base-tick}}

通过 \texttt{par} 或 \texttt{axis} 函数实现刻度线的精细操作，tcl 控制刻度线的长度，正值让刻度画在绘图区域内，负值正好相反，画在外面，mgp 参数有三个值，第一个值控制绘图区域和坐标轴标题之间的行数，第二个是绘图区域与坐标轴标签的行数，第三个绘图区域与轴线的行数，行数表示间距

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{tcl =} \FloatTok{0.4}\NormalTok{, }\AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-17-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 又一个例子}
\FunctionTok{par}\NormalTok{(op)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{95}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{tcl =} \FloatTok{0.4}\NormalTok{, }\AttributeTok{lwd.ticks =} \DecValTok{3}\NormalTok{, }\AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{text =} \StringTok{"X axis"}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.5}\NormalTok{) }
\CommentTok{\# mtext 设置坐标轴标签}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{tcl =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{lwd.ticks =} \DecValTok{3}\NormalTok{, }\AttributeTok{col.ticks =} \StringTok{"orange"}\NormalTok{, }\AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{text =} \StringTok{"Numbers taken randomly"}\NormalTok{, }\AttributeTok{line =} \FloatTok{2.2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-17-2} \end{center}

\hypertarget{base-title}{%
\subsection{标题}\label{base-title}}

添加多个标题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(N, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x) }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{5} \SpecialCharTok{*} \FunctionTok{rnorm}\NormalTok{(N)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Subtitle"}\NormalTok{, }\DecValTok{3}\NormalTok{, }\AttributeTok{line =}\NormalTok{ .}\DecValTok{8}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Title"}\NormalTok{, }\DecValTok{3}\NormalTok{, }\AttributeTok{line =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"X axis"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{line =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"X axis subtitle"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{line =} \FloatTok{3.7}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-18-1} 

}

\caption{图标题/子标题 x轴标题/子标题}\label{fig:unnamed-chunk-18}
\end{figure}

\hypertarget{base-annotation}{%
\subsection{注释}\label{base-annotation}}

数学符号注释，图\ref{fig:math-annotation} 自定义坐标轴 \citep{Paul_2000_Approach}。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 自定义坐标轴}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e6}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, pi),}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{log =} \StringTok{"x"}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e2}\NormalTok{, }\FloatTok{1e4}\NormalTok{, }\FloatTok{1e6}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{expression}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{6}\NormalTok{)}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, }\SpecialCharTok{{-}}\NormalTok{pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, pi),}
  \AttributeTok{labels =} \FunctionTok{expression}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, }\SpecialCharTok{{-}}\NormalTok{pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, pi)}
\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\FloatTok{1e3}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(}\StringTok{"Customized Axes"}\NormalTok{)))}
\FunctionTok{box}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/math-annotation-1} 

}

\caption{创建自定义的坐标轴和刻度标签}\label{fig:math-annotation}
\end{figure}

在标题中添加数学公式

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\AttributeTok{length =} \DecValTok{200}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \FunctionTok{expression}\NormalTok{(}
  \StringTok{"graph of the function f"}\NormalTok{(x) }\SpecialCharTok{==} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-19-1} 

}

\caption{标题含有数学公式}\label{fig:unnamed-chunk-19}
\end{figure}

修改参数使用 \texttt{substitute} 函数批量生成

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\AttributeTok{length =} \DecValTok{200}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{ }\CommentTok{\# 画四个图}
\NormalTok{  y }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(i }\SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
  \FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
    \AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
    \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{6}\NormalTok{),}
    \AttributeTok{ylab =} \FunctionTok{substitute}\NormalTok{(}
      \FunctionTok{expression}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(i }\SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)),}
      \FunctionTok{list}\NormalTok{(}\AttributeTok{i =}\NormalTok{ i)}
\NormalTok{    )}
\NormalTok{  )}
  \FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \FunctionTok{substitute}\NormalTok{(}
    \StringTok{"graph of the function f"}\NormalTok{(x) }\SpecialCharTok{==} \FunctionTok{sqrt}\NormalTok{(i }\SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{),}
    \FunctionTok{list}\NormalTok{(}\AttributeTok{i =}\NormalTok{ i)}
\NormalTok{  ))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-20-1} 

}

\caption{批量生成函数图形}\label{fig:unnamed-chunk-20-1}
\end{figure}
\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-20-2} 

}

\caption{批量生成函数图形}\label{fig:unnamed-chunk-20-2}
\end{figure}
\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-20-3} 

}

\caption{批量生成函数图形}\label{fig:unnamed-chunk-20-3}
\end{figure}
\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-20-4} 

}

\caption{批量生成函数图形}\label{fig:unnamed-chunk-20-4}
\end{figure}

基础绘图函数，如 plot 标签 \texttt{xlab} 支持 Unicode 代码表示的希腊字母，常用字母表备查，公式环境下，也可以用在绘图中

\begin{longtable}[]{@{}llllll@{}}
\caption{\label{tab:letters} 希腊字母表}\tabularnewline
\toprule
希腊字母 & LaTeX 代码 & Unicode 代码 & 希腊字母 & LaTeX 代码 & Unicode 代码 \\
\midrule
\endfirsthead
\toprule
希腊字母 & LaTeX 代码 & Unicode 代码 & 希腊字母 & LaTeX 代码 & Unicode 代码 \\
\midrule
\endhead
\(\alpha\) & \texttt{\textbackslash{}alpha} & \texttt{\textbackslash{}u03B1} & \(\mu\) & \texttt{\textbackslash{}mu} & \texttt{\textbackslash{}u03BC} \\
\(\beta\) & \texttt{\textbackslash{}beta} & \texttt{\textbackslash{}u03B2} & \(\nu\) & \texttt{\textbackslash{}nu} & \texttt{\textbackslash{}u03BD} \\
\(\gamma\) & \texttt{\textbackslash{}gamma} & \texttt{\textbackslash{}u03B3} & \(\xi\) & \texttt{\textbackslash{}xi} & \texttt{\textbackslash{}u03BE} \\
\(\delta\) & \texttt{\textbackslash{}delta} & \texttt{\textbackslash{}u03B4} & \(\varphi\) & \texttt{\textbackslash{}varphi} & \texttt{\textbackslash{}u03C6} \\
\(\epsilon\) & \texttt{\textbackslash{}epsilon} & \texttt{\textbackslash{}u03B5} & \(\pi\) & \texttt{\textbackslash{}pi} & \texttt{\textbackslash{}u03C0} \\
\(\zeta\) & \texttt{\textbackslash{}zeta} & \texttt{\textbackslash{}u03B6} & \(\rho\) & \texttt{\textbackslash{}rho} & \texttt{\textbackslash{}u03C1} \\
\(\eta\) & \texttt{\textbackslash{}eta} & \texttt{\textbackslash{}u03B7} & \(\upsilon\) & \texttt{\textbackslash{}upsilon} & \texttt{\textbackslash{}u03C5} \\
\(\theta\) & \texttt{\textbackslash{}theta} & \texttt{\textbackslash{}u03B8} & \(\phi\) & \texttt{\textbackslash{}phi} & \texttt{\textbackslash{}u03C6} \\
\(\iota\) & \texttt{\textbackslash{}iota} & \texttt{\textbackslash{}u03B9} & \(\chi\) & \texttt{\textbackslash{}chi} & \texttt{\textbackslash{}u03C7} \\
\(\kappa\) & \texttt{\textbackslash{}kappa} & \texttt{\textbackslash{}u03BA} & \(\psi\) & \texttt{\textbackslash{}psi} & \texttt{\textbackslash{}u03C8} \\
\(\lambda\) & \texttt{\textbackslash{}lambda} & \texttt{\textbackslash{}u03BB} & \(\omega\) & \texttt{\textbackslash{}omega} & \texttt{\textbackslash{}u03C9} \\
\(\sigma\) & \texttt{\textbackslash{}sigma} & \texttt{\textbackslash{}u03C3} & \(\tau\) & \texttt{\textbackslash{}tau} & \texttt{\textbackslash{}u03C4} \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}llllll@{}}
\caption{\label{tab:super-sub-script} 数字上下标}\tabularnewline
\toprule
上标数字 & LaTeX 代码 & Unicode 代码 & 下标数字 & LaTeX 代码 & Unicode 代码 \\
\midrule
\endfirsthead
\toprule
上标数字 & LaTeX 代码 & Unicode 代码 & 下标数字 & LaTeX 代码 & Unicode 代码 \\
\midrule
\endhead
\({}^0\) & \texttt{\{\}\^{}0} & \texttt{\textbackslash{}u2070} & \({}_0\) & \texttt{\{\}\_0} & \texttt{\textbackslash{}u2080} \\
\({}^1\) & \texttt{\{\}\^{}1} & \texttt{\textbackslash{}u00B9} & \({}_1\) & \texttt{\{\}\_1} & \texttt{\textbackslash{}u2081} \\
\({}^2\) & \texttt{\{\}\^{}2} & \texttt{\textbackslash{}u00B2} & \({}_2\) & \texttt{\{\}\_2} & \texttt{\textbackslash{}u2082} \\
\({}^3\) & \texttt{\{\}\^{}3} & \texttt{\textbackslash{}u00B2} & \({}_3\) & \texttt{\{\}\_3} & \texttt{\textbackslash{}u2083} \\
\({}^4\) & \texttt{\{\}\^{}4} & \texttt{\textbackslash{}u2074} & \({}_4\) & \texttt{\{\}\_4} & \texttt{\textbackslash{}u2084} \\
\({}^5\) & \texttt{\{\}\^{}5} & \texttt{\textbackslash{}u2075} & \({}_5\) & \texttt{\{\}\_5} & \texttt{\textbackslash{}u2085} \\
\({}^6\) & \texttt{\{\}\^{}6} & \texttt{\textbackslash{}u2076} & \({}_6\) & \texttt{\{\}\_6} & \texttt{\textbackslash{}u2086} \\
\({}^7\) & \texttt{\{\}\^{}7} & \texttt{\textbackslash{}u2077} & \({}_7\) & \texttt{\{\}\_7} & \texttt{\textbackslash{}u2087} \\
\({}^8\) & \texttt{\{\}\^{}8} & \texttt{\textbackslash{}u2078} & \({}_8\) & \texttt{\{\}\_8} & \texttt{\textbackslash{}u2088} \\
\({}^9\) & \texttt{\{\}\^{}9} & \texttt{\textbackslash{}u2079} & \({}_9\) & \texttt{\{\}\_9} & \texttt{\textbackslash{}u2089} \\
\({}^n\) & \texttt{\{\}\^{}n} & \texttt{\textbackslash{}u207F} & \({}_n\) & \texttt{\{\}\_n} & - \\
\bottomrule
\end{longtable}

其它字母，请查看 \href{https://www.ssec.wisc.edu/~tomw/java/unicode.html}{Unicode 字母表}

\hypertarget{base-legend}{%
\subsection{图例}\label{base-legend}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\DecValTok{6}\NormalTok{, }\AttributeTok{length =} \DecValTok{200}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{cos}\NormalTok{(x)}
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"angle"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Trigonometric functions"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
  \AttributeTok{yjust =} \DecValTok{0}\NormalTok{,}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sine"}\NormalTok{, }\StringTok{"Cosine"}\NormalTok{),}
  \AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"fg"}\NormalTok{), }\StringTok{"red"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-21-1} 

}

\caption{三角函数添加图例}\label{fig:unnamed-chunk-21}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xmin }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{1}\NormalTok{]}
\NormalTok{xmax }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{2}\NormalTok{]}
\NormalTok{ymin }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{]}
\NormalTok{ymax }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{4}\NormalTok{]}

\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"angle"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Trigonometric functions"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{,}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sine"}\NormalTok{, }\StringTok{"Cosine"}\NormalTok{),}
  \AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"fg"}\NormalTok{), }\StringTok{"red"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-22-1} 

}

\caption{设置图例的位置}\label{fig:unnamed-chunk-22}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"angle"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Trigonometric functions"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{,}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sine"}\NormalTok{, }\StringTok{"Cosine"}\NormalTok{),}
  \AttributeTok{inset =} \FunctionTok{c}\NormalTok{(.}\DecValTok{03}\NormalTok{, .}\DecValTok{03}\NormalTok{),}
  \AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"fg"}\NormalTok{), }\StringTok{"red"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-23-1} 

}

\caption{insert 函数微调图例位置}\label{fig:unnamed-chunk-23}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{no.readonly =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"angle"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Trigonometric functions"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{xpd =} \ConstantTok{TRUE}\NormalTok{) }\CommentTok{\# Do not clip to the drawing area 关键一行/允许出界}
\NormalTok{lambda }\OtherTok{\textless{}{-}}\NormalTok{ .}\DecValTok{025}
\FunctionTok{legend}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{1}\NormalTok{],}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ lambda) }\SpecialCharTok{*} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ lambda }\SpecialCharTok{*} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{],}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sine"}\NormalTok{, }\StringTok{"Cosine"}\NormalTok{),}
  \AttributeTok{xjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{yjust =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"fg"}\NormalTok{), }\StringTok{"red"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-24-1} 

}

\caption{将图例放在绘图区域外面}\label{fig:unnamed-chunk-24}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

Hmisc 包的 labcurve 函数可以在曲线上放置名称，而不是遥远的图例上

\hypertarget{base-par}{%
\subsection{边空}\label{base-par}}

边空分为内边空和外边空

\begin{figure}

{\centering \subfloat[内边空\label{fig:par-mai-oma-1}]{\includegraphics[width=0.35\linewidth]{/opt/R/4.1.1/lib/R/library/graphics/help/figures/mai} }\subfloat[外边空\label{fig:par-mai-oma-2}]{\includegraphics[width=0.35\linewidth]{/opt/R/4.1.1/lib/R/library/graphics/help/figures/oma} }

}

\caption{边空}\label{fig:par-mai-oma}
\end{figure}

\texttt{line} 第一行

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(N, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x) }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{5} \SpecialCharTok{*} \FunctionTok{rnorm}\NormalTok{(N)}
\FunctionTok{plot}\NormalTok{(x, y,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}
    \StringTok{"The }\SpecialCharTok{\textbackslash{}"}\StringTok{mtext}\SpecialCharTok{\textbackslash{}"}\StringTok{ function"}\NormalTok{,}
    \FunctionTok{paste}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{" "}\NormalTok{, }\DecValTok{60}\NormalTok{), }\AttributeTok{collapse =} \StringTok{""}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{1}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{)) \{}
  \FunctionTok{mtext}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Line"}\NormalTok{, i), }\DecValTok{3}\NormalTok{, }\AttributeTok{line =}\NormalTok{ i)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-25-1} 

}

\caption{外边空在图的边缘添加文字}\label{fig:unnamed-chunk-25}
\end{figure}

\texttt{par}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 多图排列/分屏 page 47}
\CommentTok{\# 最常用的是 par mfrow mfcol分别按行/列放置图形}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}
  \AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{0}\NormalTok{) }\CommentTok{\# Outer margins}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{),}
    \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"random plot ("}\NormalTok{, i, }\StringTok{")"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(op)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Four plots, without enough room for this title"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{font =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}
\NormalTok{) }\CommentTok{\# 总/大标题放不下}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-26-1} 

}

\caption{多图排列共享一个大标题}\label{fig:unnamed-chunk-26}
\end{figure}

\texttt{par} 的 oma 用来设置外边空的大小，默认情形下没有外边空的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{oma}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0 0 0 0
\end{verbatim}

我们可以自己设置外边空

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}
  \AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{) }\CommentTok{\# Outer margins}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{),}
    \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"random plot ("}\NormalTok{, i, }\StringTok{")"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(op)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Four plots, with some room for this title"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{font =} \DecValTok{1}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-28-1} 

}

\caption{设置外边空放置大标题}\label{fig:unnamed-chunk-28}
\end{figure}

除了内边空还有外边空，内外边空用来放注释说明

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{no.readonly =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (side }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
\NormalTok{  inner }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{mar[side], }\DecValTok{0}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{1}
  \ControlFlowTok{for}\NormalTok{ (line }\ControlFlowTok{in} \DecValTok{0}\SpecialCharTok{:}\NormalTok{inner) \{}
    \FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Inner line "}\NormalTok{, line), }\AttributeTok{side =}\NormalTok{ side, }\AttributeTok{line =}\NormalTok{ line)}
\NormalTok{  \}}
\NormalTok{  outer }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{oma[side], }\DecValTok{0}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{1}
  \ControlFlowTok{for}\NormalTok{ (line }\ControlFlowTok{in} \DecValTok{0}\SpecialCharTok{:}\NormalTok{inner) \{}
    \FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer line "}\NormalTok{, line), }\AttributeTok{side =}\NormalTok{ side, }\AttributeTok{line =}\NormalTok{ line, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-29-1} \end{center}

外边空可以用来放图例

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\NormalTok{cols }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{5}\NormalTok{), }\AttributeTok{each =} \DecValTok{2}\NormalTok{)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{pch =} \DecValTok{16}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{col =}\NormalTok{ cols, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \StringTok{"A common x{-}axis label"}\NormalTok{, }\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{line =} \DecValTok{0}\NormalTok{, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \StringTok{"A common y{-}axis label"}\NormalTok{, }\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{line =} \DecValTok{0}\NormalTok{, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}
  \AttributeTok{x =} \DecValTok{1}\NormalTok{, }\AttributeTok{y =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{legend =}\NormalTok{ LETTERS[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{],}
  \AttributeTok{col =} \FunctionTok{unique}\NormalTok{(cols), }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{bty =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xpd =} \ConstantTok{NA}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-30-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

坐标轴标签 \texttt{xlab} 和 \texttt{ylab} 的内容很长的时候需要内边空

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{cex.lab =} \FloatTok{1.7}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"A very very long axis title}\SpecialCharTok{\textbackslash{}n}\StringTok{that need special care"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}
\NormalTok{)}

\CommentTok{\# 增加内边空的大小}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"A very very long axis title}\SpecialCharTok{\textbackslash{}n}\StringTok{that need special care"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-31-1} \end{center}

有时候，仅仅增加内边空还不够，坐标轴标签内容甚至可以出现在绘图区域外面，设置 \texttt{outer\ =\ TRUE}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}
  \AttributeTok{text =} \StringTok{"A very very long axis title}\SpecialCharTok{\textbackslash{}n}\StringTok{that need special care"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{line =} \DecValTok{0}\NormalTok{, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.7}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-32-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}
  \AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{),}
  \AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{1} \CommentTok{\# Margins}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{),}
    \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
    \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"random plot ("}\NormalTok{, i, }\StringTok{")"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(op)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Title"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{font =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-33-1} 

}

\caption{设置每个子图的边空 mar}\label{fig:unnamed-chunk-33}
\end{figure}

\hypertarget{base-layer}{%
\subsection{图层}\label{base-layer}}

覆盖图形 \texttt{add\ =\ T} or \texttt{par(new=TRUE)}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"\#EA4335"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3}
\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{segments}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"blue"}
\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Overlaying points, segments, lines..."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-34-1} 

}

\caption{添加图层}\label{fig:unnamed-chunk-34}
\end{figure}

\hypertarget{base-layout}{%
\subsection{布局}\label{base-layout}}

\texttt{layout} 函数布局， 绘制复杂组合图形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{layout}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
  \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{,}
  \DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{,}
  \DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}
\NormalTok{), }\AttributeTok{nr =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{))}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n), }\AttributeTok{col =} \StringTok{"light blue"}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n), }\AttributeTok{col =} \StringTok{"light blue"}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n), }\AttributeTok{col =} \StringTok{"light blue"}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n), }\AttributeTok{col =} \StringTok{"light blue"}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"The }\SpecialCharTok{\textbackslash{}"}\StringTok{layout}\SpecialCharTok{\textbackslash{}"}\StringTok{ function"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{font =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.2}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-35-1} 

}

\caption{更加复杂的组合图形}\label{fig:unnamed-chunk-35}
\end{figure}

\hypertarget{base-combine}{%
\subsection{组合}\label{base-combine}}

\texttt{par} 之 \texttt{fig} 参数很神奇，使得多个图可以叠加在一起，它接受一个数值向量\texttt{c(x1,\ x2,\ y1,\ y2)} ，是图形设备显示区域中的绘图区域的(NDC, normalized device coordinates)坐标。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"b"}\NormalTok{, }\AttributeTok{main =} \StringTok{"\textquotesingle{}fg\textquotesingle{} : axes, ticks and box in gray"}\NormalTok{,}
  \AttributeTok{fg =} \FunctionTok{gray}\NormalTok{(}\FloatTok{0.7}\NormalTok{), }\AttributeTok{bty =} \StringTok{"7"}\NormalTok{, }\AttributeTok{sub =}\NormalTok{ R.version.string}
\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{fig =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{, }\AttributeTok{new =}\NormalTok{ T)}
\FunctionTok{plot}\NormalTok{(}\DecValTok{6}\SpecialCharTok{:}\DecValTok{10}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"b"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{fg =} \FunctionTok{gray}\NormalTok{(}\FloatTok{0.7}\NormalTok{), }\AttributeTok{bty =} \StringTok{"7"}\NormalTok{, }\AttributeTok{xlab =}\NormalTok{ R.version.string}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-36-1} 

}

\caption{多图叠加}\label{fig:unnamed-chunk-36}
\end{figure}

\texttt{fig} 参数控制图形的位置，用来绘制组合图形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{1000}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rt}\NormalTok{(n, }\AttributeTok{df =} \DecValTok{10}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(x,}
  \AttributeTok{col =} \StringTok{"light blue"}\NormalTok{,}
  \AttributeTok{probability =} \StringTok{"TRUE"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{1.2} \SpecialCharTok{*} \FunctionTok{max}\NormalTok{(}\FunctionTok{density}\NormalTok{(x)}\SpecialCharTok{$}\NormalTok{y))}
\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(x),}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{,}
  \AttributeTok{lwd =} \DecValTok{3}
\NormalTok{)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}
  \AttributeTok{fig =} \FunctionTok{c}\NormalTok{(.}\DecValTok{02}\NormalTok{, .}\DecValTok{4}\NormalTok{, .}\DecValTok{5}\NormalTok{, .}\DecValTok{98}\NormalTok{),}
  \AttributeTok{new =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{qqnorm}\NormalTok{(x,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{axes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{qqline}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-37-1} 

}

\caption{组合图形}\label{fig:unnamed-chunk-37}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

\hypertarget{base-screen}{%
\subsection{分屏}\label{base-screen}}

\texttt{split.screen} 分屏组合

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{random.plot }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
\NormalTok{  N }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{  f }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}
    \FunctionTok{list}\NormalTok{(}
\NormalTok{      rnorm,}
      \ControlFlowTok{function}\NormalTok{(x) \{}
        \FunctionTok{rt}\NormalTok{(x, }\AttributeTok{df =} \DecValTok{2}\NormalTok{)}
\NormalTok{      \},}
\NormalTok{      rlnorm,}
\NormalTok{      runif}
\NormalTok{    ),}
    \DecValTok{1}
\NormalTok{  ) [[}\DecValTok{1}\NormalTok{]]}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{f}\NormalTok{(N)}
  \FunctionTok{hist}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{axes =}\NormalTok{ F)}
  \FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{\}}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{bg =} \StringTok{"white"}\NormalTok{, }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{2.5}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{split.screen}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{split.screen}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{screen =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3 4 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{screen}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\FunctionTok{random.plot}\NormalTok{()}
\CommentTok{\# screen(2); random.plot() \# Screen 2 was split into three screens: 3, 4, 5}
\FunctionTok{screen}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\FunctionTok{random.plot}\NormalTok{()}
\FunctionTok{screen}\NormalTok{(}\DecValTok{4}\NormalTok{)}
\FunctionTok{random.plot}\NormalTok{()}
\FunctionTok{screen}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\FunctionTok{random.plot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-38-1} 

}

\caption{分屏}\label{fig:unnamed-chunk-38}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{close.screen}\NormalTok{(}\AttributeTok{all =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

\hypertarget{identify-locator}{%
\subsection{交互}\label{identify-locator}}

辅助绘图 identify locator

\hypertarget{base-graphics}{%
\section{基础统计图形}\label{base-graphics}}

按图的类型划分，最后在小结部分给出各图适用的数据类型

根据数据类型划分： 对于一元数据，可用什么图来描述；多元数据呢，连续数据和离散数据（分类数据）

先找一个不重不漏的划分，指导原则是根据数据类型选择图，根据探索到的数据中的规律，选择图

其它 assocplot fourfoldplot sunflowerplot

\hypertarget{plot-bar}{%
\subsection{条形图}\label{plot-bar}}

\href{https://rpubs.com/chidungkt/392980}{条形图}

简单条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(diamonds, }\AttributeTok{package =} \StringTok{"ggplot2"}\NormalTok{) }\CommentTok{\# 加载数据}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{barCenters }\OtherTok{\textless{}{-}} \FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(diamonds}\SpecialCharTok{$}\NormalTok{cut),}
  \AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{axisnames =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}
\NormalTok{)}
\FunctionTok{text}\NormalTok{(}
  \AttributeTok{y =}\NormalTok{ barCenters, }\AttributeTok{x =} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{],}
  \AttributeTok{adj =} \DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{names}\NormalTok{(}\FunctionTok{table}\NormalTok{(diamonds}\SpecialCharTok{$}\NormalTok{cut)), }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{25000}\NormalTok{, }\AttributeTok{by =} \DecValTok{5000}\NormalTok{), }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{25000}\NormalTok{, }\AttributeTok{by =} \DecValTok{5000}\NormalTok{),}
  \AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \StringTok{"gray"}
\NormalTok{)}
\FunctionTok{grid}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/diamonds-base-barplot-1} 

}

\caption{条形图}\label{fig:diamonds-base-barplot}
\end{figure}

简单柱形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123456}\NormalTok{)}
\NormalTok{barPois }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(stats}\SpecialCharTok{::}\FunctionTok{rpois}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\AttributeTok{lambda =} \DecValTok{5}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(barPois, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{type =} \StringTok{"h"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{10}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-39-1} 

}

\caption{柱形图}\label{fig:unnamed-chunk-39}
\end{figure}

复合条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.1}\NormalTok{, }\FloatTok{2.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{4.5}\NormalTok{))}
\FunctionTok{barplot}\NormalTok{(VADeaths,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{legend.text =} \FunctionTok{rownames}\NormalTok{(VADeaths), }\AttributeTok{xpd =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{cex.names =} \FloatTok{0.9}\NormalTok{,}
  \AttributeTok{args.legend =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"right"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Age"}\NormalTok{,}
    \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{inset =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(}\AttributeTok{nx =} \DecValTok{0}\NormalTok{, }\AttributeTok{ny =} \DecValTok{7}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/barplot-VADeaths-1-1} 

}

\caption{复合条形图}\label{fig:barplot-VADeaths-1}
\end{figure}

堆积条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.1}\NormalTok{, }\FloatTok{2.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{4.5}\NormalTok{))}
\FunctionTok{barplot}\NormalTok{(VADeaths,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{legend.text =} \FunctionTok{rownames}\NormalTok{(VADeaths), }\AttributeTok{xpd =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{beside =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{cex.names =} \FloatTok{0.9}\NormalTok{,}
  \AttributeTok{args.legend =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"right"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Age"}\NormalTok{,}
    \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{inset =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(}\AttributeTok{nx =} \DecValTok{0}\NormalTok{, }\AttributeTok{ny =} \DecValTok{4}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/barplot-VADeaths-2-1} 

}

\caption{堆积条形图}\label{fig:barplot-VADeaths-2}
\end{figure}

\begin{itemize}
\tightlist
\item
  堆积条形图 spineplot
\end{itemize}

简单条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ BOD, demand }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Time, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{20}\NormalTok{),}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/barplot-BOD-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pg\_mean }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth, mean)}
\FunctionTok{barplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ pg\_mean, weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/barplot-PlantGrowth-1} \end{center}

Titanic 数据集是 table 数据类型

简单条形图

复合条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(Freq }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Class }\SpecialCharTok{+}\NormalTok{ Survived,}
  \AttributeTok{data =}\NormalTok{ Titanic,}
  \AttributeTok{subset =}\NormalTok{ Age }\SpecialCharTok{==} \StringTok{"Adult"} \SpecialCharTok{\&}\NormalTok{ Sex }\SpecialCharTok{==} \StringTok{"Male"}\NormalTok{,}
  \AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{),}
  \AttributeTok{args.legend =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Class"}\NormalTok{,}
    \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{ylab =} \StringTok{"\# \{passengers\}"}\NormalTok{, }\AttributeTok{legend =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-40-1} \end{center}

堆积条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(Freq }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Class }\SpecialCharTok{+}\NormalTok{ Survived,}
  \AttributeTok{data =}\NormalTok{ Titanic,}
  \AttributeTok{subset =}\NormalTok{ Age }\SpecialCharTok{==} \StringTok{"Adult"} \SpecialCharTok{\&}\NormalTok{ Sex }\SpecialCharTok{==} \StringTok{"Male"}\NormalTok{,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{),}
  \AttributeTok{args.legend =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Class"}\NormalTok{,}
    \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{ylab =} \StringTok{"\# \{passengers\}"}\NormalTok{, }\AttributeTok{legend =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-41-1} \end{center}

\hypertarget{plot-hist}{%
\subsection{直方图}\label{plot-hist}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{24}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(n, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{delta }\OtherTok{\textless{}{-}} \FloatTok{0.01}
\NormalTok{len }\OtherTok{\textless{}{-}} \FunctionTok{diff}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{which}\NormalTok{(x }\SpecialCharTok{\textless{}}\NormalTok{ delta), n }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{{-}} \DecValTok{1}
\NormalTok{ylim }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1800}\NormalTok{, }\AttributeTok{by =} \DecValTok{300}\NormalTok{)}
\NormalTok{xlim }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{20}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{hist}\NormalTok{(len[len }\SpecialCharTok{\textless{}} \DecValTok{101}\NormalTok{], }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{1}\SpecialCharTok{:}\DecValTok{100} \SpecialCharTok{+} \FloatTok{0.5}\NormalTok{, }\AttributeTok{plot =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(p, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{labels =}\NormalTok{ xlim, }\AttributeTok{at =}\NormalTok{ xlim, }\AttributeTok{las =} \DecValTok{1}\NormalTok{) }\CommentTok{\# x 轴}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{labels =}\NormalTok{ ylim, }\AttributeTok{at =}\NormalTok{ ylim, }\AttributeTok{las =} \DecValTok{0}\NormalTok{) }\CommentTok{\# y 轴}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-42-1} 

}

\caption{直方图}\label{fig:unnamed-chunk-42}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(faithful, }\FunctionTok{plot}\NormalTok{(eruptions }\SpecialCharTok{\textasciitilde{}}\NormalTok{ waiting, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-43-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(faithful, }\FunctionTok{hist}\NormalTok{(waiting,}
  \AttributeTok{main =} \StringTok{"Time between Old Faithful eruptions"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Minutes"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{cex.main =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex.lab =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex.axis =} \FloatTok{1.4}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-44-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}\AttributeTok{data =}\NormalTok{ faithful, \{}
  \FunctionTok{hist}\NormalTok{(eruptions, }\FunctionTok{seq}\NormalTok{(}\FloatTok{1.6}\NormalTok{, }\FloatTok{5.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
    \AttributeTok{prob =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{main =} \StringTok{""}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}
\NormalTok{  )}
  \FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(eruptions, }\AttributeTok{bw =} \FloatTok{0.1}\NormalTok{), }\AttributeTok{col =} \StringTok{"\#EA4335"}\NormalTok{)}
  \FunctionTok{rug}\NormalTok{(eruptions, }\AttributeTok{col =} \StringTok{"\#EA4335"}\NormalTok{) }\CommentTok{\# 添加数据点}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/eruptions-1} 

}

\caption{老忠实泉间歇性喷水的时间间隔分布}\label{fig:eruptions}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed,}
  \AttributeTok{probability =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{col =} \StringTok{"light blue"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}
\NormalTok{)}
\CommentTok{\# 添加密度估计}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed),}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{,}
  \AttributeTok{lwd =} \DecValTok{3}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-45-1} 

}

\caption{概率密度分布}\label{fig:unnamed-chunk-45}
\end{figure}

直方图有很多花样的，添加阴影线，angle 控制倾斜的角度

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# hist(longley$Unemployed, density = 1, angle = 45)}
\CommentTok{\# hist(longley$Unemployed, density = 3, angle = 15)}
\CommentTok{\# hist(longley$Unemployed, density = 1, angle = 15)}
\FunctionTok{hist}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed, }\AttributeTok{density =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{45}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-46-1} 

}

\caption{density 数值越大阴影线越密}\label{fig:unnamed-chunk-46}
\end{figure}

\hypertarget{plot-density}{%
\subsection{密度图}\label{plot-density}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(galaxies, }\AttributeTok{package =} \StringTok{"MASS"}\NormalTok{)}
\NormalTok{galaxies }\OtherTok{\textless{}{-}}\NormalTok{ galaxies }\SpecialCharTok{/} \DecValTok{1000}
\CommentTok{\# Bandwidth Selection by Pilot Estimation of Derivatives}
\FunctionTok{c}\NormalTok{(MASS}\SpecialCharTok{::}\FunctionTok{width.SJ}\NormalTok{(galaxies, }\AttributeTok{method =} \StringTok{"dpi"}\NormalTok{), MASS}\SpecialCharTok{::}\FunctionTok{width.SJ}\NormalTok{(galaxies))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.256151 2.566423
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.2}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{bty =} \StringTok{"l"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"velocity of galaxy (km/s)"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"density"}
\NormalTok{)}
\FunctionTok{rug}\NormalTok{(galaxies)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(galaxies, }\AttributeTok{width =} \FloatTok{3.25}\NormalTok{, }\AttributeTok{n =} \DecValTok{200}\NormalTok{), }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(galaxies, }\AttributeTok{width =} \FloatTok{2.56}\NormalTok{, }\AttributeTok{n =} \DecValTok{200}\NormalTok{), }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-48-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{100}\NormalTok{, }\AttributeTok{to =} \DecValTok{174}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.5}\NormalTok{)}
\NormalTok{y1 }\OtherTok{\textless{}{-}} \FunctionTok{dnorm}\NormalTok{(x, }\AttributeTok{mean =} \DecValTok{145}\NormalTok{, }\AttributeTok{sd =} \DecValTok{9}\NormalTok{)}
\NormalTok{y2 }\OtherTok{\textless{}{-}} \FunctionTok{dnorm}\NormalTok{(x, }\AttributeTok{mean =} \DecValTok{128}\NormalTok{, }\AttributeTok{sd =} \DecValTok{8}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y1,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"firebrick3"}\NormalTok{,}
 \AttributeTok{main =} \StringTok{"Systolic Blood Pressure Before and After Treatment"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Systolic Blood Pressure (mmHg)"}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"Frequency"}\NormalTok{, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{175}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{)}
\NormalTok{)}

\FunctionTok{lines}\NormalTok{(x, y2, }\AttributeTok{col =} \StringTok{"dodgerblue4"}\NormalTok{)}
\FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{117}\NormalTok{, x, }\DecValTok{175}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, y2, }\DecValTok{0}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"dodgerblue4"}\NormalTok{,}
  \AttributeTok{border =} \StringTok{"white"}
\NormalTok{)}

\FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{100}\NormalTok{, x, }\DecValTok{175}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, y1, }\DecValTok{0}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"firebrick3"}\NormalTok{,}
  \AttributeTok{border =} \StringTok{"white"}
\NormalTok{)}

\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{8}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{175}\NormalTok{, }\AttributeTok{by =} \DecValTok{25}\NormalTok{), }\AttributeTok{las =} \DecValTok{1}
\NormalTok{)}

\FunctionTok{text}\NormalTok{(}\AttributeTok{x =} \DecValTok{100}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.0445}\NormalTok{, }\StringTok{"Pre{-}Treatment BP"}\NormalTok{, }\AttributeTok{col =} \StringTok{"dodgerblue4"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.9}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\AttributeTok{x =} \DecValTok{100}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.0395}\NormalTok{, }\StringTok{"Post{-}Treatment BP"}\NormalTok{, }\AttributeTok{col =} \StringTok{"firebrick3"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.9}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\DecValTok{100}\NormalTok{, }\FloatTok{0.0445}\NormalTok{, }\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{col =} \StringTok{"dodgerblue4"}\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\DecValTok{100}\NormalTok{, }\FloatTok{0.0395}\NormalTok{, }\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{col =} \StringTok{"firebrick3"}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \FunctionTok{c}\NormalTok{(}\DecValTok{145}\NormalTok{, }\DecValTok{128}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{\textquotesingle{}gray\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.65\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-49-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{days }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{125}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{density}\NormalTok{(days, }\AttributeTok{from =} \DecValTok{0}\NormalTok{),}
  \AttributeTok{main =} \StringTok{"Density plot"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Number of days since trial started"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-50-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{density}\NormalTok{(days, }\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{180}\NormalTok{, }\AttributeTok{adjust =} \FloatTok{0.2}\NormalTok{),}
  \AttributeTok{main =} \StringTok{"Density plot {-} Up to 180 days (86\% of data)"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Number of days since trial started"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-50-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(survival)}
\NormalTok{surv.days }\OtherTok{\textless{}{-}} \FunctionTok{Surv}\NormalTok{(days)}
\NormalTok{surv.fit }\OtherTok{\textless{}{-}} \FunctionTok{survfit}\NormalTok{(surv.days }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(surv.fit,}
  \AttributeTok{main =} \StringTok{"Kaplan{-}Meier estimate with 95\% confidence bounds (86\% of data)"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Days since trial started"}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{180}\NormalTok{),}
  \AttributeTok{ylab =} \StringTok{"Survival function"}
\NormalTok{)}
\FunctionTok{grid}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-51-1} \end{center}

\hypertarget{plot-ecdf}{%
\subsection{经验图}\label{plot-ecdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}\AttributeTok{data =}\NormalTok{ faithful, \{}
\NormalTok{  long }\OtherTok{\textless{}{-}}\NormalTok{ eruptions[eruptions }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{]}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{ecdf}\NormalTok{(long), }\AttributeTok{do.points =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{verticals =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{3}\NormalTok{, }\FloatTok{5.4}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
  \FunctionTok{lines}\NormalTok{(x, }\FunctionTok{pnorm}\NormalTok{(x, }\AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(long), }\AttributeTok{sd =} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(long))), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/faithful-ecdf-1} 

}

\caption{累积经验分布图}\label{fig:faithful-ecdf}
\end{figure}

\hypertarget{plot-qqnorm}{%
\subsection{QQ 图}\label{plot-qqnorm}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}\AttributeTok{data =}\NormalTok{ faithful, \{}
\NormalTok{  long }\OtherTok{\textless{}{-}}\NormalTok{ eruptions[eruptions }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{]}
  \FunctionTok{par}\NormalTok{(}\AttributeTok{pty =} \StringTok{"s"}\NormalTok{) }\CommentTok{\# arrange for a square figure region}
  \FunctionTok{qqnorm}\NormalTok{(long, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
  \FunctionTok{qqline}\NormalTok{(long)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/faithful-eruptions-1} \end{center}

\hypertarget{plot-ts}{%
\subsection{时序图}\label{plot-ts}}

时序图最适合用来描述股价走势

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{matplot}\NormalTok{(}\FunctionTok{time}\NormalTok{(EuStockMarkets), EuStockMarkets,}
  \AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Date"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"closing prices"}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{col =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topleft"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(EuStockMarkets), }\AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-52-1} 

}

\caption{1991–1998年间主要欧洲股票市场日闭市价格指数图 
 德国 DAX (Ibis), Switzerland SMI, 法国 CAC 和 英国 FTSE}\label{fig:unnamed-chunk-52}
\end{figure}

\hypertarget{plot-pie}{%
\subsection{饼图}\label{plot-pie}}

clockwise 参数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pie.sales }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.12}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.26}\NormalTok{, }\FloatTok{0.16}\NormalTok{, }\FloatTok{0.04}\NormalTok{, }\FloatTok{0.12}\NormalTok{)}
\FunctionTok{names}\NormalTok{(pie.sales) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"Blueberry"}\NormalTok{, }\StringTok{"Cherry"}\NormalTok{,}
  \StringTok{"Apple"}\NormalTok{, }\StringTok{"Boston Cream"}\NormalTok{, }\StringTok{"Other"}\NormalTok{, }\StringTok{"Vanilla Cream"}
\NormalTok{)}
\FunctionTok{pie}\NormalTok{(pie.sales, }\AttributeTok{clockwise =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\FunctionTok{segments}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\StringTok{"init.angle = 90"}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-53-1} \end{center}

\hypertarget{plot-stem-leaf}{%
\subsection{茎叶图}\label{plot-stem-leaf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stem}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##   The decimal point is 2 digit(s) to the right of the |
## 
##   1 | 99
##   2 | 134899
##   3 | 46789
##   4 | 078
\end{verbatim}

\hypertarget{plot-scatter}{%
\subsection{散点图}\label{plot-scatter}}

在一维空间上，绘制散点图，其实是在看散点的疏密程度随坐标轴的变化

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stripchart}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed,}
  \AttributeTok{method =} \StringTok{"jitter"}\NormalTok{,}
  \AttributeTok{jitter =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}
\NormalTok{)}
\FunctionTok{stripchart}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed,}
  \AttributeTok{method =} \StringTok{"overplot"}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[抖动图\label{fig:unnamed-chunk-55-1}]{\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-55-1} }\subfloat[疏密图\label{fig:unnamed-chunk-55-2}]{\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-55-2} }

}

\caption{一维散点图}\label{fig:unnamed-chunk-55}
\end{figure}

气泡图是二维散点图的一种变体，气泡的大小可以用来描述第三个变量，下面以数据集 topo 为例展示气泡图

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载数据集}
\FunctionTok{data}\NormalTok{(topo, }\AttributeTok{package =} \StringTok{"MASS"}\NormalTok{)}
\CommentTok{\# 查看数据集}
\FunctionTok{str}\NormalTok{(topo)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    52 obs. of  3 variables:
##  $ x: num  0.3 1.4 2.4 3.6 5.7 1.6 2.9 3.4 3.4 4.8 ...
##  $ y: num  6.1 6.2 6.1 6.2 6.2 5.2 5.1 5.3 5.7 5.6 ...
##  $ z: int  870 793 755 690 800 800 730 728 710 780 ...
\end{verbatim}

topo 是空间地形数据集，包含有52行3列，数据点是310平方英尺范围内的海拔高度数据，x 坐标每单位50英尺，y 坐标单位同 x 坐标，海拔高度 z 单位是英尺

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{cex =}\NormalTok{ (}\DecValTok{960} \SpecialCharTok{{-}}\NormalTok{ z) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{960} \SpecialCharTok{{-}} \DecValTok{690}\NormalTok{) }\SpecialCharTok{*} \DecValTok{3}\NormalTok{, }\AttributeTok{data =}\NormalTok{ topo,}
  \AttributeTok{xlab =} \StringTok{"X Coordinates"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Y coordinates"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-57-1} 

}

\caption{地形图之海拔高度}\label{fig:unnamed-chunk-57}
\end{figure}

散点图也适合分类数据的展示，在图中用不同颜色或符号标记数据点所属类别，即在普通散点图的基础上添加一分类变量的描述

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(mpg }\SpecialCharTok{\textasciitilde{}}\NormalTok{ hp,}
  \AttributeTok{data =} \FunctionTok{subset}\NormalTok{(mtcars, am }\SpecialCharTok{==} \DecValTok{1}\NormalTok{), }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{35}\NormalTok{)}
\NormalTok{)}
\FunctionTok{points}\NormalTok{(mpg }\SpecialCharTok{\textasciitilde{}}\NormalTok{ hp,}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{,}
  \AttributeTok{data =} \FunctionTok{subset}\NormalTok{(mtcars, am }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\DecValTok{300}\NormalTok{, }\DecValTok{35}\NormalTok{,}
  \FunctionTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"0"}\NormalTok{),}
  \AttributeTok{title =} \StringTok{"am"}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{),}
  \AttributeTok{pch =} \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{16}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/category-base-1} 

}

\caption{分类散点图}\label{fig:category-base}
\end{figure}

iris 数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Width, }\AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{col =}\NormalTok{ Species, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topright"}\NormalTok{,}
  \AttributeTok{legend =} \FunctionTok{unique}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{box.col =} \StringTok{"gray"}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \FunctionTok{unique}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)}
\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/iris-scatter-1} 

}

\caption{分类散点图}\label{fig:iris-scatter}
\end{figure}

分组散点图和平滑

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(carData)}
\FunctionTok{library}\NormalTok{(car)}
\FunctionTok{scatterplot}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Width,}
  \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"black"}\NormalTok{, }\StringTok{"red"}\NormalTok{, }\StringTok{"blue"}\NormalTok{), }\AttributeTok{pch =} \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{16}\NormalTok{, }\DecValTok{16}\NormalTok{),}
  \AttributeTok{smooth =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{boxplots =} \StringTok{"xy"}\NormalTok{, }\AttributeTok{groups =}\NormalTok{ iris}\SpecialCharTok{$}\NormalTok{Species,}
  \AttributeTok{xlab =} \StringTok{"Sepal.Width"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Sepal.Length"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ iris}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

有时为了实现特定的目的，需要高亮其中某些点，按类别或者因子变量分组绘制散点图，这里继续采用 \texttt{stripchart} 函数绘制二维散点图\ref{fig:scatter-iris}，由左图可知，函数 \texttt{stripchart} 提供的参数 \texttt{pch} 不接受向量，实际只是取了前三个值 16 16 17 对应于 Species 的三类，关键是高亮的分界点是有区分意义的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"iris"}\NormalTok{)}
\NormalTok{pch }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{16}\NormalTok{, }\FunctionTok{length}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Petal.Length))}
\NormalTok{pch[}\FunctionTok{which}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Petal.Length }\SpecialCharTok{\textless{}} \FloatTok{1.4}\NormalTok{)] }\OtherTok{\textless{}{-}} \DecValTok{17}
\FunctionTok{stripchart}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris,}
  \AttributeTok{vertical =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{method =} \StringTok{"jitter"}\NormalTok{,}
  \AttributeTok{pch =}\NormalTok{ pch}
\NormalTok{)}
\CommentTok{\# 对比一下}
\FunctionTok{stripchart}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{subset =}\NormalTok{ Petal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{1.4}\NormalTok{,}
  \AttributeTok{vertical =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{method =} \StringTok{"jitter"}\NormalTok{, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{7}\NormalTok{),}
  \AttributeTok{pch =} \DecValTok{16}
\NormalTok{)}
\FunctionTok{stripchart}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{subset =}\NormalTok{ Petal.Length }\SpecialCharTok{\textless{}} \FloatTok{1.4}\NormalTok{,}
  \AttributeTok{vertical =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{method =} \StringTok{"jitter"}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[原图\label{fig:scatter-iris-1}]{\includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/scatter-iris-1} }\subfloat[高亮\label{fig:scatter-iris-2}]{\includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/scatter-iris-2} }

}

\caption{高亮图中部分散点}\label{fig:scatter-iris}
\end{figure}

如果存在大量散点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{densCols}\NormalTok{(x,}
  \AttributeTok{y =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{nbin =} \DecValTok{128}\NormalTok{, bandwidth,}
  \AttributeTok{colramp =} \FunctionTok{colorRampPalette}\NormalTok{(blues9[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{densCols} 函数根据点的局部密度生成颜色，密度估计采用核平滑法，由 \textbf{KernSmooth} 包的 \texttt{bkde2D} 函数实现。参数 \texttt{colramp} 传递一个函数，\texttt{colorRampPalette} 根据给定的几种颜色生成函数，参数 \texttt{bandwidth} 实际上是传给 \texttt{bkde2D} 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(faithful,}
  \AttributeTok{col =} \FunctionTok{densCols}\NormalTok{(faithful),}
  \AttributeTok{pch =} \DecValTok{20}\NormalTok{, }\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/densCols-1} 

}

\caption{根据点的密度生成颜色}\label{fig:densCols}
\end{figure}

气泡图也是散点图的一种

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Volume }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Height,}
  \AttributeTok{data =}\NormalTok{ trees, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{cex =}\NormalTok{ Girth }\SpecialCharTok{/} \DecValTok{8}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{rev}\NormalTok{(}\FunctionTok{terrain.colors}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(trees), }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{5}\NormalTok{))}
\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-60-1} 

}

\caption{气泡图}\label{fig:unnamed-chunk-60}
\end{figure}

气泡图

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 空白画布}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{),}
     \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# 添加坐标轴}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{), }\AttributeTok{labels =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{), }\AttributeTok{labels =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{) }\CommentTok{\# 在当前图形上添加图形}
\CommentTok{\# axes 坐标轴上的刻度 "xaxt" or "yaxt"  ann 坐标轴和标题的标签}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{), }\FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{cex =} \FunctionTok{runif}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{)[}\FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), }\DecValTok{100}\NormalTok{)],}
  \AttributeTok{bg =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"gray"}\NormalTok{, }\FunctionTok{replicate}\NormalTok{(}\DecValTok{100}\NormalTok{, }\FunctionTok{sample}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{), }\DecValTok{1}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{))),}
  \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{pch =} \DecValTok{21}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"top"}\NormalTok{,}
  \AttributeTok{legend =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"class"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{)), }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{),}
  \AttributeTok{pt.lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{pch =} \DecValTok{21}\NormalTok{, }\AttributeTok{box.col =} \StringTok{"gray"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-61-1} \end{center}

除了\texttt{par(new=TRUE)}设置外，有些函数本身就具有 \texttt{add} 选项

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(dist }\SpecialCharTok{\textasciitilde{}}\NormalTok{ speed, }\AttributeTok{data =}\NormalTok{ cars, }\AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{)}
\FunctionTok{with}\NormalTok{(cars, }\FunctionTok{symbols}\NormalTok{(dist }\SpecialCharTok{\textasciitilde{}}\NormalTok{ speed,}
  \AttributeTok{circles =} \FunctionTok{runif}\NormalTok{(}\FunctionTok{length}\NormalTok{(speed), }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{inches =}\NormalTok{ .}\DecValTok{5}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}
\NormalTok{))}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(dist }\SpecialCharTok{\textasciitilde{}}\NormalTok{ speed, }\AttributeTok{data =}\NormalTok{ cars)}
\FunctionTok{abline}\NormalTok{(z, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{)}
\FunctionTok{curve}\NormalTok{(tan, }\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ pi, }\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(stats}\SpecialCharTok{::}\FunctionTok{lowess}\NormalTok{(cars))}
\FunctionTok{points}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"green"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{80}\NormalTok{, }\StringTok{"text here"}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-62-1} \end{center}

\hypertarget{base-jitter}{%
\subsection{抖动图}\label{base-jitter}}

抖动散点图

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mat }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(}\FunctionTok{colors}\NormalTok{()), }\AttributeTok{ncol =} \DecValTok{9}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{col =} \FunctionTok{colors}\NormalTok{(),}
  \AttributeTok{x =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(}\FunctionTok{colors}\NormalTok{()), }\DecValTok{9}\NormalTok{)),}
  \AttributeTok{y =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{73}\NormalTok{, }\DecValTok{9}\NormalTok{), }\AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.1}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{jitter}\NormalTok{(x),}
  \AttributeTok{data =}\NormalTok{ df, }\AttributeTok{col =}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{col,}
  \AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{main =} \StringTok{"Visualizing colors() split in 9 groups"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Group"}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"Element of the group (min = 1, max = 73)"}\NormalTok{,}
  \AttributeTok{sub =} \StringTok{"x = 3, y = 1 means that it\textquotesingle{}s the 2 * 73 + 1 = 147th color"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/jitter-scatter-1} 

}

\caption{抖动散点图}\label{fig:jitter-scatter}
\end{figure}

\hypertarget{plot-box}{%
\subsection{箱线图}\label{plot-box}}

boxplotdbl: Double Box Plot for Two-Axes Correlation. Correlation chart of two set (x and y) of data. Using Quartiles with boxplot style. Visualize the effect of factor.

\href{https://tomizonor.wordpress.com/2013/03/15/double-box-plot/}{复合箱线图}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, \{}
\NormalTok{  op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, .}\DecValTok{5}\NormalTok{))}
  \FunctionTok{plot}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species)}
  \FunctionTok{plot}\NormalTok{(Sepal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species)}
  \FunctionTok{plot}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species)}
  \FunctionTok{plot}\NormalTok{(Petal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species)}
  \FunctionTok{par}\NormalTok{(op)}
  \FunctionTok{mtext}\NormalTok{(}\StringTok{"Edgar Anderson\textquotesingle{}s Iris Data"}\NormalTok{, }\AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{line =} \DecValTok{4}\NormalTok{)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/iris-1} 

}

\caption{安德森的鸢尾花数据}\label{fig:iris}
\end{figure}

箱线图的花样也很多

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(InsectSprays)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, .}\DecValTok{5}\NormalTok{, .}\DecValTok{5}\NormalTok{))}
\FunctionTok{boxplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ InsectSprays, count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray,}
  \AttributeTok{col =} \StringTok{"gray"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Spray"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Count"}
\NormalTok{)}

\FunctionTok{boxplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ InsectSprays, count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray,}
  \AttributeTok{col =} \StringTok{"gray"}\NormalTok{, }\AttributeTok{horizontal =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Count"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Spray"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[垂直放置\label{fig:unnamed-chunk-63-1}]{\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-63-1} }\newline\subfloat[水平放置\label{fig:unnamed-chunk-63-2}]{\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-63-2} }

}

\caption{箱线图}\label{fig:unnamed-chunk-63}
\end{figure}

Notched Boxplots

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{8}
\NormalTok{g }\OtherTok{\textless{}{-}} \FunctionTok{gl}\NormalTok{(n, }\DecValTok{100}\NormalTok{, n }\SpecialCharTok{*} \DecValTok{100}\NormalTok{) }\CommentTok{\# n水平个数 100是重复次数}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(n }\SpecialCharTok{*} \DecValTok{100}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(g))}
\FunctionTok{boxplot}\NormalTok{(}\FunctionTok{split}\NormalTok{(x, g), }\AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(n), }\AttributeTok{notch =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{title}\NormalTok{(}
  \AttributeTok{main =} \StringTok{"Notched Boxplots"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Group"}\NormalTok{,}
  \AttributeTok{font.main =} \DecValTok{4}\NormalTok{, }\AttributeTok{font.lab =} \DecValTok{1}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-64-1} \end{center}

真实的情况是这样的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumcm2011A }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\AttributeTok{file =} \StringTok{"cumcm2011A.RDS"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(As, }\AttributeTok{xlab =} \StringTok{"As"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\FloatTok{3.6}\NormalTok{, }\FloatTok{5.4}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Cd, }\AttributeTok{xlab =} \StringTok{"Cd"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{130}\NormalTok{, }\DecValTok{190}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Cr, }\AttributeTok{xlab =} \StringTok{"Cr"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{13}\NormalTok{, }\DecValTok{31}\NormalTok{, }\DecValTok{49}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Cu, }\AttributeTok{xlab =} \StringTok{"Cu"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\FloatTok{6.0}\NormalTok{, }\FloatTok{13.2}\NormalTok{, }\FloatTok{20.4}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Hg, }\AttributeTok{xlab =} \StringTok{"Hg"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{19}\NormalTok{, }\DecValTok{35}\NormalTok{, }\DecValTok{51}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Ni, }\AttributeTok{xlab =} \StringTok{"Ni"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.7}\NormalTok{, }\FloatTok{12.3}\NormalTok{, }\FloatTok{19.9}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Pb, }\AttributeTok{xlab =} \StringTok{"Pb"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{19}\NormalTok{, }\DecValTok{31}\NormalTok{, }\DecValTok{43}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Zn, }\AttributeTok{xlab =} \StringTok{"Zn"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{41}\NormalTok{, }\DecValTok{69}\NormalTok{, }\DecValTok{97}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(As }\SpecialCharTok{\textasciitilde{}}\NormalTok{ area,}
  \AttributeTok{data =}\NormalTok{ cumcm2011A,}
  \AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}
  \AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\FloatTok{3.6}\NormalTok{, }\FloatTok{5.4}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{),}
  \AttributeTok{lty =} \DecValTok{2}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{error-bars}{%
\subsection{残差图}\label{error-bars}}

iris 四个测量指标

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vec\_mean }\OtherTok{\textless{}{-}} \FunctionTok{colMeans}\NormalTok{(iris[, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{])}
\NormalTok{vec\_sd }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(iris[, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{], }\DecValTok{2}\NormalTok{, sd)}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), vec\_mean,}
  \AttributeTok{ylim =} \FunctionTok{range}\NormalTok{(}\FunctionTok{c}\NormalTok{(vec\_mean }\SpecialCharTok{{-}}\NormalTok{ vec\_sd, vec\_mean }\SpecialCharTok{+}\NormalTok{ vec\_sd)),}
  \AttributeTok{xlab =} \StringTok{"Species"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Mean +/{-} SD"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{1}\NormalTok{, }\AttributeTok{pch =} \DecValTok{19}\NormalTok{,}
  \AttributeTok{axes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{colnames}\NormalTok{(iris)[}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{])}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{7}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{7}\NormalTok{))}
\FunctionTok{arrows}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), vec\_mean }\SpecialCharTok{{-}}\NormalTok{ vec\_sd, }\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), vec\_mean }\SpecialCharTok{+}\NormalTok{ vec\_sd,}
  \AttributeTok{length =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{code =} \DecValTok{3}
\NormalTok{)}
\FunctionTok{box}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-67-1} 

}

\caption{带标准差的均值散点图}\label{fig:unnamed-chunk-67}
\end{figure}

\hypertarget{plot-violin}{%
\subsection{提琴图}\label{plot-violin}}

Tom Kelly 维护的 vioplot 包 \url{https://github.com/TomKellyGenetics/vioplot}

\hypertarget{plot-contour}{%
\subsection{轮廓图}\label{plot-contour}}

topo 是地形数据

等高线图

\hypertarget{plot-line}{%
\subsection{折线图}\label{plot-line}}

函数曲线，样条曲线，核密度曲线，平行坐标图

\begin{itemize}
\tightlist
\item
  折线图
\item
  点线图 \texttt{plot(type="b")} 函数曲线图 \texttt{curve} \texttt{matplot} X 样条曲线 \texttt{xspline}
\item
  时序图
\end{itemize}

太阳黑子活动数据

sunspot.month Monthly Sunspot Data, from 1749 to ``Present'' sunspot.year Yearly Sunspot Data, 1700-1988 sunspots Monthly Sunspot Numbers, 1749-1983

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(AirPassengers)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-68-1} 

}

\caption{折线图}\label{fig:unnamed-chunk-68}
\end{figure}

\hypertarget{function}{%
\subsection{函数图}\label{function}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x0 }\OtherTok{\textless{}{-}} \DecValTok{2}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{20}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{nus }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{501}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(x0, x0}\SpecialCharTok{\^{}{-}}\DecValTok{8}\NormalTok{,}
  \AttributeTok{frame.plot =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 添加绘图框}
  \AttributeTok{log =} \StringTok{"xy"}\NormalTok{, }\CommentTok{\# x 和 y 轴都取对数尺度}
  \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 去掉坐标轴}
  \AttributeTok{xlab =} \StringTok{"$u$"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathcal\{K\}\_\{}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{kappa\}(u)$"}\NormalTok{, }\CommentTok{\# 设置坐标轴标签}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\CommentTok{\# 清除绘图区域的内容}
  \AttributeTok{ann =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 添加标题 x和y轴标签}
  \AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{() }\CommentTok{\# 添加背景参考线}
\NormalTok{)}

\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{at =} \DecValTok{10}\SpecialCharTok{\^{}}\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }\AttributeTok{to =} \DecValTok{2}\NormalTok{, }\AttributeTok{by =} \DecValTok{2}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathsf\{10\^{}\{"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }\AttributeTok{to =} \DecValTok{2}\NormalTok{, }\AttributeTok{by =} \DecValTok{2}\NormalTok{), }\StringTok{"\}\}$"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{,}
  \AttributeTok{at =} \DecValTok{10}\SpecialCharTok{\^{}}\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }\AttributeTok{to =} \DecValTok{56}\NormalTok{, }\AttributeTok{by =} \DecValTok{16}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathsf\{10\^{}\{"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }\AttributeTok{to =} \DecValTok{56}\NormalTok{, }\AttributeTok{by =} \DecValTok{16}\NormalTok{), }\StringTok{"\}\}$"}\NormalTok{), }\AttributeTok{las =} \DecValTok{1}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\FunctionTok{length}\NormalTok{(nus))) \{}
  \FunctionTok{lines}\NormalTok{(x0, }\FunctionTok{besselK}\NormalTok{(x0, }\AttributeTok{nu =}\NormalTok{ nus[i]), }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{9}\NormalTok{)[i], }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topright"}\NormalTok{,}
  \AttributeTok{legend =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{kappa="}\NormalTok{, }\FunctionTok{rev}\NormalTok{(nus), }\StringTok{"$"}\NormalTok{),}
  \AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{9}\NormalTok{, }\AttributeTok{rev =}\NormalTok{ T), }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \DecValTok{1}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.65\linewidth]{graphics-foundations_files/figure-latex/bessel-function-1} 

}

\caption{贝塞尔函数}\label{fig:bessel-function}
\end{figure}

还有 eta 函数和 gammaz 函数

\hypertarget{plot-mosaic}{%
\subsection{马赛克图}\label{plot-mosaic}}

马赛克图 mosaicplot

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(HairEyeColor, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-69-1} 

}

\caption{马赛克图}\label{fig:unnamed-chunk-69}
\end{figure}

\hypertarget{plot-dotchart}{%
\subsection{点图}\label{plot-dotchart}}

dotchart 克利夫兰点图

条件图 coplot

\hypertarget{plot-matrix}{%
\subsection{矩阵图}\label{plot-matrix}}

在对角线上添加平滑曲线、密度曲线

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pairs}\NormalTok{(longley,}
  \AttributeTok{gap =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{diag.panel =} \ControlFlowTok{function}\NormalTok{(x, ...) \{}
    \FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}
    \FunctionTok{hist}\NormalTok{(x,}
      \AttributeTok{col =} \StringTok{"light blue"}\NormalTok{,}
      \AttributeTok{probability =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
      \AttributeTok{main =} \StringTok{""}
\NormalTok{    )}
    \FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(x),}
      \AttributeTok{col =} \StringTok{"red"}\NormalTok{,}
      \AttributeTok{lwd =} \DecValTok{3}
\NormalTok{    )}
    \FunctionTok{rug}\NormalTok{(x)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-70-1} 

}

\caption{变量关系}\label{fig:unnamed-chunk-70}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 自带 layout}
\FunctionTok{plot}\NormalTok{(iris[, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{], }\AttributeTok{col =}\NormalTok{ iris}\SpecialCharTok{$}\NormalTok{Species)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-71-1} 

}

\caption{矩阵图}\label{fig:unnamed-chunk-71}
\end{figure}

\hypertarget{plot-radar}{%
\subsection{雷达图}\label{plot-radar}}

星图 stars 多元数据

\hypertarget{plot-rose}{%
\subsection{玫瑰图}\label{plot-rose}}

注意与 image 函数区别

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{10} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(volcano))}
\NormalTok{y }\OtherTok{\textless{}{-}} \DecValTok{10} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(volcano))}
\FunctionTok{image}\NormalTok{(x, y, volcano, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{100}\NormalTok{), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{contour}\NormalTok{(x, y, volcano,}
  \AttributeTok{levels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{200}\NormalTok{, }\AttributeTok{by =} \DecValTok{5}\NormalTok{),}
  \AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{col =} \StringTok{"peru"}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{800}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{))}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{600}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{))}
\FunctionTok{box}\NormalTok{()}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Maunga Whau Volcano"}\NormalTok{, }\AttributeTok{font.main =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-72-1} 

}

\caption{image 图形}\label{fig:unnamed-chunk-72}
\end{figure}

\hypertarget{plot-persp}{%
\subsection{透视图}\label{plot-persp}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(.}\DecValTok{5}\NormalTok{, }\FloatTok{2.1}\NormalTok{, .}\DecValTok{5}\NormalTok{, .}\DecValTok{5}\NormalTok{))}
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length =} \DecValTok{51}\NormalTok{)}
\NormalTok{x2 }\OtherTok{\textless{}{-}}\NormalTok{ x1 }
\NormalTok{f }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x1, x2, }\AttributeTok{mu1 =} \DecValTok{0}\NormalTok{, }\AttributeTok{mu2 =} \DecValTok{0}\NormalTok{, }\AttributeTok{s11 =} \DecValTok{10}\NormalTok{, }\AttributeTok{s12 =} \DecValTok{15}\NormalTok{, }\AttributeTok{s22 =} \DecValTok{10}\NormalTok{, }\AttributeTok{rho =} \FloatTok{0.5}\NormalTok{) \{}
\NormalTok{  term1 }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(s11 }\SpecialCharTok{*}\NormalTok{ s22 }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ rho}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)))}
\NormalTok{  term2 }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ rho}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\NormalTok{  term3 }\OtherTok{\textless{}{-}}\NormalTok{ (x1 }\SpecialCharTok{{-}}\NormalTok{ mu1)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{/}\NormalTok{ s11}
\NormalTok{  term4 }\OtherTok{\textless{}{-}}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ mu2)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{/}\NormalTok{ s22}
\NormalTok{  term5 }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ rho }\SpecialCharTok{*}\NormalTok{ ((x1 }\SpecialCharTok{{-}}\NormalTok{ mu1) }\SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ mu2)) }\SpecialCharTok{/}\NormalTok{ (}\FunctionTok{sqrt}\NormalTok{(s11) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(s22))}
\NormalTok{  term1 }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(term2 }\SpecialCharTok{*}\NormalTok{ (term3 }\SpecialCharTok{+}\NormalTok{ term4 }\SpecialCharTok{{-}}\NormalTok{ term5))}
\NormalTok{\} }
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{outer}\NormalTok{(x1, x2, f) }
\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{persp}\NormalTok{(x1, x2, z,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{zlab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{drapecol}\NormalTok{(z, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{20}\NormalTok{)),}
  \AttributeTok{border =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{shade =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{r =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{expand =} \FloatTok{0.5}\NormalTok{,}
  \AttributeTok{theta =} \DecValTok{120}\NormalTok{, }\AttributeTok{phi =} \DecValTok{15}\NormalTok{, }\AttributeTok{ltheta =} \DecValTok{90}\NormalTok{, }\AttributeTok{lphi =} \DecValTok{180}\NormalTok{,}
  \AttributeTok{ticktype =} \StringTok{"detailed"}\NormalTok{, }\AttributeTok{nticks =} \DecValTok{5}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/normal-dist-1} 

}

\caption{统计学的世界}\label{fig:normal-dist}
\end{figure}

\hypertarget{lattice-graphics}{%
\section{栅格统计图形}\label{lattice-graphics}}

\begin{quote}
If you imagine that this pen is Trellis, then Lattice is not this pen.

\hspace*{\fill} --- Paul Murrell \footnote{Paul 在 DSC 2001 大会上的幻灯片 见\url{https://www.stat.auckland.ac.nz/~paul/Talks/dsc2001.pdf}}
\end{quote}

把网站搬出来，汉化 \url{http://latticeextra.r-forge.r-project.org/}

\hypertarget{lattice-boxplot}{%
\subsection{箱线图}\label{lattice-boxplot}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(lattice)}
\CommentTok{\# plot(data = InsectSprays, count \textasciitilde{} spray)}
\FunctionTok{bwplot}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-73-1} \end{center}

\hypertarget{lattice-line}{%
\subsection{折线图}\label{lattice-line}}

latticeExtra 包提供了强大的图层函数 \texttt{layer()}

多元时间序列

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(RColorBrewer)}
\FunctionTok{library}\NormalTok{(latticeExtra)}
\FunctionTok{xyplot}\NormalTok{(EuStockMarkets) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}\FunctionTok{panel.scaleArrow}\NormalTok{(}
    \AttributeTok{x =} \FloatTok{0.99}\NormalTok{, }\AttributeTok{append =} \StringTok{" units"}\NormalTok{, }\AttributeTok{col =} \StringTok{"grey"}\NormalTok{, }\AttributeTok{srt =} \DecValTok{90}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.8}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-74-1} \end{center}

如何解释

时序图

Plot many time series in parallel

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{horizonplot}\NormalTok{(EuStockMarkets,}
  \AttributeTok{colorkey =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{origin =} \DecValTok{4000}\NormalTok{, }\AttributeTok{horizonscale =} \DecValTok{1000}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}\FunctionTok{panel.scaleArrow}\NormalTok{(}
    \AttributeTok{x =} \FloatTok{0.99}\NormalTok{, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \StringTok{"grey"}\NormalTok{,}
    \AttributeTok{srt =} \DecValTok{90}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.7}
\NormalTok{  )) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}
\NormalTok{    lim }\OtherTok{\textless{}{-}} \FunctionTok{current.panel.limits}\NormalTok{(),}
    \FunctionTok{panel.text}\NormalTok{(lim}\SpecialCharTok{$}\NormalTok{x[}\DecValTok{1}\NormalTok{], lim}\SpecialCharTok{$}\NormalTok{y[}\DecValTok{1}\NormalTok{], }\FunctionTok{round}\NormalTok{(lim}\SpecialCharTok{$}\NormalTok{y[}\DecValTok{1}\NormalTok{], }\DecValTok{1}\NormalTok{),}
      \AttributeTok{font =} \DecValTok{2}\NormalTok{,}
      \AttributeTok{cex =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{adj =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{), }\AttributeTok{col =} \StringTok{"\#9FC8DC"}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-75-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# \# https://stackoverflow.com/questions/25109196/r{-}lattice{-}package{-}add{-}legend{-}to{-}a{-}figure}
\FunctionTok{library}\NormalTok{(lattice)}
\FunctionTok{library}\NormalTok{(nlme)}

\FunctionTok{plot}\NormalTok{(Orange,}
  \AttributeTok{outer =} \SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{,}
  \AttributeTok{key =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{space =} \StringTok{"right"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Tree"}\NormalTok{, }\AttributeTok{cex.title =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{lines =} \FunctionTok{list}\NormalTok{(}\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{5}\NormalTok{)),}
    \CommentTok{\# points = list(pch = 1, col = gray.colors(5)),}
    \AttributeTok{text =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"3"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"5"}\NormalTok{, }\StringTok{"2"}\NormalTok{, }\StringTok{"4"}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}
    \CommentTok{\# plot.line = list(col = gray.colors(5), border = "transparent"),}
    \CommentTok{\# plot.symbol = list(col = gray.colors(5), border = "transparent"),}
    \AttributeTok{strip.background =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"white"}\NormalTok{),}
    \AttributeTok{strip.border =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-76-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(MASS)}
\FunctionTok{library}\NormalTok{(lattice)}
\DocumentationTok{\#\# Plot the claims frequency against age group by engine size and district}

\FunctionTok{barchart}\NormalTok{(Claims }\SpecialCharTok{/}\NormalTok{ Holders }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Age }\SpecialCharTok{|}\NormalTok{ Group,}
  \AttributeTok{groups =}\NormalTok{ District,}
  \AttributeTok{data =}\NormalTok{ Insurance, }\AttributeTok{origin =} \DecValTok{0}\NormalTok{, }\AttributeTok{auto.key =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-77-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barchart}\NormalTok{(Claims }\SpecialCharTok{/}\NormalTok{ Holders }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Age }\SpecialCharTok{|}\NormalTok{ Group,}
  \AttributeTok{groups =}\NormalTok{ District, }\AttributeTok{data =}\NormalTok{ Insurance,}
  \AttributeTok{main =} \StringTok{"Claims frequency"}\NormalTok{,}
  \AttributeTok{auto.key =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{space =} \StringTok{"top"}\NormalTok{, }\AttributeTok{columns =} \DecValTok{4}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"District"}\NormalTok{, }\AttributeTok{cex.title =} \DecValTok{1}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-78-1} \end{center}

lattice 图形的参数设置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{show.settings}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{graphics-foundations_files/figure-latex/lattice-settings-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{myColours }\OtherTok{\textless{}{-}} \FunctionTok{brewer.pal}\NormalTok{(}\DecValTok{6}\NormalTok{, }\StringTok{"Blues"}\NormalTok{)}
\NormalTok{my.settings }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{superpose.polygon =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =}\NormalTok{ myColours[}\DecValTok{2}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], }\AttributeTok{border =} \StringTok{"transparent"}\NormalTok{),}
  \AttributeTok{strip.background =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =}\NormalTok{ myColours[}\DecValTok{6}\NormalTok{]),}
  \AttributeTok{strip.border =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# 获取参数设置}
\FunctionTok{trellis.par.get}\NormalTok{()}

\CommentTok{\# 全局参数设置}
\FunctionTok{trellis.par.set}\NormalTok{(my.settings)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(MASS)}
\FunctionTok{library}\NormalTok{(lattice)}

\FunctionTok{barchart}\NormalTok{(Claims }\SpecialCharTok{/}\NormalTok{ Holders }\SpecialCharTok{*} \DecValTok{100} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Age }\SpecialCharTok{|}\NormalTok{ Group,}
  \AttributeTok{groups =}\NormalTok{ District, }\AttributeTok{data =}\NormalTok{ Insurance,}
  \AttributeTok{origin =} \DecValTok{0}\NormalTok{, }\AttributeTok{main =} \StringTok{"Motor insurance claims frequency"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Age"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Claims frequency \%"}\NormalTok{,}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{alternating =} \DecValTok{1}\NormalTok{),}
  \AttributeTok{auto.key =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{space =} \StringTok{"top"}\NormalTok{, }\AttributeTok{columns =} \DecValTok{4}\NormalTok{, }
    \AttributeTok{points =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{rectangles =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"District"}\NormalTok{, }\AttributeTok{cex.title =} \DecValTok{1}
\NormalTok{  ),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{superpose.polygon =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{border =} \StringTok{"transparent"}\NormalTok{),}
    \AttributeTok{strip.background =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray80"}\NormalTok{),}
    \AttributeTok{strip.border =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{par.strip.text =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray40"}\NormalTok{, }\AttributeTok{font =} \DecValTok{2}\NormalTok{),}
  \AttributeTok{panel =} \ControlFlowTok{function}\NormalTok{(x, y, ...) \{}
    \FunctionTok{panel.grid}\NormalTok{(}\AttributeTok{h =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{v =} \DecValTok{0}\NormalTok{)}
    \FunctionTok{panel.barchart}\NormalTok{(x, y, ...)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-80-1} \end{center}

\hypertarget{lattice-smooth}{%
\subsection{平滑图}\label{lattice-smooth}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{xy }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{runif}\NormalTok{(}\DecValTok{100}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{rt}\NormalTok{(}\DecValTok{100}\NormalTok{, }\AttributeTok{df =} \DecValTok{5}\NormalTok{)}
\NormalTok{)}

\FunctionTok{xyplot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, xy, }\AttributeTok{panel =} \ControlFlowTok{function}\NormalTok{(...) \{}
  \FunctionTok{panel.xyplot}\NormalTok{(...)}
  \FunctionTok{panel.smoother}\NormalTok{(..., }\AttributeTok{span =} \FloatTok{0.9}\NormalTok{)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-81-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(splines)}
\FunctionTok{xyplot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, xy) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}\FunctionTok{panel.smoother}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{ns}\NormalTok{(x, }\DecValTok{5}\NormalTok{), }\AttributeTok{method =} \StringTok{"lm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-81-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(nlme)}
\FunctionTok{library}\NormalTok{(mgcv)}
\FunctionTok{xyplot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, xy) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}\FunctionTok{panel.smoother}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x), }\AttributeTok{method =} \StringTok{"gam"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-81-3} \end{center}

Trellis Displays of Tukey's Hanging Rootograms

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rpois}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\AttributeTok{lambda =} \DecValTok{50}\NormalTok{)}
\FunctionTok{rootogram}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{x, }\AttributeTok{dfun =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{dpois}\NormalTok{(x, }\AttributeTok{lambda =} \DecValTok{50}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-82-1} \end{center}

\hypertarget{lattice-dotplot}{%
\subsection{点图}\label{lattice-dotplot}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 添加背景网格线作为参考线}
\FunctionTok{segplot}\NormalTok{(}\FunctionTok{reorder}\NormalTok{(}\FunctionTok{factor}\NormalTok{(county), rate.male) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LCL95.male }\SpecialCharTok{+}\NormalTok{ UCL95.male,}
  \AttributeTok{data =} \FunctionTok{subset}\NormalTok{(USCancerRates, state }\SpecialCharTok{==} \StringTok{"Washington"}\NormalTok{),}
  \AttributeTok{draw.bands =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{centers =}\NormalTok{ rate.male}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-83-1} \end{center}

\hypertarget{lattice-step}{%
\subsection{阶梯图}\label{lattice-step}}

经验累积分布图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ecdfplot}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{height }\SpecialCharTok{|}\NormalTok{ voice.part, }\AttributeTok{data =}\NormalTok{ singer)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-84-1} \end{center}

\hypertarget{lattice-facet}{%
\subsection{分面图}\label{lattice-facet}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# a variant of Figure 5.6 from Sarkar (2008)}
\DocumentationTok{\#\# http://lmdvr.r{-}forge.r{-}project.org/figures/figures.html?chapter=05;figure=05\_06}

\NormalTok{depth.ord }\OtherTok{\textless{}{-}} \FunctionTok{rev}\NormalTok{(}\FunctionTok{order}\NormalTok{(quakes}\SpecialCharTok{$}\NormalTok{depth))}
\NormalTok{quakes}\SpecialCharTok{$}\NormalTok{Magnitude }\OtherTok{\textless{}{-}} \FunctionTok{equal.count}\NormalTok{(quakes}\SpecialCharTok{$}\NormalTok{mag, }\DecValTok{4}\NormalTok{)}
\NormalTok{quakes.ordered }\OtherTok{\textless{}{-}}\NormalTok{ quakes[depth.ord, ]}

\FunctionTok{levelplot}\NormalTok{(depth }\SpecialCharTok{\textasciitilde{}}\NormalTok{ long }\SpecialCharTok{+}\NormalTok{ lat }\SpecialCharTok{|}\NormalTok{ Magnitude,}
  \AttributeTok{data =}\NormalTok{ quakes.ordered,}
  \AttributeTok{panel =}\NormalTok{ panel.levelplot.points, }\AttributeTok{type =} \FunctionTok{c}\NormalTok{(}\StringTok{"p"}\NormalTok{, }\StringTok{"g"}\NormalTok{),}
  \AttributeTok{aspect =} \StringTok{"iso"}\NormalTok{, }\AttributeTok{prepanel =}\NormalTok{ prepanel.default.xyplot}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-85-1} \end{center}

\hypertarget{lattice-contour}{%
\subsection{等高线图}\label{lattice-contour}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{xyz }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{), }\AttributeTok{y =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{))}
\NormalTok{xyz}\SpecialCharTok{$}\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(xyz, x }\SpecialCharTok{*}\NormalTok{ y }\SpecialCharTok{+} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\AttributeTok{sd =} \DecValTok{1}\NormalTok{))}

\DocumentationTok{\#\# GAM smoother with smoothness by cross validation}
\FunctionTok{library}\NormalTok{(mgcv)}
\FunctionTok{levelplot}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y, xyz,}
  \AttributeTok{panel =}\NormalTok{ panel}\FloatTok{.2}\NormalTok{dsmoother,}
  \AttributeTok{form =}\NormalTok{ z }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, y), }\AttributeTok{method =} \StringTok{"gam"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/smoothness-1} \end{center}

\hypertarget{lattice-persp}{%
\subsection{透视图}\label{lattice-persp}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{persp}\NormalTok{(volcano, }
  \AttributeTok{theta =} \DecValTok{30}\NormalTok{, }\AttributeTok{phi =} \DecValTok{20}\NormalTok{, }
  \AttributeTok{r =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{expand =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{ltheta =} \DecValTok{90}\NormalTok{, }\AttributeTok{lphi =} \DecValTok{180}\NormalTok{,}
  \AttributeTok{shade =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{ticktype =} \StringTok{"detailed"}\NormalTok{, }\AttributeTok{nticks =} \DecValTok{5}\NormalTok{, }\AttributeTok{box =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{drapecol}\NormalTok{(volcano, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{100}\NormalTok{)),}
  \AttributeTok{xlab =} \StringTok{"X"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Y"}\NormalTok{, }\AttributeTok{zlab =} \StringTok{"Z"}\NormalTok{, }\AttributeTok{border =} \StringTok{"transparent"}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"Topographic Information }\SpecialCharTok{\textbackslash{}n}\StringTok{ on Auckland\textquotesingle{}s Maunga Whau Volcano"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/volcano-topo-1} 

}

\caption{Auckland Maunga Whau 火山地形图 \(10m\times 10m\)。火山的实况地形图 \url{https://en.wikipedia.org/wiki/Maungawhau_/_Mount_Eden}。}\label{fig:volcano-topo}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(volcano,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]),}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]),}
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \SpecialCharTok{{-}}\DecValTok{45}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/volcano-shade-1} 

}

\caption{Auckland Maunga Whau 火山地形图 \(10m\times 10m\)。火山的实况地形图 \url{https://en.wikipedia.org/wiki/Maungawhau_/_Mount_Eden}。}\label{fig:volcano-shade}
\end{figure}



\hypertarget{lattice-map}{%
\subsection{地图}\label{lattice-map}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(maps)}
\FunctionTok{library}\NormalTok{(mapproj)}
\FunctionTok{library}\NormalTok{(latticeExtra)}
\CommentTok{\# 找一个新的 map 包含夏威夷和阿拉斯加}
\DocumentationTok{\#\# this generates warnings with both USCancerRates and ancestry.}
\FunctionTok{data}\NormalTok{(USCancerRates)}
\FunctionTok{mapplot}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(USCancerRates) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{log}\NormalTok{(rate.male) }\SpecialCharTok{+} \FunctionTok{log}\NormalTok{(rate.female),}
  \AttributeTok{data =}\NormalTok{ USCancerRates,}
  \AttributeTok{map =} \FunctionTok{map}\NormalTok{(}\StringTok{"county"}\NormalTok{,}
    \AttributeTok{plot =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{projection =} \StringTok{"mercator"}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in (function (x, y, map, breaks, colramp, exact = FALSE, lwd = 0.5, : 65
## unmatched regions: alaska,nome, alaska,wade hampton, alaska,haines, alaska,....
\end{verbatim}

\begin{verbatim}
## Warning in (function (x, y, map, breaks, colramp, exact = FALSE, lwd = 0.5, : 65
## unmatched regions: alaska,nome, alaska,wade hampton, alaska,haines, alaska,....
\end{verbatim}

\begin{figure}

{\centering \includegraphics[width=1\linewidth]{graphics-foundations_files/figure-latex/map-1} 

}

\caption{maps 包提供的 county 数据集不包含阿拉斯加和夏威夷两个州。}\label{fig:map}
\end{figure}



\hypertarget{lattice-cluster}{%
\subsection{聚类图}\label{lattice-cluster}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xyplot}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Petal.Length,}
  \AttributeTok{groups =}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{scales =} \StringTok{"free"}\NormalTok{,}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{superpose.symbol =} \FunctionTok{list}\NormalTok{(}\AttributeTok{pch =} \FunctionTok{c}\NormalTok{(}\DecValTok{15}\SpecialCharTok{:}\DecValTok{17}\NormalTok{)),}
    \AttributeTok{superpose.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{panel =} \ControlFlowTok{function}\NormalTok{(x, y, ...) \{}
    \FunctionTok{panel.xyplot}\NormalTok{(x, y, ...)}
    \FunctionTok{panel.ellipse}\NormalTok{(x, y, ...)}
\NormalTok{  \},}
  \AttributeTok{auto.key =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .}\DecValTok{1}\NormalTok{, }\AttributeTok{y =}\NormalTok{ .}\DecValTok{8}\NormalTok{, }\AttributeTok{corner =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-86-1} \end{center}

\hypertarget{graphics-sessioninfo}{%
\section{运行环境}\label{graphics-sessioninfo}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   askpass_1.1         base64enc_0.1.3     bookdown_0.24      
##   codetools_0.2-18    compiler_4.1.1      curl_4.3.2         
##   digest_0.6.28       evaluate_0.14       fastmap_1.1.0      
##   filehash_2.4-2      glue_1.4.2          graphics_4.1.1     
##   grDevices_4.1.1     grid_4.1.1          highr_0.9          
##   htmltools_0.5.2     jpeg_0.1-9          jquerylib_0.1.4    
##   jsonlite_1.7.2      KernSmooth_2.23-20  knitr_1.36         
##   lattice_0.20-45     latticeExtra_0.6-29 magick_2.7.3       
##   magrittr_2.0.1      mapproj_1.2.7       maps_3.4.0         
##   MASS_7.3-54         Matrix_1.3-4        methods_4.1.1      
##   mgcv_1.8-37         nlme_3.1-153        pdftools_3.0.1     
##   png_0.1-7           qpdf_1.1            RColorBrewer_1.1-2 
##   Rcpp_1.0.7          rlang_0.4.11        rmarkdown_2.11     
##   shape_1.4.6         splines_4.1.1       stats_4.1.1        
##   stringi_1.7.4       stringr_1.4.0       survival_3.2-13    
##   sys_3.4             tikzDevice_0.12.3.1 tinytex_0.34       
##   tools_4.1.1         utils_4.1.1         xfun_0.26          
##   yaml_2.2.1
\end{verbatim}

\hypertarget{chap-data-visualization}{%
\chapter{数据可视化}\label{chap-data-visualization}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)           }\CommentTok{\# ggplot2 图形}
\FunctionTok{library}\NormalTok{(patchwork)         }\CommentTok{\# 图形布局}
\FunctionTok{library}\NormalTok{(magrittr)          }\CommentTok{\# 管道操作}
\FunctionTok{library}\NormalTok{(ggrepel)           }\CommentTok{\# 文本注释}
\FunctionTok{library}\NormalTok{(extrafont)         }\CommentTok{\# 加载外部字体 TTF}
\FunctionTok{library}\NormalTok{(hrbrthemes)        }\CommentTok{\# 主题}
\FunctionTok{library}\NormalTok{(maps)              }\CommentTok{\# 地图数据}
\FunctionTok{library}\NormalTok{(mapdata)           }\CommentTok{\# 地图数据}
\FunctionTok{library}\NormalTok{(xkcd)              }\CommentTok{\# 漫画字体}
\FunctionTok{library}\NormalTok{(RgoogleMaps)       }\CommentTok{\# 静态地图}
\FunctionTok{library}\NormalTok{(data.table)        }\CommentTok{\# 数据操作}
\FunctionTok{library}\NormalTok{(KernSmooth)        }\CommentTok{\# 核平滑}
\FunctionTok{library}\NormalTok{(ggnormalviolin)    }\CommentTok{\# 提琴图}
\FunctionTok{library}\NormalTok{(ggbeeswarm)        }\CommentTok{\# 蜂群图}
\FunctionTok{library}\NormalTok{(gert)              }\CommentTok{\# Git 数据操作}
\FunctionTok{library}\NormalTok{(ggridges)          }\CommentTok{\# 岭线图}
\FunctionTok{library}\NormalTok{(ggpubr)            }\CommentTok{\# 组合图}
\FunctionTok{library}\NormalTok{(treemap)           }\CommentTok{\# 树状图}
\FunctionTok{library}\NormalTok{(treemapify)        }\CommentTok{\# 树状图}
\FunctionTok{library}\NormalTok{(ggalluvial)        }\CommentTok{\# 桑基图}
\FunctionTok{library}\NormalTok{(ggmosaic)          }\CommentTok{\# 马赛克图}
\FunctionTok{library}\NormalTok{(ggbump)            }\CommentTok{\# 凹凸图}
\FunctionTok{library}\NormalTok{(ggstream)          }\CommentTok{\# 水流图}
\FunctionTok{library}\NormalTok{(timelineS)         }\CommentTok{\# 时间线}
\FunctionTok{library}\NormalTok{(ggdendro)          }\CommentTok{\# 聚类图}
\FunctionTok{library}\NormalTok{(ggfortify)         }\CommentTok{\# 统计分析结果可视化：主成分图}
\FunctionTok{library}\NormalTok{(gganimate)         }\CommentTok{\# 动态图}
\end{Highlighting}
\end{Shaded}

David Robinson 给出为何使用 ggplot2 \footnote{\url{http://varianceexplained.org/r/why-I-use-ggplot2/}} 当然也有 Jeff Leek 指出在某些重要场合不适合 ggplot2 \footnote{\url{https://simplystatistics.org/2016/02/11/why-i-dont-use-ggplot2/}} 并且给出强有力的 \href{http://motioninsocial.com/tufte/}{证据}，其实不管怎么样，适合自己的才是好的。也不枉费 Garrick Aden-Buie 花费 160 页幻灯片逐步分解介绍 \href{https://pkg.garrickadenbuie.com/gentle-ggplot2}{优雅的ggplot2}，\href{https://malco.io/}{Malcolm Barrett} 也介绍了 \href{https://malco.io/slides/hs_ggplot2}{ggplot2 基础用法}，还有 Selva Prabhakaran 精心总结给出了 50 个 ggplot2 数据可视化的 \href{https://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html}{例子} 以及 Victor Perrier 为小白用 ggplot2 操碎了心地开发 RStudio 插件 \href{https://github.com/dreamRs/esquisse}{esquisse} 包，Claus O. Wilke 教你一步步创建出版级的图形 \url{https://github.com/clauswilke/practical_ggplot2}。

ggplot2 是十分方便的统计作图工具，相比 Base R，为了一张出版级的图形，不需要去调整每个参数，实现快速出图。集成了很多其它统计计算的 R 包，支持丰富的统计分析和计算功能，如回归、平滑等，实现了作图和模型的无缝连接。比如图\ref{fig:awesome-ggplot2}，使用 loess 局部多项式平滑得到数据的趋势，不仅仅是散点图，代码量也非常少。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(displ, hwy)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ class)) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{se =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{method =} \StringTok{"loess"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Fuel efficiency generally decreases with engine size"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"Two seaters (sports cars) are an exception because of their light weight"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"Data from fueleconomy.gov"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/awesome-ggplot2-1} 

}

\caption{简洁美观}\label{fig:awesome-ggplot2}
\end{figure}

故事源于一幅图片，我不记得第一次见到这幅图是什么时候了，只因多次在多个场合中见过，所以留下了深刻的印象，后来才知道它出自于一篇博文 --- \href{https://medium.com/airbnb-engineering/using-r-packages-and-education-to-scale-data-science-at-airbnb}{Using R packages and education to scale Data Science at Airbnb}，作者 Ricardo Bion 还在其 Github 上传了相关代码\footnote{\url{https://github.com/ricardo-bion/medium_visualization}}。除此之外还有几篇重要的参考资料：

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Pablo Barberá 的 \href{https://github.com/pablobarbera/Rdataviz}{Data Visualization with R and ggplot2}
\item
  Matt Leonawicz 的新作 \href{https://github.com/leonawicz/mapmate}{mapmate}, 可以去其主页欣赏系列作品\footnote{\url{https://leonawicz.github.io/}}
\item
  \href{https://github.com/rfordatascience/tidytuesday}{tidytuesday 可视化挑战官方项目} 还有 \href{https://github.com/abichat/tidytuesday}{tidytuesday}
\item
  \href{https://github.com/IndrajeetPatil/ggstatsplot}{ggstatsplot} 可视化统计检验、模型的结果
\item
  \href{https://github.com/kassambara/ggpubr}{ggpubr} 制作出版级统计图形
\item
  Thomas Lin Pedersen \href{https://github.com/thomasp85/ggplot2_workshop}{Drawing Anything with ggplot2}
\item
  \href{https://designing-ggplots.netlify.app/}{Designing ggplots: making clear figures that communicate}
\item
  \href{https://github.com/teunbrand/ggh4x}{ggh4x} 提供 ggplot2 的额外定制功能
\item
  \href{https://github.com/mjskay/ggdist}{ggdist} Visualizations of distributions and uncertainty
\item
  \href{https://github.com/yutannihilation/gghighlight}{gghighlight}
\item
  \href{https://github.com/briatte/ggnetwork}{ggnetwork}
\item
  \href{https://github.com/ggPMXdevelopment/ggPMX}{ggPMX} `ggplot2' Based Tool to Facilitate Diagnostic Plots for NLME Models
\item
  \href{https://github.com/aphalo/ggpp}{ggpp} ggpp: Grammar Extensions to `ggplot2'
\end{enumerate}

如 Berton Gunter 所说，数据可视化只是一种手段，根据数据实际情况作展示才是重要的，并不是要追求酷炫。

\begin{quote}
3-D bar plots are an abomination. Just because Excel can do them doesn't mean you should. (Dismount pulpit).

\hspace*{\fill} --- Berton Gunter \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2007-October/142420.html}}
\end{quote}

\textbf{grid} 是 \textbf{lattice} 和 \textbf{ggplot2} 的基础，\textbf{gganimate} 是 ggplot2 一个扩展，它将静态图形视为帧，调用第三方工具合成 GIF 动图或 MP4 视频等，要想深入了解 ggplot2，可以去看 \href{http://hadley.nz}{Hadley Wickham}, \href{https://djnavarro.net}{Danielle Navarro}, and \href{https://www.data-imaginist.com}{Thomas Lin Pedersen} 合著的《ggplot2: elegant graphics for data analysis》第三版 \url{https://ggplot2-book.org/}。

\hypertarget{sec-elements}{%
\section{元素}\label{sec-elements}}

以数据集 airquality 为例介绍 GGplot2 图层、主题、配色、坐标、尺度、注释和组合等

\hypertarget{ggplot2-layer}{%
\subsection{图层}\label{ggplot2-layer}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}geom\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "geom_abline"            "geom_area"              "geom_bar"              
##  [4] "geom_bin_2d"            "geom_bin2d"             "geom_blank"            
##  [7] "geom_boxplot"           "geom_col"               "geom_contour"          
## [10] "geom_contour_filled"    "geom_count"             "geom_crossbar"         
## [13] "geom_curve"             "geom_density"           "geom_density_2d"       
## [16] "geom_density_2d_filled" "geom_density2d"         "geom_density2d_filled" 
## [19] "geom_dotplot"           "geom_errorbar"          "geom_errorbarh"        
## [22] "geom_freqpoly"          "geom_function"          "geom_hex"              
## [25] "geom_histogram"         "geom_hline"             "geom_jitter"           
## [28] "geom_label"             "geom_line"              "geom_linerange"        
## [31] "geom_map"               "geom_path"              "geom_point"            
## [34] "geom_pointrange"        "geom_polygon"           "geom_qq"               
## [37] "geom_qq_line"           "geom_quantile"          "geom_raster"           
## [40] "geom_rect"              "geom_ribbon"            "geom_rug"              
## [43] "geom_segment"           "geom_sf"                "geom_sf_label"         
## [46] "geom_sf_text"           "geom_smooth"            "geom_spoke"            
## [49] "geom_step"              "geom_text"              "geom_tile"             
## [52] "geom_violin"            "geom_vline"
\end{verbatim}

生成一个散点图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-3-1} \end{center}

\hypertarget{subsec-axis-label}{%
\subsection{标签}\label{subsec-axis-label}}

图形的标签分为横纵轴标签、刻度标签、主标题、副标题等

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{dates =} \FunctionTok{seq.Date}\NormalTok{(}
    \AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"1945{-}01{-}01"}\NormalTok{),}
    \AttributeTok{to =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"1974{-}12{-}31"}\NormalTok{), }
    \AttributeTok{by =} \StringTok{"quarter"}
\NormalTok{  ),}
  \AttributeTok{presidents =} \FunctionTok{as.vector}\NormalTok{(presidents)}
\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dates, }\AttributeTok{y =}\NormalTok{ presidents)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"slategray"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{color =} \StringTok{"darkslategray"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_date}\NormalTok{(}\AttributeTok{date\_breaks =} \StringTok{"4 year"}\NormalTok{, }\AttributeTok{date\_labels =} \StringTok{"\%Y"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"1945年至1974年美国总统每季度支持率"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"年份"}\NormalTok{, }\AttributeTok{y =} \StringTok{"支持率 (\%)"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"数据源: R 包 datasets"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \FloatTok{10.54}\NormalTok{, }\AttributeTok{base\_family =} \StringTok{"source{-}han{-}sans{-}cn"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/approval-ratings-1} 

}

\caption{自1945年第一季度至1974年第四季度美国总统的支持率}\label{fig:approval-ratings}
\end{figure}

\hypertarget{subsec-annotation}{%
\subsection{注释}\label{subsec-annotation}}

图中注释的作用在于高亮指出关键点，提请读者注意。文本注释可由 \href{https://github.com/slowkow/ggrepel}{\textbf{ggrepel}} 包提供的标签图层 \texttt{geom\_label\_repel()} 添加，标签数据可独立于之前的数据层，标签所在的位置可以通过参数 \texttt{direction} 和 \texttt{nudge\_y} 精调，图 \ref{fig:text-annotation} 模拟了一组数据。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\FunctionTok{library}\NormalTok{(ggrepel)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{cumsum}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{))}
\NormalTok{)}
\NormalTok{anno\_data }\OtherTok{\textless{}{-}}\NormalTok{ dat }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{subset}\NormalTok{(x }\SpecialCharTok{\%\%} \DecValTok{25} \SpecialCharTok{==} \DecValTok{10}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{text =} \StringTok{"text"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(x, y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_label\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ text),}
    \AttributeTok{data =}\NormalTok{ anno\_data,}
    \AttributeTok{direction =} \StringTok{"y"}\NormalTok{,}
    \AttributeTok{nudge\_y =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/text-annotation-1} 

}

\caption{文本注释}\label{fig:text-annotation}
\end{figure}

\textbf{ggrepel} 包的图层 \texttt{geom\_text\_repel()} 支持所有数据点的注释，并且自动调整文本的位置，防止重叠，增加辨识度，如图 \ref{fig:mtcars-annotation}。当然，数据点如果过于密集也不适合全部注释，高亮其中的关键点即可。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{cyl =} \FunctionTok{as.factor}\NormalTok{(cyl)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(wt, mpg, }\AttributeTok{label =} \FunctionTok{rownames}\NormalTok{(mtcars), }\AttributeTok{color =}\NormalTok{ cyl)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_text\_repel}\NormalTok{(}\AttributeTok{max.overlaps =} \DecValTok{12}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/mtcars-annotation-1} 

}

\caption{少量点的情况下可以全部注释，且可以解决注释重叠的问题}\label{fig:mtcars-annotation}
\end{figure}

Claus Wilke 开发的 \href{https://github.com/wilkelab/ggtext}{ggtext} 包支持更加丰富的注释样式，详见网站 \url{https://wilkelab.org/ggtext/}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}annotation\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "annotation_custom"   "annotation_logticks" "annotation_map"     
## [4] "annotation_raster"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-5-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \FunctionTok{substitute}\NormalTok{(}\FunctionTok{paste}\NormalTok{(d }\SpecialCharTok{*}
    \FunctionTok{bolditalic}\NormalTok{(x)[}\FunctionTok{italic}\NormalTok{(t)] }\SpecialCharTok{==}\NormalTok{ alpha }\SpecialCharTok{*}\NormalTok{ (theta }\SpecialCharTok{{-}} \FunctionTok{bolditalic}\NormalTok{(x)[}\FunctionTok{italic}\NormalTok{(t)]) }\SpecialCharTok{*}
\NormalTok{    d }\SpecialCharTok{*} \FunctionTok{italic}\NormalTok{(t) }\SpecialCharTok{+}\NormalTok{ lambda }\SpecialCharTok{*}\NormalTok{ d }\SpecialCharTok{*} \FunctionTok{italic}\NormalTok{(B)[}\FunctionTok{italic}\NormalTok{(t)]), }\FunctionTok{list}\NormalTok{(}\AttributeTok{lambda =} \DecValTok{4}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/math-expr-r-1} \end{center}

\hypertarget{ggplot2-scale}{%
\subsection{刻度}\label{ggplot2-scale}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}scale\_(x|y)\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "scale_x_binned"     "scale_x_continuous" "scale_x_date"      
##  [4] "scale_x_datetime"   "scale_x_discrete"   "scale_x_log10"     
##  [7] "scale_x_reverse"    "scale_x_sqrt"       "scale_x_time"      
## [10] "scale_y_binned"     "scale_y_continuous" "scale_y_date"      
## [13] "scale_y_datetime"   "scale_y_discrete"   "scale_y_log10"     
## [16] "scale_y_reverse"    "scale_y_sqrt"       "scale_y_time"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Temp, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 56 97
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Ozone, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]   1 168
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{5}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{20}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-7-1} \end{center}

\hypertarget{ggplot2-legend}{%
\subsection{图例}\label{ggplot2-legend}}

二维的图例 \href{https://github.com/slu-openGIS/biscale}{biscale} 和 \href{https://github.com/clauswilke/multiscales}{multiscales} 和 \href{https://github.com/eliocamp/ggnewscale}{ggnewscale}

\hypertarget{ggplot2-coord}{%
\subsection{坐标系}\label{ggplot2-coord}}

极坐标，直角坐标

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}coord\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "coord_cartesian" "coord_equal"     "coord_fixed"     "coord_flip"     
##  [5] "coord_map"       "coord_munch"     "coord_polar"     "coord_quickmap" 
##  [9] "coord_sf"        "coord_trans"
\end{verbatim}

\hypertarget{ggplot2-axes}{%
\subsection{坐标轴}\label{ggplot2-axes}}

坐标轴标签位置、大小、字体

\hypertarget{ggplot2-color}{%
\subsection{配色}\label{ggplot2-color}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}scale\_(color|fill)\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "scale_color_binned"     "scale_color_brewer"     "scale_color_continuous"
##  [4] "scale_color_date"       "scale_color_datetime"   "scale_color_discrete"  
##  [7] "scale_color_distiller"  "scale_color_fermenter"  "scale_color_gradient"  
## [10] "scale_color_gradient2"  "scale_color_gradientn"  "scale_color_grey"      
## [13] "scale_color_hue"        "scale_color_identity"   "scale_color_manual"    
## [16] "scale_color_ordinal"    "scale_color_steps"      "scale_color_steps2"    
## [19] "scale_color_stepsn"     "scale_color_viridis_b"  "scale_color_viridis_c" 
## [22] "scale_color_viridis_d"  "scale_fill_binned"      "scale_fill_brewer"     
## [25] "scale_fill_continuous"  "scale_fill_date"        "scale_fill_datetime"   
## [28] "scale_fill_discrete"    "scale_fill_distiller"   "scale_fill_fermenter"  
## [31] "scale_fill_gradient"    "scale_fill_gradient2"   "scale_fill_gradientn"  
## [34] "scale_fill_grey"        "scale_fill_hue"         "scale_fill_identity"   
## [37] "scale_fill_manual"      "scale_fill_ordinal"     "scale_fill_steps"      
## [40] "scale_fill_steps2"      "scale_fill_stepsn"      "scale_fill_viridis_b"  
## [43] "scale_fill_viridis_c"   "scale_fill_viridis_d"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone, }\AttributeTok{color =} \FunctionTok{as.factor}\NormalTok{(Month))) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-10-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone, }\AttributeTok{color =} \FunctionTok{as.ordered}\NormalTok{(Month))) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-10-2} \end{center}

\hypertarget{subsec-theme}{%
\subsection{主题}\label{subsec-theme}}

\href{https://github.com/thomas-neitmann/ggcharts}{ggcharts} 和 \href{https://github.com/bbc/bbplot}{bbplot} \href{https://github.com/jumpingrivers/prettyB}{prettyB} 美化 Base R 图形 \href{https://github.com/csdaw/ggprism}{ggprism}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}theme\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "theme_bw"       "theme_classic"  "theme_dark"     "theme_get"     
##  [5] "theme_gray"     "theme_grey"     "theme_light"    "theme_linedraw"
##  [9] "theme_minimal"  "theme_replace"  "theme_set"      "theme_test"    
## [13] "theme_update"   "theme_void"
\end{verbatim}

这里只展示 \texttt{theme\_bw()} \texttt{theme\_void()} \texttt{theme\_minimal()} 和 \texttt{theme\_void()} 等四个常见主题，更多主题参考 \href{https://github.com/nanxstats/ggsci}{ggsci}、\href{https://github.com/jrnold/ggthemes}{ggthemes} 、\href{https://github.com/ricardo-bion/ggtech}{ggtech}、\href{https://github.com/hrbrmstr/hrbrthemes}{hrbrthemes} 和 \href{https://github.com/cttobin/ggthemr}{ggthemr} 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{theme\_bw}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{theme\_void}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{theme\_classic}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{figure}

{\centering \subfloat[黑白主题\label{fig:builtin-themes-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/builtin-themes-1} }\subfloat[无主题\label{fig:builtin-themes-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/builtin-themes-2} }\newline\subfloat[极少配置的主题\label{fig:builtin-themes-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/builtin-themes-3} }\subfloat[经典主题\label{fig:builtin-themes-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/builtin-themes-4} }

}

\caption{ggplot2 内置的主题}\label{fig:builtin-themes}
\end{figure}

除主题之外，还有一类提供一整套统一的风格样式来绘制各种统计图形，如 \href{https://github.com/kassambara/ggpubr}{ggpubr} 和 \href{https://github.com/bbc/bbplot}{bbplot}

\hypertarget{ggplot2-grid}{%
\subsection{布局}\label{ggplot2-grid}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{as.ordered}\NormalTok{(Month))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.85\linewidth]{data-visualization_files/figure-latex/unnamed-chunk-12-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{as.ordered}\NormalTok{(Month), }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{data-visualization_files/figure-latex/unnamed-chunk-13-1} \end{center}

\href{https://github.com/wilkelab/cowplot}{cowplot} 是以作者 \href{https://wilkelab.org/}{Claus O. Wilke} 命名的，用来组合 ggplot 对象画图，类似的组合图形的功能包还有 \href{https://baptiste.github.io/}{baptiste auguié} 开发的 \href{https://CRAN.R-project.org/package=gridExtra}{gridExtra} 和 \href{https://github.com/baptiste/egg}{egg}， \href{https://www.data-imaginist.com/}{Thomas Lin Pedersen} 开发的 \href{https://github.com/thomasp85/patchwork}{patchwork}

\href{https://deanattali.com/}{Dean Attali} 开发的 \href{https://github.com/daattali/ggExtra}{ggExtra} 可以在图的边界添加密度估计曲线，直方图等

\hypertarget{sec-fonts}{%
\section{字体}\label{sec-fonts}}

\href{https://github.com/vankesteren/firatheme}{firatheme} 包提供基于 fira sans 字体的 ggplot2 主题，类似的字体主题包还有 \href{https://github.com/leonawicz/trekfont}{trekfont} 、 \href{https://github.com/bhaskarvk/fontHind}{fontHind}， \href{https://github.com/lionel-/fontquiver}{fontquiver} 包与 fontBitstreamVera（Bitstream Vera 字体）、 \href{https://cran.r-project.org/package=fontLiberation}{fontLiberation}（Liberation 字体）包和 \href{https://github.com/lionel-/fontDejaVu}{fontDejaVu} （DejaVu 字体）包一道提供了一些可允许使用的字体文件，这样，我们可以不依赖系统制作可重复的图形。Thomas Lin Pedersen 开发的 \href{https://github.com/r-lib/systemfonts}{systemfonts} 可直接使用系统自带的字体。

\hypertarget{subsec-system-fonts}{%
\subsection{系统字体}\label{subsec-system-fonts}}

以 CentOS 系统为例，软件仓库中包含 \href{https://github.com/googlefonts/noto-fonts}{Noto} ， \href{https://github.com/dejavu-fonts}{DejaVu} 、\href{https://github.com/liberationfonts/liberation-fonts}{liberation} 等字体。可以安装自己喜欢的字体类型，比如：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y} \DataTypeTok{\textbackslash{}}
\NormalTok{  google{-}noto{-}mono{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  google{-}noto{-}sans{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  google{-}noto{-}serif{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  dejavu{-}sans{-}mono{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  dejavu{-}sans{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  dejavu{-}serif{-}fonts}
\CommentTok{\# 或者}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ dejavu{-}fonts liberation{-}fonts}
\end{Highlighting}
\end{Shaded}

liberation 系列的四款字体可以用来替换 Windows 系统上对应的四款字体，对应关系见表 \ref{tab:fonts-centos-vs-win}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:fonts-centos-vs-win} Windows 系统上四款字体的替代品}\tabularnewline
\toprule
& CentOS 系统 & Windows 系统 \\
\midrule
\endfirsthead
\toprule
& CentOS 系统 & Windows 系统 \\
\midrule
\endhead
衬线体/宋体 & liberation-serif-fonts & Times New Roman \\
无衬线体/黑体 & liberation-sans-fonts & Arial \\
Arial 的细瘦版 & liberation-narrow-fonts & Arial Narrow \\
等宽体/微软雅黑 & liberation-mono-fonts & Courier New \\
\bottomrule
\end{longtable}

Lionel Henry 将 Liberation 系列字体打包到 R 包 \href{https://github.com/lionel-/fontLiberation}{fontLiberation}，非常便携，不需要操心跨平台的字体安装了。那如何使用呢？

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# install.packages("fontLiberation")}
\FunctionTok{system.file}\NormalTok{(}\AttributeTok{package =} \StringTok{"fontLiberation"}\NormalTok{, }\StringTok{"fonts"}\NormalTok{, }\StringTok{"liberation{-}fonts"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] ""
\end{verbatim}

此外，我们还可以从网上获取各种个样的字体，特别地，Boryslav Larin 收录的 \href{https://github.com/brabadu/awesome-fonts}{awesome-fonts} 列表是一个不错的开始，比如图标字体 \href{https://github.com/FortAwesome/Font-Awesome}{Font-Awesome}，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ fontawesome{-}fonts}
\end{Highlighting}
\end{Shaded}

再安装宏包 \href{https://ctan.org/pkg/fontawesome}{fontawesome} 后，即可在 LaTeX 文档中使用，下面这个示例推荐用 XeLaTeX 引擎编译。

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{\textbackslash{}documentclass}\NormalTok{[border=10pt]\{}\ExtensionTok{standalone}\NormalTok{\}}
\BuiltInTok{\textbackslash{}usepackage}\NormalTok{\{}\ExtensionTok{fontawesome}\NormalTok{\}}
\KeywordTok{\textbackslash{}begin}\NormalTok{\{}\ExtensionTok{document}\NormalTok{\}}
\NormalTok{Hello, }\FunctionTok{\textbackslash{}faGithub}
\KeywordTok{\textbackslash{}end}\NormalTok{\{}\ExtensionTok{document}\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

而在 R 绘制的图形中，通过指定 \texttt{par()}、 \texttt{plot()}、 \texttt{title()} 等函数的 \texttt{family} 参数值，比如 \texttt{family\ =\ "Liberation\ Sans"} 来调用系统无衬线 Liberation 字体，效果见图 \ref{fig:system-fonts-liberation}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(extrafont)}
\FunctionTok{plot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ pressure, pressure }\SpecialCharTok{\textasciitilde{}}\NormalTok{ temperature, }
     \AttributeTok{xlab =} \StringTok{"Temperature (deg C)"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Pressure (mm of Hg)"}\NormalTok{,}
     \AttributeTok{col.lab =} \StringTok{"red"}\NormalTok{, }\AttributeTok{col.axis =} \StringTok{"blue"}\NormalTok{,}
     \AttributeTok{font.lab =} \DecValTok{3}\NormalTok{, }\AttributeTok{font.axis =} \DecValTok{2}\NormalTok{, }\AttributeTok{family =} \StringTok{"Liberation Sans"}\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Vapor Pressure of Mercury as a Function of Temperature"}\NormalTok{, }
      \AttributeTok{family =} \StringTok{"Liberation Serif"}\NormalTok{, }\AttributeTok{font.main =} \DecValTok{3}\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{sub =} \StringTok{"Data Source: Weast, R. C"}\NormalTok{, }
      \AttributeTok{family =} \StringTok{"Liberation Mono"}\NormalTok{, }\AttributeTok{font.sub =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/system-fonts-liberation-1} 

}

\caption{调用系统字体绘图}\label{fig:system-fonts-liberation}
\end{figure}

为了符合出版的要求，需要在 \ref{fig:system-fonts-liberation} 中嵌入字体，

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# embed fonts to pdf}
\NormalTok{embed\_fonts }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(fig\_path) \{}
  \ControlFlowTok{if}\NormalTok{(knitr}\SpecialCharTok{::}\FunctionTok{is\_latex\_output}\NormalTok{())\{}
    \FunctionTok{embedFonts}\NormalTok{(}
      \AttributeTok{file =}\NormalTok{ fig\_path, }\AttributeTok{outfile =}\NormalTok{ fig\_path,}
      \AttributeTok{fontpaths =} \StringTok{"\textasciitilde{}/Library/Fonts"}
\NormalTok{    )}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(fig\_path)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

设置代码块选项 \texttt{fig.process=embed\_fonts}，这样生成 PDF 格式图形的时候，会调用此函数处理 PDF 图形。在 ggplot2 绘图中的调用方式是类似的，便不再赘述了。值得注意的是，extrafont 和 showtext 有些不一样，前者只能处理系统字体，后者还能获取网络字体和使用 OTF 字体，下面从 Google 开源的字体库获取 Noto 系列的四款字体，如图 \ref{fig:font-in-ggplot}。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Noto Sans"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{)}
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Noto Serif"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Noto Serif"}\NormalTok{)}
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Noto Serif SC"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{)}
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Noto Sans SC"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Noto Sans SC"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{rmdwarn}{警告}
在本书中，不要全局加载 showtext 包或调用 \texttt{showtext::showtext\_auto()}，会和 extrafont 冲突，使得绘图时默认就只能使用 showtext 提供的字体。extrafont 包提供的函数 \texttt{font\_import()} 仅支持系统安装的 TrueType/Type1 字体

\end{rmdwarn}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(pressure, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ temperature, }\AttributeTok{y =}\NormalTok{ pressure)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\AttributeTok{label =} \StringTok{"默认字体设置"}\NormalTok{)}

\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ p1 }\SpecialCharTok{+} \FunctionTok{theme}\NormalTok{(}
  \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{),}
  \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\AttributeTok{label =} \StringTok{"英文字体设置"}\NormalTok{)}

\NormalTok{p3 }\OtherTok{\textless{}{-}}\NormalTok{ p1 }\SpecialCharTok{+} \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"温度"}\NormalTok{, }\AttributeTok{y =} \StringTok{"压力"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\AttributeTok{label =} \StringTok{"中文字体设置"}\NormalTok{)}

\NormalTok{p4 }\OtherTok{\textless{}{-}}\NormalTok{ p1 }\SpecialCharTok{+} \FunctionTok{labs}\NormalTok{(}
  \AttributeTok{x =} \StringTok{"温度"}\NormalTok{, }\AttributeTok{y =} \StringTok{"压力"}\NormalTok{, }\AttributeTok{title =} \StringTok{"散点图"}\NormalTok{,}
  \AttributeTok{subtitle =} \StringTok{"Vapor Pressure of Mercury as a Function of Temperature"}\NormalTok{,}
  \AttributeTok{caption =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Data on the relation }
\StringTok{                  between temperature in degrees Celsius and"}\NormalTok{,}
    \StringTok{"vapor pressure of mercury in millimeters (of mercury)."}\NormalTok{,}
    \AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif"}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{),}
    \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{),}
    \AttributeTok{plot.subtitle =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{, }\AttributeTok{size =} \FunctionTok{rel}\NormalTok{(}\FloatTok{0.7}\NormalTok{)),}
    \AttributeTok{plot.caption =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{, }\AttributeTok{size =} \FunctionTok{rel}\NormalTok{(}\FloatTok{0.6}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\AttributeTok{label =} \StringTok{"任意字体设置"}\NormalTok{)}

\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2) }\SpecialCharTok{/}\NormalTok{ (p3 }\SpecialCharTok{+}\NormalTok{ p4)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=1\linewidth]{data-visualization_files/figure-latex/font-in-ggplot-1} 

}

\caption{在 ggplot2 绘图系统中设置中英文字体}\label{fig:font-in-ggplot}
\end{figure}

另外值得一提的是 \href{https://github.com/hrbrmstr/hrbrthemes}{hrbrthemes} 包，除了定制了很多 ggplot2 主题，它还打包了很多的字体主题。比如默认主题 \texttt{theme\_ipsum()} 使用 Arial Narrow 字体，如果没有该字体就自动寻找系统中的替代品，如图 \ref{fig:hrbrthemes} 实际使用的是 Nimbus Sans Narrow 字体，因为在 GitHub Action 中，我实际使用的测试环境是 Ubuntu 20.04，该系统自带 Nimbus Sans Narrow 字体，Arial Narrow 毕竟是 Windows 上的闭源字体。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# brew install font{-}roboto}
\CommentTok{\# 导入字体}
\CommentTok{\# hrbrthemes::import\_roboto\_condensed()}
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Roboto Condensed"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Roboto Condensed"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(hrbrthemes)}
\FunctionTok{ggplot}\NormalTok{(mtcars, }\FunctionTok{aes}\NormalTok{(mpg, wt)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Fuel efficiency (mpg)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Weight (tons)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Seminal ggplot2 scatterplot example"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"A plot that is only useful for demonstration purposes"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"Brought to you by the letter \textquotesingle{}g\textquotesingle{}"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_ipsum}\NormalTok{(}\AttributeTok{base\_family =} \StringTok{"Roboto Condensed"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/hrbrthemes-1} 

}

\caption{调用 hrbrthemes 包设置字体主题}\label{fig:hrbrthemes}
\end{figure}

如果系统没有安装 Arial Narrow 字体，可以导入 hrbrthemes 包自带的一些字体，比如 \texttt{hrbrthemes::import\_roboto\_condensed()}，然后调用字体主题 \texttt{theme\_ipsum\_rc()} 。如果不想使用这个包自带的字体，可以用系统中安装的字体去修改主题 \texttt{theme\_ipsum()} 和 \texttt{theme\_ipsum\_rc()} 中的字体设置。如图 \ref{fig:arial-narrow} 使用了 \texttt{theme\_ipsum()} 中的 Arial Narrow 字体。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mtcars, }\FunctionTok{aes}\NormalTok{(mpg, wt)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Fuel efficiency (mpg)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Weight (tons)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Seminal ggplot2 scatterplot example"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"A plot that is only useful for demonstration purposes"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"Brought to you by the letter \textquotesingle{}g\textquotesingle{}"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_ipsum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/arial-narrow-1} 

}

\caption{默认字体 Arial Narrow}\label{fig:arial-narrow}
\end{figure}

\begin{rmdtip}{提示}
\textbf{hrbrthemes} 包提供了一个全局字体加载选项 \texttt{hrbrthemes.loadfonts} ，如果设置为 TRUE，即 \texttt{options(hrbrthemes.loadfonts\ =\ TRUE)} 会先调用函数 \texttt{extrafont::loadfonts()} 预加载系统字体，就不用一次次手动加载字体了。后续在第 \ref{subsec-fontcm} 节还会提及 extrafont 包的其它功能。

\end{rmdtip}

\hypertarget{subsec-showtext}{%
\subsection{思源字体}\label{subsec-showtext}}

邱怡轩开发的 \href{https://github.com/yixuan/showtext}{showtext} 包支持丰富的外部字体，支持 Base R 和 ggplot2 图形，图 \ref{fig:showtext} 嵌入了 5 号思源宋体，图例和坐标轴文本使用 serif 字体，更多详细的使用文档见 \citep{Qiu2015}。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 安装 showtext 包}
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}showtext\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 思源宋体}
\NormalTok{showtextdb}\SpecialCharTok{::}\FunctionTok{font\_install}\NormalTok{(showtextdb}\SpecialCharTok{::}\FunctionTok{source\_han\_serif}\NormalTok{())}
\CommentTok{\# 思源黑体}
\NormalTok{showtextdb}\SpecialCharTok{::}\FunctionTok{font\_install}\NormalTok{(showtextdb}\SpecialCharTok{::}\FunctionTok{source\_han\_sans}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(Sepal.Length, Sepal.Width)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{colour =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{scale\_colour\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Set1"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"鸢尾花数据的散点图"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"萼片长度"}\NormalTok{, }\AttributeTok{y =} \StringTok{"萼片宽度"}\NormalTok{, }\AttributeTok{colour =} \StringTok{"鸢尾花类别"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"鸢尾花数据集最早见于 Edgar Anderson (1935) "}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"source{-}han{-}sans{-}cn"}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"source{-}han{-}serif{-}cn"}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"source{-}han{-}serif{-}cn"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/showtext-1} 

}

\caption{showtext 包处理图里的中文}\label{fig:showtext}
\end{figure}

斐济是太平洋上的一个岛国，受地壳板块运动的影响，地震活动频繁，图 \ref{fig:fiji-earthquake} 清晰展示了它的地震带。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(maps)}
\FunctionTok{library}\NormalTok{(mapdata)}
\NormalTok{FijiMap }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"worldHires"}\NormalTok{, }\AttributeTok{region =} \StringTok{"Fiji"}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(FijiMap, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ long, }\AttributeTok{y =}\NormalTok{ lat)) }\SpecialCharTok{+}
  \FunctionTok{geom\_map}\NormalTok{(}\AttributeTok{map =}\NormalTok{ FijiMap, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{map\_id =}\NormalTok{ region), }\AttributeTok{size =}\NormalTok{ .}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data =}\NormalTok{ quakes, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ long, }\AttributeTok{y =}\NormalTok{ lat, }\AttributeTok{colour =}\NormalTok{ mag)) }\SpecialCharTok{+}
  \FunctionTok{xlim}\NormalTok{(}\DecValTok{160}\NormalTok{, }\DecValTok{195}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_colour\_distiller}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =}\NormalTok{ (}\SpecialCharTok{{-}}\DecValTok{18}\SpecialCharTok{:}\DecValTok{18}\NormalTok{) }\SpecialCharTok{*} \DecValTok{5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}\StringTok{"ortho"}\NormalTok{, }\AttributeTok{orientation =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{180}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{colour =} \StringTok{"震级"}\NormalTok{, }\AttributeTok{x =} \StringTok{"经度"}\NormalTok{, }\AttributeTok{y =} \StringTok{"纬度"}\NormalTok{, }\AttributeTok{title =} \StringTok{"斐济地震带"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"source{-}han{-}sans{-}cn"}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"source{-}han{-}serif{-}cn"}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"source{-}han{-}sans{-}cn"}\NormalTok{),}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{legend.justification =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/fiji-earthquake-1} 

}

\caption{斐济地震带}\label{fig:fiji-earthquake}
\end{figure}

\hypertarget{subsec-fontcm}{%
\subsection{数学字体}\label{subsec-fontcm}}

Winston Chang 将 Paul Murrell 的 Computer Modern 字体文件打包成 \href{https://github.com/wch/fontcm}{fontcm} 包 \citep{fontcm}，\textbf{fontcm} 包可以在 Base R 图形中嵌入数学字体 \footnote{\url{https://www.stat.auckland.ac.nz/~paul/R/CM/CMR.html}}，图形中嵌入重音字符 \footnote{\url{https://www.stat.auckland.ac.nz/~paul/Reports/maori/maori.html}}。 下面先下载、安装、加载字体，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(extrafont)}
\FunctionTok{font\_addpackage}\NormalTok{(}\AttributeTok{pkg =} \StringTok{"fontcm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

查看可被 \texttt{pdf()} 图形设备使用的字体列表

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 可用的字体}
\FunctionTok{fonts}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "CM Roman"               "CM Roman Asian"         "CM Roman CE"           
##  [4] "CM Roman Cyrillic"      "CM Roman Greek"         "CM Sans"               
##  [7] "CM Sans Asian"          "CM Sans CE"             "CM Sans Cyrillic"      
## [10] "CM Sans Greek"          "CM Symbol"              "CM Typewriter"         
## [13] "CM Typewriter Asian"    "CM Typewriter CE"       "CM Typewriter Cyrillic"
## [16] "CM Typewriter Greek"
\end{verbatim}

fontcm 包提供数学字体，\texttt{grDevices::embedFonts()} 函数调用 Ghostscript 软件将数学字体嵌入 ggplot2 图形中，达到正确显示数学公式的目的，此方法适用于 pdf 设备保存的图形，对 \texttt{cairo\_pdf()} 保存的 PDF 格式图形无效。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(fontcm)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(extrafont)}
\FunctionTok{library}\NormalTok{(patchwork)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{)),}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Made with CM fonts"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Made with CM fonts"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Made with CM fonts"}
\NormalTok{  )}
\CommentTok{\# 公式}
\NormalTok{eq }\OtherTok{\textless{}{-}} \StringTok{"italic(sum(frac(1, n*\textquotesingle{}!\textquotesingle{}), n==0, infinity) ==}
\StringTok{       lim(bgroup(\textquotesingle{}(\textquotesingle{}, 1 + frac(1, n), \textquotesingle{})\textquotesingle{})\^{}n, n \%{-}\textgreater{}\% infinity))"}
\CommentTok{\# 默认字体}
\NormalTok{p1 }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{,}
  \AttributeTok{x =} \DecValTok{3}\NormalTok{, }\AttributeTok{y =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{parse =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{label =}\NormalTok{ eq }\CommentTok{\# , family = "CM Roman"}
\NormalTok{)}
\CommentTok{\# 使用 CM Roman 字体}
\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{,}
  \AttributeTok{x =} \DecValTok{3}\NormalTok{, }\AttributeTok{y =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{parse =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{label =}\NormalTok{ eq, }\AttributeTok{family =} \StringTok{"CM Roman"}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{family =} \StringTok{"CM Roman"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face =} \StringTok{"italic"}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face =} \StringTok{"bold"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/fontcm-1} 

}

\caption{fontcm 处理数学公式}\label{fig:fontcm}
\end{figure}

为实现图 \ref{fig:fontcm} 的最终效果，需要启用一个有超级牛力的 \href{https://yihui.org/knitr/options/\#plots}{fig.process} 选项，主要是传递一个函数给它，对用 R 语言生成的图形再操作。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# embed math fonts to pdf}
\NormalTok{embed\_math\_fonts }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(fig\_path) \{}
  \ControlFlowTok{if}\NormalTok{(knitr}\SpecialCharTok{::}\FunctionTok{is\_latex\_output}\NormalTok{())\{}
    \FunctionTok{embedFonts}\NormalTok{(}
      \AttributeTok{file =}\NormalTok{ fig\_path, }\AttributeTok{outfile =}\NormalTok{ fig\_path,}
      \AttributeTok{fontpaths =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"fonts"}\NormalTok{, }\AttributeTok{package =} \StringTok{"fontcm"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(fig\_path)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

代码块选项中设置 \texttt{fig.process=embed\_math\_fonts} 可在绘图后，立即插入字体，此操作仅限于以 pdf 格式保存的图形设备，也适用于 Base R 绘制的图形，见图 \ref{fig:embed-math-fonts}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.1}\NormalTok{, }\FloatTok{4.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\AttributeTok{family =} \StringTok{"CM Roman"}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{len =} \DecValTok{101}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{sin}\NormalTok{(x), }\FunctionTok{cos}\NormalTok{(x))}
\FunctionTok{matplot}\NormalTok{(x, y,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{main =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}
    \FunctionTok{plain}\NormalTok{(sin) }\SpecialCharTok{*}\NormalTok{ phi, }\StringTok{"  and  "}\NormalTok{,}
    \FunctionTok{plain}\NormalTok{(cos) }\SpecialCharTok{*}\NormalTok{ phi}
\NormalTok{  )),}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(}\StringTok{"sin"} \SpecialCharTok{*}\NormalTok{ phi, }\StringTok{"cos"} \SpecialCharTok{*}\NormalTok{ phi),}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Phase Angle "}\NormalTok{, phi)),}
  \AttributeTok{col.main =} \StringTok{"blue"}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, }\SpecialCharTok{{-}}\NormalTok{pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, pi),}
  \AttributeTok{labels =} \FunctionTok{expression}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, }\SpecialCharTok{{-}}\NormalTok{pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, pi)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/embed-math-fonts-1} 

}

\caption{嵌入数学字体}\label{fig:embed-math-fonts}
\end{figure}

\hypertarget{subsec-tikz-device}{%
\subsection{TikZ 设备}\label{subsec-tikz-device}}

与 \ref{subsec-fontcm} 小节不同，Ralf Stubner 维护的 \href{https://github.com/daqana/tikzDevice}{\textbf{tikzDevice}} 包提供了另一种嵌入数学字体的方式，其提供的 \texttt{tikzDevice::tikz()} 绘图设备将图形对象转化为 TikZ 代码，调用 LaTeX 引擎编译成 PDF 文档。安装后，先测试一下 LaTeX 编译环境是否正常。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tikzDevice}\SpecialCharTok{::}\FunctionTok{tikzTest}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Active compiler:
##  /home/runner/.TinyTeX/bin/x86_64-linux/xelatex
##  XeTeX 3.141592653-2.6-0.999993 (TeX Live 2021)
##  kpathsea version 6.3.3
\end{verbatim}

\begin{verbatim}
## [1] 7.90259
\end{verbatim}

确认没有问题后，下面图 \ref{fig:tikz-regression} 的坐标轴标签，标题，图例等位置都支持数学公式，使用 \textbf{tikzDevice} 打造出版级的效果图。更多功能的介绍见 \url{https://www.daqana.org/tikzDevice/}。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}}\NormalTok{ x }\SpecialCharTok{+} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{5}\NormalTok{, }\AttributeTok{sd =} \FloatTok{0.25}\NormalTok{)}
\NormalTok{model }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x)}
\NormalTok{rsq }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(model)}\SpecialCharTok{$}\NormalTok{r.squared}
\NormalTok{rsq }\OtherTok{\textless{}{-}} \FunctionTok{signif}\NormalTok{(rsq, }\DecValTok{4}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y,}
  \AttributeTok{main =} \StringTok{"Hello }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{LaTeX!"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"$x$"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"$y$"}\NormalTok{,}
  \AttributeTok{sub =} \StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathcal\{N\}(x;}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mu,}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{Sigma)$"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(model, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Linear model: $R\^{}\{2\}="}\NormalTok{, rsq, }\StringTok{"$"}\NormalTok{), }\AttributeTok{line =} \FloatTok{0.5}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomright"}\NormalTok{,}
  \AttributeTok{legend =} \FunctionTok{paste0}\NormalTok{(}
    \StringTok{"$y = "}\NormalTok{,}
    \FunctionTok{round}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model)[}\DecValTok{2}\NormalTok{], }\DecValTok{3}\NormalTok{),}
    \StringTok{"x +"}\NormalTok{,}
    \FunctionTok{round}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model)[}\DecValTok{1}\NormalTok{], }\DecValTok{3}\NormalTok{),}
    \StringTok{"$"}
\NormalTok{  ),}
  \AttributeTok{bty =} \StringTok{"n"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/tikz-regression-1} 

}

\caption{线性回归模型}\label{fig:tikz-regression}
\end{figure}

推荐的全局 LaTeX 环境配置如下：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{options}\NormalTok{(}
  \AttributeTok{tinytex.engine =} \StringTok{"xelatex"}\NormalTok{,}
  \AttributeTok{tikzDefaultEngine =} \StringTok{"xetex"}\NormalTok{,}
  \AttributeTok{tikzDocumentDeclaration =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{documentclass[tikz]\{standalone\}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
  \AttributeTok{tikzXelatexPackages =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{usepackage[fontset=adobe]\{ctex\}"}\NormalTok{,}
    \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{usepackage[default,semibold]\{sourcesanspro\}"}\NormalTok{,}
    \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{usepackage\{amsfonts,mathrsfs,amssymb\}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

设置默认的 LaTeX 编译引擎为 XeLaTeX，相比于 PDFLaTeX，它对中文的兼容性更好，支持多平台下的中文环境，中文字体这里采用了 Adobe 的字体，默认加载了 mathrsfs 宏包支持 \texttt{\textbackslash{}mathcal}、\texttt{\textbackslash{}mathscr} 等命令，此外， LaTeX 发行版采用谢益辉自定义的 \href{https://yihui.org/tinytex/}{TinyTeX}。绘制独立的 PDF 图形的过程如下：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tikzDevice)}
\NormalTok{tf }\OtherTok{\textless{}{-}} \FunctionTok{file.path}\NormalTok{(}\FunctionTok{getwd}\NormalTok{(), }\StringTok{"tikz{-}regression.tex"}\NormalTok{)}
\FunctionTok{tikz}\NormalTok{(tf, }\AttributeTok{width =} \DecValTok{6}\NormalTok{, }\AttributeTok{height =} \FloatTok{5.5}\NormalTok{, }\AttributeTok{pointsize =} \DecValTok{30}\NormalTok{, }\AttributeTok{standAlone =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 绘图代码}
\FunctionTok{dev.off}\NormalTok{()}
\CommentTok{\# 编译成 PDF 图形}
\NormalTok{tinytex}\SpecialCharTok{::}\FunctionTok{latexmk}\NormalTok{(}\AttributeTok{file =} \StringTok{"tikz{-}regression.tex"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-xkcd-comic}{%
\subsection{漫画字体}\label{subsec-xkcd-comic}}

下载 XKCD 字体，并刷新系统字体缓存

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mkdir} \AttributeTok{{-}p}\NormalTok{ \textasciitilde{}/.fonts}
\ExtensionTok{curl} \AttributeTok{{-}fLo}\NormalTok{ \textasciitilde{}/.fonts/xkcd.ttf http://simonsoftware.se/other/xkcd.ttf}
\ExtensionTok{fc{-}cache} \AttributeTok{{-}fsv}
\end{Highlighting}
\end{Shaded}

将 XKCD 字体导入到 R 环境，以便后续被 ggplot2 图形设备调用。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R }\SpecialCharTok{{-}}\NormalTok{e }\StringTok{\textquotesingle{}library(extrafont);font\_import(pattern="[X/x]kcd.ttf", prompt = FALSE)\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

图 \ref{fig:xkcd-graph} 是一个使用 xkcd 字体的简单例子，更多高级特性请看 \textbf{xkcd} 包文档 \citep{xkcd}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(extrafont)}
\FunctionTok{library}\NormalTok{(xkcd)}
\FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(mpg, wt), }\AttributeTok{data =}\NormalTok{ mtcars) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_xkcd}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in theme_xkcd(): Not xkcd fonts installed! See vignette("xkcd-intro")
\end{verbatim}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/xkcd-graph-1} 

}

\caption{漫画风格的字体方案}\label{fig:xkcd-graph}
\end{figure}

\hypertarget{subsec-emoji-fonts}{%
\subsection{表情字体}\label{subsec-emoji-fonts}}

余光创开发的 \href{https://github.com/GuangchuangYu/emojifont}{emojifont} 包和 Hadley 开发的 \href{https://github.com/hadley/emo}{emo} 包，下面使用 Noto Emoji 字体，支持的表情图见 \url{https://www.google.com/get/noto/help/emoji/food-drink/}，下面给出一个示例。先从 GitHub 安装 \textbf{emo} 包，目前它还未正式发布到 CRAN 上。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{remotes}\SpecialCharTok{::}\FunctionTok{install\_github}\NormalTok{(}\StringTok{"hadley/emo"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

除了安装 emo 包，系统需要先安装好 emoji 字体，图形才会正确地渲染出来，想调用更多 emoji 图标请参考 \href{https://github.com/ikatyang/emoji-cheat-sheet}{Emoji 速查手册}，给出 emoji 对应的名字。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# CentOS}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ google{-}noto{-}emoji{-}color{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  google{-}noto{-}emoji{-}fonts}
\CommentTok{\# MacOS}
\ExtensionTok{brew}\NormalTok{ cask install font{-}noto{-}color{-}emoji font{-}noto{-}emoji}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{category =} \FunctionTok{c}\NormalTok{(}\StringTok{"pineapple"}\NormalTok{, }\StringTok{"apple"}\NormalTok{, }\StringTok{"watermelon"}\NormalTok{, }\StringTok{"mango"}\NormalTok{, }\StringTok{"pear"}\NormalTok{),}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{category =} \FunctionTok{sapply}\NormalTok{(category, emo}\SpecialCharTok{::}\NormalTok{ji)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ category, }\AttributeTok{y =}\NormalTok{ value)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{7}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ category), }\AttributeTok{size =} \DecValTok{12}\NormalTok{, }\AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/emoji-fonts-online-1} 

}

\caption{表情字体}\label{fig:emoji-fonts-online}
\end{figure}

Noto Color Emoji 字体在 MacOS 上有问题，为了跨平台的便携性，提供 emojifont 包的例子，要引入更多的依赖。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(emojifont)}

\NormalTok{names }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"smile"}\NormalTok{, }\StringTok{"school"}\NormalTok{, }\StringTok{"office"}\NormalTok{, }\StringTok{"blush"}\NormalTok{, }\StringTok{"smirk"}\NormalTok{, }\StringTok{"heart\_eyes"}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(names)}\SpecialCharTok{:}\DecValTok{1}
\NormalTok{e }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(names, emojifont}\SpecialCharTok{::}\NormalTok{emoji)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{emoji\_name =}\NormalTok{ names, }\AttributeTok{n =}\NormalTok{ n, }\AttributeTok{emoji =}\NormalTok{ e, }\AttributeTok{stringsAsFactors =}\NormalTok{ F)}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(emoji\_name, n)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_discrete}\NormalTok{(}\AttributeTok{breaks =}\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{emoji\_name, }\AttributeTok{labels =}\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{emoji) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{family =} \StringTok{"EmojiOne"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-colors}{%
\section{配色}\label{sec-colors}}

配色真的是一门学问，有的人功力非常深厚，仅用黑白灰就可以创造出一个世界，如中国的水墨画，科波拉执导的《教父》，沃卓斯基姐妹执导的《黑客帝国》等。黑西装、白衬衫和黑领带是《黑客帝国》的经典元素，《教父》开场的黑西装、黑领结和白衬衫，尤其胸前的红玫瑰更是点睛之笔。导演将黑白灰和光影混合形成了层次丰富立体的画面，打造了一场视觉盛宴，无论是呈现在纸上还是银幕上都可以给人留下深刻的印象。正所谓食色性也，花花世界，岂能都是法印眼中的白骨！再说《红楼梦》里，芍药丛中，桃花树下，滴翠亭边，栊翠庵里，处处都是湘云、黛玉、宝钗、妙玉留下的四季诗歌。

为什么需要这么多颜色模式呢？主要取决于颜色输出的通道，比如印刷机，照相机，自然界，网页，人眼等，显示器因屏幕和分辨率的不同呈现的色彩数量是不一样的。读者大概都听说过 RGB、CMYK、AdobeRGB、sRGB、P3 广色域等名词，我想这主要归功于各大电子设备厂商的宣传。普清、高清、超高清、全高清、2K、4K、5K、视网膜屏，而 HSV、HCL 估计听说的人就少很多了。本节的目的是简单阐述背后的色彩原理，颜色模式及其之间的转化，在应对天花乱坠的销售时少交一些智商税，同时，告诉读者如何在 R 环境中使用色彩。早些时候我在统计之都论坛上发帖 -- R语言绘图用调色板大全 \url{https://d.cosx.org/d/419378}，如果读者希望拿来即用，不妨去看看。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{filled.contour}\NormalTok{(volcano, }\AttributeTok{nlevels =} \DecValTok{10}\NormalTok{, }\AttributeTok{color.palette =}\NormalTok{ terrain.colors)}
\FunctionTok{filled.contour}\NormalTok{(volcano, }\AttributeTok{nlevels =} \DecValTok{10}\NormalTok{, }\AttributeTok{color.palette =}\NormalTok{ heat.colors)}
\FunctionTok{filled.contour}\NormalTok{(volcano, }\AttributeTok{nlevels =} \DecValTok{10}\NormalTok{, }\AttributeTok{color.palette =}\NormalTok{ topo.colors)}
\FunctionTok{filled.contour}\NormalTok{(volcano, }\AttributeTok{nlevels =} \DecValTok{10}\NormalTok{, }\AttributeTok{color.palette =}\NormalTok{ cm.colors)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[terrain.colors 调色板\label{fig:old-color-palette-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/old-color-palette-1} }\subfloat[heat.colors 调色板\label{fig:old-color-palette-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/old-color-palette-2} }\newline\subfloat[topo.colors 调色板\label{fig:old-color-palette-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/old-color-palette-3} }\subfloat[cm.colors 调色板\label{fig:old-color-palette-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/old-color-palette-4} }

}

\caption{R 3.6.0 以前的调色板}\label{fig:old-color-palette}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{nlevels =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{color.palette =} \ControlFlowTok{function}\NormalTok{(n, ...) }\FunctionTok{hcl.colors}\NormalTok{(n, }\StringTok{"Grays"}\NormalTok{, }\AttributeTok{rev =} \ConstantTok{TRUE}\NormalTok{, ...)}
\NormalTok{)}
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{nlevels =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{color.palette =} \ControlFlowTok{function}\NormalTok{(n, ...) }\FunctionTok{hcl.colors}\NormalTok{(n, }\StringTok{"YlOrRd"}\NormalTok{, }\AttributeTok{rev =} \ConstantTok{TRUE}\NormalTok{, ...)}
\NormalTok{)}
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{nlevels =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{color.palette =} \ControlFlowTok{function}\NormalTok{(n, ...) }\FunctionTok{hcl.colors}\NormalTok{(n, }\StringTok{"purples"}\NormalTok{, }\AttributeTok{rev =} \ConstantTok{TRUE}\NormalTok{, ...)}
\NormalTok{)}
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{nlevels =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{color.palette =} \ControlFlowTok{function}\NormalTok{(n, ...) }\FunctionTok{hcl.colors}\NormalTok{(n, }\StringTok{"viridis"}\NormalTok{, }\AttributeTok{rev =} \ConstantTok{FALSE}\NormalTok{, ...)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[Grays 调色板\label{fig:new-color-palette-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/new-color-palette-1} }\subfloat[YlOrRd 调色板\label{fig:new-color-palette-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/new-color-palette-2} }\newline\subfloat[Purples 3 调色板\label{fig:new-color-palette-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/new-color-palette-3} }\subfloat[Viridis 调色板\label{fig:new-color-palette-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/new-color-palette-4} }

}

\caption{R 3.6.0 以后的调色板}\label{fig:new-color-palette}
\end{figure}

\begin{rmdnote}{注意}
\texttt{hcl.colors()} 函数是在 R 3.6.0 引入的，之前的 R 软件版本中没有，同时内置了 110 个调色板，详见 \texttt{hcl.pals()}。

\end{rmdnote}

\hypertarget{subsec-color-palettes}{%
\subsection{调色板}\label{subsec-color-palettes}}

R 预置的灰色有224种，挑出其中的调色板

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}gr(a|e)y"}\NormalTok{, }\FunctionTok{grep}\NormalTok{(}\StringTok{"gr(a|e)y"}\NormalTok{, }\FunctionTok{colors}\NormalTok{(), }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{), }
     \AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{invert =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "darkgray"       "darkgrey"       "darkslategray"  "darkslategray1"
##  [5] "darkslategray2" "darkslategray3" "darkslategray4" "darkslategrey" 
##  [9] "dimgray"        "dimgrey"        "lightgray"      "lightgrey"     
## [13] "lightslategray" "lightslategrey" "slategray"      "slategray1"    
## [17] "slategray2"     "slategray3"     "slategray4"     "slategrey"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gray\_colors }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"slategray"}\NormalTok{, }\StringTok{"darkslategray"}\NormalTok{), }\AttributeTok{each =} \DecValTok{4}\NormalTok{), }\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\FunctionTok{barplot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\AttributeTok{col =}\NormalTok{ gray\_colors, }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/gray-palettes-1} 

}

\caption{灰度调色板}\label{fig:gray-palettes}
\end{figure}

gray 与 grey 是一样的，类似 color 和 colour 的关系，可能是美式和英式英语的差别，且看

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{all.equal}\NormalTok{(}
  \FunctionTok{col2rgb}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"gray"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{))),}
  \FunctionTok{col2rgb}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grey"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{)))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\texttt{gray100} 代表白色，\texttt{gray0} 代表黑色，提取灰色调色板，去掉首尾部分是必要的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{8}\NormalTok{, }\AttributeTok{start =}\NormalTok{ .}\DecValTok{3}\NormalTok{, }\AttributeTok{end =}\NormalTok{ .}\DecValTok{9}\NormalTok{),}
  \AttributeTok{main =} \StringTok{"gray.colors function"}\NormalTok{, }\AttributeTok{border =} \ConstantTok{NA}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/gray-colors-1} 

}

\caption{提取 10 种灰色做调色板}\label{fig:gray-colors}
\end{figure}

首先选择一组合适的颜色，比如从桃色到梨色，选择6种颜色，以此为基础，可以借助 \texttt{grDevices::colorRampPalette()} 函数扩充至想要的数目，用 \texttt{graphics::rect()} 函数预览这组颜色配制的调色板

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Colors from https://github.com/johannesbjork/LaCroixColoR}
\NormalTok{colors\_vec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\#FF3200"}\NormalTok{, }\StringTok{"\#E9A17C"}\NormalTok{, }\StringTok{"\#E9E4A6"}\NormalTok{, }
                \StringTok{"\#1BB6AF"}\NormalTok{, }\StringTok{"\#0076BB"}\NormalTok{, }\StringTok{"\#172869"}\NormalTok{)}
\CommentTok{\# 代码来自 ?colorspace::rainbow\_hcl}
\NormalTok{pal }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \DecValTok{20}\NormalTok{, }\AttributeTok{colors =}\NormalTok{ colors, }\AttributeTok{border =} \StringTok{"light gray"}\NormalTok{, ...) \{}
\NormalTok{  colorname }\OtherTok{\textless{}{-}}\NormalTok{ (grDevices}\SpecialCharTok{::}\FunctionTok{colorRampPalette}\NormalTok{(colors))(n)}
  \FunctionTok{plot}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
    \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{),}
    \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, ...}
\NormalTok{  )}
  \FunctionTok{rect}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\NormalTok{(n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ n, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n }\SpecialCharTok{/}\NormalTok{ n, }\DecValTok{1}\NormalTok{, }\AttributeTok{col =}\NormalTok{ colorname, }\AttributeTok{border =}\NormalTok{ border)}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{20}\NormalTok{, }\AttributeTok{colors =}\NormalTok{ colors\_vec, }\AttributeTok{xlab =} \StringTok{"Colors from Peach to Pear"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/peach-pear-palette-1} 

}

\caption{桃色至梨色的渐变}\label{fig:peach-pear-palette}
\end{figure}

\texttt{colorRampPalette()} 自制调色板

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{create\_palette }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"orangeRed"}\NormalTok{)) \{}
\NormalTok{  color\_palette }\OtherTok{\textless{}{-}} \FunctionTok{colorRampPalette}\NormalTok{(colors)(n)}
  \FunctionTok{barplot}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{times =}\NormalTok{ n), }\AttributeTok{col =}\NormalTok{ color\_palette, }
          \AttributeTok{border =}\NormalTok{ color\_palette, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\AttributeTok{xaxs =} \StringTok{"i"}\NormalTok{, }\AttributeTok{yaxs =} \StringTok{"i"}\NormalTok{)}
\FunctionTok{create\_palette}\NormalTok{(}\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"orangeRed"}\NormalTok{))}
\FunctionTok{create\_palette}\NormalTok{(}\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"darkgreen"}\NormalTok{, }\StringTok{"yellow"}\NormalTok{, }\StringTok{"orangered"}\NormalTok{))}
\FunctionTok{create\_palette}\NormalTok{(}\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"white"}\NormalTok{, }\StringTok{"orangered"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/custom-palettes-1} 

}

\caption{colorRampPalette 自制调色板}\label{fig:custom-palettes}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{RColorBrewer}\SpecialCharTok{::}\FunctionTok{display.brewer.all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/rcolorbrewer-palette-1} 

}

\caption{RColorBrewer 调色板}\label{fig:rcolorbrewer-palette}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 代码来自 ?palettes}
\NormalTok{demo.pal }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, }\AttributeTok{border =} \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{\textless{}} \DecValTok{32}\NormalTok{) }\StringTok{"light gray"} \ControlFlowTok{else} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"color palettes: alpha = 1,  n="}\NormalTok{, n),}
           \AttributeTok{ch.col =} \FunctionTok{c}\NormalTok{(}
             \StringTok{"rainbow(n, start=.7, end=.1)"}\NormalTok{, }\StringTok{"heat.colors(n)"}\NormalTok{,}
             \StringTok{"terrain.colors(n)"}\NormalTok{, }\StringTok{"topo.colors(n)"}\NormalTok{,}
             \StringTok{"cm.colors(n)"}\NormalTok{, }\StringTok{"gray.colors(n, start = 0.3, end = 0.9)"}
\NormalTok{           )) \{}
\NormalTok{    nt }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(ch.col)}
\NormalTok{    i }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n}
\NormalTok{    j }\OtherTok{\textless{}{-}}\NormalTok{ n }\SpecialCharTok{/}\NormalTok{ nt}
\NormalTok{    d }\OtherTok{\textless{}{-}}\NormalTok{ j }\SpecialCharTok{/} \DecValTok{6}
\NormalTok{    dy }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ d}
    \FunctionTok{plot}\NormalTok{(i, i }\SpecialCharTok{+}\NormalTok{ d, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =}\NormalTok{ main)}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{nt) \{}
      \FunctionTok{rect}\NormalTok{(i }\SpecialCharTok{{-}}\NormalTok{ .}\DecValTok{5}\NormalTok{, (k }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ j }\SpecialCharTok{+}\NormalTok{ dy, i }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{4}\NormalTok{, k }\SpecialCharTok{*}\NormalTok{ j,}
        \AttributeTok{col =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ ch.col[k])), }\AttributeTok{border =}\NormalTok{ border}
\NormalTok{      )}
      \FunctionTok{text}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ j, k }\SpecialCharTok{*}\NormalTok{ j }\SpecialCharTok{+}\NormalTok{ dy }\SpecialCharTok{/} \DecValTok{4}\NormalTok{, ch.col[k])}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{n }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (.Device }\SpecialCharTok{==} \StringTok{"postscript"}\NormalTok{) }\DecValTok{64} \ControlFlowTok{else} \DecValTok{16}
\CommentTok{\# Since for screen, larger n may give color allocation problem}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{demo.pal}\NormalTok{(n)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/builtin-palettes-1} 

}

\caption{grDevices 调色板 }\label{fig:builtin-palettes}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{33}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, .}\DecValTok{8}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\DecValTok{32}\NormalTok{)) \{}
  \FunctionTok{pal}\NormalTok{(}
    \AttributeTok{n =} \FunctionTok{length}\NormalTok{((}\DecValTok{1} \SpecialCharTok{+} \DecValTok{20} \SpecialCharTok{*}\NormalTok{ (i }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{))}\SpecialCharTok{:}\NormalTok{(}\DecValTok{20} \SpecialCharTok{*}\NormalTok{ i)),}
    \FunctionTok{colors}\NormalTok{()[(}\DecValTok{1} \SpecialCharTok{+} \DecValTok{20} \SpecialCharTok{*}\NormalTok{ (i }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{))}\SpecialCharTok{:}\NormalTok{(}\DecValTok{20} \SpecialCharTok{*}\NormalTok{ i)],}
    \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+} \DecValTok{20} \SpecialCharTok{*}\NormalTok{ (i }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{), }\StringTok{"to"}\NormalTok{, }\DecValTok{20} \SpecialCharTok{*}\NormalTok{ i)}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{17}\NormalTok{, }\FunctionTok{colors}\NormalTok{()[}\DecValTok{641}\SpecialCharTok{:}\DecValTok{657}\NormalTok{], }\AttributeTok{main =} \StringTok{"641 to 657"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=1\linewidth]{data-visualization_files/figure-latex/demo-colors-1} 

}

\caption{grDevices 调色板}\label{fig:demo-colors}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(colorspace)}
\DocumentationTok{\#\# a few useful diverging HCL palettes}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{2}\NormalTok{))}

\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"diverging HCL palettes"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{246}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{c =} \DecValTok{96}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{65}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{130}\NormalTok{, }\DecValTok{43}\NormalTok{), }\AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{180}\NormalTok{, }\DecValTok{70}\NormalTok{), }\AttributeTok{c =} \DecValTok{70}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{95}\NormalTok{)))}

\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{180}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{c =} \DecValTok{59}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{95}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{128}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{c =} \DecValTok{98}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{65}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{255}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{90}\NormalTok{), }\AttributeTok{power =} \DecValTok{1}\NormalTok{))}

\DocumentationTok{\#\# sequential palettes}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{sequential\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main=} \StringTok{"sequential palettes"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{heat\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{), }
                     \AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{c =} \FunctionTok{c}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{80}\NormalTok{), }\AttributeTok{power =} \DecValTok{1}\NormalTok{))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{terrain\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \FunctionTok{c}\NormalTok{(}\DecValTok{65}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{45}\NormalTok{, }\DecValTok{95}\NormalTok{), }\AttributeTok{power =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{3}\NormalTok{, }\FloatTok{1.5}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{heat\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \FunctionTok{c}\NormalTok{(}\DecValTok{80}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{), }\AttributeTok{power =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, }\FloatTok{1.5}\NormalTok{)))}

\DocumentationTok{\#\# compare base and colorspace palettes}
\DocumentationTok{\#\# (in color and desaturated)}
\DocumentationTok{\#\# diverging red{-}blue colors}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hsv}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"diverging red{-}blue colors"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{diverge\_hsv}\NormalTok{(}\DecValTok{16}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{90}\NormalTok{))))}

\DocumentationTok{\#\# diverging cyan{-}magenta colors}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{cm.colors}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"diverging cyan{-}magenta colors"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{180}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{c =} \DecValTok{59}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{95}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{cm.colors}\NormalTok{(}\DecValTok{16}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{180}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{c =} \DecValTok{59}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{95}\NormalTok{))))}

\DocumentationTok{\#\# heat colors}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{heat.colors}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"heat colors"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{heat\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{heat.colors}\NormalTok{(}\DecValTok{16}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{heat\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{)))}

\DocumentationTok{\#\# terrain colors}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"terrain colors"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{terrain\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{16}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{terrain\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{)))}

\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{rainbow\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{start =} \DecValTok{30}\NormalTok{, }\AttributeTok{end =} \DecValTok{300}\NormalTok{), }\AttributeTok{main =} \StringTok{"dynamic"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{rainbow\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{start =} \DecValTok{60}\NormalTok{, }\AttributeTok{end =} \DecValTok{240}\NormalTok{), }\AttributeTok{main =} \StringTok{"harmonic"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{rainbow\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{start =} \DecValTok{270}\NormalTok{, }\AttributeTok{end =} \DecValTok{150}\NormalTok{), }\AttributeTok{main =} \StringTok{"cold"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{rainbow\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{start =} \DecValTok{90}\NormalTok{, }\AttributeTok{end =} \SpecialCharTok{{-}}\DecValTok{30}\NormalTok{), }\AttributeTok{main =} \StringTok{"warm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/colorspace-palette-1} 

}

\caption{colorspace 调色板}\label{fig:colorspace-palette}
\end{figure}

除之前提到的 \textbf{grDevices} 包， \href{https://colorspace.r-forge.r-project.org/}{\textbf{colorspace}} (\url{https://hclwizard.org/}) 包 \citep{colorspace_2009_rainbow, colorspace_2009_rgb, colorspace_2019}，\href{https://CRAN.R-project.org/package=RColorBrewer}{RColorBrewer} 包 \citep{RColorBrewer} \url{https://colorbrewer2.org/}，\href{https://github.com/sjmgarnier/viridis}{viridis} 包、\href{https://github.com/SymbolixAU/colourvalues}{colourvalues}、\href{https://github.com/karthik/wesanderson}{wesanderson}、\href{https://CRAN.R-project.org/package=dichromat}{dichromat} 包、\href{https://github.com/kwstat/pals}{pals} 包，\href{https://github.com/AustralianAntarcticDivision/palr}{palr} 包，\href{https://cran.r-project.org/package=colorRamps}{colorRamps} 包、\href{https://cran.r-project.org/package=ColorPalette}{ColorPalette} 包、\href{https://cran.r-project.org/package=colortools}{colortools} 包就不一一详细介绍了。

\href{https://github.com/bhaskarvk/colormap}{colormap} 包基于 node.js 的 colormap 模块提供 44 个预定义的调色板 \href{https://github.com/EmilHvitfeldt/paletteer}{paletteer} 包收集了很多 R 包提供的调色板，同时也引入了很多依赖。根据电影 Harry Potter 制作的调色板 \href{https://github.com/aljrico/harrypotter}{harrypotter}，根据网站 \href{https://carto.com/}{CARTO} 设计的 \href{https://github.com/Nowosad/rcartocolor}{rcartocolor} 包，\href{https://github.com/clauswilke/colorblindr}{colorblindr} 模拟色盲环境下的配色方案。

\href{https://github.com/ndphillips/yarrr}{yarrr} 包主要是为书籍 \href{https://bookdown.org/ndphillips/YaRrr/}{《YaRrr! The Pirate's Guide to R》} \url{https://github.com/ndphillips/ThePiratesGuideToR} 提供配套资源，兼顾收集了一组\href{https://bookdown.org/ndphillips/YaRrr/more-colors.html}{调色板}。

\begin{rmdnote}{注意}

RColorBrewer 调色板数量必须至少 3 个，这是上游 colorbrewer 的 \href{https://github.com/axismaps/colorbrewer/issues/23}{问题}，具体体现在调用 \texttt{RColorBrewer::brewer.pal(n\ =\ 2,\ name\ =\ "Set2")} 时会有警告。 plotly 调用

\begin{verbatim}
[1] "#66C2A5" "#FC8D62" "#8DA0CB"
Warning message:
In RColorBrewer::brewer.pal(n = 2, name = "Set2") :
  minimal value for n is 3, returning requested palette with 3 different levels
\end{verbatim}

\end{rmdnote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{8}\NormalTok{), }\DecValTok{8}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =} \FunctionTok{palette}\NormalTok{(), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =} \FunctionTok{heat.colors}\NormalTok{(}\DecValTok{8}\NormalTok{), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{8}\NormalTok{), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =}\NormalTok{ colorspace}\SpecialCharTok{::}\FunctionTok{sequential\_hcl}\NormalTok{(}\DecValTok{8}\NormalTok{), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =}\NormalTok{ colorspace}\SpecialCharTok{::}\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{8}\NormalTok{,}
  \AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{130}\NormalTok{, }\DecValTok{43}\NormalTok{),}
  \AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{90}\NormalTok{)}
\NormalTok{), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/select-color-1} 

}

\caption{源起}\label{fig:select-color}
\end{figure}

与图 \ref{fig:geom-tile} 对比，图\ref{fig:palette-spectral} 的层次更加丰富，识别性更高

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{months =}\NormalTok{ month.abb, }\AttributeTok{years =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{num =} \FunctionTok{as.vector}\NormalTok{(AirPassengers)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ years, }\AttributeTok{y =}\NormalTok{ months, }\AttributeTok{fill =}\NormalTok{ num)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_distiller}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1949}\NormalTok{, }\DecValTok{1960}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{),}
    \AttributeTok{labels =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}
    \AttributeTok{base\_size =} \FloatTok{10.54}\NormalTok{,}
    \AttributeTok{base\_family =} \StringTok{"source{-}han{-}serif{-}cn"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"年"}\NormalTok{, }\AttributeTok{y =} \StringTok{"月"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"人数"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/palette-spectral-1} 

}

\caption{Spectral 调色板}\label{fig:palette-spectral}
\end{figure}

再举例子，图 \ref{fig:faithfuld} 是正负例对比，其中好在哪里呢？这张图要表达美国黄石国家公园的老忠实泉间歇喷发的时间规律，那么好的标准就是层次分明，以突出不同颜色之间的时间差异。这个差异，还要看起来不那么费眼睛，一目了然最好。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{erupt }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(faithfuld, }\FunctionTok{aes}\NormalTok{(waiting, eruptions, }\AttributeTok{fill =}\NormalTok{ density)) }\SpecialCharTok{+}
  \FunctionTok{geom\_raster}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\ConstantTok{NULL}\NormalTok{, }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\ConstantTok{NULL}\NormalTok{, }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\NormalTok{p1 }\OtherTok{\textless{}{-}}\NormalTok{ erupt }\SpecialCharTok{+} \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{7}\NormalTok{))}
\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ erupt }\SpecialCharTok{+} \FunctionTok{scale\_fill\_distiller}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{)}
\NormalTok{p3 }\OtherTok{\textless{}{-}}\NormalTok{ erupt }\SpecialCharTok{+} \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{7}\NormalTok{))}
\NormalTok{p4 }\OtherTok{\textless{}{-}}\NormalTok{ erupt }\SpecialCharTok{+} \FunctionTok{scale\_fill\_continuous}\NormalTok{(}\AttributeTok{type =} \StringTok{\textquotesingle{}viridis\textquotesingle{}}\NormalTok{)}
\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2) }\SpecialCharTok{/}\NormalTok{ (p3 }\SpecialCharTok{+}\NormalTok{ p4)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/faithfuld-1} 

}

\caption{美国黄石国家公园的老忠实泉}\label{fig:faithfuld}
\end{figure}

RColorBrewer 包 提供了有序 (Sequential) 、定性 (Qualitative) 和发散 (Diverging) 三类调色板，一般来讲，分别适用于连续或有序分类变量、无序分类变量、两类分层对比变量的绘图。再加上强大的 ggplot2 包内置的对颜色处理的函数，如 \texttt{scale\_alpha\_*} 、 \texttt{scale\_colour\_*} 和 \texttt{scale\_fill\_*} 等，详见：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"scale\_col(ou|o)r\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "scale_color_binned"      "scale_color_brewer"     
##  [3] "scale_color_continuous"  "scale_color_date"       
##  [5] "scale_color_datetime"    "scale_color_discrete"   
##  [7] "scale_color_distiller"   "scale_color_fermenter"  
##  [9] "scale_color_gradient"    "scale_color_gradient2"  
## [11] "scale_color_gradientn"   "scale_color_grey"       
## [13] "scale_color_hue"         "scale_color_identity"   
## [15] "scale_color_manual"      "scale_color_ordinal"    
## [17] "scale_color_steps"       "scale_color_steps2"     
## [19] "scale_color_stepsn"      "scale_color_viridis_b"  
## [21] "scale_color_viridis_c"   "scale_color_viridis_d"  
## [23] "scale_colour_binned"     "scale_colour_brewer"    
## [25] "scale_colour_continuous" "scale_colour_date"      
## [27] "scale_colour_datetime"   "scale_colour_discrete"  
## [29] "scale_colour_distiller"  "scale_colour_fermenter" 
## [31] "scale_colour_gradient"   "scale_colour_gradient2" 
## [33] "scale_colour_gradientn"  "scale_colour_grey"      
## [35] "scale_colour_hue"        "scale_colour_identity"  
## [37] "scale_colour_manual"     "scale_colour_ordinal"   
## [39] "scale_colour_steps"      "scale_colour_steps2"    
## [41] "scale_colour_stepsn"     "scale_colour_viridis_b" 
## [43] "scale_colour_viridis_c"  "scale_colour_viridis_d"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"scale\_fill\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "scale_fill_binned"     "scale_fill_brewer"     "scale_fill_continuous"
##  [4] "scale_fill_date"       "scale_fill_datetime"   "scale_fill_discrete"  
##  [7] "scale_fill_distiller"  "scale_fill_fermenter"  "scale_fill_gradient"  
## [10] "scale_fill_gradient2"  "scale_fill_gradientn"  "scale_fill_grey"      
## [13] "scale_fill_hue"        "scale_fill_identity"   "scale_fill_manual"    
## [16] "scale_fill_ordinal"    "scale_fill_steps"      "scale_fill_steps2"    
## [19] "scale_fill_stepsn"     "scale_fill_viridis_b"  "scale_fill_viridis_c" 
## [22] "scale_fill_viridis_d"
\end{verbatim}

colourlovers 包借助 XML, jsonlite 和 httr 包可以在线获取网站 \href{https://www.colourlovers.com/}{COLOURlovers} 的调色板

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(colourlovers)}
\NormalTok{palette1 }\OtherTok{\textless{}{-}} \FunctionTok{clpalette}\NormalTok{(}\StringTok{\textquotesingle{}113451\textquotesingle{}}\NormalTok{)}
\NormalTok{palette2 }\OtherTok{\textless{}{-}} \FunctionTok{clpalette}\NormalTok{(}\StringTok{\textquotesingle{}92095\textquotesingle{}}\NormalTok{)}
\NormalTok{palette3 }\OtherTok{\textless{}{-}} \FunctionTok{clpalette}\NormalTok{(}\StringTok{\textquotesingle{}629637\textquotesingle{}}\NormalTok{)}
\NormalTok{palette4 }\OtherTok{\textless{}{-}} \FunctionTok{clpalette}\NormalTok{(}\StringTok{\textquotesingle{}694737\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

使用调色板

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{layout}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{))}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}

\FunctionTok{barplot}\NormalTok{(VADeaths, }\AttributeTok{col =} \FunctionTok{swatch}\NormalTok{(palette1)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(VADeaths, }\AttributeTok{col =} \FunctionTok{swatch}\NormalTok{(palette2)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(VADeaths, }\AttributeTok{col =} \FunctionTok{swatch}\NormalTok{(palette3)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(VADeaths, }\AttributeTok{col =} \FunctionTok{swatch}\NormalTok{(palette4)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调色板的描述信息

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{palette1}
\end{Highlighting}
\end{Shaded}

获取调色板中的颜色向量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{swatch}\NormalTok{(palette1)[[}\DecValTok{1}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-color-schames}{%
\subsection{颜色模式}\label{subsec-color-schames}}

不同的颜色模式，从 RGB 到 HCL 的基本操作 \url{https://stat545.com/block018_colors.html}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://github.com/hadley/ggplot2{-}book}
\NormalTok{hcl }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length =} \DecValTok{100}\NormalTok{), }\AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length =} \DecValTok{100}\NormalTok{)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{subset}\NormalTok{(}\AttributeTok{subset =}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{r =} \FunctionTok{sqrt}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{h =} \DecValTok{180} \SpecialCharTok{/}\NormalTok{ pi }\SpecialCharTok{*} \FunctionTok{atan2}\NormalTok{(y, x),}
    \AttributeTok{c =} \DecValTok{100} \SpecialCharTok{*}\NormalTok{ r,}
    \AttributeTok{l =} \DecValTok{65}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{colour =} \FunctionTok{hcl}\NormalTok{(h, c, l)}
\NormalTok{  )}

\CommentTok{\# sin(h) = y / (c / 100)}
\CommentTok{\# y = sin(h) * c / 100}

\NormalTok{cols }\OtherTok{\textless{}{-}}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{hue\_pal}\NormalTok{()(}\DecValTok{5}\NormalTok{)}
\NormalTok{selected }\OtherTok{\textless{}{-}}\NormalTok{ colorspace}\SpecialCharTok{::}\FunctionTok{RGB}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{col2rgb}\NormalTok{(cols)) }\SpecialCharTok{/} \DecValTok{255}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as}\NormalTok{(}\StringTok{"polarLUV"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  colorspace}\SpecialCharTok{::}\FunctionTok{coords}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as.data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{x =} \FunctionTok{cos}\NormalTok{(H }\SpecialCharTok{/} \DecValTok{180} \SpecialCharTok{*}\NormalTok{ pi) }\SpecialCharTok{*}\NormalTok{ C }\SpecialCharTok{/} \DecValTok{100}\NormalTok{,}
    \AttributeTok{y =} \FunctionTok{sin}\NormalTok{(H }\SpecialCharTok{/} \DecValTok{180} \SpecialCharTok{*}\NormalTok{ pi) }\SpecialCharTok{*}\NormalTok{ C }\SpecialCharTok{/} \DecValTok{100}\NormalTok{,}
    \AttributeTok{colour =}\NormalTok{ cols}
\NormalTok{  )}

\FunctionTok{ggplot}\NormalTok{(hcl, }\FunctionTok{aes}\NormalTok{(x, y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_raster}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ colour)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_identity}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_colour\_identity}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_equal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{breaks =} \ConstantTok{NULL}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{breaks =} \ConstantTok{NULL}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data =}\NormalTok{ selected, }\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data =}\NormalTok{ selected, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{colour =}\NormalTok{ colour))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-26-1} 

}

\caption{HCL调色}\label{fig:unnamed-chunk-26}
\end{figure}

R 内置了 502 种不同颜色的名称，下面随机地选取 20 种颜色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sample}\NormalTok{(}\FunctionTok{colors}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{), }\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "royalblue4"      "plum1"           "papayawhip"      "darkslategray"  
##  [5] "darkturquoise"   "gray79"          "darkred"         "maroon4"        
##  [9] "darkolivegreen4" "springgreen2"    "orchid4"         "lemonchiffon2"  
## [13] "paleturquoise4"  "gray49"          "cyan"            "antiquewhite1"  
## [17] "yellow2"         "gray13"          "cadetblue2"      "gray77"
\end{verbatim}

R 包 grDevices 提供 hcl 调色板\footnote{\url{https://developer.r-project.org/Blog/public/2019/04/01/hcl-based-color-palettes-in-grdevices/index.html}} 调制两个色板

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Colors from https://github.com/johannesbjork/LaCroixColoR}
\NormalTok{color\_pal }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\#FF3200"}\NormalTok{, }\StringTok{"\#E9A17C"}\NormalTok{, }\StringTok{"\#E9E4A6"}\NormalTok{, }\StringTok{"\#1BB6AF"}\NormalTok{, }\StringTok{"\#0076BB"}\NormalTok{, }\StringTok{"\#172869"}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{16}
\NormalTok{more\_colors }\OtherTok{\textless{}{-}}\NormalTok{ (grDevices}\SpecialCharTok{::}\FunctionTok{colorRampPalette}\NormalTok{(color\_pal))(n)}
\NormalTok{scales}\SpecialCharTok{::}\FunctionTok{show\_col}\NormalTok{(}\AttributeTok{colours =}\NormalTok{ more\_colors)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/color-pal-1} 

}

\caption{桃色至梨色的渐变}\label{fig:color-pal}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# colors in colortools from http://www.gastonsanchez.com/}
\NormalTok{fish\_pal }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"\#69D2E7"}\NormalTok{, }\StringTok{"\#6993E7"}\NormalTok{, }\StringTok{"\#7E69E7"}\NormalTok{, }\StringTok{"\#BD69E7"}\NormalTok{,}
  \StringTok{"\#E769D2"}\NormalTok{, }\StringTok{"\#E76993"}\NormalTok{, }\StringTok{"\#E77E69"}\NormalTok{, }\StringTok{"\#E7BD69"}\NormalTok{,}
  \StringTok{"\#D2E769"}\NormalTok{, }\StringTok{"\#93E769"}\NormalTok{, }\StringTok{"\#69E77E"}\NormalTok{, }\StringTok{"\#69E7BD"}
\NormalTok{)}
\NormalTok{more\_colors }\OtherTok{\textless{}{-}}\NormalTok{ (grDevices}\SpecialCharTok{::}\FunctionTok{colorRampPalette}\NormalTok{(fish\_pal))(n)}
\NormalTok{scales}\SpecialCharTok{::}\FunctionTok{show\_col}\NormalTok{(}\AttributeTok{colours =}\NormalTok{ more\_colors)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/fish-hsv-pal-1} 

}

\caption{Hue-Saturation-Value (HSV) 颜色模型}\label{fig:fish-hsv-pal}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\AttributeTok{red =} \DecValTok{86}\NormalTok{, }\AttributeTok{green =} \DecValTok{180}\NormalTok{, }\AttributeTok{blue =} \DecValTok{233}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# "\#56B4E9"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#56B4E9"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\AttributeTok{red =} \DecValTok{0}\NormalTok{, }\AttributeTok{green =} \DecValTok{158}\NormalTok{, }\AttributeTok{blue =} \DecValTok{115}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# "\#009E73"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#009E73"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\AttributeTok{red =} \DecValTok{240}\NormalTok{, }\AttributeTok{green =} \DecValTok{228}\NormalTok{, }\AttributeTok{blue =} \DecValTok{66}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# "\#F0E442"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#F0E442"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\AttributeTok{red =} \DecValTok{0}\NormalTok{, }\AttributeTok{green =} \DecValTok{114}\NormalTok{, }\AttributeTok{blue =} \DecValTok{178}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# "\#0072B2"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#0072B2"
\end{verbatim}

举例子，直方图配色与不配色

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# library(pander)}
\CommentTok{\# evalsOptions(\textquotesingle{}graph.unify\textquotesingle{}, TRUE)}
\CommentTok{\# panderOptions(\textquotesingle{}graph.colors\textquotesingle{}) 获取调色板}
\CommentTok{\# https://www.fontke.com/tool/rgbschemes/ 在线配色}
\NormalTok{cols }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"\#56B4E9"}\NormalTok{, }\StringTok{"\#009E73"}\NormalTok{, }\StringTok{"\#F0E442"}\NormalTok{, }\StringTok{"\#0072B2"}\NormalTok{,}
  \StringTok{"\#D55E00"}\NormalTok{, }\StringTok{"\#CC79A7"}\NormalTok{, }\StringTok{"\#999999"}\NormalTok{, }\StringTok{"\#E69F00"}
\NormalTok{)}
\FunctionTok{hist}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{hp, }\AttributeTok{col =} \StringTok{"\#56B4E9"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{grid =} \FunctionTok{grid}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-29-1} 

}

\caption{直方图}\label{fig:unnamed-chunk-29}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mtcars) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ hp, }\AttributeTok{fill =} \FunctionTok{as.factor}\NormalTok{(..count..)),}
    \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{bins =} \DecValTok{6}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{rep}\NormalTok{(}\StringTok{"\#56B4E9"}\NormalTok{, }\DecValTok{10}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Histogram with ggplot2"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-30-1} 

}

\caption{直方图}\label{fig:unnamed-chunk-30}
\end{figure}

\hypertarget{rgb}{%
\subsubsection{RGB}\label{rgb}}

红(red)、绿(green)、蓝(blue)是三原色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(red, green, blue, alpha, }\AttributeTok{names =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

函数参数说明：

\begin{itemize}
\tightlist
\item
  \texttt{red,\ blue,\ green,\ alpha} 取值范围\([0,M]\)，\(M\) 是 \emph{maxColorValue}
\item
  \texttt{names} 字符向量，给这组颜色值取名
\item
  \texttt{maxColorValue} 红，绿，蓝三色范围的最大值
\end{itemize}

The colour specification refers to the standard sRGB colorspace (IEC standard 61966).

rgb 产生一种颜色，如 \texttt{rgb(255,\ 0,\ 0,\ maxColorValue\ =\ 255)} 的颜色是 \texttt{"\#FF0000"} ，这是一串16进制数，每两个一组，那么一组有 \(16^2 = 256\) 种组合，整个一串有 \(256^3 = 16777216\) 种组合，这就是RGB表达的所有颜色。

\hypertarget{hsl}{%
\subsubsection{HSL}\label{hsl}}

色相饱和度亮度 hue--saturation--luminance (HSL)

\hypertarget{hsv}{%
\subsubsection{HSV}\label{hsv}}

Create a vector of colors from vectors specifying hue, saturation and value. 色相饱和度值

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hsv}\NormalTok{(}\AttributeTok{h =} \DecValTok{1}\NormalTok{, }\AttributeTok{s =} \DecValTok{1}\NormalTok{, }\AttributeTok{v =} \DecValTok{1}\NormalTok{, alpha)}
\end{Highlighting}
\end{Shaded}

This function creates a vector of colors corresponding to the given values in HSV space. rgb and rgb2hsv for RGB to HSV conversion;

hsv函数通过设置色调、饱和度和亮度获得颜色，三个值都是0-1的相对量

RGB HSV HSL 都是不连续的颜色空间，缺点

\hypertarget{hcl}{%
\subsubsection{HCL}\label{hcl}}

基于感知的颜色空间替代RGB颜色空间

通过指定色相(hue)，色度(chroma)和亮度(luminance/lightness)，创建一组（种）颜色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hcl}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{c =} \DecValTok{35}\NormalTok{, }\AttributeTok{l =} \DecValTok{85}\NormalTok{, alpha, }\AttributeTok{fixup =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

函数参数说明：

\begin{itemize}
\item
  \textbf{h} 颜色的色调，取值范围为{[}0,360{]}，0、120、240分别对应红色、绿色、蓝色
\item
  \textbf{c} 颜色的色度，其上界取决于色调和亮度
\item
  \textbf{l} 颜色的亮度，取值范围{[}0,100{]}，给定色调和色度，只有一部分子集可用
\item
  \textbf{alpha} 透明度，取值范围{[}0,1{]}，0 和1分别表示透明和不透明
\end{itemize}

This function corresponds to polar coordinates in the CIE-LUV color space

选色为什么这么难

色相与阴影相比是无关紧要的，色相对于标记和分类很有用，但表示（精细的）空间数据或形状的效果较差。颜色是改善图形的好工具，但糟糕的配色方案 (color schemes) 可能会导致比灰度调色板更差的效果。\citep{colorspace_2009_rainbow}

黑、白、灰，看似有三种颜色，其实只有一种颜色，黑和白只是灰色的两极，那么如何设置灰色梯度，使得人眼比较好区分它们呢？这样获得的调色板适用于什么样的绘图环境呢？

\hypertarget{cmyk}{%
\subsubsection{CMYK}\label{cmyk}}

印刷三原色：青 (cyan)、品红 (magenta)、黄 (yellow)

\begin{itemize}
\tightlist
\item
  颜色模式转化
\end{itemize}

\texttt{col2rgb()} 、\texttt{rgb2hsv()} 和 \texttt{rgb()} 函数 \texttt{hex2RGB()} 函数 colorspace \texttt{col2hcl()} 函数 scales \texttt{col2HSV()} colortools \texttt{col2hex()}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{col2rgb}\NormalTok{(}\StringTok{"lightblue"}\NormalTok{) }\CommentTok{\# color to  RGB}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       [,1]
## red    173
## green  216
## blue   230
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{scales}\SpecialCharTok{::}\FunctionTok{col2hcl}\NormalTok{(}\StringTok{"lightblue"}\NormalTok{) }\CommentTok{\# color to HCL}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#ADD8E6"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# palr::col2hex("lightblue") \# color to HEX}
\CommentTok{\# colortools::col2HSV("lightblue") \# color to HSV}

\FunctionTok{rgb}\NormalTok{(}\DecValTok{173}\NormalTok{, }\DecValTok{216}\NormalTok{, }\DecValTok{230}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# RGB to HEX}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#ADD8E6"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{colorspace}\SpecialCharTok{::}\FunctionTok{hex2RGB}\NormalTok{(}\StringTok{"\#ADD8E6"}\NormalTok{) }\CommentTok{\# HEX to RGB}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              R         G         B
## [1,] 0.6784314 0.8470588 0.9019608
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(.}\DecValTok{678}\NormalTok{, .}\DecValTok{847}\NormalTok{, .}\DecValTok{902}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{1}\NormalTok{) }\CommentTok{\# RGB to HEX}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#ADD8E6"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb2hsv}\NormalTok{(}\DecValTok{173}\NormalTok{, }\DecValTok{216}\NormalTok{, }\DecValTok{230}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# RGB to HSV}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        [,1]
## h 0.5409357
## s 0.2478261
## v 0.9019608
\end{verbatim}

\hypertarget{subsec-latex-colors}{%
\subsection{LaTeX 配色}\label{subsec-latex-colors}}

LaTeX 宏包 \href{https://www.ctan.org/pkg/xcolor}{xcolor} 中定义颜色的常用方式有两种，其一，\texttt{\textbackslash{}textcolor\{green!40!yellow\}} 表示 40\% 的绿色和 60\% 的黄色混合色彩，其二，\texttt{\textbackslash{}textcolor{[}HTML{]}\{34A853\}} HEX 表示的色彩直接在 LaTeX 文档中使用的方式，类似地 \texttt{\textbackslash{}textcolor{[}RGB{]}\{52,168,83\}} 也表示 Google 图标中的绿色。

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{\textbackslash{}documentclass}\NormalTok{[tikz,border=10pt]\{}\ExtensionTok{standalone}\NormalTok{\}}
\KeywordTok{\textbackslash{}begin}\NormalTok{\{}\ExtensionTok{document}\NormalTok{\}}
\KeywordTok{\textbackslash{}begin}\NormalTok{\{}\ExtensionTok{tikzpicture}\NormalTok{\}}
\FunctionTok{\textbackslash{}draw}\NormalTok{ (0,0) rectangle (2,1) node [midway] \{}\FunctionTok{\textbackslash{}textcolor}\NormalTok{[RGB]\{52,168,83\}\{Hello\} }\FunctionTok{\textbackslash{}textcolor}\NormalTok{[HTML]\{34A853\}\{}\FunctionTok{\textbackslash{}TeX}\NormalTok{\}\};}
\KeywordTok{\textbackslash{}end}\NormalTok{\{}\ExtensionTok{tikzpicture}\NormalTok{\}}
\KeywordTok{\textbackslash{}end}\NormalTok{\{}\ExtensionTok{document}\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

对应于 R 中的调用方式为：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\DecValTok{52}\NormalTok{, }\DecValTok{168}\NormalTok{, }\DecValTok{83}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#34A853"
\end{verbatim}

\hypertarget{subsec-ggplot2-colors}{%
\subsection{ggplot2 配色}\label{subsec-ggplot2-colors}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group,}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{,}
  \AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}
\NormalTok{)}
\CommentTok{\# 类似 boxplot}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fill =} \StringTok{"lightgray"}\NormalTok{)}

\CommentTok{\# 默认调色板}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}\NormalTok{)}

\CommentTok{\# Google 调色板}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4285f4"}\NormalTok{, }\StringTok{"\#34A853"}\NormalTok{, }\StringTok{"\#FBBC05"}\NormalTok{, }\StringTok{"\#EA4335"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[简单箱线图\label{fig:colorize-boxplot-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/colorize-boxplot-1} }\subfloat[ggplot2 绘制的箱线图\label{fig:colorize-boxplot-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/colorize-boxplot-2} }\newline\subfloat[ggplot2 调用默认调色板\label{fig:colorize-boxplot-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/colorize-boxplot-3} }\subfloat[ggplot2 调用 Google 调色板\label{fig:colorize-boxplot-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/colorize-boxplot-4} }

}

\caption{几种不同的箱线图}\label{fig:colorize-boxplot}
\end{figure}

\hypertarget{sec-gallery}{%
\section{图库}\label{sec-gallery}}

\hypertarget{sec-ggplot2-pie}{%
\subsection{饼图}\label{sec-ggplot2-pie}}

我对饼图是又爱又恨，爱的是它表示百分比的时候，往往让读者联想到蛋糕，份额这类根深蒂固的情景，从而让数字通俗易懂、深入人心，是一种很好的表达方式，恨的也是这一点，我用柱状图表达不香吗？人眼对角度的区分度远不如柱状图呢，特别是当两个类所占的份额比较接近的时候，所以很多时候，除了用饼图表达份额，还会在旁边标上百分比，从数据可视化的角度来说，如图 \ref{fig:bod-pie} 所示，这是信息冗余！

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{BOD }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{transform}\NormalTok{(., }\AttributeTok{ratio =}\NormalTok{ demand }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(demand)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(., }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =}\NormalTok{ demand, }\AttributeTok{fill =} \FunctionTok{reorder}\NormalTok{(Time, demand))) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{(}\AttributeTok{theta =} \StringTok{"y"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FloatTok{1.6}\NormalTok{, }\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(ratio, }\AttributeTok{digits =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%"}\NormalTok{)),}
    \AttributeTok{position =} \FunctionTok{position\_stack}\NormalTok{(}\AttributeTok{vjust =} \FloatTok{0.5}\NormalTok{), }\AttributeTok{color =} \StringTok{"black"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{label =}\NormalTok{ Time),}
    \AttributeTok{position =} \FunctionTok{position\_stack}\NormalTok{(}\AttributeTok{vjust =} \FloatTok{0.5}\NormalTok{), }\AttributeTok{color =} \StringTok{"black"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_void}\NormalTok{(}\AttributeTok{base\_size =} \DecValTok{14}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/bod-pie-1} 

}

\caption{饼图}\label{fig:bod-pie}
\end{figure}

\texttt{plot\_ly(type\ =\ "pie",\ ...\ )} 和添加图层 \texttt{add\_pie()} 的效果是一样的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{=} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ carat }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut, }\AttributeTok{data =}\NormalTok{ diamonds, }\AttributeTok{FUN =}\NormalTok{ length)}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_pie}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{labels =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{carat,}
    \AttributeTok{name =} \StringTok{"简单饼图1"}\NormalTok{, }\AttributeTok{domain =} \FunctionTok{list}\NormalTok{(}\AttributeTok{row =} \DecValTok{0}\NormalTok{, }\AttributeTok{column =} \DecValTok{0}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_pie}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{labels =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{carat, }\AttributeTok{hole =} \FloatTok{0.6}\NormalTok{,}
    \AttributeTok{textposition =} \StringTok{"inside"}\NormalTok{, }\AttributeTok{textinfo =} \StringTok{"label+percent"}\NormalTok{,}
    \AttributeTok{name =} \StringTok{"简单饼图2"}\NormalTok{, }\AttributeTok{domain =} \FunctionTok{list}\NormalTok{(}\AttributeTok{row =} \DecValTok{0}\NormalTok{, }\AttributeTok{column =} \DecValTok{1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"多图布局"}\NormalTok{, }\AttributeTok{showlegend =}\NormalTok{ F,}
    \AttributeTok{grid =} \FunctionTok{list}\NormalTok{(}\AttributeTok{rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{columns =} \DecValTok{2}\NormalTok{),}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{zeroline =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{showticklabels =} \ConstantTok{FALSE}\NormalTok{),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{zeroline =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{showticklabels =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

设置参数 hole 可以绘制环形饼图，比如 hole = 0.6

\hypertarget{sec-ggplot2-map}{%
\subsection{地图}\label{sec-ggplot2-map}}

USArrests 数据集描述了1973年美国50个州每10万居民中因袭击、抢劫和强奸而逮捕的人，以及城市人口占比。这里的地图是指按照行政区划为边界的示意图，比如图 \ref{fig:state-crimes}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(maps)}
\NormalTok{crimes }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{state =} \FunctionTok{tolower}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(USArrests)), USArrests)}
\CommentTok{\# 等价于 crimes \%\textgreater{}\% tidyr::pivot\_longer(Murder:Rape)}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(crimes)[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{], }\ControlFlowTok{function}\NormalTok{(j) \{}
  \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{state =}\NormalTok{ crimes}\SpecialCharTok{$}\NormalTok{state, }\AttributeTok{variable =}\NormalTok{ j, }\AttributeTok{value =}\NormalTok{ crimes[[j]])}
\NormalTok{\})}
\NormalTok{crimes\_long }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, vars)}
\NormalTok{states\_map }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"state"}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(crimes, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{map\_id =}\NormalTok{ state)) }\SpecialCharTok{+}
  \FunctionTok{geom\_map}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ Murder), }\AttributeTok{map =}\NormalTok{ states\_map) }\SpecialCharTok{+}
  \FunctionTok{expand\_limits}\NormalTok{(}\AttributeTok{x =}\NormalTok{ states\_map}\SpecialCharTok{$}\NormalTok{long, }\AttributeTok{y =}\NormalTok{ states\_map}\SpecialCharTok{$}\NormalTok{lat) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_binned}\NormalTok{(}\AttributeTok{type =} \StringTok{"viridis"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/state-crimes-1} 

}

\caption{1975年美国各州犯罪事件}\label{fig:state-crimes}
\end{figure}

先来看看中国及其周边，见图\ref{fig:incorrect-map}，这个地图的缺陷就是中国南海及九段线没有标记，台湾和中国大陆不是一种颜色标记，这里的地图数据来自 R 包 \textbf{maps} 和 \textbf{mapdata}，像这样的地图就不宜在国内正式刊物上出现。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(maps)}
\FunctionTok{library}\NormalTok{(mapdata)}
\NormalTok{east\_asia }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"worldHires"}\NormalTok{,}
  \AttributeTok{region =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Japan"}\NormalTok{, }\StringTok{"Taiwan"}\NormalTok{, }\StringTok{"China"}\NormalTok{,}
    \StringTok{"North Korea"}\NormalTok{, }\StringTok{"South Korea"}
\NormalTok{  )}
\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(east\_asia, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ long, }\AttributeTok{y =}\NormalTok{ lat, }\AttributeTok{group =}\NormalTok{ group, }\AttributeTok{fill =}\NormalTok{ region)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Set2"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/incorrect-map-1} 

}

\caption{中国及其周边}\label{fig:incorrect-map}
\end{figure}

绘制真正的地图需要考虑投影坐标系，观察角度、分辨率、政策法规等一系列因素，它是一种复杂的图形，如图 \ref{fig:draw-map} 所示。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{worldmap }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"world"}\NormalTok{)}

\CommentTok{\# 默认 mercator 投影下的默认视角 c(90, 0, mean(range(x)))}
\FunctionTok{ggplot}\NormalTok{(worldmap, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ region), }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{120}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{)}
\NormalTok{  )}

\CommentTok{\# 换观察角度}
\FunctionTok{ggplot}\NormalTok{(worldmap, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ region), }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{120}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{),}
    \AttributeTok{orientation =} \FunctionTok{c}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  )}

\CommentTok{\# 换投影坐标系}
\FunctionTok{ggplot}\NormalTok{(worldmap, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ region), }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}\StringTok{"ortho"}\NormalTok{,}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{120}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{)}
\NormalTok{  )}

\CommentTok{\# 二者皆换}
\FunctionTok{ggplot}\NormalTok{(worldmap, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ region), }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}\StringTok{"ortho"}\NormalTok{,}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{120}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{),}
    \AttributeTok{orientation =} \FunctionTok{c}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[墨卡托投影\label{fig:draw-map-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/draw-map-1} }\subfloat[北极观察\label{fig:draw-map-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/draw-map-2} }\newline\subfloat[正交投影\label{fig:draw-map-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/draw-map-3} }\subfloat[正交投影北极观察\label{fig:draw-map-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/draw-map-4} }

}

\caption{画地图的正确姿势}\label{fig:draw-map}
\end{figure}

Google 地图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(RgoogleMaps)}
\CommentTok{\# 一组坐标的中心位置}
\NormalTok{lat }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{40.702147}\NormalTok{, }\FloatTok{40.718217}\NormalTok{, }\FloatTok{40.711614}\NormalTok{)}
\NormalTok{lon }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{74.012318}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{74.015794}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{73.998284}\NormalTok{)}
\NormalTok{center }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{mean}\NormalTok{(lat), }\FunctionTok{mean}\NormalTok{(lon))}
\NormalTok{zoom }\OtherTok{\textless{}{-}} \FunctionTok{min}\NormalTok{(}\FunctionTok{MaxZoom}\NormalTok{(}\FunctionTok{range}\NormalTok{(lat), }\FunctionTok{range}\NormalTok{(lon)))}
\CommentTok{\# 矩形对角线的两个顶点}
\NormalTok{bb }\OtherTok{\textless{}{-}} \FunctionTok{qbbox}\NormalTok{(lat, lon)}
\CommentTok{\# 获取地图数据}
\NormalTok{myMap }\OtherTok{\textless{}{-}} \FunctionTok{GetMap}\NormalTok{(center, }\AttributeTok{size =} \FunctionTok{c}\NormalTok{(}\DecValTok{640}\NormalTok{, }\DecValTok{640}\NormalTok{), }\AttributeTok{zoom =}\NormalTok{ zoom, }\AttributeTok{type =} \StringTok{"osm"}\NormalTok{)}
\CommentTok{\# 在地图上添加红、蓝、绿三个点}
\FunctionTok{PlotOnStaticMap}\NormalTok{(myMap,}
  \AttributeTok{lat =}\NormalTok{ lat, }\AttributeTok{lon =}\NormalTok{ lon, }\AttributeTok{pch =} \DecValTok{20}\NormalTok{, }\AttributeTok{cex =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"red"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"green"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/google-map-1} 

}

\caption{Google 地图示例}\label{fig:google-map}
\end{figure}

\hypertarget{sec-ggplot2-heatmap}{%
\subsection{热图}\label{sec-ggplot2-heatmap}}

Zuguang Gu 开发的 \href{https://github.com/jokergoo/ComplexHeatmap}{ComplexHeatmap} 包实现复杂数据的可视化，用以发现关联数据集之间的模式。特别地，比如基因数据、生存数据等，更多应用见开发者的书籍 \href{https://jokergoo.github.io/ComplexHeatmap-reference/book/}{ComplexHeatmap 完全手册} 。 R 包发布在 Bioconductor 上 \url{https://www.bioconductor.org/packages/ComplexHeatmap}。使用之前我要确保已经安装 \textbf{BiocManager} 包，这个包负责管理 Bioconductor 上所有的包，需要先安装它，然后安装 \textbf{ComplexHeatmap} 包 \citep{Gu_2016_heatmap}。

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"BiocManager"}\NormalTok{, }\AttributeTok{quietly =} \ConstantTok{TRUE}\NormalTok{))}
    \FunctionTok{install.packages}\NormalTok{(}\StringTok{"BiocManager"}\NormalTok{)}
\NormalTok{BiocManager}\SpecialCharTok{::}\FunctionTok{install}\NormalTok{(}\StringTok{"ComplexHeatmap"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{ggplot2-scatter}{%
\subsection{散点图}\label{ggplot2-scatter}}

下面以 diamonds 数据集为例展示 ggplot2 的绘图过程，首先加载 diamonds 数据集，查看数据集的内容

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(diamonds)}
\FunctionTok{str}\NormalTok{(diamonds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## tibble [53,940 x 10] (S3: tbl_df/tbl/data.frame)
##  $ carat  : num [1:53940] 0.23 0.21 0.23 0.29 0.31 0.24 0.24 0.26 0.22 0.23 ...
##  $ cut    : Ord.factor w/ 5 levels "Fair"<"Good"<..: 5 4 2 4 2 3 3 3 1 3 ...
##  $ color  : Ord.factor w/ 7 levels "D"<"E"<"F"<"G"<..: 2 2 2 6 7 7 6 5 2 5 ...
##  $ clarity: Ord.factor w/ 8 levels "I1"<"SI2"<"SI1"<..: 2 3 5 4 2 6 7 3 4 5 ...
##  $ depth  : num [1:53940] 61.5 59.8 56.9 62.4 63.3 62.8 62.3 61.9 65.1 59.4 ...
##  $ table  : num [1:53940] 55 61 65 58 58 57 57 55 61 61 ...
##  $ price  : int [1:53940] 326 326 327 334 335 336 336 337 337 338 ...
##  $ x      : num [1:53940] 3.95 3.89 4.05 4.2 4.34 3.94 3.95 4.07 3.87 4 ...
##  $ y      : num [1:53940] 3.98 3.84 4.07 4.23 4.35 3.96 3.98 4.11 3.78 4.05 ...
##  $ z      : num [1:53940] 2.43 2.31 2.31 2.63 2.75 2.48 2.47 2.53 2.49 2.39 ...
\end{verbatim}

数值型变量 carat 作为 x 轴

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat))}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price))}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{color =}\NormalTok{ cut))}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat), }\AttributeTok{color =} \StringTok{"steelblue"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[指定 x 轴\label{fig:diamonds-axis-1}]{\includegraphics[width=0.35\linewidth]{data-visualization_files/figure-latex/diamonds-axis-1} }\subfloat[数值变量 price 作为纵轴\label{fig:diamonds-axis-2}]{\includegraphics[width=0.35\linewidth]{data-visualization_files/figure-latex/diamonds-axis-2} }\newline\subfloat[有序分类变量 cut 指定颜色\label{fig:diamonds-axis-3}]{\includegraphics[width=0.35\linewidth]{data-visualization_files/figure-latex/diamonds-axis-3} }\subfloat[指定统一颜色\label{fig:diamonds-axis-4}]{\includegraphics[width=0.35\linewidth]{data-visualization_files/figure-latex/diamonds-axis-4} }

}

\caption{绘图过程}\label{fig:diamonds-axis}
\end{figure}

图 \ref{fig:diamonds-axis} 的基础上添加数据图层

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sub\_diamonds }\OtherTok{\textless{}{-}}\NormalTok{ diamonds[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(diamonds), }\DecValTok{1000}\NormalTok{), ]}
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-1} 

}

\caption{添加数据图层}\label{fig:scatter}
\end{figure}

给散点图\ref{fig:scatter}上色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"steelblue"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-color-1-1} 

}

\caption{散点图配色}\label{fig:scatter-color-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"steelblue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{unit\_format}\NormalTok{(}\AttributeTok{unit =} \StringTok{"k"}\NormalTok{, }\AttributeTok{scale =} \FloatTok{1e{-}3}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{20000}\NormalTok{, }\DecValTok{4000}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-scale-1-1} 

}

\caption{格式化坐标轴刻度标签}\label{fig:scatter-scale-1}
\end{figure}

让另一变量 cut 作为颜色分类指标

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-color-2-1} 

}

\caption{分类散点图}\label{fig:scatter-color-2}
\end{figure}

当然还有一种类似的表示就是分组，默认情况下，ggplot2将所有观测点视为一组，以分类变量 cut 来分组

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-group-1} 

}

\caption{分组}\label{fig:scatter-group}
\end{figure}

在图\ref{fig:scatter-group} 上没有体现出来分组的意思，下面以 cut 分组线性回归为例

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-lm-1} 

}

\caption{分组线性回归}\label{fig:group-lm-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-lm-2} 

}

\caption{分组线性回归}\label{fig:group-lm-2}
\end{figure}

我们当然可以选择更加合适的拟合方式，如局部多项式平滑 \texttt{loess} 但是该方法不太适用观测值比较多的情况，因为它会占用比较多的内存，建议使用广义可加模型作平滑拟合

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"loess"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-36-1} 

}

\caption{局部多项式平滑}\label{fig:unnamed-chunk-36}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"gam"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, }\AttributeTok{bs =} \StringTok{"cs"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-gam-1} 

}

\caption{数据分组应用广义可加平滑}\label{fig:group-gam}
\end{figure}

\href{https://github.com/sinhrks/ggfortify}{ggfortify} 包支持更多的统计分析结果的可视化。

为了更好地区分开组别，我们在图\ref{fig:group-gam}的基础上分面或者配色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"gam"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, }\AttributeTok{bs =} \StringTok{"cs"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-facet-1} 

}

\caption{分组分面}\label{fig:group-facet-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"gam"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, }\AttributeTok{bs =} \StringTok{"cs"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-facet-2} 

}

\caption{分组配色}\label{fig:group-facet-2}
\end{figure}

在分类散点图的另一种表示方法就是分面图，以 cut 变量作为分面的依据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-facet-1} 

}

\caption{分面散点图}\label{fig:scatter-facet}
\end{figure}

给图 \ref{fig:scatter-facet} 上色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"steelblue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-facet-color-1-1} 

}

\caption{给分面散点图上色}\label{fig:scatter-facet-color-1}
\end{figure}

在图\ref{fig:scatter-facet-color-1}的基础上，给不同的类上不同的颜色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-facet-color-2-1} 

}

\caption{给不同的类上不同的颜色}\label{fig:scatter-facet-color-2}
\end{figure}

去掉图例，此时图例属于冗余信息了

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-facet-color-3-1} 

}

\caption{去掉图例}\label{fig:scatter-facet-color-3}
\end{figure}

四块土地，所施肥料不同，肥力大小顺序 4 \textless{} 2 \textless{} 3 \textless{} 1 小麦产量随肥力的变化

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(Wheat2, }\AttributeTok{package =} \StringTok{"nlme"}\NormalTok{) }\CommentTok{\# Wheat Yield Trials}
\FunctionTok{library}\NormalTok{(colorspace)}
\FunctionTok{ggplot}\NormalTok{(Wheat2, }\FunctionTok{aes}\NormalTok{(longitude, latitude)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =}\NormalTok{ yield, }\AttributeTok{colour =}\NormalTok{ Block)) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_discrete\_sequential}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Viridis"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{5}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-37-1} 

}

\caption{多个图例}\label{fig:unnamed-chunk-37}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mtcars, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ hp, }\AttributeTok{y =}\NormalTok{ mpg, }\AttributeTok{color =} \FunctionTok{factor}\NormalTok{(am))) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/category-ggplot-1} 

}

\caption{分类散点图}\label{fig:category-ggplot}
\end{figure}

图层、分组、分面和散点图介绍完了，接下来就是其它统计图形，如箱线图，小提琴图和条形图

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1948} \SpecialCharTok{+} \FunctionTok{seq}\NormalTok{(}\DecValTok{12}\NormalTok{), }\AttributeTok{each =} \DecValTok{12}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{12}\NormalTok{), }\DecValTok{12}\NormalTok{), AirPassengers))}
\FunctionTok{colnames}\NormalTok{(dat) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"year"}\NormalTok{, }\StringTok{"month"}\NormalTok{, }\StringTok{"passengers"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{as.factor}\NormalTok{(year), }\AttributeTok{y =} \FunctionTok{as.factor}\NormalTok{(month))) }\SpecialCharTok{+}
  \FunctionTok{stat\_sum}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =}\NormalTok{ passengers), }\AttributeTok{colour =} \StringTok{"lightblue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_size}\NormalTok{(}\AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{650}\NormalTok{, }\DecValTok{50}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Year"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Month"}\NormalTok{, }\AttributeTok{colour =} \StringTok{"Passengers"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-38-1} 

}

\caption{1948年至1960年航班乘客人数变化}\label{fig:unnamed-chunk-38}
\end{figure}

\hypertarget{sec-ggplot2-barplot}{%
\subsection{条形图}\label{sec-ggplot2-barplot}}

条形图特别适合分类变量的展示，我们这里展示钻石切割质量 cut 不同等级的数量，当然我们可以直接展示各类的数目，在图层 \texttt{geom\_bar} 中指定 \texttt{stat="identity"}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 需要映射数据框的两个变量，相当于自己先计算了每类的数量}
\FunctionTok{with}\NormalTok{(diamonds, }\FunctionTok{table}\NormalTok{(cut))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## cut
##      Fair      Good Very Good   Premium     Ideal 
##      1610      4906     12082     13791     21551
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cut\_df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{table}\NormalTok{(diamonds}\SpecialCharTok{$}\NormalTok{cut))}
\FunctionTok{ggplot}\NormalTok{(cut\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Var1, }\AttributeTok{y =}\NormalTok{ Freq)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-39-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-1-1} 

}

\caption{频数条形图}\label{fig:diamonds-barplot-1}
\end{figure}

还有另外三种表示方法

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"count"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-40-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ ..count..)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-40-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =} \FunctionTok{stat}\NormalTok{(count))) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-40-3} \end{center}

我们还可以在图 \ref{fig:diamonds-barplot-1} 的基础上再添加一个分类变量钻石的纯净度 clarity，形成堆积条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-2-1} 

}

\caption{堆积条形图}\label{fig:diamonds-barplot-2}
\end{figure}

再添加一个分类变量钻石颜色 color 比较好的做法是分面

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-3-1} 

}

\caption{分面堆积条形图}\label{fig:diamonds-barplot-3}
\end{figure}

实际上，绘制图\ref{fig:diamonds-barplot-3}包含了对分类变量的分组计数过程，如下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(diamonds, }\FunctionTok{table}\NormalTok{(cut, color))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            color
## cut            D    E    F    G    H    I    J
##   Fair       163  224  312  314  303  175  119
##   Good       662  933  909  871  702  522  307
##   Very Good 1513 2400 2164 2299 1824 1204  678
##   Premium   1603 2337 2331 2924 2360 1428  808
##   Ideal     2834 3903 3826 4884 3115 2093  896
\end{verbatim}

还有一种堆积的方法是按比例，而不是按数量，如图\ref{fig:diamonds-barplot-4}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-4-1} 

}

\caption{比例堆积条形图}\label{fig:diamonds-barplot-4}
\end{figure}

接下来就是复合条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-5-1} 

}

\caption{复合条形图}\label{fig:diamonds-barplot-5}
\end{figure}

再添加一个分类变量，就是需要分面大法了，图 \ref{fig:diamonds-barplot-5} 展示了三个分类变量，其实我们还可以再添加一个分类变量用作分面的列依据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\AttributeTok{rows =} \FunctionTok{vars}\NormalTok{(cut))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-6-1} 

}

\caption{分面复合条形图}\label{fig:diamonds-barplot-6}
\end{figure}

图 \ref{fig:diamonds-barplot-6} 展示的数据如下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(diamonds, }\FunctionTok{table}\NormalTok{(color, clarity, cut))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , cut = Fair
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D    4   56   58   25    5    9    3    3
##     E    9   78   65   42   14   13    3    0
##     F   35   89   83   53   33   10    5    4
##     G   53   80   69   45   45   17    3    2
##     H   52   91   75   41   32   11    1    0
##     I   34   45   30   32   25    8    1    0
##     J   23   27   28   23   16    1    1    0
## 
## , , cut = Good
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D    8  223  237  104   43   25   13    9
##     E   23  202  355  160   89   52   43    9
##     F   19  201  273  184  132   50   35   15
##     G   19  163  207  192  152   75   41   22
##     H   14  158  235  138   77   45   31    4
##     I    9   81  165  110  103   26   22    6
##     J    4   53   88   90   52   13    1    6
## 
## , , cut = Very Good
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D    5  314  494  309  175  141   52   23
##     E   22  445  626  503  293  298  170   43
##     F   13  343  559  466  293  249  174   67
##     G   16  327  474  479  432  302  190   79
##     H   12  343  547  376  257  145  115   29
##     I    8  200  358  274  205   71   69   19
##     J    8  128  182  184  120   29   19    8
## 
## , , cut = Premium
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D   12  421  556  339  131   94   40   10
##     E   30  519  614  629  292  121  105   27
##     F   34  523  608  619  290  146   80   31
##     G   46  492  566  721  566  275  171   87
##     H   46  521  655  532  336  118  112   40
##     I   24  312  367  315  221   82   84   23
##     J   13  161  209  202  153   34   24   12
## 
## , , cut = Ideal
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D   13  356  738  920  351  284  144   28
##     E   18  469  766 1136  593  507  335   79
##     F   42  453  608  879  616  520  440  268
##     G   16  486  660  910  953  774  594  491
##     H   38  450  763  556  467  289  326  226
##     I   17  274  504  438  408  178  179   95
##     J    2  110  243  232  201   54   29   25
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 漫谈条形图 https://cosx.org/2017/10/discussion{-}about{-}bar{-}graph}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{age =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{30}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{gender =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"man"}\NormalTok{, }\StringTok{"woman"}\NormalTok{), }\AttributeTok{each =} \DecValTok{30}\NormalTok{),}
  \AttributeTok{num =} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{100}\NormalTok{, }\AttributeTok{size =} \DecValTok{60}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T)}
\NormalTok{)}
\CommentTok{\# 重叠}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ num, }\AttributeTok{fill =}\NormalTok{ gender)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{)}
\CommentTok{\# 堆积}
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ num, }\AttributeTok{fill =}\NormalTok{ gender)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"stack"}\NormalTok{)}
\CommentTok{\# 双柱}
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ num, }\AttributeTok{fill =}\NormalTok{ gender)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{)}
\CommentTok{\# 百分比}
\NormalTok{p4 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ num, }\AttributeTok{fill =}\NormalTok{ gender)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent\_format}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{y =} \StringTok{"\%"}\NormalTok{)}
\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2) }\SpecialCharTok{/}\NormalTok{ (p3 }\SpecialCharTok{+}\NormalTok{ p4)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/barplot-1-1} 

}

\caption{条形图的四种常见形态}\label{fig:barplot-1}
\end{figure}

以数据集 diamonds 为例，按照纯净度 clarity 和切工 cut 分组统计钻石的数量，再按切工分组统计不同纯净度的钻石数量占比，如表 \ref{tab:diamonds-table} 所示

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{diamonds }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(diamonds)}
\NormalTok{dat }\OtherTok{\textless{}{-}}\NormalTok{ diamonds[, .(}\AttributeTok{cnt =}\NormalTok{ .N), by }\OtherTok{=}\NormalTok{ .(cut, clarity)] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[, pct }\SpecialCharTok{:}\ErrorTok{=}\NormalTok{ cnt }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(cnt), by }\OtherTok{=}\NormalTok{ .(cut)] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[, pct\_pp }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{paste0}\NormalTok{(cnt, }\StringTok{" ("}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(pct, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{), }\StringTok{")"}\NormalTok{) ]}
\CommentTok{\# 分组计数 with(diamonds, table(clarity, cut))}
\FunctionTok{dcast}\NormalTok{(dat, }\AttributeTok{formula =}\NormalTok{ clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut, }\AttributeTok{value.var =} \StringTok{"pct\_pp"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(}\AttributeTok{align =} \StringTok{"crrrrr"}\NormalTok{, }\AttributeTok{caption =} \StringTok{"数值和比例组合呈现"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:diamonds-table}数值和比例组合呈现}
\centering
\begin{tabular}[t]{c|r|r|r|r|r}
\hline
clarity & Fair & Good & Very Good & Premium & Ideal\\
\hline
I1 & 210 (13.04\%) & 96 (1.96\%) & 84 (0.70\%) & 205 (1.49\%) & 146 (0.68\%)\\
\hline
SI2 & 466 (28.94\%) & 1081 (22.03\%) & 2100 (17.38\%) & 2949 (21.38\%) & 2598 (12.06\%)\\
\hline
SI1 & 408 (25.34\%) & 1560 (31.80\%) & 3240 (26.82\%) & 3575 (25.92\%) & 4282 (19.87\%)\\
\hline
VS2 & 261 (16.21\%) & 978 (19.93\%) & 2591 (21.45\%) & 3357 (24.34\%) & 5071 (23.53\%)\\
\hline
VS1 & 170 (10.56\%) & 648 (13.21\%) & 1775 (14.69\%) & 1989 (14.42\%) & 3589 (16.65\%)\\
\hline
VVS2 & 69 (4.29\%) & 286 (5.83\%) & 1235 (10.22\%) & 870 (6.31\%) & 2606 (12.09\%)\\
\hline
VVS1 & 17 (1.06\%) & 186 (3.79\%) & 789 (6.53\%) & 616 (4.47\%) & 2047 (9.50\%)\\
\hline
IF & 9 (0.56\%) & 71 (1.45\%) & 268 (2.22\%) & 230 (1.67\%) & 1212 (5.62\%)\\
\hline
\end{tabular}
\end{table}

分别以堆积条形图和百分比堆积条形图展示，添加注释到条形图上，见 \ref{fig:barplot-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{=} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ cnt, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ cnt), }\AttributeTok{position =} \FunctionTok{position\_dodge}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(pct, }\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{)),}
    \AttributeTok{position =} \FunctionTok{position\_dodge}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{vjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{hjust =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{"clarity"}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{x =} \StringTok{"cut"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{)}

\NormalTok{p2 }\OtherTok{=} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ cut, }\AttributeTok{x =}\NormalTok{ cnt, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ cnt), }\AttributeTok{position =} \FunctionTok{position\_fill}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(pct, }\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{)),}
    \AttributeTok{position =} \FunctionTok{position\_fill}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{vjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{hjust =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{percent) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{"clarity"}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{x =} \StringTok{"cut"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{)}

\NormalTok{p1 }\SpecialCharTok{/}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/barplot-2-1} 

}

\caption{添加注释到条形图}\label{fig:barplot-2}
\end{figure}

借助 plotly 制作相应的动态百分比堆积条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge2"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{)}

\CommentTok{\# 百分比堆积条形图}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(dat,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{pct,}
  \AttributeTok{colors =} \StringTok{"Spectral"}\NormalTok{, }\AttributeTok{type =} \StringTok{"bar"}\NormalTok{,}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
\NormalTok{    cnt, }\StringTok{"颗 \textless{}br\textgreater{}"}\NormalTok{,}
    \StringTok{"占比："}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(pct, }\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}
\NormalTok{  ),}
  \AttributeTok{hoverinfo =} \StringTok{"text"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{barmode =} \StringTok{"stack"}\NormalTok{,}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{tickformat =} \StringTok{".0\%"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}

\CommentTok{\# \textasciigrave{}type = "histogram"\textasciigrave{} 以 cut 和 clarity 分组计数}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Spectral"}\NormalTok{, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}

\CommentTok{\# 堆积图}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Spectral"}\NormalTok{, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{barmode =} \StringTok{"stack"}\NormalTok{, }
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"cnt"}\NormalTok{),}
    \AttributeTok{legend =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{"clarity"}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{ggplot2-histogram}{%
\subsection{直方图}\label{ggplot2-histogram}}

直方图用来查看连续变量的分布

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(price)) }\SpecialCharTok{+} \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins =} \DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-43-1} 

}

\caption{钻石价格的分布}\label{fig:unnamed-chunk-43}
\end{figure}

堆积直方图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins =} \DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-44-1} 

}

\caption{钻石价格随切割质量的分布}\label{fig:unnamed-chunk-44}
\end{figure}

基础 R 包与 Ggplot2 包绘制的直方图的对比，Base R 绘图速度快，代码更加稳定，Ggplot2 代码简洁，更美观

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{2.1}\NormalTok{, }\FloatTok{2.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{),}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{font.main =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{frame.plot =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
  \CommentTok{\# xlab = "hp", ylab = "Frequency",}
  \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Histogram with Base R"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{" "}\NormalTok{, }\DecValTok{60}\NormalTok{), }\AttributeTok{collapse =} \StringTok{""}\NormalTok{))}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}
  \AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{),}
  \AttributeTok{tick =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{padj =} \DecValTok{0}\NormalTok{, }\AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}
  \AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \CommentTok{\# col = "white", 坐标轴的颜色}
  \CommentTok{\# col.ticks 刻度线的颜色}
  \AttributeTok{tick =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 取消刻度线}
  \AttributeTok{las =} \DecValTok{1}\NormalTok{, }\CommentTok{\# 水平方向}
  \AttributeTok{hadj =} \DecValTok{1}\NormalTok{, }\CommentTok{\# 右侧对齐}
  \AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{0}\NormalTok{) }\CommentTok{\# 纵轴边距线设置为 0.1}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{v =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{col =} \StringTok{"gray90"}\NormalTok{, }\AttributeTok{lty =} \StringTok{"solid"}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{v =} \FunctionTok{seq}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{325}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{col =} \StringTok{"gray95"}\NormalTok{, }\AttributeTok{lty =} \StringTok{"solid"}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{hp,}
  \AttributeTok{col =} \StringTok{"\#56B4E9"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{,}
  \AttributeTok{freq =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}
  \CommentTok{\# labels = TRUE, axes = TRUE, ylim = c(0, 10.5),}
  \CommentTok{\# xlab = "hp",main = "Histogram with Base R"}
\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"hp"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.0}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Frequency"}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.0}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(mtcars) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ hp), }\AttributeTok{fill =} \StringTok{"\#56B4E9"}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"hp"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Frequency"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Histogram with Ggplot2"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[Base R 直方图\label{fig:base-vs-ggplot2-hist-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/base-vs-ggplot2-hist-1} }\subfloat[Ggplot2 直方图\label{fig:base-vs-ggplot2-hist-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/base-vs-ggplot2-hist-2} }

}

\caption{直方图}\label{fig:base-vs-ggplot2-hist}
\end{figure}

\hypertarget{ggplot2-boxplot}{%
\subsection{箱线图}\label{ggplot2-boxplot}}

以 PlantGrowth 数据集为例展示箱线图，在两组不同实验条件下，植物生长的情况，纵坐标是干燥植物的量，横坐标表示不同的实验条件。这是非常典型的适合用箱线图来表达数据的场合，Y 轴对应数值型变量，X 轴对应分类变量，在 R 语言中，分类变量的类型是 factor

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"PlantGrowth"}\NormalTok{)}
\FunctionTok{str}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    30 obs. of  2 variables:
##  $ weight: num  4.17 5.58 5.18 6.11 4.5 4.61 5.17 4.53 5.33 5.14 ...
##  $ group : Factor w/ 3 levels "ctrl","trt1",..: 1 1 1 1 1 1 1 1 1 1 ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight)) }\SpecialCharTok{+} \FunctionTok{geom\_boxplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/PlantGrowth-boxplot-1} \end{center}

PlantGrowth 数据量比较小，此时比较适合采用抖动散点图，抖动是为了避免点之间相互重叠，为了增加不同类别之间的识别性，我们可以用不同的点的形状或者不同的颜色来表示类别

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{shape =}\NormalTok{ group)) }\SpecialCharTok{+} \FunctionTok{geom\_jitter}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/PlantGrowth-jitter-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{color =}\NormalTok{ group)) }\SpecialCharTok{+} \FunctionTok{geom\_jitter}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/PlantGrowth-jitter-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group,}
  \AttributeTok{data =}\NormalTok{ PlantGrowth,}
  \AttributeTok{ylab =} \StringTok{"Dried weight of plants"}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{,}
  \AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-46-1} \end{center}

以钻石切割质量 cut 为分面依据，以钻石颜色类别 color 为 x 轴，钻石价格为 y 轴，绘制箱线图\ref{fig:boxplot-facet-color}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-facet-color-1} 

}

\caption{箱线图}\label{fig:boxplot-facet-color}
\end{figure}

我们当然还可以添加钻石的纯净度 clarity 作为分面依据，那么箱线图可以为图 \ref{fig:boxplot-facet-color-clarity-1}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-facet-color-clarity-1-1} 

}

\caption{复合分面箱线图}\label{fig:boxplot-facet-color-clarity-1}
\end{figure}

经过观察，我们发现水平分类过多，考虑用切割质量 cut 替换钻石颜色 color 绘图，但是由于分类过细，图信息展示不简练，反而不好，如图 \ref{fig:boxplot-facet-color-clarity-2}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ color)}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ color)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[切割质量cut上色\label{fig:boxplot-facet-color-clarity-2-1}]{\includegraphics{data-visualization_files/figure-latex/boxplot-facet-color-clarity-2-1} }\newline\subfloat[钻石颜色配色\label{fig:boxplot-facet-color-clarity-2-2}]{\includegraphics{data-visualization_files/figure-latex/boxplot-facet-color-clarity-2-2} }

}

\caption{箱线图配色}\label{fig:boxplot-facet-color-clarity-2}
\end{figure}

\hypertarget{sec-ggplot2-function}{%
\subsection{函数图}\label{sec-ggplot2-function}}

蝴蝶图的参数方程如下

\begin{align}
x &= \sin t \big(\mathrm e^{\cos t} - 2 \cos 4t + \sin^5(\frac{t}{12})\big) \\
y &= \cos t \big(\mathrm e^{\cos t} - 2 \cos 4t + \sin^5(\frac{t}{12})\big), t \in [- \pi, \pi]
\end{align}

\hypertarget{sec-ggplot2-density}{%
\subsection{密度图}\label{sec-ggplot2-density}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(cty)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{factor}\NormalTok{(cyl)), }\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Density plot"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"City Mileage Grouped by Number of cylinders"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"Source: mpg"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"City Mileage"}\NormalTok{,}
    \AttributeTok{fill =} \StringTok{"\# Cylinders"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/mpg-cyl-density-1} 

}

\caption{按汽缸数分组的城市里程}\label{fig:mpg-cyl-density}
\end{figure}

添加透明度，解决遮挡

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_density}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/density-1} 

}

\caption{密度图}\label{fig:density-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_density}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/density-2} 

}

\caption{添加透明度的密度图}\label{fig:density-2}
\end{figure}

堆积密度图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density}\NormalTok{(}\AttributeTok{position =} \StringTok{"stack"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/stack-density-1} 

}

\caption{堆积密度图}\label{fig:stack-density}
\end{figure}

条件密度估计

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# You can use position="fill" to produce a conditional density estimate}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(carat, }\FunctionTok{stat}\NormalTok{(count), }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-47-1} 

}

\caption{条件密度估计图}\label{fig:unnamed-chunk-47}
\end{figure}

岭线图是密度图的一种变体，可以防止密度曲线重叠在一起

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds) }\SpecialCharTok{+}
\NormalTok{  ggridges}\SpecialCharTok{::}\FunctionTok{geom\_density\_ridges}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{y =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ color))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-48-1} \end{center}

二维的密度图又是一种延伸

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density\_2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-49-1} \end{center}

\texttt{stat} 函数，特别是 nlevel 参数，在密度曲线之间填充我们又可以得到热力图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{stat\_density\_2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{stat}\NormalTok{(nlevel)), }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(. }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-50-1} \end{center}

\texttt{gemo\_hex} 也是二维密度图的一种变体，特别适合数据量比较大的情形

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+} \FunctionTok{geom\_hex}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-51-1} \end{center}

\href{https://themockup.blog/posts/2020-08-28-heatmaps-in-ggplot2/}{heatmaps in ggplot2} 二维密度图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ eruptions, }\AttributeTok{y =}\NormalTok{ waiting)) }\SpecialCharTok{+}
  \FunctionTok{stat\_density\_2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ ..level..), }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{100}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ eruptions, }\AttributeTok{y =}\NormalTok{ waiting)) }\SpecialCharTok{+}
  \FunctionTok{stat\_density2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{stat}\NormalTok{(level)), }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{(}\AttributeTok{option =} \StringTok{"viridis"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[默认调色板\label{fig:density-2d-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/density-2d-1} }\subfloat[viridis 调色板\label{fig:density-2d-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/density-2d-2} }

}

\caption{二维密度图}\label{fig:density-2d}
\end{figure}

\begin{rmdtip}{提示}

\texttt{MASS::kde2d()} 实现二维核密度估计，\textbf{ggplot2} 包提供了两种等价的绘图方式

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{stat\_density\_2d()} 和 \texttt{..}
\item
  \texttt{stat\_density2d()} 和 \texttt{stat()}
\end{enumerate}

\end{rmdtip}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ faithful, }\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{eruptions,}
  \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{waiting, }\AttributeTok{type =} \StringTok{"histogram2dcontour"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}

\CommentTok{\# plot\_ly(faithful, x = \textasciitilde{}waiting, y = \textasciitilde{}eruptions) \%\textgreater{}\% }
\CommentTok{\#   add\_histogram2d() \%\textgreater{}\% }
\CommentTok{\#   add\_histogram2dcontour()}
\end{Highlighting}
\end{Shaded}

延伸一下，热力图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(KernSmooth)}
\NormalTok{den }\OtherTok{\textless{}{-}} \FunctionTok{bkde2D}\NormalTok{(}\AttributeTok{x =}\NormalTok{ faithful, }\AttributeTok{bandwidth =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\CommentTok{\# 热力图}
\NormalTok{p1 }\OtherTok{\textless{}{-}}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{x1, }\AttributeTok{y =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{x2, }\AttributeTok{z =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{fhat) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_heatmap}\NormalTok{()}

\CommentTok{\# 等高线图}
\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{x1, }\AttributeTok{y =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{x2, }\AttributeTok{z =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{fhat) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_contour}\NormalTok{()}

\NormalTok{htmltools}\SpecialCharTok{::}\FunctionTok{tagList}\NormalTok{(p1, p2)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-violin}{%
\subsection{提琴图}\label{sec-ggplot2-violin}}

2004 年 Daniel Adler 开发 \href{https://github.com/TomKellyGenetics/vioplot}{vioplot} 包实现提琴图的绘制，它可能是最早实现此功能的 R 包，随后10余年没有更新却一直坚挺在 CRAN 上，非常难得，好在 Thomas Kelly 已经接手维护。另一款绘制提琴图的 R 包是 Peter Kampstra 开发的 \href{https://cran.r-project.org/package=beanplot}{beanplot} \citep{beanplot_2008_jss}，也存在很多年了，不过随着时间的变迁，比较现代的方式是 \textbf{ggplot2} 带来的 \texttt{geom\_violin()} 扔掉了很多依赖，也是各种图形的汇集地，可以看作是最佳实践。提琴图比起箱线图优势在于呈现更多的分布信息，其次在于更加美观，但是就目前来说箱线图的受众比提琴图要多很多，毕竟前者是包含更多统计信息，如图\ref{fig:boxplot-violin} 所示。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays)}
\NormalTok{vioplot}\SpecialCharTok{::}\FunctionTok{vioplot}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(InsectSprays, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ spray, }\AttributeTok{y =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_violin}\NormalTok{(}\AttributeTok{fill =} \StringTok{"lightgray"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\NormalTok{beanplot}\SpecialCharTok{::}\FunctionTok{beanplot}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[简单箱线图\label{fig:boxplot-violin-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/boxplot-violin-1} }\subfloat[vioplot 绘制的提琴图\label{fig:boxplot-violin-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/boxplot-violin-2} }\newline\subfloat[ggplot2 绘制的提琴图\label{fig:boxplot-violin-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/boxplot-violin-3} }\subfloat[beanplot 绘制的提琴图\label{fig:boxplot-violin-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/boxplot-violin-4} }

}

\caption{几种不同的提琴图}\label{fig:boxplot-violin}
\end{figure}

\href{https://github.com/wjschne/ggnormalviolin}{ggnormalviolin} 包在给定均值和标准差的情况下，绘制正态分布的概率密度曲线，如图 \ref{fig:normal-violin} 所示。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggnormalviolin)}
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{aggregate}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ iris, Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species,}
    \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{c}\NormalTok{(}\AttributeTok{dist\_mean =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{dist\_sd =} \FunctionTok{sd}\NormalTok{(x))}
\NormalTok{  ),}
  \FunctionTok{cbind.data.frame}\NormalTok{(Sepal.Length, Species)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Species, }\AttributeTok{mu =}\NormalTok{ dist\_mean, }\AttributeTok{sigma =}\NormalTok{ dist\_sd, }\AttributeTok{fill =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{geom\_normalviolin}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/normal-violin-1} 

}

\caption{正态分布的概率密度曲线}\label{fig:normal-violin}
\end{figure}

\hypertarget{ggplot2-jitter}{%
\subsection{抖动图}\label{ggplot2-jitter}}

抖动图适合数据量比较小的情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class, }\AttributeTok{y =}\NormalTok{ hwy, }\AttributeTok{color =}\NormalTok{ class)) }\SpecialCharTok{+} \FunctionTok{geom\_jitter}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-53-1} \end{center}

抖不抖，还是抖一下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Species, }\AttributeTok{y =}\NormalTok{ Sepal.Length)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ Species), }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{colour =} \StringTok{"grey20"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\# geom\_boxplot(outlier.colour = NA, fill = NA, colour = "grey20") +}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Not Jittered"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-54-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Species, }\AttributeTok{y =}\NormalTok{ Sepal.Length)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ Species),}
    \AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{colour =} \StringTok{"grey20"}\NormalTok{,}
    \AttributeTok{position =} \FunctionTok{position\_jitter}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{height =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \CommentTok{\# geom\_boxplot(outlier.colour = NA, fill = NA, colour = "grey20") +}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Jittered"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-54-2} \end{center}

在数据量比较大的时候，可以用箱线图、密度图、提琴图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+} \FunctionTok{geom\_jitter}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-55-1} 

}

\caption{抖动图的反例}\label{fig:unnamed-chunk-55}
\end{figure}

上色和分面都不好使的抖动图，因为区分度变小

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-56-1} 

}

\caption{根据钻石颜色上色}\label{fig:unnamed-chunk-56}
\end{figure}

箱线图此时不宜分的过细

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(cut }\SpecialCharTok{\textasciitilde{}}\NormalTok{ clarity)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-facet-cut-clarity-1} 

}

\caption{箱线图}\label{fig:boxplot-facet-cut-clarity}
\end{figure}

所以这样更好，先按纯净度分面，再对比不同的颜色，钻石价格的差异

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{clarity)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-facet-clarity-1} 

}

\caption{钻石按纯净度分面}\label{fig:boxplot-facet-clarity}
\end{figure}

最好只比较一个维度，不同颜色钻石的价格对比

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-color-1} 

}

\caption{不同颜色钻石的价格比较}\label{fig:boxplot-color}
\end{figure}

\hypertarget{sec-ggplot2-beeswarm}{%
\subsection{蜂群图}\label{sec-ggplot2-beeswarm}}

在样本点有限的情况下，用蜜蜂图代替普通的抖动图，可视化效果会好很多，如图 \ref{fig:beeswarm} 所示。Erik Clarke 开发的 \href{https://github.com/eclarke/ggbeeswarm}{ggbeeswarm} 包可以将随机抖动的散点图朝着比较规律的方向聚合，又不丢失数据本身的准确性。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggbeeswarm)}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(Species, Sepal.Length)) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(Species, Sepal.Length)) }\SpecialCharTok{+}
  \FunctionTok{geom\_quasirandom}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/beeswarm-1} 

}

\caption{蜜蜂图可视化效果比抖动图好}\label{fig:beeswarm}
\end{figure}

\hypertarget{ggplot2-rose}{%
\subsection{玫瑰图}\label{ggplot2-rose}}

南丁格尔风玫瑰图\footnote{\url{https://mbostock.github.io/protovis/ex/crimea-rose-full.html}} 可以作为堆积条形图，分组条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/stack-to-rose-1} 

}

\caption{堆积条形图转风玫瑰图}\label{fig:stack-to-rose-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/stack-to-rose-2} 

}

\caption{堆积条形图转风玫瑰图}\label{fig:stack-to-rose-2}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 风玫瑰图 http://blog.csdn.net/Bone\_ACE/article/details/47624987}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2018}\NormalTok{)}
\CommentTok{\# 随机生成100次风向，并汇集到16个区间内}
\NormalTok{direction }\OtherTok{\textless{}{-}} \FunctionTok{cut\_interval}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{360}\NormalTok{), }\AttributeTok{n =} \DecValTok{16}\NormalTok{)}
\CommentTok{\# 随机生成100次风速，并划分成4种强度}
\NormalTok{mag }\OtherTok{\textless{}{-}} \FunctionTok{cut\_interval}\NormalTok{(}\FunctionTok{rgamma}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{15}\NormalTok{), }\DecValTok{4}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{direction =}\NormalTok{ direction, }\AttributeTok{mag =}\NormalTok{ mag)}
\CommentTok{\# 将风向映射到X轴，频数映射到Y轴，风速大小映射到填充色，生成条形图后再转为极坐标形式即可}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ direction, }\AttributeTok{y =}\NormalTok{ ..count.., }\AttributeTok{fill =}\NormalTok{ mag))}
\NormalTok{p }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{colour =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }\AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Magnitude"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/wind-rose-1} 

}

\caption{风玫瑰图}\label{fig:wind-rose}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }\AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Magnitude"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-57-1} \end{center}

\hypertarget{sec-ggplot2-tile}{%
\subsection{瓦片图}\label{sec-ggplot2-tile}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{months =}\NormalTok{ month.abb, }\AttributeTok{years =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{num =} \FunctionTok{as.vector}\NormalTok{(AirPassengers)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ years, }\AttributeTok{y =}\NormalTok{ months, }\AttributeTok{fill =}\NormalTok{ num)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_continuous}\NormalTok{(}\AttributeTok{type =} \StringTok{"viridis"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1949}\NormalTok{, }\DecValTok{1960}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{), }\AttributeTok{labels =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \FloatTok{10.54}\NormalTok{, }\AttributeTok{base\_family =} \StringTok{"source{-}han{-}serif{-}cn"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"年"}\NormalTok{, }\AttributeTok{y =} \StringTok{"月"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"人数"}\NormalTok{)}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{months =}\NormalTok{ month.abb, }\AttributeTok{years =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{num =} \FunctionTok{as.vector}\NormalTok{(AirPassengers)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ years, }\AttributeTok{y =}\NormalTok{ months, }\AttributeTok{color =}\NormalTok{ num)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{size =} \DecValTok{8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_distiller}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1949}\NormalTok{, }\DecValTok{1960}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{), }\AttributeTok{labels =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \FloatTok{10.54}\NormalTok{, }\AttributeTok{base\_family =} \StringTok{"source{-}han{-}sans{-}cn"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"年"}\NormalTok{, }\AttributeTok{y =} \StringTok{"月"}\NormalTok{, }\AttributeTok{color =} \StringTok{"人数"}\NormalTok{)}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/geom-tile-1} 

}

\caption{1949-1960年国际航线乘客数量的月度趋势}\label{fig:geom-tile}
\end{figure}

\hypertarget{sec-ggplot2-calendar}{%
\subsection{日历图}\label{sec-ggplot2-calendar}}

airquality 数据集记录了1973年5月至9月纽约的空气质量，包括气温（华氏度）、风速（米/小时）、紫外线强度、臭氧含量四个指标，图 \ref{fig:calendar-airquality} 展示了每日的气温变化。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{Date =} \FunctionTok{seq.Date}\NormalTok{(}
    \AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"1973{-}05{-}01"}\NormalTok{),}
    \AttributeTok{to =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"1973{-}09{-}30"}\NormalTok{), }\AttributeTok{by =} \StringTok{"day"}
\NormalTok{  )) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{Week =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{format}\NormalTok{(Date, }\StringTok{"\%W"}\NormalTok{)),}
    \AttributeTok{Year =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{format}\NormalTok{(Date, }\StringTok{"\%Y"}\NormalTok{)),}
    \AttributeTok{Weekdays =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{weekdays}\NormalTok{(Date, }\AttributeTok{abbreviate =}\NormalTok{ T),}
      \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Mon"}\NormalTok{, }\StringTok{"Tue"}\NormalTok{, }\StringTok{"Wed"}\NormalTok{, }\StringTok{"Thu"}\NormalTok{, }\StringTok{"Fri"}\NormalTok{, }\StringTok{"Sat"}\NormalTok{, }\StringTok{"Sun"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Week, }\AttributeTok{y =}\NormalTok{ Weekdays, }\AttributeTok{fill =}\NormalTok{ Temp)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_distiller}\NormalTok{(}\AttributeTok{name =} \StringTok{"Temp (F)"}\NormalTok{, }\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\StringTok{"Year"}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{52}\NormalTok{, }\AttributeTok{length =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ month.abb}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/calendar-airquality-1} 

}

\caption{1973年5月至9月纽约的气温变化}\label{fig:calendar-airquality}
\end{figure}

\begin{rmdnote}{注意}

图 \ref{fig:calendar-airquality} 横轴的刻度标签换成了月份，一个月为四周，一年 52～53 周，每周的第一天约定为星期一，1973年05月01日为星期二。代码中颇为技巧的在于 \texttt{format()} 函数从 Date 日期类型的数据提取第几周， 用 \texttt{weekdays()} 函数提取星期几，而 month.abb 则是一个内置常量，12个月份的英文缩写。在调用其它 R 包处理日期数据时要特别小心，要留意一周的的第一天是星期几，有的是星期一，有的是星期日，这往往和宗教信仰相关，星期日在西方也叫礼拜天。 上面 Base R 提供的日期函数认为一周的第一天是星期一，而调用 \textbf{data.table} 的话，默认一周是从星期日（礼拜天）开始的。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://d.cosx.org/d/421230}
\FunctionTok{weekdays}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{(), }\AttributeTok{abbreviate =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Tue"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{wday}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3
\end{verbatim}

\end{rmdnote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gert)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{git\_config\_set}\NormalTok{(}\StringTok{"user.name"}\NormalTok{, }\StringTok{"XiangyunHuang"}\NormalTok{)}
\FunctionTok{git\_config\_set}\NormalTok{(}\StringTok{"user.email"}\NormalTok{, }\StringTok{"xiangyunfaith@outlook.com"}\NormalTok{)}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{git\_log}\NormalTok{(}\AttributeTok{max =} \DecValTok{1000}\NormalTok{)}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(dat,}
  \AttributeTok{date =} \FunctionTok{format}\NormalTok{(time, }\StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{),}
  \AttributeTok{year =} \FunctionTok{format}\NormalTok{(time, }\StringTok{"\%Y"}\NormalTok{) ,}
  \AttributeTok{month =} \FunctionTok{format}\NormalTok{(time, }\StringTok{"\%m"}\NormalTok{),}
  \AttributeTok{weekday =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{format}\NormalTok{(time, }\StringTok{"\%a"}\NormalTok{),}
    \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Sun"}\NormalTok{, }\StringTok{"Mon"}\NormalTok{, }\StringTok{"Tue"}\NormalTok{, }\StringTok{"Wed"}\NormalTok{, }\StringTok{"Thu"}\NormalTok{, }\StringTok{"Fri"}\NormalTok{, }\StringTok{"Sat"}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{week =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{format}\NormalTok{(time, }\StringTok{"\%W"}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

本书的活跃情况

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat1 }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ commit }\SpecialCharTok{\textasciitilde{}}\NormalTok{ year }\SpecialCharTok{+}\NormalTok{ month, }\AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{FUN =}\NormalTok{ length)}
\CommentTok{\# 条形图}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ month, }\AttributeTok{y =}\NormalTok{ commit, }\AttributeTok{fill =}\NormalTok{ year)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{position =} \StringTok{"identity"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-60-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 日历图}
\NormalTok{dat2 }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ commit }\SpecialCharTok{\textasciitilde{}}\NormalTok{ year }\SpecialCharTok{+}\NormalTok{ week }\SpecialCharTok{+}\NormalTok{ weekday, }\AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{FUN =}\NormalTok{ length)}

\NormalTok{dat2 }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(dat2, }\AttributeTok{colorBin =} \FunctionTok{cut}\NormalTok{(commit, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{25}\NormalTok{)))}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ week, }\AttributeTok{y =}\NormalTok{ weekday, }\AttributeTok{fill =}\NormalTok{ colorBin)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{name =} \StringTok{"commit"}\NormalTok{, }\AttributeTok{palette =} \StringTok{"Greens"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\StringTok{"year"}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{52}\NormalTok{, }\AttributeTok{length =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ month.abb}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/calendar-masr-1} 

}

\caption{《现代统计图形》的活跃情况}\label{fig:calendar-masr}
\end{figure}

\hypertarget{sec-ggplot2-ridgeline}{%
\subsection{岭线图}\label{sec-ggplot2-ridgeline}}

\textbf{ggridges} 包，\href{https://yufree.cn/}{于淼} 对此图形的来龙去脉做了比较系统的阐述，详见统计之都主站文章\href{https://cosx.org/2018/04/ridgeline-story/}{叠嶂图的前世今生}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggridges)}
\FunctionTok{ggplot}\NormalTok{(lincoln\_weather, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{\textasciigrave{}}\AttributeTok{Mean Temperature [F]}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{y =}\NormalTok{ Month, }\AttributeTok{fill =} \FunctionTok{stat}\NormalTok{(x))) }\SpecialCharTok{+}
  \FunctionTok{geom\_density\_ridges\_gradient}\NormalTok{(}\AttributeTok{scale =} \DecValTok{3}\NormalTok{, }\AttributeTok{rel\_min\_height =} \FloatTok{0.01}\NormalTok{, }\AttributeTok{gradient\_lwd =} \FloatTok{1.}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_discrete}\NormalTok{(}\AttributeTok{expand =} \FunctionTok{expansion}\NormalTok{(}\AttributeTok{mult =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.25}\NormalTok{))) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{(}\AttributeTok{name =} \StringTok{"Temp. [F]"}\NormalTok{, }\AttributeTok{option =} \StringTok{"C"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{\textquotesingle{}Temperatures in Lincoln NE\textquotesingle{}}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{\textquotesingle{}Mean temperatures (Fahrenheit) by month for 2016\textquotesingle{}}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_ridges}\NormalTok{(}\AttributeTok{font\_size =} \DecValTok{13}\NormalTok{, }\AttributeTok{grid =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/lincoln-weather-1} 

}

\caption{2016年在内布拉斯加州林肯市的天气变化}\label{fig:lincoln-weather}
\end{figure}

通过数据可视化的手段帮助肉眼检查两组数据的分布

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(sleep, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ extra, }\AttributeTok{y =}\NormalTok{ group, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density\_ridges}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_ridges}\NormalTok{()}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{y =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density\_ridges}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_ridges}\NormalTok{()}

\NormalTok{p1 }\SpecialCharTok{/}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/sleep-diamonds-1} 

}

\caption{比较数据的分布}\label{fig:sleep-diamonds}
\end{figure}

\href{https://github.com/R-CoderDotCom/ridgeline}{ridgeline} 提供 Base R 绘图方案

\begin{figure}

{\centering \includegraphics[width=0.65\linewidth]{data-visualization_files/figure-latex/ridge-1} 

}

\caption{岭线图}\label{fig:ridge}
\end{figure}

\hypertarget{sec-ggplot2-ellipse}{%
\subsection{椭圆图}\label{sec-ggplot2-ellipse}}

type 指定多元分布的类型，\texttt{type\ =\ "t"} 和 \texttt{type\ =\ "norm"} 分别表示 t 分布和正态分布，\texttt{geom\ =\ "polygon"}，以 \texttt{eruptions\ \textgreater{}\ 3} 分为两组

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ waiting, }\AttributeTok{y =}\NormalTok{ eruptions)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{stat\_ellipse}\NormalTok{()}

\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(waiting, eruptions, }\AttributeTok{color =}\NormalTok{ eruptions }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{stat\_ellipse}\NormalTok{(}\AttributeTok{type =} \StringTok{"norm"}\NormalTok{, }\AttributeTok{linetype =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{stat\_ellipse}\NormalTok{(}\AttributeTok{type =} \StringTok{"t"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(waiting, eruptions, }\AttributeTok{fill =}\NormalTok{ eruptions }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{stat\_ellipse}\NormalTok{(}\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[简单椭圆图\label{fig:ellipse-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/ellipse-1} }\subfloat[正态和 t 分布\label{fig:ellipse-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/ellipse-2} }\newline\subfloat[填充几何图形\label{fig:ellipse-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/ellipse-3} }

}

\caption{几种不同的椭圆图}\label{fig:ellipse}
\end{figure}

\hypertarget{sec-ggplot2-chull}{%
\subsection{包络图}\label{sec-ggplot2-chull}}

ggpubr 包提供了 \texttt{stat\_chull()} 图层

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggpubr)}
\FunctionTok{ggscatter}\NormalTok{(mpg, }\AttributeTok{x =} \StringTok{"displ"}\NormalTok{, }\AttributeTok{y =} \StringTok{"hwy"}\NormalTok{, }\AttributeTok{color =} \StringTok{"drv"}\NormalTok{)}\SpecialCharTok{+}
 \FunctionTok{stat\_chull}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ drv, }\AttributeTok{fill =}\NormalTok{ drv), }\AttributeTok{alpha =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/stat-chull-1} 

}

\caption{包络图}\label{fig:stat-chull}
\end{figure}

其背后的原理如下

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stat\_chull}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (mapping = NULL, data = NULL, geom = "path", position = "identity", 
##     na.rm = FALSE, show.legend = NA, inherit.aes = TRUE, ...) 
## {
##     layer(stat = StatChull, data = data, mapping = mapping, geom = geom, 
##         position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
##         params = list(na.rm = na.rm, ...))
## }
## <bytecode: 0x56509116ee08>
## <environment: namespace:ggpubr>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{StatChull }\OtherTok{\textless{}{-}} \FunctionTok{ggproto}\NormalTok{(}\StringTok{"StatChull"}\NormalTok{, Stat,}
  \AttributeTok{compute\_group =} \ControlFlowTok{function}\NormalTok{(data, scales) \{}
\NormalTok{    data[}\FunctionTok{chull}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{x, data}\SpecialCharTok{$}\NormalTok{y), , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{  \},}
  \AttributeTok{required\_aes =} \FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{)}
\NormalTok{)}

\NormalTok{stat\_chull }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{mapping =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{data =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{,}
                       \AttributeTok{position =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{show.legend =} \ConstantTok{NA}\NormalTok{,}
                       \AttributeTok{inherit.aes =} \ConstantTok{TRUE}\NormalTok{, ...) \{}
  \FunctionTok{layer}\NormalTok{(}
    \AttributeTok{stat =}\NormalTok{ StatChull, }\AttributeTok{data =}\NormalTok{ data, }\AttributeTok{mapping =}\NormalTok{ mapping, }\AttributeTok{geom =}\NormalTok{ geom,}
    \AttributeTok{position =}\NormalTok{ position, }\AttributeTok{show.legend =}\NormalTok{ show.legend, }\AttributeTok{inherit.aes =}\NormalTok{ inherit.aes,}
    \AttributeTok{params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{na.rm =}\NormalTok{ na.rm, ...)}
\NormalTok{  )}
\NormalTok{\}}

\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(displ, hwy)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{stat\_chull}\NormalTok{(}\AttributeTok{fill =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(displ, hwy, }\AttributeTok{colour =}\NormalTok{ drv)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{stat\_chull}\NormalTok{(}\AttributeTok{fill =} \ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-fit}{%
\subsection{拟合图}\label{sec-ggplot2-fit}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xx }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{9}\SpecialCharTok{:}\DecValTok{9}
\NormalTok{yy }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{abs}\NormalTok{(xx))}
\FunctionTok{plot}\NormalTok{(xx, yy,}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x),}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{abs}\NormalTok{(x)))}
\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{spline}\NormalTok{(xx, yy, }\AttributeTok{n =} \DecValTok{101}\NormalTok{, }\AttributeTok{method =} \StringTok{"fmm"}\NormalTok{, }\AttributeTok{ties =}\NormalTok{ mean), }\AttributeTok{col =} \StringTok{"pink"}\NormalTok{)}

\NormalTok{myspline }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(formula, data, ...) \{}
\NormalTok{  dat }\OtherTok{\textless{}{-}} \FunctionTok{model.frame}\NormalTok{(formula, data)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{splinefun}\NormalTok{(dat[[}\DecValTok{2}\NormalTok{]], dat[[}\DecValTok{1}\NormalTok{]])}
  \FunctionTok{class}\NormalTok{(res) }\OtherTok{\textless{}{-}} \StringTok{"myspline"}
\NormalTok{  res}
\NormalTok{\}}

\NormalTok{predict.myspline }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(object, newdata, ...) \{}
  \FunctionTok{object}\NormalTok{(newdata[[}\DecValTok{1}\NormalTok{]])}
\NormalTok{\}}

\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{9}\SpecialCharTok{:}\DecValTok{9}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{y =} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{abs}\NormalTok{(x))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{stat\_smooth}\NormalTok{(}\AttributeTok{method =}\NormalTok{ myspline, }\AttributeTok{formula =}\NormalTok{ y}\SpecialCharTok{\textasciitilde{}}\NormalTok{x, }\AttributeTok{se =}\NormalTok{ F, }\AttributeTok{color =} \StringTok{"pink"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \FunctionTok{expression}\NormalTok{(x), }\AttributeTok{y =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{abs}\NormalTok{(x)))) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/spline-fun-1} \includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/spline-fun-2} 

}

\caption{自定义样条函数}\label{fig:spline-fun}
\end{figure}

下面以真实数据集 trees 为例，介绍 \texttt{geom\_smooth()} 支持的拟合方法，比如 \texttt{"lm"} 线性回归和 \texttt{"nls"} 非线性回归

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trees, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{log}\NormalTok{(Girth), }\AttributeTok{y =} \FunctionTok{log}\NormalTok{(Volume))) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{se =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(trees, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Girth, }\AttributeTok{y =}\NormalTok{ Volume)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}
    \AttributeTok{method =} \StringTok{"nls"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ a }\SpecialCharTok{*}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ b, }\AttributeTok{se =}\NormalTok{ F,}
    \AttributeTok{method.args =} \FunctionTok{list}\NormalTok{(}\AttributeTok{start =} \FunctionTok{list}\NormalTok{(}\AttributeTok{a =} \DecValTok{5}\NormalTok{, }\AttributeTok{b =} \SpecialCharTok{{-}}\DecValTok{36}\NormalTok{))}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/smooth-methods-1} \includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/smooth-methods-2} 

}

\caption{平滑方法}\label{fig:smooth-methods}
\end{figure}

\hypertarget{sec-ggplot2-raster}{%
\subsection{地形图}\label{sec-ggplot2-raster}}

区域之间以轮廓分割，轮廓之间以相同的颜色填充，Cleveland 把这个叫做 level plot， \textbf{lattice} 包中 \texttt{levelplot()} 函数正来源于此。

\href{https://en.wikipedia.org/wiki/Maungawhau}{Auckland's Maunga Whau Volcano} 是火山喷发后留下的碴堆，位于新西兰奥克兰伊甸山郊区。\href{https://www.stat.auckland.ac.nz/~ihaka/}{Ross Ihaka} 收集了它的地形数据，命名为 volcano，打包在 R 软件环境中，见图 \ref{fig:elevation-volcano}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{color.palette =}\NormalTok{ terrain.colors,}
  \AttributeTok{plot.title =} \FunctionTok{title}\NormalTok{(}
    \AttributeTok{main =} \StringTok{"The Topography of Maunga Whau"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"Meters North"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Meters West"}
\NormalTok{  ),}
  \AttributeTok{plot.axes =}\NormalTok{ \{}
    \FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{800}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{))}
    \FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{600}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{))}
\NormalTok{  \},}
  \AttributeTok{key.title =} \FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Height}\SpecialCharTok{\textbackslash{}n}\StringTok{(meters)"}\NormalTok{),}
  \AttributeTok{key.axes =} \FunctionTok{axis}\NormalTok{(}\DecValTok{4}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{190}\NormalTok{, }\AttributeTok{by =} \DecValTok{10}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/elevation-volcano-1} 

}

\caption{image 图形}\label{fig:elevation-volcano}
\end{figure}

美国西南部犹他州锡安国家公园的高程珊格数据 elevation，该数据集由 \href{https://nowosad.github.io/}{Jakub Nowosad} 收集于 \href{https://github.com/Nowosad/spDataLarge}{spDataLarge} 包内，由于该 R 包收集的地理信息数据很多又很大，超出了 CRAN 对 R 包的大小限制，需要从作者制作的 drat 站点下载。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"spDataLarge"}\NormalTok{, }\AttributeTok{repos =} \StringTok{"https://nowosad.github.io/drat/"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

elevation 数据集通过雷达地形测绘 SRTM (Shuttle Radar Topography Mission) 获得，其分辨率为 90m \(\times\) 90m，属于高精度地形网格数据，更多细节描述见 \url{http://srtm.csi.cgiar.org/}，图 \ref{fig:elevation-zion} 将公园的地形清晰地展示出来了，读者不妨再借助维基百科词条 (\url{https://en.wikipedia.org/wiki/Zion_National_Park}) 从整体上了解该公园的情况，结合丰富的实景图可以获得更加直观的感受。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"elevation"}\NormalTok{, }\AttributeTok{package =} \StringTok{"spDataLarge"}\NormalTok{)}
\NormalTok{raster}\SpecialCharTok{::}\FunctionTok{plot}\NormalTok{(elevation, }\AttributeTok{asp =} \ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/elevation-zion-1} 

}

\caption{锡安国家公园的高程珊格数据}\label{fig:elevation-zion}
\end{figure}

\hypertarget{sec-ggplot2-treemap}{%
\subsection{树状图}\label{sec-ggplot2-treemap}}

数据集 GNI2014 来自 \href{https://github.com/mtennekes/treemap}{\textbf{treemap}} 包，是一个 data.frame 类型的数据对象，记录了 2014 年每个国家的人口总数 population 和国民人均收入 GNI，数据样例见下方：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(treemap)}
\FunctionTok{data}\NormalTok{(GNI2014, }\AttributeTok{package =} \StringTok{"treemap"}\NormalTok{)}
\FunctionTok{subset}\NormalTok{(GNI2014, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =}\NormalTok{ country, }\AttributeTok{pattern =} \StringTok{\textquotesingle{}China\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    iso3              country continent population   GNI
## 7   MAC     Macao SAR, China      Asia     559846 76270
## 33  HKG Hong Kong SAR, China      Asia    7061200 40320
## 87  CHN                China      Asia 1338612970  7400
\end{verbatim}

数据呈现明显的层级结构，从大洲到国家记录人口数量和人均收入，矩阵树图以方块大小表示人口数量，以颜色深浅表示人均收入，见图\ref{fig:treemap-grid}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{treemap}\NormalTok{(GNI2014,}
  \AttributeTok{index =} \FunctionTok{c}\NormalTok{(}\StringTok{"continent"}\NormalTok{, }\StringTok{"iso3"}\NormalTok{),}
  \AttributeTok{vSize =} \StringTok{"population"}\NormalTok{, }
  \AttributeTok{vColor =} \StringTok{"GNI"}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"value"}\NormalTok{,}
  \AttributeTok{format.legend =} \FunctionTok{list}\NormalTok{(}\AttributeTok{scientific =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{big.mark =} \StringTok{" "}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/treemap-grid-1} 

}

\caption{矩阵树图}\label{fig:treemap-grid}
\end{figure}

\begin{rmdtip}{提示}

数据集 GNI2014 的另一种呈现方式是将数据铺到地图上，可以借助 \textbf{highcharter} 包的 \texttt{hcmap()} 函数来实现。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 代码块不要启用缓存}
\FunctionTok{data}\NormalTok{(GNI2014, }\AttributeTok{package =} \StringTok{"treemap"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(highcharter)}
\FunctionTok{hcmap}\NormalTok{(}
  \StringTok{"custom/world{-}robinson{-}lowres"}\NormalTok{,}
  \AttributeTok{data =}\NormalTok{ GNI2014,}
  \AttributeTok{name =} \StringTok{"Gross national income per capita"}\NormalTok{,}
  \AttributeTok{value =} \StringTok{"GNI"}\NormalTok{,}
  \AttributeTok{borderWidth =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{nullColor =} \StringTok{"gray"}\NormalTok{,}
  \AttributeTok{joinBy =} \FunctionTok{c}\NormalTok{(}\StringTok{"iso{-}a3"}\NormalTok{, }\StringTok{"iso3"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_colorAxis}\NormalTok{(}
    \AttributeTok{stops =} \FunctionTok{color\_stops}\NormalTok{(}
      \AttributeTok{colors =} \FunctionTok{terrain.colors}\NormalTok{(}\AttributeTok{n =} \DecValTok{10}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{type =} \StringTok{"logarithmic"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\end{rmdtip}

\href{https://github.com/wilkox/treemapify}{\textbf{treemapify}} 包基于 ggplot2 制作树状图，类似地，该 R 包内置了数据集 G20，记录了世界主要经济体 G20 (\url{https://en.wikipedia.org/wiki/G20}) 的经济和人口信息，国家 GDP （单位：百万美元）\texttt{gdp\_mil\_usd} 和人类发展指数 \texttt{hdi}。相比于 GNI2014，它还包含了两列标签信息：经济发展阶段和所处的半球。图@(fig:treemap-ggplot2)以南北半球 hemisphere 分面，以色彩填充区域 region，以 \texttt{gdp\_mil\_usd} 表示区域大小

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(treemapify)}
\FunctionTok{ggplot}\NormalTok{(G20, }\FunctionTok{aes}\NormalTok{(}
  \AttributeTok{area =}\NormalTok{ gdp\_mil\_usd, }\AttributeTok{fill =}\NormalTok{ region,}
  \AttributeTok{label =}\NormalTok{ country, }\AttributeTok{subgroup =}\NormalTok{ region}
\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_treemap}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_treemap\_text}\NormalTok{(}\AttributeTok{grow =}\NormalTok{ T, }\AttributeTok{reflow =}\NormalTok{ T, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{hemisphere) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Set1"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"The G{-}20 major economies by hemisphere"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"The area of each tile represents the country\textquotesingle{}s GDP as a}
\StringTok{      proportion of all countries in that hemisphere"}\NormalTok{,}
    \AttributeTok{fill =} \StringTok{"Region"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/treemap-ggplot2-1} 

}

\caption{世界主要经济体G20的人口和经济信息}\label{fig:treemap-ggplot2}
\end{figure}

\hypertarget{sec-ggplot2-cohort}{%
\subsection{留存图}\label{sec-ggplot2-cohort}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cohort }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{cohort =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\AttributeTok{times =} \DecValTok{5}\SpecialCharTok{:}\DecValTok{1}\NormalTok{),}
  \AttributeTok{week =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(}
    \DecValTok{75}\NormalTok{, }\DecValTok{73}\NormalTok{, }\DecValTok{54}\NormalTok{, }\DecValTok{23}\NormalTok{, }\DecValTok{3}\NormalTok{,}
    \DecValTok{98}\NormalTok{, }\DecValTok{94}\NormalTok{, }\DecValTok{70}\NormalTok{, }\DecValTok{25}\NormalTok{,}
    \DecValTok{52}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{,}
    \DecValTok{44}\NormalTok{, }\DecValTok{15}\NormalTok{,}
    \DecValTok{88}
\NormalTok{  )}
\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(cohort, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ week, }\AttributeTok{y =}\NormalTok{ cohort, }\AttributeTok{fill =}\NormalTok{ value)) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ value), }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_reverse}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_binned}\NormalTok{(}\AttributeTok{type =} \StringTok{"viridis"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/cohort-ggplot2-1} \end{center}

留存是 \href{https://en.wikipedia.org/wiki/Cohort_analysis}{Cohort 分析} 中的一种情况，还有转化等，首先 定义你的问题，确定度量问题的指标，确定和问题相关的 Cohort （比如时间、空间和用户属性等关键的影响因素），然后数据处理、可视化获得 Cohort 分析结果，最后在实际决策和行动中检验分析结论。

\hypertarget{sec-ggplot2-waterfall}{%
\subsection{瀑布图}\label{sec-ggplot2-waterfall}}

瀑布图 waterfall 与上月相比，谁增谁减，用瀑布图分别表示占比和绝对数值。\href{https://vita.had.co.nz/papers/ggplot2-wires.pdf}{瀑布图 waterfall}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balance }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{event =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Starting}\SpecialCharTok{\textbackslash{}n}\StringTok{Cash"}\NormalTok{, }\StringTok{"Sales"}\NormalTok{, }\StringTok{"Refunds"}\NormalTok{,}
    \StringTok{"Payouts"}\NormalTok{, }\StringTok{"Court}\SpecialCharTok{\textbackslash{}n}\StringTok{Losses"}\NormalTok{, }\StringTok{"Court}\SpecialCharTok{\textbackslash{}n}\StringTok{Wins"}\NormalTok{, }\StringTok{"Contracts"}\NormalTok{, }\StringTok{"End}\SpecialCharTok{\textbackslash{}n}\StringTok{Cash"}
\NormalTok{  ),}
  \AttributeTok{change =} \FunctionTok{c}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\DecValTok{3400}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1100}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{6600}\NormalTok{, }\DecValTok{3800}\NormalTok{, }\DecValTok{1400}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{2800}\NormalTok{)}
\NormalTok{)}

\NormalTok{balance}\SpecialCharTok{$}\NormalTok{balance }\OtherTok{\textless{}{-}} \FunctionTok{cumsum}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, balance}\SpecialCharTok{$}\NormalTok{change[}\SpecialCharTok{{-}}\FunctionTok{nrow}\NormalTok{(balance)])) }\CommentTok{\# 累计值}
\NormalTok{balance}\SpecialCharTok{$}\NormalTok{time }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(balance)}
\NormalTok{balance}\SpecialCharTok{$}\NormalTok{flow }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}\FunctionTok{sign}\NormalTok{(balance}\SpecialCharTok{$}\NormalTok{change)) }\CommentTok{\# 变化为正还是为负}

\FunctionTok{ggplot}\NormalTok{(balance) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{colour =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_rect}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{xmin =}\NormalTok{ time }\SpecialCharTok{{-}} \FloatTok{0.45}\NormalTok{, }\AttributeTok{xmax =}\NormalTok{ time }\SpecialCharTok{+} \FloatTok{0.45}\NormalTok{,}
    \AttributeTok{ymin =}\NormalTok{ balance, }\AttributeTok{ymax =}\NormalTok{ balance }\SpecialCharTok{+}\NormalTok{ change, }\AttributeTok{fill =}\NormalTok{ flow}
\NormalTok{  )) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ time,}
    \AttributeTok{y =} \FunctionTok{pmin}\NormalTok{(balance, balance }\SpecialCharTok{+}\NormalTok{ change) }\SpecialCharTok{{-}} \DecValTok{50}\NormalTok{,}
    \AttributeTok{label =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{dollar}\NormalTok{(change)}
\NormalTok{  ),}
  \AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{vjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{name =} \StringTok{""}\NormalTok{,}
    \AttributeTok{breaks =}\NormalTok{ balance}\SpecialCharTok{$}\NormalTok{time,}
    \AttributeTok{labels =}\NormalTok{ balance}\SpecialCharTok{$}\NormalTok{event}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{name =} \StringTok{"Balance"}\NormalTok{,}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{dollar}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/waterfall-1} 

}

\caption{瀑布图}\label{fig:waterfall}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\CommentTok{\# AtherEnergy/ggTimeSeries}
\CommentTok{\# 个人收入，国家地区收入}
\FunctionTok{library}\NormalTok{(ggTimeSeries) }\CommentTok{\# https://github.com/AtherEnergy/ggTimeSeries}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{year =} \DecValTok{2000}\SpecialCharTok{:}\DecValTok{2021}\NormalTok{, }\AttributeTok{dpc =} \DecValTok{10}\SpecialCharTok{:}\DecValTok{31}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ year, }\AttributeTok{y =}\NormalTok{ dpc)) }\SpecialCharTok{+}
  \FunctionTok{stat\_waterfall}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-sankey}{%
\subsection{桑基图}\label{sec-ggplot2-sankey}}

\href{https://github.com/corybrunson/ggalluvial}{ggalluvial}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{titanic\_wide }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(Titanic)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(titanic\_wide)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Class    Sex   Age Survived Freq
## 1   1st   Male Child       No    0
## 2   2nd   Male Child       No    0
## 3   3rd   Male Child       No   35
## 4  Crew   Male Child       No    0
## 5   1st Female Child       No    0
## 6   2nd Female Child       No    0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggalluvial)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ titanic\_wide,}
       \FunctionTok{aes}\NormalTok{(}\AttributeTok{axis1 =}\NormalTok{ Class, }\AttributeTok{axis2 =}\NormalTok{ Sex, }\AttributeTok{axis3 =}\NormalTok{ Age,}
           \AttributeTok{y =}\NormalTok{ Freq)) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_discrete}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\StringTok{"Class"}\NormalTok{, }\StringTok{"Sex"}\NormalTok{, }\StringTok{"Age"}\NormalTok{), }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(.}\DecValTok{2}\NormalTok{, .}\DecValTok{05}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Demographic"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_alluvium}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ Survived)) }\SpecialCharTok{+}
  \FunctionTok{geom\_stratum}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{stat =} \StringTok{"stratum"}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{after\_stat}\NormalTok{(stratum))) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"passengers on the maiden voyage of the Titanic"}\NormalTok{,}
          \StringTok{"stratified by demographics and survival"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/ggalluvial-1} 

}

\caption{桑基图}\label{fig:ggalluvial}
\end{figure}

\hypertarget{ggplot2-wordcloud}{%
\subsection{词云图}\label{ggplot2-wordcloud}}

词云 \href{https://github.com/lepennec/ggwordcloud}{ggwordcloud}

\hypertarget{ggplot2-gantt}{%
\subsection{甘特图}\label{ggplot2-gantt}}

描述项目进展的甘特图 \href{https://github.com/giocomai/ganttrify}{ganttrify}

\hypertarget{sec-ggplot2-ggmosaic}{%
\subsection{马赛克图}\label{sec-ggplot2-ggmosaic}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggmosaic)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{as.data.frame}\NormalTok{(UCBAdmissions)) }\SpecialCharTok{+}
  \FunctionTok{geom\_mosaic}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{weight =}\NormalTok{ Freq, }\AttributeTok{x =} \FunctionTok{product}\NormalTok{(Gender, Admit), }\AttributeTok{fill =}\NormalTok{ Dept)) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Admit"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Gender"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/ucb-admissions-1} 

}

\caption{UCBAdmissions 马赛克图}\label{fig:ucb-admissions}
\end{figure}

\hypertarget{sec-ggplot2-bump}{%
\subsection{凹凸图}\label{sec-ggplot2-bump}}

\href{https://github.com/davidsjoberg/ggbump}{ggbump} 排序随位置的变化

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# remotes::install\_github("davidsjoberg/ggbump")}
\FunctionTok{library}\NormalTok{(ggbump)}
\CommentTok{\# 代码修改自 https://github.com/davidsjoberg/ggbump}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{season =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Spring"}\NormalTok{, }\StringTok{"Pre{-}season"}\NormalTok{, }\StringTok{"Summer"}\NormalTok{, }\StringTok{"Season finale"}\NormalTok{, }\StringTok{"Autumn"}\NormalTok{, }\StringTok{"Winter"}\NormalTok{,}
    \StringTok{"Spring"}\NormalTok{, }\StringTok{"Pre{-}season"}\NormalTok{, }\StringTok{"Summer"}\NormalTok{, }\StringTok{"Season finale"}\NormalTok{, }\StringTok{"Autumn"}\NormalTok{, }\StringTok{"Winter"}\NormalTok{,}
    \StringTok{"Spring"}\NormalTok{, }\StringTok{"Pre{-}season"}\NormalTok{, }\StringTok{"Summer"}\NormalTok{, }\StringTok{"Season finale"}\NormalTok{, }\StringTok{"Autumn"}\NormalTok{, }\StringTok{"Winter"}\NormalTok{,}
    \StringTok{"Spring"}\NormalTok{, }\StringTok{"Pre{-}season"}\NormalTok{, }\StringTok{"Summer"}\NormalTok{, }\StringTok{"Season finale"}\NormalTok{, }\StringTok{"Autumn"}\NormalTok{, }\StringTok{"Winter"}
\NormalTok{  ),}
  \AttributeTok{rank =} \FunctionTok{c}\NormalTok{(}
    \DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{,}
    \DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{,}
    \DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{,}
    \DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}
\NormalTok{  ),}
  \AttributeTok{player =} \FunctionTok{c}\NormalTok{(}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"David"}\NormalTok{, }\DecValTok{6}\NormalTok{),}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"Anna"}\NormalTok{, }\DecValTok{6}\NormalTok{),}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"Franz"}\NormalTok{, }\DecValTok{6}\NormalTok{),}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"Ika"}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}

\CommentTok{\# Create factors and order factor}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(df, }\AttributeTok{season =} \FunctionTok{factor}\NormalTok{(season, }\AttributeTok{levels =} \FunctionTok{unique}\NormalTok{(season)))}

\CommentTok{\# Add manual axis labels to plot}
\FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(season, rank, }\AttributeTok{color =}\NormalTok{ player)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bump}\NormalTok{(}\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{smooth =} \DecValTok{20}\NormalTok{, }\AttributeTok{show.legend =}\NormalTok{ F) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{shape =}\NormalTok{ player)) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \DecValTok{10}\NormalTok{, }\AttributeTok{base\_line\_size =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ RColorBrewer}\SpecialCharTok{::}\FunctionTok{brewer.pal}\NormalTok{(}\AttributeTok{name =} \StringTok{"Set2"}\NormalTok{, }\AttributeTok{n =} \DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group

## Warning in f(...): 'StatBump' needs at least two observations per group
\end{verbatim}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/ggbump-1} 

}

\caption{凹凸图}\label{fig:ggbump}
\end{figure}

\hypertarget{sec-ggplot2-streamgraph}{%
\subsection{水流图}\label{sec-ggplot2-streamgraph}}

常用于时间序列数据展示的堆积区域图，\href{https://github.com/davidsjoberg/ggstream}{ggstream} 和 \href{https://github.com/hrbrmstr/streamgraph}{streamgraph}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggstream)}

\FunctionTok{ggplot}\NormalTok{(blockbusters, }\FunctionTok{aes}\NormalTok{(year, box\_office, }\AttributeTok{fill =}\NormalTok{ genre)) }\SpecialCharTok{+}
  \FunctionTok{geom\_stream}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/stream-graph-1} 

}

\caption{堆积区域图}\label{fig:stream-graph}
\end{figure}

\hypertarget{sec-ggplot2-vistime}{%
\subsection{时间线}\label{sec-ggplot2-vistime}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 交互动态图 https://github.com/shosaco/vistime}
\CommentTok{\# 刘思喆 2018 数据科学的时间轴 https://bjt.name/2018/11/18/timeline.html}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}
  \FunctionTok{textConnection}\NormalTok{(}\StringTok{"}
\StringTok{The Future of Data Analysis,1962}
\StringTok{Relational Database,1970}
\StringTok{Data science(Peter Naur),1974}
\StringTok{Two{-}Way Communication,1975}
\StringTok{Exploratory Data Analysis,1977}
\StringTok{Business Intelligence,1989}
\StringTok{The First Database Report,1992}
\StringTok{The World Wide Web Explodes,1995}
\StringTok{Data Mining and Knowledge Discovery,1997}
\StringTok{S(ACM Software System Award),1998}
\StringTok{Statistical Modeling: The Two Cultures,2001}
\StringTok{Hadoop,2006}
\StringTok{Data scientist,2008}
\StringTok{NOSQL,2009}
\StringTok{Deep Learning,2015}
\StringTok{"}\NormalTok{),}
  \AttributeTok{sep =} \StringTok{","}
\NormalTok{)}
\FunctionTok{names}\NormalTok{(x) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Event"}\NormalTok{, }\StringTok{"EventDate"}\NormalTok{)}
\NormalTok{x}\SpecialCharTok{$}\NormalTok{EventDate }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{paste}\NormalTok{(x}\SpecialCharTok{$}\NormalTok{EventDate, }\StringTok{"/01/01"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{))}

\FunctionTok{library}\NormalTok{(timelineS)}
\FunctionTok{timelineS}\NormalTok{(x,}
  \AttributeTok{labels =} \FunctionTok{paste}\NormalTok{(x[[}\DecValTok{1}\NormalTok{]], }\FunctionTok{format}\NormalTok{(x[[}\DecValTok{2}\NormalTok{]], }\StringTok{"\%Y"}\NormalTok{)),}
  \AttributeTok{line.color =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{label.angle =} \DecValTok{15}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/vis-timeline-1} 

}

\caption{数据科学的时间轴}\label{fig:vis-timeline}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(timeline)}
\FunctionTok{data}\NormalTok{(ww2, }\AttributeTok{package =} \StringTok{\textquotesingle{}timeline\textquotesingle{}}\NormalTok{)}
\FunctionTok{timeline}\NormalTok{(ww2, ww2.events, }\AttributeTok{event.spots=}\DecValTok{2}\NormalTok{, }\AttributeTok{event.label=}\StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{, }\AttributeTok{event.above=}\ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 适合放在动态幻灯片}
\CommentTok{\# 美团风格的写轮眼}
\CommentTok{\# 时间线}
\FunctionTok{library}\NormalTok{(vistime)}
\CommentTok{\# presidents and vice presidents}
\NormalTok{pres }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Position =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"President"}\NormalTok{, }\StringTok{"Vice"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{),}
  \AttributeTok{Name =} \FunctionTok{c}\NormalTok{(}\StringTok{"Washington"}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Adams"}\NormalTok{, }\StringTok{"Jefferson"}\NormalTok{), }\DecValTok{2}\NormalTok{), }\StringTok{"Burr"}\NormalTok{),}
  \AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\StringTok{"1789{-}03{-}29"}\NormalTok{, }\StringTok{"1797{-}02{-}03"}\NormalTok{, }\StringTok{"1801{-}02{-}03"}\NormalTok{),}
  \AttributeTok{end =} \FunctionTok{c}\NormalTok{(}\StringTok{"1797{-}02{-}03"}\NormalTok{, }\StringTok{"1801{-}02{-}03"}\NormalTok{, }\StringTok{"1809{-}02{-}03"}\NormalTok{),}
  \AttributeTok{color =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#cbb69d"}\NormalTok{, }\StringTok{"\#603913"}\NormalTok{, }\StringTok{"\#c69c6e"}\NormalTok{)}
\NormalTok{)}

\FunctionTok{hc\_vistime}\NormalTok{(pres, }\AttributeTok{col.event =} \StringTok{"Position"}\NormalTok{, }\AttributeTok{col.group =} \StringTok{"Name"}\NormalTok{, }
           \AttributeTok{title =} \StringTok{"Presidents of the USA"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-ternary}{%
\subsection{三元图}\label{sec-ggplot2-ternary}}

\href{https://github.com/ms609/Ternary/}{Ternary} 使用基础图形库，而 \href{https://bitbucket.org/nicholasehamilton/ggtern}{ggtern} 使用 ggplot2 绘制

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggtern)}
\FunctionTok{library}\NormalTok{(ggalt)}
\FunctionTok{data}\NormalTok{(}\StringTok{"Fragments"}\NormalTok{)}
\FunctionTok{ggtern}\NormalTok{(Fragments, }\FunctionTok{aes}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ Qm, }\AttributeTok{y =}\NormalTok{ Qp, }\AttributeTok{z =}\NormalTok{ Rf }\SpecialCharTok{+}\NormalTok{ M,}
  \AttributeTok{fill =}\NormalTok{ GrainSize, }\AttributeTok{shape =}\NormalTok{ GrainSize}
\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_encircle}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Example Plot"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"using geom\_encircle"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_legend\_position}\NormalTok{(}\StringTok{"tr"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-eisenhower}{%
\subsection{四象限图}\label{sec-ggplot2-eisenhower}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{perc =} \FunctionTok{c}\NormalTok{(}\DecValTok{54}\NormalTok{, }\DecValTok{18}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{),}
  \AttributeTok{wall\_policy =} \FunctionTok{c}\NormalTok{(}\StringTok{"oppose"}\NormalTok{, }\StringTok{"favor"}\NormalTok{, }\StringTok{"oppose"}\NormalTok{, }\StringTok{"favor"}\NormalTok{),}
  \AttributeTok{dreamer\_policy =} \FunctionTok{c}\NormalTok{(}\StringTok{"favor"}\NormalTok{, }\StringTok{"favor"}\NormalTok{, }\StringTok{"oppose"}\NormalTok{, }\StringTok{"oppose"}\NormalTok{),}
  \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{xmin =} \FunctionTok{ifelse}\NormalTok{(wall\_policy }\SpecialCharTok{==} \StringTok{"oppose"}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{sqrt}\NormalTok{(perc), }\DecValTok{0}\NormalTok{),}
    \AttributeTok{xmax =} \FunctionTok{ifelse}\NormalTok{(wall\_policy }\SpecialCharTok{==} \StringTok{"favor"}\NormalTok{, }\FunctionTok{sqrt}\NormalTok{(perc), }\DecValTok{0}\NormalTok{),}
    \AttributeTok{ymin =} \FunctionTok{ifelse}\NormalTok{(dreamer\_policy }\SpecialCharTok{==} \StringTok{"oppose"}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{sqrt}\NormalTok{(perc), }\DecValTok{0}\NormalTok{),}
    \AttributeTok{ymax =} \FunctionTok{ifelse}\NormalTok{(dreamer\_policy }\SpecialCharTok{==} \StringTok{"favor"}\NormalTok{, }\FunctionTok{sqrt}\NormalTok{(perc), }\DecValTok{0}\NormalTok{)}
\NormalTok{  )}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{+}
  \FunctionTok{geom\_rect}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{xmin =}\NormalTok{ xmin, }\AttributeTok{xmax =}\NormalTok{ xmax,}
    \AttributeTok{ymin =}\NormalTok{ ymin, }\AttributeTok{ymax =}\NormalTok{ ymax}
\NormalTok{  ), }\AttributeTok{fill =} \StringTok{"grey"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ xmin }\SpecialCharTok{+} \FloatTok{0.5} \SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(perc),}
    \AttributeTok{y =}\NormalTok{ ymin }\SpecialCharTok{+} \FloatTok{0.5} \SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(perc),}
    \AttributeTok{label =}\NormalTok{ perc}
\NormalTok{  ),}
  \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{coord\_equal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{title =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/eisenhower-1} 

}

\caption{四象限图}\label{fig:eisenhower}
\end{figure}

\hypertarget{sec-ggplot2-venn}{%
\subsection{韦恩图}\label{sec-ggplot2-venn}}

\href{https://github.com/gaospecial/ggVennDiagram}{ggVennDiagram}

\hypertarget{sec-ggplot2-tornado}{%
\subsection{龙卷风图}\label{sec-ggplot2-tornado}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{variable =} \FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{),}
  \AttributeTok{Level =} \FunctionTok{c}\NormalTok{(}\StringTok{"Top{-}2"}\NormalTok{, }\StringTok{"Top{-}2"}\NormalTok{, }\StringTok{"Bottom{-}2"}\NormalTok{, }\StringTok{"Bottom{-}2"}\NormalTok{),}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(.}\DecValTok{8}\NormalTok{, .}\DecValTok{7}\NormalTok{, }\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{3}\NormalTok{)}
\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ variable, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{fill =}\NormalTok{ Level)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ abs) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/tornado-ggplot2-1} 

}

\caption{龙卷风图展示变量重要性}\label{fig:tornado-ggplot2}
\end{figure}

\href{https://en.wikipedia.org/wiki/Tornado_diagram}{Tornado diagram} 主要用于敏感性分析，比较不同变量的重要性程度。条形图 \texttt{geom\_bar()} 图层的变体，模型权重可视化的手段，仅限于广义线性模型。

\hypertarget{sec-ggplot2-hclust}{%
\subsection{聚类图}\label{sec-ggplot2-hclust}}

ggdendro 的 \texttt{dendro\_data()} 函数支持 \texttt{tree} 、\texttt{hclust} 、\texttt{dendrogram} 和 \texttt{rpart} 结果的整理，进而绘图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggdendro)}
\NormalTok{hc }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(USArrests), }\StringTok{"ave"}\NormalTok{)}
\NormalTok{hcdata }\OtherTok{\textless{}{-}} \FunctionTok{dendro\_data}\NormalTok{(hc, }\AttributeTok{type =} \StringTok{"rectangle"}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =} \FunctionTok{segment}\NormalTok{(hcdata), }
               \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{xend =}\NormalTok{ xend, }\AttributeTok{yend =}\NormalTok{ yend)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =} \FunctionTok{label}\NormalTok{(hcdata), }
            \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{label =}\NormalTok{ label, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{), }
            \AttributeTok{size =} \DecValTok{3}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_reverse}\NormalTok{(}\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-70-1} \end{center}

\hypertarget{sec-ggplot2-prcomp}{%
\subsection{主成分图}\label{sec-ggplot2-prcomp}}

借助 \href{https://github.com/terrytangyuan/autoplotly}{\textbf{autoplotly}} 包 \citep{autoplotly} 可将函数 \texttt{stats::prcomp} 生成的结果转化为交互图形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pca }\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(iris[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{)])}
\FunctionTok{plot}\NormalTok{(pca)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/pac-plot-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(autoplotly)}
\FunctionTok{autoplotly}\NormalTok{(pca,}
  \AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{colour =} \StringTok{"Species"}\NormalTok{,}
  \AttributeTok{label =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{label.size =} \DecValTok{3}\NormalTok{, }\AttributeTok{frame =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/sinhrks/ggfortify}{\textbf{ggfortify}} \citep{Tang_2016_ggfortify} 包将主成分分析图转化为静态图形

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggfortify)}
\FunctionTok{autoplot}\NormalTok{(pca, }\AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{colour =} \StringTok{\textquotesingle{}Species\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/pca-ggplot2-1} 

}

\caption{主成分分析}\label{fig:pca-ggplot2}
\end{figure}

\hypertarget{sec-ggplot2-composite}{%
\subsection{组合图}\label{sec-ggplot2-composite}}

组合的意思是将不同种类的图形绘制在一个区域中，比如密度曲线和地毯图\footnote{其实是轴须图 rug plot，只因样子看起来像铺在地上的毛毯，故而称之为地毯图，对应于 R 内置的 \texttt{rug()} 函数或 ggplot2 提供的图层 \texttt{geom\_rug()}，更多解释详见 \url{https://en.wikipedia.org/wiki/Rug_plot}。}组合。 \href{https://github.com/ggobi/ggally}{\textbf{GGally}}、 \href{https://github.com/const-ae/ggupset}{\textbf{ggupset}}、 \href{https://github.com/thomas-neitmann/ggcharts}{ggcharts} 和 \href{https://github.com/kassambara/ggpubr}{\textbf{ggpubr}} 高度定制了一些组合统计图形，以 ggpubr 为例，见图 \ref{fig:ggpubr-composite}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggpubr)}
\FunctionTok{ggdensity}\NormalTok{(sleep,}
  \AttributeTok{x =} \StringTok{"extra"}\NormalTok{, }\AttributeTok{add =} \StringTok{"mean"}\NormalTok{, }\AttributeTok{rug =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{color =} \StringTok{"group"}\NormalTok{,}
  \AttributeTok{fill =} \StringTok{"group"}\NormalTok{, }\AttributeTok{palette =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#00AFBB"}\NormalTok{, }\StringTok{"\#E7B800"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/ggpubr-composite-1} 

}

\caption{组合图形}\label{fig:ggpubr-composite}
\end{figure}

上面介绍的都是已经固化的组合方式，一般地，将多个图形组合到一个图中，可以有很多办法，比如 Claus Wilke 开发的 \href{https://github.com/wilkelab/cowplot}{\textbf{cowplot}} ，在他的书里 \href{http://serialmentor.com/dataviz}{Fundamentals of Data Visualization} 大量使用，后起之秀 \href{https://github.com/thomasp85/patchwork}{\textbf{patchwork}} 则提供更加简洁的组合语法，非常受欢迎，更加底层的拼接方法可以去看 \href{https://msg-book.netlify.app/tricks.html\#sec-multipage}{一页多图} 和 R 内置的 grid 系统。

\hypertarget{sec-ggplot2-animation}{%
\subsection{动态图}\label{sec-ggplot2-animation}}

\href{https://github.com/ropensci/av}{\textbf{av}} 包基于 \href{https://github.com/FFmpeg/FFmpeg}{FFmpeg} 将静态图片合成视频，而 \href{https://github.com/r-rust/gifski/}{\textbf{gifski}} 包基于 \href{https://gif.ski/}{gifski} 将静态图片合成 GIF 动画，\href{https://github.com/yihui/animation}{\textbf{animation}} 包 \citep{Xie_2013_animation} 将 Base R 绘制的图形转化为动画或视频，\href{https://github.com/leonawicz/mapmate}{mapmate} 制作地图相关的三维可视化图形，\href{https://github.com/thomasp85/gganimate}{\textbf{gganimate}} 包支持将 ggplot2 生成的图形，\textbf{magick} 可以将一系列静态图形合成动态图形，借助 \textbf{gifski} 包转化为动态图片或视频。推荐读者从 \href{https://github.com/ropenscilabs/learngganimate}{gganimate 案例合集} 开始制作动态图形。 \href{https://r-forge.r-project.org/projects/rgl/}{\textbf{rgl}} 可以制作真三维动态图形，支持缩放、拖拽、旋转等操作， \href{https://github.com/tylermorganwall/rayshader}{\textbf{rayshader}} 还支持转化 ggplot2 对象为 3D 图形。

数据集 Indometh 记录了药物在人体中的代谢情况，给 6 个人分别静脉注射了吲哚美辛，每隔一段时间抽血检查药物在血浆中的浓度，收集的数据见表 \ref{tab:indometh-data}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(Indometh, }\AttributeTok{v.names =} \StringTok{"conc"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"Subject"}\NormalTok{, }
        \AttributeTok{timevar =} \StringTok{"time"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(.,}
    \AttributeTok{caption =} \StringTok{"吲哚美辛在人体中的代谢情况"}\NormalTok{,}
    \AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col.names =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(conc)"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{names}\NormalTok{(.)),}
    \AttributeTok{align =} \StringTok{"c"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:indometh-data}吲哚美辛在人体中的代谢情况}
\centering
\begin{tabular}[t]{c|c|c|c|c|c|c|c|c|c|c|c}
\hline
Subject & 0.25 & 0.5 & 0.75 & 1 & 1.25 & 2 & 3 & 4 & 5 & 6 & 8\\
\hline
1 & 1.50 & 0.94 & 0.78 & 0.48 & 0.37 & 0.19 & 0.12 & 0.11 & 0.08 & 0.07 & 0.05\\
\hline
2 & 2.03 & 1.63 & 0.71 & 0.70 & 0.64 & 0.36 & 0.32 & 0.20 & 0.25 & 0.12 & 0.08\\
\hline
3 & 2.72 & 1.49 & 1.16 & 0.80 & 0.80 & 0.39 & 0.22 & 0.12 & 0.11 & 0.08 & 0.08\\
\hline
4 & 1.85 & 1.39 & 1.02 & 0.89 & 0.59 & 0.40 & 0.16 & 0.11 & 0.10 & 0.07 & 0.07\\
\hline
5 & 2.05 & 1.04 & 0.81 & 0.39 & 0.30 & 0.23 & 0.13 & 0.11 & 0.08 & 0.10 & 0.06\\
\hline
6 & 2.31 & 1.44 & 1.03 & 0.84 & 0.64 & 0.42 & 0.24 & 0.17 & 0.13 & 0.10 & 0.09\\
\hline
\end{tabular}
\end{table}

如图 \ref{fig:indometh-concentration} 所示，药物在人体中浓度变化情况

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ Indometh,}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ time, }\AttributeTok{y =}\NormalTok{ conc, }\AttributeTok{color =}\NormalTok{ Subject)}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"time (hr)"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"plasma concentrations of indometacin (mcg/ml)"}
\NormalTok{  )}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/indometh-concentration-1} 

}

\caption{药物在人体中的代谢情况}\label{fig:indometh-concentration}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gganimate)}
\NormalTok{p }\SpecialCharTok{+} \FunctionTok{transition\_reveal}\NormalTok{(time)}
\end{Highlighting}
\end{Shaded}

\begin{center}\animategraphics[,controls,loop]{10}{data-visualization_files/figure-latex/indometh-animate-}{1}{100}\end{center}

\begin{rmdtip}{提示}
书籍目标输出格式是 PDF，则在代码块选项设置里必须指定参数 \texttt{fig.show=\textquotesingle{}animate\textquotesingle{}} 否则插入的只是图片而不是动画， 目标格式是 HTML 网页， 就不必指定参数，默认会将图片合成 GIF 动态图，嵌入 PDF 里面的动画需要 Acrobat Reader 阅读器才能正确地显示。

\end{rmdtip}

动态图形制作的原理，简单来说，就是将一帧帧静态图形以较快的速度播放，人眼形成视觉残留，以为是连续的画面，相比于 animation， \textbf{gganimate} 借助 \textbf{tweenr} 包添加了过渡效果，动态图形显得非常自然。下面以 cup 函数\footnote{函数来自余光创的博客 --- \href{https://guangchuangyu.github.io/cn/2017/09/3d-breast/}{3D 版邪恶的曲线} ，此处借用 gganimate 将其动态化，前方高能，少儿不宜，R 还能这么不正经的玩。}为例

\[f(x;\theta,\phi) = \theta x\log(x)-\frac{1}{\phi}\mathit{e}^{-\phi^4(x-\frac{1}{\mathit{e}})^4}, \quad \theta \in (2,3), \phi \in (30,50), x \in (0,1)\] 函数图像随着 \(\theta\) 和 \(\phi\) 的变化情况见图 \ref{fig:cup-curve}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tweenr)}
\NormalTok{cup\_curve }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{theta =} \DecValTok{3}\NormalTok{, }\AttributeTok{phi =} \DecValTok{30}\NormalTok{, }\AttributeTok{cup =} \StringTok{"A"}\NormalTok{) \{}
  \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.00001}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =}\NormalTok{ n), }\AttributeTok{cup =}\NormalTok{ cup) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{transform}\NormalTok{(}\AttributeTok{y =}\NormalTok{ theta }\SpecialCharTok{*}\NormalTok{ x }\SpecialCharTok{*} \FunctionTok{log}\NormalTok{(x, }\AttributeTok{base =} \DecValTok{10}\NormalTok{) }
              \SpecialCharTok{{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ phi }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(phi }\SpecialCharTok{*}\NormalTok{ x }\SpecialCharTok{{-}}\NormalTok{ phi }\SpecialCharTok{/} \FunctionTok{exp}\NormalTok{(}\DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
\NormalTok{\}}
\FunctionTok{mapply}\NormalTok{(}
  \AttributeTok{FUN =}\NormalTok{ cup\_curve, }\AttributeTok{theta =} \FunctionTok{c}\NormalTok{(}\AttributeTok{E =} \DecValTok{3}\NormalTok{, }\AttributeTok{D =} \FloatTok{2.8}\NormalTok{, }\AttributeTok{C =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{B =} \FloatTok{2.2}\NormalTok{, }\AttributeTok{A =} \DecValTok{2}\NormalTok{),}
  \AttributeTok{phi =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{33}\NormalTok{, }\DecValTok{36}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{cup =} \FunctionTok{c}\NormalTok{(}\StringTok{"E"}\NormalTok{, }\StringTok{"D"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"A"}\NormalTok{),}
  \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{n =} \DecValTok{50}\NormalTok{), }\AttributeTok{SIMPLIFY =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{USE.NAMES =} \ConstantTok{TRUE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tween\_states}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ .,}
    \AttributeTok{tweenlength =} \DecValTok{2}\NormalTok{, }\AttributeTok{statelength =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{ease =} \FunctionTok{rep}\NormalTok{(}\StringTok{"cubic{-}in{-}out"}\NormalTok{, }\DecValTok{4}\NormalTok{), }\AttributeTok{nframes =} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ., }\FunctionTok{aes}\NormalTok{(x, y, }\AttributeTok{color =}\NormalTok{ cup, }\AttributeTok{frame =}\NormalTok{ .frame)) }\SpecialCharTok{+}
  \FunctionTok{geom\_path}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_void}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/cup-curve-1} 

}

\caption{添加过渡效果}\label{fig:cup-curve}
\end{figure}

\hypertarget{chap-interactive-web-graphics}{%
\chapter{交互图形}\label{chap-interactive-web-graphics}}

\begin{rmdtip}{提示}
plotly 包的函数使用起来还是比较复杂的，特别是需要打磨细节以打造数据产品时，此外，其依赖相当重，仅数据处理就包含两套方法 --- dplyr 和 data.table，引起很多函数冲突，可谓「苦其久矣」！因此，准备另起炉灶，开发一个新的 R 包 qplotly，取意 quick plotly，以 \texttt{qplot\_ly()} 替代 \texttt{plot\_ly()}。类似简化 API 的工作有 \href{https://github.com/StatisticsNZ/simplevis}{simplevis}、 \href{https://github.com/terrytangyuan/autoplotly}{autoplotly}、 \href{https://github.com/sinhrks/ggfortify}{ggfortify} 和 \href{https://github.com/yogevherz/plotme}{plotme}。

plotly 团队开发了 \href{https://github.com/plotly/plotly.js}{plotly.js} 库，且维护了 R 接口文档 (\url{https://plotly.com/r/})，Carson Sievert 开发了 \href{https://github.com/ropensci/plotly}{plotly} 包，配套书 \href{https://plotly-r.com/}{Interactive web-based data visualization with R, plotly, and shiny}。 Paul C. Bauer 的书 \href{https://bookdown.org/paul/applied-data-visualization/}{Applied Data Visualization} 介绍 plotly \url{https://bookdown.org/paul/applied-data-visualization/what-is-plotly.html}

\end{rmdtip}

\href{https://github.com/JohnCoene/echarts4r}{echarts4r} 包基于 \href{https://github.com/apache/incubator-echarts}{Apache ECharts (incubating)}，ECharts 的 Python 接口 \href{https://github.com/pyecharts/pyecharts}{pyecharts} 也非常受欢迎，基于 \href{https://github.com/apexcharts/apexcharts.js}{apexcharts.js} 的 \href{https://github.com/dreamRs/apexcharter}{apexcharter}。 \href{https://github.com/XD-DENG/ECharts2Shiny}{ECharts2Shiny} 包将 ECharts 嵌入 shiny 框架中。

\href{https://github.com/daattali/timevis}{timevis} 创建交互式的时间线的时序可视化，它基于 \href{https://visjs.org/}{Vis} 的 \href{https://github.com/visjs/vis-timeline}{vis-timeline} 模块，支持 shiny 集成。\href{https://github.com/rstudio/dygraphs}{dygraphs} 包基于 \href{https://github.com/danvk/dygraphs}{dygraphs} 可视化库，将时序数据可视化，更多情况见 \url{https://dygraphs.com/}。\href{https://github.com/rstudio/leaflet}{leaflet} 提供 \href{https://leafletjs.com/}{leaflet} 的 R 接口。\href{https://github.com/stla/rAmCharts4}{rAmCharts4} 基于 \href{https://github.com/amcharts/amcharts4/}{amCharts 4} 库， \href{https://github.com/dreamRs/apexcharter}{apexcharter} 提供 \href{https://github.com/apexcharts/apexcharts.js}{apexcharts.js} 的 R 接口。还有 \href{https://github.com/dreamRs/billboarder}{billboarder} 等。更完整地，请看 Etienne Bacher 维护的 R 包列表 \href{https://github.com/etiennebacher/r-js-adaptation}{r-js-adaptation} 。

对于想了解 htmlwidgets 框架，JavaScript 响应式编程的读者，推荐 John Coene 新书 \href{https://book.javascript-for-r.com/}{JavaScript for R}

\begin{rmdtip}{提示}
学习 \href{https://github.com/ropensci/plotly}{plotly} 和 \href{https://github.com/jbkunst/highcharter}{highcharter} 为代表的 基于 JavaScript 的 R 包，共有四重境界：第一重是照着帮助文档的示例，示例有啥我们做啥；第二重是明白帮助文档中 R 函数和 JavaScript 函数的对应关系，能力达到 JS 库的功能边界；第三重是深度自定义一些扩展性的 JS 功能，放飞自我；第四重是重新造轮子，为所欲为。下面的介绍希望能帮助读者到达第二重境界。

\end{rmdtip}

\href{https://github.com/ropensci/plotly}{plotly} 是一个功能非常强大的绘制交互式图形的 R 包。它支持下载图片、添加水印、自定义背景图片、工具栏和注释\footnote{\url{https://plotly.com/r/reference/\#layout-scene-annotations-items-annotation-font}} 等一系列细节的自定义控制。下面结合 JavaScript 库 \href{https://github.com/plotly/plotly.js}{plotly.js} 一起介绍，帮助文档 \texttt{?config} 没有太详细地介绍，所以我们看看 \texttt{config()} 函数中参数 \texttt{...} 和 JavaScript 库 \href{https://github.com/plotly/plotly.js/blob/master/src/plot_api/plot_config.js}{plot\_config.js} 中的功能函数是怎么对应的。图 中图片下载按钮对应 \texttt{toImageButtonOptions} 参数， 看 \href{https://github.com/plotly/plotly.js/blob/master/src/plot_api/plot_config.js\#L311}{toImageButtonOptions} 源代码，可知，它接受任意数据类型，对应到 R 里面就是列表。 \texttt{watermark} 和 \texttt{displaylogo} 都是传递布尔值（TRUE/FALSE），具体根据 JavaScript 代码中的 valType （参数值类型）决定，其它参数类似。另一个函数 \href{https://plot.ly/r/reference/\#Layout_and_layout_style_objects}{layout} 和函数 \texttt{config()} 是类似的，怎么传递参数值是根据 JavaScript 代码来的。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{toImageButtonOptions}\OperatorTok{:}\NormalTok{ \{}
    \DataTypeTok{valType}\OperatorTok{:} \StringTok{\textquotesingle{}any\textquotesingle{}}\OperatorTok{,}
    \DataTypeTok{dflt}\OperatorTok{:}\NormalTok{ \{\}}\OperatorTok{,}
    \DataTypeTok{description}\OperatorTok{:}\NormalTok{ [}
        \StringTok{\textquotesingle{}Statically override options for toImage modebar button\textquotesingle{}}\OperatorTok{,}
        \StringTok{\textquotesingle{}allowed keys are format, filename, width, height, scale\textquotesingle{}}\OperatorTok{,}
        \StringTok{\textquotesingle{}see ../components/modebar/buttons.js\textquotesingle{}}
\NormalTok{    ]}\OperatorTok{.}\FunctionTok{join}\NormalTok{(}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\NormalTok{\}}\OperatorTok{,}
\NormalTok{displaylogo}\OperatorTok{:}\NormalTok{ \{}
    \DataTypeTok{valType}\OperatorTok{:} \StringTok{\textquotesingle{}boolean\textquotesingle{}}\OperatorTok{,}
    \DataTypeTok{dflt}\OperatorTok{:} \KeywordTok{true}\OperatorTok{,}
    \DataTypeTok{description}\OperatorTok{:}\NormalTok{ [}
        \StringTok{\textquotesingle{}Determines whether or not the plotly logo is displayed\textquotesingle{}}\OperatorTok{,}
        \StringTok{\textquotesingle{}on the end of the mode bar.\textquotesingle{}}
\NormalTok{    ]}\OperatorTok{.}\FunctionTok{join}\NormalTok{(}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\NormalTok{\}}\OperatorTok{,}
\NormalTok{watermark}\OperatorTok{:}\NormalTok{ \{}
    \DataTypeTok{valType}\OperatorTok{:} \StringTok{\textquotesingle{}boolean\textquotesingle{}}\OperatorTok{,}
    \DataTypeTok{dflt}\OperatorTok{:} \KeywordTok{false}\OperatorTok{,}
    \DataTypeTok{description}\OperatorTok{:} \StringTok{\textquotesingle{}watermark the images with the company}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{s logo\textquotesingle{}}
\NormalTok{\}}\OperatorTok{,}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(plotly, }\AttributeTok{warn.conflicts =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{price,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{colors =} \StringTok{"Set1"}\NormalTok{, }\AttributeTok{type =} \StringTok{"box"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{toImageButtonOptions =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{format =} \StringTok{"svg"}\NormalTok{, }\AttributeTok{width =} \DecValTok{450}\NormalTok{, }\AttributeTok{height =} \DecValTok{300}\NormalTok{,}
      \AttributeTok{filename =} \FunctionTok{paste}\NormalTok{(}\StringTok{"plot"}\NormalTok{, }\FunctionTok{Sys.Date}\NormalTok{(), }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{)}
\NormalTok{    ), }
    \AttributeTok{modeBarButtons =} \FunctionTok{list}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\StringTok{"toImage"}\NormalTok{)),}
    \AttributeTok{watermark =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{displaylogo =} \ConstantTok{FALSE}\NormalTok{, }
    \AttributeTok{locale =} \StringTok{"zh{-}CN"}\NormalTok{, }
    \AttributeTok{staticPlot =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{showLink =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{modeBarButtonsToRemove =} \FunctionTok{c}\NormalTok{(}
      \StringTok{"hoverClosestCartesian"}\NormalTok{, }\StringTok{"hoverCompareCartesian"}\NormalTok{, }
      \StringTok{"zoom2d"}\NormalTok{, }\StringTok{"zoomIn2d"}\NormalTok{, }\StringTok{"zoomOut2d"}\NormalTok{, }
      \StringTok{"autoScale2d"}\NormalTok{, }\StringTok{"resetScale2d"}\NormalTok{, }\StringTok{"pan2d"}\NormalTok{,}
      \StringTok{"toggleSpikelines"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{template =} \StringTok{"plotly\_dark"}\NormalTok{,}
    \AttributeTok{images =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{source =} \StringTok{"https://images.plot.ly/language{-}icons/api{-}home/r{-}logo.png"}\NormalTok{,}
      \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{,}
      \AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
      \AttributeTok{x =} \FloatTok{1.00}\NormalTok{,}
      \AttributeTok{y =} \FloatTok{0.25}\NormalTok{,}
      \AttributeTok{sizex =} \FloatTok{0.2}\NormalTok{,}
      \AttributeTok{sizey =} \FloatTok{0.2}\NormalTok{,}
      \AttributeTok{opacity =} \FloatTok{0.5}
\NormalTok{    ),}
    \AttributeTok{annotations =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{text =} \StringTok{"DRAFT"}\NormalTok{,               }\CommentTok{\# 水印文本}
      \AttributeTok{textangle =} \SpecialCharTok{{-}}\DecValTok{30}\NormalTok{,              }\CommentTok{\# 逆时针旋转 30 度}
      \AttributeTok{font =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{size =} \DecValTok{40}\NormalTok{,                  }\CommentTok{\# 字号}
        \AttributeTok{color =} \StringTok{"gray"}\NormalTok{,             }\CommentTok{\# 颜色}
        \AttributeTok{family =} \StringTok{"Times New Roman"}  \CommentTok{\# 字族}
\NormalTok{      ),}
      \AttributeTok{opacity =} \FloatTok{0.2}\NormalTok{,                }\CommentTok{\# 透明度}
      \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{,}
      \AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
      \AttributeTok{x =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{y =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{showarrow =} \ConstantTok{FALSE}             \CommentTok{\# 去掉箭头指示}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:plotly-config} 交互图形的设置函数 \texttt{config()} 各个参数及其作用（部分）}\tabularnewline
\toprule
参数 & 作用 \\
\midrule
\endfirsthead
\toprule
参数 & 作用 \\
\midrule
\endhead
displayModeBar & 是否显示交互图形上的工具条，默认显示 \texttt{TRUE}\footnote{\url{https://plotly-r.com/control-modebar.html}。}。 \\
modeBarButtons & 工具条上保留的工具，如下载 \texttt{"toImage"}，缩放 \texttt{"zoom2d"}\footnote{完整的列表见 \url{https://github.com/plotly/plotly.js/blob/master/src/components/modebar/buttons.js}。}。 \\
modeBarButtonsToRemove & 工具条上要移除的工具，如下载和缩放图片 \texttt{c("toImage",\ "zoom2d")}。 \\
toImageButtonOptions & 工具条上下载图片的选项设置，包括名称、类型、尺寸等。\footnote{设置下载图片的尺寸，还可设置为 PNG 格式，SVG 格式图片，可借助 \textbf{rsvg} 的 \texttt{rsvg\_pdf()} 函数转化为 PDF 格式 \url{https://github.com/ropensci/plotly/issues/1556\#issuecomment-505833092}。} \\
displaylogo & 是否交显示互图形上 Plotly 的图标，默认显示 \texttt{TRUE}\footnote{\url{https://plotly.com/r/logos/}。}。 \\
staticPlot & 是否将交互图形转为静态图形，默认 \texttt{FALSE}。 \\
locale & 本土化语言设置，比如 \texttt{"zh-CN"} 表示中文。 \\
\bottomrule
\end{longtable}

\hypertarget{sec-plotly-scatter}{%
\section{散点图}\label{sec-plotly-scatter}}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:plotly-scatter-functions} 散点图类型}\tabularnewline
\toprule
类型 & 名称 \\
\midrule
\endfirsthead
\toprule
类型 & 名称 \\
\midrule
\endhead
\texttt{scattercarpet} & 地毯图 \\
\texttt{scatterternary} & 三元图 \\
\texttt{scatter3d} & 三维散点图 \\
\texttt{scattergeo} & 地图散点图 \\
\texttt{scattermapbox} & 地图散点图 Mapbox \\
\texttt{scatter} & 散点图 \\
\texttt{scattergl} & 散点图 GL \\
\texttt{scatterpolar} & 极坐标散点图 \\
\texttt{scatterpolargl} & 极坐标散点图 GL \\
\bottomrule
\end{longtable}

plotly.js 提供很多图层用于绘制各类图形 \url{https://github.com/plotly/plotly.js/tree/master/src/traces}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 折线图}
\FunctionTok{plot\_ly}\NormalTok{(Orange,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{age, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{circumference, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Tree,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-barplot}{%
\section{条形图}\label{sec-plotly-barplot}}

日常使用最多的图形无外乎散点图、柱形图（分组、堆积、百分比堆积等）

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 简单条形图}
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{diamonds }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(diamonds)}

\NormalTok{p11 }\OtherTok{\textless{}{-}}\NormalTok{ diamonds[, .(}\AttributeTok{cnt =}\NormalTok{ .N), by }\OtherTok{=}\NormalTok{ .(cut)] }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cnt, }\AttributeTok{type =} \StringTok{"bar"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_text}\NormalTok{(}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{comma}\NormalTok{(cnt), }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cnt,}
    \AttributeTok{textposition =} \StringTok{"top middle"}\NormalTok{,}
    \AttributeTok{cliponaxis =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{showlegend =} \ConstantTok{FALSE}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =}\NormalTok{ F)}

\CommentTok{\# 分组条形图}
\NormalTok{p12 }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Accent"}\NormalTok{, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =}\NormalTok{ F)}

\CommentTok{\# 堆积条形图}
\NormalTok{p13 }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Accent"}\NormalTok{, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{barmode =} \StringTok{"stack"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =}\NormalTok{ F)}

\CommentTok{\# 百分比堆积条形图}
\CommentTok{\# p14 \textless{}{-} plot\_ly(diamonds,}
\CommentTok{\#   x = \textasciitilde{}cut, color = \textasciitilde{}clarity,}
\CommentTok{\#   colors = "Accent", type = "histogram"}
\CommentTok{\# ) \%\textgreater{}\%}
\CommentTok{\#   layout(barmode = "stack", barnorm = "percent") \%\textgreater{}\%}
\CommentTok{\#   config(displayModeBar = F)}

\CommentTok{\# 推荐使用如下方式绘制堆积条形图}
\NormalTok{dat }\OtherTok{=}\NormalTok{ diamonds[, .(}\AttributeTok{cnt =} \FunctionTok{length}\NormalTok{(carat)), by }\OtherTok{=}\NormalTok{ .(clarity, cut)] }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  .[, pct }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{round}\NormalTok{(}\DecValTok{100} \SpecialCharTok{*}\NormalTok{ cnt }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(cnt), }\DecValTok{2}\NormalTok{), by }\OtherTok{=}\NormalTok{ .(cut)]}

\NormalTok{p14 }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{pct, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Set3"}\NormalTok{, }\AttributeTok{type =} \StringTok{"bar"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{barmode =} \StringTok{"stack"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =}\NormalTok{ F)}

\NormalTok{htmltools}\SpecialCharTok{::}\FunctionTok{tagList}\NormalTok{(p11, p12, p13, p14)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-lineplot}{%
\section{折线图}\label{sec-plotly-lineplot}}

其它常见的图形还要折线图、直方图、箱线图和提琴图

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 折线图}
\FunctionTok{plot\_ly}\NormalTok{(Orange,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{age, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{circumference, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Tree,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers+lines"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-multiple-y-axes}{%
\section{双轴图}\label{sec-multiple-y-axes}}

\href{https://plotly.com/r/multiple-axes/}{双轴图}

模拟一组数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{dt =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020{-}01{-}01"}\NormalTok{), }\AttributeTok{to =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020{-}01{-}31"}\NormalTok{), }\AttributeTok{by =} \StringTok{"day"}\NormalTok{),}
  \AttributeTok{search\_qv =} \FunctionTok{sample}\NormalTok{(}\DecValTok{100000}\SpecialCharTok{:}\DecValTok{1000000}\NormalTok{, }\AttributeTok{size =} \DecValTok{31}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{valid\_click\_qv =} \FunctionTok{sapply}\NormalTok{(search\_qv, rbinom, }\AttributeTok{n =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.5}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{qv\_ctr =}\NormalTok{ valid\_click\_qv }\SpecialCharTok{/}\NormalTok{ search\_qv)}
\end{Highlighting}
\end{Shaded}

\texttt{hoverinfo\ =\ "text"} 表示 tooltips 使用指定的 text 映射，而 \texttt{visible\ =\ "legendonly"} 表示图层默认隐藏不展示，只在图例里显示，有时候很多条线，默认只是展示几条而已。举例如下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_bars}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{dt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{search\_qv, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray80"}\NormalTok{), }\AttributeTok{name =} \StringTok{"搜索 QV"}\NormalTok{,}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
      \StringTok{"日期："}\NormalTok{, dt, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"点击 QV："}\NormalTok{, }\FunctionTok{format}\NormalTok{(valid\_click\_qv, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"搜索 QV："}\NormalTok{, }\FunctionTok{format}\NormalTok{(search\_qv, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"QV\_CTR："}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(qv\_ctr, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}
\NormalTok{    ),}
    \AttributeTok{hoverinfo =} \StringTok{"text"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_bars}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{dt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{valid\_click\_qv, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray60"}\NormalTok{), }\AttributeTok{name =} \StringTok{"点击 QV"}\NormalTok{,}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
      \StringTok{"日期："}\NormalTok{, dt, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"点击 QV："}\NormalTok{, }\FunctionTok{format}\NormalTok{(valid\_click\_qv, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"搜索 QV："}\NormalTok{, }\FunctionTok{format}\NormalTok{(search\_qv, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"QV\_CTR："}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(qv\_ctr, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}
\NormalTok{    ), }\AttributeTok{visible =} \StringTok{"legendonly"}\NormalTok{,}
    \AttributeTok{hoverinfo =} \StringTok{"text"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_lines}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{dt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{qv\_ctr, }\AttributeTok{name =} \StringTok{"QV\_CTR"}\NormalTok{, }\AttributeTok{yaxis =} \StringTok{"y2"}\NormalTok{, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray40"}\NormalTok{),}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste}\NormalTok{(}\StringTok{"QV\_CTR："}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(qv\_ctr, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{), }
    \AttributeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \StringTok{"spline"}\NormalTok{, }\AttributeTok{width =} \DecValTok{3}\NormalTok{, }\AttributeTok{dash =} \StringTok{"line"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{""}\NormalTok{,}
    \AttributeTok{yaxis2 =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{tickfont =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
      \AttributeTok{overlaying =} \StringTok{"y"}\NormalTok{,}
      \AttributeTok{side =} \StringTok{"right"}\NormalTok{,}
      \AttributeTok{title =} \StringTok{"QV\_CTR（\%）"}\NormalTok{,}
      \CommentTok{\# ticksuffix = "\%", \# 设置坐标轴单位}
      \AttributeTok{tickformat =} \StringTok{\textquotesingle{}.1\%\textquotesingle{}}\NormalTok{, }\CommentTok{\# 设置坐标轴刻度}
      \AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{automargin =} \ConstantTok{TRUE}
\NormalTok{    ),}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"日期"}\NormalTok{, }\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{showline =}\NormalTok{ F),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{" "}\NormalTok{, }\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{showline =}\NormalTok{ F),}
    \AttributeTok{margin =} \FunctionTok{list}\NormalTok{(}\AttributeTok{r =} \DecValTok{20}\NormalTok{, }\AttributeTok{autoexpand =}\NormalTok{ T),}
    \AttributeTok{legend =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\NormalTok{, }\AttributeTok{orientation =} \StringTok{"h"}\NormalTok{,}
      \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{" "}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =}\NormalTok{ F)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-histogram}{%
\section{直方图}\label{sec-plotly-histogram}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Sepal.Length, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Species, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-boxplot}{%
\section{箱线图}\label{sec-plotly-boxplot}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 箱线图}
\FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{price, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{type =} \StringTok{"box"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-violin}{%
\section{提琴图}\label{sec-plotly-violin}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(sleep,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{group, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{extra, }\AttributeTok{split =} \SpecialCharTok{\textasciitilde{}}\NormalTok{group,}
  \AttributeTok{type =} \StringTok{"violin"}\NormalTok{,}
  \AttributeTok{box =} \FunctionTok{list}\NormalTok{(}\AttributeTok{visible =}\NormalTok{ T),}
  \AttributeTok{meanline =} \FunctionTok{list}\NormalTok{(}\AttributeTok{visible =}\NormalTok{ T)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

plotly 包含图层 27 种，见表 \ref{tab:add-layer}

\begin{table}

\caption{\label{tab:add-layer}图层}
\centering
\begin{tabular}[t]{l|l|l}
\hline
A & B & C\\
\hline
add\_annotations & add\_histogram & add\_polygons\\
\hline
add\_area & add\_histogram2d & add\_ribbons\\
\hline
add\_bars & add\_histogram2dcontour & add\_scattergeo\\
\hline
add\_boxplot & add\_image & add\_segments\\
\hline
add\_choropleth & add\_lines & add\_sf\\
\hline
add\_contour & add\_markers & add\_surface\\
\hline
add\_data & add\_mesh & add\_table\\
\hline
add\_fun & add\_paths & add\_text\\
\hline
add\_heatmap & add\_pie & add\_trace\\
\hline
\end{tabular}
\end{table}

\hypertarget{sec-plotly-bubble}{%
\section{气泡图}\label{sec-plotly-bubble}}

简单图形 scatter，分布图几类，其中 scatter、heatmap、scatterpolar 支持 WebGL 绘图引擎

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://plotly.com/r/bubble{-}charts/}
\NormalTok{dat }\OtherTok{\textless{}{-}}\NormalTok{ diamonds[, .(}
  \AttributeTok{carat =} \FunctionTok{mean}\NormalTok{(carat),}
  \AttributeTok{price =} \FunctionTok{sum}\NormalTok{(price), }
  \AttributeTok{cnt =}\NormalTok{ .N}
\NormalTok{), by }\OtherTok{=}\NormalTok{ .(cut)]}

\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{carat, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{price, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{size =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cnt,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers"}\NormalTok{,}
  \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{symbol =} \StringTok{"circle"}\NormalTok{, }\AttributeTok{sizemode =} \StringTok{"diameter"}\NormalTok{,}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{width =} \DecValTok{2}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#FFFFFF"}\NormalTok{), }\AttributeTok{opacity =} \FloatTok{0.4}
\NormalTok{  ),}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste}\NormalTok{(}
    \AttributeTok{sep =} \StringTok{" "}\NormalTok{, }\StringTok{"重量："}\NormalTok{, }\FunctionTok{round}\NormalTok{(carat, }\DecValTok{2}\NormalTok{), }\StringTok{"克拉"}\NormalTok{,}
    \StringTok{"\textless{}br\textgreater{}价格:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(price }\SpecialCharTok{/} \DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{6}\NormalTok{, }\DecValTok{2}\NormalTok{), }\StringTok{"百万"}
\NormalTok{  ),}
  \AttributeTok{hoverinfo =} \StringTok{\textquotesingle{}text\textquotesingle{}}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_annotations}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{carat, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{price, }\AttributeTok{text =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cnt,}
    \AttributeTok{showarrow =}\NormalTok{ F, }\AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{family =} \StringTok{"sans"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{hoverformat =} \StringTok{".2f"}\NormalTok{),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{hoverformat =} \StringTok{".0f"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =}\NormalTok{ F)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-spline}{%
\section{曲线图}\label{sec-plotly-spline}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{2.2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\FloatTok{5.3}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{), }
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray40"}\NormalTok{), }
  \AttributeTok{mode =} \StringTok{"markers+lines"}\NormalTok{, }\AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \StringTok{"spline"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_annotations}\NormalTok{(}
    \AttributeTok{x =} \DecValTok{2}\NormalTok{, }\AttributeTok{y =} \DecValTok{6}\NormalTok{, }\AttributeTok{size =} \FunctionTok{I}\NormalTok{(}\DecValTok{100}\NormalTok{),}
    \AttributeTok{text =} \FunctionTok{TeX}\NormalTok{(}\StringTok{"x\_i }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{sim N(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mu, }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{sigma)"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{title =} \FunctionTok{TeX}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mu"}\NormalTok{)),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{title =} \FunctionTok{TeX}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{alpha"}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{mathjax =} \StringTok{\textquotesingle{}cdn\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-tozeroy}{%
\section{堆积图}\label{sec-plotly-tozeroy}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{weight,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{group, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \StringTok{"spline"}\NormalTok{),}
  \AttributeTok{mode =} \StringTok{"lines"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"tozeroy"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-heatmap}{%
\section{热力图}\label{sec-plotly-heatmap}}

其他基础图形

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{z =}\NormalTok{ volcano, }\AttributeTok{type =} \StringTok{\textquotesingle{}heatmap\textquotesingle{}}\NormalTok{, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-map}{%
\section{地图 I}\label{sec-plotly-map}}

\texttt{plot\_mapbox()} 使用 Mapbox 提供的地图服务，因此，需要注册一个账户，获取 MAPBOX\_TOKEN

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"quakes"}\NormalTok{)}
\FunctionTok{plot\_mapbox}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ quakes, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{lon =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag, }\AttributeTok{size =} \DecValTok{2}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"scattermapbox"}\NormalTok{, }
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{,}
  \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{opacity =} \FloatTok{0.5}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Fiji Earthquake"}\NormalTok{,}
    \AttributeTok{mapbox =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{zoom =} \DecValTok{3}\NormalTok{,}
      \AttributeTok{center =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{median}\NormalTok{(lat }\SpecialCharTok{{-}} \DecValTok{5}\NormalTok{),}
        \AttributeTok{lon =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{median}\NormalTok{(long)}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{mapboxAccessToken =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"MAPBOX\_TOKEN"}\NormalTok{),}
    \AttributeTok{displayModeBar =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ quakes,}
  \AttributeTok{lon =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat,}
  \AttributeTok{type =} \StringTok{"scattergeo"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers"}\NormalTok{,}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
    \StringTok{"站点："}\NormalTok{, stations, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
    \StringTok{"震级："}\NormalTok{, mag}
\NormalTok{  ),}
  \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag, }
    \AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{opacity =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{width =} \DecValTok{1}\NormalTok{)}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{geo =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{showland =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{landcolor =} \FunctionTok{toRGB}\NormalTok{(}\StringTok{"gray95"}\NormalTok{),}
    \AttributeTok{subunitcolor =} \FunctionTok{toRGB}\NormalTok{(}\StringTok{"gray85"}\NormalTok{),}
    \AttributeTok{countrycolor =} \FunctionTok{toRGB}\NormalTok{(}\StringTok{"gray85"}\NormalTok{),}
    \AttributeTok{countrywidth =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{subunitwidth =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{lonaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{showgrid =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{gridwidth =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\DecValTok{160}\NormalTok{, }\DecValTok{190}\NormalTok{),}
      \AttributeTok{dtick =} \DecValTok{5}
\NormalTok{    ),}
    \AttributeTok{lataxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{showgrid =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{gridwidth =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{40}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{),}
      \AttributeTok{dtick =} \DecValTok{5}
\NormalTok{    )}
\NormalTok{  )) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{displayModeBar =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{=} \FunctionTok{data.frame}\NormalTok{(state.x77, }\AttributeTok{stats =} \FunctionTok{rownames}\NormalTok{(state.x77), }\AttributeTok{stats\_abbr =}\NormalTok{ state.abb)}
\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat,}
  \AttributeTok{type =} \StringTok{"choropleth"}\NormalTok{,}
  \AttributeTok{locations =} \SpecialCharTok{\textasciitilde{}}\NormalTok{stats\_abbr,}
  \AttributeTok{locationmode =} \StringTok{"USA{-}states"}\NormalTok{,}
  \AttributeTok{colorscale =} \StringTok{"Greys"}\NormalTok{, }
  \AttributeTok{z =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Income}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{geo =} \FunctionTok{list}\NormalTok{(}\AttributeTok{scope =} \StringTok{"usa"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-fitted}{%
\section{拟合图}\label{sec-plotly-fitted}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(economics,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{date,}
  \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{uempmed,}
  \AttributeTok{name =} \StringTok{"observed unemployment"}\NormalTok{,}
  \AttributeTok{mode =} \StringTok{"markers+lines"}\NormalTok{,}
  \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{color =} \StringTok{"red"}
\NormalTok{  ),}
  \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{color =} \StringTok{"red"}\NormalTok{,}
    \AttributeTok{dash =} \StringTok{"dashed"}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{date,}
    \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\FunctionTok{fitted}\NormalTok{(}\FunctionTok{loess}\NormalTok{(uempmed }\SpecialCharTok{\textasciitilde{}} \FunctionTok{as.numeric}\NormalTok{(date))),}
    \AttributeTok{name =} \StringTok{"fitted unemployment"}\NormalTok{,}
    \AttributeTok{mode =} \StringTok{"markers+lines"}\NormalTok{,}
    \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{color =} \StringTok{"orange"}
\NormalTok{    ),}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{color =} \StringTok{"orange"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"失业时间"}\NormalTok{,}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{title =} \StringTok{"日期"}\NormalTok{,}
      \AttributeTok{showgrid =}\NormalTok{ F}
\NormalTok{    ),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{title =} \StringTok{"失业时间（周）"}
\NormalTok{    ),}
    \AttributeTok{legend =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\NormalTok{, }\AttributeTok{orientation =} \StringTok{"v"}\NormalTok{,}
      \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{""}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-rasterly}{%
\section{轨迹图}\label{sec-plotly-rasterly}}

\href{https://github.com/plotly/rasterly}{rasterly} 百万量级的散点图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rasterly)}
\FunctionTok{plot\_ly}\NormalTok{(quakes, }\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_rasterly\_heatmap}\NormalTok{()}

\NormalTok{quakes }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rasterly}\NormalTok{(}\AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ long, }\AttributeTok{y =}\NormalTok{ lat)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rasterly\_points}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(plotly)}
\CommentTok{\# 读取数据}
\CommentTok{\# uber 轨迹数据来自 https://github.com/plotly/rasterly}
\NormalTok{ridesDf }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\AttributeTok{file =} \StringTok{\textquotesingle{}data/uber.rds\textquotesingle{}}\NormalTok{)}

\NormalTok{ridesDf }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rasterly}\NormalTok{(}\AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Lat, }\AttributeTok{y =}\NormalTok{ Lon)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rasterly\_points}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=5.19in]{screenshots/rasterly-rides} 

}

\caption{轨迹数据}\label{fig:uber-rides}
\end{figure}

\hypertarget{sec-plotly-3d}{%
\section{三维图 (plotly)}\label{sec-plotly-3d}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{z =} \SpecialCharTok{\textasciitilde{}}\NormalTok{volcano) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_surface}\NormalTok{()}

\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{z =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_mesh}\NormalTok{()}

\CommentTok{\# https://plot.ly/r/reference/\#scatter3d}
\FunctionTok{transform}\NormalTok{(mtcars, }\AttributeTok{am =} \FunctionTok{ifelse}\NormalTok{(am }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\StringTok{"Automatic"}\NormalTok{, }\StringTok{"Manual"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{wt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{hp, }\AttributeTok{z =} \SpecialCharTok{\textasciitilde{}}\NormalTok{qsec, }
          \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{am, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#BF382A"}\NormalTok{, }\StringTok{"\#0C4B8E"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_markers}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{scene =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"Weight"}\NormalTok{),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"Gross horsepower"}\NormalTok{),}
    \AttributeTok{zaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"1/4 mile time"}\NormalTok{)}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-gantt-charts}{%
\section{甘特图}\label{sec-plotly-gantt-charts}}

项目管理必备，如图所示，本项目拆分成7个任务，一共使用3种项目资源

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://plotly.com/r/gantt/}
\CommentTok{\# 项目拆解为一系列任务，每个任务的开始时间，持续时间和资源类型}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{task =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Task"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{),}
  \AttributeTok{start =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \StringTok{"2016{-}01{-}01"}\NormalTok{, }\StringTok{"2016{-}02{-}20"}\NormalTok{, }\StringTok{"2016{-}01{-}01"}\NormalTok{,}
    \StringTok{"2016{-}04{-}10"}\NormalTok{, }\StringTok{"2016{-}06{-}09"}\NormalTok{, }\StringTok{"2016{-}04{-}10"}\NormalTok{,}
    \StringTok{"2016{-}09{-}07"}\NormalTok{, }\StringTok{"2016{-}11{-}26"}
\NormalTok{  )),}
  \AttributeTok{duration =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{10}\NormalTok{),}
  \AttributeTok{resource =} \FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"B"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{end =}\NormalTok{ start }\SpecialCharTok{+}\NormalTok{ duration) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(.))}

\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_segments}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{start, }\AttributeTok{xend =} \SpecialCharTok{\textasciitilde{}}\NormalTok{end,}
    \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{y, }\AttributeTok{yend =} \SpecialCharTok{\textasciitilde{}}\NormalTok{y,}
    \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{resource,}
    \AttributeTok{mode =} \StringTok{"lines"}\NormalTok{,}
    \AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{, }
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{width =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{showlegend =}\NormalTok{ F,}
    \AttributeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste}\NormalTok{(}
      \StringTok{" 任务: "}\NormalTok{, task, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"启动时间: "}\NormalTok{, start, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"周期: "}\NormalTok{, duration, }\StringTok{"天\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"资源: "}\NormalTok{, resource}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{showgrid =}\NormalTok{ F,}
      \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{""}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{showgrid =}\NormalTok{ F,}
      \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{""}\NormalTok{),}
      \AttributeTok{tickmode =} \StringTok{"array"}\NormalTok{,}
      \AttributeTok{tickvals =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df),}
      \AttributeTok{ticktext =} \FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{task),}
      \AttributeTok{domain =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.9}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{annotations =} \FunctionTok{list}\NormalTok{(}
      \FunctionTok{list}\NormalTok{(}
        \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{, }\AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
        \AttributeTok{x =} \FloatTok{0.80}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.1}\NormalTok{,}
        \AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}
          \StringTok{"项目周期: "}\NormalTok{, }\FunctionTok{sum}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{duration), }\StringTok{" 天\textless{}br\textgreater{}"}\NormalTok{,}
          \StringTok{"资源类型: "}\NormalTok{, }\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{resource)), }\StringTok{" 个\textless{}br\textgreater{}"}
\NormalTok{        ),}
        \AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
        \AttributeTok{ax =} \DecValTok{0}\NormalTok{, }\AttributeTok{ay =} \DecValTok{0}\NormalTok{,}
        \AttributeTok{align =} \StringTok{"left"}
\NormalTok{      ),}
      \FunctionTok{list}\NormalTok{(}
        \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{, }\AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
        \AttributeTok{x =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\NormalTok{,}
        \AttributeTok{xanchor =} \StringTok{"left"}\NormalTok{,}
        \AttributeTok{text =} \StringTok{"项目资源管理"}\NormalTok{,}
        \AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
        \AttributeTok{ax =} \DecValTok{0}\NormalTok{, }\AttributeTok{ay =} \DecValTok{0}\NormalTok{,}
        \AttributeTok{align =} \StringTok{"left"}\NormalTok{,}
        \AttributeTok{showarrow =} \ConstantTok{FALSE}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{displayModeBar =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-pareto-charts}{%
\section{帕雷托图}\label{sec-plotly-pareto-charts}}

\href{https://en.wikipedia.org/wiki/Pareto_chart}{帕雷托图} 20/80 法则

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据来自 https://github.com/plotly/datasets }
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{complaint =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Small portions"}\NormalTok{, }\StringTok{"Overpriced"}\NormalTok{,}
    \StringTok{"Wait time"}\NormalTok{, }\StringTok{"Food is tasteless"}\NormalTok{, }\StringTok{"No atmosphere"}\NormalTok{, }\StringTok{"Not clean"}\NormalTok{,}
    \StringTok{"Too noisy"}\NormalTok{, }\StringTok{"Food is too salty"}\NormalTok{, }\StringTok{"Unfriendly staff"}\NormalTok{, }\StringTok{"Food not fresh"}
\NormalTok{  ),}
  \AttributeTok{count =} \FunctionTok{c}\NormalTok{( 621L, 789L, 109L, 65L, 45L, 30L, 27L, 15L, 12L, 9L)}
\NormalTok{)}

\NormalTok{dat }\OtherTok{\textless{}{-}}\NormalTok{ dat[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{dat}\SpecialCharTok{$}\NormalTok{count), ] }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{cumulative =} \FunctionTok{round}\NormalTok{(}\DecValTok{100} \SpecialCharTok{*} \FunctionTok{cumsum}\NormalTok{(count) }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(count), }\AttributeTok{digits =} \DecValTok{2}\NormalTok{))}

\CommentTok{\# complaint 按 count 降序排列}
\NormalTok{dat}\SpecialCharTok{$}\NormalTok{complaint }\OtherTok{\textless{}{-}} \FunctionTok{reorder}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{complaint, }\AttributeTok{X =}\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{count, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\DecValTok{1}\SpecialCharTok{/}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ x))}

\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_bars}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{complaint, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{count,}
    \AttributeTok{showlegend =}\NormalTok{ F, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray60"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_lines}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{complaint, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cumulative, }\AttributeTok{yaxis =} \StringTok{"y2"}\NormalTok{,}
    \AttributeTok{showlegend =}\NormalTok{ F, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray40"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{yaxis2 =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{tickfont =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
      \AttributeTok{overlaying =} \StringTok{"y"}\NormalTok{,}
      \AttributeTok{side =} \StringTok{"right"}\NormalTok{,}
      \AttributeTok{title =} \StringTok{"累积百分比（\%）"}\NormalTok{,}
      \AttributeTok{showgrid =}\NormalTok{ F}
\NormalTok{    ),}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"投诉类型"}\NormalTok{, }\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{showline =}\NormalTok{ F),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"数量"}\NormalTok{, }\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{showline =}\NormalTok{ F)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{displayModeBar =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{rmdtip}{提示}
\texttt{reorder()} 对 complaint 按照降序还是升序由 FUN 函数的单调性决定，单调增对应升序，单调减对应降序

\end{rmdtip}

\hypertarget{sec-plotly-vistime}{%
\section{时间线}\label{sec-plotly-vistime}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(vistime)}

\NormalTok{pres }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Position =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"President"}\NormalTok{, }\StringTok{"Vice"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{),}
  \AttributeTok{Name =} \FunctionTok{c}\NormalTok{(}\StringTok{"Washington"}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Adams"}\NormalTok{, }\StringTok{"Jefferson"}\NormalTok{), }\DecValTok{2}\NormalTok{), }\StringTok{"Burr"}\NormalTok{),}
  \AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\StringTok{"1789{-}03{-}29"}\NormalTok{, }\StringTok{"1797{-}02{-}03"}\NormalTok{, }\StringTok{"1801{-}02{-}03"}\NormalTok{),}
  \AttributeTok{end =} \FunctionTok{c}\NormalTok{(}\StringTok{"1797{-}02{-}03"}\NormalTok{, }\StringTok{"1801{-}02{-}03"}\NormalTok{, }\StringTok{"1809{-}02{-}03"}\NormalTok{),}
  \AttributeTok{color =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#cbb69d"}\NormalTok{, }\StringTok{"\#603913"}\NormalTok{, }\StringTok{"\#c69c6e"}\NormalTok{),}
  \AttributeTok{fontcolor =} \FunctionTok{c}\NormalTok{(}\StringTok{"black"}\NormalTok{, }\StringTok{"white"}\NormalTok{, }\StringTok{"black"}\NormalTok{)}
\NormalTok{)}

\FunctionTok{vistime}\NormalTok{(pres, }\AttributeTok{col.event =} \StringTok{"Position"}\NormalTok{, }\AttributeTok{col.group =} \StringTok{"Name"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{displayModeBar =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-funnel}{%
\section{漏斗图}\label{sec-plotly-funnel}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{category =} \FunctionTok{c}\NormalTok{(}\StringTok{"访问"}\NormalTok{, }\StringTok{"下载"}\NormalTok{, }\StringTok{"潜客"}\NormalTok{, }\StringTok{"报价"}\NormalTok{, }\StringTok{"下单"}\NormalTok{),}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(}\DecValTok{39}\NormalTok{, }\FloatTok{27.4}\NormalTok{, }\FloatTok{20.6}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{percent =}\NormalTok{ value }\SpecialCharTok{/} \FunctionTok{cumsum}\NormalTok{(value))}

\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{type =} \StringTok{"funnel"}\NormalTok{,}
    \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category,}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{value,}
    \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category, }
    \AttributeTok{colors =} \StringTok{"Set2"}\NormalTok{, }
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(value, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{, }\FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.2f\%\%"}\NormalTok{, }\DecValTok{100}\SpecialCharTok{*}\NormalTok{percent)) ,}
    \AttributeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
    \AttributeTok{showlegend =} \ConstantTok{FALSE}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{categoryarray =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category,}
    \AttributeTok{title =} \StringTok{""}
\NormalTok{  )) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{displayModeBar =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{type =} \StringTok{"funnel"}\NormalTok{,}
    \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category,}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{value,}
    \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =}\NormalTok{ RColorBrewer}\SpecialCharTok{::}\FunctionTok{brewer.pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{5}\NormalTok{, }\AttributeTok{name =} \StringTok{"Set2"}\NormalTok{)),}
    \AttributeTok{textposition =} \StringTok{"auto"}\NormalTok{,}
    \AttributeTok{textinfo =} \StringTok{"value+percent previous"}\NormalTok{,}
    \AttributeTok{hoverinfo =} \StringTok{"none"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}\AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{categoryarray =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category, }\AttributeTok{title =} \StringTok{""}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-radar}{%
\section{雷达图}\label{sec-plotly-radar}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{type =} \StringTok{"scatterpolar"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"toself"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{r =} \FunctionTok{c}\NormalTok{(}\DecValTok{39}\NormalTok{, }\DecValTok{28}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{28}\NormalTok{, }\DecValTok{39}\NormalTok{), }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray40"}\NormalTok{),}
    \AttributeTok{theta =} \FunctionTok{c}\NormalTok{(}\StringTok{"数学"}\NormalTok{, }\StringTok{"物理"}\NormalTok{, }\StringTok{"化学"}\NormalTok{, }\StringTok{"英语"}\NormalTok{, }\StringTok{"生物"}\NormalTok{, }\StringTok{"数学"}\NormalTok{),}
    \AttributeTok{name =} \StringTok{"学生 A"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{r =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{39}\NormalTok{, }\DecValTok{31}\NormalTok{, }\DecValTok{15}\NormalTok{, }\FloatTok{1.5}\NormalTok{), }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray80"}\NormalTok{),}
    \AttributeTok{theta =} \FunctionTok{c}\NormalTok{(}\StringTok{"数学"}\NormalTok{, }\StringTok{"物理"}\NormalTok{, }\StringTok{"化学"}\NormalTok{, }\StringTok{"英语"}\NormalTok{, }\StringTok{"生物"}\NormalTok{, }\StringTok{"数学"}\NormalTok{),}
    \AttributeTok{name =} \StringTok{"学生 B"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{polar =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{radialaxis =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{visible =}\NormalTok{ T,}
        \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{50}\NormalTok{)}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-waterfall}{%
\section{瀑布图}\label{sec-plotly-waterfall}}

盈亏图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(plotly)}
\FunctionTok{library}\NormalTok{(dplyr)}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"销售"}\NormalTok{, }\StringTok{"咨询"}\NormalTok{, }\StringTok{"净收入"}\NormalTok{,}
    \StringTok{"购买"}\NormalTok{, }\StringTok{"其他费用"}\NormalTok{, }\StringTok{"税前利润"}
\NormalTok{  ),}
  \AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{60}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{10}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{40}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{20}\NormalTok{, }\DecValTok{0}\NormalTok{),}
  \AttributeTok{measure =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"relative"}\NormalTok{, }\StringTok{"relative"}\NormalTok{, }\StringTok{"relative"}\NormalTok{,}
    \StringTok{"relative"}\NormalTok{, }\StringTok{"relative"}\NormalTok{, }\StringTok{"total"}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{text =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    y }\SpecialCharTok{\textgreater{}} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"+"}\NormalTok{, y),}
\NormalTok{    y }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \StringTok{""}\NormalTok{,}
\NormalTok{    y }\SpecialCharTok{\textless{}} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{as.character}\NormalTok{(y)}
\NormalTok{  )) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{x =} \FunctionTok{factor}\NormalTok{(x, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"销售"}\NormalTok{, }\StringTok{"咨询"}\NormalTok{, }\StringTok{"净收入"}\NormalTok{,}
    \StringTok{"购买"}\NormalTok{, }\StringTok{"其他费用"}\NormalTok{, }\StringTok{"税前利润"}
\NormalTok{  )))}

\NormalTok{n\_rows }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(dat)}
\NormalTok{dat[}\FunctionTok{nrow}\NormalTok{(dat), }\StringTok{"text"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"累计"}

\CommentTok{\# measure 取值为 \textquotesingle{}relative\textquotesingle{}/\textquotesingle{}total\textquotesingle{}/\textquotesingle{}absolute\textquotesingle{}}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(dat,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{x, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{y, }\AttributeTok{measure =} \SpecialCharTok{\textasciitilde{}}\NormalTok{measure, }\AttributeTok{type =} \StringTok{"waterfall"}\NormalTok{,}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}}\NormalTok{text, }\AttributeTok{textposition =} \StringTok{"outside"}\NormalTok{, }
  \AttributeTok{name =} \StringTok{"收支"}\NormalTok{, }\AttributeTok{hoverinfo =} \StringTok{"final"}\NormalTok{, }
  \AttributeTok{connector =} \FunctionTok{list}\NormalTok{(}\AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"gray"}\NormalTok{)),}
  \AttributeTok{increasing =} \FunctionTok{list}\NormalTok{(}\AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"\#66C2A5"}\NormalTok{)),}
  \AttributeTok{decreasing =} \FunctionTok{list}\NormalTok{(}\AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"\#FC8D62"}\NormalTok{)),}
  \AttributeTok{totals =} \FunctionTok{list}\NormalTok{(}\AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"\#8DA0CB"}\NormalTok{))}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"2018 年收支状态"}\NormalTok{,}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"业务"}\NormalTok{),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"金额"}\NormalTok{),}
    \AttributeTok{showlegend =} \ConstantTok{FALSE}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-treemap}{%
\section{树状图}\label{sec-plotly-treemap}}

plotly 绘制 treemap 和 sunburst 图比较复杂，接口不友好， \href{https://github.com/yogevherz/plotme}{plotme} 正好弥补不足。

\hypertarget{sec-plotly-sunburst}{%
\section{旭日图}\label{sec-plotly-sunburst}}

\href{https://github.com/yogevherz/plotme}{plotme}

\hypertarget{sec-plotly-color-palette}{%
\section{调色板}\label{sec-plotly-color-palette}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Length, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Width,}
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}\NormalTok{,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{6}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#132B43"}\NormalTok{, }\StringTok{"\#56B1F7"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Length, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Width, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{6}\NormalTok{,}
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}
\NormalTok{)}

\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Length, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Width, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{6}\NormalTok{,}
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{colors =} \StringTok{"Set2"}
\NormalTok{)}

\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Length, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Width, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{6}\NormalTok{,}
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{colors =} \StringTok{"Set1"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

构造 20 个类别 超出 Set1 调色板的范围，会触发警告说 Set1 没有那么多色块，但还是返回足够多的色块，也可以使用 \texttt{viridis}、\texttt{plasma}、\texttt{magma} 或 \texttt{inferno} 调色板

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{dt =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}
    \AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2021{-}01{-}01"}\NormalTok{),}
    \AttributeTok{to =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2021{-}01{-}31"}\NormalTok{), }\AttributeTok{by =} \StringTok{"day"}
\NormalTok{  ), }\AttributeTok{each =} \DecValTok{20}\NormalTok{),}
  \AttributeTok{bu =} \FunctionTok{rep}\NormalTok{(LETTERS[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{], }\DecValTok{31}\NormalTok{),}
  \AttributeTok{qv =} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \DecValTok{20} \SpecialCharTok{*} \DecValTok{31}\NormalTok{, }\AttributeTok{size =} \DecValTok{10000}\NormalTok{, }\AttributeTok{prob =} \FunctionTok{runif}\NormalTok{(}\DecValTok{20} \SpecialCharTok{*} \DecValTok{31}\NormalTok{))}
\NormalTok{)}
\CommentTok{\# viridis}
\FunctionTok{plot\_ly}\NormalTok{(dat,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{dt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{qv, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{bu, }
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{colors =} \StringTok{"viridis"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-highcharter}{%
\section{堆积图 (highcharter)}\label{sec-highcharter}}

Joshua Kunst 在他的博客里 \url{https://jkunst.com/} 补充了很多数据可视化案例，另一个关键的参考资料是 \href{https://api.highcharts.com/highcharts/}{highcharts API 文档}，文档主要分两部分全局选项 \texttt{Highcharts.setOptions} 和绘图函数 \texttt{Highcharts.chart}。下面以 \texttt{data\_to\_boxplot()} 为例解析 R 中的数据结构是如何和 highcharts 的 JSON 以及绘图函数对应的。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(highcharter)}
\FunctionTok{highchart}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_xAxis}\NormalTok{(}\AttributeTok{type =} \StringTok{"category"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_add\_series\_list}\NormalTok{(}\AttributeTok{x =} \FunctionTok{data\_to\_boxplot}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ iris,}
    \AttributeTok{variable =}\NormalTok{ Sepal.Length,}
    \AttributeTok{group\_var =}\NormalTok{ Species,}
    \AttributeTok{add\_outliers =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{name =} \StringTok{"iris"}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

除了箱线图 boxplot 还有折线图、条形图、密度图等一系列常用图形，共计 50 余种，详见表\ref{tab:hc-charts}，各类图形示例见 \url{https://www.highcharts.com/demo}。

\begin{longtable}[]{@{}lllll@{}}
\caption{\label{tab:hc-charts}图形种类}\tabularnewline
\toprule
A & B & C & D & E \\
\midrule
\endfirsthead
\toprule
A & B & C & D & E \\
\midrule
\endhead
area & columnrange & item & pyramid3d & treemap \\
arearange & cylinder & line & sankey & variablepie \\
areaspline & dependencywheel & lollipop & scatter & variwide \\
areasplinerange & dumbbell & networkgraph & scatter3d & vector \\
bar & errorbar & organization & solidgauge & venn \\
bellcurve & funnel & packedbubble & spline & waterfall \\
boxplot & funnel3d & pareto & streamgraph & windbarb \\
bubble & gauge & pie & sunburst & wordcound \\
column & heatmap & polygon & tilemap & xrange \\
columnpyramid & histogram & pyramid & timeline & NA \\
\bottomrule
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(highcharter)}
\FunctionTok{hchart}\NormalTok{(iris, }\StringTok{"scatter"}\NormalTok{, }
       \FunctionTok{hcaes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width, }\AttributeTok{group =}\NormalTok{ Species))}
\end{Highlighting}
\end{Shaded}

有的图形种类包含多个变体，如 area 面积图，还有 arearange 、areaspline 和 areasplinerange，而 area 图其实是折线图，只是线与坐标轴围成的区域用颜色填充了。一个基本示例见\href{https://jsfiddle.net/gh/get/library/pure/highcharts/highcharts/tree/master/samples/highcharts/demo/area-basic/}{基础面积图}，数据结构如下：

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Highcharts}\OperatorTok{.}\FunctionTok{chart}\NormalTok{(}\StringTok{\textquotesingle{}container\textquotesingle{}}\OperatorTok{,}\NormalTok{ \{}
    \DataTypeTok{chart}\OperatorTok{:}\NormalTok{ \{}
        \DataTypeTok{type}\OperatorTok{:} \StringTok{\textquotesingle{}area\textquotesingle{}}
\NormalTok{    \}}\OperatorTok{,}
    \DataTypeTok{accessibility}\OperatorTok{:}\NormalTok{ \{}
        \DataTypeTok{description}\OperatorTok{:} \StringTok{\textquotesingle{}Image description: An area chart compares the nuclear stockpiles of the USA and the USSR/Russia between 1945 and 2017. The number of nuclear weapons is plotted on the Y{-}axis and the years on the X{-}axis. The chart is interactive, and the year{-}on{-}year stockpile levels can be traced for each country. The US has a stockpile of 6 nuclear weapons at the dawn of the nuclear age in 1945. This number has gradually increased to 369 by 1950 when the USSR enters the arms race with 6 weapons. At this point, the US starts to rapidly build its stockpile culminating in 32,040 warheads by 1966 compared to the USSR’s 7,089. From this peak in 1966, the US stockpile gradually decreases as the USSR’s stockpile expands. By 1978 the USSR has closed the nuclear gap at 25,393. The USSR stockpile continues to grow until it reaches a peak of 45,000 in 1986 compared to the US arsenal of 24,401. From 1986, the nuclear stockpiles of both countries start to fall. By 2000, the numbers have fallen to 10,577 and 21,000 for the US and Russia, respectively. The decreases continue until 2017 at which point the US holds 4,018 weapons compared to Russia’s 4,500.\textquotesingle{}}
\NormalTok{    \}}\OperatorTok{,}
    \DataTypeTok{title}\OperatorTok{:}\NormalTok{ \{}
        \DataTypeTok{text}\OperatorTok{:} \StringTok{\textquotesingle{}US and USSR nuclear stockpiles\textquotesingle{}}
\NormalTok{    \}}\OperatorTok{,}
    \DataTypeTok{subtitle}\OperatorTok{:}\NormalTok{ \{}
        \DataTypeTok{text}\OperatorTok{:} \StringTok{\textquotesingle{}Sources: \textless{}a href="https://thebulletin.org/2006/july/global{-}nuclear{-}stockpiles{-}1945{-}2006"\textgreater{}\textquotesingle{}} \OperatorTok{+}
            \StringTok{\textquotesingle{}thebulletin.org\textless{}/a\textgreater{} \&amp; \textless{}a href="https://www.armscontrol.org/factsheets/Nuclearweaponswhohaswhat"\textgreater{}\textquotesingle{}} \OperatorTok{+}
            \StringTok{\textquotesingle{}armscontrol.org\textless{}/a\textgreater{}\textquotesingle{}}
\NormalTok{    \}}\OperatorTok{,}
    \DataTypeTok{xAxis}\OperatorTok{:}\NormalTok{ \{}
        \DataTypeTok{allowDecimals}\OperatorTok{:} \KeywordTok{false}\OperatorTok{,}
        \DataTypeTok{labels}\OperatorTok{:}\NormalTok{ \{}
            \DataTypeTok{formatter}\OperatorTok{:} \KeywordTok{function}\NormalTok{ () \{}
                \ControlFlowTok{return} \KeywordTok{this}\OperatorTok{.}\AttributeTok{value}\OperatorTok{;} \CommentTok{// clean, unformatted number for year}
\NormalTok{            \}}
\NormalTok{        \}}\OperatorTok{,}
        \DataTypeTok{accessibility}\OperatorTok{:}\NormalTok{ \{}
            \DataTypeTok{rangeDescription}\OperatorTok{:} \StringTok{\textquotesingle{}Range: 1940 to 2017.\textquotesingle{}}
\NormalTok{        \}}
\NormalTok{    \}}\OperatorTok{,}
    \DataTypeTok{yAxis}\OperatorTok{:}\NormalTok{ \{}
        \DataTypeTok{title}\OperatorTok{:}\NormalTok{ \{}
            \DataTypeTok{text}\OperatorTok{:} \StringTok{\textquotesingle{}Nuclear weapon states\textquotesingle{}}
\NormalTok{        \}}\OperatorTok{,}
        \DataTypeTok{labels}\OperatorTok{:}\NormalTok{ \{}
            \DataTypeTok{formatter}\OperatorTok{:} \KeywordTok{function}\NormalTok{ () \{}
                \ControlFlowTok{return} \KeywordTok{this}\OperatorTok{.}\AttributeTok{value} \OperatorTok{/} \DecValTok{1000} \OperatorTok{+} \StringTok{\textquotesingle{}k\textquotesingle{}}\OperatorTok{;}
\NormalTok{            \}}
\NormalTok{        \}}
\NormalTok{    \}}\OperatorTok{,}
    \DataTypeTok{tooltip}\OperatorTok{:}\NormalTok{ \{}
        \DataTypeTok{pointFormat}\OperatorTok{:} \StringTok{\textquotesingle{}\{series.name\} had stockpiled \textless{}b\textgreater{}\{point.y:,.0f\}\textless{}/b\textgreater{}\textless{}br/\textgreater{}warheads in \{point.x\}\textquotesingle{}}
\NormalTok{    \}}\OperatorTok{,}
    \DataTypeTok{plotOptions}\OperatorTok{:}\NormalTok{ \{}
        \DataTypeTok{area}\OperatorTok{:}\NormalTok{ \{}
            \DataTypeTok{pointStart}\OperatorTok{:} \DecValTok{1940}\OperatorTok{,}
            \DataTypeTok{marker}\OperatorTok{:}\NormalTok{ \{}
                \DataTypeTok{enabled}\OperatorTok{:} \KeywordTok{false}\OperatorTok{,}
                \DataTypeTok{symbol}\OperatorTok{:} \StringTok{\textquotesingle{}circle\textquotesingle{}}\OperatorTok{,}
                \DataTypeTok{radius}\OperatorTok{:} \DecValTok{2}\OperatorTok{,}
                \DataTypeTok{states}\OperatorTok{:}\NormalTok{ \{}
                    \DataTypeTok{hover}\OperatorTok{:}\NormalTok{ \{}
                        \DataTypeTok{enabled}\OperatorTok{:} \KeywordTok{true}
\NormalTok{                    \}}
\NormalTok{                \}}
\NormalTok{            \}}
\NormalTok{        \}}
\NormalTok{    \}}\OperatorTok{,}
    \DataTypeTok{series}\OperatorTok{:}\NormalTok{ [\{}
        \DataTypeTok{name}\OperatorTok{:} \StringTok{\textquotesingle{}USA\textquotesingle{}}\OperatorTok{,}
        \DataTypeTok{data}\OperatorTok{:}\NormalTok{ [}
            \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \DecValTok{6}\OperatorTok{,} \DecValTok{11}\OperatorTok{,} \DecValTok{32}\OperatorTok{,} \DecValTok{110}\OperatorTok{,} \DecValTok{235}\OperatorTok{,}
            \DecValTok{369}\OperatorTok{,} \DecValTok{640}\OperatorTok{,} \DecValTok{1005}\OperatorTok{,} \DecValTok{1436}\OperatorTok{,} \DecValTok{2063}\OperatorTok{,} \DecValTok{3057}\OperatorTok{,} \DecValTok{4618}\OperatorTok{,} \DecValTok{6444}\OperatorTok{,} \DecValTok{9822}\OperatorTok{,} \DecValTok{15468}\OperatorTok{,}
            \DecValTok{20434}\OperatorTok{,} \DecValTok{24126}\OperatorTok{,} \DecValTok{27387}\OperatorTok{,} \DecValTok{29459}\OperatorTok{,} \DecValTok{31056}\OperatorTok{,} \DecValTok{31982}\OperatorTok{,} \DecValTok{32040}\OperatorTok{,} \DecValTok{31233}\OperatorTok{,} \DecValTok{29224}\OperatorTok{,} \DecValTok{27342}\OperatorTok{,}
            \DecValTok{26662}\OperatorTok{,} \DecValTok{26956}\OperatorTok{,} \DecValTok{27912}\OperatorTok{,} \DecValTok{28999}\OperatorTok{,} \DecValTok{28965}\OperatorTok{,} \DecValTok{27826}\OperatorTok{,} \DecValTok{25579}\OperatorTok{,} \DecValTok{25722}\OperatorTok{,} \DecValTok{24826}\OperatorTok{,} \DecValTok{24605}\OperatorTok{,}
            \DecValTok{24304}\OperatorTok{,} \DecValTok{23464}\OperatorTok{,} \DecValTok{23708}\OperatorTok{,} \DecValTok{24099}\OperatorTok{,} \DecValTok{24357}\OperatorTok{,} \DecValTok{24237}\OperatorTok{,} \DecValTok{24401}\OperatorTok{,} \DecValTok{24344}\OperatorTok{,} \DecValTok{23586}\OperatorTok{,} \DecValTok{22380}\OperatorTok{,}
            \DecValTok{21004}\OperatorTok{,} \DecValTok{17287}\OperatorTok{,} \DecValTok{14747}\OperatorTok{,} \DecValTok{13076}\OperatorTok{,} \DecValTok{12555}\OperatorTok{,} \DecValTok{12144}\OperatorTok{,} \DecValTok{11009}\OperatorTok{,} \DecValTok{10950}\OperatorTok{,} \DecValTok{10871}\OperatorTok{,} \DecValTok{10824}\OperatorTok{,}
            \DecValTok{10577}\OperatorTok{,} \DecValTok{10527}\OperatorTok{,} \DecValTok{10475}\OperatorTok{,} \DecValTok{10421}\OperatorTok{,} \DecValTok{10358}\OperatorTok{,} \DecValTok{10295}\OperatorTok{,} \DecValTok{10104}\OperatorTok{,} \DecValTok{9914}\OperatorTok{,} \DecValTok{9620}\OperatorTok{,} \DecValTok{9326}\OperatorTok{,}
            \DecValTok{5113}\OperatorTok{,} \DecValTok{5113}\OperatorTok{,} \DecValTok{4954}\OperatorTok{,} \DecValTok{4804}\OperatorTok{,} \DecValTok{4761}\OperatorTok{,} \DecValTok{4717}\OperatorTok{,} \DecValTok{4368}\OperatorTok{,} \DecValTok{4018}
\NormalTok{        ]}
\NormalTok{    \}}\OperatorTok{,}\NormalTok{ \{}
        \DataTypeTok{name}\OperatorTok{:} \StringTok{\textquotesingle{}USSR/Russia\textquotesingle{}}\OperatorTok{,}
        \DataTypeTok{data}\OperatorTok{:}\NormalTok{ [}\KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,} \KeywordTok{null}\OperatorTok{,}
            \DecValTok{5}\OperatorTok{,} \DecValTok{25}\OperatorTok{,} \DecValTok{50}\OperatorTok{,} \DecValTok{120}\OperatorTok{,} \DecValTok{150}\OperatorTok{,} \DecValTok{200}\OperatorTok{,} \DecValTok{426}\OperatorTok{,} \DecValTok{660}\OperatorTok{,} \DecValTok{869}\OperatorTok{,} \DecValTok{1060}\OperatorTok{,}
            \DecValTok{1605}\OperatorTok{,} \DecValTok{2471}\OperatorTok{,} \DecValTok{3322}\OperatorTok{,} \DecValTok{4238}\OperatorTok{,} \DecValTok{5221}\OperatorTok{,} \DecValTok{6129}\OperatorTok{,} \DecValTok{7089}\OperatorTok{,} \DecValTok{8339}\OperatorTok{,} \DecValTok{9399}\OperatorTok{,} \DecValTok{10538}\OperatorTok{,}
            \DecValTok{11643}\OperatorTok{,} \DecValTok{13092}\OperatorTok{,} \DecValTok{14478}\OperatorTok{,} \DecValTok{15915}\OperatorTok{,} \DecValTok{17385}\OperatorTok{,} \DecValTok{19055}\OperatorTok{,} \DecValTok{21205}\OperatorTok{,} \DecValTok{23044}\OperatorTok{,} \DecValTok{25393}\OperatorTok{,} \DecValTok{27935}\OperatorTok{,}
            \DecValTok{30062}\OperatorTok{,} \DecValTok{32049}\OperatorTok{,} \DecValTok{33952}\OperatorTok{,} \DecValTok{35804}\OperatorTok{,} \DecValTok{37431}\OperatorTok{,} \DecValTok{39197}\OperatorTok{,} \DecValTok{45000}\OperatorTok{,} \DecValTok{43000}\OperatorTok{,} \DecValTok{41000}\OperatorTok{,} \DecValTok{39000}\OperatorTok{,}
            \DecValTok{37000}\OperatorTok{,} \DecValTok{35000}\OperatorTok{,} \DecValTok{33000}\OperatorTok{,} \DecValTok{31000}\OperatorTok{,} \DecValTok{29000}\OperatorTok{,} \DecValTok{27000}\OperatorTok{,} \DecValTok{25000}\OperatorTok{,} \DecValTok{24000}\OperatorTok{,} \DecValTok{23000}\OperatorTok{,} \DecValTok{22000}\OperatorTok{,}
            \DecValTok{21000}\OperatorTok{,} \DecValTok{20000}\OperatorTok{,} \DecValTok{19000}\OperatorTok{,} \DecValTok{18000}\OperatorTok{,} \DecValTok{18000}\OperatorTok{,} \DecValTok{17000}\OperatorTok{,} \DecValTok{16000}\OperatorTok{,} \DecValTok{15537}\OperatorTok{,} \DecValTok{14162}\OperatorTok{,} \DecValTok{12787}\OperatorTok{,}
            \DecValTok{12600}\OperatorTok{,} \DecValTok{11400}\OperatorTok{,} \DecValTok{5500}\OperatorTok{,} \DecValTok{4512}\OperatorTok{,} \DecValTok{4502}\OperatorTok{,} \DecValTok{4502}\OperatorTok{,} \DecValTok{4500}\OperatorTok{,} \DecValTok{4500}
\NormalTok{        ]}
\NormalTok{    \}]}
\NormalTok{\})}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

对应到 R 包 \textbf{highcharter} 中，绘图代码如下：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(highcharter)}
\FunctionTok{options}\NormalTok{(}\AttributeTok{highcharter.theme =} \FunctionTok{hc\_theme\_hcrt}\NormalTok{(}\AttributeTok{tooltip =} \FunctionTok{list}\NormalTok{(}\AttributeTok{valueDecimals =} \DecValTok{2}\NormalTok{)))}

\NormalTok{usa }\OtherTok{\textless{}{-}} \FunctionTok{ts}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{c}\NormalTok{(}
    \ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{32}\NormalTok{, }\DecValTok{110}\NormalTok{, }\DecValTok{235}\NormalTok{,}
    \DecValTok{369}\NormalTok{, }\DecValTok{640}\NormalTok{, }\DecValTok{1005}\NormalTok{, }\DecValTok{1436}\NormalTok{, }\DecValTok{2063}\NormalTok{, }\DecValTok{3057}\NormalTok{, }\DecValTok{4618}\NormalTok{, }\DecValTok{6444}\NormalTok{, }\DecValTok{9822}\NormalTok{, }\DecValTok{15468}\NormalTok{,}
    \DecValTok{20434}\NormalTok{, }\DecValTok{24126}\NormalTok{, }\DecValTok{27387}\NormalTok{, }\DecValTok{29459}\NormalTok{, }\DecValTok{31056}\NormalTok{, }\DecValTok{31982}\NormalTok{, }\DecValTok{32040}\NormalTok{, }\DecValTok{31233}\NormalTok{, }\DecValTok{29224}\NormalTok{, }\DecValTok{27342}\NormalTok{,}
    \DecValTok{26662}\NormalTok{, }\DecValTok{26956}\NormalTok{, }\DecValTok{27912}\NormalTok{, }\DecValTok{28999}\NormalTok{, }\DecValTok{28965}\NormalTok{, }\DecValTok{27826}\NormalTok{, }\DecValTok{25579}\NormalTok{, }\DecValTok{25722}\NormalTok{, }\DecValTok{24826}\NormalTok{, }\DecValTok{24605}\NormalTok{,}
    \DecValTok{24304}\NormalTok{, }\DecValTok{23464}\NormalTok{, }\DecValTok{23708}\NormalTok{, }\DecValTok{24099}\NormalTok{, }\DecValTok{24357}\NormalTok{, }\DecValTok{24237}\NormalTok{, }\DecValTok{24401}\NormalTok{, }\DecValTok{24344}\NormalTok{, }\DecValTok{23586}\NormalTok{, }\DecValTok{22380}\NormalTok{,}
    \DecValTok{21004}\NormalTok{, }\DecValTok{17287}\NormalTok{, }\DecValTok{14747}\NormalTok{, }\DecValTok{13076}\NormalTok{, }\DecValTok{12555}\NormalTok{, }\DecValTok{12144}\NormalTok{, }\DecValTok{11009}\NormalTok{, }\DecValTok{10950}\NormalTok{, }\DecValTok{10871}\NormalTok{, }\DecValTok{10824}\NormalTok{,}
    \DecValTok{10577}\NormalTok{, }\DecValTok{10527}\NormalTok{, }\DecValTok{10475}\NormalTok{, }\DecValTok{10421}\NormalTok{, }\DecValTok{10358}\NormalTok{, }\DecValTok{10295}\NormalTok{, }\DecValTok{10104}\NormalTok{, }\DecValTok{9914}\NormalTok{, }\DecValTok{9620}\NormalTok{, }\DecValTok{9326}\NormalTok{,}
    \DecValTok{5113}\NormalTok{, }\DecValTok{5113}\NormalTok{, }\DecValTok{4954}\NormalTok{, }\DecValTok{4804}\NormalTok{, }\DecValTok{4761}\NormalTok{, }\DecValTok{4717}\NormalTok{, }\DecValTok{4368}\NormalTok{, }\DecValTok{4018}
\NormalTok{  ),}
  \AttributeTok{start =} \DecValTok{1940}\NormalTok{, }\AttributeTok{end =} \DecValTok{2017}
\NormalTok{)}

\NormalTok{russia }\OtherTok{\textless{}{-}} \FunctionTok{ts}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{c}\NormalTok{(}
    \ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{,}
    \DecValTok{5}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{120}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{426}\NormalTok{, }\DecValTok{660}\NormalTok{, }\DecValTok{869}\NormalTok{, }\DecValTok{1060}\NormalTok{,}
    \DecValTok{1605}\NormalTok{, }\DecValTok{2471}\NormalTok{, }\DecValTok{3322}\NormalTok{, }\DecValTok{4238}\NormalTok{, }\DecValTok{5221}\NormalTok{, }\DecValTok{6129}\NormalTok{, }\DecValTok{7089}\NormalTok{, }\DecValTok{8339}\NormalTok{, }\DecValTok{9399}\NormalTok{, }\DecValTok{10538}\NormalTok{,}
    \DecValTok{11643}\NormalTok{, }\DecValTok{13092}\NormalTok{, }\DecValTok{14478}\NormalTok{, }\DecValTok{15915}\NormalTok{, }\DecValTok{17385}\NormalTok{, }\DecValTok{19055}\NormalTok{, }\DecValTok{21205}\NormalTok{, }\DecValTok{23044}\NormalTok{, }\DecValTok{25393}\NormalTok{, }\DecValTok{27935}\NormalTok{,}
    \DecValTok{30062}\NormalTok{, }\DecValTok{32049}\NormalTok{, }\DecValTok{33952}\NormalTok{, }\DecValTok{35804}\NormalTok{, }\DecValTok{37431}\NormalTok{, }\DecValTok{39197}\NormalTok{, }\DecValTok{45000}\NormalTok{, }\DecValTok{43000}\NormalTok{, }\DecValTok{41000}\NormalTok{, }\DecValTok{39000}\NormalTok{,}
    \DecValTok{37000}\NormalTok{, }\DecValTok{35000}\NormalTok{, }\DecValTok{33000}\NormalTok{, }\DecValTok{31000}\NormalTok{, }\DecValTok{29000}\NormalTok{, }\DecValTok{27000}\NormalTok{, }\DecValTok{25000}\NormalTok{, }\DecValTok{24000}\NormalTok{, }\DecValTok{23000}\NormalTok{, }\DecValTok{22000}\NormalTok{,}
    \DecValTok{21000}\NormalTok{, }\DecValTok{20000}\NormalTok{, }\DecValTok{19000}\NormalTok{, }\DecValTok{18000}\NormalTok{, }\DecValTok{18000}\NormalTok{, }\DecValTok{17000}\NormalTok{, }\DecValTok{16000}\NormalTok{, }\DecValTok{15537}\NormalTok{, }\DecValTok{14162}\NormalTok{, }\DecValTok{12787}\NormalTok{,}
    \DecValTok{12600}\NormalTok{, }\DecValTok{11400}\NormalTok{, }\DecValTok{5500}\NormalTok{, }\DecValTok{4512}\NormalTok{, }\DecValTok{4502}\NormalTok{, }\DecValTok{4502}\NormalTok{, }\DecValTok{4500}\NormalTok{, }\DecValTok{4500}
\NormalTok{  ),}
  \AttributeTok{start =} \DecValTok{1940}\NormalTok{, }\AttributeTok{end =} \DecValTok{2017}
\NormalTok{)}

\NormalTok{unit\_format }\OtherTok{\textless{}{-}} \FunctionTok{JS}\NormalTok{(}\StringTok{"function()\{}
\StringTok{  return this.value / 10000 + \textquotesingle{}M\textquotesingle{};}
\StringTok{\}"}\NormalTok{)}

\FunctionTok{highchart}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_xAxis}\NormalTok{(}\AttributeTok{type =} \StringTok{"datetime"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_yAxis}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{"Nuclear weapon states"}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{list}\NormalTok{(}\AttributeTok{formatter =}\NormalTok{ unit\_format)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_title}\NormalTok{(}\AttributeTok{text =} \StringTok{"US and USSR nuclear stockpiles"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_subtitle}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste}\NormalTok{(}
    \StringTok{\textquotesingle{}Sources: \textless{}a href="https://thebulletin.org/2006/july/global{-}nuclear{-}stockpiles{-}1945{-}2006"\textgreater{}\textquotesingle{}}\NormalTok{,}
    \StringTok{\textquotesingle{}thebulletin.org\textless{}/a\textgreater{} \&amp; \textless{}a href="https://www.armscontrol.org/factsheets/Nuclearweaponswhohaswhat"\textgreater{}\textquotesingle{}}\NormalTok{,}
    \StringTok{"armscontrol.org\textless{}/a\textgreater{}"}
\NormalTok{  )) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_add\_series}\NormalTok{(}\AttributeTok{data =}\NormalTok{ russia, }\AttributeTok{type =} \StringTok{"area"}\NormalTok{, }\AttributeTok{name =} \StringTok{"USSR/Russia"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_add\_series}\NormalTok{(}\AttributeTok{data =}\NormalTok{ usa, }\AttributeTok{type =} \StringTok{"area"}\NormalTok{, }\AttributeTok{name =} \StringTok{"USA"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_exporting}\NormalTok{(}
    \AttributeTok{enabled =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{filename =} \FunctionTok{paste}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{(), }\StringTok{"nuclear"}\NormalTok{, }\AttributeTok{sep =} \StringTok{"{-}"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

可以看出来，JS API 文档里 \texttt{chart\ -\textgreater{}\ plotOptions} 对应于 R 包 API 的 \texttt{hc\_plotOptions()} 函数，\texttt{hchart()} 函数对应于 \url{https://api.highcharts.com/highcharts/series} ，为了绘图方便起见，作者还直接支持 R 中一些数据对象，比如数据框 data.frame 和时间序列 ts 等，完整的支持列表见：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(highcharter)}
\FunctionTok{methods}\NormalTok{(hchart)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] hchart.acf*        hchart.character*  hchart.data.frame* hchart.default*   
##  [5] hchart.density*    hchart.dist*       hchart.ets*        hchart.factor*    
##  [9] hchart.forecast*   hchart.histogram*  hchart.igraph*     hchart.list*      
## [13] hchart.matrix*     hchart.mforecast*  hchart.mts*        hchart.numeric*   
## [17] hchart.prcomp*     hchart.princomp*   hchart.stl*        hchart.survfit*   
## [21] hchart.tibble*     hchart.ts*         hchart.xts*       
## see '?methods' for accessing help and source code
\end{verbatim}

更多 API 细节描述见 \url{https://jkunst.com/highcharter/articles/modules.html}。 桑基图描述能量的流动 \footnote{\url{https://antv-2018.alipay.com/zh-cn/vis/chart/sankey.html}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(jsonlite)}
\CommentTok{\# 转化为 JSON 格式的字符串}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{toJSON}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{from =} \FunctionTok{c}\NormalTok{(}\StringTok{"AT"}\NormalTok{, }\StringTok{"DE"}\NormalTok{, }\StringTok{"CH"}\NormalTok{, }\StringTok{"DE"}\NormalTok{),}
  \AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\StringTok{"DE"}\NormalTok{, }\StringTok{"CH"}\NormalTok{, }\StringTok{"DE"}\NormalTok{, }\StringTok{"FI"}\NormalTok{),}
  \AttributeTok{weight =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\NormalTok{))}

\FunctionTok{highchart}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_chart}\NormalTok{(}\AttributeTok{type =} \StringTok{"sankey"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_add\_series}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat)}
\end{Highlighting}
\end{Shaded}

此外，highcharter 提供 \texttt{highchartOutput()} 和 \texttt{renderHighchart()} 函数支持在 shiny 中使用 highcharts 图形。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(highcharter)}

\FunctionTok{shinyApp}\NormalTok{(}
  \AttributeTok{ui =} \FunctionTok{fluidPage}\NormalTok{(}
    \FunctionTok{highchartOutput}\NormalTok{(}\StringTok{"plot\_hc"}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{server =} \ControlFlowTok{function}\NormalTok{(input, output) \{}
\NormalTok{    output}\SpecialCharTok{$}\NormalTok{plot\_hc }\OtherTok{\textless{}{-}} \FunctionTok{renderHighchart}\NormalTok{(\{}
      \FunctionTok{hchart}\NormalTok{(PlantGrowth, }\StringTok{"area"}\NormalTok{, }\FunctionTok{hcaes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{group =}\NormalTok{ group))}
\NormalTok{    \})}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

借助 htmlwidgets 和 reactR 创建新的基于 JS 库的 R 包，这样就快速将可视化图形库赋能 R 环境，关于网页可视化，JS 一定是优于 R 的，毕竟人家是专业前端工具，我们做的就是快速套模板，让 R 数据操作和分析的结果以非常精美的方式展现出来。这里有一篇基于 reactR 框架引入 React.js 衍生 JS 库到 R 环境中的资料 \url{https://github.com/react-R/nivocal}，一读就懂，非常适合上手。

\begin{rmdtip}{提示}

点击图例隐藏某一类别，可以看到图形纵轴会自适应展示区域的大小，这个特性对于所有图形都是支持的。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(highcharter)}
\CommentTok{\# 折线图}
\FunctionTok{hchart}\NormalTok{(sleep, }\StringTok{"line"}\NormalTok{, }\FunctionTok{hcaes}\NormalTok{(ID, extra, }\AttributeTok{group =}\NormalTok{ group))}
\CommentTok{\# 堆积区域图}
\CommentTok{\# 堆积折线图}
\end{Highlighting}
\end{Shaded}

\end{rmdtip}

\hypertarget{sec-dygraphs}{%
\section{时序图}\label{sec-dygraphs}}

\href{https://github.com/rstudio/dygraphs}{dygraphs} 专门用来绘制交互式时间序列图形，下面以美团股价为例，展示时间窗口筛选、坐标轴名称、刻度标签、注释、事件标注、缩放等功能

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meituan }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"3690.HK"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(dygraphs)}
\CommentTok{\# 缩放}
\NormalTok{dyUnzoom }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dygraph) \{}
  \FunctionTok{dyPlugin}\NormalTok{(}
    \AttributeTok{dygraph =}\NormalTok{ dygraph,}
    \AttributeTok{name =} \StringTok{"Unzoom"}\NormalTok{,}
    \AttributeTok{path =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"plugins/unzoom.js"}\NormalTok{, }\AttributeTok{package =} \StringTok{"dygraphs"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}

\CommentTok{\# 年月}
\NormalTok{getYearMonth }\OtherTok{\textless{}{-}} \StringTok{\textquotesingle{}}
\StringTok{  function(d) \{}
\StringTok{    var monthNames = ["01", "02", "03", "04", "05", "06","07", "08", "09", "10", "11", "12"];}
\StringTok{    date = new Date(d);}
\StringTok{    return date.getFullYear() + "{-}" + monthNames[date.getMonth()]; }
\StringTok{  \}\textquotesingle{}}

\FunctionTok{dygraph}\NormalTok{(meituan[, }\StringTok{"3690.HK.Adjusted"}\NormalTok{], }\AttributeTok{main =} \StringTok{"美团股价走势"}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyRangeSelector}\NormalTok{(}\AttributeTok{dateWindow =} \FunctionTok{c}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{(), }\StringTok{"\%Y{-}01{-}01"}\NormalTok{), }\FunctionTok{as.character}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{())))  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyAxis}\NormalTok{(}\AttributeTok{name =} \StringTok{"x"}\NormalTok{, }\AttributeTok{axisLabelFormatter =}\NormalTok{ getYearMonth)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyAxis}\NormalTok{(}\StringTok{"y"}\NormalTok{, }\AttributeTok{valueRange =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{500}\NormalTok{), }\AttributeTok{label =} \StringTok{"美团股价"}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyEvent}\NormalTok{(}\StringTok{"2020{-}01{-}23"}\NormalTok{, }\StringTok{"武汉封城"}\NormalTok{, }\AttributeTok{labelLoc =} \StringTok{"bottom"}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyShading}\NormalTok{(}\AttributeTok{from =} \StringTok{"2020{-}01{-}23"}\NormalTok{, }\AttributeTok{to =} \StringTok{"2020{-}04{-}08"}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#FFE6E6"}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyAnnotation}\NormalTok{(}\StringTok{"2020{-}01{-}23"}\NormalTok{, }\AttributeTok{text =} \StringTok{"武汉封城"}\NormalTok{, }\AttributeTok{tooltip =} \StringTok{"武汉封城"}\NormalTok{, }\AttributeTok{width =} \DecValTok{60}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyAnnotation}\NormalTok{(}\StringTok{"2020{-}04{-}08"}\NormalTok{, }\AttributeTok{text =} \StringTok{"武汉解封"}\NormalTok{, }\AttributeTok{tooltip =} \StringTok{"武汉解封"}\NormalTok{, }\AttributeTok{width =} \DecValTok{60}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyHighlight}\NormalTok{(}\AttributeTok{highlightSeriesOpts =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strokeWidth =} \DecValTok{2}\NormalTok{))  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dySeries}\NormalTok{(}\AttributeTok{label =} \StringTok{"调整股价"}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyLegend}\NormalTok{(}\AttributeTok{show =} \StringTok{"follow"}\NormalTok{, }\AttributeTok{hideOnMouseOut =} \ConstantTok{FALSE}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyOptions}\NormalTok{(}\AttributeTok{fillGraph =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drawGrid =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{gridLineColor =} \StringTok{"lightblue"}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{dyUnzoom}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-export}{%
\section{导出静态图形}\label{sec-export}}

orca (Open-source Report Creator App) 软件针对 plotly.js 库渲染的图形具有很强的导出功能，\href{https://github.com/plotly/orca\#installation}{安装 orca} 后，\texttt{plotly::orca()} 函数可以将基于 htmlwidgets 的 plotly 图形对象导出为 PNG、PDF 和 SVG 等格式的高质量静态图片。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{color =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\FunctionTok{orca}\NormalTok{(p, }\StringTok{"plot.svg"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplotly}{%
\section{静态图形转交互图形}\label{sec-ggplotly}}

函数 \texttt{ggplotly()} 将 ggplot 对象转化为交互式 plotly 对象

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gg }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ eruptions, }\AttributeTok{y =}\NormalTok{ waiting)) }\SpecialCharTok{+}
  \FunctionTok{stat\_density\_2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ ..level..), }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

静态图形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gg}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{interactive-web-graphics_files/figure-latex/unnamed-chunk-10-1} \end{center}

转化为 plotly 对象

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplotly}\NormalTok{(gg)}
\end{Highlighting}
\end{Shaded}

添加动态点的注释，比如点横纵坐标、坐标文本，整个注释标签的样式（如背景色）

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplotly}\NormalTok{(gg, }\AttributeTok{dynamicTicks =} \StringTok{"y"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{style}\NormalTok{(., }\AttributeTok{hoveron =} \StringTok{"points"}\NormalTok{, }\AttributeTok{hoverinfo =} \StringTok{"x+y+text"}\NormalTok{, }
        \AttributeTok{hoverlabel =} \FunctionTok{list}\NormalTok{(}\AttributeTok{bgcolor =} \StringTok{"white"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-echarts4r-map}{%
\section{地图 II}\label{sec-echarts4r-map}}

\textbf{leaflet} 包制作地图，斐济是太平洋上的一个岛国，处于板块交界处，经常发生地震，如下图所示，展示 1964 年来 1000 次震级大于 4 级的地震活动。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(leaflet)}
\FunctionTok{data}\NormalTok{(quakes)}
\CommentTok{\# Pop 提示}
\NormalTok{quakes}\SpecialCharTok{$}\NormalTok{popup\_text }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}
  \StringTok{"编号:"}\NormalTok{, }\StringTok{"\textless{}strong\textgreater{}"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{stations, }\StringTok{"\textless{}/strong\textgreater{}"}\NormalTok{, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
  \StringTok{"震深:"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{depth, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
  \StringTok{"震级:"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{mag}
\NormalTok{), htmltools}\SpecialCharTok{::}\NormalTok{HTML)}
\CommentTok{\# 构造调色板}
\NormalTok{pal }\OtherTok{\textless{}{-}} \FunctionTok{colorBin}\NormalTok{(}\StringTok{"Spectral"}\NormalTok{, }\AttributeTok{bins =} \FunctionTok{pretty}\NormalTok{(quakes}\SpecialCharTok{$}\NormalTok{mag), }\AttributeTok{reverse =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{leaflet}\NormalTok{(quakes) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addProviderTiles}\NormalTok{(providers}\SpecialCharTok{$}\NormalTok{CartoDB.Positron) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addCircles}\NormalTok{(}\AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{pal}\NormalTok{(mag), }\AttributeTok{label =} \SpecialCharTok{\textasciitilde{}}\NormalTok{popup\_text) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addLegend}\NormalTok{(}\StringTok{"bottomright"}\NormalTok{,}
    \AttributeTok{pal =}\NormalTok{ pal, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag,}
    \AttributeTok{title =} \StringTok{"地震震级"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addScaleBar}\NormalTok{(}\AttributeTok{position =} \FunctionTok{c}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{))}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{screenshots/leaflet-fiji} 

}

\caption{斐济地震带}\label{fig:fiji-quakes-latex}
\end{figure}

将上面的绘图部分保存为独立的 HTML 网页文件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(htmlwidgets)}
\CommentTok{\# p 就是绘图部分的数据对象}
\FunctionTok{saveWidget}\NormalTok{(p, }\StringTok{"fiji{-}map.html"}\NormalTok{, }\AttributeTok{selfcontained =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(leaflet)}
\FunctionTok{library}\NormalTok{(leaflet.extras)}

\NormalTok{quakes }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{leaflet}\NormalTok{() }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addTiles}\NormalTok{() }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addProviderTiles}\NormalTok{(providers}\SpecialCharTok{$}\NormalTok{OpenStreetMap.DE) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addHeatmap}\NormalTok{(}
    \AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat, }\AttributeTok{intensity =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag,}
    \AttributeTok{max =} \DecValTok{100}\NormalTok{, }\AttributeTok{radius =} \DecValTok{20}\NormalTok{, }\AttributeTok{blur =} \DecValTok{10}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{screenshots/leaflet-heatmap} 

}

\caption{斐济地震带热力图}\label{fig:fiji-heatmap-latex}
\end{figure}

\textbf{leafletCN} 提供汉化

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 地图默认放大倍数}
\NormalTok{zoom         }\OtherTok{\textless{}{-}} \DecValTok{4}
\CommentTok{\# 地图可以放大的倍数区间}
\NormalTok{minZoom      }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{maxZoom      }\OtherTok{\textless{}{-}} \DecValTok{18}

\FunctionTok{library}\NormalTok{(leaflet)}
\FunctionTok{library}\NormalTok{(leafletCN)}
\FunctionTok{library}\NormalTok{(maptools)}
\FunctionTok{library}\NormalTok{(leaflet.extras)}

\CommentTok{\# 热力图 heatmap}
\FunctionTok{leaflet}\NormalTok{(res, }\AttributeTok{options =} \FunctionTok{leafletOptions}\NormalTok{(}\AttributeTok{minZoom =}\NormalTok{ minZoom, }\AttributeTok{maxZoom =}\NormalTok{ maxZoom)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{amap}\NormalTok{() }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \CommentTok{\# setView(lng = mean(data$long), lat = mean(data$lat), zoom = zoom) |\textgreater{}}
  \FunctionTok{setView}\NormalTok{(}\AttributeTok{lng =} \DecValTok{109}\NormalTok{, }\AttributeTok{lat =} \DecValTok{38}\NormalTok{, }\AttributeTok{zoom =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addHeatmap}\NormalTok{(}
    \AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long2, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat2, }\AttributeTok{intensity =} \SpecialCharTok{\textasciitilde{}}\NormalTok{uv, }\AttributeTok{max =} \FunctionTok{max}\NormalTok{(res}\SpecialCharTok{$}\NormalTok{uv),}
    \AttributeTok{blur =}\NormalTok{ blur, }\AttributeTok{minOpacity =}\NormalTok{ minOpacity, }\AttributeTok{radius =}\NormalTok{ radius}
\NormalTok{  )}

\NormalTok{quakes}\SpecialCharTok{$}\NormalTok{popup\_text }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}
  \StringTok{"编号:"}\NormalTok{, }\StringTok{"\textless{}strong\textgreater{}"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{stations, }\StringTok{"\textless{}/strong\textgreater{}"}\NormalTok{, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
  \StringTok{"震深:"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{depth, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
  \StringTok{"震级:"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{mag}
\NormalTok{), htmltools}\SpecialCharTok{::}\NormalTok{HTML)}
\CommentTok{\# 构造调色板}
\NormalTok{pal }\OtherTok{\textless{}{-}} \FunctionTok{colorBin}\NormalTok{(}\StringTok{"Spectral"}\NormalTok{, }\AttributeTok{bins =} \FunctionTok{pretty}\NormalTok{(quakes}\SpecialCharTok{$}\NormalTok{mag), }\AttributeTok{reverse =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{leaflet}\NormalTok{(quakes) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addProviderTiles}\NormalTok{(providers}\SpecialCharTok{$}\NormalTok{CartoDB.Positron) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addCircles}\NormalTok{(}
    \AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat,}
    \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{pal}\NormalTok{(mag), }\AttributeTok{label =} \SpecialCharTok{\textasciitilde{}}\NormalTok{popup\_text}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{setView}\NormalTok{(}\DecValTok{178}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{20}\NormalTok{, }\DecValTok{5}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addHeatmap}\NormalTok{(}
    \AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat, }\AttributeTok{intensity =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag,}
    \AttributeTok{blur =} \DecValTok{20}\NormalTok{, }\AttributeTok{max =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{radius =} \DecValTok{15}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addLegend}\NormalTok{(}\StringTok{"bottomright"}\NormalTok{,}
    \AttributeTok{pal =}\NormalTok{ pal, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag,}
    \AttributeTok{title =} \StringTok{"地震震级"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addScaleBar}\NormalTok{(}\AttributeTok{position =} \FunctionTok{c}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-echarts4r-animation}{%
\section{动画}\label{sec-echarts4r-animation}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://d.cosx.org/d/422311}
\FunctionTok{library}\NormalTok{(purrr)}
\FunctionTok{library}\NormalTok{(echarts4r)}

\FunctionTok{data}\NormalTok{(}\StringTok{"gapminder"}\NormalTok{, }\AttributeTok{package =} \StringTok{"gapminder"}\NormalTok{)}

\NormalTok{titles }\OtherTok{\textless{}{-}} \FunctionTok{map}\NormalTok{(}\FunctionTok{unique}\NormalTok{(gapminder}\SpecialCharTok{$}\NormalTok{year), }\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{text =} \StringTok{"Gapminder"}\NormalTok{,}
    \AttributeTok{left =} \StringTok{"center"}
\NormalTok{  )}
\NormalTok{\})}

\NormalTok{years }\OtherTok{\textless{}{-}} \FunctionTok{map}\NormalTok{(}\FunctionTok{unique}\NormalTok{(gapminder}\SpecialCharTok{$}\NormalTok{year), }\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{subtext =}\NormalTok{ x,}
    \AttributeTok{left =} \StringTok{"center"}\NormalTok{,}
    \AttributeTok{top =} \StringTok{"center"}\NormalTok{,}
    \AttributeTok{z =} \DecValTok{0}\NormalTok{,}
    \AttributeTok{subtextStyle =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{fontSize =} \DecValTok{100}\NormalTok{,}
      \AttributeTok{color =} \StringTok{"rgb(170, 170, 170, 0.5)"}\NormalTok{,}
      \AttributeTok{fontWeight =} \StringTok{"bolder"}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{\})}

\CommentTok{\# 添加一列颜色，各大洲和颜色的对应关系可自定义，调整 levels 或 labels 里面的顺序即可，也可不指定 levels ，调用其它调色板}
\NormalTok{gapminder }\OtherTok{\textless{}{-}}\NormalTok{ gapminder }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{color =} \FunctionTok{factor}\NormalTok{(}
\NormalTok{      continent,}
      \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Asia"}\NormalTok{, }\StringTok{"Africa"}\NormalTok{, }\StringTok{"Americas"}\NormalTok{, }\StringTok{"Europe"}\NormalTok{, }\StringTok{"Oceania"}\NormalTok{),}
      \AttributeTok{labels =}\NormalTok{ RColorBrewer}\SpecialCharTok{::}\FunctionTok{brewer.pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{5}\NormalTok{, }\AttributeTok{name =} \StringTok{"Spectral"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}

\NormalTok{gapminder }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(year) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_charts}\NormalTok{(}\AttributeTok{x =}\NormalTok{ gdpPercap, }\AttributeTok{timeline =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_scatter}\NormalTok{(}
    \AttributeTok{serie =}\NormalTok{ lifeExp, }\AttributeTok{size =}\NormalTok{ pop, }\AttributeTok{bind =}\NormalTok{ country,}
    \AttributeTok{symbol\_size =} \DecValTok{5}\NormalTok{, }\AttributeTok{name =} \StringTok{""}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_add}\NormalTok{(}\StringTok{"itemStyle"}\NormalTok{, color) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_y\_axis}\NormalTok{(}
    \AttributeTok{min =} \DecValTok{20}\NormalTok{, }\AttributeTok{max =} \DecValTok{85}\NormalTok{, }\AttributeTok{nameGap =} \DecValTok{30}\NormalTok{,}
    \AttributeTok{name =} \StringTok{"Life Exp"}\NormalTok{, }\AttributeTok{nameLocation =} \StringTok{"center"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_x\_axis}\NormalTok{(}
    \AttributeTok{type =} \StringTok{"log"}\NormalTok{, }\AttributeTok{min =} \DecValTok{100}\NormalTok{, }\AttributeTok{max =} \DecValTok{100000}\NormalTok{,}
    \AttributeTok{nameGap =} \DecValTok{30}\NormalTok{, }\AttributeTok{name =} \StringTok{"GDP / Cap"}\NormalTok{, }\AttributeTok{nameLocation =} \StringTok{"center"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_timeline\_serie}\NormalTok{(}\AttributeTok{title =}\NormalTok{ titles) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_timeline\_serie}\NormalTok{(}\AttributeTok{title =}\NormalTok{ years, }\AttributeTok{index =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_timeline\_opts}\NormalTok{(}\AttributeTok{playInterval =} \DecValTok{1000}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_grid}\NormalTok{(}\AttributeTok{bottom =} \DecValTok{100}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_tooltip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# params.name 对应 bind}
\CommentTok{\# params.value[0] 对应 x}
\CommentTok{\# params.value[1] 对应 serie}
\CommentTok{\# params.value[2] 对应 size}
\CommentTok{\# tooltips 自定义}
\CommentTok{\# https://stackoverflow.com/questions/50554304/displaying{-}extra{-}variables{-}in{-}tooltips{-}echarts4r}
\CommentTok{\# 百分数处理}
\CommentTok{\# https://stackoverflow.com/questions/11832914/how{-}to{-}round{-}to{-}at{-}most{-}2{-}decimal{-}places{-}if{-}necessary}
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
\NormalTok{  tibble}\SpecialCharTok{::}\FunctionTok{rownames\_to\_column}\NormalTok{(}\StringTok{"model"}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_charts}\NormalTok{(}\AttributeTok{x =}\NormalTok{ wt) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_scatter}\NormalTok{(}\AttributeTok{serie =}\NormalTok{ mpg, }\AttributeTok{size =}\NormalTok{ qsec, }\AttributeTok{bind =}\NormalTok{ model) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_tooltip}\NormalTok{(}\AttributeTok{formatter =}\NormalTok{ htmlwidgets}\SpecialCharTok{::}\FunctionTok{JS}\NormalTok{(}\StringTok{"}
\StringTok{          function(params) \{}
\StringTok{              return (}
\StringTok{                  \textquotesingle{}\textless{}strong\textgreater{}\textquotesingle{} + params.name + \textquotesingle{}\textless{}/strong\textgreater{}\textquotesingle{} +}
\StringTok{                  \textquotesingle{}\textless{}br /\textgreater{}wt: \textquotesingle{} + params.value[0] +}
\StringTok{                  \textquotesingle{}\textless{}br /\textgreater{}mpg: \textquotesingle{} + params.value[1] +}
\StringTok{                  \textquotesingle{}\textless{}br /\textgreater{}qsec{-} \textquotesingle{} + params.value[2]}
\StringTok{              )}
\StringTok{          \}}
\StringTok{          "}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-rgl-3d}{%
\section{三维图 (rgl)}\label{sec-rgl-3d}}

\href{https://github.com/coolbutuseless/ggrgl}{ggrgl}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rgl)}
\NormalTok{lat }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{90}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, }\AttributeTok{len =} \DecValTok{50}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{/} \DecValTok{180}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{long }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{180}\NormalTok{, }\DecValTok{180}\NormalTok{, }\AttributeTok{len =} \DecValTok{50}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{/} \DecValTok{180}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{)}

\NormalTok{r }\OtherTok{\textless{}{-}} \FloatTok{6378.1} \CommentTok{\# radius of Earth in km}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ r }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(lat) }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(long)}
\NormalTok{y }\OtherTok{\textless{}{-}}\NormalTok{ r }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(lat) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(long)}
\NormalTok{z }\OtherTok{\textless{}{-}}\NormalTok{ r }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(lat)}
\CommentTok{\# 调整视角}
\FunctionTok{rgl.viewpoint}\NormalTok{( }\AttributeTok{theta =} \DecValTok{0}\NormalTok{, }\AttributeTok{phi =} \DecValTok{15}\NormalTok{, }\AttributeTok{fov =} \DecValTok{60}\NormalTok{, }\AttributeTok{zoom =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{interactive =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{persp3d}\NormalTok{(x, y, z,}
  \AttributeTok{col =} \StringTok{"white"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{zlab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{texture =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"textures/world.png"}\NormalTok{, }\AttributeTok{package =} \StringTok{"rgl"}\NormalTok{),}
  \AttributeTok{specular =} \StringTok{"black"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{box =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{normal\_x =}\NormalTok{ x, }\AttributeTok{normal\_y =}\NormalTok{ y, }\AttributeTok{normal\_z =}\NormalTok{ z}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-network-analysis}{%
\section{网络图}\label{sec-network-analysis}}

\href{https://github.com/gephi/gephi}{gephi} 探索和可视化网络图 GraphViz

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# library(igraph)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-networkD3}{%
\subsection{networkD3}\label{subsec-networkD3}}

\href{https://github.com/christophergandrud/networkD3}{networkD3} \href{https://github.com/d3/d3}{D3} 非常适合绘制网络图，如网络、树状、桑基图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(networkD3)}
\FunctionTok{data}\NormalTok{(MisLinks, MisNodes) }\CommentTok{\# 加载数据}
\FunctionTok{head}\NormalTok{(MisLinks) }\CommentTok{\# 边}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   source target value
## 1      1      0     1
## 2      2      0     8
## 3      3      0    10
## 4      3      2     6
## 5      4      0     1
## 6      5      0     1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(MisNodes) }\CommentTok{\# 节点}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              name group size
## 1          Myriel     1   15
## 2        Napoleon     1   20
## 3 Mlle.Baptistine     1   23
## 4    Mme.Magloire     1   30
## 5    CountessdeLo     1   11
## 6        Geborand     1    9
\end{verbatim}

构造网络图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{forceNetwork}\NormalTok{(}
  \AttributeTok{Links =}\NormalTok{ MisLinks, }\AttributeTok{Nodes =}\NormalTok{ MisNodes, }\AttributeTok{Source =} \StringTok{"source"}\NormalTok{,}
  \AttributeTok{Target =} \StringTok{"target"}\NormalTok{, }\AttributeTok{Value =} \StringTok{"value"}\NormalTok{, }\AttributeTok{NodeID =} \StringTok{"name"}\NormalTok{,}
  \AttributeTok{Group =} \StringTok{"group"}\NormalTok{, }\AttributeTok{opacity =} \FloatTok{0.4}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-visNetwork}{%
\subsection{visNetwork}\label{subsec-visNetwork}}

\href{https://github.com/datastorm-open/visNetwork}{visNetwork} 使用 \href{https://github.com/visjs/vis-network}{vis-network.js} 库绘制网络关系图 \url{https://datastorm-open.github.io/visNetwork}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(visNetwork)}
\end{Highlighting}
\end{Shaded}

调用函数 \texttt{visTree()} 可视化分类模型结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rpart)}
\FunctionTok{library}\NormalTok{(sparkline) }\CommentTok{\# 函数 visTree 需要导入 sparkline 包}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{rpart}\NormalTok{(Species}\SpecialCharTok{\textasciitilde{}}\NormalTok{., }\AttributeTok{data=}\NormalTok{iris)}
\FunctionTok{visTree}\NormalTok{(res, }\AttributeTok{main =} \StringTok{"鸢尾花分类树"}\NormalTok{, }\AttributeTok{width =} \StringTok{"100\%"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{interactive-web-graphics_files/figure-latex/unnamed-chunk-19-1} \end{center}

节点、边的属性都可以映射数据指标

\hypertarget{subsec-r2d3}{%
\subsection{r2d3}\label{subsec-r2d3}}

\href{https://d3js.org/}{D3} 是非常流行的 JavaScript 库，\href{https://github.com/rstudio/r2d3}{r2d3} 提供了 R 接口

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(r2d3)}
\end{Highlighting}
\end{Shaded}

更加具体的使用介绍，一个复杂的案例，如何从简单配置过来，以条形图为例， D3 是一个相当强大且成熟的库，提供的案例功能要覆盖 plotly

\href{https://github.com/rstudio/r2d3}{r2d3} 提供了两个样例 JS 库 \texttt{baranims.js} 和 \texttt{barchart.js}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{list.files}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"examples/"}\NormalTok{, }\AttributeTok{package =} \StringTok{"r2d3"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "baranims.js" "barchart.js"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(r2d3)}
\FunctionTok{r2d3}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.40}\NormalTok{, }\FloatTok{0.20}\NormalTok{),}
  \AttributeTok{script =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"examples/barchart.js"}\NormalTok{, }\AttributeTok{package =} \StringTok{"r2d3"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{r2d3}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.40}\NormalTok{, }\FloatTok{0.20}\NormalTok{),}
  \AttributeTok{script =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"examples/baranims.js"}\NormalTok{, }\AttributeTok{package =} \StringTok{"r2d3"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textcolor{red}{\textbf{TODO: }{提供一个 R 包和 HTML Widgets 小练习：给 roughViz.js 写个 R 包装 \url{https://d.cosx.org/d/421030-r-html-widgets-roughviz-js-r} \url{https://github.com/XiangyunHuang/roughviz}}}

\hypertarget{sec-python-plotly}{%
\section{Python 交互图形}\label{sec-python-plotly}}

\href{https://github.com/plotly/plotly.py/blob/master/packages/python/plotly/plotly/express/_chart_types.py}{Plotly} 的图形库

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ plotly.express }\ImportTok{as}\NormalTok{ px}

\NormalTok{px.scatter(}
\NormalTok{    px.data.iris(),}
\NormalTok{    x}\OperatorTok{=}\StringTok{"sepal\_width"}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{"sepal\_length"}\NormalTok{,}
\NormalTok{    color}\OperatorTok{=}\StringTok{"species"}\NormalTok{,}
\NormalTok{    trendline}\OperatorTok{=}\StringTok{"ols"}\NormalTok{,}
\NormalTok{    template}\OperatorTok{=}\StringTok{"simple\_white"}\NormalTok{,}
\NormalTok{    labels}\OperatorTok{=}\NormalTok{\{}
        \StringTok{"sepal\_length"}\NormalTok{: }\StringTok{"Sepal Length (cm)"}\NormalTok{,}
        \StringTok{"sepal\_width"}\NormalTok{: }\StringTok{"Sepal Width (cm)"}\NormalTok{,}
        \StringTok{"species"}\NormalTok{: }\StringTok{"Species of Iris"}\NormalTok{,}
\NormalTok{    \},}
\NormalTok{    title}\OperatorTok{=}\StringTok{"Edgar Anderson\textquotesingle{}s Iris Data"}\NormalTok{,}
\NormalTok{    color\_discrete\_sequence}\OperatorTok{=}\NormalTok{px.colors.qualitative.Set2}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{images/iris} 

}

\caption{插入图片}\label{fig:plotly-python-iris}
\end{figure}

不能同时使用 Python 版和 R 版的 Plotly.js 库，因为版本不一致产生冲突，而不能显示图形。

\hypertarget{sec-web-graphics-session}{%
\section{运行环境}\label{sec-web-graphics-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] sparkline_2.0     rpart_4.1-15      visNetwork_2.1.0  networkD3_0.4    
##  [5] r2d3_0.2.5        dygraphs_1.1.1.6  highcharter_0.8.2 plotly_4.9.4.1   
##  [9] ggplot2_3.3.5     reticulate_1.22  
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.7        lubridate_1.7.10  lattice_0.20-45   tidyr_1.1.4      
##  [5] ps_1.6.0          png_0.1-7         zoo_1.8-9         assertthat_0.2.1 
##  [9] digest_0.6.28     utf8_1.2.2        R6_2.5.1          backports_1.2.1  
## [13] evaluate_0.14     httr_1.4.2        highr_0.9         pillar_1.6.3     
## [17] rlang_0.4.11      lazyeval_0.2.2    curl_4.3.2        rstudioapi_0.13  
## [21] data.table_1.14.2 callr_3.7.0       TTR_0.24.2        Matrix_1.3-4     
## [25] rmarkdown_2.11    labeling_0.4.2    webshot_0.5.2     stringr_1.4.0    
## [29] htmlwidgets_1.5.4 igraph_1.2.6      munsell_0.5.0     broom_0.7.9      
## [33] compiler_4.1.1    xfun_0.26         pkgconfig_2.0.3   htmltools_0.5.2  
## [37] tidyselect_1.1.1  tibble_3.1.5      bookdown_0.24     fansi_0.5.0      
## [41] viridisLite_0.4.0 crayon_1.4.1      dplyr_1.0.7       withr_2.4.2      
## [45] MASS_7.3-54       grid_4.1.1        jsonlite_1.7.2    gtable_0.3.0     
## [49] lifecycle_1.0.1   DBI_1.1.1         magrittr_2.0.1    scales_1.1.1     
## [53] rlist_0.4.6.2     quantmod_0.4.18   stringi_1.7.4     farver_2.1.0     
## [57] ellipsis_0.3.2    xts_0.12.1        generics_0.1.0    vctrs_0.3.8      
## [61] tools_4.1.1       glue_1.4.2        purrr_0.3.4       processx_3.5.2   
## [65] fastmap_1.1.0     yaml_2.2.1        colorspace_2.0-2  isoband_0.2.5    
## [69] knitr_1.36
\end{verbatim}

\hypertarget{part-ux52a8ux6001ux6587ux6863}{%
\part{动态文档}\label{part-ux52a8ux6001ux6587ux6863}}

\hypertarget{chap-dynamic-documents}{%
\chapter*{介绍}\label{chap-dynamic-documents}}
\addcontentsline{toc}{chapter}{介绍}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{images/rmarkdown} 

}

\caption{R Markdown 极其周边生态}\label{fig:rmarkdown-hex}
\end{figure}

\href{https://github.com/tjmahr/WrapRmd}{WrapRmd} 将 R Markdown 里很长的文本自动断行，但不产生空行。 \href{https://github.com/gadenbuie/regexplain}{regexplain} 帮助检查正则表达式，\href{https://github.com/mdequeljoe/rdoc}{rdoc} 支持 R 帮助文档的语法高亮。\href{https://github.com/gadenbuie/shinyComponents}{shinyComponents} 实现在 R Markdown 中写 shiny 。\href{https://github.com/benmarwick/wordcountaddin}{wordcountaddin} 统计 R Markdown 文档中的单词数量。\href{https://github.com/r-lib/styler}{styler} 格式化 R Markdown 文档中的代码块。\href{https://github.com/tidyverse/reprex}{reprex} 添加代码执行的软件环境，提供可重复的例子，方便在论坛/Github上发问。\href{https://github.com/yonicd/carbonate}{carbonate} 将源代码截图。\href{https://github.com/fmmattioni/downloadthis}{downloadthis} 在 R Markdown 文档中添加下载按钮。\href{https://github.com/ropenscilabs/icon}{icon} 添加各种各样的图标，\href{https://github.com/rstudio/thematic/}{thematic} 定制 R Markdown 主题。 \href{https://github.com/nstrayer/datadrivencv}{datadrivencv}、\href{https://github.com/mitchelloharawild/vitae}{vitae} 制作基于 R Markdown 文档的简历。\href{https://github.com/daattali/addinslist}{addinslist} 收集了一系列 RStudio 插件，提高写作和编码的效率。\href{https://github.com/brentthorne/posterdown}{posterdown} 写宣传海报，\href{https://github.com/noamross/redoc}{redoc} 实现 R Markdown 和 Microsoft Word 两种文档格式之间互相转化，\href{https://github.com/benmarwick/rrtools}{rrtools} 写可重复性的研究论文和报告，提供一套自动化的软件环境的配置，节省科研人员的时间。\href{https://github.com/jonocarroll/butteRfly}{butteRfly} 快速获取 Github 等社交网络上活动记录，以日历图的形式展现出来。\href{https://github.com/moodymudskipper/flow}{flow} 可以非常方便地制作函数内部调用执行的流程图。

\href{https://github.com/atusy/minidown}{minidown} 提供轻量级的 CSS 框架打磨的网页模版，\href{https://github.com/juba/rmdformats}{rmdformats} 和 \href{https://github.com/yixuan/prettydoc}{prettydoc} 提供不同主题样式的网页输出，\href{https://github.com/ukgovdatascience/govdown}{govdown} 提供 \href{https://design-system.service.gov.uk/}{GOV.UK} 风格的网页模版。

\href{https://github.com/illinois-r/uiucthemes}{uiucthemes} 伊利诺伊大学主题的 R Markdown 模版， \href{https://github.com/mangothecat/rmdshower}{rmdshower} 提供 \href{https://github.com/shower/shower}{shower} 引擎打造的幻灯片，而 \href{https://github.com/yihui/xaringan}{xaringan} 是基于 \href{https://remarkjs.com/}{remark.js}。\href{https://github.com/gadenbuie/xaringanthemer}{xaringanthemer} 和 \href{https://github.com/gadenbuie/xaringanExtra}{xaringanExtra} 包含丰富的 xaringan 的主题。

\href{https://github.com/datalorax/slidex}{slidex} 可以将 PowerPoint 幻灯片转化为粗燥的 xaringan 幻灯片。

\href{https://github.com/kiernann/gluedown}{gluedown} 用 R 代码写格式化的 Markdown 文本，

\begin{itemize}
\tightlist
\item
  Reproducible Research Data and Project Management in R \url{https://annakrystalli.me/rrresearchACCE20/}
\item
  Higher, further, faster with Marvelous R Markdown \url{https://bit.ly/marvelRMD}
\item
  R Markdown for Scientists \url{https://rmd4sci.njtierney.com/}
\item
  Getting Used to R, RStudio, and R Markdown \url{https://rbasics.netlify.app/}
\item
  R Markdown 指南手册 \url{https://www.dataquest.io/blog/r-markdown-guide-cheatsheet/}
\item
  Statistical Inference via Data Science: A ModernDive into R and the tidyverse \url{https://moderndive.com/}
\item
  参数化报告 \url{https://github.com/jenniferthompson/ParamRmdExample} 和 \url{https://elastic-lovelace-155848.netlify.app/gallery/themes/flatly.html}
\item
  Sharing analyses with R Markdown \url{https://andrewbtran.github.io/NICAR/2018/workflow/docs/02-rmarkdown.html}
\item
  Introduction to the Normal Distribution \url{https://tinystats.github.io/teacups-giraffes-and-statistics/02_bellCurve.html}
\item
  混合效应模型的 workshop \url{https://github.com/singmann/mixed_model_workshop}
\item
  基于 thematic 和 bslib 包美化 Rmd 文档 \url{https://www.tillac-data.com/2020-fast-rmd-theming-with-thematic-and-bootstraplib/}
\item
  借助 flipbookr 在 xaringan 制作的幻灯片里逐行展示代码执行的效果，特别适合用于 ggplot2 的教学 \url{https://evamaerey.github.io/little_flipbooks_library/flipbookr/skeleton}
\item
  制作 note/tips 等自定义块 \url{https://desiree.rbind.io/post/2019/making-tip-boxes-with-bookdown-and-rmarkdown/}
\item
  learnr: Interactive Tutorials with R Markdown \url{https://rstudio.github.com/learnr/}
\item
  r2d3: R Interface to D3 Visualizations \url{https://rstudio.github.io/r2d3/}
\item
  radix: Radix combines the technical authoring features of Distill with R Markdown, enabling a fully reproducible workflow based on literate programming \url{https://github.com/radixpub/radix-r}
\item
  revealjs: R Markdown Format for reveal.js Presentations \url{https://github.com/rstudio/revealjs}
\item
  xaringan: Presentation Ninja 幻灯忍者写轮眼 \url{https://slides.yihui.name/xaringan/}
\end{itemize}

\hypertarget{chap-document-elements}{%
\chapter{文档元素}\label{chap-document-elements}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(knitr)}
\FunctionTok{library}\NormalTok{(nomnoml)}
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{library}\NormalTok{(rmarkdown)}
\end{Highlighting}
\end{Shaded}

knitr 将 R Markdown 文件转化为 Markdown 文件， Pandoc 可以将 Markdown 文件转化为 HTML5、Word、PowerPoint 和 PDF 等文档格式。

\begin{figure}

{\centering \href{https://www.ardata.fr/img/illustrations}{\includegraphics[width=0.15\linewidth,height=0.15\textheight]{images/html5} }\href{https://www.ardata.fr/img/illustrations}{\includegraphics[width=0.15\linewidth,height=0.15\textheight]{images/word} }\href{https://www.ardata.fr/img/illustrations}{\includegraphics[width=0.15\linewidth,height=0.15\textheight]{images/powerpoint} }\href{https://www.ardata.fr/img/illustrations}{\includegraphics[width=0.15\linewidth,height=0.15\textheight]{images/pdf} }

}

\caption{rmarkdown 支持的输出格式}\label{fig:rmarkdown-output}
\end{figure}

rmarkdown 自 2014年09月17日在 CRAN 上发布第一个正式版本以来，逐渐形成了一个强大的生态系统，世界各地的开发者贡献各种各样的扩展功能，见图 \ref{fig:rmarkdown-ecosystem}

\begin{figure}

{\centering \includegraphics{document-elements_files/figure-latex/rmarkdown-ecosystem-1} 

}

\caption{rmarkdown 生态系统}\label{fig:rmarkdown-ecosystem}
\end{figure}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{diagrams/rmarkdown} 

}

\caption{R Markdown 概念图}\label{fig:rmarkdown-concept-map}
\end{figure}

\hypertarget{sec-sql-engine}{%
\section{控制选项}\label{sec-sql-engine}}

\href{https://irene.rbind.io/post/using-sql-in-rstudio/}{Using SQL in RStudio}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\NormalTok{conn }\OtherTok{\textless{}{-}}\NormalTok{ DBI}\SpecialCharTok{::}\FunctionTok{dbConnect}\NormalTok{(RSQLite}\SpecialCharTok{::}\FunctionTok{SQLite}\NormalTok{(),}
  \AttributeTok{dbname =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"db"}\NormalTok{, }\StringTok{"datasets.sqlite"}\NormalTok{, }\AttributeTok{package =} \StringTok{"RSQLite"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Base R 内置的数据集都整合进 RSQLite 的样例数据库里了，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbListTables}\NormalTok{(conn)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "BOD"              "CO2"              "ChickWeight"      "DNase"           
##  [5] "Formaldehyde"     "Indometh"         "InsectSprays"     "LifeCycleSavings"
##  [9] "Loblolly"         "Orange"           "OrchardSprays"    "PlantGrowth"     
## [13] "Puromycin"        "Theoph"           "ToothGrowth"      "USArrests"       
## [17] "USJudgeRatings"   "airquality"       "anscombe"         "attenu"          
## [21] "attitude"         "cars"             "chickwts"         "esoph"           
## [25] "faithful"         "freeny"           "infert"           "iris"            
## [29] "longley"          "morley"           "mtcars"           "npk"             
## [33] "pressure"         "quakes"           "randu"            "rock"            
## [37] "sleep"            "stackloss"        "swiss"            "trees"           
## [41] "warpbreaks"       "women"
\end{verbatim}

随意选择 5 行数据记录，将结果保存到变量 iris\_preview

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{SELECT} \OperatorTok{*} \KeywordTok{FROM}\NormalTok{ iris }\KeywordTok{LIMIT} \DecValTok{5}\NormalTok{;}
\end{Highlighting}
\end{Shaded}

查看变量 iris\_preview 的内容

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris\_preview}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
\end{verbatim}

结束后关闭连接

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbDisconnect}\NormalTok{(}\AttributeTok{conn =}\NormalTok{ conn)}
\end{Highlighting}
\end{Shaded}

\hypertarget{markdown}{%
\section{Markdown}\label{markdown}}

Markdown 为核心，Pandoc's Markdown 和 R Markdown 仅介绍扩展的功能，三剑客 Markdown \& Pandoc's Markdown \& R Markdown，\href{https://github.com/scholmd/scholmd/wiki}{Markdown for scientific writing}

首先介绍 Markdown 在强调、标题、列表、断行、链接、图片、引用、代码块、LaTeX 公式等使用方式，然后在 Markdown 的基础上介绍 Pandoc's Markdown 功能有加强的地方，R Markdown 在 Pandoc's Markdown 的基础上介绍功能有加强的地方。

Markdown 基础语法见 RStudio IDE 自带的 Markdown 手册：RStudio 顶部菜单栏 -\textgreater{} Help -\textgreater{} Markdown Quick Reference，这里主要介绍一下Markdown 高级语法，特别是 \href{https://pandoc.org/MANUAL.html\#pandocs-markdown}{Pandoc's Markdown}，其实是 Pandoc 提供了很多对 Markdown 的扩展支持，下面介绍一下被 Pandoc 加强后的 Markdown 表格、图片和公式的使用

\hypertarget{markdown-list}{%
\subsection{列表}\label{markdown-list}}

\begin{itemize}
\item
  有序的列表

  \begin{enumerate}
  \def\labelenumi{\arabic{enumi}.}
  \tightlist
  \item
    第一条
  \item
    第二条
  \end{enumerate}
\item
  无序的列表

  \begin{itemize}
  \item
    第一条
  \item
    第二条
  \item
    here is my first list item.
  \item
    and my second.
  \end{itemize}
\item
  嵌套的列表

  \begin{enumerate}
  \def\labelenumi{\arabic{enumi}.}
  \tightlist
  \item
    有序
  \item
    Item 2
  \item
    Item 3

    \begin{itemize}
    \tightlist
    \item
      Item 3a
    \item
      Item 3b
    \end{itemize}
  \end{enumerate}

  \begin{itemize}
  \tightlist
  \item
    无序
  \item
    Item 2

    \begin{itemize}
    \tightlist
    \item
      Item 2a
    \item
      Item 2b
    \end{itemize}
  \end{itemize}
\end{itemize}

定义型列表中包含代码

\begin{description}
\item[Term 1]
Definition 1
\item[Term 2 with \emph{inline markup}]
Definition 2

\begin{verbatim}
{ some code, part of Definition 2 }
\end{verbatim}

Third paragraph of definition 2.
\end{description}

定义类型的列表，紧凑形式

\begin{description}
\tightlist
\item[Term 1]
Definition 1
\item[Term 2]
Definition 2a

Definition 2b
\end{description}

无序列表

\begin{itemize}
\tightlist
\item
  fruits

  \begin{itemize}
  \tightlist
  \item
    apples

    \begin{itemize}
    \tightlist
    \item
      macintosh
    \item
      red delicious
    \end{itemize}
  \item
    pears
  \item
    peaches
  \end{itemize}
\item
  vegetables

  \begin{itemize}
  \tightlist
  \item
    broccoli
  \item
    chard
  \end{itemize}
\end{itemize}

对应 LaTeX 列表环境里的有序环境，通篇计数

\begin{enumerate}
\def\labelenumi{(\arabic{enumi})}
\tightlist
\item
  My first example will be numbered (1).
\item
  My second example will be numbered (2).
\end{enumerate}

Explanation of examples.

\begin{enumerate}
\def\labelenumi{(\arabic{enumi})}
\setcounter{enumi}{2}
\tightlist
\item
  My third example will be numbered (3).
\end{enumerate}

\texttt{(@)} 环境可以引用

\begin{enumerate}
\def\labelenumi{(\arabic{enumi})}
\setcounter{enumi}{3}
\tightlist
\item
  这是一个好例子
\end{enumerate}

正如 (4) 所指出的那样，

列表里包含代码块

\begin{itemize}
\tightlist
\item
  item one
\item
  item two
\end{itemize}

\begin{verbatim}
{ my code block }
\end{verbatim}

显示反引号 \texttt{\textasciigrave{}}

\hypertarget{markdown-quote}{%
\subsection{引用}\label{markdown-quote}}

注意在引用末尾空两格，出处另起一行，引用名人名言:

\begin{quote}
It's always better to give than to receive.
\end{quote}

\begin{quote}
Trellis graphics are a bit like hash functions: you can be close to the target, but get a far-off result.\footnote{(about problems with creating a suitable lattice panel function) R-help (August 2008)}

\hspace*{\fill} --- Dieter Menne
\end{quote}

\begin{quote}
If you imagine that this pen is Trellis, then Lattice is not this pen.\footnote{(on the difference of Lattice (which eventually was called grid) and Trellis) DSC 2001, Wien (March 2001)}

\hspace*{\fill} --- Paul Murrell
\end{quote}

\begin{quote}
You're overlooking something like line 800 of the documentation for xyplot. {[}\ldots{]} It's probably in the R-FAQ as well, since my original feeling was that this behaviour was chosen in order to confuse people and see how many people read the FAQ\ldots{} :) \footnote{(about the fact that lattice objects have to be print()ed) R-help (May 2005)}

\hspace*{\fill} --- Barry Rowlingson
\end{quote}

\hypertarget{markdown-table}{%
\subsection{表格}\label{markdown-table}}

插入表格很简单的，复杂的表格制作可以借助 R 包 knitr 提供的 kable 函数以及 kableExtra 包\footnote{\url{https://xiangyunhuang.github.io/bookdown-kableExtra/}}，此外谢益辉的书籍 \href{https://bookdown.org/yihui/bookdown/}{bookdown: Authoring Books and Technical Documents with R Markdown} 中也有一节专门介绍表格 \url{https://bookdown.org/yihui/bookdown/tables.html}

\texttt{kable} 支持多个表格并排，

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(}
    \FunctionTok{head}\NormalTok{(iris[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], }\DecValTok{3}\NormalTok{),}
    \FunctionTok{head}\NormalTok{(mtcars[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\DecValTok{5}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{caption =} \StringTok{\textquotesingle{}A Tale of Two Tables.\textquotesingle{}}\NormalTok{, }\AttributeTok{booktabs =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}
\caption{\label{tab:table-multi}A Tale of Two Tables.}

\centering
\begin{tabular}[t]{rr}
\toprule
Sepal.Length & Sepal.Width\\
\midrule
5.1 & 3.5\\
4.9 & 3.0\\
4.7 & 3.2\\
\bottomrule
\end{tabular}
\centering
\begin{tabular}[t]{lrrr}
\toprule
  & mpg & cyl & disp\\
\midrule
Mazda RX4 & 21.0 & 6 & 160\\
Mazda RX4 Wag & 21.0 & 6 & 160\\
Datsun 710 & 22.8 & 4 & 108\\
Hornet 4 Drive & 21.4 & 6 & 258\\
Hornet Sportabout & 18.7 & 8 & 360\\
\bottomrule
\end{tabular}
\end{table}

在表格中引入数学符号

\href{https://github.com/haozhu233/kableExtra}{kableExtra} 、broom 和 \href{https://github.com/nutterb/pixiedust}{pixiedust} 包实现表格样式的精细调整，如黄湘云制作的 \href{https://xiangyunhuang.github.io/bookdown-kableExtra/}{样例}

\hypertarget{image}{%
\subsection{图片}\label{image}}

利用 \texttt{knitr::include\_graphics} 函数在代码块中插入图片是很简单的，如图\ref{fig:knitr-footnote}所示，图、表的标题很长或者需要插入脚注，可以使用{[}文本引用{]}{[}text-references{]}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{/opt/R/4.1.1/lib/R/library/graphics/help/figures/mai} 

}

\caption{(ref:footnote)}\label{fig:knitr-footnote}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.1}\NormalTok{, }\FloatTok{4.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{10}\NormalTok{), }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[height=4in]{document-elements_files/figure-latex/unnamed-chunk-7-1} 

}

\caption{测试文本引用 (ref:text-references) 图表标题很长可使用{[}文本引用{]}{[}text-references{]} (ref:footnote) 表格标题里插入脚注，但是 ebooks 不支持这样插入脚注{[}\^{}longnote{]} {[}\^{}longnote{]}: Here's one with multiple blocks. {[}text-references{]}: \url{https://bookdown.org/yihui/bookdown/markdown-extensions-by-bookdown.html\#text-references}}\label{fig:unnamed-chunk-7}
\end{figure}

控制图片插入的宽度参考谢益辉的博客： CSS 的位置属性以及如何居中对齐超宽元素 \url{https://yihui.name/cn/2018/05/css-position/}

\begin{itemize}
\item
  One
\item
  Two

  \begin{figure}
  \centering
  \includegraphics[width=0.25\textwidth,height=\textheight]{images/iris.png}
  \caption{还可以在列表环境中插入图片}
  \end{figure}
\item
  Three
\end{itemize}

根据代码动态生成图片，并插入文档中；外部图片插入文档中

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{document-elements_files/figure-latex/air-passengers-1} 

}

\caption{时间序列图}\label{fig:air-passengers}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(pressure)}
\FunctionTok{plot}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[压力与温度的关系\label{fig:two-rows-1}]{\includegraphics{document-elements_files/figure-latex/two-rows-1} }\\\subfloat[时间序列图\label{fig:two-rows-2}]{\includegraphics{document-elements_files/figure-latex/two-rows-2} }

}

\caption{2行1列布局}\label{fig:two-rows}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(pressure)}
\FunctionTok{plot}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[压力与温度的关系\label{fig:two-cols-1}]{\includegraphics[width=0.35\linewidth]{document-elements_files/figure-latex/two-cols-1} }\subfloat[时间序列图\label{fig:two-cols-2}]{\includegraphics[width=0.35\linewidth]{document-elements_files/figure-latex/two-cols-2} }

}

\caption{1行2列布局}\label{fig:two-cols}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(pressure)}
\FunctionTok{plot}\NormalTok{(AirPassengers)}
\FunctionTok{plot}\NormalTok{(pressure)}
\FunctionTok{plot}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[压力与温度的关系\label{fig:two-rows-two-cols-1}]{\includegraphics[width=0.35\linewidth]{document-elements_files/figure-latex/two-rows-two-cols-1} }\subfloat[压力与温度的关系\label{fig:two-rows-two-cols-2}]{\includegraphics[width=0.35\linewidth]{document-elements_files/figure-latex/two-rows-two-cols-2} }\\\subfloat[压力与温度的关系\label{fig:two-rows-two-cols-3}]{\includegraphics[width=0.35\linewidth]{document-elements_files/figure-latex/two-rows-two-cols-3} }\subfloat[压力与温度的关系\label{fig:two-rows-two-cols-4}]{\includegraphics[width=0.35\linewidth]{document-elements_files/figure-latex/two-rows-two-cols-4} }

}

\caption{2x2图布局}\label{fig:two-rows-two-cols}
\end{figure}



\hypertarget{markdown-math}{%
\subsection{公式}\label{markdown-math}}

行内公式一对美元符号 \(\alpha\) 或者 \(\alpha+\beta\)，行间公式 \[\alpha\] 或者 \[\alpha + \beta\] 对公式编号，如公式 \eqref{eq:likelihood}

\begin{equation}
L(\beta,\boldsymbol{\theta}) = f(y;\beta,\boldsymbol{\theta}) = \int_{\mathbb{R}^{n}}N(t;D\beta,\Sigma(\boldsymbol{\theta}))f(y|t)dt \label{eq:likelihood}
\end{equation}

多行公式分别编号，如公式\eqref{eq:BL-SGLMM} 和公式\eqref{eq:Poss-SGLMM}

\begin{align}
\log\{\frac{p_i}{1-p_i}\} & = T_{i} = d(x_i)'\beta + S(x_i) + Z_i \label{eq:BL-SGLMM}\\
\log(\lambda_i)           & = T_{i} = d(x_i)'\beta + S(x_i) + Z_i \label{eq:Poss-SGLMM}
\end{align}

多行公式中对某一（些）行编号，如公式 \eqref{eq:align} 和 公式 \eqref{eq:Poss-SGLMM2}

\begin{align} 
g(X_{n}) &= g(\theta)+g'({\tilde{\theta}})(X_{n}-\theta) \\
\sqrt{n}[g(X_{n})-g(\theta)] &= g'\left({\tilde{\theta}}\right) 
  \sqrt{n}[X_{n}-\theta ] \label{eq:align} \\
\log(\lambda_i)  & = T_{i} = d(x_i)'\beta + S(x_i) + Z_i \label{eq:Poss-SGLMM2}  
\end{align}

多行公式共用一个编号，如公式 \eqref{eq:likelihood2}

\begin{equation}
\begin{aligned}
L(\beta,\boldsymbol{\theta})
& = \int_{\mathbb{R}^{n}} \frac{N(t;D\beta,\Sigma(\boldsymbol{\theta}))f(y|t)}{N(t;D\beta_{0},\Sigma(\boldsymbol{\theta}_{0}))f(y|t)}f(y,t)dt\\
& \varpropto \int_{\mathbb{R}^{n}} \frac{N(t;D\beta,\Sigma(\boldsymbol{\theta}))}{N(t;D\beta_{0},\Sigma(\boldsymbol{\theta}_{0}))}f(t|y)dt \\
&= E_{T|y}\left[\frac{N(t;D\beta,\Sigma(\boldsymbol{\theta}))}{N(t;D\beta_{0},\Sigma(\boldsymbol{\theta}_{0}))}\right] 
\end{aligned}
\label{eq:likelihood2}
\end{equation}

推荐在 \texttt{equation} 公式中，使用 \texttt{split} 环境，意思是一个公式很长，需要拆成多行，如公式\eqref{eq:var-beta}

\begin{equation} 
\begin{split}
\mathrm{Var}(\hat{\beta}) & =\mathrm{Var}((X'X)^{-1}X'y)\\
 & =(X'X)^{-1}X'\mathrm{Var}(y)((X'X)^{-1}X')'\\
 & =(X'X)^{-1}X'\mathrm{Var}(y)X(X'X)^{-1}\\
 & =(X'X)^{-1}X'\sigma^{2}IX(X'X)^{-1}\\
 & =(X'X)^{-1}\sigma^{2}
\end{split}
\label{eq:var-beta}
\end{equation}

注意，\texttt{\textbackslash{}mathbf} 只对字母 \(a,b,c,A,B,C\) 加粗，mathjax 不支持公式中使用 \texttt{\textbackslash{}bm} 对 \(\theta,\alpha,\beta,\ldots,\gamma\) 加粗，应该使用 \texttt{\textbackslash{}boldsymbol}

\hypertarget{sec-rmarkdown-table}{%
\section{表格}\label{sec-rmarkdown-table}}

\textbf{knitr} 的 \texttt{kable()} 函数提供了制作表格的基本功能 \url{https://bookdown.org/yihui/rmarkdown-cookbook/tables.html}，\href{https://github.com/davidgohel/flextable}{flextable} 支持更加细粒度的表格定制功能。\href{https://github.com/mwip/beautifyR}{beautifyR} 整理 Markdown 表格非常方便，\href{https://github.com/MilesMcBain/datapasta}{datapasta} 快速复制粘贴 data.frame 和 tibble 类型的数据表格。\href{https://github.com/smartinsightsfromdata/rpivotTable}{rpivotTable} 不更新了，\href{https://github.com/cbailiss/pivottabler}{pivottabler} 在更新，内容似乎更好。\href{https://github.com/ThinkR-open/remedy}{remedy} 提供了更加通用的 Markdown 写作功能，简化创作的技术难度。

\hypertarget{sec-rmarkdown-uml}{%
\section{流程图}\label{sec-rmarkdown-uml}}

\href{https://github.com/rstudio/nomnoml}{nomnoml} 流程图、思维导图

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nomnoml}\SpecialCharTok{::}\FunctionTok{nomnoml}\NormalTok{(}\StringTok{" }
\StringTok{\#stroke: \#26A63A}
\StringTok{\#.box: fill=\#8f8 dashed visual=note}
\StringTok{\#direction: down}

\StringTok{[Sweave{-}test{-}1.Rnw] {-}\textgreater{} utils::Sweave() [Sweave{-}test{-}1.tex|Sweave{-}test{-}1{-}006.pdf|Sweave{-}test{-}1{-}007.pdf]}
\StringTok{[Sweave{-}test{-}1.Rnw] {-}\textgreater{} utils::Stangle() [Sweave{-}test{-}1.R]}
\StringTok{[Sweave{-}test{-}1.tex] {-}\textgreater{} tools::texi2pdf() [Sweave{-}test{-}1.pdf]}
\StringTok{[Sweave{-}test{-}1.tex] {-}\textgreater{} tools::texi2dvi() [Sweave{-}test{-}1.dvi]}
\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{document-elements_files/figure-latex/unnamed-chunk-8-1} \end{center}

\hypertarget{sec-eng}{%
\section{编程语言引擎}\label{sec-eng}}

语法高亮

\begin{verbatim}
## Warning in matrix(names(knitr::knit_engines$get()), ncol = 3, byrow = TRUE):
## data length [58] is not a sub-multiple or multiple of the number of rows [20]
\end{verbatim}

\begin{table}

\caption{\label{tab:knitr-engine}knitr 支持的引擎}
\centering
\begin{tabular}[t]{l|l|l}
\hline
awk & bash & coffee\\
\hline
gawk & groovy & haskell\\
\hline
lein & mysql & node\\
\hline
octave & perl & psql\\
\hline
Rscript & ruby & sas\\
\hline
scala & sed & sh\\
\hline
stata & zsh & highlight\\
\hline
Rcpp & tikz & dot\\
\hline
c & cc & fortran\\
\hline
fortran95 & asy & cat\\
\hline
asis & stan & block\\
\hline
block2 & js & css\\
\hline
sql & go & python\\
\hline
julia & sass & scss\\
\hline
R & bslib & targets\\
\hline
theorem & lemma & corollary\\
\hline
proposition & conjecture & definition\\
\hline
example & exercise & hypothesis\\
\hline
proof & remark & solution\\
\hline
nomnoml & awk & bash\\
\hline
\end{tabular}
\end{table}

Pandoc 通过 LaTeX 环境 lstlisting 支持语法高亮，比如

\begin{table}

\caption{\label{tab:pandoc-lang}Pandoc 支持的语法高亮}
\centering
\begin{tabular}[t]{l|l|l|l|l|l|l}
\hline
ABAP & IDL & Plasm & ACSL & inform & POV & Ada\\
\hline
Java & Prolog & Algol & JVMIS & Promela & Ant & ksh\\
\hline
Python & Assembler & Lisp & R & Awk & Logo & Reduce\\
\hline
bash & make & Rexx & Basic & Mathematica & RSL & C\\
\hline
Matlab & Ruby & C++ & Mercury & S & Caml & MetaPost\\
\hline
SAS & Clean & Miranda & Scilab & Cobol & Mizar & sh\\
\hline
Comal & ML & SHELXL & csh & Modula-2 & Simula & Delphi\\
\hline
MuPAD & SQL & Eiffel & NASTRAN & tcl & Elan & Oberon-2\\
\hline
TeX & erlang & OCL & VBScript & Euphoria & Octave & Verilog\\
\hline
Fortran & Oz & VHDL & GCL & Pascal & VRML & Gnuplot\\
\hline
Perl & XML & Haskell & PHP & XSLT & HTML & PL/I\\
\hline
\end{tabular}
\end{table}

\hypertarget{sec-bookdown-skeleton}{%
\section{快速创建书籍项目}\label{sec-bookdown-skeleton}}

在指定目录创建 Book 项目

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bookdown}\SpecialCharTok{:::}\FunctionTok{bookdown\_skeleton}\NormalTok{(}\StringTok{"\textasciitilde{}/bookdown{-}demo"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

项目根目录的文件列表

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{directory/}
\NormalTok{├──  index.Rmd}
\NormalTok{├── 01{-}intro.Rmd}
\NormalTok{├── 02{-}literature.Rmd}
\NormalTok{├── 03{-}method.Rmd}
\NormalTok{├── 04{-}application.Rmd}
\NormalTok{├── 05{-}summary.Rmd}
\NormalTok{├── 06{-}references.Rmd}
\NormalTok{├── \_bookdown.yml}
\NormalTok{├── \_output.yml}
\NormalTok{├──  book.bib}
\NormalTok{├──  preamble.tex}
\NormalTok{├──  README.md}
\NormalTok{└──  style.css}
\end{Highlighting}
\end{Shaded}

\hypertarget{markdown-ecosystem}{%
\section{Markdown 生态系统}\label{markdown-ecosystem}}

大量基于 Markdown 的软件工具，比如 Wiki Gollum、 Typora 和 VS Code 等

Pandoc's Markdown 在 Markdown 的基础上添加的功能

\hypertarget{rmarkdown-ecosystem}{%
\section{R Markdown 生态系统}\label{rmarkdown-ecosystem}}

R Markdown 站在巨人的肩膀上，这些巨人有 \href{https://daringfireball.net/projects/markdown/}{Markdown}、 \href{http://pandoc.org}{Pandoc} 和 \href{https://www.latex-project.org/}{LaTeX} 等。

markdown 简洁设计哲学， Sweave 文学编程思想，期间各种工具粉墨登场，最后分别回到 Pandoc 和 R Markdown

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:rmarkdown-eco}R Markdown 生态系统}\tabularnewline
\toprule
Package & Title \\
\midrule
\endfirsthead
\toprule
Package & Title \\
\midrule
\endhead
\textbf{addinsOutline} & RStudio Addins for Show Outline of a R Markdown/LaTeX Project \\
\textbf{blogdown} & Create Blogs and Websites with R Markdown \\
\textbf{bookdown} & Authoring Books and Technical Documents with R Markdown \\
\textbf{bsplus} & Adds Functionality to the R Markdown + Shiny Bootstrap Framework \\
\textbf{chronicle} & Grammar for Creating R Markdown Reports \\
\textbf{distill} & R Markdown Format for Scientific and Technical Writing \\
\textbf{flexdashboard} & R Markdown Format for Flexible Dashboards \\
\textbf{govdown} & GOV.UK Style Templates for R Markdown \\
\textbf{jds.rmd} & R Markdown Templates for Journal of Data Science \\
\textbf{komaletter} & Simply Beautiful PDF Letters from Markdown \\
\textbf{liftr} & Containerize R Markdown Documents for Continuous Reproducibility \\
\textbf{mailmerge} & Mail Merge Using R Markdown Documents and `gmailr' \\
\textbf{memoiR} & R Markdown and Bookdown Templates to Publish Documents \\
\textbf{memor} & A rmarkdown Template that Can be Highly Customized \\
\textbf{officedown} & Enhanced R Markdown Format for `Word' and `PowerPoint' \\
\textbf{pagedown} & Paginate the HTML Output of R Markdown with CSS for Print \\
\textbf{parsermd} & Formal Parser and Related Tools for R Markdown Documents \\
\textbf{posterdown} & Generate PDF Conference Posters Using R Markdown \\
\textbf{prereg} & R Markdown Templates to Preregister Scientific Studies \\
\textbf{prettydoc} & Creating Pretty Documents from R Markdown \\
\textbf{quarto} & R Interface to `Quarto' Markdown Publishing System \\
\textbf{radix} & R Markdown Format for Scientific and Technical Writing \\
\textbf{reportfactory} & Lightweight Infrastructure for Handling Multiple R Markdown Documents \\
\textbf{revealjs} & R Markdown Format for reveal.js Presentations \\
\textbf{rmdfiltr} & Lua-Filters for R Markdown \\
\textbf{rmdformats} & HTML Output Formats and Templates for rmarkdown Documents \\
\textbf{rmdplugr} & Plugins for R Markdown Formats \\
\textbf{rmdshower} & R Markdown Format for shower Presentations \\
\textbf{rticles} & Article Formats for R Markdown \\
\textbf{siteymlgen} & Automatically Generate \_site.yml File for R Markdown \\
\textbf{stevetemplates} & Steve's R Markdown Templates \\
\textbf{trackdown} & Collaborative Writing and Editing of R Markdown (or Sweave) Documents in Google Drive \\
\textbf{tufte} & Tufte's Styles for R Markdown Documents \\
\textbf{tufterhandout} & Tufte-style html document format for rmarkdown \\
\textbf{uiucthemes} & R Markdown Themes for UIUC Documents and Presentations \\
\textbf{vitae} & Curriculum Vitae for R Markdown \\
\textbf{webexercises} & Create Interactive Web Exercises in R Markdown (Formerly `webex') \\
\textbf{ymlthis} & Write YAML for R Markdown, bookdown, blogdown, and More \\
\bottomrule
\end{longtable}

\hypertarget{sec-web-graphics}{%
\section{支持网页图形}\label{sec-web-graphics}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width, }\AttributeTok{color =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width, }\AttributeTok{color =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\FunctionTok{library}\NormalTok{(patchwork)}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{document-elements_files/figure-latex/iris-ggplot2-1} 

}

\caption{组合 ggplot2 图形}\label{fig:iris-ggplot2}
\end{figure}

ggiraph 将 ggplot 对象转化为网页

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggiraph)}
\FunctionTok{girafe}\NormalTok{(}\AttributeTok{code =} \FunctionTok{print}\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2), }\AttributeTok{width\_svg =} \DecValTok{8}\NormalTok{, }\AttributeTok{height\_svg =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-load-shiny-app}{%
\section{支持 Shiny App}\label{sec-load-shiny-app}}

将动态图形嵌入 Shiny App 中

\begin{figure}

{\centering \href{https://xiangyun.shinyapps.io/01-iris-ggiraph/}{\includegraphics{document-elements_files/figure-latex/iris-ggiraph-shiny-1} }

}

\caption{A Shiny app created via the ggiraph package; you can see a live version at https://xiangyun.shinyapps.io/01-iris-ggiraph/.}\label{fig:iris-ggiraph-shiny}
\end{figure}

\hypertarget{chap-portable-document}{%
\chapter{便携式文档}\label{chap-portable-document}}

\hypertarget{sec-chinese-document}{%
\section{文档汉化}\label{sec-chinese-document}}

从 R Markdown 到 beamer 幻灯片，如何迁移 LaTeX 模版

默认的 PDF 文档 \href{https://github.com/XiangyunHuang/masr/blob/master/examples/pdf-default.Rmd}{PDF 文档案例}

详见\href{https://github.com/XiangyunHuang/masr/blob/master/examples/pdf-document.Rmd}{PDF 文档案例}

\hypertarget{sec-draft-watermark}{%
\section{添加水印}\label{sec-draft-watermark}}

\href{https://github.com/callegar/LaTeX-draftwatermark}{draftwatermark}

\hypertarget{sec-two-column}{%
\section{双栏排版}\label{sec-two-column}}

普通单栏排版改为双栏排版，只需添加文档类选项 \texttt{"twocolumn"}，将 YAML 元数据中的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{classoption}\KeywordTok{:}\AttributeTok{ }\StringTok{"UTF8,a4paper,fontset=adobe,zihao=false"}
\end{Highlighting}
\end{Shaded}

变为

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{classoption}\KeywordTok{:}\AttributeTok{ }\StringTok{"UTF8,a4paper,fontset=adobe,zihao=false,twocolumn"}
\end{Highlighting}
\end{Shaded}

其中，参数 \texttt{UTF8} 设定文档编码类型， \texttt{a4paper} 设置版面为 A4 纸大小，\texttt{fontset=adobe} 指定中文字体为 Adobe 字体，\texttt{zihao=false} 不指定字体大小，使用文档类 ctexart 默认的字号,

\hypertarget{sec-parameterized-reports}{%
\section{参数化报告}\label{sec-parameterized-reports}}

\href{https://github.com/XiangyunHuang/masr/blob/master/examples/parameterized-document.Rmd}{参数化文档案例}

进一步将文档类型做成参数化，实现在运行时自由选择，只需将如下两行替换掉上述一行

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{params}\KeywordTok{:}
\AttributeTok{  }\FunctionTok{classoption}\KeywordTok{:}\AttributeTok{ twocolumn}
\FunctionTok{classoption}\KeywordTok{:}\AttributeTok{ }\StringTok{"\textasciigrave{}r params$classoption\textasciigrave{}"}
\end{Highlighting}
\end{Shaded}

如果想要双栏的排版风格，编译时传递 documentclass 参数值，覆盖掉默认的参数值即可

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rmarkdown}\SpecialCharTok{::}\FunctionTok{render}\NormalTok{(}
  \AttributeTok{input =} \StringTok{"examples/pdf{-}document.Rmd"}\NormalTok{,}
  \AttributeTok{params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{classoption =} \FunctionTok{c}\NormalTok{(}\StringTok{"twocolumn"}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-beamer-slides}{%
\section{学术幻灯片}\label{sec-beamer-slides}}

beamer 幻灯片也是一种 PDF 文档 \href{https://github.com/XiangyunHuang/masr/blob/master/examples/beamer-verona.Rmd}{PDF 文档案例}

Dirk Eddelbuettel 将几个大学的 beamer 幻灯片转化成 R Markdown 模板，收录在 \href{https://github.com/eddelbuettel/binb}{binb} 包里，方便调用。伊利诺伊大学的 \href{https://thecoatlessprofessor.com/}{James J Balamuta} 在 R Markdown 基础上专门为自己学校开发了一套的幻灯片模版，全部打包在 \href{https://github.com/illinois-r/uiucthemes}{uiucthemes} 包里。

\href{https://github.com/rnuske/komaletter}{komaletter} 用 Markdown 写信件

\href{https://github.com/hebrewseniorlife/memor}{memor} \texttt{memor::pdf\_memo()}

\href{http://github.com/hrbrmstr/hrbrthemes}{hrbrthemes} 提供两个文档模版 \texttt{hrbrthemes::ipsum\_pdf()} 和 \texttt{hrbrthemes::ipsum()}

此汉风主题由 \href{https://github.com/liantze/pgfornament-han/}{林莲枝} 开发，LaTeX 宏包已发布在 \href{https://www.ctan.org/pkg/pgfornament-han}{CTAN} 上，使用此幻灯片主题需要将相关的 LaTeX 宏包一块安装。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr}\NormalTok{ install pgfornament pgfornament{-}han needspace xpatch}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-document-template}{%
\section{文档模版}\label{sec-document-template}}

字体设置

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\PreprocessorTok{{-}{-}{-}}
\FunctionTok{output}\KeywordTok{:}\AttributeTok{ }
\AttributeTok{  }\FunctionTok{pdf\_document}\KeywordTok{:}\AttributeTok{ }
\AttributeTok{    }\FunctionTok{extra\_dependencies}\KeywordTok{:}
\AttributeTok{      }\FunctionTok{DejaVuSansMono}\KeywordTok{:}
\AttributeTok{       }\KeywordTok{{-}}\AttributeTok{ scaled=0.9}
\AttributeTok{      }\FunctionTok{DejaVuSerif}\KeywordTok{:}
\AttributeTok{       }\KeywordTok{{-}}\AttributeTok{ scaled=0.9}
\AttributeTok{      }\FunctionTok{DejaVuSans}\KeywordTok{:}
\AttributeTok{       }\KeywordTok{{-}}\AttributeTok{ scaled=0.9}
\PreprocessorTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\end{column}

\begin{column}{0.05\textwidth}
~

\end{column}

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\PreprocessorTok{{-}{-}{-}}
\FunctionTok{output}\KeywordTok{:}\AttributeTok{ }
\AttributeTok{  }\FunctionTok{pdf\_document}\KeywordTok{:}\AttributeTok{ }
\AttributeTok{    }\FunctionTok{extra\_dependencies}\KeywordTok{:}
\AttributeTok{      }\FunctionTok{sourcecodepro}\KeywordTok{:}
\AttributeTok{       }\KeywordTok{{-}}\AttributeTok{ scale=0.85}
\AttributeTok{      }\FunctionTok{sourceserifpro}\KeywordTok{:}
\AttributeTok{       }\KeywordTok{{-}}\AttributeTok{ rmdefault}
\AttributeTok{      }\FunctionTok{sourcesanspro}\KeywordTok{:}
\AttributeTok{       }\KeywordTok{{-}}\AttributeTok{ sfdefault}
\PreprocessorTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\end{column}

\hypertarget{sec-cite-doi}{%
\section{引用文献}\label{sec-cite-doi}}

\href{https://fishandwhistle.net/post/2020/getting-started-zotero-better-bibtex-rmarkdown/}{Getting started with Zotero, Better BibTeX, and RMarkdown}

\href{https://github.com/cboettig/knitcitations}{knitcitations} 包可以根据文献数字对象标识符（英文 Digital Object Identifier，简称 DOI）生成引用，以文章《A Probabilistic Grammar of Graphics》\citep{Pu_2020_Grammar} 为例，其 DOI 为 \texttt{10.1145/3313831.3376466}，总之， DOI 就像是文章的身份证，是一一对应的关系\footnote{\url{https://zh.wikipedia.org/wiki/DOI}}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(knitcitations)}
\FunctionTok{citep}\NormalTok{(}\AttributeTok{x =}\StringTok{\textquotesingle{}10.1145/3313831.3376466\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "(Pu and Kay, 2020)"
\end{verbatim}

在表格的格子中引用参考文献

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{author =} \FunctionTok{c}\NormalTok{(}\StringTok{"Yihui Xie"}\NormalTok{, }\StringTok{"Yihui Xie"}\NormalTok{, }\StringTok{"Yihui Xie"}\NormalTok{),}
  \AttributeTok{citation =} \FunctionTok{c}\NormalTok{(}\StringTok{"[@xie2019]"}\NormalTok{, }\StringTok{"[@xie2015]"}\NormalTok{, }\StringTok{"[@xie2016]"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(}\AttributeTok{format =} \StringTok{"pandoc"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule
author & citation \\
\midrule
\endhead
Yihui Xie & \citep{xie2019} \\
Yihui Xie & \citep{xie2015} \\
Yihui Xie & \citep{xie2016} \\
\bottomrule
\end{longtable}

\href{https://github.com/crsh/citr}{citr} 包提供了快速查找参考文献的 RStudio 插件，不用去原始文献库 \texttt{*.bib} 搜索查找，也会自动生成引用，非常方便，极大地提高了工作效率。 \textbf{citr} 还支持集成 \href{https://www.zotero.org/}{Zotero} 文献管理软件，可以直接从 Zotero 中导入参考文献数据库。\href{https://github.com/paleolimbot/rbbt}{rbbt} 包也提供了类似的功能，只要系统安装 Zotero 软件及其插件 \href{https://retorque.re/zotero-better-bibtex/}{Better Bibtex for Zotero connector}。

\hypertarget{sec-custom-blocks}{%
\section{自定义块}\label{sec-custom-blocks}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tinytex}\SpecialCharTok{::}\FunctionTok{tlmgr\_install}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}awesomebox\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fontawesome5\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

安装 \href{https://ctan.org/pkg/awesomebox}{awesomebox} 包，开发仓库在 \url{https://github.com/milouse/latex-awesomebox}，这个 LaTeX 宏包的作用是提供几类常用的块，比如提示、注意、警告等

\begin{noteblock}注意
这是注意

\end{noteblock}

\begin{tipblock}提示
这是提示信息

\end{tipblock}

\begin{warningblock}警告
这是警告信息

\end{warningblock}

\begin{importantblock}重要
这是重要信息

\end{importantblock}

\hypertarget{chap-web-documents}{%
\chapter{网页文档}\label{chap-web-documents}}

丘怡轩开发的 \href{https://github.com/yixuan/prettydoc}{prettydoc} 包提供了一系列模版，方便快速提高网页逼格。另有 Atsushi Yasumoto 开发的 \href{https://github.com/atusy/minidown}{minidown} 包非常轻量，但是常用功能都覆盖了。

\hypertarget{sec-slides}{%
\section{幻灯片}\label{sec-slides}}

谢益辉开发的 \href{https://github.com/yihui/xaringan}{xaringan} 用于制作网页幻灯片， \href{https://github.com/gadenbuie/xaringanthemer}{xaringanthemer} 为 xaringan 提供主题定制， \href{https://github.com/gadenbuie/xaringanExtra}{xaringanExtra} 在 xaringan 之上提供各种功能扩展， \href{https://github.com/jhelvy/xaringanBuilder}{xaringanBuilder} 为 xaringan 提供多种输出格式。

\hypertarget{sec-emails}{%
\section{电子邮件}\label{sec-emails}}

\href{https://github.com/datawookie/emayili}{emayili} 是非常轻量的实现邮件发送的 R 包，其它功能类似的 R 包有 \href{https://github.com/rich-iannone/blastula}{blastula} \href{https://github.com/rpremraj/mailR}{mailR}。Rahul Premraj 基于 rJava 开发的 \href{https://github.com/rpremraj/mailR}{mailR} 虽然还未在 CRAN 上正式发布，但是已得到很多人的关注，也被广泛的使用，目前作者已经不维护了，继续使用有一定风险。 RStudio 公司 Richard Iannone 新开发的 \href{https://github.com/rich-iannone/blastula}{blastula} 扔掉了 Java 的重依赖，更加轻量化、现代化，支持发送群组邮件\footnote{\url{https://thecoatlessprofessor.com/programming/r/sending-an-email-from-r-with-blastula-to-groups-of-students/}}。 \href{https://github.com/jeroen/curl}{curl} 包提供的函数 \texttt{send\_mail()} 本质上是在利用 \href{https://curl.haxx.se/}{curl} 软件发送邮件，举个例子，邮件内容如下：

\begin{verbatim}
From: "黄湘云" <邮箱地址>
To: "黄湘云" <邮箱地址>
Subject: 测试邮件

你好：

这是一封测试邮件！
\end{verbatim}

将邮件内容保存为 mail.txt 文件，然后使用 curl 命令行工具将邮件内容发出去。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{curl} \AttributeTok{{-}{-}url} \StringTok{\textquotesingle{}smtp://公司邮件服务器地址:开放的端口号\textquotesingle{}} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}ssl{-}reqd} \AttributeTok{{-}{-}mail{-}from} \StringTok{\textquotesingle{}发件人邮箱地址\textquotesingle{}} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}mail{-}rcpt} \StringTok{\textquotesingle{}收件人邮箱地址\textquotesingle{}} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}upload{-}file}\NormalTok{ data/mail.txt }\DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}user} \StringTok{\textquotesingle{}发件人邮箱地址:邮箱登陆密码\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{rmdnote}{注意}
Gmail 出于安全性考虑，不支持这种发送邮件的方式，会将邮件内容阻挡，进而接收不到邮件。

\end{rmdnote}

下面以 blastula 包为例怎么支持 Gmail/Outlook/QQ 等邮件发送，先安装系统软件依赖，CentOS 8 上安装依赖

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ libsecret{-}devel libsodium{-}devel}
\end{Highlighting}
\end{Shaded}

然后安装 \href{}{\textbf{keyring}} 和 \href{}{\textbf{blastula}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"keyring"}\NormalTok{, }\StringTok{"blastula"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

接着配置邮件帐户，这一步需要邮件账户名和登陆密码，配置一次就够了，不需要每次发送邮件的时候都配置一次

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(blastula)}
\FunctionTok{create\_smtp\_creds\_key}\NormalTok{(}
  \AttributeTok{id =} \StringTok{"outlook"}\NormalTok{, }
  \AttributeTok{user =} \StringTok{"xiangyunfaith@outlook.com"}\NormalTok{,}
  \AttributeTok{provider =} \StringTok{"outlook"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

第二步，准备邮件内容，包括邮件主题、发件人、收件人、抄送人、密送人、邮件主体和附件等。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{attachment }\OtherTok{\textless{}{-}} \StringTok{"data/mail.txt"} \CommentTok{\# 如果没有附件，引号内留空即可。}
\CommentTok{\# 这个Rmd文件渲染后就是邮件的正文，交互图形和交互表格不适用}
\NormalTok{body }\OtherTok{\textless{}{-}} \StringTok{"examples/html{-}document.Rmd"} 
\CommentTok{\# 渲染邮件内容，生成预览}
\NormalTok{email }\OtherTok{\textless{}{-}} \FunctionTok{render\_email}\NormalTok{(body) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{add\_attachment}\NormalTok{(}\AttributeTok{file =}\NormalTok{ attachment)}
\NormalTok{email}
\end{Highlighting}
\end{Shaded}

最后，发送邮件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{smtp\_send}\NormalTok{(}
  \AttributeTok{from =} \FunctionTok{c}\NormalTok{(}\StringTok{"张三"} \OtherTok{=} \StringTok{"xxx@outlook.com"}\NormalTok{), }\CommentTok{\# 发件人}
  \AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\StringTok{"李四"} \OtherTok{=} \StringTok{"xxx@foxmail.com"}\NormalTok{,}
         \StringTok{"王五"} \OtherTok{=} \StringTok{"xxx@gmail.com"}\NormalTok{), }\CommentTok{\# 收件人}
  \AttributeTok{cc =} \FunctionTok{c}\NormalTok{(}\StringTok{"赵六"} \OtherTok{=} \StringTok{"xxx@outlook.com"}\NormalTok{), }\CommentTok{\# 抄送人}
  \AttributeTok{subject =} \StringTok{"这是一封测试邮件"}\NormalTok{,}
  \AttributeTok{email =}\NormalTok{ email,}
  \AttributeTok{credentials =} \FunctionTok{creds\_key}\NormalTok{(}\AttributeTok{id =} \StringTok{"outlook"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

密送人实现群发单显，即一封邮件同时发送给多个人，每个收件人只能看到发件人地址而看不到其它收件人地址。

\hypertarget{chap-office-document}{%
\chapter{办公文档}\label{chap-office-document}}

\href{https://github.com/graphdr/docxtools}{docxtools}、\href{https://github.com/davidgohel/officer}{officer} 和 \href{https://github.com/davidgohel/officedown}{officedown} 大大扩展了 rmarkdown 在制作 Word/PPT 方面的功能。

本节探索 Markdown + Pandoc 以 Word 格式作为最终交付的可能性。R Markdown 借助 Pandoc 将 Markdown 转化为 Word 文档，继承自 Pandoc 的扩展性， R Markdown 也支持自定义 Word 模版，那如何自定义呢？首先，我们需要知道 Pandoc 内建的 Word 模版长什么样子，然后我们依样画葫芦，制作适合实际需要的模版。获取 Pandoc 2.10.1 自带的 Word 和 PPT 模版，只需在命令行中执行

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# DOCX 模版}
\ExtensionTok{pandoc} \AttributeTok{{-}o}\NormalTok{ custom{-}reference.docx }\AttributeTok{{-}{-}print{-}default{-}data{-}file}\NormalTok{ reference.docx}
\CommentTok{\# PPTX 模版}
\ExtensionTok{pandoc} \AttributeTok{{-}o}\NormalTok{ custom{-}reference.pptx }\AttributeTok{{-}{-}print{-}default{-}data{-}file}\NormalTok{ reference.pptx}
\end{Highlighting}
\end{Shaded}

这里其实是将 Pandoc 自带的 docx 文档 reference.docx 拷贝一份到 custom-reference.docx，而后将 custom-reference.docx 文档自定义一番，但仅限于借助 MS Word 去自定义样式。 Word 文档的 YAML 元数据定义详情见 \url{https://pandoc.org/MANUAL.html\#option--reference-doc}，如何深度自定义文档模版见 \url{https://bookdown.org/yihui/rmarkdown/word-document.html} ，其它模版见 GitHub 仓库 \href{https://github.com/jgm/pandoc-templates}{pandoc-templates}。这里提供一个\href{https://github.com/XiangyunHuang/masr/blob/master/examples/docx-document.Rmd}{Word 文档案例}供读者参考。\textbf{bookdown} 提供的函数 \texttt{word\_document2()} 相比于 \textbf{rmarkdown} 提供的 \texttt{word\_document()} 支持图表的交叉引用，更多细节详见帮助 \texttt{?bookdown::word\_document2}。

\begin{rmdnote}{注意}
R Markdown 文档支持带编号的 Word 文档格式输出要求 Pandoc 版本 2.10.1 及以上， rmarkdown 版本 2.4 及以上。

\end{rmdnote}

\hypertarget{chap-reproducible-workflows}{%
\chapter{工作流}\label{chap-reproducible-workflows}}

\href{https://github.com/ropensci/drake}{drake} 一站式可重复性研究工作空间打造者，用户手册 \url{https://books.ropensci.org/drake/} 和学习材料 \url{https://github.com/wlandau/learndrake}

\hypertarget{chap-advanced-documents}{%
\chapter{高级文档}\label{chap-advanced-documents}}

\hypertarget{sec-bookdown}{%
\section{编写书籍}\label{sec-bookdown}}

此外， \href{https://github.com/XiangyunHuang/ElegantTufteBookdown}{ElegantTufteBookdown} 项目提供了 tufte 风格的书籍模板，本书配套的仓库目录 \texttt{examples/} 下准备了一系列常用模板。

\hypertarget{sec-blogdown}{%
\section{个人网站}\label{sec-blogdown}}

\hypertarget{sec-pkgdown}{%
\section{R 包文档}\label{sec-pkgdown}}

\hypertarget{sec-rmarkdown}{%
\section{课程网站}\label{sec-rmarkdown}}

\hypertarget{part-ux6570ux636eux4ea7ux54c1}{%
\part{数据产品}\label{part-ux6570ux636eux4ea7ux54c1}}

\hypertarget{chap-data-product}{%
\chapter*{介绍}\label{chap-data-product}}
\addcontentsline{toc}{chapter}{介绍}

数据产品

\hypertarget{chap-interactive-data-tables}{%
\chapter{交互表格}\label{chap-interactive-data-tables}}

Greg Lin 开发的 \href{https://github.com/glin/reactable}{reactable} 包覆盖测试达到惊人的 99\%，它基于 JavaScript 库 \href{https://github.com/tannerlinsley/react-table}{react-table}， 是 \href{https://github.com/facebook/react}{react} 框架的衍生品，Nick Raienko 整理了一份超棒的 \href{https://github.com/enaqx/awesome-react}{react 模块合集} 也许机智如你，可以引入更多优秀的 react 模块到 R 语言社区。\href{https://github.com/kcuilla/reactablefmtr}{reactablefmtr} 提供一些函数简化 reactable 定制表格的复杂性

谢益辉开发的 \href{https://github.com/rstudio/DT}{DT} 包覆盖测试 31\%， 它基于 \href{https://datatables.net/}{DataTables} 库，是 \href{https://jquery.com/}{jQuery} 框架的衍生品。益辉评价 reactable 在多个方面优于 DT，比如行分组和聚合，嵌入 HTML widgets，甚至说要是 \textbf{reactable} 存在于 \textbf{DT} 之前，他就不会新开发 DT 这个 R 包了，不过这是后话了\footnote{\url{https://bookdown.org/yihui/rmarkdown-cookbook/table-other.html}}。

Richard Iannone 开发的 \href{https://github.com/rstudio/gt}{gt} 包覆盖测试 78\%，类似 \textbf{ggplot2} 的设计哲学，试图打造制作表格的语法，相比于 \textbf{reactable} 和 \textbf{DT}， 它不依赖于 JavaScript 库，更加轻量，一般来讲，持续维护更新重 JS 库依赖的 R 包比较累人，JS 库可能会不断重构，进而变动 API。

朱昊开发的 \href{https://github.com/haozhu233/kableExtra}{kableExtra} 大大扩展了 \textbf{knitr} 包的 \texttt{kable()} 函数的功能，虽没有覆盖测试，但中英文文档特别详细，见官网 \url{https://haozhu233.github.io/kableExtra/}。

目前，Greg Lin、 谢益辉和 Richard Iannone 都是 RStudio 公司雇员，他们背靠开源组织和大公司，开发的这些 R 包的生命力都比较强。 \textbf{gt} 和 \textbf{kableExtra} 摆脱了 JavaScript 库的依赖，网页形式的表格可以嵌入到邮件内容中，这是一个不太引人注意的优势。\textbf{kableExtra} 还支持高度自定义的 LaTeX 输出，详见案例 \url{https://github.com/XiangyunHuang/bookdown-kableExtra}，\textbf{gt} 包据说未来也会支持，拭目以待吧，也许在成书之日能看到！

此外，还有任坤开发的 \href{https://github.com/renkun-ken/formattable}{\textbf{formattable}} 和 David Gohel 开发的 \href{https://github.com/davidgohel/flextable}{\textbf{flextable}} 包等，一份综合介绍见博文 \href{https://rfortherestofus.com/2019/11/how-to-make-beautiful-tables-in-r/}{How to Make Beautiful Tables in R}。

\href{https://github.com/Roche/rtables}{rtables} 处于原型开发的阶段，针对复杂表格，有比较好的设计。\href{https://github.com/rrprf/tablesgg}{tablesgg} 使用 ggplot2 将表格渲染成图片。

\hypertarget{sec-dt-reactable}{%
\section{DT 和 reactable}\label{sec-dt-reactable}}

\href{https://github.com/rstudio/DT}{DT} 基于 jQuery 的 JS 库 \href{https://datatables.net/}{DataTables} 提供了一个 R 的封装，封装工具和许多其他基于 JS 库的 R 包一样，比如即将介绍的 \textbf{reactable} 包，都依赖于 \href{https://github.com/ramnathv/htmlwidgets}{htmlwidgets}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{\textquotesingle{}CI\textquotesingle{}}\NormalTok{, }\ConstantTok{NA}\NormalTok{))) \{}
  \FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{R\_CRAN\_WEB =} \StringTok{"https://cloud.r{-}project.org/"}\NormalTok{)}
\NormalTok{\} }\ControlFlowTok{else}\NormalTok{ \{}
  \FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{R\_CRAN\_WEB =} \StringTok{"https://mirrors.tuna.tsinghua.edu.cn/CRAN"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{pdb }\OtherTok{\textless{}{-}}\NormalTok{ tools}\SpecialCharTok{::}\FunctionTok{CRAN\_package\_db}\NormalTok{()}
\NormalTok{sub\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{subset =} \SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(pdb[, }\StringTok{"Package"}\NormalTok{]) }\SpecialCharTok{\&}\NormalTok{ pdb[, }\StringTok{"Package"}\NormalTok{] }\SpecialCharTok{\%in\%} \FunctionTok{.packages}\NormalTok{(T))}
\NormalTok{pkg\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(sub\_pdb,}
  \AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Yihui Xie"}\NormalTok{, sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{]) }\SpecialCharTok{|} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Hadley Wickham"}\NormalTok{, sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{]),}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Maintainer"}\NormalTok{, }\StringTok{"Package"}\NormalTok{, }\StringTok{"Version"}\NormalTok{, }\StringTok{"Published"}\NormalTok{, }\StringTok{"Title"}\NormalTok{)}
\NormalTok{)}

\NormalTok{pkg\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(pkg\_pdb, }\AttributeTok{Title =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}n}\StringTok{)"}\NormalTok{, }\StringTok{" "}\NormalTok{, Title))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DT)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{datatable}\NormalTok{(pkg\_pdb[}\FunctionTok{order}\NormalTok{(pkg\_pdb}\SpecialCharTok{$}\NormalTok{Maintainer, }\AttributeTok{decreasing =}\NormalTok{ T), ],}
  \AttributeTok{rownames =}\NormalTok{ F, }\CommentTok{\# 不显示行名}
  \AttributeTok{extensions =} \FunctionTok{c}\NormalTok{(}\StringTok{"Buttons"}\NormalTok{, }\StringTok{"RowGroup"}\NormalTok{),}
  \AttributeTok{options =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{pageLength =} \DecValTok{10}\NormalTok{, }\CommentTok{\# 每页显示的行数}
    \AttributeTok{language =} \FunctionTok{list}\NormalTok{(}\AttributeTok{url =} \StringTok{"//cdn.datatables.net/plug{-}ins/1.10.11/i18n/Chinese.json"}\NormalTok{), }\CommentTok{\# 汉化}
    \AttributeTok{dom =} \StringTok{"Brtp"}\NormalTok{, }\CommentTok{\# 去掉显示行数 i、过滤 f 的能力，翻页用 p 表示}
    \AttributeTok{ordering =}\NormalTok{ F, }\CommentTok{\# 去掉列排序}
    \AttributeTok{buttons =} \FunctionTok{c}\NormalTok{(}\StringTok{"copy"}\NormalTok{, }\StringTok{"csv"}\NormalTok{, }\StringTok{"excel"}\NormalTok{, }\StringTok{"pdf"}\NormalTok{, }\StringTok{"print"}\NormalTok{), }\CommentTok{\# 提供打印按钮}
    \AttributeTok{rowGroup =} \FunctionTok{list}\NormalTok{(}\AttributeTok{dataSrc =} \DecValTok{0}\NormalTok{), }\CommentTok{\# 按 Maintainer 列分组}
    \AttributeTok{columnDefs =} \FunctionTok{list}\NormalTok{(}
      \FunctionTok{list}\NormalTok{(}\AttributeTok{className =} \StringTok{"dt{-}center"}\NormalTok{, }\AttributeTok{targets =} \DecValTok{0}\NormalTok{), }\CommentTok{\# 不显示行名，则 targets 从 0 开始，否则从 1 开始}
      \FunctionTok{list}\NormalTok{(}\AttributeTok{visible =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{targets =} \DecValTok{0}\NormalTok{) }\CommentTok{\# 不显示 Maintainer 列}
\NormalTok{    )}
\NormalTok{  ),}
  \AttributeTok{caption =} \StringTok{"谢大和哈神维护的 R 包"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{colorize\_num }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{,}
    \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\textless{}span style=\textquotesingle{}color:\%s\textquotesingle{}\textgreater{}\%s\textless{}/span\textgreater{}"}\NormalTok{, }\StringTok{"green"}\NormalTok{, x),}
    \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\textless{}span style=\textquotesingle{}color:\%s\textquotesingle{}\textgreater{}\%s\textless{}/span\textgreater{}"}\NormalTok{, }\StringTok{"red"}\NormalTok{, x)}
\NormalTok{  )}
\NormalTok{\}}
\NormalTok{colorize\_pct }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{,}
    \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\textless{}span style=\textquotesingle{}color:\%s\textquotesingle{}\textgreater{}\%s\textless{}/span\textgreater{}"}\NormalTok{, }\StringTok{"green"}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(x, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{)),}
    \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\textless{}span style=\textquotesingle{}color:\%s\textquotesingle{}\textgreater{}\%s\textless{}/span\textgreater{}"}\NormalTok{, }\StringTok{"red"}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(x, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{))}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{colorize\_pp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{,}
    \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\textless{}span style=\textquotesingle{}color:\%s\textquotesingle{}\textgreater{}\%s\textless{}/span\textgreater{}"}\NormalTok{, }\StringTok{"green"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\DecValTok{100}\SpecialCharTok{*}\NormalTok{x, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{), }\StringTok{"PP"}\NormalTok{)),}
    \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\textless{}span style=\textquotesingle{}color:\%s\textquotesingle{}\textgreater{}\%s\textless{}/span\textgreater{}"}\NormalTok{, }\StringTok{"red"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\DecValTok{100}\SpecialCharTok{*}\NormalTok{x, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{), }\StringTok{"PP"}\NormalTok{))}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{colorize\_text }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) \{}
    \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\textless{}span style=\textquotesingle{}color:\%s\textquotesingle{}\textgreater{}\%s\textless{}/span\textgreater{}"}\NormalTok{, color, x )}
\NormalTok{\}}

\FunctionTok{library}\NormalTok{(tibble)}

\NormalTok{dat }\OtherTok{=} \FunctionTok{tribble}\NormalTok{(}
  \SpecialCharTok{\textasciitilde{}}\NormalTok{name1, }\SpecialCharTok{\textasciitilde{}}\NormalTok{name2,}
  \FunctionTok{as.character}\NormalTok{(htmltools}\SpecialCharTok{::}\NormalTok{tags}\SpecialCharTok{$}\FunctionTok{b}\NormalTok{(}\StringTok{"加粗"}\NormalTok{)), }\FunctionTok{as.character}\NormalTok{(htmltools}\SpecialCharTok{::}\FunctionTok{a}\NormalTok{(}\AttributeTok{href =} \StringTok{"https://rstudio.com"}\NormalTok{, }\StringTok{"超链"}\NormalTok{)), }\CommentTok{\# 支持超链接}
  \FunctionTok{as.character}\NormalTok{(htmltools}\SpecialCharTok{::}\FunctionTok{em}\NormalTok{(}\StringTok{"强调"}\NormalTok{)), }\StringTok{\textquotesingle{}\textless{}a href="\#" onclick="alert(}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{Hello World}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{);"\textgreater{}Hello\textless{}/a\textgreater{}\textquotesingle{}}\NormalTok{,}
  \FunctionTok{as.character}\NormalTok{(htmltools}\SpecialCharTok{::}\FunctionTok{span}\NormalTok{(}\AttributeTok{style =} \StringTok{\textquotesingle{}color:red\textquotesingle{}}\NormalTok{, }\StringTok{"正常"}\NormalTok{)), }\StringTok{\textquotesingle{}正常\textquotesingle{}}
\NormalTok{)}

\FunctionTok{datatable}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ dat,}
  \AttributeTok{escape =}\NormalTok{ F, }\CommentTok{\# 设置 escape = F}
  \AttributeTok{colnames =} \FunctionTok{c}\NormalTok{(}\FunctionTok{colorize\_text}\NormalTok{(}\StringTok{"第1列"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\FunctionTok{as.character}\NormalTok{(htmltools}\SpecialCharTok{::}\FunctionTok{em}\NormalTok{(}\StringTok{"第2列"}\NormalTok{))),}
  \AttributeTok{caption =}\NormalTok{ htmltools}\SpecialCharTok{::}\NormalTok{tags}\SpecialCharTok{$}\FunctionTok{caption}\NormalTok{(}
    \AttributeTok{style =} \StringTok{"caption{-}side: top; text{-}align: center;"}\NormalTok{,}
    \StringTok{"表格 2: "}\NormalTok{, htmltools}\SpecialCharTok{::}\FunctionTok{em}\NormalTok{(}\StringTok{"表格标题"}\NormalTok{)}
\NormalTok{  ), }\CommentTok{\# 在表格底部显示标题，默认在表格上方显示标题}
  \CommentTok{\# filter = "top", \# 过滤框}
  \AttributeTok{options =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{pageLength =} \DecValTok{5}\NormalTok{, }\CommentTok{\# 每页显示5行}
    \AttributeTok{dom =} \StringTok{"t"}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

下面重点介绍 reactable 包，看看 React.js 和 Shiny 是如何集成的，这是比较高级的主题，主要参考 \href{https://github.com/alandipert}{Alan Dipert} 的演讲材料 \href{https://rstudio.com/resources/rstudioconf-2019/integrating-react-js-and-shiny/}{Integrating React.js and Shiny}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(reactable) }
\end{Highlighting}
\end{Shaded}

下面这个例子来自 React.js 官网 \url{https://reactjs.org/}

\begin{Shaded}
\begin{Highlighting}[]
\InformationTok{\textasciigrave{}\textasciigrave{}\textasciigrave{}js}
\KeywordTok{class}\NormalTok{ HelloMessage }\KeywordTok{extends}\NormalTok{ React}\OperatorTok{.}\AttributeTok{Component}\NormalTok{ \{}
  \FunctionTok{render}\NormalTok{() \{}
    \ControlFlowTok{return}\NormalTok{ (}
      \OperatorTok{\textless{}}\NormalTok{div}\OperatorTok{\textgreater{}}
\NormalTok{        Hello \{}\KeywordTok{this}\OperatorTok{.}\AttributeTok{props}\OperatorTok{.}\AttributeTok{name}\NormalTok{\}}
      \OperatorTok{\textless{}/}\NormalTok{div}\OperatorTok{\textgreater{}}
\NormalTok{    )}\OperatorTok{;}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{ReactDOM}\OperatorTok{.}\FunctionTok{render}\NormalTok{(}
  \OperatorTok{\textless{}}\NormalTok{HelloMessage name}\OperatorTok{=}\StringTok{"Taylor"} \OperatorTok{/\textgreater{},}
  \BuiltInTok{document}\OperatorTok{.}\FunctionTok{getElementById}\NormalTok{(}\StringTok{\textquotesingle{}hello{-}example\textquotesingle{}}\NormalTok{)}
\NormalTok{)}\OperatorTok{;}
\VerbatimStringTok{\textasciigrave{}\textasciigrave{}\textasciigrave{}}
\end{Highlighting}
\end{Shaded}

更多细节定制见 Thomas Mock 的博文 \href{https://themockup.blog/posts/2020-05-13-reactable-tables-the-rest-of-the-owl/}{reactable - An Interactive Tables Guide}

reactable 制作表格

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(reactable)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{fluidPage}\NormalTok{(}
  \FunctionTok{reactableOutput}\NormalTok{(}\StringTok{"table"}\NormalTok{)}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{table }\OtherTok{\textless{}{-}} \FunctionTok{renderReactable}\NormalTok{(\{}
    \FunctionTok{reactable}\NormalTok{(iris,}
      \AttributeTok{filterable =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 过滤}
      \AttributeTok{searchable =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 搜索}
      \AttributeTok{showPageSizeOptions =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 页面大小}
      \AttributeTok{pageSizeOptions =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{), }\CommentTok{\# 页面大小可选项}
      \AttributeTok{defaultPageSize =} \DecValTok{10}\NormalTok{, }\CommentTok{\# 默认显示10行}
      \AttributeTok{highlight =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 高亮选择}
      \AttributeTok{striped =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 隔行高亮}
      \AttributeTok{fullWidth =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 默认不要全宽填充，适应数据框的宽度}
      \AttributeTok{defaultSorted =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{Sepal.Length =} \StringTok{"asc"}\NormalTok{, }\CommentTok{\# 由小到大排序}
        \AttributeTok{Petal.Length =} \StringTok{"desc"} \CommentTok{\# 由大到小}
\NormalTok{      ),}
      \AttributeTok{columns =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{Sepal.Width =} \FunctionTok{colDef}\NormalTok{(}\AttributeTok{style =} \ControlFlowTok{function}\NormalTok{(value) \{ }\CommentTok{\# Sepal.Width 添加颜色标记}
          \ControlFlowTok{if}\NormalTok{ (value }\SpecialCharTok{\textgreater{}} \FloatTok{3.5}\NormalTok{) \{}
\NormalTok{            color }\OtherTok{\textless{}{-}} \StringTok{"\#008000"}
\NormalTok{          \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (value }\SpecialCharTok{\textgreater{}} \DecValTok{2}\NormalTok{) \{}
\NormalTok{            color }\OtherTok{\textless{}{-}} \StringTok{"\#e00000"}
\NormalTok{          \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{            color }\OtherTok{\textless{}{-}} \StringTok{"\#777"}
\NormalTok{          \}}
          \FunctionTok{list}\NormalTok{(}\AttributeTok{color =}\NormalTok{ color, }\AttributeTok{fontWeight =} \StringTok{"bold"}\NormalTok{)}
\NormalTok{        \})}

\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  \})}
\NormalTok{\}}

\FunctionTok{shinyApp}\NormalTok{(ui, server)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 修改自 Code: https://gist.github.com/jthomasmock/f085dce3e70e42ca49b052bbe25de49f}
\FunctionTok{library}\NormalTok{(reactable)}
\FunctionTok{library}\NormalTok{(htmltools)}

\CommentTok{\# barchart function from: https://glin.github.io/reactable/articles/building{-}twitter{-}followers.html}
\NormalTok{bar\_chart }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, }\AttributeTok{width =} \StringTok{"100\%"}\NormalTok{, }\AttributeTok{height =} \StringTok{"14px"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"\#00bfc4"}\NormalTok{, }\AttributeTok{background =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  bar }\OtherTok{\textless{}{-}} \FunctionTok{div}\NormalTok{(}\AttributeTok{style =} \FunctionTok{list}\NormalTok{(}\AttributeTok{background =}\NormalTok{ fill, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height))}
\NormalTok{  chart }\OtherTok{\textless{}{-}} \FunctionTok{div}\NormalTok{(}\AttributeTok{style =} \FunctionTok{list}\NormalTok{(}\AttributeTok{flexGrow =} \DecValTok{1}\NormalTok{, }\AttributeTok{marginLeft =} \StringTok{"6px"}\NormalTok{, }\AttributeTok{background =}\NormalTok{ background), bar)}
  \FunctionTok{div}\NormalTok{(}\AttributeTok{style =} \FunctionTok{list}\NormalTok{(}\AttributeTok{display =} \StringTok{"flex"}\NormalTok{, }\AttributeTok{alignItems =} \StringTok{"center"}\NormalTok{), label, chart)}
\NormalTok{\}}

\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{subset}\NormalTok{(}\AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"mpg"}\NormalTok{)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{subset}\NormalTok{(}\AttributeTok{subset =} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{), }\AttributeTok{size =} \DecValTok{6}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T))}


\FunctionTok{reactable}\NormalTok{(}
\NormalTok{  data,}
  \AttributeTok{defaultPageSize =} \DecValTok{20}\NormalTok{,}
  \AttributeTok{columns =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{cyl =} \FunctionTok{colDef}\NormalTok{(}\AttributeTok{align =} \StringTok{"center"}\NormalTok{),}
    \AttributeTok{mpg =} \FunctionTok{colDef}\NormalTok{(}
      \AttributeTok{name =} \StringTok{"mpg"}\NormalTok{,}
      \AttributeTok{defaultSortOrder =} \StringTok{"desc"}\NormalTok{,}
      \AttributeTok{minWidth =} \DecValTok{250}\NormalTok{,}
      \AttributeTok{cell =} \ControlFlowTok{function}\NormalTok{(value, index) \{}
\NormalTok{        width }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(value }\SpecialCharTok{*} \DecValTok{100} \SpecialCharTok{/} \FunctionTok{max}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{mpg), }\StringTok{"\%"}\NormalTok{)}
\NormalTok{        value }\OtherTok{\textless{}{-}} \FunctionTok{format}\NormalTok{(value, }\AttributeTok{width =} \DecValTok{9}\NormalTok{, }\AttributeTok{justify =} \StringTok{"right"}\NormalTok{, }\AttributeTok{nsmall =} \DecValTok{1}\NormalTok{)}
        
        \CommentTok{\# output the value of another column }
        \CommentTok{\# that aligns with current value}
\NormalTok{        cyl\_val }\OtherTok{\textless{}{-}}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{cyl[index]}

        \CommentTok{\# Color based on the row\textquotesingle{}s cyl value}
\NormalTok{        color\_fill }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (cyl\_val }\SpecialCharTok{==} \DecValTok{4}\NormalTok{) \{}
          \StringTok{"\#3686d3"} \CommentTok{\# blue}
\NormalTok{        \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (cyl\_val }\SpecialCharTok{==} \DecValTok{6}\NormalTok{) \{}
          \StringTok{"\#88398a"} \CommentTok{\# purple}
\NormalTok{        \} }\ControlFlowTok{else}\NormalTok{ \{}
          \StringTok{"\#fcab27"} \CommentTok{\# orange}
\NormalTok{        \}}
        \FunctionTok{bar\_chart}\NormalTok{(value, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{fill =}\NormalTok{ color\_fill, }\AttributeTok{background =} \StringTok{"\#e1e1e1"}\NormalTok{)}
\NormalTok{      \},}
      \AttributeTok{align =} \StringTok{"left"}\NormalTok{,}
      \AttributeTok{style =} \FunctionTok{list}\NormalTok{(}\AttributeTok{fontFamily =} \StringTok{"monospace"}\NormalTok{, }\AttributeTok{whiteSpace =} \StringTok{"pre"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-gt-kableExtra}{%
\section{gt 和 kableExtra}\label{sec-gt-kableExtra}}

如表 \ref{tab:kable-styles} 所示，我们可以自定义表格样式，比如配色，例子修改自 kableExtra 帮助文档 \url{https://haozhu233.github.io/kableExtra/bookdown/cross-format-tables-in-bookdown.html}，同时支持 HTML 和 LaTeX 输出， 但是 LaTeX 输出需要在文档类选项中增加 table 选项，即 \texttt{classoption:\ "table"}，这样就可以加载 colortbl 宏包，进而提供 \texttt{\textbackslash{}rowcolor} 等 LaTeX 命令，在表格中给每个格子定制颜色。我们推荐在 classoption 中添加 table 选项，而不是再次加载 xcolor 包，比如像这样 \texttt{\textbackslash{}usepackage{[}table{]}\{xcolor\}}，这会在 R Markdown 中引起冲突 \footnote{\url{https://stackoverflow.com/questions/50094698/rmarkdown-beamer-presentation-option-clash-clash-for-xcolor}}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(kableExtra)}

\NormalTok{iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, ] }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{Sepal.Length =}
      \FunctionTok{cell\_spec}\NormalTok{(Sepal.Length,}
        \AttributeTok{bold =}\NormalTok{ T,}
        \AttributeTok{color =} \FunctionTok{spec\_color}\NormalTok{(Sepal.Length, }\AttributeTok{end =} \FloatTok{0.9}\NormalTok{),}
        \AttributeTok{font\_size =} \FunctionTok{spec\_font\_size}\NormalTok{(Sepal.Length)}
\NormalTok{      )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{Species =} \FunctionTok{cell\_spec}\NormalTok{(}
\NormalTok{    Species,}
    \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{bold =}\NormalTok{ T,}
    \AttributeTok{background =} \FunctionTok{spec\_color}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{,}
      \AttributeTok{end =} \FloatTok{0.9}\NormalTok{,}
      \AttributeTok{option =} \StringTok{"A"}\NormalTok{, }\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}
\NormalTok{    )}
\NormalTok{  )) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{kable}\NormalTok{(}
    \AttributeTok{escape =}\NormalTok{ F, }\AttributeTok{align =} \StringTok{"c"}\NormalTok{, }\AttributeTok{booktabs =}\NormalTok{ T,}
    \AttributeTok{caption =} \StringTok{"自定义表格样式"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{kable\_styling}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"striped"}\NormalTok{, }\StringTok{"condensed"}\NormalTok{),}
    \AttributeTok{latex\_options =} \StringTok{"striped"}\NormalTok{,}
    \AttributeTok{full\_width =}\NormalTok{ F}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:kable-styles}自定义表格样式}
\centering
\begin{tabular}[t]{ccccc}
\toprule
Sepal.Length & Sepal.Width & Petal.Length & Petal.Width & Species\\
\midrule
\cellcolor{gray!6}{\bgroup\fontsize{14}{16}\selectfont \textcolor[HTML]{28AE80}{\textbf{5.1}}\egroup{}} & \cellcolor{gray!6}{3.5} & \cellcolor{gray!6}{1.4} & \cellcolor{gray!6}{0.2} & \cellcolor{gray!6}{\textcolor{white}{\textbf{setosa}}}\\
\bgroup\fontsize{12}{14}\selectfont \textcolor[HTML]{25838E}{\textbf{4.9}}\egroup{} & 3.0 & 1.4 & 0.2 & \cellcolor[HTML]{FEA06D}{\textcolor{white}{\textbf{setosa}}}\\
\cellcolor{gray!6}{\bgroup\fontsize{10}{12}\selectfont \textcolor[HTML]{39578C}{\textbf{4.7}}\egroup{}} & \cellcolor{gray!6}{3.2} & \cellcolor{gray!6}{1.3} & \cellcolor{gray!6}{0.2} & \cellcolor{gray!6}{\textcolor{white}{\textbf{setosa}}}\\
\bgroup\fontsize{10}{12}\selectfont \textcolor[HTML]{433E85}{\textbf{4.6}}\egroup{} & 3.1 & 1.5 & 0.2 & \cellcolor[HTML]{DE4968}{\textcolor{white}{\textbf{setosa}}}\\
\cellcolor{gray!6}{\bgroup\fontsize{13}{15}\selectfont \textcolor[HTML]{1F9A8A}{\textbf{5}}\egroup{}} & \cellcolor{gray!6}{3.6} & \cellcolor{gray!6}{1.4} & \cellcolor{gray!6}{0.2} & \cellcolor{gray!6}{\textcolor{white}{\textbf{setosa}}}\\
\addlinespace
\bgroup\fontsize{16}{18}\selectfont \textcolor[HTML]{BBDF27}{\textbf{5.4}}\egroup{} & 3.9 & 1.7 & 0.4 & \cellcolor[HTML]{8C2981}{\textcolor{white}{\textbf{setosa}}}\\
\cellcolor{gray!6}{\bgroup\fontsize{10}{12}\selectfont \textcolor[HTML]{433E85}{\textbf{4.6}}\egroup{}} & \cellcolor{gray!6}{3.4} & \cellcolor{gray!6}{1.4} & \cellcolor{gray!6}{0.3} & \cellcolor{gray!6}{\textcolor{white}{\textbf{setosa}}}\\
\bgroup\fontsize{13}{15}\selectfont \textcolor[HTML]{1F9A8A}{\textbf{5}}\egroup{} & 3.4 & 1.5 & 0.2 & \cellcolor[HTML]{3C0F70}{\textcolor{white}{\textbf{setosa}}}\\
\cellcolor{gray!6}{\bgroup\fontsize{8}{10}\selectfont \textcolor[HTML]{440154}{\textbf{4.4}}\egroup{}} & \cellcolor{gray!6}{2.9} & \cellcolor{gray!6}{1.4} & \cellcolor{gray!6}{0.2} & \cellcolor{gray!6}{\textcolor{white}{\textbf{setosa}}}\\
\bgroup\fontsize{12}{14}\selectfont \textcolor[HTML]{25838E}{\textbf{4.9}}\egroup{} & 3.1 & 1.5 & 0.1 & \cellcolor[HTML]{000004}{\textcolor{white}{\textbf{setosa}}}\\
\bottomrule
\end{tabular}
\end{table}

一个非常基本的 gt 制作的表格

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gt)}
\NormalTok{iris }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{head}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{gt}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

然后添加表格的标题和副标题，套上 \texttt{md()} 函数后，标题和副标题支持 Markdown 语法，告别 HTML 的制表方式吧！其它表格元素，如脚注支持和表格的列指标关联

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}

\NormalTok{iris }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  as.data.table }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[, }\FunctionTok{head}\NormalTok{(.SD, }\DecValTok{2}\NormalTok{), by }\OtherTok{=}\NormalTok{ .(Species)] }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{gt}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_header}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{md}\NormalTok{(}\StringTok{"**鸢尾花**数据集"}\NormalTok{),}
    \AttributeTok{subtitle =} \StringTok{"R 内置数据集"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{data\_color}\NormalTok{(}
    \AttributeTok{columns =} \FunctionTok{vars}\NormalTok{(Sepal.Length),}
    \AttributeTok{colors =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{col\_numeric}\NormalTok{(}\AttributeTok{palette =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{5}\NormalTok{, }\AttributeTok{rev =}\NormalTok{ T), }\AttributeTok{domain =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{data\_color}\NormalTok{(}
    \AttributeTok{columns =} \FunctionTok{vars}\NormalTok{(Species),}
    \AttributeTok{colors =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{col\_factor}\NormalTok{(}\AttributeTok{palette =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{3}\NormalTok{), }\AttributeTok{domain =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_footnote}\NormalTok{(}
    \AttributeTok{footnote =} \FunctionTok{md}\NormalTok{(}\StringTok{"据说数据集最早收集自 Fisher\textquotesingle{}s or Anderson\textquotesingle{}s"}\NormalTok{),}
    \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{vars}\NormalTok{(Sepal.Length))}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_footnote}\NormalTok{(}
    \AttributeTok{footnote =} \StringTok{"鸢尾花的类别"}\NormalTok{,}
    \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{(}
      \AttributeTok{columns =} \FunctionTok{vars}\NormalTok{(Species)}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

更多细节的设置见 Thomas Mock 的博文\href{https://themockup.blog/posts/2020-05-16-gt-a-grammer-of-tables/}{gt - a (G)rammar of (T)ables}

\begin{rmdnote}{注意}
当前 gt 包对 LaTeX 的支持比较弱，上述表格在 HTML 网页环境中可以看到的效果并不能一一对应到 LaTeX 输出中。且 gt 包生成 LaTeX 表格会自动加载宏包 amsmath、booktabs、caption 和 longtable， \texttt{gt\_latex\_dependencies()} 且不能控制

\end{rmdnote}

\hypertarget{sec-table-session}{%
\section{运行环境}\label{sec-table-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] kableExtra_1.3.4 reactable_0.2.3  DT_0.19          magrittr_2.0.1  
## 
## loaded via a namespace (and not attached):
##  [1] rstudioapi_0.13   knitr_1.36        xml2_1.3.2        munsell_0.5.0    
##  [5] rvest_1.0.1       viridisLite_0.4.0 colorspace_2.0-2  R6_2.5.1         
##  [9] rlang_0.4.11      fastmap_1.1.0     stringr_1.4.0     httr_1.4.2       
## [13] tools_4.1.1       webshot_0.5.2     xfun_0.26         systemfonts_1.0.2
## [17] htmltools_0.5.2   yaml_2.2.1        digest_0.6.28     lifecycle_1.0.1  
## [21] bookdown_0.24     htmlwidgets_1.5.4 curl_4.3.2        glue_1.4.2       
## [25] evaluate_0.14     rmarkdown_2.11    stringi_1.7.4     compiler_4.1.1   
## [29] scales_1.1.1      svglite_2.0.0
\end{verbatim}

\hypertarget{chap-interactive-shiny-app}{%
\chapter{交互报表}\label{chap-interactive-shiny-app}}

学习 shiny 应用开发，建议多看看 \href{https://shiny.rstudio.com/tutorial/}{Learn Shiny}。 了解 shiny server ，推荐从 \href{https://docs.rstudio.com/shiny-server/}{Shiny Server Professional Administrator's Guide} 开始。了解 shiny 相关的生态，建议从 shiny 资源列表 \url{https://github.com/grabear/awesome-rshiny} 和 shiny 扩展合集 \url{https://github.com/nanxstats/awesome-shiny-extensions} 开始，希望读者能从中打造属于自己的最佳实践。

RStudio 首席技术官 CTO Joe Cheng 在 2019年 RStudio 大会上介绍 \href{https://resources.rstudio.com/rstudio-conf-2019/shiny-in-production-principles-practices-and-tools-joe-cheng}{企业级 shiny 应用 原理、实践和工具} 可以作为 shiny 从新技术到生产力的蜕变节点。支持高并发的异步编程，比如 Heather Nolis 和 Dr.~Jacqueline Nolis 的报告介绍了日百万访问量下的 shiny 应用如何搭建\footnote{\url{https://resources.rstudio.com/rstudio-conf-2020/we-re-hitting-r-a-million-times-a-day-so-we-made-a-talk-about-it-heather-nolis-dr-jacqueline-nolis}}。 Colin Fay, Sébastien Rochette, Vincent Guyader, Cervan Girard 的书 \href{https://engineering-shiny.org/}{Engineering Production-Grade Shiny Apps}、David Granjon 的书\href{https://unleash-shiny.rinterface.com/}{Outstanding User Interfaces with Shiny} 和 Hadley Wickham 的书 \href{https://mastering-shiny.org/}{Mastering Shiny} 的问世宣告 shiny 的成熟稳定，以及生态的形成，在此之前 shiny 一直不被看好。shiny 生态意味着一个完整的工业级的应用圈，满足安全性、稳定性、高效性、维护性、扩展性的要求。

\begin{figure}

{\centering \includegraphics[width=10.31in]{screenshots/shiny-app} 

}

\caption{Shiny 生态系统}\label{fig:shiny-ecosystem}
\end{figure}

iSEE is winner of the Most Technically Impressive award of the 2019 Shiny Contest. 源码地址 \url{https://github.com/iSEE/isee-shiny-contest}

Six Years of Shiny in Research - Collaborative Development of Web Tools in R \citep{RJ-2021-004}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{diagrams/shiny-org} 

}

\caption{开发 Shiny 应用扩展的组织}\label{fig:shiny-org}
\end{figure}

以 RStudio 为核心，开发 Shiny 应用扩展的社区组织有 \href{https://github.com/rstudio}{RStudio}、\href{https://github.com/Appsilon}{Appsilon}、\href{https://github.com/RinteRface}{RinteRface}、\href{https://github.com/ThinkR-open}{ThinkR-open}、\href{https://github.com/dreamRs}{dreamRs} 和\href{https://github.com/datastorm-open}{datastorm-open}

\hypertarget{sec-dev-workflow}{%
\section{开发流程}\label{sec-dev-workflow}}

报表开发从数据仓库的 DWD 层开始，可能一些业务原因，我们需要从 ODS 层甚至从点击流的日志数据开始，经过数据清洗、提取、聚合成为支撑BI报表最底层的基础表，存储在 Hive 中，然后对这一系列的基础表根据BI展示的需要进行第二层聚合形成中间表，这两层数据根据业务情况做增量更新或者全量更新，并将中间表同步到 MySQL 仓库中，全量更新的情况，往往更新数据比较大，建议用 sqoop 做数据的同步。创建第二层的中间表稍有些灵活性，原则是在中间表之上对应的数据操作和可视化是容易实现且效率较高的，否则应该构造第三层的中间表，绝不能将大规模的数据集直接导入 R 中进行分析和可视化，拖慢前端展示的速度，占用过多的服务器资源。

\hypertarget{sec-dev-tools}{%
\section{开发工具}\label{sec-dev-tools}}

除了在第 \ref{sec-dev-workflow} 节介绍的和数据库紧密相关的工具外，我们还需要 Git 做代码管理， Azkaban 做任务调度 （或者其它工具做任务调度器），RStudio IDE 做开发工具（或者 VS Code 等）， Shiny Server 做报表支撑，做报表管理。具体到 shiny 页面开发，我们需要：

\begin{itemize}
\tightlist
\item
  RMySQL 做数据库连接，推荐 odbc 这个包，它支持连接相当广泛的数据库。
\item
  data.table 或者 dplyr 做数据操作，推荐和管道操作 magrittr 一起使用，增加代码可读性。
\item
  plotly 或者 highcharter 做数据可视化，reactable 和 DT 做数据呈现，也可以 \href{https://github.com/tidyverse/ggplot2}{ggplot2} 和 \href{https://github.com/ropensci/plotly}{plotly} 的 \texttt{ggplotly()} 函数共同实现静态图到动态图的交互可视化。
\item
  \href{https://rstudio.github.io/shiny}{shiny} 及其扩展工具做页面设计，比如 shinythemes 可以统一配色，\href{https://github.com/nik01010/dashboardthemes}{dashboardthemes} 提供更加深度的主题，\href{https://github.com/rstudio/shinytableau}{shinytableau} 提供仿 \href{https://www.tableau.com/}{Tableau} 的 dashboard 框架。\href{https://github.com/rstudio/sass}{sass} 在 CSS 样式层面重定义网站风格，比如\href{https://resources.rstudio.com/rstudio-conf-2020/styling-shiny-apps-with-sass-and-bootstrap-4-joe-cheng}{借助 sass 修改 Bootstrap 4}， shiny 的布局其实就是魔改了 Bootstrap 库。
\item
  针对特定应用场景的其它交互可视化工具包，比如 \href{https://github.com/rstudio/leaflet}{leaflet} 可以将地图嵌入 Shiny 应用， \href{https://github.com/rstudio/dygraphs}{dygraphs} 可以将时间序列塞进去。
\item
  其它加强 shiny 页面的小功能，比如 \href{https://github.com/merlinoa/shinyFeedback}{shinyFeedback} 提供用户输入的反馈，\href{https://github.com/rstudio/miniUI}{miniUI} 专为小屏幕设计，\href{https://github.com/RinteRface/shinyMobile}{shinyMobile} 在 IOS 和安卓手机上访问 shiny 应用，大大加强 miniUI 的功能，\href{https://github.com/dreamRs/shinyWidgets}{shinyWidgets} 提供自定义 widget 的功能，\href{https://github.com/datastorm-open/shinymanager}{shinymanager} 支持单个 shiny 应用的权限管理，\href{https://github.com/JohnCoene/firebase}{firebase} 提供访问权限设置 \url{https://firebase.john-coene.com/}。
\item
  \href{https://github.com/rstudio/shiny-server}{shiny-server} 以网络服务的方式支持 shiny 应用，是企业级 shiny 应用的核心， \href{https://github.com/openanalytics/shinyproxy}{shinyproxy} 提供企业级部署 shiny 应用的开源解决方案，\href{https://github.com/clevr-dev/ShinyStudio}{ShinyStudio} 打造基于容器架构的协作开发环境的开源解决方案，\href{https://github.com/ThinkR-open/golem}{golem} 构建企业级 shiny 应用的框架，\href{https://github.com/RinteRface}{RinteRface} 开发的系列 R 包也试图打造一套完整的解决方案，并配有速查小抄 \href{https://github.com/RinteRface/cheatsheets}{cheatsheets}
\item
  \href{https://github.com/radiant-rstats/radiant}{radiant} 探索性分析解决方案
\end{itemize}

\href{https://github.com/paulc91/shinyauthr}{shinyauthr} 应用授权

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-foundations}{%
\section{基础知识}\label{sec-foundations}}

\href{https://xiangyun.shinyapps.io/masr-cars/}{1920s 汽车数据分析和建模}

\hypertarget{sec-shiny-elements}{%
\section{基础组件}\label{sec-shiny-elements}}

\hypertarget{subsec-bookmark}{%
\subsection{书签}\label{subsec-bookmark}}

链接可以指向页面状态

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(request) \{}
  \FunctionTok{fluidPage}\NormalTok{(}
    \FunctionTok{plotOutput}\NormalTok{(}\StringTok{"plot"}\NormalTok{),}
    \FunctionTok{sliderInput}\NormalTok{(}\StringTok{"n"}\NormalTok{, }\StringTok{"Number of observations"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(faithful), }\DecValTok{100}\NormalTok{),}
    \FunctionTok{bookmarkButton}\NormalTok{()}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output, session) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{renderPlot}\NormalTok{(\{}
    \FunctionTok{hist}\NormalTok{(faithful}\SpecialCharTok{$}\NormalTok{eruptions[}\FunctionTok{seq\_len}\NormalTok{(input}\SpecialCharTok{$}\NormalTok{n)], }\AttributeTok{breaks =} \DecValTok{40}\NormalTok{)}
\NormalTok{  \})}
\NormalTok{\}}

\FunctionTok{enableBookmarking}\NormalTok{(}\AttributeTok{store =} \StringTok{"url"}\NormalTok{)}
\FunctionTok{shinyApp}\NormalTok{(ui, server)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-shiny-tables}{%
\subsection{表格}\label{subsec-shiny-tables}}

\href{https://github.com/glin/reactable}{reactable} 基于 JS 库 \href{https://github.com/tannerlinsley/react-table}{React Table} 提供交互式表格渲染，和 shiny 无缝集成，是替代 DT 的不二选择，在 app.R 用 reactable 包的 \texttt{reactableOutput()} 和 \texttt{renderReactable()} 函数替代 shiny 里面的 \texttt{dataTableOutput()} 和 \texttt{renderDataTable()}。 再也不用忍受 DT 和 shiny 的函数冲突了，且其覆盖测试达到 99\%。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(data.table)}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/rstudio/gt}{gt} 高度自定义 gt 表格样式，支持 shiny 集成， \href{https://github.com/Rdatatable/data.table}{data.table} 提供高效的数据操作，\href{https://github.com/renkun-ken/formattable}{formattable} 支持自定义格子。

kableExtra 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{library}\NormalTok{(kableExtra)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{fluidPage}\NormalTok{(}
  \AttributeTok{title =} \StringTok{"mtcars datasets"}\NormalTok{,}
  \FunctionTok{titlePanel}\NormalTok{(}\StringTok{"mtcars 数据集"}\NormalTok{),}

  \FunctionTok{sidebarLayout}\NormalTok{(}
    \FunctionTok{sidebarPanel}\NormalTok{(}
      \FunctionTok{sliderInput}\NormalTok{(}\StringTok{"mpg"}\NormalTok{, }\StringTok{"mpg 范围"}\NormalTok{,}
        \AttributeTok{min =} \DecValTok{11}\NormalTok{, }\AttributeTok{max =} \DecValTok{33}\NormalTok{, }\AttributeTok{value =} \DecValTok{15}
\NormalTok{      )}
\NormalTok{    ),}

    \FunctionTok{mainPanel}\NormalTok{(}
      \FunctionTok{tableOutput}\NormalTok{(}\StringTok{"mtcars\_kable"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{)}

\DocumentationTok{\#\# 设置列序 https://stackoverflow.com/questions/19619666/change{-}column{-}position{-}of{-}data{-}table}
\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{mtcars\_kable }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
    \CommentTok{\# 转化数据类型}
\NormalTok{    mtcars\_dt }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(mtcars)}
    \CommentTok{\# 添加新的列}
\NormalTok{    mtcars\_dt[, car }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{rownames}\NormalTok{(mtcars)][mpg }\SpecialCharTok{\textless{}=}\NormalTok{ input}\SpecialCharTok{$}\NormalTok{mpg] }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{setcolorder}\NormalTok{(., }\FunctionTok{c}\NormalTok{(}\StringTok{"car"}\NormalTok{, }\FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(.), }\StringTok{"car"}\NormalTok{))) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(}\StringTok{"html"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{kable\_styling}\NormalTok{(}\StringTok{"striped"}\NormalTok{, }\AttributeTok{full\_width =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{add\_header\_above}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{"Group 1"} \OtherTok{=} \DecValTok{5}\NormalTok{, }\StringTok{"Group 2"} \OtherTok{=} \DecValTok{6}\NormalTok{))}
\NormalTok{  \}}
\NormalTok{\}}

\CommentTok{\# 执行程序}
\FunctionTok{shinyApp}\NormalTok{(}\AttributeTok{ui =}\NormalTok{ ui, }\AttributeTok{server =}\NormalTok{ server)}
\end{Highlighting}
\end{Shaded}

reactable 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(reactable)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{fluidPage}\NormalTok{(}
  \FunctionTok{reactableOutput}\NormalTok{(}\StringTok{"table"}\NormalTok{)}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{table }\OtherTok{\textless{}{-}} \FunctionTok{renderReactable}\NormalTok{(\{}
    \FunctionTok{reactable}\NormalTok{(iris,}
      \AttributeTok{filterable =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 过滤}
      \AttributeTok{searchable =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 搜索}
      \AttributeTok{showPageSizeOptions =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 页面大小}
      \AttributeTok{pageSizeOptions =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{), }\CommentTok{\# 页面大小可选项}
      \AttributeTok{defaultPageSize =} \DecValTok{10}\NormalTok{, }\CommentTok{\# 默认显示10行}
      \AttributeTok{highlight =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 高亮选择}
      \AttributeTok{striped =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 隔行高亮}
      \AttributeTok{fullWidth =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 默认不要全宽填充，适应数据框的宽度}
      \AttributeTok{defaultSorted =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{Sepal.Length =} \StringTok{"asc"}\NormalTok{, }\CommentTok{\# 由小到大排序}
        \AttributeTok{Petal.Length =} \StringTok{"desc"} \CommentTok{\# 由大到小}
\NormalTok{      ),}
      \AttributeTok{columns =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{Sepal.Width =} \FunctionTok{colDef}\NormalTok{(}\AttributeTok{style =} \ControlFlowTok{function}\NormalTok{(value) \{ }\CommentTok{\# Sepal.Width 添加颜色标记}
          \ControlFlowTok{if}\NormalTok{ (value }\SpecialCharTok{\textgreater{}} \FloatTok{3.5}\NormalTok{) \{}
\NormalTok{            color }\OtherTok{\textless{}{-}} \StringTok{"\#008000"}
\NormalTok{          \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (value }\SpecialCharTok{\textgreater{}} \DecValTok{2}\NormalTok{) \{}
\NormalTok{            color }\OtherTok{\textless{}{-}} \StringTok{"\#e00000"}
\NormalTok{          \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{            color }\OtherTok{\textless{}{-}} \StringTok{"\#777"}
\NormalTok{          \}}
          \FunctionTok{list}\NormalTok{(}\AttributeTok{color =}\NormalTok{ color, }\AttributeTok{fontWeight =} \StringTok{"bold"}\NormalTok{) }\CommentTok{\# 字体加粗}
\NormalTok{        \})}

\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  \})}
\NormalTok{\}}

\FunctionTok{shinyApp}\NormalTok{(ui, server)}
\end{Highlighting}
\end{Shaded}

下面介绍 DT

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\CommentTok{\# ui.R 前端}
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{shinyUI}\NormalTok{(}\FunctionTok{fluidPage}\NormalTok{(}
  \CommentTok{\# 应用的标题名称}
  \FunctionTok{titlePanel}\NormalTok{(}\StringTok{"鸢尾花数据集"}\NormalTok{),}
  \CommentTok{\# 边栏}
  \FunctionTok{fluidRow}\NormalTok{(}
    \FunctionTok{column}\NormalTok{(}
      \DecValTok{12}\NormalTok{,}
\NormalTok{      DT}\SpecialCharTok{::}\FunctionTok{dataTableOutput}\NormalTok{(}\StringTok{"table"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{))}

\CommentTok{\# server.R 服务端}
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{shinyServer}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{table }\OtherTok{\textless{}{-}}\NormalTok{ iris }\SpecialCharTok{\%\textgreater{}\%}
    \StringTok{\textasciigrave{}}\AttributeTok{colnames\textless{}{-}}\StringTok{\textasciigrave{}}\NormalTok{(., }\FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{tolower}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(.)))) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{    DT}\SpecialCharTok{::}\FunctionTok{renderDataTable}\NormalTok{(.,}
      \AttributeTok{options =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{pageLength =} \DecValTok{5}\NormalTok{, }\CommentTok{\# 每页显示5行}
        \AttributeTok{initComplete =} \FunctionTok{I}\NormalTok{(}\StringTok{"function(settings, json) \{alert(\textquotesingle{}Done.\textquotesingle{});\}"}\NormalTok{)}
\NormalTok{      ), }\AttributeTok{server =}\NormalTok{ F}
\NormalTok{    )}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{rmdnote}{注意}
加载 shiny 包后再加载 DT 包，函数 \texttt{dataTableOutput()} 和\texttt{renderDataTable()} 显示冲突，因为两个 R 包都有这两个函数。在创建 shiny 应用的过程中，如果我们需要呈现动态表格，就需要使用 DT 包的 \texttt{DT::dataTableOutput()} 和 \texttt{DT::renderDataTable()} 否则会报错，详见 \url{https://github.com/rstudio/shiny/issues/2653}，DT 包官方文档 \url{https://rstudio.github.io/DT/}。

\end{rmdnote}

\begin{rmdtip}{提示}
在 server.R 里我们对数据集 iris 做了重命列名的操作，如果不使用管道操作，通常是下面这样操作。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{colnames}\NormalTok{(iris) }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{tolower}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(iris)))}
\end{Highlighting}
\end{Shaded}

换成管道操作，函数 \texttt{colnames()} 要换成 \texttt{colnames\textless{}-}，这其实类似于 \texttt{1\ +\ 2} 换成 \texttt{+}(1, 2)，保持函数在左边，参数值在右边的一致性。

\end{rmdtip}

设置页面默认显示的行数和列的宽度

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://stackoverflow.com/questions/45509501/set{-}names{-}of{-}values{-}in{-}lengthmenu{-}page{-}length{-}menu{-}in{-}r{-}dt{-}datatable}
\CommentTok{\# 相关例子见 https://github.com/rstudio/shiny{-}examples/tree/master/018{-}datatable{-}options}
\CommentTok{\# DT 选项 https://rstudio.github.io/DT/options.html}

\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(DT)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{fluidPage}\NormalTok{(}
\NormalTok{  DT}\SpecialCharTok{::}\FunctionTok{dataTableOutput}\NormalTok{(}\StringTok{"table"}\NormalTok{)}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{table }\OtherTok{\textless{}{-}}\NormalTok{ DT}\SpecialCharTok{::}\FunctionTok{renderDataTable}\NormalTok{(\{}
\NormalTok{    DT}\SpecialCharTok{::}\FunctionTok{datatable}\NormalTok{(iris, }\AttributeTok{options =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{language =} \FunctionTok{list}\NormalTok{(}\AttributeTok{url =} \StringTok{"//cdn.datatables.net/plug{-}ins/1.10.11/i18n/Chinese.json"}\NormalTok{),}
      \AttributeTok{pageLength =} \DecValTok{24}\NormalTok{, }\CommentTok{\# 设置页面默认显示的行数}
      \AttributeTok{lengthMenu =} \FunctionTok{list}\NormalTok{(}
        \FunctionTok{c}\NormalTok{(}\DecValTok{24}\NormalTok{, }\DecValTok{48}\NormalTok{, }\DecValTok{72}\NormalTok{, }\DecValTok{96}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{),}
        \FunctionTok{c}\NormalTok{(}\StringTok{"24"}\NormalTok{, }\StringTok{"48"}\NormalTok{, }\StringTok{"72"}\NormalTok{, }\StringTok{"96"}\NormalTok{, }\StringTok{"All"}\NormalTok{)}
\NormalTok{      ),}
      \AttributeTok{paging =}\NormalTok{ T,}
      \CommentTok{\# 设置第一列和第三列的宽度 https://rstudio.github.io/DT/options.html}
      \AttributeTok{autoWidth =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{columnDefs =} \FunctionTok{list}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{width =} \StringTok{\textquotesingle{}400px\textquotesingle{}}\NormalTok{, }\AttributeTok{targets =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{)))}
\NormalTok{    ))}
\NormalTok{  \})}
\NormalTok{\}}

\FunctionTok{shinyApp}\NormalTok{(ui, server)}
\end{Highlighting}
\end{Shaded}

按指定格式显示数据

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data \textless{}{-} data.frame(x = c(100.0011, 80.0011, {-}90.0011, {-}110.0011, {-}70))}
\CommentTok{\#}
\CommentTok{\# library(shiny)}
\CommentTok{\# runApp(list(}
\CommentTok{\#   ui = fluidPage(dataTableOutput("num")),}
\CommentTok{\#   server = function(input, output) \{}
\CommentTok{\#     output$num = renderDataTable(format(round(data, 3), nsmall = 3))}
\CommentTok{\#   \}}
\CommentTok{\# ))}

\FunctionTok{library}\NormalTok{(DT)}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{100.0011}\NormalTok{, }\FloatTok{80.0011}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{90.0011}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{110.0067}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{70}\NormalTok{))}

\NormalTok{rowCallback }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"function(row, data, index)\{"}\NormalTok{,}
  \StringTok{"  var N = data.length;"}\NormalTok{,}
  \StringTok{"  for(var j=1; j\textless{}data.length; j++)\{"}\NormalTok{,}
  \StringTok{"    $(\textquotesingle{}td:eq(\textquotesingle{}+j+\textquotesingle{})\textquotesingle{},row)"}\NormalTok{,}
  \StringTok{"      .html(parseFloat(data[j]).toFixed(3));"}\NormalTok{, }\CommentTok{\# 四舍五入保留 3 位小数}
  \StringTok{"  \}"}\NormalTok{,}
  \StringTok{"\}"}
\NormalTok{)}

\CommentTok{\# https://github.com/rstudio/shiny/issues/2277}
\FunctionTok{datatable}\NormalTok{(dat,}
  \AttributeTok{options =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{rowCallback =} \FunctionTok{JS}\NormalTok{(rowCallback)}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-advanced-topics}{%
\section{高级主题}\label{sec-advanced-topics}}

异步编程，并发访问

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# shiny 异步编程}
\DocumentationTok{\#\# 解决问题，多人同时访问 Shiny 应用的情况下，必须等另一个人完成访问的情况下才能继续访问}

\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(future)}
\FunctionTok{library}\NormalTok{(promises)}

\FunctionTok{plan}\NormalTok{(multiprocess)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{fluidPage}\NormalTok{(}
  \FunctionTok{h2}\NormalTok{(}\StringTok{"测试异步下载"}\NormalTok{),}
\NormalTok{  tags}\SpecialCharTok{$}\FunctionTok{ol}\NormalTok{(}
\NormalTok{    tags}\SpecialCharTok{$}\FunctionTok{li}\NormalTok{(}\StringTok{"Verify that plot appears below"}\NormalTok{),}
\NormalTok{    tags}\SpecialCharTok{$}\FunctionTok{li}\NormalTok{(}\StringTok{"Verify that pressing Download results in 5 second delay, then rock.csv being downloaded"}\NormalTok{),}
\NormalTok{    tags}\SpecialCharTok{$}\FunctionTok{li}\NormalTok{(}\StringTok{"Check \textquotesingle{}Throw on download?\textquotesingle{} checkbox and verify that pressing Download results in 5 second delay, then error, as well as stack traces in console"}\NormalTok{)}
\NormalTok{  ),}
  \FunctionTok{hr}\NormalTok{(),}
  \FunctionTok{checkboxInput}\NormalTok{(}\StringTok{"throw"}\NormalTok{, }\StringTok{"Throw on download?"}\NormalTok{),}
  \FunctionTok{downloadButton}\NormalTok{(}\StringTok{"download"}\NormalTok{, }\StringTok{"下载 (等待5秒)"}\NormalTok{),}
  \FunctionTok{plotOutput}\NormalTok{(}\StringTok{"plot"}\NormalTok{)}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output, session) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{download }\OtherTok{\textless{}{-}} \FunctionTok{downloadHandler}\NormalTok{(}\StringTok{"rock.csv"}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(file) \{}
    \FunctionTok{future}\NormalTok{(\{}\FunctionTok{Sys.sleep}\NormalTok{(}\DecValTok{5}\NormalTok{)\}) }\SpecialCharTok{\%...\textgreater{}\%}
\NormalTok{      \{}
        \ControlFlowTok{if}\NormalTok{ (input}\SpecialCharTok{$}\NormalTok{throw) \{}
          \FunctionTok{stop}\NormalTok{(}\StringTok{"boom"}\NormalTok{)}
\NormalTok{        \} }\ControlFlowTok{else}\NormalTok{ \{}
          \FunctionTok{write.csv}\NormalTok{(rock, file)}
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{  \})}

\NormalTok{  output}\SpecialCharTok{$}\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{renderPlot}\NormalTok{(\{}
    \FunctionTok{plot}\NormalTok{(cars)}
\NormalTok{  \})}
\NormalTok{\}}

\FunctionTok{shinyApp}\NormalTok{(ui, server)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-shiny-deployment}{%
\section{部署应用}\label{sec-shiny-deployment}}

\hypertarget{sec-shiny-principles}{%
\section{最佳实践}\label{sec-shiny-principles}}

\href{https://blog.rstudio.com/2020/07/21/4-tips-to-make-your-shiny-dashboard-faster/}{提升 shiny 仪表盘访问性能的4个建议}

\hypertarget{sec-shiny-dashboard}{%
\section{仪表盘}\label{sec-shiny-dashboard}}

dashboard 翻译过来叫仪表盘，就是驾驶仓的那个玩意，形象地表达作为掌舵者应该关注的对象。R 包 shiny 出现后，仪表盘的制作显得非常容易，也很快形成了一个生态，比如 \href{https://rstudio.github.io/shinydashboard}{shinydashboard}、 \href{https://github.com/rstudio/flexdashboard}{flexdashboard} 等，此外 \href{https://github.com/RinteRface/bs4Dash}{bs4Dash} 基于 Bootstrap 4 的仪表盘，目前 shiny 和 rmarkdown 都在向 Bootstrap 4 升级，这是未来的方向。 \href{https://github.com/RinteRface/shinydashboardPlus}{shinydashboardPlus} 主要目的在于扩展 \textbf{shinydashboard} 包

shinydashboard 包

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# app.R \#\#}
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(shinydashboard)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{dashboardPage}\NormalTok{(}
    \FunctionTok{dashboardHeader}\NormalTok{(}\AttributeTok{title =} \StringTok{"Basic dashboard"}\NormalTok{),}
    \DocumentationTok{\#\# Sidebar content}
    \FunctionTok{dashboardSidebar}\NormalTok{(}
        \FunctionTok{sidebarMenu}\NormalTok{(}
            \FunctionTok{menuItem}\NormalTok{(}\StringTok{"Dashboard"}\NormalTok{, }\AttributeTok{tabName =} \StringTok{"dashboard"}\NormalTok{, }\AttributeTok{icon =} \FunctionTok{icon}\NormalTok{(}\StringTok{"dashboard"}\NormalTok{)),}
            \FunctionTok{menuItem}\NormalTok{(}\StringTok{"Widgets"}\NormalTok{, }\AttributeTok{tabName =} \StringTok{"widgets"}\NormalTok{, }\AttributeTok{icon =} \FunctionTok{icon}\NormalTok{(}\StringTok{"th"}\NormalTok{))}
\NormalTok{        )}
\NormalTok{    ),}
    \DocumentationTok{\#\# Body content}
    \FunctionTok{dashboardBody}\NormalTok{(}
        \FunctionTok{tabItems}\NormalTok{(}
            \CommentTok{\# First tab content}
            \FunctionTok{tabItem}\NormalTok{(}\AttributeTok{tabName =} \StringTok{"dashboard"}\NormalTok{,}
                    \FunctionTok{fluidRow}\NormalTok{(}
                        \FunctionTok{box}\NormalTok{(}\FunctionTok{plotOutput}\NormalTok{(}\StringTok{"plot1"}\NormalTok{, }\AttributeTok{height =} \DecValTok{250}\NormalTok{)),}

                        \FunctionTok{box}\NormalTok{(}
                            \AttributeTok{title =} \StringTok{"Controls"}\NormalTok{,}
                            \FunctionTok{sliderInput}\NormalTok{(}\StringTok{"slider"}\NormalTok{, }\StringTok{"Number of observations:"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{)}
\NormalTok{                        )}
\NormalTok{                    )}
\NormalTok{            ),}

            \CommentTok{\# Second tab content}
            \FunctionTok{tabItem}\NormalTok{(}\AttributeTok{tabName =} \StringTok{"widgets"}\NormalTok{,}
                    \FunctionTok{h2}\NormalTok{(}\StringTok{"Widgets tab content"}\NormalTok{)}
\NormalTok{            )}
\NormalTok{        )}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output) \{}
    \FunctionTok{set.seed}\NormalTok{(}\DecValTok{122}\NormalTok{)}
\NormalTok{    histdata }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{500}\NormalTok{)}

\NormalTok{    output}\SpecialCharTok{$}\NormalTok{plot1 }\OtherTok{\textless{}{-}} \FunctionTok{renderPlot}\NormalTok{(\{}
\NormalTok{        data }\OtherTok{\textless{}{-}}\NormalTok{ histdata[}\FunctionTok{seq\_len}\NormalTok{(input}\SpecialCharTok{$}\NormalTok{slider)]}
        \FunctionTok{hist}\NormalTok{(data)}
\NormalTok{    \})}
\NormalTok{\}}

\FunctionTok{shinyApp}\NormalTok{(ui, server)}
\end{Highlighting}
\end{Shaded}

shinydashboardPlus 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(shinydashboard)}
\FunctionTok{library}\NormalTok{(shinydashboardPlus)}

\FunctionTok{shinyApp}\NormalTok{(}
  \AttributeTok{ui =} \FunctionTok{dashboardPage}\NormalTok{(}
    \FunctionTok{dashboardHeader}\NormalTok{(),}
    \FunctionTok{dashboardSidebar}\NormalTok{(),}
    \FunctionTok{dashboardBody}\NormalTok{(}
      \FunctionTok{box}\NormalTok{(}
        \AttributeTok{solidHeader =} \ConstantTok{FALSE}\NormalTok{,}
        \AttributeTok{title =} \StringTok{"Status summary"}\NormalTok{,}
        \AttributeTok{background =} \ConstantTok{NULL}\NormalTok{,}
        \AttributeTok{width =} \DecValTok{4}\NormalTok{,}
        \AttributeTok{status =} \StringTok{"danger"}\NormalTok{,}
        \AttributeTok{footer =} \FunctionTok{fluidRow}\NormalTok{(}
          \FunctionTok{column}\NormalTok{(}
            \AttributeTok{width =} \DecValTok{6}\NormalTok{,}
            \FunctionTok{descriptionBlock}\NormalTok{(}
              \AttributeTok{number =} \StringTok{"17\%"}\NormalTok{,}
              \AttributeTok{numberColor =} \StringTok{"green"}\NormalTok{,}
              \AttributeTok{numberIcon =} \StringTok{"fa fa{-}caret{-}up"}\NormalTok{,}
              \AttributeTok{header =} \StringTok{"$35,210.43"}\NormalTok{,}
              \AttributeTok{text =} \StringTok{"TOTAL REVENUE"}\NormalTok{,}
              \AttributeTok{rightBorder =} \ConstantTok{TRUE}\NormalTok{,}
              \AttributeTok{marginBottom =} \ConstantTok{FALSE}
\NormalTok{            )}
\NormalTok{          ),}
          \FunctionTok{column}\NormalTok{(}
            \AttributeTok{width =} \DecValTok{6}\NormalTok{,}
            \FunctionTok{descriptionBlock}\NormalTok{(}
              \AttributeTok{number =} \StringTok{"18\%"}\NormalTok{,}
              \AttributeTok{numberColor =} \StringTok{"red"}\NormalTok{,}
              \AttributeTok{numberIcon =} \StringTok{"fa fa{-}caret{-}down"}\NormalTok{,}
              \AttributeTok{header =} \StringTok{"1200"}\NormalTok{,}
              \AttributeTok{text =} \StringTok{"GOAL COMPLETION"}\NormalTok{,}
              \AttributeTok{rightBorder =} \ConstantTok{FALSE}\NormalTok{,}
              \AttributeTok{marginBottom =} \ConstantTok{FALSE}
\NormalTok{            )}
\NormalTok{          )}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    ),}
    \AttributeTok{title =} \StringTok{"Description Blocks"}
\NormalTok{  ),}
  \AttributeTok{server =} \ControlFlowTok{function}\NormalTok{(input, output) \{ \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

shinymaterial 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(shinymaterial)}

\CommentTok{\# https://ericrayanderson.github.io/shinymaterial/}
\CommentTok{\# https://github.com/ericrayanderson/shinymaterial}

\CommentTok{\# Wrap shinymaterial apps in material\_page}
\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{material\_page}\NormalTok{(}
  \AttributeTok{title =} \StringTok{"用户画像"}\NormalTok{,}
  \AttributeTok{nav\_bar\_fixed =} \ConstantTok{TRUE}\NormalTok{,}
  \CommentTok{\# 每个 sidebar 内容}
  \FunctionTok{material\_side\_nav}\NormalTok{(}
    \AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{,}
    \CommentTok{\# Place side{-}nav tabs within side{-}nav}
    \FunctionTok{material\_side\_nav\_tabs}\NormalTok{(}
      \AttributeTok{side\_nav\_tabs =} \FunctionTok{c}\NormalTok{(}
        \StringTok{"数据汇总"} \OtherTok{=} \StringTok{"tab\_1"}\NormalTok{,}
        \StringTok{"趋势信息"} \OtherTok{=} \StringTok{"tab\_2"}
\NormalTok{      ),}
      \AttributeTok{icons =} \FunctionTok{c}\NormalTok{(}\StringTok{"cast"}\NormalTok{, }\StringTok{"insert\_chart"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  ),}
  \CommentTok{\# 每个 tab 页面的内容}
  \FunctionTok{material\_side\_nav\_tab\_content}\NormalTok{(}
    \AttributeTok{side\_nav\_tab\_id =} \StringTok{"tab\_1"}\NormalTok{,}
\NormalTok{    tags}\SpecialCharTok{$}\FunctionTok{h2}\NormalTok{(}\StringTok{"第一个tab页"}\NormalTok{)}
\NormalTok{  ),}
  \FunctionTok{material\_side\_nav\_tab\_content}\NormalTok{(}
    \AttributeTok{side\_nav\_tab\_id =} \StringTok{"tab\_2"}\NormalTok{,}
\NormalTok{    tags}\SpecialCharTok{$}\FunctionTok{h2}\NormalTok{(}\StringTok{"第二个tab页"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output) \{}

\NormalTok{\}}
\FunctionTok{shinyApp}\NormalTok{(}\AttributeTok{ui =}\NormalTok{ ui, }\AttributeTok{server =}\NormalTok{ server)}
\end{Highlighting}
\end{Shaded}

miniUI 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}
\FunctionTok{library}\NormalTok{(miniUI)}
\FunctionTok{library}\NormalTok{(leaflet)}
\FunctionTok{library}\NormalTok{(ggplot2)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{miniPage}\NormalTok{(}
  \FunctionTok{gadgetTitleBar}\NormalTok{(}\StringTok{"Shiny gadget example"}\NormalTok{),}
  \FunctionTok{miniTabstripPanel}\NormalTok{(}
    \FunctionTok{miniTabPanel}\NormalTok{(}\StringTok{"Parameters"}\NormalTok{, }\AttributeTok{icon =} \FunctionTok{icon}\NormalTok{(}\StringTok{"sliders"}\NormalTok{),}
                 \FunctionTok{miniContentPanel}\NormalTok{(}
                   \FunctionTok{sliderInput}\NormalTok{(}\StringTok{"year"}\NormalTok{, }\StringTok{"Year"}\NormalTok{, }\DecValTok{1978}\NormalTok{, }\DecValTok{2010}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\DecValTok{2010}\NormalTok{), }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{                 )}
\NormalTok{    ),}
    \FunctionTok{miniTabPanel}\NormalTok{(}\StringTok{"Visualize"}\NormalTok{, }\AttributeTok{icon =} \FunctionTok{icon}\NormalTok{(}\StringTok{"area{-}chart"}\NormalTok{),}
                 \FunctionTok{miniContentPanel}\NormalTok{(}
                   \FunctionTok{plotOutput}\NormalTok{(}\StringTok{"cars"}\NormalTok{, }\AttributeTok{height =} \StringTok{"100\%"}\NormalTok{)}
\NormalTok{                 )}
\NormalTok{    ),}
    \FunctionTok{miniTabPanel}\NormalTok{(}\StringTok{"Map"}\NormalTok{, }\AttributeTok{icon =} \FunctionTok{icon}\NormalTok{(}\StringTok{"map{-}o"}\NormalTok{),}
                 \FunctionTok{miniContentPanel}\NormalTok{(}\AttributeTok{padding =} \DecValTok{0}\NormalTok{,}
                                  \FunctionTok{leafletOutput}\NormalTok{(}\StringTok{"map"}\NormalTok{, }\AttributeTok{height =} \StringTok{"100\%"}\NormalTok{)}
\NormalTok{                 ),}
                 \FunctionTok{miniButtonBlock}\NormalTok{(}
                   \FunctionTok{actionButton}\NormalTok{(}\StringTok{"resetMap"}\NormalTok{, }\StringTok{"Reset"}\NormalTok{)}
\NormalTok{                 )}
\NormalTok{    ),}
    \FunctionTok{miniTabPanel}\NormalTok{(}\StringTok{"Data"}\NormalTok{, }\AttributeTok{icon =} \FunctionTok{icon}\NormalTok{(}\StringTok{"table"}\NormalTok{),}
                 \FunctionTok{miniContentPanel}\NormalTok{(}
\NormalTok{                   DT}\SpecialCharTok{::}\FunctionTok{dataTableOutput}\NormalTok{(}\StringTok{"table"}\NormalTok{)}
\NormalTok{                 )}
\NormalTok{    ),}
    \AttributeTok{selected =} \StringTok{"Map"}
\NormalTok{  )}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output, session) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{cars }\OtherTok{\textless{}{-}} \FunctionTok{renderPlot}\NormalTok{(\{}
    \FunctionTok{require}\NormalTok{(ggplot2)}
    \FunctionTok{ggplot}\NormalTok{(cars, }\FunctionTok{aes}\NormalTok{(speed, dist)) }\SpecialCharTok{+} \FunctionTok{geom\_point}\NormalTok{()}
\NormalTok{  \})}

\NormalTok{  output}\SpecialCharTok{$}\NormalTok{map }\OtherTok{\textless{}{-}} \FunctionTok{renderLeaflet}\NormalTok{(\{}
    \FunctionTok{force}\NormalTok{(input}\SpecialCharTok{$}\NormalTok{resetMap)}

    \FunctionTok{leaflet}\NormalTok{(quakes, }\AttributeTok{height =} \StringTok{"100\%"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{addTiles}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{addMarkers}\NormalTok{(}\AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat)}
\NormalTok{  \})}

\NormalTok{  output}\SpecialCharTok{$}\NormalTok{table }\OtherTok{\textless{}{-}}\NormalTok{ DT}\SpecialCharTok{::}\FunctionTok{renderDataTable}\NormalTok{(\{}
\NormalTok{    diamonds}
\NormalTok{  \})}

  \FunctionTok{observeEvent}\NormalTok{(input}\SpecialCharTok{$}\NormalTok{done, \{}
    \FunctionTok{stopApp}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \})}
\NormalTok{\}}

\FunctionTok{shinyApp}\NormalTok{(ui, server)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-interactive-dash-app}{%
\section{交互式数据报表 dash}\label{sec-interactive-dash-app}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dash)}
\FunctionTok{library}\NormalTok{(dashHtmlComponents)}
\FunctionTok{library}\NormalTok{(dashCoreComponents)}
\FunctionTok{library}\NormalTok{(dashTable)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-session-shiny}{%
\section{运行环境}\label{sec-session-shiny}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] data.table_1.14.2 shiny_1.7.0      
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.7       knitr_1.36       magrittr_2.0.1   xtable_1.8-4    
##  [5] R6_2.5.1         rlang_0.4.11     fastmap_1.1.0    stringr_1.4.0   
##  [9] tools_4.1.1      xfun_0.26        png_0.1-7        htmltools_0.5.2 
## [13] ellipsis_0.3.2   yaml_2.2.1       digest_0.6.28    lifecycle_1.0.1 
## [17] bookdown_0.24    later_1.3.0      promises_1.2.0.1 curl_4.3.2      
## [21] evaluate_0.14    mime_0.12        rmarkdown_2.11   stringi_1.7.4   
## [25] compiler_4.1.1   httpuv_1.6.3
\end{verbatim}

\hypertarget{part-ux7edfux8ba1ux57faux7840}{%
\part{统计基础}\label{part-ux7edfux8ba1ux57faux7840}}

\hypertarget{chap-statistical-foundations}{%
\chapter*{介绍}\label{chap-statistical-foundations}}
\addcontentsline{toc}{chapter}{介绍}

统计基础

\hypertarget{chap-sampling-distributions}{%
\chapter{抽样分布}\label{chap-sampling-distributions}}

分布我们已经听说过很多了，可是它们都是凭空臆测的吗？肯定不是，那它们是怎么产生的呢？谁提出了正态分布，他/她是怎么提出的？一定有故事背景，一定有数据记录，即观察值，我们的样本数据

抽样分布其中抽样二字更加贴近生活，说明它源于实际生产场景，而不是光靠大脑思维理论推导出来的东西，它是最本质的

\hypertarget{sec-normal-distribution}{%
\section{正态分布}\label{sec-normal-distribution}}

分三块介绍

\begin{itemize}
\tightlist
\item
  历史背景
\item
  分布性质
\item
  应用场景
\end{itemize}

来源，为啥叫逻辑斯谛？历史故事

逻辑斯谛分布

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  正态分布
\item
  t 分布
\item
  F 分布
\item
  \(\chi^2\) 分布
\item
  霍特林 \(T^2\) 分布 Hoteling's T\^{}2 Distribution
\item
  威沙特分布 Wishart Distribution
\end{enumerate}

分一元和多元情况阐述正态分布、t 分布、F 分布、卡方分布及分布\href{https://mirrors.tuna.tsinghua.edu.cn/CRAN/doc/contrib/Ricci-distributions-en.pdf}{拟合}

常见分布之间的关系图需要用 TikZ 来绘制

完整的关系图 \url{http://www.math.wm.edu/~leemis/2008amstat.pdf} 参考自 \url{https://www.math.wustl.edu/~jmding/math494/dist.pdf}

图来自 \citep{Lawrence_1986_Dist}

\href{https://github.com/aursiber/fitdistrplus}{fitdistrplus}

\hypertarget{sec-exponential-family}{%
\section{指数族}\label{sec-exponential-family}}

谁提出的指数族，有哪些性质，指数族 quasi-poisson 是什么含义，拟族

如何判别一个分布是否属于指数族

常见的高斯、二项、正态分布、伽马分布、泊松分布

指数族

推广到一般情况

\begin{quote}
三大抽样分布t分布，\(\chi\) 分布和F分布，一元和多元情形，一元分布知识范围是本科，多元分布范围是研究生和博士，参考数理统计引论。一元分布多用于本科假设检验，多元分布常用于均值向量和协方差阵以及统计量的极限分布。介绍各个分布的形式、历史来源、各个特征量、密度、分布函数推导，数值计算
\end{quote}

三大抽样的发现、历史、多元、非中心形式的推广

多元 t 分布函数 (MVT)

\[
T(\mathbf{a},\mathbf{b},\Sigma,\nu)=\frac{2^{1-\frac{\nu}{2}}}{\Gamma(\frac{\nu}{2}) } \int_{0}^{\infty} s^{\nu-1}e^{-\frac{s^2}{2}} \Phi(\frac{s\mathbf{a}}{\sqrt{\nu}},\frac{s\mathbf{b}}{\sqrt{\nu}},\Sigma)ds
\]

多元正态分布函数 (MVN)

\[
\Phi(\mathbf{a},\mathbf{b},\Sigma)=\frac{1}{\sqrt{|\Sigma|(2\pi)^m}} \int_{a_1}^{b_1}\!\int_{a_2}^{b_2}\!\cdots\!\int_{a_m}^{b_m} e^{-\frac{1}{2}x^\top\Sigma^{-1}x}dx
\]

其中 \(x = (x_1,x_2,\dots,x_m)^\top, \forall i, -\infty \le a_i \le b_i \le \infty\)， \(\Sigma\) 是 \(m \times m\) 对称非负定的矩阵

多元 \(t\) 分布分位数计算

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(mvtnorm)}
\NormalTok{n }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{26}\NormalTok{, }\DecValTok{24}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{33}\NormalTok{, }\DecValTok{32}\NormalTok{)}
\NormalTok{V }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ n)}
\NormalTok{df }\OtherTok{\textless{}{-}} \DecValTok{130}
\NormalTok{C }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
  \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{,}
  \DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
  \DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}
\NormalTok{), }\AttributeTok{ncol =} \DecValTok{5}\NormalTok{)}
\NormalTok{cv }\OtherTok{\textless{}{-}}\NormalTok{ C }\SpecialCharTok{\%*\%}\NormalTok{ V }\SpecialCharTok{\%*\%} \FunctionTok{t}\NormalTok{(C) }\DocumentationTok{\#\# covariance matrix}
\NormalTok{dv }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{diag}\NormalTok{(cv)))}
\NormalTok{cr }\OtherTok{\textless{}{-}}\NormalTok{ cv }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{t}\NormalTok{(dv) }\SpecialCharTok{\%*\%}\NormalTok{ dv) }\DocumentationTok{\#\# correlation matrix}
\NormalTok{delta }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\NormalTok{Tn }\OtherTok{\textless{}{-}} \FunctionTok{qmvt}\NormalTok{(}\FloatTok{0.95}\NormalTok{,}
  \AttributeTok{df =}\NormalTok{ df, }\AttributeTok{delta =}\NormalTok{ delta, }\AttributeTok{corr =}\NormalTok{ cr,}
  \AttributeTok{abseps =} \FloatTok{0.0001}\NormalTok{, }\AttributeTok{maxpts =} \DecValTok{100000}\NormalTok{, }\AttributeTok{tail =} \StringTok{"both"}
\NormalTok{)}
\NormalTok{Tn}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $quantile
## [1] 2.56084
## 
## $f.quantile
## [1] 2.069875e-07
## 
## attr(,"message")
## [1] "Normal Completion"
\end{verbatim}

计算多元正态分布的概率，这个例子来自 \url{https://stackoverflow.com/questions/36704081}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 模拟一个协方差矩阵}
\NormalTok{sigma }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/sigma.csv"}\NormalTok{, }\AttributeTok{header =}\NormalTok{ F, }\AttributeTok{sep =} \StringTok{","}\NormalTok{))}
\FunctionTok{rownames}\NormalTok{(sigma) }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(sigma)}
\CommentTok{\# matrixcalc::is.symmetric.matrix(sigma) \# 判断 sigma 是否为对称的矩阵}
\CommentTok{\# matrixcalc::is.positive.definite(sigma) \# 判断 sigma 是否为正定的矩阵}
\CommentTok{\# isTRUE(all.equal(sigma, t(sigma)))}
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(sigma)}
\NormalTok{Fn }\OtherTok{\textless{}{-}} \FunctionTok{pmvnorm}\NormalTok{(}
  \AttributeTok{lower =} \FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\ConstantTok{Inf}\NormalTok{, m), }\AttributeTok{upper =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, m),}
  \AttributeTok{mean =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, m), }\AttributeTok{sigma =}\NormalTok{ sigma}
\NormalTok{)}
\NormalTok{Fn}
\end{Highlighting}
\end{Shaded}

\texttt{mvrnorm()} 函数来自 \textbf{MASS} 包，模拟多元正态分布的样本

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(MASS)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{1000} \CommentTok{\# 样本量}
\NormalTok{X }\OtherTok{\textless{}{-}} \FunctionTok{mvrnorm}\NormalTok{(n, }\AttributeTok{mu =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{Sigma =} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(X,}
  \AttributeTok{pch =} \DecValTok{20}\NormalTok{, }\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(), }\AttributeTok{cex =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{densCols}\NormalTok{(X, }\AttributeTok{colramp =}\NormalTok{ terrain.colors),}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(X[}\DecValTok{1}\NormalTok{]), }\AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(X[}\DecValTok{2}\NormalTok{])}
\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\AttributeTok{x =}\DecValTok{0}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{, }\AttributeTok{pch =} \DecValTok{3}\NormalTok{, }\AttributeTok{cex =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{sampling-distributions_files/figure-latex/bivariate-scatter-1} 

}

\caption{二维正态分布}\label{fig:bivariate-scatter}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{f1 }\OtherTok{\textless{}{-}} \FunctionTok{kde2d}\NormalTok{(X[, }\DecValTok{1}\NormalTok{], X[, }\DecValTok{2}\NormalTok{], }\AttributeTok{n =} \DecValTok{25}\NormalTok{)}
\FunctionTok{filled.contour}\NormalTok{(f1, }\AttributeTok{color.palette =}\NormalTok{ terrain.colors)}

\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{persp}\NormalTok{(f1}\SpecialCharTok{$}\NormalTok{z, }
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(X[}\DecValTok{1}\NormalTok{]), }\AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(X[}\DecValTok{2}\NormalTok{]),}
  \AttributeTok{zlab =} \FunctionTok{expression}\NormalTok{(Z),}
  \AttributeTok{col =} \FunctionTok{drapecol}\NormalTok{(f1}\SpecialCharTok{$}\NormalTok{z, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{20}\NormalTok{)),}
  \AttributeTok{theta =} \DecValTok{30}\NormalTok{, }\AttributeTok{phi =} \DecValTok{20}\NormalTok{, }
  \AttributeTok{r =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{expand =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{ltheta =} \DecValTok{90}\NormalTok{, }\AttributeTok{lphi =} \DecValTok{180}\NormalTok{,}
  \AttributeTok{shade =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{ticktype =} \StringTok{"detailed"}\NormalTok{, }\AttributeTok{nticks =} \DecValTok{5}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[等高线图\label{fig:bivariate-persp-1}]{\includegraphics[width=0.45\linewidth]{sampling-distributions_files/figure-latex/bivariate-persp-1} }\subfloat[透视图\label{fig:bivariate-persp-2}]{\includegraphics[width=0.45\linewidth]{sampling-distributions_files/figure-latex/bivariate-persp-2} }

}

\caption{二维正态分布}\label{fig:bivariate-persp}
\end{figure}

Wishart 分布 文献 \citep{Eaton_2007_MultiStat} 第八章

\hypertarget{chap-parameter-estimators}{%
\chapter{参数估计}\label{chap-parameter-estimators}}

\begin{quote}
Jeremy Koster: My students were looking at the estimated varying intercepts for each higher-level group (or the ``BLUP's'', as some people seem to call them).

Douglas Bates: As Alan James once said, ``these values are just like the BLUPs - Best Linear Unbiased Predictors - except that they aren't linear and they aren't unbiased and there is no clear sense in which they are''best'', but other than that \ldots''

\hspace*{\fill} --- Jeremy Koster and Douglas Bates \footnote{\url{https://stat.ethz.ch/pipermail/r-sig-mixed-models/2012q3/018817.html}}
\end{quote}

\hypertarget{sec-point-estimator}{%
\section{点估计}\label{sec-point-estimator}}

\begin{itemize}
\tightlist
\item
  矩估计
\item
  极大似然估计
\item
  最小二乘估计
\item
  同变估计
\item
  稳健估计
\end{itemize}

单参数和多参数模型的参数估计，比如指数分布、泊松分布、二项分布、正态分布，线性模型各个估计的推导过程

\begin{rmdnote}{注意}
应当考虑 \((X^{\top}X)^{-1}\) 不存在的情况，在均方误差最小的意义下，不必要求 \(\beta\) 的估计 \(\hat{\beta}\) 满足无偏性的要求，所以介绍岭回归估计 \(\hat{\beta}_{ridge}\)、压缩估计 \(\hat{\beta}_{jse}\)、主成分估计 \(\hat{\beta}_{pca}\) 和偏最小二乘估计 \(\hat{\beta}_{pls}\)。相比于 \(\hat{\beta}_{pca}\)， \(\hat{\beta}_{pls}\) 考虑了响应变量的作用。《数理统计引论》第5章第5节线性估计类从改进 LS 估计出发，牺牲一部分估计的偏差，即采用有偏的估计，达到总体均方误差更小的效果 \citep{Stat_1981_Chen}

James-Stein 估计可不可以看作一种压缩估计？从它牺牲一部分偏差，获取整体方差的降低来看和上面应该有某种联系

\end{rmdnote}

\begin{itemize}
\tightlist
\item
  \href{https://cosx.org/2014/04/lmm-and-me}{昔日因，今日意} 讲线性混合效应模型和很多模型之间的联系
\item
  \href{https://cosx.org/2012/05/chase-after-eb}{那些年，我们一起追的 EB} James-Stein 估计和岭回归估计的联系
\item
  \href{https://cosx.org/2011/12/stories-about-statistical-learning}{统计学习那些事} lasso 和 boosting 之间的联系
\end{itemize}

\hypertarget{sec-moments-estimation}{%
\subsection{矩估计}\label{sec-moments-estimation}}

\hypertarget{sec-lse}{%
\subsection{最小二乘估计}\label{sec-lse}}

谈非线性最小二乘，这段话的意思是非线性模型不要谈 ANOVA 和 R\^{}2 之类的东西

\begin{quote}
As one of the developers of the \texttt{nls} function I would like to state that the lack of automatic ANOVA, \(R^2\) and \(adj. R^2\) from \texttt{nls} is a feature, not a bug :-)

\hspace*{\fill} --- Douglas Bates \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2000-August/007778.html}}
\end{quote}

\begin{quote}
最小二乘估计是一种非参数估计方法（对数据分布没有假设，只要预测误差达到最小即可），而极大似然估计是一种参数估计方法（观测数据服从带参数的多元分布）
\end{quote}

非线性最小二乘估计

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Nonlinear least{-}squares using nlm()}
\CommentTok{\# demo(nlm)}

\CommentTok{\# Helical Valley Function}
\CommentTok{\# 非线性最小二乘}

\NormalTok{theta }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x1, x2) (}\FunctionTok{atan}\NormalTok{(x2 }\SpecialCharTok{/}\NormalTok{ x1) }\SpecialCharTok{+}\NormalTok{ (}\ControlFlowTok{if}\NormalTok{ (x1 }\SpecialCharTok{\textless{}=} \DecValTok{0}\NormalTok{) pi }\ControlFlowTok{else} \DecValTok{0}\NormalTok{)) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)}
\DocumentationTok{\#\# 更加简洁的表达}
\NormalTok{theta }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x1, x2) }\FunctionTok{atan2}\NormalTok{(x2, x1) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)}
\CommentTok{\# 目标函数}
\NormalTok{f }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  f1 }\OtherTok{\textless{}{-}} \DecValTok{10} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{10} \SpecialCharTok{*} \FunctionTok{theta}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]))}
\NormalTok{  f2 }\OtherTok{\textless{}{-}} \DecValTok{10} \SpecialCharTok{*}\NormalTok{ (}\FunctionTok{sqrt}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{  f3 }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}
  \FunctionTok{return}\NormalTok{(f1}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ f2}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ f3}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}

\DocumentationTok{\#\# explore surface \{at x3 = 0\}}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{50}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{50}\NormalTok{)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(}\FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(x, y)), }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{f}\NormalTok{(}\FunctionTok{c}\NormalTok{(x, }\DecValTok{0}\NormalTok{)))}

\FunctionTok{contour}\NormalTok{(x, y, }\FunctionTok{matrix}\NormalTok{(}\FunctionTok{log10}\NormalTok{(z), }\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{))}

\NormalTok{nlm.f }\OtherTok{\textless{}{-}} \FunctionTok{nlm}\NormalTok{(f, }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{hessian =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{points}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(nlm.f}\SpecialCharTok{$}\NormalTok{estim[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# the Rosenbrock banana valley function 香蕉谷函数}

\NormalTok{fR }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x1 }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}
\NormalTok{  x2 }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}
  \DecValTok{100} \SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{\}}

\DocumentationTok{\#\# explore surface}
\NormalTok{fx }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{ }\DocumentationTok{\#\# \textasciigrave{}vectorized\textquotesingle{} version of fR()}
\NormalTok{  x1 }\OtherTok{\textless{}{-}}\NormalTok{ x[, }\DecValTok{1}\NormalTok{]}
\NormalTok{  x2 }\OtherTok{\textless{}{-}}\NormalTok{ x[, }\DecValTok{2}\NormalTok{]}
  \DecValTok{100} \SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{\}}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{100}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{100}\NormalTok{)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{fx}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(x, y))}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{mar =} \FloatTok{0.1} \SpecialCharTok{+} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{contour}\NormalTok{(x, y, }\FunctionTok{matrix}\NormalTok{(}\FunctionTok{log10}\NormalTok{(z), }\FunctionTok{length}\NormalTok{(x)))}

\NormalTok{nlm.f2 }\OtherTok{\textless{}{-}} \FunctionTok{nlm}\NormalTok{(fR, }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{hessian =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(nlm.f2}\SpecialCharTok{$}\NormalTok{estim[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{20}\NormalTok{)}

\DocumentationTok{\#\# Zoom in :}
\FunctionTok{rect}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\AttributeTok{border =} \StringTok{"orange"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ y }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{100}\NormalTok{)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{fx}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(x, y))}
\FunctionTok{contour}\NormalTok{(x, y, }\FunctionTok{matrix}\NormalTok{(}\FunctionTok{log10}\NormalTok{(z), }\FunctionTok{length}\NormalTok{(x)))}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"zoomed in"}\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"orange"}\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(nlm.f2}\SpecialCharTok{$}\NormalTok{estim[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{20}\NormalTok{)}
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}
\NormalTok{  nlm.f2,}
  \FunctionTok{stopifnot}\NormalTok{(}
    \FunctionTok{all.equal}\NormalTok{(estimate, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{tol =} \FloatTok{1e{-}5}\NormalTok{),}
\NormalTok{    minimum }\SpecialCharTok{\textless{}} \FloatTok{1e{-}11}\NormalTok{, }\FunctionTok{abs}\NormalTok{(gradient) }\SpecialCharTok{\textless{}} \FloatTok{1e{-}6}\NormalTok{, code }\SpecialCharTok{\%in\%} \DecValTok{1}\SpecialCharTok{:}\DecValTok{2}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fg }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x1, x2) \{}
    \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{400} \SpecialCharTok{*}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1) }\SpecialCharTok{{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x1), }\DecValTok{200} \SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1))}
\NormalTok{  \}}
\NormalTok{  x1 }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}
\NormalTok{  x2 }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}
  \FunctionTok{structure}\NormalTok{(}\DecValTok{100} \SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
    \AttributeTok{gradient =} \FunctionTok{gr}\NormalTok{(x1, x2)}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{nfg }\OtherTok{\textless{}{-}} \FunctionTok{nlm}\NormalTok{(fg, }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{hessian =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{str}\NormalTok{(nfg)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}
\NormalTok{  nfg,}
  \FunctionTok{stopifnot}\NormalTok{(}
\NormalTok{    minimum }\SpecialCharTok{\textless{}} \FloatTok{1e{-}17}\NormalTok{, }\FunctionTok{all.equal}\NormalTok{(estimate, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)),}
    \FunctionTok{abs}\NormalTok{(gradient) }\SpecialCharTok{\textless{}} \FloatTok{1e{-}7}\NormalTok{, code }\SpecialCharTok{\%in\%} \DecValTok{1}\SpecialCharTok{:}\DecValTok{2}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# or use deriv to find the derivatives}

\NormalTok{fd }\OtherTok{\textless{}{-}} \FunctionTok{deriv}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \DecValTok{100} \SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"x1"}\NormalTok{, }\StringTok{"x2"}\NormalTok{))}
\NormalTok{fdd }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x1, x2) \{\}}
\FunctionTok{body}\NormalTok{(fdd) }\OtherTok{\textless{}{-}}\NormalTok{ fd}

\NormalTok{nlfd }\OtherTok{\textless{}{-}} \FunctionTok{nlm}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{fdd}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{hessian =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{str}\NormalTok{(nlfd)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}
\NormalTok{  nlfd,}
  \FunctionTok{stopifnot}\NormalTok{(}
\NormalTok{    minimum }\SpecialCharTok{\textless{}} \FloatTok{1e{-}17}\NormalTok{, }\FunctionTok{all.equal}\NormalTok{(estimate, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)),}
    \FunctionTok{abs}\NormalTok{(gradient) }\SpecialCharTok{\textless{}} \FloatTok{1e{-}7}\NormalTok{, code }\SpecialCharTok{\%in\%} \DecValTok{1}\SpecialCharTok{:}\DecValTok{2}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fgh }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x1, x2) \{}
    \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{400} \SpecialCharTok{*}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1) }\SpecialCharTok{{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x1), }\DecValTok{200} \SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1))}
\NormalTok{  \}}
\NormalTok{  h }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x1, x2) \{}
\NormalTok{    a11 }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{{-}} \DecValTok{400} \SpecialCharTok{*}\NormalTok{ x2 }\SpecialCharTok{+} \DecValTok{1200} \SpecialCharTok{*}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1}
\NormalTok{    a21 }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{400} \SpecialCharTok{*}\NormalTok{ x1}
    \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(a11, a21, a21, }\DecValTok{200}\NormalTok{), }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  x1 }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}
\NormalTok{  x2 }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}
  \FunctionTok{structure}\NormalTok{(}\DecValTok{100} \SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x1)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
    \AttributeTok{gradient =} \FunctionTok{gr}\NormalTok{(x1, x2),}
    \AttributeTok{hessian  =}  \FunctionTok{h}\NormalTok{(x1, x2)}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{nlfgh }\OtherTok{\textless{}{-}} \FunctionTok{nlm}\NormalTok{(fgh, }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{hessian =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{str}\NormalTok{(nlfgh)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# NB: This did \_NOT\_ converge for R version \textless{}= 3.4.0}
\FunctionTok{with}\NormalTok{(}
\NormalTok{  nlfgh,}
  \FunctionTok{stopifnot}\NormalTok{(}
\NormalTok{    minimum }\SpecialCharTok{\textless{}} \FloatTok{1e{-}15}\NormalTok{, }\CommentTok{\# see 1.13e{-}17 .. slightly worse than above}
    \FunctionTok{all.equal}\NormalTok{(estimate, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{tol =} \FloatTok{9e{-}9}\NormalTok{), }\CommentTok{\# see 1.236e{-}9}
    \FunctionTok{abs}\NormalTok{(gradient) }\SpecialCharTok{\textless{}} \FloatTok{7e{-}7}\NormalTok{, code }\SpecialCharTok{\%in\%} \DecValTok{1}\SpecialCharTok{:}\DecValTok{2}
\NormalTok{  )}
\NormalTok{) }\CommentTok{\# g[1] = 1.3e{-}7}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-mle}{%
\subsection{极大似然估计}\label{sec-mle}}

教材简短一句话，这里面有很多信息值得发散，一个数学家提出了统计学领域极其重要的一个核心思想，他是在研究什么的时候提出了这个想法，为什么后来没有得到重视，虽然这可能有点离题，但是对于读者可能有很多别的启迪。整整100 年以后，Fisher 又是怎么提出这一思想的呢？他做了什么使得这个思想被广泛接受和应用？

统计决策理论，任何统计推断都应该依赖损失函数，而极大似然估计未曾考虑到，这是它的局限性。 Lasso 和贝叶斯先验的关系，和损失函数的关系

是最大似然估计还是极大似然估计？当然是极大似然估计，如果有人告诉你是最大似然估计那一定是假的，这两个概念归根结底是极值和最值得区别

书本定义和性质，在后续章节介绍

介绍线性模型为何引入 REML 减少偏差

极大似然估计是费舍尔提出来的

\begin{itemize}
\tightlist
\item
  边际似然 Marginal Likelihood
\item
  条件似然 conditional lkelihood
\item
  完全似然 complete Likelihood
\item
  层次似然 Hierarchical likelihood
\item
  部分似然 partial likelihood
\item
  剖面似然 Profile Likelihood
\item
  限制似然 Restricted Likelihood
\item
  惩罚/边际拟似然 (PQL/MQL) Penalized Quasi-Likelihood/Marginal Quasi-Likelihood
\item
  分布 边际分布 条件分布
\item
  似然 边际似然 条件似然
\item
  极大似然估计 Maximum likelihood 简称 ML
\item
  限制极大似然 Restricted Maximum likelihood, 简称 REML
\item
  惩罚拟似然 Penalized Quasi-Likelihood, 简称 PQL 和边际拟似然 Marginal Quasi-Likelihood, 简称 MQL，Profile Maximal Likelihood, 简称 PML
\end{itemize}

\href{https://en.wikipedia.org/wiki/Quasi-maximum_likelihood_estimate}{拟似然估计} \href{https://en.wikipedia.org/wiki/Maximum_likelihood_estimation}{极大似然估计} \href{https://en.wikipedia.org/wiki/Likelihood_function}{似然函数}

Penalized maximum likelihood estimates are calculated using optimization methods such as the limited memory Broyden-Fletcher-Goldfarb-Shanno algorithm (L-BFGS).

BFGS 拟牛顿法和采样器 \url{https://bookdown.org/rdpeng/advstatcomp}

\hypertarget{chap-interval-estimation}{%
\section{区间估计}\label{chap-interval-estimation}}

\hypertarget{subsec-ci}{%
\subsection{正态分布}\label{subsec-ci}}

正态分布 \(\mathcal{N}(\mu,\sigma^2)\)，\(\sigma^2\) 未知，关于参数 \(\mu\) 的置信水平为 \(1 - \alpha\) 的区间估计

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  构造统计量 \(t = \frac{\bar{x} - \mu}{s/\sqrt{n}} \sim t(n-1)\)
\item
  参数 \(\mu\) 的 \(1-\alpha\) 置信区间为 \[\bar{x} \pm t_{1-\alpha/2}(n-1)s/\sqrt{n}\]
\end{enumerate}

其中，\(s^2 = \frac{1}{n-1}\sum_{i=1}^{n}(x_i - \bar{x})^2\) 是 \(\sigma^2\) 的无偏估计。若取 \(\alpha = 0.05\)，则置信水平 \(1 - \alpha = 0.95\)。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{) }\CommentTok{\# 为了可重复，设置随机数种子}
\NormalTok{mu\_ci }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{mu =} \DecValTok{4}\NormalTok{) \{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\AttributeTok{n =}\NormalTok{ n, }\AttributeTok{mean =}\NormalTok{ mu, }\AttributeTok{sd =} \DecValTok{1}\NormalTok{)}
\NormalTok{  x\_bar }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(x)}
\NormalTok{  d }\OtherTok{\textless{}{-}} \FunctionTok{qt}\NormalTok{(}\AttributeTok{p =} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ alpha }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\AttributeTok{df =}\NormalTok{ n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{lower.tail =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{var}\NormalTok{(x) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n)}
  \FunctionTok{c}\NormalTok{(}\AttributeTok{mu =}\NormalTok{ mu, }\AttributeTok{lower =}\NormalTok{ x\_bar }\SpecialCharTok{{-}}\NormalTok{ d, }\AttributeTok{upper =}\NormalTok{ x\_bar }\SpecialCharTok{+}\NormalTok{ d)}
\NormalTok{\}}
\CommentTok{\# 重抽样 100 次，获得 100 个置信区间}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{replicate}\NormalTok{(}\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\FunctionTok{mu\_ci}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{mu =} \DecValTok{4}\NormalTok{)))}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(dat, }\AttributeTok{idx =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{100}\NormalTok{, }\AttributeTok{cover =} \FunctionTok{ifelse}\NormalTok{(mu }\SpecialCharTok{\textgreater{}=}\NormalTok{ lower }\SpecialCharTok{\&}\NormalTok{ mu }\SpecialCharTok{\textless{}=}\NormalTok{ upper, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

真实的参数值 \(\mu = 4\)，重抽样 100 次，覆盖真值的次数为 97 次，覆盖概率为 0.97

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 覆盖概率}
\FunctionTok{mean}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{cover)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.97
\end{verbatim}



\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ idx, }\AttributeTok{xend =}\NormalTok{ idx,}
    \AttributeTok{y =}\NormalTok{ lower, }\AttributeTok{yend =}\NormalTok{ upper, }\AttributeTok{color =}\NormalTok{ cover}
\NormalTok{  )) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{parameter-estimators_files/figure-latex/ci-1} 

}

\caption{\(\mu\) 的置信水平为 0.95 的置信区间}\label{fig:ci}
\end{figure}

方差 \(\sigma^2\) 已知的情况下，标准正态分布 \(N(\mu, \sigma^2), \mu = 0, \sigma^2 = 1\) 的参数 \(\mu\) 的区间估计和覆盖概率 \url{https://yihui.org/animation/example/conf-int/}

\hypertarget{subsec-binomial}{%
\subsection{0-1 分布}\label{subsec-binomial}}

设 0-1 分布 \(B(1, p)\) 的成功概率 \(p = 0.95\)，假定是抛硬币的场景，成功概率对应正面朝上的概率为 0.95。一次实验，重复抛 10 次，有两次正面朝上。现在要根据这次实验结果估计成功概率 \(p\) 的值，及其置信区间

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 卡方近似}
\FunctionTok{prop.test}\NormalTok{(}\AttributeTok{x =} \DecValTok{2}\NormalTok{, }\AttributeTok{n =} \DecValTok{10}\NormalTok{, }\AttributeTok{p =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{correct =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in prop.test(x = 2, n = 10, p = 0.95, conf.level = 0.95, correct =
## TRUE): Chi-squared approximation may be incorrect
\end{verbatim}

\begin{verbatim}
## 
##  1-sample proportions test with continuity correction
## 
## data:  2 out of 10, null probability 0.95
## X-squared = 103.16, df = 1, p-value < 2.2e-16
## alternative hypothesis: true p is not equal to 0.95
## 95 percent confidence interval:
##  0.03542694 0.55781858
## sample estimates:
##   p 
## 0.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 二项精确估计}
\FunctionTok{binom.test}\NormalTok{(}\AttributeTok{x =} \DecValTok{2}\NormalTok{, }\AttributeTok{n =} \DecValTok{10}\NormalTok{, }\AttributeTok{p =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Exact binomial test
## 
## data:  2 and 10
## number of successes = 2, number of trials = 10, p-value = 1.605e-09
## alternative hypothesis: true probability of success is not equal to 0.95
## 95 percent confidence interval:
##  0.02521073 0.55609546
## sample estimates:
## probability of success 
##                    0.2
\end{verbatim}

可知，在置信水平都是 0.95 的情况下，带连续矫正的单样本比例检验方法获得的区间估计是 (0.0354, 0.5578)， 区间长度 0.5224。精确二项检验方法获得的区间估计是 (0.0252, 0.5560)，区间长度 0.5308。

从二项分布 \(B(30, 0.2)\) 中随机抽取一个样本，为可重复记，设置随机数种子为 2020

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\FunctionTok{rbinom}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{30}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.2}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 7
\end{verbatim}

得到样本观测值为 7，

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{7} \SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}} \FloatTok{0.95} \SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\FloatTok{0.2} \SpecialCharTok{*} \FloatTok{0.8} \SpecialCharTok{/} \DecValTok{30}\NormalTok{) }\CommentTok{\# 6.995}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6.995421
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{7} \SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}} \FloatTok{0.95} \SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\FloatTok{0.2} \SpecialCharTok{*} \FloatTok{0.8} \SpecialCharTok{/} \DecValTok{30}\NormalTok{) }\CommentTok{\# 7.0045}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 7.004579
\end{verbatim}

样本观测值 7 对应的参数 \(p\) 的区间估计，如下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prop.test}\NormalTok{(}\AttributeTok{x =} \DecValTok{7}\NormalTok{, }\AttributeTok{n =} \DecValTok{30}\NormalTok{, }\AttributeTok{p =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{correct =} \ConstantTok{TRUE}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  1-sample proportions test with continuity correction
## 
## data:  7 out of 30, null probability 0.2
## X-squared = 0.052083, df = 1, p-value = 0.8195
## alternative hypothesis: true p is not equal to 0.2
## 95 percent confidence interval:
##  0.1063502 0.4270023
## sample estimates:
##         p 
## 0.2333333
\end{verbatim}

随机变量 \(X\) 服从二项分布 \(B(30, 0.2)\)，则概率值 \(P(x \leq 7) = 0.7607\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pbinom}\NormalTok{(}\DecValTok{7}\NormalTok{, }\AttributeTok{size =} \DecValTok{30}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{lower.tail =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.7607906
\end{verbatim}

已知概率值为 0.95， 即 \(P(x \leq m) = 0.95\) 且 \(X \sim B(30, 0.2)\)，现在计算 m 的值，即求下分位点，为 10

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qbinom}\NormalTok{(}\AttributeTok{p =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{size =} \DecValTok{30}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{lower.tail =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10
\end{verbatim}

\begin{rmdtip}{提示}

二项分布的特点，主要用于计算期望，概率 \(P\big\{ C_1 +1\leq x \leq C_2 -1 \big\}\)

\[
\sum_{x = C_1 + 1}^{C_2 -1} x \binom{n}{x} p^{x}(1-p)^{n-x} = np \sum_{x = C_1 + 1}^{C_2 -1} \binom{n -1}{x -1} p^{x -1}(1-p)^{(n -1)-(x-1)}
\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OtherTok{=} \DecValTok{30} 
\NormalTok{c2 }\OtherTok{=} \DecValTok{20} 
\NormalTok{c1 }\OtherTok{=} \DecValTok{10}
\NormalTok{p }\OtherTok{=} \FloatTok{0.2}
\NormalTok{n }\SpecialCharTok{*}\NormalTok{ p }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{pbinom}\NormalTok{(}\AttributeTok{q =}\NormalTok{ c2 }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{, }\AttributeTok{size =}\NormalTok{ n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p) }\SpecialCharTok{{-}} \FunctionTok{pbinom}\NormalTok{(}\AttributeTok{q =}\NormalTok{ c1 }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{size =}\NormalTok{ n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.2955803
\end{verbatim}

\end{rmdtip}

\hypertarget{sec-confidence-fiducial-limits}{%
\subsection{置信区间和信仰区间}\label{sec-confidence-fiducial-limits}}

计算置信区间的覆盖概率 \href{https://cran.r-project.org/package=binom}{binom}

二项分布的参数估计，包括点估计和区间估计 \citep{Test_1934_binom}

给定样本量 n = 10 0-1 分布 成功概率 p 分别取 0.1,0.2,\ldots,1 置信度为 95\% 观测到 x 取 1,2,3,..,10 时 估计 p 的上下限

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.1}\NormalTok{) }\CommentTok{\# 结果解读}
\end{Highlighting}
\end{Shaded}

抛掷硬币 10 次，观测到2次正面朝上，估计正面朝上的概率

观测到正面朝上 2 次 此时请以 95\% 的信心给出 p 的区间 (p\_low, p\_up)

绘制曲线 p 关于 x 的曲线

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{11}\NormalTok{)}
\CommentTok{\# 成功概率 总体参数 p 值}
\FunctionTok{sapply}\NormalTok{(}\FunctionTok{rep}\NormalTok{(p, }\AttributeTok{each =} \DecValTok{10}\NormalTok{), rbinom, }\AttributeTok{n =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1]  0  0  0  0  0  0  0  0  0  0  2  1  0  1  0  0  2  0  0  1  3  2  1  1  3
##  [26]  2  0  3  1  2  3  3  5  2  1  0  3  5  3  3  5  1  5  3  1  2  3  4  1  5
##  [51]  5  4  7  6  6  5  7  7  4  4  7  8  9  7  6  7  2  4  8  8  8  8  6  8  6
##  [76]  4  8  9  6  7  9  9  9  9  8  4  9  8  9  7 10  8  7 10  9 10  9  9  8 10
## [101] 10 10 10 10 10 10 10 10 10 10
\end{verbatim}

计算每一次抽样获得的上下限

Clopper-Pearson 方法，即求和搜索，在保持累积概率

\[B(x,n;n,p) = \sum_{r = x}^{n} \binom{n}{r}p^r(1-p)^{n-r} = \alpha/2\]

其中 n 表示试验次数，这里是 10， p 是未知待求，已知 \(\alpha = 0.05\)，而 \(1-\alpha\) 表示置信水平，意思是说对于我给出的区间估计，长期来看，我有 95\% 的信心认为，真实值 \(p\) 会落在此区间内。

对上尾部从 x 到 n 求和，计算 p，对每一个 x 都能计算出一个 p，根据二项分布的对称性，区间 \([0, x]\) 和 \([x,n]\) 的累积概率是相同的，各占 \(\alpha/2\)

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 精确计算二项分布检验的 p}
\CommentTok{\# 调用符号计算}
\CommentTok{\# x = 7}
\NormalTok{fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p, }\AttributeTok{r =} \DecValTok{8}\NormalTok{, }\AttributeTok{n =} \DecValTok{10}\NormalTok{) \{}
  \FunctionTok{choose}\NormalTok{(n, n}\DecValTok{{-}2}\NormalTok{)}\SpecialCharTok{*}\NormalTok{p}\SpecialCharTok{\^{}}\NormalTok{r}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{p)}\SpecialCharTok{\^{}}\NormalTok{(n}\SpecialCharTok{{-}}\NormalTok{r) }\SpecialCharTok{+} \FunctionTok{choose}\NormalTok{(n, n}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{p}\SpecialCharTok{\^{}}\NormalTok{(n}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{p) }\SpecialCharTok{+} \FunctionTok{choose}\NormalTok{(n, n)}\SpecialCharTok{*}\NormalTok{p}\SpecialCharTok{\^{}}\NormalTok{n }\SpecialCharTok{{-}} \FloatTok{0.025}
\NormalTok{\}}
\FunctionTok{uniroot}\NormalTok{(fun, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $root
## [1] 0.4439038
## 
## $f.root
## [1] -2.707352e-07
## 
## $iter
## [1] 9
## 
## $init.it
## [1] NA
## 
## $estim.prec
## [1] 6.103516e-05
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# x = 8}
\NormalTok{fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p) \{}
  \DecValTok{45}\SpecialCharTok{*}\NormalTok{p}\SpecialCharTok{\^{}}\DecValTok{8}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{p)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \DecValTok{10}\SpecialCharTok{*}\NormalTok{p}\SpecialCharTok{\^{}}\DecValTok{9}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{p) }\SpecialCharTok{+}\NormalTok{ p}\SpecialCharTok{\^{}}\DecValTok{10} \SpecialCharTok{{-}} \FloatTok{0.025}
\NormalTok{\}}
\FunctionTok{uniroot}\NormalTok{(fun, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $root
## [1] 0.4439038
## 
## $f.root
## [1] -2.707352e-07
## 
## $iter
## [1] 9
## 
## $init.it
## [1] NA
## 
## $estim.prec
## [1] 6.103516e-05
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# x = 9}
\NormalTok{fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \DecValTok{9} \SpecialCharTok{*}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{10} \SpecialCharTok{{-}} \DecValTok{10} \SpecialCharTok{*}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{9} \SpecialCharTok{+} \FloatTok{0.025}
\NormalTok{\}}
\CommentTok{\# 0.555 计算下限}
\FunctionTok{uniroot}\NormalTok{(fun, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $root
## [1] 0.5549828
## 
## $f.root
## [1] 3.773379e-07
## 
## $iter
## [1] 10
## 
## $init.it
## [1] NA
## 
## $estim.prec
## [1] 6.462529e-05
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# x = 10}
\NormalTok{fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x}\SpecialCharTok{\^{}}\DecValTok{10} \SpecialCharTok{{-}} \FloatTok{0.025}
\NormalTok{\}}
\CommentTok{\# 0.691}
\FunctionTok{uniroot}\NormalTok{(fun, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $root
## [1] 0.6914996
## 
## $f.root
## [1] -1.194136e-06
## 
## $iter
## [1] 9
## 
## $init.it
## [1] NA
## 
## $estim.prec
## [1] 6.103516e-05
\end{verbatim}

累积二项概率

找到最小的 p 使得其等于 9

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 已知概率求上分位点}

\CommentTok{\# 等于}
\FunctionTok{qbinom}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.565}\NormalTok{, }\AttributeTok{lower.tail =}\NormalTok{ F)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 9
\end{verbatim}

找到使得函数为 0 的 p 中最小的那个，找到所有的根，然后取最小的那个

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p, }\AttributeTok{r =} \DecValTok{9}\NormalTok{) }\FunctionTok{qbinom}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p, }\AttributeTok{lower.tail =}\NormalTok{ F) }\SpecialCharTok{{-}}\NormalTok{ r}
\CommentTok{\# 计算每个 x 对应的 p }
\NormalTok{(p }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{uniroot}\NormalTok{(fun, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =} \DecValTok{1}\NormalTok{, }\AttributeTok{r =}\NormalTok{ x)}\SpecialCharTok{$}\NormalTok{root))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 0.01666667 0.05333333 0.09375000 0.16000000 0.25000000 0.30000000
##  [7] 0.35000000 0.53333333 0.67500000 1.00000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{y =}\NormalTok{ p)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{parameter-estimators_files/figure-latex/unnamed-chunk-27-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 二项检验 菱形置信带}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{replicate}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{, }\AttributeTok{expr =}\NormalTok{ \{}
\NormalTok{  x }\OtherTok{=} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{prob =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\FloatTok{0.2}\NormalTok{))}
  \FunctionTok{sum}\NormalTok{(x)}\SpecialCharTok{/}\DecValTok{10}
\NormalTok{\})}

\CommentTok{\# 成功概率 p = 0.2 每个样本量 10}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.2}\NormalTok{)}\SpecialCharTok{/}\DecValTok{10}
\FunctionTok{table}\NormalTok{(dat)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## dat
##   0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 
## 119 274 304 180  82  30  10   1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分布图 y 轴是密度}
\CommentTok{\# right = TRUE 区间形式 (a,b] 左开右闭}
\FunctionTok{hist}\NormalTok{(dat, }\AttributeTok{probability =}\NormalTok{ T, }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\FloatTok{0.1}\NormalTok{, }\AttributeTok{to =} \DecValTok{1}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{parameter-estimators_files/figure-latex/unnamed-chunk-29-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 0.2\^{}10 左闭右开区间}
\FunctionTok{hist}\NormalTok{(dat, }\AttributeTok{probability =}\NormalTok{ T, }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \FloatTok{1.1}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.1}\NormalTok{),}
     \AttributeTok{right =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{1.1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{parameter-estimators_files/figure-latex/unnamed-chunk-29-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分布}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(magrittr)}
\CommentTok{\# 这个图里面会不会隐含什么信息，分布是怎样的？}
\CommentTok{\# 二项展开有关系吗}
\NormalTok{dat1 }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{table}\NormalTok{(dat))}


\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dat, }\AttributeTok{y =}\NormalTok{ Freq)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{parameter-estimators_files/figure-latex/unnamed-chunk-30-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(dat), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dat)) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins =} \DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{parameter-estimators_files/figure-latex/unnamed-chunk-30-2} \end{center}

\hypertarget{sec-least-angle-regression}{%
\section{最小角回归}\label{sec-least-angle-regression}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Efron, Bradley and Hastie, Trevor and Johnstone, Iain and Tibshirani, Robert. 2004. Least angle regression. The Annals of Statistics. 32(2): 407--499. \url{https://doi.org/10.1214/009053604000000067}.
\end{enumerate}

方差缩减技术，修偏技术

\hypertarget{sec-jackknife}{%
\section{刀切法}\label{sec-jackknife}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Efron, B. 1979. Bootstrap Methods: Another Look at the Jackknife. The Annals of Statistics. 7(1):1--26. \url{https://doi.org/10.1214/aos/1176344552}
\end{enumerate}

\hypertarget{sec-resampling}{%
\section{重抽样}\label{sec-resampling}}

\hypertarget{sec-delta-methods}{%
\section{Delta 方法}\label{sec-delta-methods}}

\hypertarget{chap-hypothesis-test}{%
\chapter{假设检验}\label{chap-hypothesis-test}}

\begin{quote}
The Earth is Round (\(p < 0.05\))

\hspace*{\fill} --- Jacob Cohen \citep{Cohen_1994_Earth}
\end{quote}

\begin{center}\includegraphics{hypothesis-test_files/figure-latex/unnamed-chunk-2-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{=} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\AttributeTok{to =} \DecValTok{8}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{193}\NormalTok{)}
\NormalTok{y1 }\OtherTok{=} \FunctionTok{dnorm}\NormalTok{(x, }\AttributeTok{mean =} \DecValTok{3}\NormalTok{, }\AttributeTok{sd =} \DecValTok{1}\NormalTok{) }
\NormalTok{y2 }\OtherTok{=} \FunctionTok{dnorm}\NormalTok{(x, }\AttributeTok{mean =} \DecValTok{2}\NormalTok{, }\AttributeTok{sd =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{library}\NormalTok{(magrittr)}
\NormalTok{hline }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{y =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{type =} \StringTok{"line"}\NormalTok{, }
    \AttributeTok{x0 =} \DecValTok{0}\NormalTok{, }
    \AttributeTok{x1 =} \DecValTok{1}\NormalTok{, }
    \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{,}
    \AttributeTok{y0 =}\NormalTok{ y, }
    \AttributeTok{y1 =}\NormalTok{ y, }
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =}\NormalTok{ color, }\AttributeTok{dash =} \StringTok{\textquotesingle{}dash\textquotesingle{}}\NormalTok{, }\AttributeTok{width =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{vline }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{type =} \StringTok{"line"}\NormalTok{, }
    \AttributeTok{x0 =}\NormalTok{ x, }
    \AttributeTok{x1 =}\NormalTok{ x, }
    \AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
    \AttributeTok{y0 =} \DecValTok{0}\NormalTok{, }
    \AttributeTok{y1 =} \DecValTok{1}\NormalTok{, }
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =}\NormalTok{ color, }\AttributeTok{dash =} \StringTok{\textquotesingle{}dash\textquotesingle{}}\NormalTok{, }\AttributeTok{width =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y1,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"lines"}\NormalTok{,}
  \AttributeTok{fill =} \StringTok{"tozeroy"}\NormalTok{, }\AttributeTok{fillcolor =} \StringTok{"rgba(92, 184, 92, 0.2)"}\NormalTok{,}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
    \StringTok{"x："}\NormalTok{, x, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
    \StringTok{"y："}\NormalTok{, }\FunctionTok{round}\NormalTok{(y1, }\DecValTok{3}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}
\NormalTok{  ),}
  \AttributeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
  \AttributeTok{name =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{TeX}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathcal\{N\}(3,1\^{}2)"}\NormalTok{),}
  \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \StringTok{"spline"}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#5CB85C"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y2,}
    \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"lines"}\NormalTok{,}
    \AttributeTok{fill =} \StringTok{"tozeroy"}\NormalTok{, }\AttributeTok{fillcolor =} \StringTok{"rgba(91, 192, 222, 0.2)"}\NormalTok{,}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
      \StringTok{"x："}\NormalTok{, x, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"y："}\NormalTok{, }\FunctionTok{round}\NormalTok{(y2, }\DecValTok{3}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}
\NormalTok{    ),}
    \AttributeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
    \AttributeTok{name =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{TeX}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathcal\{N\}(2, 1.5\^{}2)"}\NormalTok{),}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \StringTok{"spline"}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#5BC0DE"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_segments}\NormalTok{(}
    \AttributeTok{x =} \DecValTok{2}\NormalTok{,}
    \AttributeTok{y =} \FloatTok{0.28}\NormalTok{,}
    \AttributeTok{xend =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{yend =} \FloatTok{0.28}\NormalTok{,}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{showlegend =}\NormalTok{ F}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_annotations}\NormalTok{(}
    \AttributeTok{x =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.3}\NormalTok{,}
    \AttributeTok{showarrow =}\NormalTok{ F, }\AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{24}\NormalTok{),}
    \AttributeTok{text =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{TeX}\NormalTok{(}\StringTok{"d"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_annotations}\NormalTok{(}
    \AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \DecValTok{1} \SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi), }
    \AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{100}\NormalTok{), }\AttributeTok{showarrow =}\NormalTok{ F,}
    \AttributeTok{text =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{TeX}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{frac\{1\}\{}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{sqrt\{2}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{pi\}\}"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_annotations}\NormalTok{(}
    \AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ (}\FloatTok{1.5} \SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)), }
    \AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{100}\NormalTok{), }\AttributeTok{showarrow =}\NormalTok{ F,}
    \AttributeTok{text =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{TeX}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{frac\{1\}\{1.5}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{sqrt\{2}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{pi\}\}"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{shapes =} \FunctionTok{list}\NormalTok{(}
      \FunctionTok{hline}\NormalTok{(}\AttributeTok{y =} \DecValTok{1} \SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi), }\AttributeTok{color =} \StringTok{"\#F27B0C"}\NormalTok{),}
      \FunctionTok{hline}\NormalTok{(}\AttributeTok{y =} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ (}\FloatTok{1.5} \SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)), }\AttributeTok{color =} \StringTok{"\#F27B0C"}\NormalTok{),}
      \FunctionTok{vline}\NormalTok{(}\AttributeTok{x =} \DecValTok{3}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#F27B0C"}\NormalTok{),}
      \FunctionTok{vline}\NormalTok{(}\AttributeTok{x =} \DecValTok{2}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#F27B0C"}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{title =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{TeX}\NormalTok{(}\StringTok{"x"}\NormalTok{)),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{title =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{TeX}\NormalTok{(}\StringTok{"f(x)"}\NormalTok{)),}
    \AttributeTok{legend =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\NormalTok{, }\AttributeTok{orientation =} \StringTok{"v"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{mathjax =} \StringTok{"cdn"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

R. A. Fisher 将抽样分布、参数估计和假设检验列为统计推断的三个中心内容，可见假设检验的重要地位

呈现常见检验的公式，将手写代码和 R 内置函数计算结果进行比较，每一组原假设和备择假设要说明对应的 R 函数和及其参数设置，尽量理论和代码并重，最后结合实际的数据予以解释说明。

Jacob Cohen 实际谈的是更加深刻的问题。开篇介绍为什么需要假设检验，做检验和不做检验有什么区别？ 杨灿老师在\href{https://d.cosx.org/d/420930/11}{讨论帖}提出检验的作用和实际应用问题

有了均值和方差，为什么还要位置参数和尺度参数？为了更一般地描述问题，扩展范围。

\href{https://rcompanion.org/handbook/}{Summary and Analysis of Extension Program Evaluation in R} 介绍了各类假设检验方法

\href{https://mbjoseph.github.io/posts/2018-12-27-the-iquit-r-video-series/}{The IQUIT R video series}

假设检验， 实验 A 和 B 的区分度 适用于在线服务的 A/B 测试方法论 \url{http://www.fengjunchen.com/}

\href{https://yihui.org/cn/2009/02/test-statistical-distributions/}{统计分布的检验}

\href{https://rpsychologist.com/d3/cohend/}{从心理学和可视化的角度谈 Cohen's d}

\href{https://yihui.org/cn/2008/09/introduction-to-bootstrap-and-permutation-test/}{Bootstrap 方法和置换/秩检验（Permutation Test）的入门读物}

\href{https://stats.stackexchange.com/questions/471232/optimal-unbalanced-design-for-a-b-test}{非平衡的 A/B 试验设计 Optimal unbalanced design for A/B test}

\href{https://stats.stackexchange.com/questions/471486/wilcoxon-wmwu-test-sensitivity}{Wilcoxon (WMWU) test sensitivity 检验的灵敏性}

\href{https://blog.ephorie.de/from-coin-tosses-to-p-hacking-make-statistics-significant-again}{从抛硬币到 P 值和统计显著性}

\href{https://blog.ephorie.de/learning-data-science-a-b-testing-in-under-one-minute}{一分钟学会 A/B 测试}

\href{https://github.com/kassambara/rstatix}{rstatix} 包提供了一个简明的管道友好的框架，和 tidyverse 的设计哲学保持一致，支持常见的统计检验，如 T 检验，Wilcoxon 检验，方差分析，Kruskal-Wallis 检验，相关性分析，并将结果整理成干净的数据框形式，以方便可视化。

\url{https://github.com/pieces201020/AB-Test-Sample-Size-Calculator} 又一个样本量计算器

\hypertarget{sec-ansari-test}{%
\section{\texorpdfstring{Ansari-Bradley 检验 \texttt{ansari.test}}{Ansari-Bradley 检验 ansari.test}}\label{sec-ansari-test}}

Ansari-Bradley 检验目的是检验两样本的尺度参数是否有显著性差异

尺度参数可以理解为方差 \(\sigma^2\)

位置参数可以理解为均值 \(\mu\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(ansari.test)}
\FunctionTok{ansari.test}\NormalTok{(x, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"ansari.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{ansari.test}\NormalTok{(x, y, }\AttributeTok{alternative =} \FunctionTok{c}\NormalTok{(}\StringTok{"two.sided"}\NormalTok{, }\StringTok{"less"}\NormalTok{, }\StringTok{"greater"}\NormalTok{), }\AttributeTok{exact =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{conf.int =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"ansari.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{ansari.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-bartlett-test}{%
\section{\texorpdfstring{Bartlett 检验 \texttt{bartlett.test}}{Bartlett 检验 bartlett.test}}\label{sec-bartlett-test}}

\texttt{ansari.test} 和 \texttt{mood.test} 是基于秩的两样本尺度参数显著性差异检验，是非参数检验

Bartlett 检验：检验各个组的方差是否有显著性差异，即方差齐性检验。

\texttt{var.test} 和 \texttt{bartlett.test} 都属于参数检验，用于检验方差齐性问题，前者考虑正态总体下方差齐性检验，后者没有对总体的分布形式做限定。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(bartlett.test)}
\FunctionTok{bartlett.test}\NormalTok{(x, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"bartlett.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{bartlett.test}\NormalTok{(x, g, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"bartlett.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{bartlett.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-binom-test}{%
\section{\texorpdfstring{二项检验 \texttt{binom.test}}{二项检验 binom.test}}\label{sec-binom-test}}

比例 \(p\) 的检验， 做 \(n\) 次独立试验，样本 \(X_1,\ldots,X_n \sim b(1, p)\)，事件发生的总次数 \(\sum_{i=1}^{n}X_i\)

函数 \texttt{binom.test} 用来检验伯努利试验中成功概率 \(p\) 和给定概率 \(p_0\) 的关系，属于精确检验。

编程手动实现一个，再调用函数计算，比较结果

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 模拟一组样本}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{size =} \DecValTok{100}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{prob =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\FloatTok{0.2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

二项分布中成功概率的检验

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{binom.test}\NormalTok{(}\FunctionTok{sum}\NormalTok{(x), }\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{p =} \FloatTok{0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Exact binomial test
## 
## data:  sum(x) and 100
## number of successes = 28, number of trials = 100, p-value = 1.258e-05
## alternative hypothesis: true probability of success is not equal to 0.5
## 95 percent confidence interval:
##  0.1947936 0.3786670
## sample estimates:
## probability of success 
##                   0.28
\end{verbatim}

检验成功概率 p 是否等于 0.5， P 值 \(6.148 \times 10^{-11}\) 结论是拒绝原假设

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{binom.test}\NormalTok{(}\FunctionTok{sum}\NormalTok{(x), }\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{p =} \FloatTok{0.2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Exact binomial test
## 
## data:  sum(x) and 100
## number of successes = 28, number of trials = 100, p-value = 0.05948
## alternative hypothesis: true probability of success is not equal to 0.2
## 95 percent confidence interval:
##  0.1947936 0.3786670
## sample estimates:
## probability of success 
##                   0.28
\end{verbatim}

检验成功概率 p 是否等于 0.2， P 值 0.7081 结论是不能拒绝原假设

二项检验 \citep{Test_1934_binom}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(binom.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
binom.test(x, n, p = 0.5, alternative = c("two.sided", "less", "greater"),
    conf.level = 0.95)
\end{verbatim}

\hypertarget{sec-Box-test}{%
\section{\texorpdfstring{时间序列独立性检验 \texttt{Box.test}}{时间序列独立性检验 Box.test}}\label{sec-Box-test}}

计算 Box-Pierce 或 Ljung-Box 检验统计量来检查给定时间序列的独立性假设。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(Box.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Box.test(x, lag = 1, type = c("Box-Pierce", "Ljung-Box"), fitdf = 0)
\end{verbatim}

\hypertarget{sec-chisq-test}{%
\section{\texorpdfstring{皮尔逊卡方检验 \texttt{chisq.test}}{皮尔逊卡方检验 chisq.test}}\label{sec-chisq-test}}

用于计数数据的皮尔逊卡方检验：列联表独立性检验和拟合优度检验

\texttt{chisq.test} \(\chi^2\) 检验：列联表检验和拟合优度检验

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(chisq.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
chisq.test(x, y = NULL, correct = TRUE, p = rep(1/length(x), length(x)),
    rescale.p = FALSE, simulate.p.value = FALSE, B = 2000)
\end{verbatim}

\hypertarget{sec-fisher-test}{%
\section{\texorpdfstring{费舍尔精确检验 \texttt{fisher.test}}{费舍尔精确检验 fisher.test}}\label{sec-fisher-test}}

固定边际的情况下，检验列联表行和列之间的独立性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(fisher.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
fisher.test(x, y = NULL, workspace = 2e+05, hybrid = FALSE,
    hybridPars = c(expect = 5, percent = 80, Emin = 1), control = list(),
    or = 1, alternative = "two.sided", conf.int = TRUE, conf.level = 0.95,
    simulate.p.value = FALSE, B = 2000)
\end{verbatim}

\hypertarget{sec-fligner-test}{%
\section{\texorpdfstring{方差齐性检验 \texttt{fligner.test}}{方差齐性检验 fligner.test}}\label{sec-fligner-test}}

Fligner-Killeen (中位数) 检验各个组的样本方差是不是一致的，也是方差齐性检验

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(fligner.test)}
\FunctionTok{fligner.test}\NormalTok{(x, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"fligner.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{fligner.test}\NormalTok{(x, g, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"fligner.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{fligner.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-friedman-test}{%
\section{\texorpdfstring{Friedman 秩和检验 \texttt{friedman.test}}{Friedman 秩和检验 friedman.test}}\label{sec-friedman-test}}

Friedman 秩和检验

Performs a Friedman rank sum test with unreplicated blocked data.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(friedman.test)}
\FunctionTok{friedman.test}\NormalTok{(y, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"friedman.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{friedman.test}\NormalTok{(y, groups, blocks, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"friedman.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{friedman.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-kruskal-test}{%
\section{\texorpdfstring{Kruskal-Wallis 秩和检验 \texttt{kruskal.test}}{Kruskal-Wallis 秩和检验 kruskal.test}}\label{sec-kruskal-test}}

Kruskal-Wallis 秩和检验

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(kruskal.test)}
\FunctionTok{kruskal.test}\NormalTok{(x, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"kruskal.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{kruskal.test}\NormalTok{(x, g, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"kruskal.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{kruskal.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ks-test}{%
\section{\texorpdfstring{同分布检验 \texttt{ks.test}}{同分布检验 ks.test}}\label{sec-ks-test}}

Lilliefors 检验 \footnote{\url{https://personal.utdallas.edu/~herve/Abdi-Lillie2007-pretty.pdf}} 和单样本的 ks 检验的关系

\begin{quote}
As to whether you can do a \textbf{Lilliefors test} for several groups, that depends entirely on your ability to understand what the underlying question would be (see Adams D 1979).

\hspace*{\fill} --- Knut M. Wittkowski \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2004-February/045597.html}}
\end{quote}

Kolmogorov-Smirnov 检验：单样本或两样本的同分布检验

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(ks.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
ks.test(x, y, ..., alternative = c("two.sided", "less", "greater"),
    exact = NULL)
\end{verbatim}

\hypertarget{sec-mantelhaen-test}{%
\section{\texorpdfstring{Cochran-Mantel-Haenszel 卡方检验 \texttt{mantelhaen.test}}{Cochran-Mantel-Haenszel 卡方检验 mantelhaen.test}}\label{sec-mantelhaen-test}}

用于计数数据的 Cochran-Mantel-Haenszel 卡方检验

Performs a Cochran-Mantel-Haenszel chi-squared test of the null that two nominal variables are conditionally independent in each stratum, assuming that there is no three-way interaction.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(mantelhaen.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
mantelhaen.test(x, y = NULL, z = NULL,
    alternative = c("two.sided", "less", "greater"), correct = TRUE,
    exact = FALSE, conf.level = 0.95)
\end{verbatim}

\hypertarget{sec-mauchly-test}{%
\section{\texorpdfstring{Mauchly 球形检验 \texttt{mauchly.test}}{Mauchly 球形检验 mauchly.test}}\label{sec-mauchly-test}}

检验：Wishart 分布的协方差矩阵是否正比于给定的矩阵

Mauchly's Test of Sphericity

Tests whether a Wishart-distributed covariance matrix (or transformation thereof) is proportional to a given matrix.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(mauchly.test)}
\FunctionTok{mauchly.test}\NormalTok{(object, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"mauchly.test.mlm"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}mlm\textquotesingle{}}
\FunctionTok{mauchly.test}\NormalTok{(object, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"mauchly.test.SSD"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}SSD\textquotesingle{}}
\FunctionTok{mauchly.test}\NormalTok{(object, }\AttributeTok{Sigma =} \FunctionTok{diag}\NormalTok{(}\AttributeTok{nrow =}\NormalTok{ p), }\AttributeTok{T =} \FunctionTok{Thin.row}\NormalTok{(}\FunctionTok{proj}\NormalTok{(M) }\SpecialCharTok{{-}} \FunctionTok{proj}\NormalTok{(X)),}
    \AttributeTok{M =} \FunctionTok{diag}\NormalTok{(}\AttributeTok{nrow =}\NormalTok{ p), }\AttributeTok{X =} \SpecialCharTok{\textasciitilde{}}\DecValTok{0}\NormalTok{, }\AttributeTok{idata =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{index =} \FunctionTok{seq\_len}\NormalTok{(p)), ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-mcnemar-test}{%
\section{\texorpdfstring{McNemar 卡方检验 \texttt{mcnemar.test}}{McNemar 卡方检验 mcnemar.test}}\label{sec-mcnemar-test}}

两种统计量的比较 参看谢益辉的博文 \href{https://yihui.org/cn/2010/05/asymptotia-mcnemar-test-statistics/}{渐近理想国：McNemar 检验的两种统计量}

用于计数数据的 McNemar's 卡方检验

McNemar's \(\chi^2\) 检验：检验二维列联表行和列的对称性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(mcnemar.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
mcnemar.test(x, y = NULL, correct = TRUE)
\end{verbatim}

\hypertarget{sec-mood-test}{%
\section{\texorpdfstring{Mood 方差检验 \texttt{mood.test}}{Mood 方差检验 mood.test}}\label{sec-mood-test}}

检验方差

Mood's 两样本检验：检验两样本尺度参数之间的差异性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(mood.test)}
\FunctionTok{mood.test}\NormalTok{(x, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"mood.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{mood.test}\NormalTok{(x, y, }\AttributeTok{alternative =} \FunctionTok{c}\NormalTok{(}\StringTok{"two.sided"}\NormalTok{, }\StringTok{"less"}\NormalTok{, }\StringTok{"greater"}\NormalTok{), ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"mood.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{mood.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-oneway-test}{%
\section{\texorpdfstring{单因素多重比较 \texttt{oneway.test}}{单因素多重比较 oneway.test}}\label{sec-oneway-test}}

单因素方差分析，各个组的方差不一定相同，检验两个及以上来自正态分布的样本是否有相同的均值？

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(oneway.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
oneway.test(formula, data, subset, na.action, var.equal = FALSE)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 假定方差不等}
\FunctionTok{oneway.test}\NormalTok{(extra }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ sleep)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  One-way analysis of means (not assuming equal variances)
## 
## data:  extra and group
## F = 3.4626, num df = 1.000, denom df = 17.776, p-value = 0.07939
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 假定方差相等}
\FunctionTok{oneway.test}\NormalTok{(extra }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ sleep, }\AttributeTok{var.equal =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  One-way analysis of means
## 
## data:  extra and group
## F = 3.4626, num df = 1, denom df = 18, p-value = 0.07919
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 和线性回归结果一样}
\FunctionTok{anova}\NormalTok{(}\FunctionTok{lm}\NormalTok{(extra }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ sleep))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Response: extra
##           Df Sum Sq Mean Sq F value  Pr(>F)  
## group      1 12.482 12.4820  3.4626 0.07919 .
## Residuals 18 64.886  3.6048                  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

CO2 数据

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# coplot(uptake \textasciitilde{} conc | Plant, data = CO2, show.given = FALSE, type = "b")}
\CommentTok{\# levels(CO2$Plant) \# Plant 是有序的}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(patchwork)}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ CO2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ conc, }\AttributeTok{y =}\NormalTok{ uptake)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ Treatment)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ Treatment)) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{Plant, }\AttributeTok{ncol =} \DecValTok{4}\NormalTok{, }\AttributeTok{dir =} \StringTok{"v"}\NormalTok{)}
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ CO2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ conc, }\AttributeTok{y =}\NormalTok{ uptake)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ Type)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ Type)) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{Plant, }\AttributeTok{ncol =} \DecValTok{4}\NormalTok{, }\AttributeTok{dir =} \StringTok{"v"}\NormalTok{)}
\NormalTok{p1 }\SpecialCharTok{/}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{hypothesis-test_files/figure-latex/CO2-1} 

}

\caption{草类植物吸收 CO2}\label{fig:CO2}
\end{figure}

\hypertarget{sec-pairwise-test}{%
\section{配对样本的检验}\label{sec-pairwise-test}}

配对样本和单样本的等价转化

\hypertarget{subsec-pairwise-prop-test}{%
\subsection{\texorpdfstring{配对比例检验 \texttt{pairwise.prop.test}}{配对比例检验 pairwise.prop.test}}\label{subsec-pairwise-prop-test}}

配对数据的比例检验

Pairwise comparisons for proportions

Calculate pairwise comparisons between pairs of proportions with correction for multiple testing

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(pairwise.prop.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
pairwise.prop.test(x, n, p.adjust.method = p.adjust.methods, ...)
\end{verbatim}

\hypertarget{subsec-pairwise-t-test}{%
\subsection{\texorpdfstring{配对 t 检验 \texttt{pairwise.t.test}}{配对 t 检验 pairwise.t.test}}\label{subsec-pairwise-t-test}}

Calculate pairwise comparisons between group levels with corrections for multiple testing

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(pairwise.t.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
pairwise.t.test(x, g, p.adjust.method = p.adjust.methods, pool.sd = !paired,
    paired = FALSE, alternative = c("two.sided", "less", "greater"), ...)
\end{verbatim}

谢益辉以配对组 t 检验谈 \href{https://yihui.org/cn/2018/02/cohen-s-d/}{Cohen's d}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pairwise.t.test}\NormalTok{(}\AttributeTok{x =}\NormalTok{ sleep}\SpecialCharTok{$}\NormalTok{extra, }\AttributeTok{g =}\NormalTok{ sleep}\SpecialCharTok{$}\NormalTok{group, }\AttributeTok{paired =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Pairwise comparisons using paired t tests 
## 
## data:  sleep$extra and sleep$group 
## 
##   1     
## 2 0.0028
## 
## P value adjustment method: holm
\end{verbatim}

成对的 t 检验

\hypertarget{subsec-pairwise-wilcox-test}{%
\subsection{\texorpdfstring{配对 Wilcoxon 检验 \texttt{pairwise.wilcox.test}}{配对 Wilcoxon 检验 pairwise.wilcox.test}}\label{subsec-pairwise-wilcox-test}}

Pairwise Wilcoxon Rank Sum Tests 配对的 Wilcoxon 秩和检验

Calculate pairwise comparisons between group levels with corrections for multiple testing.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(pairwise.wilcox.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
pairwise.wilcox.test(x, g, p.adjust.method = p.adjust.methods, paired = FALSE,
    ...)
\end{verbatim}

\hypertarget{subsec-cor-test}{%
\subsection{\texorpdfstring{配对样本相关性检验 \texttt{cor.test}}{配对样本相关性检验 cor.test}}\label{subsec-cor-test}}

配对样本的相关性检验：Pearson's 相关系数

Test for association between paired samples, using one of Pearson's product moment correlation coefficient,

Kendall's \(\tau\) 检验或者 Spearman's \(\rho\) 检验.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(cor.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
cor.test(x, ...)
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{Kendall::Kendall} \citep{Kendall}
\item
  \texttt{SuppDists::pKendall} 和 \texttt{SuppDists::pSpearman} \citep{SuppDists}
\item
  \texttt{pspearman::spearman.test} \citep{pspearman}
\end{itemize}

\hypertarget{sec-poisson-test}{%
\section{\texorpdfstring{精确泊松检验 \texttt{poisson.test}}{精确泊松检验 poisson.test}}\label{sec-poisson-test}}

泊松分布是 1837年由法国数学家泊松 (Poisson, 1781-1840) 首次提出

泊松分布的参数 \(\lambda (>0)\) 的精确检验

Performs an exact test of a simple null hypothesis about the rate parameter in Poisson distribution, or for the ratio between two rate parameters. 适用于单样本和两样本

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(poisson.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
poisson.test(x, T = 1, r = 1, alternative = c("two.sided", "less", "greater"),
    conf.level = 0.95)
\end{verbatim}

\hypertarget{sec-PP-test}{%
\section{\texorpdfstring{单位根检验 \texttt{PP.test}}{单位根检验 PP.test}}\label{sec-PP-test}}

时间序列平稳性检验

Phillips-Perron 的单位根检验

Computes the Phillips-Perron test for the null hypothesis that x has a unit root against a stationary alternative.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(PP.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
PP.test(x, lshort = TRUE)
\end{verbatim}

\hypertarget{sec-prop-test}{%
\section{\texorpdfstring{比例检验 \texttt{prop.test}}{比例检验 prop.test}}\label{sec-prop-test}}

函数 \texttt{prop.test} 用来检验两组或多组二项分布的成功概率（比例）是否相等，或等于给定的值。近似检验

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(prop.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
prop.test(x, n, p = NULL, alternative = c("two.sided", "less", "greater"),
    conf.level = 0.95, correct = TRUE)
\end{verbatim}

设随机变量 X 服从参数为 \(p\) 的二项分布 \(b(n, p)\)， \(Y\) 服从参数为 \(\theta\) 的二项分布 \(b(m,\theta)\)， \(m,n\) 都假定为较大的正整数，检验如下问题

\[
H_0: P_A \geq P_B \quad vs. \quad H_1: P_A < P_B
\]

根据中心极限定理

\[
\frac{\bar{X} - \bar{Y}}{\sqrt{\frac{p(1-p)}{n} + \frac{\theta(1-\theta)}{m}}}
\] 近似服从标准正态分布 \(N(0,1)\)。如果用矩估计 \(\bar{X}\) 和 \(\bar{Y}\) 分别替代总体参数 \(p\) 和 \(\theta\)，构造检验统计量

\[
T = \frac{\bar{X} - \bar{Y}}{\sqrt{\frac{\bar{X}(1-\bar{X})}{n} + \frac{\bar{Y}(1-\bar{Y})}{m}}}
\] 根据 Slutsky 定理，检验统计量 \(T\) 近似服从标准正态分布，当 \(T\) 偏大时，拒绝 \(H_0\)。该方法的优势在于当 \(n,m\) 比较大时，二项分布比较复杂，无法建立统计表，利用标准正态分布表来给出检验所需要的临界值，简便易行！

当 \(p\) 和 \(\theta\) 都比较小，上述方法检验效果不好，原因在于由中心极限定理对 \(\bar{X}\) 和 \(\bar{Y}\) 的正态分布近似效果不好，或者间接地导致 \(\bar{X}-\bar{Y}\) 的方差偏小，进而 \(T\) 的分辨都不好，而且当 \(p,\theta\) 很接近 1 时，上述现象也会产生！

下面介绍新的解决办法

上面的检验问题等价于

\[
H_0: \frac{P_A}{P_B} \geq 1 \quad vs. \quad H_1: \frac{P_A}{P_B} < 1
\]

引入检验统计量

\[
T^{\star} = \frac{\bar{X}}{\bar{Y}}
\] 同样由 Slutsky 定理和中心极限定理可知， \(\bar{X}/\bar{Y}\) 近似服从 正态分布\(N(1,\frac{1-\theta}{m\theta})\)

当 \((T^\star - 1)/\hat\sigma\) 偏大时接受 \(H_0\)，临界值可通过 \(N(0, \hat\sigma^2)\) 分布表计算得到， \(\hat\sigma^2\) 是对 \(\frac{1-\theta}{m\theta}\) 的估计，比如取 \(\hat\sigma^2 = \frac{1-\bar{Y}}{m}\cdot \frac{1}{\bar{Y}}\) 或取 \(\hat\sigma^2 = \frac{1-\bar{Y}}{m}\cdot \frac{1}{\bar{X}}\)

由于渐近方差形如 \(\frac{1-\theta}{m\theta}\)，因而在 \(\theta\) 较小，渐近方差较大，克服了之前 \(\bar{X} - \bar{Y}\)的方差较小的问题

\(p,\theta\) 很接近 1 时，我们取检验统计量

\[
T^{\star\star} = \frac{1-\bar{Y}}{1-\bar{X}}
\] 结论和 \(T^\star\) 类似，当 \(T^{\star\star}\) 偏大时，拒绝 \(H_0\)。

两个二项总体成功概率的比较 \citep{Prop_2011_Song}

\hypertarget{subsec-equivalent-test}{%
\subsection{两个独立二项总体等价性检验}\label{subsec-equivalent-test}}

关于比例的检验问题

\begin{align}
H_0: P_A = P_B \quad vs. \quad H_1: P_A > P_B \\
H_0: P_A = P_B \quad vs. \quad H_1: P_A < P_B
\end{align}

\(H_0\) 成立的情况下，暗示着两个样本来自同一总体。在这种假设设置下，拒绝原假设是不是意味着接受备择假设？如何判断样本点会落在哪个拒绝域内呢？

2009 年东南大学韦博成教授将两个独立二项总体的等价性检验应用于《红楼梦》前80回与后40回某些文风差异的统计分析 \citep{Stone_2009_Wei}

\hypertarget{subsec-ctr}{%
\subsection{不同页面的点击率问题}\label{subsec-ctr}}

CTR：点击率 Click Ratio

矩阵 x 第一行表示页面 A 的点击情况，即 1000 次展示有 500 次点击，第二行表示页面 B 的点击情况，即 100 次展示有 80 次点击。通过统计检验的方式比较页面 A 和 B 的点击率哪个更好？

\begin{longtable}[]{@{}ccc@{}}
\toprule
& S & F \\
\midrule
\endhead
A & 500 & 500 \\
B & 80 & 20 \\
\bottomrule
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(x }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{20}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{FALSE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]  500  500
## [2,]   80   20
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 等价于 prop.test(x, alternative = "two.sided", correct = TRUE)}
\FunctionTok{prop.test}\NormalTok{(x) }\CommentTok{\# 默认参数设置情形是双边检验}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  2-sample test for equality of proportions with continuity correction
## 
## data:  x
## X-squared = 31.632, df = 1, p-value = 1.863e-08
## alternative hypothesis: two.sided
## 95 percent confidence interval:
##  -0.3898012 -0.2101988
## sample estimates:
## prop 1 prop 2 
##    0.5    0.8
\end{verbatim}

默认的假设检验问题

\[
H_0: P_A = P_B \quad vs. \quad H_1: P_A \ne P_B
\]

输出结果中 alternative hypothesis 表示备择假设，参数 \texttt{alternative} 指定备择假设的形式

备择假设 \(P_A < P_B\) 对应

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prop.test}\NormalTok{(x, }\AttributeTok{alternative =} \StringTok{"less"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  2-sample test for equality of proportions with continuity correction
## 
## data:  x
## X-squared = 31.632, df = 1, p-value = 9.315e-09
## alternative hypothesis: less
## 95 percent confidence interval:
##  -1.0000000 -0.2237522
## sample estimates:
## prop 1 prop 2 
##    0.5    0.8
\end{verbatim}

P 值 \(9.315\times 10^{-09}\) 结论是拒绝原假设，并且接受备择假设，即 \(P_A < P_B\)，在原假设成立的情况下，样本落入拒绝域的概率很小，小于 0.05，即在一次实验中，样本不可能落入拒绝域，应当接受原假设，因为将备择假设设为

备择假设 \(P_A > P_B\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prop.test}\NormalTok{(x, }\AttributeTok{alternative =} \StringTok{"greater"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  2-sample test for equality of proportions with continuity correction
## 
## data:  x
## X-squared = 31.632, df = 1, p-value = 1
## alternative hypothesis: greater
## 95 percent confidence interval:
##  -0.3762478  1.0000000
## sample estimates:
## prop 1 prop 2 
##    0.5    0.8
\end{verbatim}

P 值为 1 不能拒绝原假设，在原假设成立的情况下，样本落入拒绝域的概率是 1

备择假设和原假设在这里是对立的关系

页面 A 观测到的点击率为 \(50\%\) 页面 B 观测到的点击率为 \(80\%\)，设置检验问题

\[
H_0: P_A = P_B \quad vs. \quad H_1: P_A \leq P_B
\]

页面点击率 A 等于 B，则备择假设页面点击率 A 不大于 B

默认启用 Yates' 连续性校正 (continuity correction, 简称 CC)

\hypertarget{subsec-prop-home}{%
\subsection{比例齐性检验}\label{subsec-prop-home}}

原假设四个组里面病人中吸烟的比例是相同的，备择假设是四个组里面至少有一个组的吸烟比例是不同的

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Data from Fleiss (1981), p. 139.}
\DocumentationTok{\#\# H0: The null hypothesis is that the four populations from which}
\DocumentationTok{\#\#     the patients were drawn have the same true proportion of smokers.}
\DocumentationTok{\#\# A:  The alternative is that this proportion is different in at}
\DocumentationTok{\#\#     least one of the populations.}

\NormalTok{smokers }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{83}\NormalTok{, }\DecValTok{90}\NormalTok{, }\DecValTok{129}\NormalTok{, }\DecValTok{70}\NormalTok{)}
\NormalTok{patients }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{86}\NormalTok{, }\DecValTok{93}\NormalTok{, }\DecValTok{136}\NormalTok{, }\DecValTok{82}\NormalTok{)}
\FunctionTok{prop.test}\NormalTok{(smokers, patients)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  4-sample test for equality of proportions without continuity
##  correction
## 
## data:  smokers out of patients
## X-squared = 12.6, df = 3, p-value = 0.005585
## alternative hypothesis: two.sided
## sample estimates:
##    prop 1    prop 2    prop 3    prop 4 
## 0.9651163 0.9677419 0.9485294 0.8536585
\end{verbatim}

Wilson 检验统计量 \citep{Test_1927_prop} 考虑单样本比例 \(p\) 的区间估计问题，

Probable Inference (Usual): 可能的推断，或然推断，概率推断

在某个总体中抽取 n 个样本，观测到某个比率/频率 \(p_0\)，相应的标准差 \(\sigma_0 = (p_0q_0/n)^{1/2}\)，常见的概率推断表述是说：比率 \(p\) 的真值落在区间 \([p_0 - \lambda\sigma_0, p_0 + \lambda\sigma_0]\) 外的概率小于等于 \(P_\lambda\)，并且随着 \(\lambda\) 增大， \(P_\lambda\) 减小。

如果使用 Tchebysheff 切比雪夫准则，我们知道 \(P_\lambda\) 本身小于 \(1/\lambda^2\)，但是如果使用概率表 \(P_\lambda\) 是概率密度曲线与坐标 \(\pm\lambda\sigma_0\) 之外的部分围成的面积。尽管切比雪夫准则在估计 \(P_\lambda\) 的时候过于保守，但是概率表给出了一个本质的估计。

严格来说，上面给出的概率推断的表述是简略的。真实概率\(p\)落在指定范围之外的机会要么是 0 要么是 1，就是说 \(p\) 要么在那个范围要么不在那个范围。观测的比率 \(p_0\) 有更大或更小的机会落在真实比率 \(p\) 的某个区间。观测者运气不好，观测到一个相对罕见的事件发生了，基于已有的推断理论，他会获得一个相当宽的标记。

Probable Inference (Improved):

一个更好的方式来阐述推理过程：

有某个比率 \(p\) 它的标准差是 \((pq/n)^{1/2} = \sigma\)，一个观测糟糕如 \(p_0\) 发生的可能性，即 \(p_0\) 落在区间 \([p - \lambda\sigma,p + \lambda\sigma]\) 是小于等于 \(P_\lambda\)。

这个表述强调了特殊观测相对于一般典型情况更容易犯的错误。

两样本比例 \(p\) 的检验问题。

思路需要推导，考虑如下检验问题

\[
H_0: P_A \geq P_B \quad vs. \quad H_1: P_A < P_B
\]

比例检验，未知 p 的情况下，且样本量有限，是 t 分布 多种二项检验的办法 \citep{Interval_1998_Newcombe}

\begin{rmdtip}{提示}
切比雪夫不等式 Chebyshev, 1821-1894

设随机变量 \(X\) 的数学期望和方差都存在，则对任意常数 \(\epsilon > 0\)，有

\begin{align}
P(|X - EX| \geq \epsilon) & \leq \frac{Var(X)}{\epsilon^2} \\
P(|X - EX| \leq \epsilon) & \geq 1 - \frac{Var(X)}{\epsilon^2}
\end{align}

\end{rmdtip}

\hypertarget{sec-prop-trend-test}{%
\section{\texorpdfstring{比例趋势检验 \texttt{prop.trend.test}}{比例趋势检验 prop.trend.test}}\label{sec-prop-trend-test}}

Performs \(\chi^2\) test for trend in proportions, i.e., a test asymptotically optimal for local alternatives where the log odds vary in proportion with score. By default, score is chosen as the group numbers.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(prop.trend.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
prop.trend.test(x, n, score = seq_along(x))
\end{verbatim}

\hypertarget{sec-quade-test}{%
\section{\texorpdfstring{Quade 检验 \texttt{quade.test}}{Quade 检验 quade.test}}\label{sec-quade-test}}

Quade Test

Performs a Quade test with unreplicated blocked data.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(quade.test)}
\FunctionTok{quade.test}\NormalTok{(y, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"quade.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{quade.test}\NormalTok{(y, groups, blocks, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"quade.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{quade.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-shapiro-test}{%
\section{\texorpdfstring{正态性检验 \texttt{shapiro.test}}{正态性检验 shapiro.test}}\label{sec-shapiro-test}}

\begin{quote}
Usually (but not always) doing tests of normality reflect a lack of understanding of the power of rank tests, and an assumption of high power for the tests (qq plots don't always help with that because of their subjectivity). When possible it's good to choose a robust method. Also, doing pre-testing for normality can affect the type I error of the overall analysis.

\hspace*{\fill} --- Frank Harrell \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2005-April/070508.html}}
\end{quote}

检验：拒绝原假设和接受原假设的风险，数据本身和理论的正态分布的距离，抛开 P 值

Shapiro 和 Wilk's 提出的 W 检验

Performs the Shapiro-Wilk test of normality.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(shapiro.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
shapiro.test(x)
\end{verbatim}

\hypertarget{sec-ep-test}{%
\section{正态性检验 Epps-Pully 检验}\label{sec-ep-test}}

\begin{quote}
The issue really comes down to the fact that the questions: ``exactly normal?'', and ``normal enough?'' are 2 very different questions (with the difference becoming greater with increased sample size) and while the first is the easier to answer, the second is generally the more useful one.

\hspace*{\fill} --- Greg Snow \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2009-May/390164.html}}
\end{quote}

EP 检验对多种备择假设有较高的效率，利用样本的特征函数和正态分布的特征函数的差的模的平方产生的一个加权积分得到 EP 检验统计量 \citep{EP_1983_normality}

\begin{rmdtip}{提示}
样本量 \(n \geq 200\) EP 检验统计量 \(T_{EP}\) 非常接近 \(n = \infty\) 时 \(T_{EP}\) 的分位数。

\end{rmdtip}

设 \(x_1, \ldots, x_n\) 是来自正态总体 \(N(\mu,\sigma^2)\) 的样本， EP 检验统计量定义为

\[
T_{EP} = 1 + \frac{n}{\sqrt{3}} + \frac{2}{n}\sum_{i=2}^{n}\sum_{j=1}^{i-1}\exp\big\{ - \frac{(x_j - x_i)^2}{2s^2_{\star}}  \big\} - \sqrt{2} \sum_{i=1}^{n}\exp\big\{- \frac{(x_i - \bar{x})^2}{4s^2_{\star}}  \big\}
\]

其中 \(\bar{x},s^2_{\star}\) 就是样本均值和（除以 \(n\) 的）样本方差

\begin{rmdtip}{提示}
几个正态性检验的功效比较 \url{https://arxiv.org/ftp/arxiv/papers/1605/1605.06293.pdf} 和 PoweR 包 \citep{JSS_2016_PoweR}

\end{rmdtip}

\hypertarget{sec-t-test}{%
\section{\texorpdfstring{学生 t 检验 \texttt{t.test}}{学生 t 检验 t.test}}\label{sec-t-test}}

\begin{quote}
t 分布的推导、 t 分布的形式 两样本的均值检验到 Behrens-Fisher 问题到大规模推荐系统中的 A/B 检验
\end{quote}

\hypertarget{subsec-two-samples}{%
\subsection{正态总体两样本的均值之差的检验}\label{subsec-two-samples}}

常见检验问题

\begin{align}
\mathrm{I}   \quad H_0: \mu_1 - \mu_2 \leq 0 \quad vs. \quad H_1: \mu_1 - \mu_2 > 0 \\
\mathrm{II}  \quad H_0: \mu_1 - \mu_2 \geq 0 \quad vs. \quad H_1: \mu_1 - \mu_2 < 0 \\
\mathrm{III} \quad H_0: \mu_1 - \mu_2 = 0 \quad vs. \quad H_1: \mu_1 - \mu_2 \neq 0
\end{align}

\hypertarget{ux65b9ux5dee-sigma2_1sigma2_2-ux5df2ux77e5}{%
\subsubsection{\texorpdfstring{方差 \(\sigma^2_1,\sigma^2_2\) 已知}{方差 \textbackslash sigma\^{}2\_1,\textbackslash sigma\^{}2\_2 已知}}\label{ux65b9ux5dee-sigma2_1sigma2_2-ux5df2ux77e5}}

\begin{quote}
检验统计量服从标准正态分布
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\AttributeTok{mean =} \DecValTok{10}\NormalTok{, }\AttributeTok{sd =} \FloatTok{2.5}\NormalTok{)}
\NormalTok{y1 }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{80}\NormalTok{, }\AttributeTok{mean =} \DecValTok{6}\NormalTok{, }\AttributeTok{sd =} \FloatTok{4.5}\NormalTok{)}
\NormalTok{u0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(x1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(y1)) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\FloatTok{2.5}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{/} \DecValTok{100} \SpecialCharTok{+} \FloatTok{4.5}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{/} \DecValTok{80}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\[
u = \frac{(\bar{X} - \bar{Y}) - (\mu_1 - \mu_2)}{\sqrt{\frac{\sigma^2_1}{m} + \frac{\sigma^2_2}{n}} }
\]

\(u \sim N(0,1)\)，检验统计量 \(u\) 对应的样本值 \(u_0\)，检验的拒绝域和 \(P\) 值如下

\[
W_1 = \{u \geq u_{1 - \alpha} \}, \quad p_1 = 1 - \varPhi(u_0) 
\]

对检验问题 I，给定显著性水平 \(\alpha = 0.05\)，得出拒绝域 \(\{ u \geq 1.645\}\)，计算样本观察值得到的检验统计量的值 \(u_0 = 7.946\)，而该值落在拒绝域，所以拒绝原假设，即拒绝 \(\mu_1 - \mu_2 \leq 0\)，则接受 \(\mu_1 - \mu_2 > 0\)。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 计算拒绝域}
\FunctionTok{qnorm}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}} \FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.644854
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 计算 P 值}
\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{pnorm}\NormalTok{(u0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 9.992007e-16
\end{verbatim}

\hypertarget{ux65b9ux5dee-sigma2_1-sigma2_2-sigma2-ux672aux77e5}{%
\subsubsection{\texorpdfstring{方差 \(\sigma^2_1 = \sigma^2_2 = \sigma^2\) 未知}{方差 \textbackslash sigma\^{}2\_1 = \textbackslash sigma\^{}2\_2 = \textbackslash sigma\^{}2 未知}}\label{ux65b9ux5dee-sigma2_1-sigma2_2-sigma2-ux672aux77e5}}

\begin{quote}
检验统计量服从自由度为 \(m + n - 2\) 的 t 分布
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\AttributeTok{mean =} \DecValTok{10}\NormalTok{, }\AttributeTok{sd =} \FloatTok{4.5}\NormalTok{)}
\NormalTok{y1 }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{80}\NormalTok{, }\AttributeTok{mean =} \DecValTok{6}\NormalTok{, }\AttributeTok{sd =} \FloatTok{4.5}\NormalTok{)}
\NormalTok{s\_w }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ (}\DecValTok{100} \SpecialCharTok{+} \DecValTok{80} \SpecialCharTok{{-}} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ ((}\DecValTok{100} \SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{var}\NormalTok{(x1) }\SpecialCharTok{+}\NormalTok{ (}\DecValTok{80} \SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{var}\NormalTok{(y1)))}
\NormalTok{t0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(x1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(y1)) }\SpecialCharTok{/}\NormalTok{ (s\_w }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/} \DecValTok{100} \SpecialCharTok{+} \DecValTok{1} \SpecialCharTok{/} \DecValTok{80}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

样本观察值 \(t_0 = 6.6816 > t_{0.95}(100 + 80 -2) = 1.653\) 落在拒绝域内，对于检验问题 I 我们要拒绝原假设

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 临界值：0.95 分位点对应的分位数}
\FunctionTok{qt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}} \FloatTok{0.05}\NormalTok{, }\AttributeTok{df =} \DecValTok{100} \SpecialCharTok{+} \DecValTok{80} \SpecialCharTok{{-}} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.653459
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# p 值}
\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{pt}\NormalTok{(t0, }\AttributeTok{df =} \DecValTok{100} \SpecialCharTok{+} \DecValTok{80} \SpecialCharTok{{-}} \DecValTok{2}\NormalTok{, }\AttributeTok{lower.tail =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.461666e-10
\end{verbatim}

利用 R 内置的 \texttt{t.test()} 函数计算

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t.test}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x1, }\AttributeTok{y =}\NormalTok{ y1, }\AttributeTok{alternative =} \StringTok{"greater"}\NormalTok{, }\AttributeTok{var.equal =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Two Sample t-test
## 
## data:  x1 and y1
## t = 6.6816, df = 178, p-value = 1.462e-10
## alternative hypothesis: true difference in means is greater than 0
## 95 percent confidence interval:
##  3.249227      Inf
## sample estimates:
## mean of x mean of y 
##  9.669997  5.352296
\end{verbatim}

与线性回归比较

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(x1, y1),}
  \AttributeTok{group =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{"x1"}\NormalTok{, }\FunctionTok{length}\NormalTok{(x1)), }\FunctionTok{rep}\NormalTok{(}\StringTok{"y1"}\NormalTok{, }\FunctionTok{length}\NormalTok{(y1)))}
\NormalTok{)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(value }\SpecialCharTok{\textasciitilde{}} \DecValTok{1} \SpecialCharTok{+} \FunctionTok{I}\NormalTok{(group }\SpecialCharTok{==} \StringTok{"y1"}\NormalTok{), }\AttributeTok{data =}\NormalTok{ dat)}
\CommentTok{\# fit \textless{}{-} lm(value \textasciitilde{} 0 + I(group == "y1"), data = dat) \# 无截距项}
\FunctionTok{summary}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = value ~ 1 + I(group == "y1"), data = dat)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -11.2282  -3.0198  -0.2959   3.0161  12.1921 
## 
## Coefficients:
##                      Estimate Std. Error t value Pr(>|t|)    
## (Intercept)            9.6700     0.4308  22.446  < 2e-16 ***
## I(group == "y1")TRUE  -4.3177     0.6462  -6.682 2.92e-10 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 4.308 on 178 degrees of freedom
## Multiple R-squared:  0.2005, Adjusted R-squared:  0.196 
## F-statistic: 44.64 on 1 and 178 DF,  p-value: 2.923e-10
\end{verbatim}

\begin{rmdnote}{注意}
lm 回归和 t 检验的差别，回归系数第二行， t 统计量为 -6.682，P 值为 2.92e-10，前者是因为截距项，后者是因为双边检验（模型系数显著性检验是和0比较），所以有2倍的关系。直观解释详见 \href{https://cosx.org/2019/09/common-tests-as-linear-models/}{翻译：常见统计检验的本质都是线性模型（或：如何教统计学）}

\end{rmdnote}

两样本方差不齐、样本量严重不等，在大样本和小样本情况下的比较， \href{https://yihui.org/cn/2010/01/unequal-variance-in-t-test/}{t 检验方差不齐有多重要}

\hypertarget{ux65b9ux5dee-sigma2_1-sigma2_2-ux5df2ux77e5}{%
\subsubsection{\texorpdfstring{方差 \(\sigma^2_1 / \sigma^2_2\) 已知}{方差 \textbackslash sigma\^{}2\_1 / \textbackslash sigma\^{}2\_2 已知}}\label{ux65b9ux5dee-sigma2_1-sigma2_2-ux5df2ux77e5}}

方差比 \(c = \sigma^2_1 / \sigma^2_2\) 已知

\hypertarget{ux65b9ux5dee-sigma2_1-sigma2_2-ux672aux77e5}{%
\subsubsection{\texorpdfstring{方差 \(\sigma^2_1 / \sigma^2_2\) 未知}{方差 \textbackslash sigma\^{}2\_1 / \textbackslash sigma\^{}2\_2 未知}}\label{ux65b9ux5dee-sigma2_1-sigma2_2-ux672aux77e5}}

英国统计学家 William Sealy Gosset (1876-1937) 于 1908 年在杂志 《Biometrics》 上以笔名 Student 发表论文《The probable error of a mean》\citep{Students_1908_Gosset}，论文中展示了独立同正态分布的样本 \(x_1, \ldots, x_n \stackrel{i.i.d}{\sim} \mathcal{N}(\mu,\sigma^2)\) 的样本方差 \(s^2\) 和样本标准差 \(s\) 的抽样分布，根据均值和标准差不相关的性质导出 t 分布，宣告 t 分布的诞生，因其在小样本领域的突出贡献，W. S. Gosset 进入世纪名人录 \citep{Statisticians_2001_Heyde}

\[\frac{(n-1)s^2}{\sigma^2} \sim \chi^2(n-1)\]

\[\frac{\bar{x} - \mu}{s/\sqrt{n}} \sim t(n-1)\]

\[E(s^2) = \sigma^2, \quad Var(s^2) = \frac{2\sigma^4}{n-1}\]

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  两样本的样本量很大，总体方差未知，检验两样本均值的显著性检验，极限分布是正态，\(u\) 检验
\item
  两个样本的样本量不是很大，总体方差也未知，检验两样本均值的显著性检验，即著名的 Behrens-Fisher 问题，Welsh 在 1938 年提出近似服从自由度为 \(\ell\) 的 t 分布。
\end{enumerate}

Egon Pearson 接过他父亲 Karl Pearson 的职位，担任伦敦大学学院的高尔顿统计教授

许宝騄在 Jerzy Neyman 和 Egon Pearson 主编的杂志《Statistical Research Memoirs》发表第一篇关于 Behrens-Fisher 问题的论文

这里提及许宝騄（Pao-Lu Hsu）的贡献 \citep{Student_1938_HSU}，

陈家鼎和郑忠国一起整理了许宝騄的生平事迹和学术成就，见\href{https://www.math.pku.edu.cn/misc/probstat/doc.pdf}{《许宝騄先生的生平和学术成就》}。

1998 年关于 Behrens-Fisher 问题的综述 \citep{Behrens_1998_Kim}

钟开涞（Kai-Lai Chung）将许宝騄的论文集整理出版 \citep{Collected_1983_HSU}

\texttt{t.test()} 提供单样本和两样本的检验

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(t.test)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}test\textquotesingle{}}
\FunctionTok{t}\NormalTok{(x, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"t.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{t.test}\NormalTok{(x, }\AttributeTok{y =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{alternative =} \FunctionTok{c}\NormalTok{(}\StringTok{"two.sided"}\NormalTok{, }\StringTok{"less"}\NormalTok{, }\StringTok{"greater"}\NormalTok{), }\AttributeTok{mu =} \DecValTok{0}\NormalTok{,}
    \AttributeTok{paired =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{var.equal =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"t.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{t.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

学生睡眠数据 sleep 见图 \ref{fig:sleep}

\begin{figure}

{\centering \includegraphics[width=0.5\linewidth]{hypothesis-test_files/figure-latex/sleep-1} \includegraphics[width=0.5\linewidth]{hypothesis-test_files/figure-latex/sleep-2} 

}

\caption{学生睡眠数据 sleep}\label{fig:sleep}
\end{figure}

两个样本的 Welch's t 检验，总体方差未知，样本量也不大，两样本均值差的显著性检验

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 等价于 with(sleep, t.test(extra[group == 1], extra[group == 2]))}
\FunctionTok{t.test}\NormalTok{(extra }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ sleep)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  extra by group
## t = -1.8608, df = 17.776, p-value = 0.07939
## alternative hypothesis: true difference in means between group 1 and group 2 is not equal to 0
## 95 percent confidence interval:
##  -3.3654832  0.2054832
## sample estimates:
## mean in group 1 mean in group 2 
##            0.75            2.33
\end{verbatim}

实际上睡眠数据是配对的，我们可以做配对数据的检验

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 数据变形操作，长格式变为宽格式}
\NormalTok{sleep2 }\OtherTok{\textless{}{-}} \FunctionTok{reshape}\NormalTok{(sleep,}
  \AttributeTok{direction =} \StringTok{"wide"}\NormalTok{,}
  \AttributeTok{idvar =} \StringTok{"ID"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"group"}
\NormalTok{)}
\CommentTok{\# R 4.0.0}
\FunctionTok{t.test}\NormalTok{(}\FunctionTok{Pair}\NormalTok{(extra}\FloatTok{.1}\NormalTok{, extra}\FloatTok{.2}\NormalTok{) }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{data =}\NormalTok{ sleep2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Paired t-test
## 
## data:  Pair(extra.1, extra.2)
## t = -4.0621, df = 9, p-value = 0.002833
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -2.4598858 -0.7001142
## sample estimates:
## mean of the differences 
##                   -1.58
\end{verbatim}

\begin{rmdnote}{注意}
函数 \texttt{t.test()} 和 \texttt{wilcox.test()} 的公式接口要求 R 版本在 4.0.0 及以上

\end{rmdnote}

\hypertarget{office-ttest}{%
\subsection{办公软件里的 T 检验}\label{office-ttest}}

以 MacOS 上的 Numbers 表格软件为例，如图\ref{fig:numbers-ttest}所示，首先打开 Numbers 软件，新建工作表，输入两组数值，然后点击空白处，再从顶部导航栏找到「插入」菜单，「公式」选项，点击扩展选项「新建公式」，在弹出的会话条里输入 TTEST，依次选择第一组，第二组值，检验类型和样本类型，最后点击确认，即可得到两样本 T 检验的 P 值结果。

\begin{figure}

{\centering \includegraphics[width=0.85\linewidth]{screenshots/number-ttest} 

}

\caption{MacOS 的办公软件 Numbers 做两样本 T 检验}\label{fig:numbers-ttest}
\end{figure}

微软 Excel 办公软件也提供 T 检验计算器，和 MacOS 系统上的 Numbers 办公软件类似，它提供 \texttt{T.TEST} 函数，计算结果也一样，此处从略。R 软件自带 \texttt{t.test()} 函数，也是用于做 T 检验，如下：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t.test}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{19}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{14}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{17}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  c(3, 4, 5, 8, 9, 1, 2, 4, 5) and c(6, 19, 3, 2, 14, 4, 5, 17, 1)
## t = -1.3622, df = 10.255, p-value = 0.2023
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -8.767183  2.100516
## sample estimates:
## mean of x mean of y 
##  4.555556  7.888889
\end{verbatim}

\hypertarget{sec-var-test}{%
\section{\texorpdfstring{方差比检验 \texttt{var.test}}{方差比检验 var.test}}\label{sec-var-test}}

\textbf{TeachingDemos} 的 \texttt{sigma.test()} 方差检验，适用于正态总体，它对非正态性很敏感。

F 检验：来自正态总体的两个样本的方差比较

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(var.test)}
\FunctionTok{var.test}\NormalTok{(x, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"var.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{var.test}\NormalTok{(x, y, }\AttributeTok{ratio =} \DecValTok{1}\NormalTok{, }\AttributeTok{alternative =} \FunctionTok{c}\NormalTok{(}\StringTok{"two.sided"}\NormalTok{, }\StringTok{"less"}\NormalTok{, }\StringTok{"greater"}\NormalTok{),}
    \AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"var.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{var.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-wilcox-test}{%
\section{\texorpdfstring{Wilcoxon 秩和检验 \texttt{wilcox.test}}{Wilcoxon 秩和检验 wilcox.test}}\label{sec-wilcox-test}}

单样本 Wilcoxon 秩和检验，两样本 Wilcoxon 符号秩检验，也叫 Mann-Whitney 检验

Wilcoxon Rank Sum and Signed Rank Tests

Performs one- and two-sample Wilcoxon tests on vectors of data; the latter is also known as `Mann-Whitney' test.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(wilcox.test)}
\FunctionTok{wilcox.test}\NormalTok{(x, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"wilcox.test.default"}\NormalTok{)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{wilcox.test}\NormalTok{(x, }\AttributeTok{y =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{alternative =} \FunctionTok{c}\NormalTok{(}\StringTok{"two.sided"}\NormalTok{, }\StringTok{"less"}\NormalTok{, }\StringTok{"greater"}\NormalTok{),}
    \AttributeTok{mu =} \DecValTok{0}\NormalTok{, }\AttributeTok{paired =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{exact =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{correct =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{conf.int =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{conf.level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{tol.root =} \FloatTok{1e{-}04}\NormalTok{, }\AttributeTok{digits.rank =} \ConstantTok{Inf}\NormalTok{, ...)}
\FunctionTok{usage}\NormalTok{(}\StringTok{"wilcox.test.formula"}\NormalTok{)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}formula\textquotesingle{}}
\FunctionTok{wilcox.test}\NormalTok{(formula, data, subset, na.action, ...)}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  \texttt{coin::wilcox\_test} for exact, asymptotic and Monte Carlo conditional p-values, including in the presence of ties.
\end{itemize}

coin 包 \citep{Hothorn_2008_coin} 提供大量基于秩的检验

\hypertarget{wilcox-test-roc}{%
\subsection{ROC 曲线和 wilcox.test 检验的关系}\label{wilcox-test-roc}}

\url{https://github.com/xrobin/pROC/wiki/FAQ---Frequently-asked-questions\#can-i-test-if-a-single-roc-curve-is-significantly-different-from-05}

ROC 曲线越往左上角拱越好， AUC 是 ROC 曲线下的面积，所以 AUC 指标越接近 1 越好。

对每个标签的预测概率指定服从均匀分布，相当于随机猜测，所以最后 ROC 会接近对角线，而且样本量越大越接近，AUC 会越来越接近 0.5

\begin{quote}
再往深一点就是研究一下 R 内置的排序算法，因为计算 AUC 最核心的步骤是排序。 \texttt{order} 函数默认的排序方法是 \texttt{auto} 即当数据量较小的时候，自动选择 radix 排序，当数据量比较大的时候，自动选择 shell 排序\footnote{radix 排序翻译过来叫桶排序或基数排序，详细描述见 \texttt{?sort}}
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 模拟一些数据}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{) }\CommentTok{\# 设置随机数种子}
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{5} \CommentTok{\# 样本量}
\NormalTok{sim\_dat }\OtherTok{\textless{}{-}} \FunctionTok{cbind.data.frame}\NormalTok{(}
  \AttributeTok{pred =} \FunctionTok{runif}\NormalTok{(N),}
  \AttributeTok{label =} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.95}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# 计算 auc 的函数}
\CommentTok{\# dat is a data.frame as input return AUC value}
\NormalTok{comp\_auc }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dat, }\AttributeTok{show\_roc =} \ConstantTok{TRUE}\NormalTok{) \{}
  \CommentTok{\# order label by predicted probability}
\NormalTok{  dat }\OtherTok{\textless{}{-}}\NormalTok{ dat[}\FunctionTok{order}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{pred, dat}\SpecialCharTok{$}\NormalTok{label, }\AttributeTok{decreasing =} \ConstantTok{TRUE}\NormalTok{), ]}

  \CommentTok{\# total samples}
\NormalTok{  n\_total }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{label)}

  \CommentTok{\# number of positive label 1}
\NormalTok{  n\_pos }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{label)}

  \CommentTok{\# number of negative label 0}
\NormalTok{  n\_neg }\OtherTok{\textless{}{-}}\NormalTok{ n\_total }\SpecialCharTok{{-}}\NormalTok{ n\_pos}

  \CommentTok{\# calculate TPR and FPR}
\NormalTok{  tpr }\OtherTok{\textless{}{-}} \FunctionTok{cumsum}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{label) }\SpecialCharTok{/}\NormalTok{ n\_pos}
\NormalTok{  fpr }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_total }\SpecialCharTok{{-}} \FunctionTok{cumsum}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{label)) }\SpecialCharTok{/}\NormalTok{ n\_neg}

  \CommentTok{\# calculate auc}
\NormalTok{  auc }\OtherTok{\textless{}{-}} \DecValTok{0}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(n\_total }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)) \{}
\NormalTok{    auc }\OtherTok{\textless{}{-}}\NormalTok{ auc }\SpecialCharTok{+}\NormalTok{ (fpr[i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ fpr[i]) }\SpecialCharTok{*}\NormalTok{ tpr[i]}
\NormalTok{  \}}
  \CommentTok{\# show ROC curve or not?}
  \ControlFlowTok{if}\NormalTok{ (show\_roc) \{}
    \FunctionTok{plot}\NormalTok{(fpr, tpr, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  auc}
\NormalTok{\}}

\FunctionTok{comp\_auc}\NormalTok{(}\AttributeTok{dat =}\NormalTok{ sim\_dat, }\AttributeTok{show\_roc =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.5015558
\end{verbatim}

模拟一个逻辑回归模型测试自编 AUC 计算程序和 R 包 pROC 计算结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2018}\NormalTok{)}
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{4} \CommentTok{\# 样本量}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(N)}
\NormalTok{beta\_0 }\OtherTok{\textless{}{-}} \FloatTok{0.5}
\NormalTok{beta\_1 }\OtherTok{\textless{}{-}} \FloatTok{0.3}
\NormalTok{eta }\OtherTok{\textless{}{-}}\NormalTok{ beta\_0 }\SpecialCharTok{+}\NormalTok{ beta\_1 }\SpecialCharTok{*}\NormalTok{ x}
\CommentTok{\# 模拟数据集}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =} \FunctionTok{rbinom}\NormalTok{(N, }\DecValTok{1}\NormalTok{, }\AttributeTok{prob =} \FunctionTok{exp}\NormalTok{(eta) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(eta))))}

\CommentTok{\# 数据集分隔}
\NormalTok{is\_train }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(dat), N }\SpecialCharTok{*} \FloatTok{0.7}\NormalTok{)}
\NormalTok{train }\OtherTok{\textless{}{-}}\NormalTok{ dat[is\_train, ]}
\NormalTok{test }\OtherTok{\textless{}{-}}\NormalTok{ dat[}\SpecialCharTok{{-}}\NormalTok{is\_train, ]}
\CommentTok{\# 模型拟合}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{data =}\NormalTok{ train, }\AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(}\AttributeTok{link =} \StringTok{"logit"}\NormalTok{))}
\CommentTok{\# 预测}
\NormalTok{y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(fit, }\AttributeTok{newdata =}\NormalTok{ test, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\NormalTok{dat2 }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{pred =}\NormalTok{ y\_pred, }\AttributeTok{label =}\NormalTok{ test}\SpecialCharTok{$}\NormalTok{y)}
\CommentTok{\# 计算 auc}
\FunctionTok{comp\_auc}\NormalTok{(}\AttributeTok{dat =}\NormalTok{ dat2, }\AttributeTok{show\_roc =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.5850287
\end{verbatim}

对比 R 包 pROC 的计算结果是一致的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pROC}\SpecialCharTok{::}\FunctionTok{auc}\NormalTok{(test}\SpecialCharTok{$}\NormalTok{y, y\_pred)}
\end{Highlighting}
\end{Shaded}

计算一下运行时间

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 100 万样本}
\FunctionTok{system.time}\NormalTok{(}\FunctionTok{comp\_auc}\NormalTok{(}\AttributeTok{dat =}\NormalTok{ dat2, }\AttributeTok{show\_roc =} \ConstantTok{FALSE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    user  system elapsed 
##   0.001   0.000   0.002
\end{verbatim}

更多关于 auc 计算的讨论见统计之都论坛帖 \url{https://d.cosx.org/d/419436}，我感觉这个问题最后会归结到排序问题。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://stat.ethz.ch/pipermail/r{-}help/2005{-}April/069217.html}
\NormalTok{trap.rule }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, y) }\FunctionTok{sum}\NormalTok{(}\FunctionTok{diff}\NormalTok{(x) }\SpecialCharTok{*}\NormalTok{ (y[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ y[}\SpecialCharTok{{-}}\FunctionTok{length}\NormalTok{(y)])) }\SpecialCharTok{/} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-three-plus-one-tests}{%
\section{3 + 1 统计检验}\label{sec-three-plus-one-tests}}

Wald 检验，似然比检验/ Wilks 检验，得分检验/Rao 检验，梯度检验

\begin{quote}
Unfortunately, this is one of those situations where as far as I can tell all of the real statisticians are out there playing with large data sets where the small-sample corrections are not so important and leaving the rest of us to figure it out for ourselves \ldots{}

\hspace*{\fill} --- Ben Bolker \footnote{\url{https://stat.ethz.ch/pipermail/r-sig-mixed-models/2011q4/017392.html}}
\end{quote}

\hypertarget{sec-classical-case-study}{%
\section{经典案例}\label{sec-classical-case-study}}

\hypertarget{subsec-ucb-admissions}{%
\subsection{1973 年加州大学伯克利分校的学生招生}\label{subsec-ucb-admissions}}

录取人数按院系和性别分类统计，研究目标是各个院系在录取学生的时候是否有性别歧视？统计数据见表 \ref{tab:ucb-admissions-data}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as.data.frame}\NormalTok{(UCBAdmissions) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{reshape}\NormalTok{(.,}
    \AttributeTok{v.names =} \StringTok{"Freq"}\NormalTok{, }\AttributeTok{idvar =} \FunctionTok{c}\NormalTok{(}\StringTok{"Admit"}\NormalTok{, }\StringTok{"Gender"}\NormalTok{),}
    \AttributeTok{timevar =} \StringTok{"Dept"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(.,}
    \AttributeTok{caption =} \StringTok{"伯克利大学各个院系的录取人数"}\NormalTok{,}
    \AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col.names =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(Freq)"}\NormalTok{, }\StringTok{"Dept"}\NormalTok{, }\FunctionTok{names}\NormalTok{(.)),}
    \AttributeTok{align =} \StringTok{"c"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:ucb-admissions-data}伯克利大学各个院系的录取人数}
\centering
\begin{tabular}[t]{c|c|c|c|c|c|c|c}
\hline
Admit & Gender & DeptA & DeptB & DeptC & DeptD & DeptE & DeptF\\
\hline
Admitted & Male & 512 & 353 & 120 & 138 & 53 & 22\\
\hline
Rejected & Male & 313 & 207 & 205 & 279 & 138 & 351\\
\hline
Admitted & Female & 89 & 17 & 202 & 131 & 94 & 24\\
\hline
Rejected & Female & 19 & 8 & 391 & 244 & 299 & 317\\
\hline
\end{tabular}
\end{table}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# plot(UCBAdmissions, col = "lightblue", border = "white")}
\FunctionTok{library}\NormalTok{(ggmosaic)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{as.data.frame}\NormalTok{(UCBAdmissions)) }\SpecialCharTok{+}
  \FunctionTok{geom\_mosaic}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{weight =}\NormalTok{ Freq, }\AttributeTok{x =} \FunctionTok{product}\NormalTok{(Gender, Admit), }\AttributeTok{fill =}\NormalTok{ Dept)) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Admit"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Gender"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{hypothesis-test_files/figure-latex/ucb-admissions-img-1} 

}

\caption{UCBAdmissions 马赛克图}\label{fig:ucb-admissions-img}
\end{figure}

\hypertarget{subsec-ethnicity}{%
\subsection{1976\textasciitilde1977年美国佛罗里达州的凶杀案件中被告肤色和死刑判决的关系}\label{subsec-ethnicity}}

\begin{longtable}[]{@{}cccc@{}}
\toprule
被告 & 被害人 & 判死 & 不判死 \\
\midrule
\endhead
白人 & 白人 & 19 & 132 \\
& 黑人 & 0 & 9 \\
黑人 & 白人 & 11 & 32 \\
& 黑人 & 6 & 97 \\
\bottomrule
\end{longtable}

\hypertarget{subsec-HairEyeColor}{%
\subsection{统计专业学生的头发和眼睛的颜色}\label{subsec-HairEyeColor}}

HairEyeColor 是一个 table 类型的数据对象，和数组的关系 array

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(HairEyeColor)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "table"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(HairEyeColor)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  'table' num [1:4, 1:4, 1:2] 32 53 10 3 11 50 10 30 10 25 ...
##  - attr(*, "dimnames")=List of 3
##   ..$ Hair: chr [1:4] "Black" "Brown" "Red" "Blond"
##   ..$ Eye : chr [1:4] "Brown" "Blue" "Hazel" "Green"
##   ..$ Sex : chr [1:2] "Male" "Female"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{apply}\NormalTok{(HairEyeColor, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{), sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Eye
## Hair    Brown Blue Hazel Green
##   Black    68   20    15     5
##   Brown   119   84    54    29
##   Red      26   17    14    14
##   Blond     7   94    10    16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# plot(HairEyeColor, col = "lightblue", border = "white")}
\FunctionTok{library}\NormalTok{(ggmosaic)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{as.data.frame}\NormalTok{(HairEyeColor)) }\SpecialCharTok{+}
  \FunctionTok{geom\_mosaic}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{weight =}\NormalTok{ Freq, }\AttributeTok{x =} \FunctionTok{product}\NormalTok{(Hair, Eye), }\AttributeTok{fill =}\NormalTok{ Sex)) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Hair"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Eye"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{hypothesis-test_files/figure-latex/HairEyeColor-1} 

}

\caption{头发、眼睛颜色和性别的比例}\label{fig:HairEyeColor}
\end{figure}

\hypertarget{sec-hypothesis-test-session}{%
\section{运行环境}\label{sec-hypothesis-test-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] ggmosaic_0.3.3  patchwork_1.1.1 nomnoml_0.2.3   ggplot2_3.3.5  
## [5] magrittr_2.0.1  formatR_1.11   
## 
## loaded via a namespace (and not attached):
##  [1] tidyselect_1.1.1   xfun_0.26          purrr_0.3.4        colorspace_2.0-2  
##  [5] vctrs_0.3.8        generics_0.1.0     viridisLite_0.4.0  htmltools_0.5.2   
##  [9] yaml_2.2.1         utf8_1.2.2         plotly_4.9.4.1     rlang_0.4.11      
## [13] pillar_1.6.3       glue_1.4.2         withr_2.4.2        DBI_1.1.1         
## [17] plyr_1.8.6         lifecycle_1.0.1    stringr_1.4.0      munsell_0.5.0     
## [21] gtable_0.3.0       htmlwidgets_1.5.4  evaluate_0.14      labeling_0.4.2    
## [25] knitr_1.36         callr_3.7.0        fastmap_1.1.0      ps_1.6.0          
## [29] curl_4.3.2         fansi_0.5.0        Rcpp_1.0.7         scales_1.1.1      
## [33] webshot_0.5.2      jsonlite_1.7.2     farver_2.1.0       digest_0.6.28     
## [37] stringi_1.7.4      bookdown_0.24      processx_3.5.2     dplyr_1.0.7       
## [41] ggrepel_0.9.1      grid_4.1.1         tools_4.1.1        productplots_0.1.1
## [45] lazyeval_0.2.2     tibble_3.1.5       tidyr_1.1.4        crayon_1.4.1      
## [49] pkgconfig_2.0.3    ellipsis_0.3.2     data.table_1.14.2  assertthat_0.2.1  
## [53] rmarkdown_2.11     httr_1.4.2         R6_2.5.1           compiler_4.1.1
\end{verbatim}

\hypertarget{chap-power-Analysis}{%
\chapter{功效分析}\label{chap-power-Analysis}}

CRAN 上有很多功效计算和分析的 R 包，我们针对不同的混合效应模型和统计检验，提供对应的 R 实现。

\href{https://github.com/stamats/MKpower}{MKpower} 包提供 Welch 和 Hsu（许宝騄）t 检验、Wilcoxon 秩和检验、符号秩检验的功效分析和样本量计算，经验功效和第一类错误的计算方法是蒙特卡罗模拟。\href{https://github.com/arcaldwell49/Superpower}{Superpower} 基于模拟的方法分析三因素方差分析实验设计的功效，开发者写了本书介绍，详见 \url{https://aaroncaldwell.us/SuperpowerBook/}，也开发了两个 Shiny 应用。\href{https://github.com/rpsychologist/powerlmm}{powerlmm} 可用于计算两、三个水平的纵向多水平/线性混合效应模型的功效。\href{https://github.com/ChaWM/pwrAB}{pwrAB} Welch 两样本 t 检验的功效分析，常用于 A/B 测试。\href{https://www.metinbulus.com/}{Metin Bulus} 开发 \href{https://github.com/metinbulus/PowerUpR}{PowerUpR} 计算响应变量是连续型的多水平随机对照实验统计功效，最小可检测的效应大小，最小样本量要求。\href{https://github.com/pitakakariki/simr}{simr} 通过模拟方法分析广义线性混合效应模型的功效。\href{https://github.com/johnnyzhz/WebPower}{WebPower} 提供相关性、比例、t 检验、单因素方差分析、两因素方差分析、线性回归、逻辑回归、泊松回归、纵向数据分析、结构方程模型和多水平模型等的功效分析，详见网站 \url{https://webpower.psychstat.org/}，包含书籍和功效分析的工具。\href{https://github.com/ginettelafit/PowerAnalysisIL}{PowerAnalysisIL} 功效分析的 shiny 应用 \url{http://daniellakens.blogspot.com/2015/01/always-use-welchs-t-test-instead-of.html}。

此外，还有 \href{https://github.com/runehaubo/lmerTestR}{lmerTest} \citep{Kuznetsova_2017_lmerTest} 和 lmtest \citep{Zeileis_2002_lmtest}。 试验设计 \citep{Design_2004_Mao} 可以视为一种组织形式，包括各类检验， R 语言实战 \citep{Action_2015_Robert} 作者 Robert I. Kabacoff 创建了网站 \href{https://www.statmethods.net/}{Quick-R}，实战这本书第 10 章功效分析主要基于 \href{https://github.com/heliosdrm/pwr}{pwr} 包来介绍，Jacob Cohen 的著作《Statistical Power Analysis for the Behavioral Sciences》第二版 \citep{Cohen1988}

\url{https://powerandsamplesize.com/} 功效和样本量计算器

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(pwr)}
\FunctionTok{library}\NormalTok{(Matrix)}
\FunctionTok{library}\NormalTok{(lme4)}
\end{Highlighting}
\end{Shaded}

\textbf{pbkrtest} 提供 parametric bootstrap test、Kenward-Roger-type F-test、Satterthwaite-type F-test 用于线性混合效应模型，parametric bootstrap test 用于广义线性混合效应模型

\hypertarget{sec-power-anova-test}{%
\section{方差分析检验的功效}\label{sec-power-anova-test}}

\texttt{power.anova.test()} 计算平衡的单因素方差分析检验的功效

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(power.anova.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
power.anova.test(groups = NULL, n = NULL, between.var = NULL, within.var = NULL,
    sig.level = 0.05, power = NULL)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{power.anova.test}\NormalTok{(}
  \AttributeTok{groups =} \DecValTok{4}\NormalTok{,       }\CommentTok{\#  4 个组  }
  \AttributeTok{between.var =} \DecValTok{1}\NormalTok{,  }\CommentTok{\# 组间方差为 1}
  \AttributeTok{within.var =} \DecValTok{3}\NormalTok{,   }\CommentTok{\# 组内方差为 3}
  \AttributeTok{power =} \FloatTok{0.95}      \CommentTok{\# 1 {-} 犯第二类错误的概率}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      Balanced one-way analysis of variance power calculation 
## 
##          groups = 4
##               n = 18.18245
##     between.var = 1
##      within.var = 3
##       sig.level = 0.05
##           power = 0.95
## 
## NOTE: n is number in each group
\end{verbatim}

\hypertarget{sec-power-prop-test}{%
\section{比例检验的功效}\label{sec-power-prop-test}}

\texttt{power.prop.test()} 计算两样本比例检验的功效

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(power.prop.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
power.prop.test(n = NULL, p1 = NULL, p2 = NULL, sig.level = 0.05, power = NULL,
    alternative = c("two.sided", "one.sided"), strict = FALSE,
    tol = .Machine$double.eps^0.25)
\end{verbatim}

功效可以用来计算实验所需要的样本量，检验统计量的功效越大/高，检验方法越好，实验所需要的样本量越少

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# p1 \textgreater{}= p2 的检验 单边和双边检验}
\FunctionTok{power.prop.test}\NormalTok{(}
  \AttributeTok{p1 =}\NormalTok{ .}\DecValTok{65}\NormalTok{, }\AttributeTok{p2 =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{sig.level =}\NormalTok{ .}\DecValTok{05}\NormalTok{,}
  \AttributeTok{power =} \FloatTok{0.90}\NormalTok{, }\AttributeTok{alternative =} \StringTok{"one.sided"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      Two-sample comparison of proportions power calculation 
## 
##               n = 1603.846
##              p1 = 0.65
##              p2 = 0.6
##       sig.level = 0.05
##           power = 0.9
##     alternative = one.sided
## 
## NOTE: n is number in *each* group
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{power.prop.test}\NormalTok{(}
  \AttributeTok{p1 =}\NormalTok{ .}\DecValTok{65}\NormalTok{, }\AttributeTok{p2 =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{sig.level =}\NormalTok{ .}\DecValTok{05}\NormalTok{,}
  \AttributeTok{power =} \FloatTok{0.90}\NormalTok{, }\AttributeTok{alternative =} \StringTok{"two.sided"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      Two-sample comparison of proportions power calculation 
## 
##               n = 1968.064
##              p1 = 0.65
##              p2 = 0.6
##       sig.level = 0.05
##           power = 0.9
##     alternative = two.sided
## 
## NOTE: n is number in *each* group
\end{verbatim}

\textbf{pwr} 包 \texttt{pwr.2p.test()} 函数提供了类似 \texttt{power.prop.test()} 函数的功能

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(pwr)}
\CommentTok{\# 明确 p1 \textgreater{} p2 的检验}
\CommentTok{\# 单边检验拆分更加明细，分为大于和小于}
\FunctionTok{pwr.2p.test}\NormalTok{(}
  \AttributeTok{h =} \FunctionTok{ES.h}\NormalTok{(}\AttributeTok{p1 =} \FloatTok{0.65}\NormalTok{, }\AttributeTok{p2 =} \FloatTok{0.6}\NormalTok{),}
  \AttributeTok{sig.level =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{power =} \FloatTok{0.9}\NormalTok{, }\AttributeTok{alternative =} \StringTok{"greater"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      Difference of proportion power calculation for binomial distribution (arcsine transformation) 
## 
##               h = 0.1033347
##               n = 1604.007
##       sig.level = 0.05
##           power = 0.9
##     alternative = greater
## 
## NOTE: same sample sizes
\end{verbatim}

已知两样本的样本量不等，检验 H0: \(p_1 = p_2\) H1: \(p_1 \neq p_2\) 的功效

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(pwr)}
\FunctionTok{pwr.2p2n.test}\NormalTok{(}
  \AttributeTok{h =} \FloatTok{0.30}\NormalTok{, }\AttributeTok{n1 =} \DecValTok{80}\NormalTok{, }\AttributeTok{n2 =} \DecValTok{245}\NormalTok{,}
  \AttributeTok{sig.level =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{alternative =} \StringTok{"greater"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      difference of proportion power calculation for binomial distribution (arcsine transformation) 
## 
##               h = 0.3
##              n1 = 80
##              n2 = 245
##       sig.level = 0.05
##           power = 0.7532924
##     alternative = greater
## 
## NOTE: different sample sizes
\end{verbatim}

h 表示两个样本的差异，计算得到的功效是 0.75

\hypertarget{sec-power-t-test}{%
\section{t 检验的功效}\label{sec-power-t-test}}

\texttt{power.t.test()} 计算单样本或两样本的 t 检验的功效，或者根据功效计算参数，如样本量

\href{https://yihui.org/cn/2018/02/cohen-s-d/}{Cohen's d} 单样本/配对 t 检验的功效分析

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OtherTok{=} \DecValTok{30}  \CommentTok{\# 样本量（只是一个例子）}
\NormalTok{x }\OtherTok{=} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{xx =}\NormalTok{ x}\SpecialCharTok{/}\FunctionTok{sqrt}\NormalTok{(n), }\AttributeTok{yy =} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{pt}\NormalTok{(x, n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)))}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ xx, }\AttributeTok{y =}\NormalTok{ yy)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{linetype =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"d = t / sqrt(n)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"2 * (1 {-} pt(x, n {-} 1))"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{power-analysis_files/figure-latex/power-t-test-1} 

}

\caption{t 检验的功效}\label{fig:power-t-test}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(power.t.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
power.t.test(n = NULL, delta = NULL, sd = 1, sig.level = 0.05, power = NULL,
    type = c("two.sample", "one.sample", "paired"),
    alternative = c("two.sided", "one.sided"), strict = FALSE,
    tol = .Machine$double.eps^0.25)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{power.t.test}\NormalTok{(}
  \AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{delta =} \FloatTok{2.2}\NormalTok{,}
  \AttributeTok{sd =} \DecValTok{1}\NormalTok{, }\AttributeTok{sig.level =} \FloatTok{0.05}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"two.sample"}\NormalTok{,}
  \AttributeTok{alternative =} \StringTok{"two.sided"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      Two-sample t test power calculation 
## 
##               n = 100
##           delta = 2.2
##              sd = 1
##       sig.level = 0.05
##           power = 1
##     alternative = two.sided
## 
## NOTE: n is number in *each* group
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:power-t-test} 函数 \texttt{power.t.test()} 的参数表}\tabularnewline
\toprule
参数 & 含义 \\
\midrule
\endfirsthead
\toprule
参数 & 含义 \\
\midrule
\endhead
\texttt{n} & 每个组的样本量 \\
\texttt{delta} & 两个组的均值之差 \\
\texttt{sd} & 标准差，默认值 1 \\
\texttt{sig.level} & 显著性水平，默认是 0.05 （犯第 I 类错误的概率） \\
\texttt{power} & 检验的功效（1 - 犯第 II 类错误的概率） \\
\texttt{type} & t 检验的类型 \texttt{"two.sample"} 两样本、\texttt{"one.sample"} 单样本或 \texttt{"paired"} 配对样本 \\
\texttt{alternative} & 单边或双边检验，取值为 \texttt{"two.sided"} 或 \texttt{"one.sided"} \\
\bottomrule
\end{longtable}

参数 \texttt{n}，\texttt{delta}，\texttt{power}，\texttt{sd} 和 \texttt{sig.level} 必须有一个值为 \texttt{NULL}，为 \texttt{NULL} 的参数是由其它参数决定的。

\href{https://en.wikipedia.org/wiki/Jacob_Cohen_(statistician)}{Jacob Cohen} 提出的 Cohen's d 和 Cohen's f 详见书籍 \citep{Cohen1988}，他的代表性文章，地球是圆的 \citep{Cohen_1994_Earth}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 前面 t 检验和方差分析检验的等价功效计算}
\FunctionTok{library}\NormalTok{(pwr)}
\FunctionTok{pwr.t.test}\NormalTok{(}
  \AttributeTok{d =} \FloatTok{2.2} \SpecialCharTok{/} \FloatTok{6.4}\NormalTok{,}
  \AttributeTok{n =} \DecValTok{100}\NormalTok{,}
  \AttributeTok{sig.level =} \FloatTok{0.05}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"two.sample"}\NormalTok{,}
  \AttributeTok{alternative =} \StringTok{"two.sided"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      Two-sample t test power calculation 
## 
##               n = 100
##               d = 0.34375
##       sig.level = 0.05
##           power = 0.6768572
##     alternative = two.sided
## 
## NOTE: n is number in *each* group
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# f 是如何和上面的组间/组内方差等价指定的}
\FunctionTok{pwr.anova.test}\NormalTok{(}
  \AttributeTok{k =} \DecValTok{4}\NormalTok{, }\CommentTok{\# 组数}
  \AttributeTok{f =} \FloatTok{0.5}\NormalTok{,}
  \AttributeTok{power =} \FloatTok{0.95} \CommentTok{\# 检验的效}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      Balanced one-way analysis of variance power calculation 
## 
##               k = 4
##               n = 18.18244
##               f = 0.5
##       sig.level = 0.05
##           power = 0.95
## 
## NOTE: n is number in each group
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{aggregate}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ PlantGrowth, weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group,}
    \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{c}\NormalTok{(}\AttributeTok{dist\_mean =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{dist\_sd =} \FunctionTok{sd}\NormalTok{(x))}
\NormalTok{  ),}
  \FunctionTok{cbind.data.frame}\NormalTok{(weight, group)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{rmdnote}{注意}
R 3.5.0 以后，函数 \texttt{aggregate} 的参数 \texttt{drop} 默认设置为 \texttt{TRUE} 表示扔掉未用来分组的变量，聚合返回的是一个矩阵类型的数据对象。

\end{rmdnote}

\href{https://github.com/const-ae/ggsignif}{\textbf{ggsignif}} 添加显著性注释

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggsignif)}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_signif}\NormalTok{(}\AttributeTok{comparisons =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"ctrl"}\NormalTok{, }\StringTok{"trt1"}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\StringTok{"trt1"}\NormalTok{, }\StringTok{"trt2"}\NormalTok{)), }
              \AttributeTok{map\_signif\_level =} \ControlFlowTok{function}\NormalTok{(p) }\FunctionTok{sprintf}\NormalTok{(}\StringTok{"p = \%.2g"}\NormalTok{, p), }
              \AttributeTok{textsize =} \DecValTok{6}\NormalTok{, }\AttributeTok{test =} \StringTok{"t.test"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

无条件 \(2 \times 2\) 列联表

fisher.test \url{https://en.wikipedia.org/wiki/Fisher's_exact_test}

\href{https://cran.r-project.org/package=Exact}{Exact} \url{https://en.wikipedia.org/wiki/Barnard's_test} exact.test power.exact.test

\href{https://cran.r-project.org/package=exact2x2}{exact2x2}

\hypertarget{sec-power-session}{%
\section{运行环境}\label{sec-power-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] ggplot2_3.3.5  lme4_1.1-27.1  Matrix_1.3-4   pwr_1.3-0      formatR_1.11  
## [6] magrittr_2.0.1
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.7       pillar_1.6.3     compiler_4.1.1   nloptr_1.2.2.2  
##  [5] tools_4.1.1      boot_1.3-28      digest_0.6.28    evaluate_0.14   
##  [9] lifecycle_1.0.1  tibble_3.1.5     nlme_3.1-153     gtable_0.3.0    
## [13] lattice_0.20-45  pkgconfig_2.0.3  rlang_0.4.11     DBI_1.1.1       
## [17] curl_4.3.2       yaml_2.2.1       xfun_0.26        fastmap_1.1.0   
## [21] withr_2.4.2      dplyr_1.0.7      stringr_1.4.0    knitr_1.36      
## [25] generics_0.1.0   vctrs_0.3.8      tidyselect_1.1.1 grid_4.1.1      
## [29] glue_1.4.2       R6_2.5.1         fansi_0.5.0      rmarkdown_2.11  
## [33] bookdown_0.24    minqa_1.2.4      farver_2.1.0     purrr_0.3.4     
## [37] scales_1.1.1     htmltools_0.5.2  ellipsis_0.3.2   MASS_7.3-54     
## [41] splines_4.1.1    assertthat_0.2.1 colorspace_2.0-2 labeling_0.4.2  
## [45] utf8_1.2.2       stringi_1.7.4    munsell_0.5.0    crayon_1.4.1
\end{verbatim}

\hypertarget{chap-experimental-design}{%
\chapter{试验设计}\label{chap-experimental-design}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\end{Highlighting}
\end{Shaded}

\begin{rmdnote}{注意}
我想不少人初次见到本章题目首先疑惑的可能是到底是试验还是实验？这里做一下说明，实验的意思是带有验证性的目的，已经有结果了，做实验验证某个规律，常常用在物理、化学的课堂里，学生做实验验证自由落体运动、做实验测量重力加速度等等。试验的意思是人为设定一系列操作步骤去探索未知，不确定结果如何，试一试。

\end{rmdnote}

试验设计（Design of Experiment，简称 DOE）是一个应用性很强的学科领域，\href{https://en.wikipedia.org/wiki/Ronald_Fisher}{R. A. Fisher} 曾在\href{https://en.wikipedia.org/wiki/Rothamsted_Research}{英国洛桑试验站}做实验验证孟德尔的豌豆实验结果。

Vikneswaran 提供了一份书籍 \citet{Berger2002} 的补充材料 --- \href{http://CRAN.R-project.org/doc/contrib/Vikneswaran-ED_companion.pdf}{An R companion to ``Experimental Design''}，目前 Paul Berger 的这本书已经迭代到第二版 \citep{Berger2018}，2015 年 Paul Berger 出版了新书 《Improving the User Experience through Practical Data Analytics: Gain Meaningful Insight and Increase Your Bottom Line》 \citep{Berger2015} 颇具应用性，结合产品用户体验来谈试验设计。

Bill Venables 开发的 \href{https://cran.r-project.org/package=conf.design}{conf.design} 是试验设计领域的核心 R 包，CRAN 官网上试验设计视图 \url{https://cran.r-project.org/view=ExperimentalDesign} 可以让我们对试验设计这个领域有一个粗略的了解。

推荐读者使用贴合 R 语言的试验设计入门书 《Design and Analysis of Experiments with R》\citep{Lawson2014}，作者提供相应的 R 包 \href{https://cran.r-project.org/package=daewr}{daewr} 打包了该书的数据和代码。另外，推荐的读物是 《Statistics for Experimenters: Design, Innovation, and Discovery》\citep{Box2005} 和《Trustworthy Online Controlled Experiments: A Practical Guide to A/B Testing》 \citep{Ron2020}。

另一个和试验设计紧密相关的话题是敏感性分析，推荐 Devin Incerti 的敏感性分析系列博客 \url{https://devinincerti.com/blog.html}，R 包 \href{https://CRAN.R-project.org/package=sensitivity}{sensitivity} 提供140+ 页的手册，功能非常强，模型的全局敏感性分析， \href{https://github.com/chrisschuerz/SWATplusR}{SWATplusR} SWAT 分析法和 R 语言结合。

\hypertarget{sec-sleep}{%
\section{学生睡眠质量}\label{sec-sleep}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sleep, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ extra, }\AttributeTok{color =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{experimental-design_files/figure-latex/sleep-data-1} \end{center}

\hypertarget{sec-insect-sprays}{%
\section{驱虫喷雾的效果}\label{sec-insect-sprays}}

InsectSprays 数据集 \citep{Beall1942} 来源于农业实验，记录了不同杀虫剂的效果，即杀虫剂过后，单位实验区域内虫子的数量，如图\ref{fig:insect-sprays}所示，横轴表示杀虫剂种类，纵轴表示虫子数量。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ InsectSprays, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ spray, }\AttributeTok{y =}\NormalTok{ count, }\AttributeTok{color =}\NormalTok{ spray)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{experimental-design_files/figure-latex/insect-sprays-1} 

}

\caption{不同杀虫剂的效果}\label{fig:insect-sprays}
\end{figure}

先创建一个 aov 对象，把它命名为 mod1，见下方

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod1 }\OtherTok{\textless{}{-}} \FunctionTok{aov}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays)}
\end{Highlighting}
\end{Shaded}

第一个参数告诉 R count 是响应变量，spray 是协变量，第二个参数告诉 R 去对象 InsectSprays 中寻找这些变量。下面把分析结果以一种漂亮的格式打印出来

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(mod1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             Df Sum Sq Mean Sq F value Pr(>F)    
## spray        5   2669   533.8    34.7 <2e-16 ***
## Residuals   66   1015    15.4                   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

表格中的条目是很容易理解的，比如最右边的列表示 P 值。如果我们想做固定显著性水平下的检验，比如 \(\alpha = 0.075\) 时的 F 统计量的值，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qf}\NormalTok{(}\FloatTok{0.075}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{66}\NormalTok{, }\AttributeTok{lower.tail =}\NormalTok{ F)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.110783
\end{verbatim}

上面的命令是说 \(F(5, 66)\) 分布的 0.075 分位点，最后一个参数很关键，因为默认情况下 R 计算下分位点，详情见 \texttt{?qf}。

方差分析做了三个假设

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  残差 \(\epsilon_{ij}\) 是相互独立的随机变量；
\item
  残差 \(\epsilon_{ij}\) 服从正态分布；
\item
  残差 \(\epsilon_{ij}\) 均值为 0，方差是固定的常数。
\end{enumerate}

假设 1 和 3 通过图来检验，假设 2 通过 QQ 图来检验。值得一提的是 mod1 对象除了打印出来，还有很多方法

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(mod1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "coefficients"  "residuals"     "effects"       "rank"         
##  [5] "fitted.values" "assign"        "qr"            "df.residual"  
##  [9] "contrasts"     "xlevels"       "call"          "terms"        
## [13] "model"
\end{verbatim}

比如获取残差，考虑到篇幅，这里仅显示前 10 个

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(mod1}\SpecialCharTok{$}\NormalTok{residuals, }\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    1    2    3    4    5    6    7    8    9   10 
## -4.5 -7.5  5.5 -0.5 -0.5 -2.5 -4.5  8.5  2.5  5.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(mod1)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{experimental-design_files/figure-latex/unnamed-chunk-7-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(mod1}\SpecialCharTok{$}\NormalTok{fitted.values, mod1}\SpecialCharTok{$}\NormalTok{residuals, }\AttributeTok{main =} \StringTok{"Residuals vs. Fitted"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{20}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{experimental-design_files/figure-latex/unnamed-chunk-8-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(mod1}\SpecialCharTok{$}\NormalTok{model}\SpecialCharTok{$}\NormalTok{spray, mod1}\SpecialCharTok{$}\NormalTok{residuals, }\AttributeTok{main =} \StringTok{"Residuals vs. Levels"}\NormalTok{ )}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{experimental-design_files/figure-latex/unnamed-chunk-9-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{72}\NormalTok{, mod1}\SpecialCharTok{$}\NormalTok{residuals, }\AttributeTok{main =} \StringTok{"Residuals vs. Time Order"}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{experimental-design_files/figure-latex/unnamed-chunk-10-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qqnorm}\NormalTok{(mod1}\SpecialCharTok{$}\NormalTok{residuals, }\AttributeTok{pch =} \DecValTok{20}\NormalTok{)}
\FunctionTok{qqline}\NormalTok{(mod1}\SpecialCharTok{$}\NormalTok{residuals)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{experimental-design_files/figure-latex/unnamed-chunk-11-1} \end{center}

如果上面的假设显著失效，我们要采用非参数检验

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\OtherTok{\textless{}{-}} \FunctionTok{kruskal.test}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays)}
\NormalTok{mod2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Kruskal-Wallis rank sum test
## 
## data:  count by spray
## Kruskal-Wallis chi-squared = 54.691, df = 5, p-value = 1.511e-10
\end{verbatim}

计算给定水平下的置信区间，构造置信水平为 95\% 的区间

\[
\bar{X} \pm t_{1-\alpha/2}(s/\sqrt{n})
\] 以 A 号杀虫剂为例，

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xbar }\OtherTok{=} \FunctionTok{mean}\NormalTok{(InsectSprays[InsectSprays}\SpecialCharTok{$}\NormalTok{spray }\SpecialCharTok{==} \StringTok{"A"}\NormalTok{, }\StringTok{"count"}\NormalTok{])}
\NormalTok{t\_crit }\OtherTok{\textless{}{-}} \FunctionTok{qt}\NormalTok{(}\FloatTok{0.025}\NormalTok{, mod1}\SpecialCharTok{$}\NormalTok{df.residual, }\AttributeTok{lower.tail =}\NormalTok{ F)}
\NormalTok{s }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{sum}\NormalTok{((mod1}\SpecialCharTok{$}\NormalTok{residuals)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ mod1}\SpecialCharTok{$}\NormalTok{df.residual)}
\NormalTok{n }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(InsectSprays}\SpecialCharTok{$}\NormalTok{spray }\SpecialCharTok{==} \StringTok{"A"}\NormalTok{)}
\CommentTok{\# 最后置信区间的上下限}
\FunctionTok{c}\NormalTok{(xbar }\SpecialCharTok{{-}}\NormalTok{ t\_crit }\SpecialCharTok{*}\NormalTok{ (s}\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n)), xbar }\SpecialCharTok{+}\NormalTok{ t\_crit }\SpecialCharTok{*}\NormalTok{ (s}\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 12.23958 16.76042
\end{verbatim}

比较 A 号和 C 号杀虫剂的效果，计算两个均值差的置信区间

\[
\bar{X}_1 - \bar{X}_2 \pm t_{1-\alpha/2}(s/\sqrt{1/n_1 + 1/n_2})
\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n1 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(InsectSprays}\SpecialCharTok{$}\NormalTok{spray }\SpecialCharTok{==} \StringTok{"A"}\NormalTok{)}
\NormalTok{n2 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(InsectSprays}\SpecialCharTok{$}\NormalTok{spray }\SpecialCharTok{==} \StringTok{"C"}\NormalTok{)}

\NormalTok{x1bar }\OtherTok{=} \FunctionTok{mean}\NormalTok{(InsectSprays[InsectSprays}\SpecialCharTok{$}\NormalTok{spray }\SpecialCharTok{==} \StringTok{"A"}\NormalTok{, }\StringTok{"count"}\NormalTok{])}
\NormalTok{x2bar }\OtherTok{=} \FunctionTok{mean}\NormalTok{(InsectSprays[InsectSprays}\SpecialCharTok{$}\NormalTok{spray }\SpecialCharTok{==} \StringTok{"C"}\NormalTok{, }\StringTok{"count"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

代入公式即可计算得到置信区间

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(x1bar }\SpecialCharTok{{-}}\NormalTok{ x2bar) }\SpecialCharTok{{-}}\NormalTok{ t\_crit }\SpecialCharTok{*}\NormalTok{ s }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{( }\DecValTok{1}\SpecialCharTok{/}\NormalTok{ n1 }\SpecialCharTok{+} \DecValTok{1}\SpecialCharTok{/}\NormalTok{n2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 9.219948
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(x1bar }\SpecialCharTok{{-}}\NormalTok{ x2bar) }\SpecialCharTok{+}\NormalTok{ t\_crit }\SpecialCharTok{*}\NormalTok{ s }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{( }\DecValTok{1}\SpecialCharTok{/}\NormalTok{ n1 }\SpecialCharTok{+} \DecValTok{1}\SpecialCharTok{/}\NormalTok{n2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 15.61339
\end{verbatim}

Fisher's 最小显著性检验 (Fisher's Least Significant Difference Test) 即

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_crit }\SpecialCharTok{*}\NormalTok{ s }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{( }\DecValTok{1}\SpecialCharTok{/}\NormalTok{ n1 }\SpecialCharTok{+} \DecValTok{1}\SpecialCharTok{/}\NormalTok{n2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.196719
\end{verbatim}

Tukey's Honestly Significant Difference Test 主要测量成对实验的误差比率，假定每个水平下的实验次数是相等的，只需将上面的 aov 对象传递给函数 \texttt{TukeyHSD()}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod3 }\OtherTok{\textless{}{-}} \FunctionTok{TukeyHSD}\NormalTok{(mod1, }\AttributeTok{ordered =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{mod3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Tukey multiple comparisons of means
##     95% family-wise confidence level
##     factor levels have been ordered
## 
## Fit: aov(formula = count ~ spray, data = InsectSprays)
## 
## $spray
##           diff       lwr       upr     p adj
## E-C  1.4166667 -3.282742  6.116075 0.9488669
## D-C  2.8333333 -1.866075  7.532742 0.4920707
## A-C 12.4166667  7.717258 17.116075 0.0000000
## B-C 13.2500000  8.550591 17.949409 0.0000000
## F-C 14.5833333  9.883925 19.282742 0.0000000
## D-E  1.4166667 -3.282742  6.116075 0.9488669
## A-E 11.0000000  6.300591 15.699409 0.0000000
## B-E 11.8333333  7.133925 16.532742 0.0000000
## F-E 13.1666667  8.467258 17.866075 0.0000000
## A-D  9.5833333  4.883925 14.282742 0.0000014
## B-D 10.4166667  5.717258 15.116075 0.0000002
## F-D 11.7500000  7.050591 16.449409 0.0000000
## B-A  0.8333333 -3.866075  5.532742 0.9951810
## F-A  2.1666667 -2.532742  6.866075 0.7542147
## F-B  1.3333333 -3.366075  6.032742 0.9603075
\end{verbatim}

其中，\texttt{diff} 表示均值之差，\texttt{lwr} 和 \texttt{upr} 表示置信区间的上下限，\(p_{adj}\) 是对应的。检查一下，看看哪些置信区间包含 0 ，包含 0 的表示不显著，从第三行来看， A 和 C 之间差别显著。之前计算过 A、C 均值，均值之差即

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(x1bar }\SpecialCharTok{{-}}\NormalTok{ x2bar)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 12.41667
\end{verbatim}

在误差比率 \(\alpha = 0.05\) 的情况下，如果你想手动计算 HSD 值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{q\_crit }\OtherTok{\textless{}{-}} \FunctionTok{qtukey}\NormalTok{(}\AttributeTok{p =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{nmeans =} \FunctionTok{length}\NormalTok{(mod1}\SpecialCharTok{$}\NormalTok{xlevels[[}\DecValTok{1}\NormalTok{]]), }\AttributeTok{df =}\NormalTok{ mod1}\SpecialCharTok{$}\NormalTok{df.residual, }\AttributeTok{lower.tail =}\NormalTok{ F)}
\CommentTok{\# mod1$df.residual 是 6 }
\NormalTok{hsd }\OtherTok{\textless{}{-}}\NormalTok{ q\_crit }\SpecialCharTok{*}\NormalTok{ s }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{6}\NormalTok{)}
\NormalTok{hsd}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6.645967
\end{verbatim}

将模型结果 mod3 用图画出来，见下图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(mod3)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{experimental-design_files/figure-latex/tukey-hsd-1} 

}

\caption{成对显著性水平}\label{fig:tukey-hsd}
\end{figure}

关于多重比较请见 Frank Bretz, Torsten Hothorn, Peter Westfall 的书《Multiple Comparisons Using R》及配套 R 包 \href{https://cran.r-project.org/package=multcomp}{multcomp}，该 R 包现由 Torsten Hothorn 维护，他还维护了一个由数据集构成的 R 包 \href{https://cran.r-project.org/package=TH.data}{TH.data}，我们后续章节也会用到。

\hypertarget{sec-multiple-comparison}{%
\section{重复数不等的多重比较}\label{sec-multiple-comparison}}

Tukey 的检验方法要求各个组的重复数相等，而方差分析的重复数不等时，我们需要用如下方法

\[
\frac{(\bar{y}_{i\cdot} - \bar{y}_{j\cdot}) - (\mu_i - \mu_j)}{\sqrt{\frac{1}{m_i} + \frac{1}{m_j}} \hat{\sigma}} \sim t(f_e)
\]

\[
c_{ij} = \sqrt{(r-1)F_{1-\alpha}(r-1, f_e)(\frac{1}{m_i} +\frac{1}{m_j})\hat{\sigma^2}}
\]

\(\hat{\sigma^2} = S_e/ f_e\) 是 \(\sigma^2\) 无偏估计。

\[
y_{ij} = \mu + a_i + \epsilon_{ij}, \quad i = 1,2,\ldots,r, \quad j = 1,2, \ldots, m_i. \quad
\sum_{i=1}^{r}m_{i}a_{i} = 0,
\] 其中，\(\epsilon_{ij}\) 相互独立，服从 \(\mathcal{N}(0, \sigma^2)\).

\(f_e = n - r, S_e = \sum_{i=1}^{r}\sum_{j=1}^{m_{i}}(y_{ij} - \bar{y}_{i\cdot})^2 = S_T - S_A\)

\hypertarget{sec-co2}{%
\section{不同地区的草类植物吸收二氧化碳的情况}\label{sec-co2}}

通过观察不同地区的草类植物吸收二氧化碳的情况，研究植物的耐寒性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ CO2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ conc, }\AttributeTok{y =}\NormalTok{ uptake, }\AttributeTok{color =}\NormalTok{ Type, }\AttributeTok{shape =}\NormalTok{ Treatment)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{Plant, }\AttributeTok{ncol =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"conc (mL/L)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"uptake (umol/m\^{}2 sec)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{experimental-design_files/figure-latex/co2-1} 

}

\caption{草类植物吸收二氧化碳的量}\label{fig:co2}
\end{figure}

\hypertarget{sec-orchard-sprays}{%
\section{果园喷雾剂的效力}\label{sec-orchard-sprays}}

评估喷雾杀虫剂的在果园的效果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"OrchardSprays"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-npk}{%
\section{验证孟德尔的豌豆实验结果}\label{sec-npk}}

R. A. Fisher 在农业站做实验验证孟德尔的豌豆实验结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"npk"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

豌豆产量和氮 (nitrogen, N) 磷酸盐 (phosphate, P) 钾盐 (potassium, K) 的关系

\hypertarget{part-ux7edfux8ba1ux6a21ux578b}{%
\part{统计模型}\label{part-ux7edfux8ba1ux6a21ux578b}}

\hypertarget{chap-statistical-models}{%
\chapter*{介绍}\label{chap-statistical-models}}
\addcontentsline{toc}{chapter}{介绍}

统计模型

\hypertarget{chap-linear-models}{%
\chapter{线性模型}\label{chap-linear-models}}

\begin{quote}
There's probably some examples, but there are some examples of people using \texttt{solve(t(X)\ \%*\%\ W\ \%*\%\ X)\ \%*\%\ W\ \%*\%\ Y} to compute regression coefficients, too.

\hspace*{\fill} --- Thomas Lumley \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2006-March/101596.html}}
\end{quote}

\hypertarget{sec-anova}{%
\section{方差分析}\label{sec-anova}}

\begin{quote}
I was profoundly disappointed when I saw that S-PLUS 4.5 now provides ``Type III'' sums of squares as a routine option for the summary method for aov objects. I note that it is not yet available for multistratum models, although this has all the hallmarks of an oversight (that is, a bug) rather than common sense seeing the light of day. When the decision was being taken of whether to include this feature, ``because the FDA requires it'' a few of my colleagues and I were consulted and our reply was unhesitatingly a clear and unequivocal ``No'', but it seems the FDA and SAS speak louder and we were clearly outvoted.

\hspace*{\fill} --- Bill Venables \footnote{来源于 \href{https://www.stats.ox.ac.uk/pub/MASS3/Exegeses.pdf}{Exegeses on Linear Models}}
\end{quote}

\begin{quote}
方差分析、 A/B Test 和多重比较多用于互联网数据 lme 的特例
\end{quote}

\hypertarget{sec-one-way-anova}{%
\section{单因素方差分析}\label{sec-one-way-anova}}

chickwts 不同的喂食方式对体重的影响

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ feed, }\AttributeTok{data =}\NormalTok{ chickwts, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{,}
    \AttributeTok{varwidth =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{notch =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{main =} \StringTok{"chickwt data"}\NormalTok{,}
    \AttributeTok{ylab =} \StringTok{"Weight at six weeks (gm)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in (function (z, notch = FALSE, width = NULL, varwidth = FALSE, : some
## notches went outside hinges ('box'): maybe set notch=FALSE
\end{verbatim}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-2-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(fm1 }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ feed, }\AttributeTok{data =}\NormalTok{ chickwts))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Response: weight
##           Df Sum Sq Mean Sq F value    Pr(>F)    
## feed       5 231129   46226  15.365 5.936e-10 ***
## Residuals 65 195556    3009                      
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{opar }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\DecValTok{0}\NormalTok{),}
            \AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.1}\NormalTok{, }\FloatTok{4.1}\NormalTok{, }\FloatTok{2.1}\NormalTok{, }\FloatTok{1.1}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(fm1)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-2-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(opar)}
\end{Highlighting}
\end{Shaded}

sleep

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Student\textquotesingle{}s paired t{-}test 成对样本的 t 检验}
\FunctionTok{with}\NormalTok{(sleep,}
     \FunctionTok{t.test}\NormalTok{(extra[group }\SpecialCharTok{==} \DecValTok{1}\NormalTok{],}
\NormalTok{            extra[group }\SpecialCharTok{==} \DecValTok{2}\NormalTok{], }\AttributeTok{paired =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Paired t-test
## 
## data:  extra[group == 1] and extra[group == 2]
## t = -4.0621, df = 9, p-value = 0.002833
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -2.4598858 -0.7001142
## sample estimates:
## mean of the differences 
##                   -1.58
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# The sleep *prolongations*}
\NormalTok{sleep1 }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(sleep, extra[group }\SpecialCharTok{==} \DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ extra[group }\SpecialCharTok{==} \DecValTok{1}\NormalTok{])}
\FunctionTok{summary}\NormalTok{(sleep1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    0.00    1.05    1.30    1.58    1.70    4.60
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stripchart}\NormalTok{(sleep1, }\AttributeTok{method =} \StringTok{"stack"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"hours"}\NormalTok{,}
           \AttributeTok{main =} \StringTok{"Sleep prolongation (n = 10)"}\NormalTok{)}
\FunctionTok{boxplot}\NormalTok{(sleep1, }\AttributeTok{horizontal =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{at =}\NormalTok{ .}\DecValTok{6}\NormalTok{, }\AttributeTok{pars =} \FunctionTok{list}\NormalTok{(}\AttributeTok{boxwex =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{staplewex =} \FloatTok{0.25}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-4-1} \end{center}

另一个关于测量光速的例子，带分类变量的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{michelson }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(morley,}
                       \AttributeTok{Expt =} \FunctionTok{factor}\NormalTok{(Expt), }\AttributeTok{Run =} \FunctionTok{factor}\NormalTok{(Run))}
\FunctionTok{xtabs}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ Expt }\SpecialCharTok{+}\NormalTok{ Run, }\AttributeTok{data =}\NormalTok{ michelson)  }\CommentTok{\# 5 x 20 balanced (two{-}way)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Run
## Expt 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20
##    1 1 1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1
##    2 1 1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1
##    3 1 1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1
##    4 1 1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1
##    5 1 1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Speed }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Expt, }\AttributeTok{data =}\NormalTok{ michelson,}
     \AttributeTok{main =} \StringTok{"Speed of Light Data"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Experiment No."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-6-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fm }\OtherTok{\textless{}{-}} \FunctionTok{aov}\NormalTok{(Speed }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Run }\SpecialCharTok{+}\NormalTok{ Expt, }\AttributeTok{data =}\NormalTok{ michelson)}
\FunctionTok{summary}\NormalTok{(fm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             Df Sum Sq Mean Sq F value  Pr(>F)   
## Run         19 113344    5965   1.105 0.36321   
## Expt         4  94514   23629   4.378 0.00307 **
## Residuals   76 410166    5397                   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fm0 }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(fm, . }\SpecialCharTok{\textasciitilde{}}\NormalTok{ . }\SpecialCharTok{{-}}\NormalTok{ Run)}
\FunctionTok{anova}\NormalTok{(fm0, fm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Model 1: Speed ~ Expt
## Model 2: Speed ~ Run + Expt
##   Res.Df    RSS Df Sum of Sq      F Pr(>F)
## 1     95 523510                           
## 2     76 410166 19    113344 1.1053 0.3632
\end{verbatim}

ToothGrowth 维生素 C 对牙齿增长的关系

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{coplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose }\SpecialCharTok{|}\NormalTok{ supp, }\AttributeTok{data =}\NormalTok{ ToothGrowth, }\AttributeTok{panel =}\NormalTok{ panel.smooth,}
       \AttributeTok{xlab =} \StringTok{"ToothGrowth data: length vs dose, given type of supplement"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-9-1} \end{center}

\hypertarget{sec-two-way-anova}{%
\section{双因素方差分析}\label{sec-two-way-anova}}

\texttt{?lm} mlm

\hypertarget{sec-manova}{%
\section{多因素方差分析}\label{sec-manova}}

\href{https://github.com/smn74/MANOVA.RM}{MANOVA.RM} 和 \href{https://github.com/olangsrud/ffmanova}{ffmanova} 包处理多因素方差分析

\hypertarget{sec-kernal-smooth}{%
\section{核学习}\label{sec-kernal-smooth}}

基于核的机器学习算法 \href{https://CRAN.R-project.org/package=kernlab}{kernlab}

David Meyer 基于 \href{https://www.csie.ntu.edu.tw/~cjlin/libsvm/}{libsvm} 开发了 \href{https://r-forge.r-project.org/projects/e1071}{e1071} 包，基于核方法实现了非线性回归分类算法

\begin{quote}
线性模型、逻辑回归模型、多项逻辑回归模型、神经网络、朴素贝叶斯、分类回归树等模型和算法借助 Shiny 整合在一起 \url{https://radiant-rstats.github.io/docs/} 和 \url{http://radiant-rstats.github.io/radiant.model/}
\end{quote}

\hypertarget{sec-unify-machine-learning}{%
\section{通用机器学习}\label{sec-unify-machine-learning}}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:predict-functions} R 包之间的不一致性，计算预测分类的概率的语法}\tabularnewline
\toprule
函数 & R 包 & 代码 \\
\midrule
\endfirsthead
\toprule
函数 & R 包 & 代码 \\
\midrule
\endhead
\texttt{lda} & \texttt{MASS} & \texttt{predict(obj)} \\
\texttt{glm} & \texttt{stats} & \texttt{predict(obj,\ type\ =\ "response")} \\
\texttt{gbm} & \texttt{gbm} & \texttt{predict(obj,\ type\ =\ "response",\ n.trees)} \\
\texttt{mda} & \texttt{mda} & \texttt{predict(obj,\ type\ =\ "posterior")} \\
\texttt{rpart} & \texttt{rpart} & \texttt{predict(obj,\ type\ =\ "prob")} \\
\texttt{Weka} & \texttt{RWeka} & \texttt{predict(obj,\ type\ =\ "probability")} \\
\texttt{logitboost} & \texttt{LogitBoost} & \texttt{predict(obj,\ type\ =\ "raw",\ nIter)} \\
\texttt{pamr.train} & \texttt{pamr} & \texttt{pamr.predict(obj,\ type\ =\ "posterior")} \\
\bottomrule
\end{longtable}

\hypertarget{sec-linear-model-theory}{%
\section{理论基础}\label{sec-linear-model-theory}}

\begin{align}
Y &= X \beta + \epsilon \\
X^{\top}Y &= X^{\top}X\beta \\
\hat{\beta} &= (X^{\top}X)^{-1}X^{\top}Y \\
\hat{Y} &= X(X^{\top}X)^{-1}X^{\top}Y \\
\hat{\sigma^2} &= \frac{\|Y - \hat{Y}\|_2}{n - rk(X)} \\
  & = \frac{\|(I - X(X^{\top}X)^{-1}X^{\top})Y\|_2}{n - rk(X)}\\
  & = \frac{Y^{\top}(I - X(X^{\top}X)^{-1}X^{\top})Y}{n - rk(X)}
\end{align}

\hypertarget{sec-multivariate-multiple-linear-regression}{%
\section{多重多元线性回归}\label{sec-multivariate-multiple-linear-regression}}

\begin{quote}
参考 John Fox 和 Sanford Weisberg 的著作\citep{car_2019_Fox} 附录\footnote{\url{https://socialsciences.mcmaster.ca/jfox/Books/Companion/appendices.html}}
\end{quote}

多个响应变量和协变量\footnote{\url{https://data.library.virginia.edu/getting-started-with-multivariate-multiple-regression/}}

多重多元线性回归 multiply linear regression \texttt{lm} R 版本 3.6 以上 \href{https://bugs.r-project.org/bugzilla3/show_bug.cgi?id=17407}{PR\#17407}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_mtcars }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(mpg, qsec) }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{data =}\NormalTok{ mtcars, }\AttributeTok{offset =} \FunctionTok{cbind}\NormalTok{(wt, wt }\SpecialCharTok{*} \DecValTok{2}\NormalTok{))}
\FunctionTok{summary}\NormalTok{(fit\_mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Response mpg :
## 
## Call:
## lm(formula = mpg ~ 1, data = mtcars, offset = cbind(wt, wt * 
##     2))
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -11.897  -4.947  -1.316   2.984  15.192 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept)   16.873      1.219   13.85  8.1e-15 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 6.893 on 31 degrees of freedom
## 
## 
## Response qsec :
## 
## Call:
## lm(formula = qsec ~ 1, data = mtcars, offset = cbind(wt, wt * 
##     2))
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.6842 -2.0793 -0.1693  2.2693  5.1857 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept)  11.4142     0.5076   22.49   <2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 2.871 on 31 degrees of freedom
\end{verbatim}

\hypertarget{sec-regression-diagnostics}{%
\section{回归诊断}\label{sec-regression-diagnostics}}

包括线性模型和广义线性模型

Regression Deletion Diagnostics \texttt{?influence.measures}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(patchwork)}
\FunctionTok{data}\NormalTok{(}\StringTok{"anscombe"}\NormalTok{)}

\NormalTok{form }\OtherTok{\textless{}{-}} \FunctionTok{sprintf}\NormalTok{(}\StringTok{\textquotesingle{}y\%d \textasciitilde{} x\%d\textquotesingle{}}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(form, lm, }\AttributeTok{data =}\NormalTok{ anscombe)}

\NormalTok{plot\_lm }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(i) \{}
\NormalTok{  annotate\_texts }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{"nonlinearity"}\NormalTok{, }\StringTok{"outlier"}\NormalTok{, }\StringTok{"influential point"}\NormalTok{)}
\NormalTok{  p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ anscombe, }\FunctionTok{aes\_string}\NormalTok{(}\AttributeTok{x =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{, i), }\AttributeTok{y =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"y"}\NormalTok{, i))) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{geom\_abline}\NormalTok{(}\AttributeTok{intercept =} \FunctionTok{coef}\NormalTok{(fit[[i]])[}\DecValTok{1}\NormalTok{], }\AttributeTok{slope =} \FunctionTok{coef}\NormalTok{(fit[[i]])[}\DecValTok{2}\NormalTok{], }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}
      \AttributeTok{x =} \FunctionTok{substitute}\NormalTok{(}\FunctionTok{bold}\NormalTok{(x[a]), }\FunctionTok{list}\NormalTok{(}\AttributeTok{a =}\NormalTok{ i)), }\AttributeTok{y =} \FunctionTok{substitute}\NormalTok{(}\FunctionTok{bold}\NormalTok{(y[b]), }\FunctionTok{list}\NormalTok{(}\AttributeTok{b =}\NormalTok{ i)),}
      \AttributeTok{title =} \FunctionTok{bquote}\NormalTok{(}\FunctionTok{bold}\NormalTok{(R)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{==}\NormalTok{ .(}\FunctionTok{round}\NormalTok{(}\FunctionTok{summary}\NormalTok{(fit[[i]])}\SpecialCharTok{$}\NormalTok{r.squared, }\DecValTok{3}\NormalTok{)))}
\NormalTok{    )}
\NormalTok{  p }\SpecialCharTok{+} \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \DecValTok{12}\NormalTok{, }\AttributeTok{y =} \DecValTok{11}\NormalTok{, }\AttributeTok{label =}\NormalTok{ annotate\_texts[i])}

\NormalTok{\}}

\FunctionTok{Reduce}\NormalTok{(}\StringTok{"+"}\NormalTok{, }\FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, plot\_lm))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{linear-models_files/figure-latex/anscombe-1} 

}

\caption{线性模型可能在欺骗你}\label{fig:anscombe}
\end{figure}

\hypertarget{sec-states}{%
\section{1977 年美国人口普查}\label{sec-states}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{state\_data }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(state.x77, }\AttributeTok{row.names =}\NormalTok{ state.abb)}
\NormalTok{fit\_state }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Life.Exp }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ state\_data)}
\FunctionTok{summary}\NormalTok{(fit\_state)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = Life.Exp ~ ., data = state_data)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.48895 -0.51232 -0.02747  0.57002  1.49447 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(>|t|)    
## (Intercept)  7.094e+01  1.748e+00  40.586  < 2e-16 ***
## Population   5.180e-05  2.919e-05   1.775   0.0832 .  
## Income      -2.180e-05  2.444e-04  -0.089   0.9293    
## Illiteracy   3.382e-02  3.663e-01   0.092   0.9269    
## Murder      -3.011e-01  4.662e-02  -6.459 8.68e-08 ***
## HS.Grad      4.893e-02  2.332e-02   2.098   0.0420 *  
## Frost       -5.735e-03  3.143e-03  -1.825   0.0752 .  
## Area        -7.383e-08  1.668e-06  -0.044   0.9649    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.7448 on 42 degrees of freedom
## Multiple R-squared:  0.7362, Adjusted R-squared:  0.6922 
## F-statistic: 16.74 on 7 and 42 DF,  p-value: 2.534e-10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# step(fit\_state)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-rock}{%
\section{石油岩石样品的测量}\label{sec-rock}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(rock)}
\end{Highlighting}
\end{Shaded}

多元线性回归

\hypertarget{sec-swiss}{%
\section{1888 年瑞士生育率分析}\label{sec-swiss}}

1888 年，瑞士开始进入一个人口转变的阶段，从发展中国家的高出生率开始下滑。数据集 swiss 记录了 1888 年瑞士 47 个说法语的省份的生育率和社会经济指标数据，下面是数据集的部分

\begin{verbatim}
##              Fertility Agriculture Examination Education Catholic
## Courtelary        80.2        17.0          15        12     9.96
## Delemont          83.1        45.1           6         9    84.84
## Franches-Mnt      92.5        39.7           5         5    93.40
## Moutier           85.8        36.5          12         7    33.77
## Neuveville        76.9        43.5          17        15     5.16
....
\end{verbatim}

Fertility（生育率，采用常见的标准生育率统计口径）、Agriculture（男性从事农业生产的比例）、Examination（应征者在军队考试中获得最高等级的比例）、Education（应征者有小学以上教育水平的比例）、Catholic（信仰天主教的比例）、Infant.Mortality（婴儿死亡率，仅考虑出生一年内死亡），各个指标都统一标准化为百分比的形式。其中，Examination 和 Education 是 1887 年、1888 年和 1889 年的平均值。瑞士 182 个地区 1888 年及其它年份的数据可从\href{https://opr.princeton.edu/archive/pefp/switz.aspx}{网站}获得。

\begin{figure}

{\centering \includegraphics{linear-models_files/figure-latex/swiss-1} 

}

\caption{1888 年瑞士生育率和社会经济指标的关系}\label{fig:swiss}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_swiss }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Fertility }\SpecialCharTok{\textasciitilde{}}\NormalTok{ . }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{data =}\NormalTok{ swiss)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(fit\_swiss)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = Fertility ~ . - 1, data = swiss)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -16.8358  -6.3606  -0.5603   6.0585  23.3203 
## 
## Coefficients:
##                  Estimate Std. Error t value Pr(>|t|)    
## Agriculture       0.11100    0.07424   1.495  0.14233    
## Examination       0.44406    0.31435   1.413  0.16514    
## Education        -0.70674    0.25009  -2.826  0.00719 ** 
## Catholic          0.11707    0.04860   2.409  0.02046 *  
## Infant.Mortality  2.98366    0.31683   9.417 6.53e-12 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 9.893 on 42 degrees of freedom
## Multiple R-squared:  0.9828, Adjusted R-squared:  0.9807 
## F-statistic: 478.8 on 5 and 42 DF,  p-value: < 2.2e-16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(fit\_swiss)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Response: Fertility
##                  Df Sum Sq Mean Sq   F value    Pr(>F)    
## Agriculture       1 204039  204039 2084.6865 < 2.2e-16 ***
## Examination       1  16781   16781  171.4556 < 2.2e-16 ***
## Education         1     24      24    0.2454    0.6229    
## Catholic          1   4782    4782   48.8556 1.504e-08 ***
## Infant.Mortality  1   8680    8680   88.6858 6.528e-12 ***
## Residuals        42   4111      98                        
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

Cook 距离 \texttt{?plot.lm}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(fit\_swiss, }\AttributeTok{which =} \DecValTok{4}\NormalTok{, }\AttributeTok{sub.caption =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/fit-swiss-cook-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(fit\_swiss, }\AttributeTok{which =} \DecValTok{5}\NormalTok{, }\AttributeTok{sub.caption =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/fit-swiss-leverage-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{X }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(swiss[, }\FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(swiss), }\StringTok{"Fertility"}\NormalTok{)])}
\NormalTok{Y }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(swiss[, }\StringTok{"Fertility"}\NormalTok{])}
\CommentTok{\# beta 的估计}
\NormalTok{(beta\_hat }\OtherTok{\textless{}{-}} \FunctionTok{solve}\NormalTok{(}\AttributeTok{a =} \FunctionTok{crossprod}\NormalTok{(X, X), }\AttributeTok{b =} \FunctionTok{crossprod}\NormalTok{(X, Y)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                        [,1]
## Agriculture       0.1110005
## Examination       0.4440591
## Education        -0.7067362
## Catholic          0.1170662
## Infant.Mortality  2.9836617
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Y 的预测 MSE 残差平方和 }
\NormalTok{sigma2\_hat }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{t}\NormalTok{(Y) }\SpecialCharTok{\%*\%}\NormalTok{ (}\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{dim}\NormalTok{(X)[}\DecValTok{1}\NormalTok{])) }\SpecialCharTok{{-}}\NormalTok{ X }\SpecialCharTok{\%*\%} \FunctionTok{solve}\NormalTok{(}\FunctionTok{crossprod}\NormalTok{(X)) }\SpecialCharTok{\%*\%} \FunctionTok{t}\NormalTok{(X)) }\SpecialCharTok{\%*\%}\NormalTok{ Y)}\SpecialCharTok{/}\NormalTok{(}\FunctionTok{dim}\NormalTok{(X)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{qr}\NormalTok{(X)}\SpecialCharTok{$}\NormalTok{rank)}
\CommentTok{\# RMSE}
\FunctionTok{sqrt}\NormalTok{(sigma2\_hat)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          [,1]
## [1,] 9.893187
\end{verbatim}

\hypertarget{sec-life-cycle-savings}{%
\section{Intercountry Life-Cycle Savings Data 1960-1970}\label{sec-life-cycle-savings}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"LifeCycleSavings"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-longley}{%
\section{Longley's Economic Regression Data 1947-1962}\label{sec-longley}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"longley"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-Formaldehyde}{%
\section{甲醛的测定}\label{sec-Formaldehyde}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ Formaldehyde, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carb, }\AttributeTok{y =}\NormalTok{ optden)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-16-1} \end{center}

\hypertarget{sec-morley}{%
\section{迈克尔逊光速数据分析}\label{sec-morley}}

1879 年迈克尔逊光速测量数据，记录了五次实验，每次试验测量 20 次光速，得到表格 \ref{tab:morley-data}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ morley, }\AttributeTok{v.names =} \StringTok{"Speed"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"Expt"}\NormalTok{,}
  \AttributeTok{timevar =} \StringTok{"Run"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(.,}
    \AttributeTok{caption =} \StringTok{"迈克尔逊光速数据"}\NormalTok{,}
    \AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col.names =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(Speed)"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{names}\NormalTok{(.)),}
    \AttributeTok{align =} \StringTok{"c"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:morley-data}迈克尔逊光速数据}
\centering
\begin{tabular}[t]{c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c}
\hline
Expt & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 & 12 & 13 & 14 & 15 & 16 & 17 & 18 & 19 & 20\\
\hline
1 & 850 & 740 & 900 & 1070 & 930 & 850 & 950 & 980 & 980 & 880 & 1000 & 980 & 930 & 650 & 760 & 810 & 1000 & 1000 & 960 & 960\\
\hline
2 & 960 & 940 & 960 & 940 & 880 & 800 & 850 & 880 & 900 & 840 & 830 & 790 & 810 & 880 & 880 & 830 & 800 & 790 & 760 & 800\\
\hline
3 & 880 & 880 & 880 & 860 & 720 & 720 & 620 & 860 & 970 & 950 & 880 & 910 & 850 & 870 & 840 & 840 & 850 & 840 & 840 & 840\\
\hline
4 & 890 & 810 & 810 & 820 & 800 & 770 & 760 & 740 & 750 & 760 & 910 & 920 & 890 & 860 & 880 & 720 & 840 & 850 & 850 & 780\\
\hline
5 & 890 & 840 & 780 & 810 & 760 & 810 & 790 & 810 & 820 & 850 & 870 & 870 & 810 & 740 & 810 & 940 & 950 & 800 & 810 & 870\\
\hline
\end{tabular}
\end{table}

数据集 morley 中光速 Speed 已经编码过了，原始观测速度减去了 299000 (km/sec)，为了展示方便

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ morley, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Expt, }\AttributeTok{y =}\NormalTok{ Speed, }\AttributeTok{group =}\NormalTok{ Expt)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Expt"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Speed (km/sec)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{linear-models_files/figure-latex/morley-1} 

}

\caption{1879 年迈克尔逊光速实验数据}\label{fig:morley}
\end{figure}

\hypertarget{sec-chickwts}{%
\section{不同喂食方式对小鸡体重的影响 I}\label{sec-chickwts}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ chickwts, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ feed, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{color =}\NormalTok{ feed)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{linear-models_files/figure-latex/chickwts-1} 

}

\caption{不同喂食方式对小鸡的影响}\label{fig:chickwts}
\end{figure}

\hypertarget{sec-ChickWeight}{%
\section{不同喂食方式对小鸡体重的影响 II}\label{sec-ChickWeight}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ChickWeight, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Time, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{group =}\NormalTok{ Chick, }\AttributeTok{color =}\NormalTok{ Diet)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{Diet) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-17-1} \end{center}

添加趋势线

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ChickWeight, }
       \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Time, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{group =}\NormalTok{ Diet, }\AttributeTok{colour =}\NormalTok{ Diet)) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{Diet) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{stat\_summary}\NormalTok{(}\AttributeTok{fun =} \StringTok{"mean"}\NormalTok{, }\AttributeTok{geom =} \StringTok{"line"}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Chick Weight over Time by Diet"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"Time (days)"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Weight (grams)"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-18-1} \end{center}

\hypertarget{sec-DNase}{%
\section{酶的酶联免疫吸附测定}\label{sec-DNase}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ DNase, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{ conc,}\AttributeTok{y=}\NormalTok{ density, }\AttributeTok{color =}\NormalTok{ Run)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-19-1} \end{center}

\hypertarget{sec-BirthWeight}{%
\section{婴儿的体重随年龄的变化情况}\label{sec-BirthWeight}}

BirthWeight 数据集记录了婴儿的体重随年龄的变化情况，年龄以周为单位计，体重以克为单位计

\begin{center}\includegraphics{linear-models_files/figure-latex/Birth-Weight-1} \end{center}

\begin{center}\includegraphics{linear-models_files/figure-latex/Birth-Weight-2} \end{center}

性别和年龄两个变量，分别是离散型的分类变量和连续型的变量

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 带截距项和不带截距项}
\FunctionTok{summary}\NormalTok{(l1 }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(birthw }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sex }\SpecialCharTok{+}\NormalTok{ age), }\AttributeTok{correlation =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = birthw ~ sex + age)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -257.49 -125.28  -58.44  169.00  303.98 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -1610.28     786.08  -2.049   0.0532 .  
## sexF         -163.04      72.81  -2.239   0.0361 *  
## age           120.89      20.46   5.908 7.28e-06 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 177.1 on 21 degrees of freedom
## Multiple R-squared:   0.64,  Adjusted R-squared:  0.6057 
## F-statistic: 18.67 on 2 and 21 DF,  p-value: 2.194e-05
## 
## Correlation of Coefficients:
##      (Intercept) sexF 
## sexF  0.07            
## age  -1.00       -0.12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(l1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Response: birthw
##           Df  Sum Sq Mean Sq F value    Pr(>F)    
## sex        1   76163   76163  2.4279    0.1341    
## age        1 1094940 1094940 34.9040 7.284e-06 ***
## Residuals 21  658771   31370                      
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 与带交互项的模型比较}
\FunctionTok{summary}\NormalTok{(li }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(birthw }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sex }\SpecialCharTok{+}\NormalTok{ sex}\SpecialCharTok{:}\NormalTok{age), }\AttributeTok{correlation =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = birthw ~ sex + sex:age)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -246.69 -138.11  -39.13  176.57  274.28 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -1268.67    1114.64  -1.138 0.268492    
## sexF         -872.99    1611.33  -0.542 0.593952    
## sexM:age      111.98      29.05   3.855 0.000986 ***
## sexF:age      130.40      30.00   4.347 0.000313 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 180.6 on 20 degrees of freedom
## Multiple R-squared:  0.6435, Adjusted R-squared:   0.59 
## F-statistic: 12.03 on 3 and 20 DF,  p-value: 0.000101
## 
## Correlation of Coefficients:
##          (Intercept) sexF  sexM:age
## sexF     -0.69                     
## sexM:age -1.00        0.69         
## sexF:age  0.00       -0.72  0.00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(li, l1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Model 1: birthw ~ sex + sex:age
## Model 2: birthw ~ sex + age
##   Res.Df    RSS Df Sum of Sq      F Pr(>F)
## 1     20 652425                           
## 2     21 658771 -1   -6346.2 0.1945 0.6639
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 类似，只是使用 glm 命令来拟合而已}
\FunctionTok{summary}\NormalTok{(zi }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(birthw }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sex }\SpecialCharTok{+}\NormalTok{ age, }\AttributeTok{family =} \FunctionTok{gaussian}\NormalTok{()))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = birthw ~ sex + age, family = gaussian())
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -257.49  -125.28   -58.44   169.00   303.98  
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -1610.28     786.08  -2.049   0.0532 .  
## sexF         -163.04      72.81  -2.239   0.0361 *  
## age           120.89      20.46   5.908 7.28e-06 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for gaussian family taken to be 31370.04)
## 
##     Null deviance: 1829873  on 23  degrees of freedom
## Residual deviance:  658771  on 21  degrees of freedom
## AIC: 321.39
## 
## Number of Fisher Scoring iterations: 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(zi)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Deviance Table
## 
## Model: gaussian, link: identity
## 
## Response: birthw
## 
## Terms added sequentially (first to last)
## 
## 
##      Df Deviance Resid. Df Resid. Dev
## NULL                    23    1829873
## sex   1    76163        22    1753711
## age   1  1094940        21     658771
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# summary(z.o4 \textless{}{-} update(zi, subset = {-}4))}
\FunctionTok{summary}\NormalTok{(zz }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(zi, birthw }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sex }\SpecialCharTok{+}\NormalTok{ age }\SpecialCharTok{+}\NormalTok{ sex}\SpecialCharTok{:}\NormalTok{age))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = birthw ~ sex + age + sex:age, family = gaussian())
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -246.69  -138.11   -39.13   176.57   274.28  
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -1268.67    1114.64  -1.138 0.268492    
## sexF         -872.99    1611.33  -0.542 0.593952    
## age           111.98      29.05   3.855 0.000986 ***
## sexF:age       18.42      41.76   0.441 0.663893    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for gaussian family taken to be 32621.23)
## 
##     Null deviance: 1829873  on 23  degrees of freedom
## Residual deviance:  652425  on 20  degrees of freedom
## AIC: 323.16
## 
## Number of Fisher Scoring iterations: 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(zi, zz)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Deviance Table
## 
## Model 1: birthw ~ sex + age
## Model 2: birthw ~ sex + age + sex:age
##   Resid. Df Resid. Dev Df Deviance
## 1        21     658771            
## 2        20     652425  1   6346.2
\end{verbatim}

\hypertarget{sec-loblolly}{%
\section{火炬松树的生长情况}\label{sec-loblolly}}

表 \ref{tab:loblolly-data} 记录了 14 颗火炬树种子的生长情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(Loblolly, }\AttributeTok{idvar =} \StringTok{"Seed"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"age"}\NormalTok{,}
        \AttributeTok{v.names =} \StringTok{"height"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(.,}
    \AttributeTok{caption =} \StringTok{"火炬松树的高度（英尺）随时间（年）的变化"}\NormalTok{,}
    \AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col.names =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(height)"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{names}\NormalTok{(.)),}
    \AttributeTok{align =} \StringTok{"c"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:loblolly-data}火炬松树的高度（英尺）随时间（年）的变化}
\centering
\begin{tabular}[t]{c|c|c|c|c|c|c}
\hline
Seed & 3 & 5 & 10 & 15 & 20 & 25\\
\hline
301 & 4.51 & 10.89 & 28.72 & 41.74 & 52.70 & 60.92\\
\hline
303 & 4.55 & 10.92 & 29.07 & 42.83 & 53.88 & 63.39\\
\hline
305 & 4.79 & 11.37 & 30.21 & 44.40 & 55.82 & 64.10\\
\hline
307 & 3.91 & 9.48 & 25.66 & 39.07 & 50.78 & 59.07\\
\hline
309 & 4.81 & 11.20 & 28.66 & 41.66 & 53.31 & 63.05\\
\hline
311 & 3.88 & 9.40 & 25.99 & 39.55 & 51.46 & 59.64\\
\hline
315 & 4.32 & 10.43 & 27.16 & 40.85 & 51.33 & 60.07\\
\hline
319 & 4.57 & 10.57 & 27.90 & 41.13 & 52.43 & 60.69\\
\hline
321 & 3.77 & 9.03 & 25.45 & 38.98 & 49.76 & 60.28\\
\hline
323 & 4.33 & 10.79 & 28.97 & 42.44 & 53.17 & 61.62\\
\hline
325 & 4.38 & 10.48 & 27.93 & 40.20 & 50.06 & 58.49\\
\hline
327 & 4.12 & 9.92 & 26.54 & 37.82 & 48.43 & 56.81\\
\hline
329 & 3.93 & 9.34 & 26.08 & 37.79 & 48.31 & 56.43\\
\hline
331 & 3.46 & 9.05 & 25.85 & 39.15 & 49.12 & 59.49\\
\hline
\end{tabular}
\end{table}

图 \ref{fig:loblolly-tree} 火炬树种子基本决定了树的长势，不同种子预示最后的高度，并且在生长期也是很稳定地生长

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ Loblolly, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ height, }\AttributeTok{color =}\NormalTok{ Seed)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"age (yr)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"height (ft)"}\NormalTok{)}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{linear-models_files/figure-latex/loblolly-tree-1} 

}

\caption{不同火炬树的生长情况}\label{fig:loblolly-tree}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gganimate)}
\NormalTok{p }\SpecialCharTok{+} \FunctionTok{transition\_reveal}\NormalTok{(age)}
\end{Highlighting}
\end{Shaded}

\begin{center}\animategraphics[,controls,loop]{10}{linear-models_files/figure-latex/loblolly-animate-}{1}{100}\end{center}

\hypertarget{sec-Puromycin}{%
\section{酶促反应的反应速率}\label{sec-Puromycin}}

Puromycin 酶促反应的反应速度，模型拟合 \texttt{?SSmicmen}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ Puromycin, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ conc, }\AttributeTok{y =}\NormalTok{ rate, }\AttributeTok{color =}\NormalTok{ state)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Substrate concentration (ppm)"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Reaction velocity (counts/min/min)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Puromycin data and fitted Michaelis{-}Menten curves"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-21-1} \end{center}

\hypertarget{sec-Theoph}{%
\section{茶碱的药代动力学}\label{sec-Theoph}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ Theoph, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Time, }\AttributeTok{y =}\NormalTok{ conc, }\AttributeTok{color =}\NormalTok{ Subject)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(Wt }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Dose, }\AttributeTok{ncol =} \DecValTok{3}\NormalTok{, }\AttributeTok{labeller =} \StringTok{"label\_both"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Time since drug administration (hr)"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Theophylline concentration (mg/L)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Observed concentrations and fitted model"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-22-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Theoph }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{transform}\NormalTok{(., }\AttributeTok{wt\_dose =} \FunctionTok{paste}\NormalTok{(Wt, Dose, }\AttributeTok{sep =} \StringTok{"\textasciitilde{}"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(., }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Time, }\AttributeTok{y =}\NormalTok{ conc, }\AttributeTok{color =}\NormalTok{ wt\_dose)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Time since drug administration (hr)"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Theophylline concentration (mg/L)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Observed concentrations and fitted model"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-23-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ Theoph, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Time, }\AttributeTok{y =}\NormalTok{ conc, }\AttributeTok{color =}\NormalTok{ Subject)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Time since drug administration (hr)"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Theophylline concentration (mg/L)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Observed concentrations and fitted model"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{linear-models_files/figure-latex/unnamed-chunk-24-1} \end{center}

\hypertarget{sec-linear-model-summary}{%
\section{本章总结}\label{sec-linear-model-summary}}

模型永远没完，总是需要自己去构造符合自己需求的模型及其实现，只有自己能够实现，才能在海洋中遨游

\begin{quote}
This is a bit like asking how should I tweak my sailboat so I can explore the ocean floor.

\hspace*{\fill} --- Roger Koenker \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2013-May/354311.html}}
\end{quote}

\hypertarget{sec-linear-model-sessioninfo}{%
\section{运行环境}\label{sec-linear-model-sessioninfo}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] patchwork_1.1.1 gganimate_1.0.7 ggplot2_3.3.5   magrittr_2.0.1 
## 
## loaded via a namespace (and not attached):
##  [1] progress_1.2.2    tidyselect_1.1.1  xfun_0.26         purrr_0.3.4      
##  [5] splines_4.1.1     lattice_0.20-45   colorspace_2.0-2  vctrs_0.3.8      
##  [9] generics_0.1.0    htmltools_0.5.2   viridisLite_0.4.0 yaml_2.2.1       
## [13] mgcv_1.8-37       utf8_1.2.2        rlang_0.4.11      pillar_1.6.3     
## [17] glue_1.4.2        withr_2.4.2       DBI_1.1.1         tweenr_1.0.2     
## [21] plyr_1.8.6        lifecycle_1.0.1   stringr_1.4.0     munsell_0.5.0    
## [25] gtable_0.3.0      codetools_0.2-18  evaluate_0.14     labeling_0.4.2   
## [29] knitr_1.36        fastmap_1.1.0     curl_4.3.2        fansi_0.5.0      
## [33] gifski_1.4.3-1    Rcpp_1.0.7        scales_1.1.1      farver_2.1.0     
## [37] hms_1.1.1         digest_0.6.28     stringi_1.7.4     bookdown_0.24    
## [41] dplyr_1.0.7       grid_4.1.1        tools_4.1.1       tibble_3.1.5     
## [45] crayon_1.4.1      pkgconfig_2.0.3   ellipsis_0.3.2    Matrix_1.3-4     
## [49] prettyunits_1.1.1 assertthat_0.2.1  rmarkdown_2.11    R6_2.5.1         
## [53] nlme_3.1-153      compiler_4.1.1
\end{verbatim}

\hypertarget{chap-generalized-linear-models}{%
\chapter{广义线性模型}\label{chap-generalized-linear-models}}

\begin{quote}
It's not meant for sampling weights. It's meant for precision weights. How best to include sampling weights in mixed models is a research problem at the moment, but you can rely on getting the wrong answer if you just use the \texttt{weights\ =} argument.

\hspace*{\fill} --- Thomas Lumley \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2012-January/301501.html}}
\end{quote}

一般广义线性模型理论参考文献 An Introduction to Generalized Linear Models \citep{Dobson_2018_Generalized} 和 Generalized Linear Models \citep{McCullagh_1989_Generalized}，逻辑回归模型主要参考 Applied Logistic Regression \citep{David_2000_Logistic} 和 Discrete Choice Methods with Simulation \citep{Train_2009_mlogit}。

简单线性模型（Linear Models，简称 LM），\texttt{stats::lm()} 函数可以拟合线性模型，而一般线性模型（General Linear Models，简称 GLM）允许线性模型方差非齐性、存在相关关系，甚至可以扩展到线性混合效应模型，将线性回归模型，方差分析模型，协方差分析模型统一地看待，一般要采用广义最小二乘（Generalized Least Squares，简称 GLS）拟合， \texttt{nlme::gls()} 函数实现广义最小二乘拟合线性模型，类似地，\texttt{nlme::gnls()} 函数实现广义最小二乘拟合非线性模型。\texttt{glm2::glm2()} 补充 \texttt{glm()}，提供更加稳定的拟合方法，适应于 \texttt{glm()} 不收敛的情况，而 \texttt{fastglm::fastglm()} 主要是加快 \texttt{glm()} 求解效率，收敛效果也比 \texttt{glm()} 和 \texttt{glm2()} 好。

\href{https://CRAN.R-project.org/package=glmnet}{glmnet} 包是处理广义线性模型的事实标准。 其官网见 \url{https://glmnet.stanford.edu/}，而 \href{https://github.com/hongooi73/glmnetUtils}{glmnetUtils} 补充公式接口，适用于弹性网络回归，交叉验证筛选 \(\alpha\) 参数等。 \href{https://CRAN.R-project.org/package=glmpath}{glmpath} 包实现 path-following 算法用于带 L1 正则项的广义线性模型和 Cox 比例风险模型。\href{https://github.com/steve-the-bayesian/BOOM}{Boom} 和 \textbf{BoomSpikeSlab} 包实现 MCMC 算法用于 Spike 和 Slab 回归，而 \textbf{spikeslab} 包进一步实现预测和变量选择 \citep{spikeslab_2005_Ishwaran}。\href{https://github.com/OHDSI/Cyclops}{Cyclops} 包实现 Cyclic coordinate descent 算法 用于逻辑回归、泊松回归和生存分析，适用于大规模正则回归 large scale regularized regressions，达到百万级别的观测和特征变量，交叉验证自动选择超参数，独立变量稀疏表示，用剖面似然估计某个变量的置信区间。\href{https://github.com/fbertran/plsRglm}{plsRglm} 包实现偏最小二乘回归方法用于广义线性模型。\textbf{biglm}、\href{https://cran.r-project.org/package=speedglm}{speedglm} 和 \href{https://CRAN.R-project.org/package=bigReg}{bigReg} 用于处理大数据集的回归，求解限制内存的 GLM \href{https://CRAN.R-project.org/package=biglmm}{biglmm}。\href{https://CRAN.R-project.org/package=cglm}{cglm} 估计带聚类数据的条件 GLM 的回归系数和发散参数。\href{https://CRAN.R-project.org/package=MGLM}{MGLM} 拟合多个响应变量的广义线性回归模型（多重 GLM ）。\href{https://CRAN.R-project.org/package=robmixglm}{robmixglm} 响应变量扩展到混合分布的情形，实现稳健 GLM 回归估计。\href{https://CRAN.R-project.org/package=ClusterBootstrap}{ClusterBootstrap} 实现自主法估计带聚类数据的 GLM。\href{https://CRAN.R-project.org/package=lcpm}{lcpm} 和 \href{https://CRAN.R-project.org/package=oglmx}{oglmx} 处理有序输出的回归。 \href{https://cran.r-project.org/package=gmnl}{gmnl}、 \href{https://CRAN.R-project.org/package=mlogit}{mlogit} \citep{Train_2009_mlogit} 和 \textbf{mnlogit} \citep{mnlogit_2016_JSS} 处理多项逻辑回归。\href{https://github.com/atahk/pscl}{pscl} 包（Political Science Computational Laboratory）可以处理贝叶斯 IRT 模型，zero-inflated 零膨胀模型，广义线性模型的拟合优度度量。

\hypertarget{sec-glm-introduction}{%
\section{介绍}\label{sec-glm-introduction}}

模型结构，模型种类，参数估计办法，相当于综述

响应变量分别服从二项分布、多项分布、对数正态分布、泊松分布、伽马分布

\hypertarget{sec-glm-theory}{%
\section{理论基础}\label{sec-glm-theory}}

分两个段落分别介绍指数族和 GLM

\[
f(y;\theta,\phi) = \exp[(a(y) b(\theta) + c(\theta))/f(\phi) + d(y,\phi)]
\]

泊松分布 (with \(\lambda \to \theta\), \(x \to y\)) (\(\phi=1\)):

\begin{equation}
\begin{split}
f(y,\theta) & = \exp(-\theta) \theta^y/(y!) \\
            & = \exp\left( \underbrace{y}_{a(y)} 
                           \underbrace{\log \theta}_{b(\theta)} + 
                           \underbrace{(-\theta)}_{c(\theta)} + 
                           \underbrace{(- \log(y!))}_{d(y)} \right)
\end{split}
\end{equation}

\hypertarget{subsec-glm-ridge}{%
\subsection{岭回归}\label{subsec-glm-ridge}}

Geometry and properties of generalized ridge regression in high dimensions \url{http://web.ccs.miami.edu/~hishwaran/papers/IR.conmath2014.pdf}

这篇文章借助三维几何图形展示高维情形下的广义岭回归

\hypertarget{subsec-glm-lasso}{%
\subsection{Lasso}\label{subsec-glm-lasso}}

glmnet: Lasso and Elastic-Net Regularized Generalized Linear Models \url{https://glmnet.stanford.edu}

\hypertarget{subset:glm-best-subset}{%
\subsection{最优子集回归}\label{subset:glm-best-subset}}

bestglm: Best Subset GLM and Regression Utilities

\hypertarget{subsec-glm-pls}{%
\subsection{偏最小二乘回归}\label{subsec-glm-pls}}

\href{https://github.com/bhmevik/pls}{pls} 包 \citep{JSS_2007_pls} 实现了偏最小二乘回归（partial least squares regression， PLS）和主成分回归 （principal component regression， PCR），详见主页 \url{https://mevik.net/work/software/pls.html} 帮助文档的质量较高，是比较完整全面的。

\begin{itemize}
\tightlist
\item
  several algorithms: the traditional orthogonal scores (NIPALS) PLS algorithm, kernel PLS, wide kernel PLS, Simpls and PCR through svd
\item
  supports multi-response models (aka PLS2)
\item
  flexible cross-validation
\item
  Jackknife variance estimates of regression coefficients
\item
  extensive and flexible plots: scores, loadings, predictions, coefficients, (R)MSEP, R², correlation loadings
\item
  formula interface, modelled after lm(), with methods for predict, print, summary, plot, update, etc.
\item
  extraction functions for coefficients, scores and loadings
\item
  MSEP, RMSEP and R² estimates
\item
  multiplicative scatter correction (MSC)
\end{itemize}

\hypertarget{sec-alcohol}{%
\section{吸烟喝酒和食道癌的关系}\label{sec-alcohol}}

存在有序分类数据

酒精的作用 effects of alcohol, tobacco and interaction, age-adjusted 数据集描述见 \texttt{help(esoph)}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(esoph)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   agegp     alcgp    tobgp ncases ncontrols
## 1 25-34 0-39g/day 0-9g/day      0        40
## 2 25-34 0-39g/day    10-19      0        10
## 3 25-34 0-39g/day    20-29      0         6
## 4 25-34 0-39g/day      30+      0         5
## 5 25-34     40-79 0-9g/day      0        27
## 6 25-34     40-79    10-19      0         7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(esoph)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    88 obs. of  5 variables:
##  $ agegp    : Ord.factor w/ 6 levels "25-34"<"35-44"<..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ alcgp    : Ord.factor w/ 4 levels "0-39g/day"<"40-79"<..: 1 1 1 1 2 2 2 2 3 3 ...
##  $ tobgp    : Ord.factor w/ 4 levels "0-9g/day"<"10-19"<..: 1 2 3 4 1 2 3 4 1 2 ...
##  $ ncases   : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ ncontrols: num  40 10 6 5 27 7 4 7 2 1 ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ esoph, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ agegp, }\AttributeTok{y =}\NormalTok{ ncases }\SpecialCharTok{/}\NormalTok{ (ncases }\SpecialCharTok{+}\NormalTok{ ncontrols), }\AttributeTok{color =}\NormalTok{ agegp)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ esoph, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ alcgp, }\AttributeTok{y =}\NormalTok{ ncases }\SpecialCharTok{/}\NormalTok{ ncontrols, }\AttributeTok{color =}\NormalTok{ alcgp)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ esoph, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ tobgp, }\AttributeTok{y =}\NormalTok{ ncases }\SpecialCharTok{/}\NormalTok{ ncontrols, }\AttributeTok{color =}\NormalTok{ tobgp)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\NormalTok{bottom\_row }\OtherTok{\textless{}{-}} \FunctionTok{plot\_grid}\NormalTok{(p2, p3, }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}C\textquotesingle{}}\NormalTok{), }\AttributeTok{label\_size =} \DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 12 rows containing non-finite values (stat_boxplot).
\end{verbatim}

\begin{verbatim}
## Warning: Removed 12 rows containing missing values (geom_point).
\end{verbatim}

\begin{verbatim}
## Warning: Removed 12 rows containing non-finite values (stat_boxplot).
\end{verbatim}

\begin{verbatim}
## Warning: Removed 12 rows containing missing values (geom_point).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_grid}\NormalTok{(p1, bottom\_row, }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{), }\AttributeTok{label\_size =} \DecValTok{12}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{generalized-linear-models_files/figure-latex/esoph-data-1} 

}

\caption{吸烟喝酒和食道癌的关系}\label{fig:esoph-data}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_esoph\_glm }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(ncases, ncontrols) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ agegp }\SpecialCharTok{+}\NormalTok{ tobgp }\SpecialCharTok{*}\NormalTok{ alcgp,}
  \AttributeTok{data =}\NormalTok{ esoph, }\AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(}\AttributeTok{link =} \StringTok{"logit"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Rcpp)}
\NormalTok{fit\_esoph\_brm }\OtherTok{\textless{}{-}}\NormalTok{ brms}\SpecialCharTok{::}\FunctionTok{brm}\NormalTok{(ncases }\SpecialCharTok{|} \FunctionTok{trials}\NormalTok{(ncases }\SpecialCharTok{+}\NormalTok{ ncontrols) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ agegp }\SpecialCharTok{+}\NormalTok{ tobgp }\SpecialCharTok{*}\NormalTok{ alcgp,}
  \AttributeTok{data =}\NormalTok{ esoph, }\AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(}\AttributeTok{link =} \StringTok{"logit"}\NormalTok{), }\AttributeTok{refresh =} \DecValTok{0}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-infert}{%
\section{自然流产和人工流产后的不育}\label{sec-infert}}

\texttt{help(infert)}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(infert)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   education age parity induced case spontaneous stratum pooled.stratum
## 1    0-5yrs  26      6       1    1           2       1              3
## 2    0-5yrs  42      1       1    1           0       2              1
## 3    0-5yrs  39      6       2    1           0       3              4
## 4    0-5yrs  34      4       2    1           0       4              2
## 5   6-11yrs  35      3       1    1           1       5             32
## 6   6-11yrs  36      4       2    1           1       6             36
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(infert)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    248 obs. of  8 variables:
##  $ education     : Factor w/ 3 levels "0-5yrs","6-11yrs",..: 1 1 1 1 2 2 2 2 2 2 ...
##  $ age           : num  26 42 39 34 35 36 23 32 21 28 ...
##  $ parity        : num  6 1 6 4 3 4 1 2 1 2 ...
##  $ induced       : num  1 1 2 2 1 2 0 0 0 0 ...
##  $ case          : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ spontaneous   : num  2 0 0 0 1 1 0 0 1 0 ...
##  $ stratum       : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ pooled.stratum: num  3 1 4 2 32 36 6 22 5 19 ...
\end{verbatim}

存在无序分类变量

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{infert\_glm\_1 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(case }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spontaneous }\SpecialCharTok{+}\NormalTok{ induced,}
  \AttributeTok{data =}\NormalTok{ infert, }\AttributeTok{family =} \FunctionTok{binomial}\NormalTok{()}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(infert\_glm\_1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = case ~ spontaneous + induced, family = binomial(), 
##     data = infert)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.6678  -0.8360  -0.5772   0.9030   1.9362  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  -1.7079     0.2677  -6.380 1.78e-10 ***
## spontaneous   1.1972     0.2116   5.657 1.54e-08 ***
## induced       0.4181     0.2056   2.033    0.042 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 316.17  on 247  degrees of freedom
## Residual deviance: 279.61  on 245  degrees of freedom
## AIC: 285.61
## 
## Number of Fisher Scoring iterations: 4
\end{verbatim}

考虑其他潜在的因素

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{infert\_glm\_2 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(case }\SpecialCharTok{\textasciitilde{}}\NormalTok{ age }\SpecialCharTok{+}\NormalTok{ parity }\SpecialCharTok{+}\NormalTok{ education }\SpecialCharTok{+}\NormalTok{ spontaneous }\SpecialCharTok{+}\NormalTok{ induced,}
  \AttributeTok{data =}\NormalTok{ infert, }\AttributeTok{family =} \FunctionTok{binomial}\NormalTok{()}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(infert\_glm\_2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = case ~ age + parity + education + spontaneous + 
##     induced, family = binomial(), data = infert)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.7603  -0.8162  -0.4956   0.8349   2.6536  
## 
## Coefficients:
##                  Estimate Std. Error z value Pr(>|z|)    
## (Intercept)      -1.14924    1.41220  -0.814   0.4158    
## age               0.03958    0.03120   1.269   0.2046    
## parity           -0.82828    0.19649  -4.215 2.49e-05 ***
## education6-11yrs -1.04424    0.79255  -1.318   0.1876    
## education12+ yrs -1.40321    0.83416  -1.682   0.0925 .  
## spontaneous       2.04591    0.31016   6.596 4.21e-11 ***
## induced           1.28876    0.30146   4.275 1.91e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 316.17  on 247  degrees of freedom
## Residual deviance: 257.80  on 241  degrees of freedom
## AIC: 271.8
## 
## Number of Fisher Scoring iterations: 4
\end{verbatim}

实际上应该使用条件逻辑回归， 调用 \textbf{survival} 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(survival)}
\NormalTok{infert\_glm\_3 }\OtherTok{\textless{}{-}} \FunctionTok{clogit}\NormalTok{(case }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spontaneous }\SpecialCharTok{+}\NormalTok{ induced }\SpecialCharTok{+} \FunctionTok{strata}\NormalTok{(stratum),}
  \AttributeTok{data =}\NormalTok{ infert}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(infert\_glm\_3)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## coxph(formula = Surv(rep(1, 248L), case) ~ spontaneous + induced + 
##     strata(stratum), data = infert, method = "exact")
## 
##   n= 248, number of events= 83 
## 
##               coef exp(coef) se(coef)     z Pr(>|z|)    
## spontaneous 1.9859    7.2854   0.3524 5.635 1.75e-08 ***
## induced     1.4090    4.0919   0.3607 3.906 9.38e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
##             exp(coef) exp(-coef) lower .95 upper .95
## spontaneous     7.285     0.1373     3.651    14.536
## induced         4.092     0.2444     2.018     8.298
## 
## Concordance= 0.776  (se = 0.044 )
## Likelihood ratio test= 53.15  on 2 df,   p=3e-12
## Wald test            = 31.84  on 2 df,   p=1e-07
## Score (logrank) test = 48.44  on 2 df,   p=3e-11
\end{verbatim}

\hypertarget{sec-australia-bacteria}{%
\section{细菌数据集}\label{sec-australia-bacteria}}

流感嗜血杆菌的细菌与中耳炎患儿

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(bacteria, }\AttributeTok{package =} \StringTok{"MASS"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 惩罚拟似然}
\NormalTok{fit\_glmmpql }\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{glmmPQL}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ trt }\SpecialCharTok{+} \FunctionTok{I}\NormalTok{(week }\SpecialCharTok{\textgreater{}} \DecValTok{2}\NormalTok{),}
  \AttributeTok{random =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ ID, }\AttributeTok{verbose =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{family =}\NormalTok{ binomial, }\AttributeTok{data =}\NormalTok{ bacteria}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_glmmpql)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Linear mixed-effects model fit by maximum likelihood
##   Data: bacteria 
##   AIC BIC logLik
##    NA  NA     NA
## 
## Random effects:
##  Formula: ~1 | ID
##         (Intercept)  Residual
## StdDev:    1.410637 0.7800511
## 
## Variance function:
##  Structure: fixed weights
##  Formula: ~invwt 
## Fixed effects:  y ~ trt + I(week > 2) 
##                     Value Std.Error  DF   t-value p-value
## (Intercept)      3.412014 0.5185033 169  6.580506  0.0000
## trtdrug         -1.247355 0.6440635  47 -1.936696  0.0588
## trtdrug+        -0.754327 0.6453978  47 -1.168779  0.2484
## I(week > 2)TRUE -1.607257 0.3583379 169 -4.485311  0.0000
##  Correlation: 
##                 (Intr) trtdrg trtdr+
## trtdrug         -0.598              
## trtdrug+        -0.571  0.460       
## I(week > 2)TRUE -0.537  0.047 -0.001
## 
## Standardized Within-Group Residuals:
##        Min         Q1        Med         Q3        Max 
## -5.1985361  0.1572336  0.3513075  0.4949482  1.7448845 
## 
## Number of Observations: 220
## Number of Groups: 50
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 拉普拉斯近似}
\NormalTok{fit\_glmer }\OtherTok{\textless{}{-}}\NormalTok{ lme4}\SpecialCharTok{::}\FunctionTok{glmer}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ trt }\SpecialCharTok{+} \FunctionTok{I}\NormalTok{(week }\SpecialCharTok{\textgreater{}} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{|}\NormalTok{ ID),}
  \AttributeTok{family =}\NormalTok{ binomial, }\AttributeTok{data =}\NormalTok{ bacteria}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_glmer)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Generalized linear mixed model fit by maximum likelihood (Laplace
##   Approximation) [glmerMod]
##  Family: binomial  ( logit )
## Formula: y ~ trt + I(week > 2) + (1 | ID)
##    Data: bacteria
## 
##      AIC      BIC   logLik deviance df.resid 
##    202.3    219.2    -96.1    192.3      215 
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -4.5615  0.1359  0.3022  0.4217  1.1276 
## 
## Random effects:
##  Groups Name        Variance Std.Dev.
##  ID     (Intercept) 1.543    1.242   
## Number of obs: 220, groups:  ID, 50
## 
## Fixed effects:
##                 Estimate Std. Error z value Pr(>|z|)    
## (Intercept)       3.5479     0.6958   5.099 3.41e-07 ***
## trtdrug          -1.3667     0.6770  -2.019 0.043516 *  
## trtdrug+         -0.7826     0.6831  -1.146 0.251926    
## I(week > 2)TRUE  -1.5985     0.4759  -3.359 0.000783 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) trtdrg trtdr+
## trtdrug     -0.593              
## trtdrug+    -0.537  0.487       
## I(wk>2)TRUE -0.656  0.126  0.064
\end{verbatim}

\hypertarget{sec-birthwt}{%
\section{研究婴儿出生体重低的相关危险因素}\label{sec-birthwt}}

在线性回归的基础上，响应变量是离散的类别，且无序 \citep{mnlogit_2016_JSS}

birthwt 数据是 1986 年在马萨诸塞州斯普林菲尔德的 Baystate 医疗中心收集的，用于研究婴儿出生体重低的相关危险因素

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载数据}
\CommentTok{\# library(MASS)}
\FunctionTok{data}\NormalTok{(birthwt, }\AttributeTok{package =} \StringTok{"MASS"}\NormalTok{)}
\CommentTok{\# 查看 birthwt 数据集 \textasciigrave{}help(birthwt)\textasciigrave{}}
\FunctionTok{head}\NormalTok{(birthwt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    low age lwt race smoke ptl ht ui ftv  bwt
## 85   0  19 182    2     0   0  0  1   0 2523
## 86   0  33 155    3     0   0  0  0   3 2551
## 87   0  20 105    1     1   0  0  0   1 2557
## 88   0  21 108    1     1   0  0  1   2 2594
## 89   0  18 107    1     1   0  0  1   0 2600
## 91   0  21 124    3     0   0  0  0   0 2622
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(birthwt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    189 obs. of  10 variables:
##  $ low  : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ age  : int  19 33 20 21 18 21 22 17 29 26 ...
##  $ lwt  : int  182 155 105 108 107 124 118 103 123 113 ...
##  $ race : int  2 3 1 1 1 3 1 3 1 1 ...
##  $ smoke: int  0 0 1 1 1 0 0 0 1 1 ...
##  $ ptl  : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ ht   : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ ui   : int  1 0 0 1 1 0 0 0 0 0 ...
##  $ ftv  : int  0 3 1 2 0 0 1 1 1 0 ...
##  $ bwt  : int  2523 2551 2557 2594 2600 2622 2637 2637 2663 2665 ...
\end{verbatim}

\texttt{low} 表示婴儿出生体重小于 2.5kg，\texttt{age} 表示母亲的年龄（年），\texttt{lwt} 母亲最后一次月经期间的体重(磅)，\texttt{race} 母亲的种族(1 =白人，2 =黑人，3 =其他)。，\texttt{smoke} 怀孕期间的吸烟状况，\texttt{ptl} 以前早产的次数，\texttt{ht} 高血压病史，\texttt{ui} 子宫过敏，\texttt{ftv} 妊娠头三个月的医生就诊次数，\texttt{bwt} 出生体重（克）

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(birthwt, }\FunctionTok{tapply}\NormalTok{(lwt, ui, var))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        0        1 
## 940.8472 783.7196
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t.test}\NormalTok{(lwt }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ui, }\AttributeTok{data =}\NormalTok{ birthwt, }\AttributeTok{var.equal =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Two Sample t-test
## 
## data:  lwt by ui
## t = 2.1138, df = 187, p-value = 0.03586
## alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
## 95 percent confidence interval:
##   0.8753389 25.3544748
## sample estimates:
## mean in group 0 mean in group 1 
##        131.7578        118.6429
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t.test}\NormalTok{(lwt }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ui, }\AttributeTok{data =}\NormalTok{ birthwt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  lwt by ui
## t = 2.2547, df = 39.163, p-value = 0.02982
## alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
## 95 percent confidence interval:
##   1.351128 24.878685
## sample estimates:
## mean in group 0 mean in group 1 
##        131.7578        118.6429
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# birthwt$ui \textless{}{-} as.factor(birthwt$ui)}
\CommentTok{\# library(lattice)}
\CommentTok{\# bwplot(lwt \textasciitilde{} ui, data = birthwt, pch = "|")}

\FunctionTok{boxplot}\NormalTok{(lwt }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ui, }\AttributeTok{data =}\NormalTok{ birthwt)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{generalized-linear-models_files/figure-latex/unnamed-chunk-11-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 重新编码，数据预处理，方便代入模型}
\NormalTok{bwt }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(birthwt, \{}
\NormalTok{  race }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(race, }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"black"}\NormalTok{, }\StringTok{"other"}\NormalTok{))}
\NormalTok{  ptd }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(ptl }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{  ftv }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(ftv)}
  \FunctionTok{levels}\NormalTok{(ftv)[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{)] }\OtherTok{\textless{}{-}} \StringTok{"2+"} \CommentTok{\# 除了前两个水平外，其余的都编码为 2+}
  \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{low =} \FunctionTok{factor}\NormalTok{(low), age, lwt, race, }\AttributeTok{smoke =}\NormalTok{ (smoke }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{),}
\NormalTok{    ptd, }\AttributeTok{ht =}\NormalTok{ (ht }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{), }\AttributeTok{ui =}\NormalTok{ (ui }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{), ftv}
\NormalTok{  )}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看编码后的数据}
\FunctionTok{head}\NormalTok{(bwt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   low age lwt  race smoke   ptd    ht    ui ftv
## 1   0  19 182 black FALSE FALSE FALSE  TRUE   0
## 2   0  33 155 other FALSE FALSE FALSE FALSE  2+
## 3   0  20 105 white  TRUE FALSE FALSE FALSE   1
## 4   0  21 108 white  TRUE FALSE FALSE  TRUE  2+
## 5   0  18 107 white  TRUE FALSE FALSE  TRUE   0
## 6   0  21 124 other FALSE FALSE FALSE FALSE   0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(bwt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    189 obs. of  9 variables:
##  $ low  : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
##  $ age  : int  19 33 20 21 18 21 22 17 29 26 ...
##  $ lwt  : int  182 155 105 108 107 124 118 103 123 113 ...
##  $ race : Factor w/ 3 levels "white","black",..: 2 3 1 1 1 3 1 3 1 1 ...
##  $ smoke: logi  FALSE FALSE TRUE TRUE TRUE FALSE ...
##  $ ptd  : Factor w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
##  $ ht   : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...
##  $ ui   : logi  TRUE FALSE FALSE TRUE TRUE FALSE ...
##  $ ftv  : Factor w/ 3 levels "0","1","2+": 1 3 2 3 1 1 2 2 2 1 ...
\end{verbatim}

广义线性模型拟合，二项逻辑回归，响应变量为婴儿出生的体重，以2.5kg为界，它被编码成二分类变量 0或1

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{options}\NormalTok{(}\AttributeTok{contrasts =} \FunctionTok{c}\NormalTok{(}\StringTok{"contr.treatment"}\NormalTok{, }\StringTok{"contr.poly"}\NormalTok{))}
\FunctionTok{glm}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ low }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{family =}\NormalTok{ binomial, }\AttributeTok{data =}\NormalTok{ bwt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:  glm(formula = low ~ ., family = binomial, data = bwt)
## 
## Coefficients:
## (Intercept)          age          lwt    raceblack    raceother    smokeTRUE  
##     0.82302     -0.03723     -0.01565      1.19241      0.74068      0.75553  
##     ptdTRUE       htTRUE       uiTRUE         ftv1        ftv2+  
##     1.34376      1.91317      0.68020     -0.43638      0.17901  
## 
## Degrees of Freedom: 188 Total (i.e. Null);  178 Residual
## Null Deviance:       234.7 
## Residual Deviance: 195.5     AIC: 217.5
\end{verbatim}

多项逻辑回归

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(nnet)}
\NormalTok{(bwt.mu }\OtherTok{\textless{}{-}} \FunctionTok{multinom}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ low }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ bwt))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # weights:  12 (11 variable)
## initial  value 131.004817 
## iter  10 value 98.029803
## final  value 97.737759 
## converged
\end{verbatim}

\begin{verbatim}
## Call:
## multinom(formula = low ~ ., data = bwt)
## 
## Coefficients:
## (Intercept)         age         lwt   raceblack   raceother   smokeTRUE 
##  0.82320102 -0.03723828 -0.01565359  1.19240391  0.74065606  0.75550487 
##     ptdTRUE      htTRUE      uiTRUE        ftv1       ftv2+ 
##  1.34375901  1.91320116  0.68020207 -0.43638470  0.17900392 
## 
## Residual Deviance: 195.4755 
## AIC: 217.4755
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(bwt.mu)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## multinom(formula = low ~ ., data = bwt)
## 
## Coefficients:
##                  Values  Std. Err.
## (Intercept)  0.82320102 1.24476766
## age         -0.03723828 0.03870437
## lwt         -0.01565359 0.00708079
## raceblack    1.19240391 0.53598076
## raceother    0.74065606 0.46176615
## smokeTRUE    0.75550487 0.42503626
## ptdTRUE      1.34375901 0.48063449
## htTRUE       1.91320116 0.72076133
## uiTRUE       0.68020207 0.46434974
## ftv1        -0.43638470 0.47941107
## ftv2+        0.17900392 0.45639129
## 
## Residual Deviance: 195.4755 
## AIC: 217.4755
\end{verbatim}

计算 Z 分数和 P 值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(bwt.mu)}\SpecialCharTok{$}\NormalTok{coefficients }\SpecialCharTok{/} \FunctionTok{summary}\NormalTok{(bwt.mu)}\SpecialCharTok{$}\NormalTok{standard.errors}
\NormalTok{z}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (Intercept)         age         lwt   raceblack   raceother   smokeTRUE 
##   0.6613291  -0.9621210  -2.2107121   2.2247140   1.6039635   1.7775069 
##     ptdTRUE      htTRUE      uiTRUE        ftv1       ftv2+ 
##   2.7958023   2.6544170   1.4648486  -0.9102516   0.3922159
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{pnorm}\NormalTok{(}\FunctionTok{abs}\NormalTok{(z), }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)) }\SpecialCharTok{*} \DecValTok{2}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (Intercept)         age         lwt   raceblack   raceother   smokeTRUE 
## 0.508401310 0.335988847 0.027055777 0.026100443 0.108722092 0.075484881 
##     ptdTRUE      htTRUE      uiTRUE        ftv1       ftv2+ 
## 0.005177106 0.007944557 0.142962228 0.362689827 0.694898695
\end{verbatim}

\begin{quote}
模型解释
\end{quote}

\hypertarget{sec-housing}{%
\section{哥本哈根住房状况调查}\label{sec-housing}}

响应变量是离散类别，且存在强弱，等级，大小之分

调用函数 \texttt{MASS::polr()}

数据集 housing 哥本哈根住房状况调查中的次数分布表，\texttt{Sat} 住户对目前居住环境的满意程度，是一个有序的因子变量，\texttt{Infl} 住户对物业管理的感知影响程度，\texttt{Type} 租赁住宿类型，如塔楼、中庭、公寓、露台，\texttt{Cont} 联系居民可与其他居民联系(低、高)，\texttt{Freq} 每个类中的居民人数，调查的人数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"housing"}\NormalTok{, }\AttributeTok{package =} \StringTok{"MASS"}\NormalTok{)}
\CommentTok{\# 查看数据 help(housing)}
\FunctionTok{head}\NormalTok{(housing)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Sat   Infl  Type Cont Freq
## 1    Low    Low Tower  Low   21
## 2 Medium    Low Tower  Low   21
## 3   High    Low Tower  Low   28
## 4    Low Medium Tower  Low   34
## 5 Medium Medium Tower  Low   22
## 6   High Medium Tower  Low   36
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(housing)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    72 obs. of  5 variables:
##  $ Sat : Ord.factor w/ 3 levels "Low"<"Medium"<..: 1 2 3 1 2 3 1 2 3 1 ...
##  $ Infl: Factor w/ 3 levels "Low","Medium",..: 1 1 1 2 2 2 3 3 3 1 ...
##  $ Type: Factor w/ 4 levels "Tower","Apartment",..: 1 1 1 1 1 1 1 1 1 2 ...
##  $ Cont: Factor w/ 2 levels "Low","High": 1 1 1 1 1 1 1 1 1 1 ...
##  $ Freq: int  21 21 28 34 22 36 10 11 36 61 ...
\end{verbatim}

居民对居住环境满意度 Sat 三个等级的有序回归

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{options}\NormalTok{(}\AttributeTok{contrasts =} \FunctionTok{c}\NormalTok{(}\StringTok{"contr.treatment"}\NormalTok{, }\StringTok{"contr.poly"}\NormalTok{))}
\NormalTok{house.plr }\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{polr}\NormalTok{(Sat }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Infl }\SpecialCharTok{+}\NormalTok{ Type }\SpecialCharTok{+}\NormalTok{ Cont, }\AttributeTok{weights =}\NormalTok{ Freq, }\AttributeTok{data =}\NormalTok{ housing)}
\NormalTok{house.plr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## MASS::polr(formula = Sat ~ Infl + Type + Cont, data = housing, 
##     weights = Freq)
## 
## Coefficients:
##    InflMedium      InflHigh TypeApartment    TypeAtrium   TypeTerrace 
##     0.5663937     1.2888191    -0.5723501    -0.3661866    -1.0910149 
##      ContHigh 
##     0.3602841 
## 
## Intercepts:
##  Low|Medium Medium|High 
##  -0.4961353   0.6907083 
## 
## Residual Deviance: 3479.149 
## AIC: 3495.149
\end{verbatim}

再计算一下 P 值，置信区间

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ctable }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(house.plr))}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{pnorm}\NormalTok{(}\FunctionTok{abs}\NormalTok{(ctable[, }\StringTok{"t value"}\NormalTok{]), }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{*} \DecValTok{2}
\NormalTok{ctable }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(ctable, }\StringTok{"p value"} \OtherTok{=}\NormalTok{ p)}
\CommentTok{\# confidence intervals 计算置信区间}
\NormalTok{ci }\OtherTok{\textless{}{-}} \FunctionTok{confint}\NormalTok{(house.plr)}
\FunctionTok{exp}\NormalTok{(}\FunctionTok{coef}\NormalTok{(house.plr))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    InflMedium      InflHigh TypeApartment    TypeAtrium   TypeTerrace 
##     1.7619017     3.6284990     0.5641979     0.6933734     0.3358754 
##      ContHigh 
##     1.4337368
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# OR and CI}
\FunctionTok{exp}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\AttributeTok{OR =} \FunctionTok{coef}\NormalTok{(house.plr), ci))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                      OR     2.5 %    97.5 %
## InflMedium    1.7619017 1.4356845 2.1639915
## InflHigh      3.6284990 2.8319659 4.6626461
## TypeApartment 0.5641979 0.4462124 0.7121941
## TypeAtrium    0.6933734 0.5114084 0.9398410
## TypeTerrace   0.3358754 0.2492277 0.4514276
## ContHigh      1.4337368 1.1892931 1.7296674
\end{verbatim}

\begin{quote}
模型解释
\end{quote}

参考文档 \texttt{help(housing)} 包含泊松回归、多项回归、比例风险模型，以及 \url{https://www.analyticsvidhya.com/blog/2016/02/multinomial-ordinal-logistic-regression/}

\begin{quote}
好好看文档 \texttt{help(housing)} 和对应的参考书籍，把原理弄清楚
\end{quote}

\begin{quote}
有序因子变量是如何实现编码的
\end{quote}

\hypertarget{sec-epileptics-counts}{%
\section{癫痫病发作次数}\label{sec-epileptics-counts}}

纵向数据 \citep{Peter_1990_epil}，考虑了过度发散 overdispersion 异方差 heteroscedasticity 观测不独立

数据集 epil 记录癫痫发作的次数及病人的特征，下面是数据建模分析过程

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(epil, }\AttributeTok{package =} \StringTok{"MASS"}\NormalTok{)}
\NormalTok{fit\_glm\_epil }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ lbase }\SpecialCharTok{*}\NormalTok{ trt }\SpecialCharTok{+}\NormalTok{ lage }\SpecialCharTok{+}\NormalTok{ V4,}
  \AttributeTok{family =}\NormalTok{ poisson,}
  \AttributeTok{data =}\NormalTok{ epil}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_glm\_epil)}

\NormalTok{fit\_glmm\_epil}\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{glmmPQL}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ lbase }\SpecialCharTok{*}\NormalTok{ trt }\SpecialCharTok{+}\NormalTok{ lage }\SpecialCharTok{+}\NormalTok{ V4,}
  \AttributeTok{random =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ subject,}
  \AttributeTok{family =}\NormalTok{ poisson, }\AttributeTok{data =}\NormalTok{ epil}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_glmm\_epil)}

\NormalTok{fit\_glmm\_lme4 }\OtherTok{\textless{}{-}}\NormalTok{ lme4}\SpecialCharTok{::}\FunctionTok{glmer}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ lbase }\SpecialCharTok{*}\NormalTok{ trt }\SpecialCharTok{+}\NormalTok{ lage }\SpecialCharTok{+}\NormalTok{ V4 }\SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{|}\NormalTok{ subject),}
  \AttributeTok{family =}\NormalTok{ poisson, }\AttributeTok{data =}\NormalTok{ epil}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_glmm\_lme4)}


\NormalTok{fit\_glmm\_glmmtmb }\OtherTok{\textless{}{-}}\NormalTok{ glmmTMB}\SpecialCharTok{::}\FunctionTok{glmmTMB}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ lbase }\SpecialCharTok{*}\NormalTok{ trt }\SpecialCharTok{+}\NormalTok{ lage }\SpecialCharTok{+}\NormalTok{ V4 }\SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{|}\NormalTok{ subject),}
  \AttributeTok{data =}\NormalTok{ epil, }\AttributeTok{family =}\NormalTok{ poisson, }\AttributeTok{REML =} \ConstantTok{TRUE}
\NormalTok{) }\CommentTok{\# REML 估计}
\FunctionTok{summary}\NormalTok{(fit\_glmm\_glmmtmb)}


\CommentTok{\# https://github.com/drizopoulos/GLMMadaptive}
\NormalTok{fit\_glmm\_glmmadaptive }\OtherTok{\textless{}{-}}\NormalTok{ GLMMadaptive}\SpecialCharTok{::}\FunctionTok{mixed\_model}\NormalTok{(}
  \AttributeTok{fixed =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ lbase }\SpecialCharTok{*}\NormalTok{ trt }\SpecialCharTok{+}\NormalTok{ lage }\SpecialCharTok{+}\NormalTok{ V4,}
  \AttributeTok{random =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ subject, }\AttributeTok{data =}\NormalTok{ epil,}
  \AttributeTok{family =} \FunctionTok{poisson}\NormalTok{()}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_glmm\_glmmadaptive)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-generalized-log-linear-model}{%
\section{对数线性模型}\label{sec-generalized-log-linear-model}}

当响应变量 \(Y\) 服从对数正态分布的时候，广义线性模型具化为对数线性模型，\textbf{gllm} 包 \citep{gllm}

\hypertarget{sec-generalized-possion-linear-model}{%
\section{泊松回归模型}\label{sec-generalized-possion-linear-model}}

加载数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(beall.webworms, }\AttributeTok{package =} \StringTok{"agridat"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

查看数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(beall.webworms)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   row col y block trt spray lead
## 1   1   1 1    B1  T1     N    N
## 2   2   1 0    B1  T1     N    N
## 3   3   1 1    B1  T1     N    N
## 4   4   1 3    B1  T1     N    N
## 5   5   1 6    B1  T1     N    N
## 6   6   1 0    B2  T1     N    N
\end{verbatim}

描述响应变量的分布

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(beall.webworms}\SpecialCharTok{$}\NormalTok{y, }\AttributeTok{main =} \StringTok{"Histogram of Worm Count"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Number of Worms"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{generalized-linear-models_files/figure-latex/unnamed-chunk-22-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ trt, }\AttributeTok{data =}\NormalTok{ beall.webworms)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{generalized-linear-models_files/figure-latex/unnamed-chunk-23-1} \end{center}

抖动图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ trt, }\AttributeTok{data =}\NormalTok{ beall.webworms, }\AttributeTok{xlab =} \StringTok{"Types of Worms"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Worm Count"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{generalized-linear-models_files/figure-latex/unnamed-chunk-24-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(beall.webworms, }\FunctionTok{aes}\NormalTok{(trt, y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{colour =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Types of Worms"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Worm Count"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{generalized-linear-models_files/figure-latex/unnamed-chunk-25-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pois.mod }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ trt, }\AttributeTok{data =}\NormalTok{ beall.webworms, }\AttributeTok{family =} \StringTok{"poisson"}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(pois.mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = y ~ trt, family = "poisson", data = beall.webworms)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.6733  -1.0046  -0.9081   0.6141   4.2771  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  0.33647    0.04688   7.177 7.12e-13 ***
## trtT2       -1.02043    0.09108 -11.204  < 2e-16 ***
## trtT3       -0.49628    0.07621  -6.512 7.41e-11 ***
## trtT4       -1.22246    0.09829 -12.438  < 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 1955.9  on 1299  degrees of freedom
## Residual deviance: 1720.4  on 1296  degrees of freedom
## AIC: 3125.5
## 
## Number of Fisher Scoring iterations: 6
\end{verbatim}

模型系数 T2 的解释，这里 GLM 使用了对数联系函数(log link function) ，因此 -1.02 是对数变换后的值，T2的系数实际是 0.3605949 ，实际意义是相对于T1，T2 类型的蠕虫数量是 T1 的 0.3605949 倍

The first valuable information is related to the residuals of the model, which should be symmetrical as for any normal linear model. From this output we can see that minimum and maximum, as well as the first and third quartiles, are similar, so this assumption is confirmed. Then we can see that the variable trt (i.e.~treatment factor) is highly significant for the model, with very low p-values. The statistical test in this case is not a t-test, as in the output of the function lm, but a Wald Test (\href{http://www.blackwellpublishing.com/specialarticles/jcn_10_774.pdf}{Wald Test}). This test computes the probability that the coefficient is 0, if the p is significant it means the chances the coefficient is zero are very low so the variable should be included in the model since it has an effect on y.

Another important information is the deviance, particularly the residual deviance. As a general rule, this value should be lower or in line than the residuals degrees of freedom for the model to be good. In this case the fact that the residual deviance is high (even though not dramatically) may suggests the explanatory power of the model is low. We will see below how to obtain p-value for the significance of the model.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(pois.mod)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{generalized-linear-models_files/figure-latex/unnamed-chunk-27-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{predict}\NormalTok{(pois.mod, }\AttributeTok{newdata =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{trt =} \FunctionTok{c}\NormalTok{(}\StringTok{"T1"}\NormalTok{, }\StringTok{"T2"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          1          2 
##  0.3364722 -0.6839588
\end{verbatim}

模型的P值

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{pchisq}\NormalTok{(}\FunctionTok{deviance}\NormalTok{(pois.mod), }\FunctionTok{df.residual}\NormalTok{(pois.mod))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.709743e-14
\end{verbatim}

模型选择

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pois.mod2 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ block }\SpecialCharTok{+}\NormalTok{ spray }\SpecialCharTok{*}\NormalTok{ lead, }\AttributeTok{data =}\NormalTok{ beall.webworms, }\AttributeTok{family =} \StringTok{"poisson"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

两模型的 AIC 比较

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{AIC}\NormalTok{(pois.mod, pois.mod2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           df      AIC
## pois.mod   4 3125.478
## pois.mod2 16 3027.438
\end{verbatim}

假设响应变量 Y 服从泊松分布，意味着随机变量 Y 的期望和方差相等

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(beall.webworms}\SpecialCharTok{$}\NormalTok{y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.7923077
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{var}\NormalTok{(beall.webworms}\SpecialCharTok{$}\NormalTok{y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.290164
\end{verbatim}

实际上方差比均值大，这种情况称之为过度发散 (overdispersed)，分布应该修正为拟（似然）泊松分布

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pois.mod3 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ trt, }\AttributeTok{data =}\NormalTok{ beall.webworms, }\AttributeTok{family =} \FunctionTok{c}\NormalTok{(}\StringTok{"quasipoisson"}\NormalTok{))}
\FunctionTok{summary}\NormalTok{(pois.mod3)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = y ~ trt, family = c("quasipoisson"), data = beall.webworms)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.6733  -1.0046  -0.9081   0.6141   4.2771  
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept)  0.33647    0.05457   6.166 9.32e-10 ***
## trtT2       -1.02043    0.10601  -9.626  < 2e-16 ***
## trtT3       -0.49628    0.08870  -5.595 2.69e-08 ***
## trtT4       -1.22246    0.11440 -10.686  < 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for quasipoisson family taken to be 1.35472)
## 
##     Null deviance: 1955.9  on 1299  degrees of freedom
## Residual deviance: 1720.4  on 1296  degrees of freedom
## AIC: NA
## 
## Number of Fisher Scoring iterations: 6
\end{verbatim}

计算得知发散参数(dispersion parameter) 是 1.35472，可见数据Y并不是发散得离谱，泊松分布可能仍然是对这个数据的合理假设

AER 包是书籍 Applied Econometrics with R 的配套材料 \citep{AER_2008_Kleiber}，可用于直接检验发散参数是否大于1

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# AER::dispersiontest(pois.mod, alternative="greater")}
\end{Highlighting}
\end{Shaded}

如果数据真的过度离散，就应该使用负二项分布作为响应变量的拟合分布，拟合它就采用 MASS 包 \citep{MASS_2002_Venables} 提供的 \texttt{glm.nb}函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{NB.mod1 }\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{glm.nb}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ trt, }\AttributeTok{data =}\NormalTok{ beall.webworms)}
\FunctionTok{summary}\NormalTok{(NB.mod1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## MASS::glm.nb(formula = y ~ trt, data = beall.webworms, init.theta = 2.004130573, 
##     link = log)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.4572  -0.9488  -0.8660   0.5340   2.7698  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  0.33647    0.06110   5.507 3.65e-08 ***
## trtT2       -1.02043    0.10661  -9.572  < 2e-16 ***
## trtT3       -0.49628    0.09423  -5.267 1.39e-07 ***
## trtT4       -1.22246    0.11283 -10.834  < 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for Negative Binomial(2.0041) family taken to be 1)
## 
##     Null deviance: 1442.7  on 1299  degrees of freedom
## Residual deviance: 1275.3  on 1296  degrees of freedom
## AIC: 3053
## 
## Number of Fisher Scoring iterations: 1
## 
## 
##               Theta:  2.004 
##           Std. Err.:  0.325 
## 
##  2 x log-likelihood:  -3042.969
\end{verbatim}

两个模型的方差分析

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(pois.mod, pois.mod2, }\AttributeTok{test =} \StringTok{"Chisq"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Deviance Table
## 
## Model 1: y ~ trt
## Model 2: y ~ block + spray * lead
##   Resid. Df Resid. Dev Df Deviance  Pr(>Chi)    
## 1      1296     1720.4                          
## 2      1284     1598.4 12   122.04 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

从方差分析比较的结果来看，P值告诉我们，两模型是显著不同的，由上面对两模型的 AIC 计算结果来看，模型 pois.mod2 比模型 pois.mod 要好，模型的 AIC 值越小，表明拟合得越准确。

\hypertarget{chap-bayesian-models}{%
\chapter{贝叶斯模型}\label{chap-bayesian-models}}

\href{https://github.com/LaplacesDemonR/LaplacesDemon}{LaplacesDemon} 支持常见模型的贝叶斯推断，具体可见\href{https://CRAN.R-project.org/package=LaplacesDemon}{网站} \citep{LaplacesDemon2021}，\href{https://github.com/stan-dev/shinystan}{shinystan} 借助 \href{https://github.com/stan-dev/rstan}{rstan} 打包了一些 stan 编写的统计模型，提供模型评估的功能。相比于 \href{https://github.com/stan-dev/rstan}{rstan}，\href{https://github.com/paul-buerkner/brms}{brms} 支持了更加广泛的模型，\href{https://github.com/fweber144/shinybrms}{shinybrms} 类似 \href{https://github.com/stan-dev/shinystan}{shinystan} 提供可视化的 shiny 前端，方便用户调用模型和评估效果。\href{https://github.com/stan-dev/rstanarm}{rstanarm} 基于 stan 语言重写了 \href{https://github.com/suyusung/arm}{arm} 里的模型，和 \href{https://github.com/paul-buerkner/brms}{brms} 一样，提供类似 \href{https://github.com/lme4/lme4}{lme4} 的公式语法，和 Base R 内置的函数 \texttt{lm()} 和 \texttt{glm()} 保持一致，降低用户学习成本。

\href{https://github.com/stan-dev/cmdstanr}{cmdstanr} 相比于 rstan 将会更加轻量，更快地将 CmdStan 的新功能融入进来，方便用户滚动升级，相比于 \textbf{rstan} 包，\textbf{cmdstanr} 包的一个巨大优势是和 Stan 软件的更新分离。做贝叶斯计算的软件框架还包括 JAGS 和 WinBUGS，苏毓松开发的 R2jags 包 \citep{R2jags} 是 JAGS 的 R 接口。

\href{https://github.com/kaskr/adcomp}{TMB}

\begin{itemize}
\item
  书籍： \href{https://xcelab.net/rm/}{Richard McElreath} 为《Statistical Rethinking》写的 \href{https://github.com/rmcelreath/rethinking}{rethinking} 包，参考 Derek S. Young \citep{Regression_2017_Young} 和 Michael H. Kutner 等 \citep{Kutner_2005_Applied}
\item
  论文： An Introduction to Inductive Statistical Inference: from Parameter Estimation to Decision-Making \url{https://arxiv.org/abs/1808.10173v2} 固定效应/随机效应广义线性模型：多水平各种模型回归，模型结构和 Stan 代码
\item
  课程： 线性模型的内容主要分为四大块，分别是线性回归模型、方差分析模型、协方差分析模型和线性混合效应模型。国外 David Pollard 的线性模型 \href{http://www.stat.yale.edu/~pollard/Courses/312.fall2016/}{课程内容}
\item
  会议： Paul-Christian Bürkner 在 Stan 大会上介绍 brms 和 rstanarm \url{https://github.com/InsuranceDataScience/StanWorkshop2018}
\end{itemize}

\hypertarget{sec-stan-setup}{%
\section{软件配置}\label{sec-stan-setup}}

从 GitHub 下载最新版的源码包 \url{https://github.com/stan-dev/cmdstan/releases/latest}，编译二进制版本

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tar} \AttributeTok{{-}xzf}\NormalTok{ /Users/xiangyun/Desktop/cmdstan{-}2.26.0.tar.gz }\AttributeTok{{-}C}\NormalTok{ /opt/}
\BuiltInTok{cd}\NormalTok{ cmdstan{-}2.26.0}
\FunctionTok{make}\NormalTok{ build}
\end{Highlighting}
\end{Shaded}

设置环境变量 CMDSTAN 指向 CmdStan 安装路径，加载 \textbf{cmdstanr} 包会自动检测和加载

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{CMDSTAN=}\StringTok{"/opt/cmdstan{-}2.26.0"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

还可以设置环境变量 \texttt{CMDSTANR\_NO\_VER\_CHECK=TRUE}，让 cmdstanr 不要检查 CmdStan 版本状态，是不是最新版，比如本书将固定下 CmdStan 版本为 2.26.0

\textbf{cmdstanr} 当前还在开发中，安装方式如下

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{remotes}\SpecialCharTok{::}\FunctionTok{install\_github}\NormalTok{(}\StringTok{\textquotesingle{}stan{-}dev/cmdstanr\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 或者}
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"cmdstanr"}\NormalTok{, }\AttributeTok{repos =} \FunctionTok{c}\NormalTok{(}\StringTok{"https://mc{-}stan.org/r{-}packages/"}\NormalTok{, }\FunctionTok{getOption}\NormalTok{(}\StringTok{"repos"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

另有一篇博文介绍在 \href{https://www.maxmantei.com/blog/2020-05-16-installing-cmdstanr-on-windows/cmdstanr-windows/}{Windows 系统上安装 cmdstanr} 的过程，这里不做展开。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# rstan}
\CommentTok{\# brms}
\CommentTok{\# rstanarm}
\NormalTok{remotes}\SpecialCharTok{::}\FunctionTok{install\_github}\NormalTok{(}\StringTok{\textquotesingle{}rmcelreath/rethinking\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-bayesian-normal-distribution}{%
\section{正态分布}\label{sec-bayesian-normal-distribution}}

我们以估计正态分布参数为例说明贝叶斯估计方法

\[Y \sim \mathcal{N}(\mu,\sigma^2)\] 已知 \(y_1,y_2,\ldots,y_n\) 是来自正态总体 \(\mathcal{N}(\mu,\sigma^2)\) 的一个样本，我们需要估计这个正态分布模型的参数 \(\mu\) 和 \(\sigma^2\)。

最大似然估计，简单推导过程，计算代码；再讲 stan 的计算步骤

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(cmdstanr)}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{cmdstan\_model}\NormalTok{(}\AttributeTok{stan\_file =} \StringTok{"code/normal\_dist.stan"}\NormalTok{, }\AttributeTok{compile =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

打包观测数据，初始化待估参数值，指定链条数，其中 \texttt{dataList} 必须与 stan 代码中数据块声明保持一致（如变量名称，长度），每条链使用不同的初始值，选择合适的初始值可以有效地提高收敛的速度。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据准备}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{20190427}\NormalTok{)}
\CommentTok{\# 设置参数}
\NormalTok{mu }\OtherTok{\textless{}{-}} \DecValTok{10}
\NormalTok{sd }\OtherTok{\textless{}{-}} \DecValTok{2}
\CommentTok{\# 样本量}
\NormalTok{nobs }\OtherTok{\textless{}{-}} \DecValTok{500}
\NormalTok{nchains }\OtherTok{\textless{}{-}} \DecValTok{4}
\CommentTok{\# 生成随机数}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\AttributeTok{n =}\NormalTok{ nobs, }\AttributeTok{mean =}\NormalTok{ mu, }\AttributeTok{sd =}\NormalTok{ sd)}
\CommentTok{\# 给每条链设置不同的参数初始值}
\NormalTok{inits\_data }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nchains, }\ControlFlowTok{function}\NormalTok{(i) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{mu =} \FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{min}\NormalTok{(y), }\FunctionTok{max}\NormalTok{(y)),}
    \AttributeTok{sigma =} \FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

将参数初值代入模型，抽样，获取参数的后验分布

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{normal\_fit }\OtherTok{\textless{}{-}}\NormalTok{ mod}\SpecialCharTok{$}\FunctionTok{sample}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{N =}\NormalTok{ nobs,}
    \AttributeTok{y =}\NormalTok{ y}
\NormalTok{  ),}
  \AttributeTok{init =}\NormalTok{ inits\_data,}
  \AttributeTok{iter\_warmup =} \DecValTok{1000}\NormalTok{, }\CommentTok{\# 每条链预处理迭代次数}
  \AttributeTok{iter\_sampling =} \DecValTok{2000}\NormalTok{, }\CommentTok{\# 每条链总迭代次数}
  \AttributeTok{chains =}\NormalTok{ nchains, }\CommentTok{\# 马尔科夫链的数目}
  \AttributeTok{parallel\_chains =} \DecValTok{1}\NormalTok{, }\CommentTok{\# 指定 CPU 核心数，可以给每条链分配一个}
  \AttributeTok{show\_messages =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 不显示迭代的中间过程}
  \AttributeTok{refresh =} \DecValTok{0}\NormalTok{, }\CommentTok{\# 不显示采样的进度}
  \AttributeTok{seed =} \DecValTok{20190425} \CommentTok{\# 设置随机数种子，不要使用 set.seed() 函数}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Running MCMC with 4 sequential chains...
## 
## Chain 1 finished in 0.1 seconds.
## Chain 2 finished in 0.1 seconds.
## Chain 3 finished in 0.1 seconds.
## Chain 4 finished in 0.1 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 0.1 seconds.
## Total execution time: 0.6 seconds.
\end{verbatim}

检查收敛性，Rhat 决定收敛性，所有待估参数的Rhat必须小于1.1，同时有效样本数量 n\_eff 除以抽样总数 N 必须小于0.001，否则收敛性是值得怀疑的。拟合结果及解释如下：

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 模型参数估计结果}
\NormalTok{normal\_fit}\SpecialCharTok{$}\FunctionTok{cmdstan\_summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Inference for Stan model: normal_dist_model
## 4 chains: each with iter=(2000,2000,2000,2000); warmup=(0,0,0,0); thin=(1,1,1,1); 8000 iterations saved.
## 
## Warmup took (0.014, 0.014, 0.014, 0.014) seconds, 0.056 seconds total
## Sampling took (0.045, 0.042, 0.041, 0.038) seconds, 0.17 seconds total
## 
##                 Mean     MCSE  StdDev    5%   50%  95%    N_Eff  N_Eff/s    R_hat
## 
## lp__            -602  1.7e-02     1.0  -604  -601 -601     3591    21634      1.0
## accept_stat__   0.92  3.3e-03    0.11  0.69  0.96  1.0  1.1e+03  6.4e+03  1.0e+00
## stepsize__      0.88  6.9e-02   0.098  0.73  0.90  1.0  2.0e+00  1.2e+01  1.5e+13
## treedepth__      1.9  1.2e-01    0.56   1.0   2.0  3.0  2.1e+01  1.3e+02  1.1e+00
## n_leapfrog__     3.7  3.7e-01     1.8   1.0   3.0  7.0  2.4e+01  1.4e+02  1.0e+00
## divergent__     0.00      nan    0.00  0.00  0.00 0.00      nan      nan      nan
## energy__         603  2.5e-02     1.4   601   602  605  3.3e+03  2.0e+04  1.0e+00
## 
## mu                10  1.2e-03   0.092   9.9    10   10     5732    34530     1.00
## sigma            2.0  7.7e-04   0.064   1.9   2.0  2.1     6885    41475     1.00
## 
## Samples were drawn using hmc with nuts.
## For each parameter, N_Eff is a crude measure of effective sample size,
## and R_hat is the potential scale reduction factor on split chains (at 
## convergence, R_hat=1).
\end{verbatim}

调用 draws 方法 \texttt{normal\_fit\$draws()}，获得一个由 \textbf{posterior} 构造的 \texttt{draws\_array} 对象，

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{draws\_array }\OtherTok{\textless{}{-}}\NormalTok{ normal\_fit}\SpecialCharTok{$}\FunctionTok{draws}\NormalTok{()}
\FunctionTok{str}\NormalTok{(draws\_array)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  'draws_array' num [1:2000, 1:4, 1:3] -601 -601 -602 -601 -601 ...
##  - attr(*, "dimnames")=List of 3
##   ..$ iteration: chr [1:2000] "1" "2" "3" "4" ...
##   ..$ chain    : chr [1:4] "1" "2" "3" "4"
##   ..$ variable : chr [1:3] "lp__" "mu" "sigma"
\end{verbatim}

采样结果可以直接传递给 \textbf{bayesplot} 包，绘制参数的后验分布和马尔科夫链蒙特卡罗采样的轨迹图（trace plot）。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(bayesplot)}
\FunctionTok{mcmc\_trace}\NormalTok{(normal\_fit}\SpecialCharTok{$}\FunctionTok{draws}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"mu"}\NormalTok{, }\StringTok{"sigma"}\NormalTok{)))}
\FunctionTok{mcmc\_hist}\NormalTok{(normal\_fit}\SpecialCharTok{$}\FunctionTok{draws}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"mu"}\NormalTok{, }\StringTok{"sigma"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[参数的轨迹图\label{fig:mu-sigma-dist-1}]{\includegraphics{bayesian-models_files/figure-latex/mu-sigma-dist-1} }\newline\subfloat[参数的后验分布图\label{fig:mu-sigma-dist-2}]{\includegraphics{bayesian-models_files/figure-latex/mu-sigma-dist-2} }

}

\caption{参数 \(\mu, \sigma\) 的迭代轨迹图和后验分布图}\label{fig:mu-sigma-dist}
\end{figure}



\hypertarget{sec-gaussian-process}{%
\section{高斯过程}\label{sec-gaussian-process}}

模拟高斯过程例子来自 Stan 参考手册 \citep{Stan_2018_Bayesian}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{cmdstan\_model}\NormalTok{(}\AttributeTok{stan\_file =} \StringTok{"code/normal\_gp.stan"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

stan 库内置了核函数为二次幂指数的实现，因此可以直接调用 \texttt{cov\_exp\_quad} 函数计算协方差矩阵

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{cmdstan\_model}\NormalTok{(}\AttributeTok{stan\_file =} \StringTok{"code/compat\_gp.stan"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

以 MASS 的 topo 数据集引出高斯过程回归模型问题复杂性

\hypertarget{sec-hierarchical-normal-models}{%
\section{分层正态模型}\label{sec-hierarchical-normal-models}}

Multilevel Models 多水平模型、Hierarchical Models 层次模型

\hypertarget{sec-eight-schools}{%
\subsection{schools 数据}\label{sec-eight-schools}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 模型编译}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{cmdstan\_model}\NormalTok{(}\AttributeTok{stan\_file =} \StringTok{"code/eight\_schools.stan"}\NormalTok{)}

\CommentTok{\# 模型拟合}
\NormalTok{eight\_schools\_fit }\OtherTok{\textless{}{-}}\NormalTok{ mod}\SpecialCharTok{$}\FunctionTok{sample}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{list}\NormalTok{( }\CommentTok{\# 观测数据}
    \AttributeTok{J =} \DecValTok{8}\NormalTok{,}
    \AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{28}\NormalTok{, }\DecValTok{8}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{7}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{18}\NormalTok{, }\DecValTok{12}\NormalTok{),}
    \AttributeTok{sigma =} \FunctionTok{c}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{16}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{18}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{iter\_warmup =} \DecValTok{1000}\NormalTok{, }\CommentTok{\# 每条链预处理迭代次数}
  \AttributeTok{iter\_sampling =} \DecValTok{2000}\NormalTok{, }\CommentTok{\# 每条链总迭代次数}
  \AttributeTok{chains =} \DecValTok{4}\NormalTok{, }\CommentTok{\# 马尔科夫链的数目}
  \AttributeTok{parallel\_chains =} \DecValTok{1}\NormalTok{, }\CommentTok{\# 指定 CPU 核心数，可以给每条链分配一个}
  \AttributeTok{show\_messages =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 不显示迭代的中间过程}
  \AttributeTok{refresh =} \DecValTok{0}\NormalTok{, }\CommentTok{\# 不显示采样的进度}
  \AttributeTok{seed =} \DecValTok{20190425} \CommentTok{\# 设置随机数种子，不要使用 set.seed() 函数}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Running MCMC with 4 sequential chains...
## 
## Chain 1 finished in 0.1 seconds.
## Chain 2 finished in 0.1 seconds.
## Chain 3 finished in 0.1 seconds.
## Chain 4 finished in 0.1 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 0.1 seconds.
## Total execution time: 0.8 seconds.
\end{verbatim}

模型拟合结果

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eight\_schools\_fit}\SpecialCharTok{$}\FunctionTok{cmdstan\_summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Inference for Stan model: eight_schools_model
## 4 chains: each with iter=(2000,2000,2000,2000); warmup=(0,0,0,0); thin=(1,1,1,1); 8000 iterations saved.
## 
## Warmup took (0.023, 0.026, 0.023, 0.026) seconds, 0.098 seconds total
## Sampling took (0.070, 0.085, 0.084, 0.088) seconds, 0.33 seconds total
## 
##                     Mean     MCSE  StdDev     5%       50%   95%    N_Eff  N_Eff/s    R_hat
## 
## lp__            -4.0e+01  5.4e-02     2.7    -44  -3.9e+01   -36     2447     7484     1.00
## accept_stat__       0.88  1.5e-02    0.20   0.40      0.96   1.0  1.8e+02  5.6e+02  1.0e+00
## stepsize__          0.34  3.2e-02   0.045   0.28      0.33  0.41  2.0e+00  6.1e+00  1.8e+13
## treedepth__          3.5  1.8e-01    0.54    3.0       4.0   4.0  8.4e+00  2.6e+01  1.1e+00
## n_leapfrog__          12  1.3e+00     4.0    7.0        15    15  9.9e+00  3.0e+01  1.1e+00
## divergent__         0.00      nan    0.00   0.00      0.00  0.00      nan      nan      nan
## energy__              45  7.2e-02     3.5     39        44    51  2.4e+03  7.4e+03  1.0e+00
## 
## mu               8.0e+00  8.1e-02     5.0  0.015   7.9e+00    17     3886    11884      1.0
## tau              6.6e+00  1.0e-01     5.6   0.48   5.3e+00    17     3064     9370      1.0
## eta[1]           3.9e-01  1.1e-02    0.95   -1.2   4.2e-01   1.9     7716    23596     1.00
## eta[2]          -4.0e-04  9.5e-03    0.88   -1.4   2.1e-04   1.4     8427    25770     1.00
## eta[3]          -2.0e-01  1.0e-02    0.94   -1.7  -2.0e-01   1.4     8319    25442      1.0
## eta[4]          -3.0e-02  9.7e-03    0.88   -1.5  -2.8e-02   1.4     8220    25138      1.0
## eta[5]          -3.7e-01  1.0e-02    0.88   -1.8  -3.9e-01   1.1     7355    22492      1.0
## eta[6]          -2.2e-01  9.8e-03    0.90   -1.7  -2.5e-01   1.3     8439    25807      1.0
## eta[7]           3.5e-01  1.0e-02    0.88   -1.1   3.7e-01   1.8     7255    22185      1.0
## eta[8]           5.4e-02  1.1e-02    0.93   -1.5   6.6e-02   1.6     7356    22494     1.00
## theta[1]         1.1e+01  1.1e-01     8.4   0.10   1.0e+01    27     5668    17333     1.00
## theta[2]         7.9e+00  6.8e-02     6.4   -2.5   7.9e+00    18     8940    27340      1.0
## theta[3]         6.2e+00  9.3e-02     7.7   -7.5   6.6e+00    18     6961    21287      1.0
## theta[4]         7.7e+00  7.1e-02     6.5   -3.0   7.7e+00    18     8515    26040      1.0
## theta[5]         5.0e+00  7.0e-02     6.4   -6.4   5.5e+00    14     8218    25130      1.0
## theta[6]         6.1e+00  7.3e-02     6.7   -5.7   6.5e+00    16     8504    26005     1.00
## theta[7]         1.1e+01  8.4e-02     6.8   0.92   1.0e+01    23     6537    19990     1.00
## theta[8]         8.5e+00  1.0e-01     7.8   -3.8   8.2e+00    22     5904    18054      1.0
## 
## Samples were drawn using hmc with nuts.
## For each parameter, N_Eff is a crude measure of effective sample size,
## and R_hat is the potential scale reduction factor on split chains (at 
## convergence, R_hat=1).
\end{verbatim}

4 条马尔可夫链，19 个变量，2000 次迭代，轨迹数据如下

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eight\_schools\_fit}\SpecialCharTok{$}\FunctionTok{draws}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A draws_array: 2000 iterations, 4 chains, and 19 variables
## , , variable = lp__
## 
##          chain
## iteration   1   2   3   4
##         1 -42 -39 -38 -40
##         2 -37 -40 -37 -42
##         3 -40 -38 -38 -43
##         4 -39 -39 -40 -43
##         5 -38 -45 -38 -40
## 
## , , variable = mu
## 
##          chain
## iteration    1      2    3    4
##         1  9.0 -3.696  8.9  1.9
##         2  5.9 13.895  1.5 13.5
##         3  6.2  0.013  4.2  1.5
##         4 12.0  2.365 10.6 15.5
##         5  5.8 -7.633  5.2 12.2
## 
## , , variable = tau
## 
##          chain
## iteration    1    2     3     4
##         1 3.20 10.3  7.93  4.11
##         2 9.70  1.9 10.70  0.65
##         3 0.38  6.3  4.31  1.18
##         4 7.19  9.2  0.43 11.03
##         5 4.06  5.6  3.36  8.74
## 
## , , variable = eta[1]
## 
##          chain
## iteration     1     2     3     4
##         1  1.10  1.72  1.23  1.10
##         2 -0.30 -0.98  1.19 -0.74
##         3 -0.31  1.28  0.34 -0.85
##         4  0.97  1.53 -0.86  2.02
##         5  1.04  0.75  1.46  1.24
## 
## # ... with 1995 more iterations, and 15 more variables
\end{verbatim}

提取参数 \(\mu\) 的四条迭代点列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eight\_schools\_fit}\SpecialCharTok{$}\FunctionTok{draws}\NormalTok{(}\StringTok{"mu"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A draws_array: 2000 iterations, 4 chains, and 1 variables
## , , variable = mu
## 
##          chain
## iteration    1      2    3    4
##         1  9.0 -3.696  8.9  1.9
##         2  5.9 13.895  1.5 13.5
##         3  6.2  0.013  4.2  1.5
##         4 12.0  2.365 10.6 15.5
##         5  5.8 -7.633  5.2 12.2
## 
## # ... with 1995 more iterations
\end{verbatim}

\texttt{eight\_schools\_fit} 是一个 R6 对象，包含整个模型信息

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(eight\_schools\_fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "CmdStanMCMC" "CmdStanFit"  "R6"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(eight\_schools\_fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'CmdStanMCMC', 'CmdStanFit', 'R6' <CmdStanMCMC>
##   Inherits from: <CmdStanFit>
##   Public:
##     clone: function (deep = FALSE) 
##     cmdstan_diagnose: function () 
##     cmdstan_summary: function (flags = NULL) 
##     data_file: function () 
##     draws: function (variables = NULL, inc_warmup = FALSE, format = getOption("cmdstanr_draws_format", 
##     init: function () 
##     initialize: function (runset) 
##     inv_metric: function (matrix = TRUE) 
##     latent_dynamics_files: function (include_failed = FALSE) 
##     loo: function (variables = "log_lik", r_eff = TRUE, ...) 
##     lp: function () 
##     metadata: function () 
##     num_chains: function () 
##     num_procs: function () 
##     output: function (id = NULL) 
##     output_files: function (include_failed = FALSE) 
##     print: function (variables = NULL, ..., digits = 2, max_rows = getOption("cmdstanr_max_rows", 
##     profile_files: function (include_failed = FALSE) 
##     profiles: function () 
##     return_codes: function () 
##     runset: CmdStanRun, R6
##     sampler_diagnostics: function (inc_warmup = FALSE, format = getOption("cmdstanr_draws_format", 
##     save_data_file: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
##     save_latent_dynamics_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
##     save_object: function (file, ...) 
##     save_output_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
##     save_profile_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
##     summary: function (variables = NULL, ...) 
##     time: function () 
##   Private:
##     draws_: -42.0125 -37.337 -40.2068 -38.9824 -38.4394 -38.7721 -35 ...
##     init_: NULL
##     inv_metric_: list
##     metadata_: list
##     read_csv_: function (variables = NULL, sampler_diagnostics = NULL, format = getOption("cmdstanr_draws_format", 
##     sampler_diagnostics_: 3 3 4 3 4 3 3 3 3 3 2 3 3 3 3 3 4 3 3 3 3 2 3 3 3 3 3 3  ...
##     warmup_draws_: NULL
##     warmup_sampler_diagnostics_: NULL
\end{verbatim}

模型诊断：查看迭代点列的平稳性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mcmc\_dens}\NormalTok{(eight\_schools\_fit}\SpecialCharTok{$}\FunctionTok{draws}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"mu"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{bayesian-models_files/figure-latex/mu-iteration-1} \end{center}

分层线性模型之生长曲线模型 \citep{Gelfand_1990_JASA}

\hypertarget{subsec-rats}{%
\subsection{rats 数据}\label{subsec-rats}}

贝叶斯分层图

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据准备}
\CommentTok{\# modified code from https://github.com/stan{-}dev/example{-}models/tree/master/bugs\_examples/vol1/rats}
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{30}
\NormalTok{T }\OtherTok{\textless{}{-}} \DecValTok{5}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{structure}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
  \DecValTok{151}\NormalTok{, }\DecValTok{145}\NormalTok{, }\DecValTok{147}\NormalTok{, }\DecValTok{155}\NormalTok{, }\DecValTok{135}\NormalTok{, }\DecValTok{159}\NormalTok{, }\DecValTok{141}\NormalTok{, }\DecValTok{159}\NormalTok{, }\DecValTok{177}\NormalTok{, }\DecValTok{134}\NormalTok{,}
  \DecValTok{160}\NormalTok{, }\DecValTok{143}\NormalTok{, }\DecValTok{154}\NormalTok{, }\DecValTok{171}\NormalTok{, }\DecValTok{163}\NormalTok{, }\DecValTok{160}\NormalTok{, }\DecValTok{142}\NormalTok{, }\DecValTok{156}\NormalTok{, }\DecValTok{157}\NormalTok{, }\DecValTok{152}\NormalTok{, }\DecValTok{154}\NormalTok{, }\DecValTok{139}\NormalTok{, }\DecValTok{146}\NormalTok{,}
  \DecValTok{157}\NormalTok{, }\DecValTok{132}\NormalTok{, }\DecValTok{160}\NormalTok{, }\DecValTok{169}\NormalTok{, }\DecValTok{157}\NormalTok{, }\DecValTok{137}\NormalTok{, }\DecValTok{153}\NormalTok{, }\DecValTok{199}\NormalTok{, }\DecValTok{199}\NormalTok{, }\DecValTok{214}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{188}\NormalTok{, }\DecValTok{210}\NormalTok{,}
  \DecValTok{189}\NormalTok{, }\DecValTok{201}\NormalTok{, }\DecValTok{236}\NormalTok{, }\DecValTok{182}\NormalTok{, }\DecValTok{208}\NormalTok{, }\DecValTok{188}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{221}\NormalTok{, }\DecValTok{216}\NormalTok{, }\DecValTok{207}\NormalTok{, }\DecValTok{187}\NormalTok{, }\DecValTok{203}\NormalTok{, }\DecValTok{212}\NormalTok{,}
  \DecValTok{203}\NormalTok{, }\DecValTok{205}\NormalTok{, }\DecValTok{190}\NormalTok{, }\DecValTok{191}\NormalTok{, }\DecValTok{211}\NormalTok{, }\DecValTok{185}\NormalTok{, }\DecValTok{207}\NormalTok{, }\DecValTok{216}\NormalTok{, }\DecValTok{205}\NormalTok{, }\DecValTok{180}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{246}\NormalTok{, }\DecValTok{249}\NormalTok{,}
  \DecValTok{263}\NormalTok{, }\DecValTok{237}\NormalTok{, }\DecValTok{230}\NormalTok{, }\DecValTok{252}\NormalTok{, }\DecValTok{231}\NormalTok{, }\DecValTok{248}\NormalTok{, }\DecValTok{285}\NormalTok{, }\DecValTok{220}\NormalTok{, }\DecValTok{261}\NormalTok{, }\DecValTok{220}\NormalTok{, }\DecValTok{244}\NormalTok{, }\DecValTok{270}\NormalTok{, }\DecValTok{242}\NormalTok{,}
  \DecValTok{248}\NormalTok{, }\DecValTok{234}\NormalTok{, }\DecValTok{243}\NormalTok{, }\DecValTok{259}\NormalTok{, }\DecValTok{246}\NormalTok{, }\DecValTok{253}\NormalTok{, }\DecValTok{225}\NormalTok{, }\DecValTok{229}\NormalTok{, }\DecValTok{250}\NormalTok{, }\DecValTok{237}\NormalTok{, }\DecValTok{257}\NormalTok{, }\DecValTok{261}\NormalTok{, }\DecValTok{248}\NormalTok{,}
  \DecValTok{219}\NormalTok{, }\DecValTok{244}\NormalTok{, }\DecValTok{283}\NormalTok{, }\DecValTok{293}\NormalTok{, }\DecValTok{312}\NormalTok{, }\DecValTok{272}\NormalTok{, }\DecValTok{280}\NormalTok{, }\DecValTok{298}\NormalTok{, }\DecValTok{275}\NormalTok{, }\DecValTok{297}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{260}\NormalTok{, }\DecValTok{313}\NormalTok{,}
  \DecValTok{273}\NormalTok{, }\DecValTok{289}\NormalTok{, }\DecValTok{326}\NormalTok{, }\DecValTok{281}\NormalTok{, }\DecValTok{288}\NormalTok{, }\DecValTok{280}\NormalTok{, }\DecValTok{283}\NormalTok{, }\DecValTok{307}\NormalTok{, }\DecValTok{286}\NormalTok{, }\DecValTok{298}\NormalTok{, }\DecValTok{267}\NormalTok{, }\DecValTok{272}\NormalTok{, }\DecValTok{285}\NormalTok{,}
  \DecValTok{286}\NormalTok{, }\DecValTok{303}\NormalTok{, }\DecValTok{295}\NormalTok{, }\DecValTok{289}\NormalTok{, }\DecValTok{258}\NormalTok{, }\DecValTok{286}\NormalTok{, }\DecValTok{320}\NormalTok{, }\DecValTok{354}\NormalTok{, }\DecValTok{328}\NormalTok{, }\DecValTok{297}\NormalTok{, }\DecValTok{323}\NormalTok{, }\DecValTok{331}\NormalTok{, }\DecValTok{305}\NormalTok{,}
  \DecValTok{338}\NormalTok{, }\DecValTok{376}\NormalTok{, }\DecValTok{296}\NormalTok{, }\DecValTok{352}\NormalTok{, }\DecValTok{314}\NormalTok{, }\DecValTok{325}\NormalTok{, }\DecValTok{358}\NormalTok{, }\DecValTok{312}\NormalTok{, }\DecValTok{324}\NormalTok{, }\DecValTok{316}\NormalTok{, }\DecValTok{317}\NormalTok{, }\DecValTok{336}\NormalTok{, }\DecValTok{321}\NormalTok{,}
  \DecValTok{334}\NormalTok{, }\DecValTok{302}\NormalTok{, }\DecValTok{302}\NormalTok{, }\DecValTok{323}\NormalTok{, }\DecValTok{331}\NormalTok{, }\DecValTok{345}\NormalTok{, }\DecValTok{333}\NormalTok{, }\DecValTok{316}\NormalTok{, }\DecValTok{291}\NormalTok{, }\DecValTok{324}
\NormalTok{), }\AttributeTok{.Dim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{8.0}\NormalTok{, }\FloatTok{15.0}\NormalTok{, }\FloatTok{22.0}\NormalTok{, }\FloatTok{29.0}\NormalTok{, }\FloatTok{36.0}\NormalTok{)}
\NormalTok{xbar }\OtherTok{\textless{}{-}} \FloatTok{22.0}


\CommentTok{\# 模型参数设置}
\NormalTok{chains }\OtherTok{\textless{}{-}} \DecValTok{4}
\NormalTok{iter }\OtherTok{\textless{}{-}} \DecValTok{1000}

\NormalTok{init }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\FunctionTok{list}\NormalTok{(}
  \AttributeTok{alpha =} \FunctionTok{rep}\NormalTok{(}\DecValTok{250}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{beta =} \FunctionTok{rep}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{30}\NormalTok{),}
  \AttributeTok{alpha\_c =} \DecValTok{150}\NormalTok{, }\AttributeTok{beta\_c =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{tausq\_c =} \DecValTok{1}\NormalTok{, }\AttributeTok{tausq\_alpha =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{tausq\_beta =} \DecValTok{1}
\NormalTok{)), chains)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{cmdstan\_model}\NormalTok{(}\AttributeTok{stan\_file =} \StringTok{"code/rats.stan"}\NormalTok{)}

\NormalTok{rats\_fit }\OtherTok{\textless{}{-}}\NormalTok{ mod}\SpecialCharTok{$}\FunctionTok{sample}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{list}\NormalTok{(}\AttributeTok{N =}\NormalTok{ N, }\AttributeTok{T =}\NormalTok{ T, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{xbar =}\NormalTok{ xbar),}
  \AttributeTok{init =}\NormalTok{ init,}
  \AttributeTok{iter\_warmup =} \DecValTok{1000}\NormalTok{, }\CommentTok{\# 每条链预处理迭代次数}
  \AttributeTok{iter\_sampling =} \DecValTok{2000}\NormalTok{, }\CommentTok{\# 每条链总迭代次数}
  \AttributeTok{chains =}\NormalTok{ chains, }\CommentTok{\# 马尔科夫链的数目}
  \AttributeTok{parallel\_chains =} \DecValTok{1}\NormalTok{, }\CommentTok{\# 指定 CPU 核心数，可以给每条链分配一个}
  \AttributeTok{show\_messages =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 不显示迭代的中间过程}
  \AttributeTok{refresh =} \DecValTok{0}\NormalTok{, }\CommentTok{\# 不显示采样的进度}
  \AttributeTok{seed =} \DecValTok{20190425} \CommentTok{\# 设置随机数种子，不要使用 set.seed() 函数}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Running MCMC with 4 sequential chains...
## 
## Chain 1 finished in 0.6 seconds.
## Chain 2 finished in 0.7 seconds.
## Chain 3 finished in 0.7 seconds.
## Chain 4 finished in 0.6 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 0.6 seconds.
## Total execution time: 2.7 seconds.
\end{verbatim}

\hypertarget{sec-nlm-gp}{%
\section{非线性模型}\label{sec-nlm-gp}}

高斯过程

\hypertarget{subsec-mcycle}{%
\subsection{mcycle 数据}\label{subsec-mcycle}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(MASS)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ mcycle, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ times, }\AttributeTok{y=}\NormalTok{ accel)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \CommentTok{\# geom\_smooth() +}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Times (ms)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Acceleration (g)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{bayesian-models_files/figure-latex/unnamed-chunk-23-1} \end{center}

\hypertarget{part-ux6570ux636eux5efaux6a21}{%
\part{数据建模}\label{part-ux6570ux636eux5efaux6a21}}

\hypertarget{chap-data-modeling}{%
\chapter*{介绍}\label{chap-data-modeling}}
\addcontentsline{toc}{chapter}{介绍}

数据建模

\hypertarget{chap-text-analysis}{%
\chapter{文本分析}\label{chap-text-analysis}}

\href{https://smltar.com/}{Supervised Machine Learning for Text Analysis in R} 和 \href{https://www.tidytextmining.com/}{Tidy Text Mining with R}

\href{https://github.com/AllanCameron/PDFR}{PDFR} 和 \href{https://github.com/ropensci/pdftools}{pdftools} 从 PDF 文档抽取文本， \href{https://github.com/ropensci/tesseract}{tesseract} 从扫描件中抽取文本

\href{https://github.com/quanteda/quanteda}{quanteda}

\href{https://github.com/FlorianSchwendinger/fastTextR}{fastTextR} \url{https://github.com/facebookresearch/fastText}

\hypertarget{chap-survival-analysis}{%
\chapter{生存分析}\label{chap-survival-analysis}}

\begin{quote}
The fact that some people murder doesn't mean we should copy them. And murdering data, though not as serious, should also be avoided.

\hspace*{\fill} --- Frank E. Harrell \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2005-July/075649.html}}
\end{quote}

R 软件内置了 \href{https://github.com/therneau/survival}{\textbf{survival}包} 它是实现生存分析的核心 R 包。文档见 \url{https://cran.r-project.org/package=survival} 相关书籍见 \citet{Therneau_2000_Modeling}

\href{https://github.com/kassambara/survminer}{survminer} 竟然严重依赖 \href{https://github.com/kassambara/ggpubr}{\textbf{ggpubr} 包}，ggpubr 包曾被 \href{https://github.com/YuLab-SMU/ggtree}{ggtree} 的作者\href{https://guangchuangyu.github.io/}{余光创}严重\href{https://guangchuangyu.github.io/2019/12/why-hate-ggpubr/}{吐槽过}。\href{https://github.com/sinhrks/ggfortify}{\textbf{ggfortify}包} 大大扩展了 \textbf{ggplot2} 包的 \texttt{autoplot()} 函数，使得它适应各种模型对象的自动绘图。

\hypertarget{sec-aml}{%
\section{急性粒细胞白血病生存数据}\label{sec-aml}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(survival)}
\NormalTok{leukemia.surv }\OtherTok{\textless{}{-}} \FunctionTok{survfit}\NormalTok{(}\FunctionTok{Surv}\NormalTok{(time, status) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{data =}\NormalTok{ aml)}
\FunctionTok{library}\NormalTok{(ggfortify)}
\FunctionTok{autoplot}\NormalTok{(leukemia.surv, }\AttributeTok{data =}\NormalTok{ aml) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{survival-analysis_files/figure-latex/aml-1} 

}

\caption{急性粒细胞白血病生存数据}\label{fig:aml}
\end{figure}

\hypertarget{chap-time-series-analysis}{%
\chapter{时序分析}\label{chap-time-series-analysis}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(formatR)}
\StringTok{\textasciigrave{}}\AttributeTok{\%\textgreater{}\%}\StringTok{\textasciigrave{}} \OtherTok{\textless{}{-}}\NormalTok{ magrittr}\SpecialCharTok{::}\StringTok{\textasciigrave{}}\AttributeTok{\%\textgreater{}\%}\StringTok{\textasciigrave{}}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggfortify) }\CommentTok{\# **ggfortify** 包提供的 \textasciigrave{}autoplot()\textasciigrave{} 函数可以根据数据对象的不同绘制不同的图形。}
\FunctionTok{library}\NormalTok{(highcharter)}
\FunctionTok{library}\NormalTok{(dygraphs) }
\CommentTok{\# library(robustbase) \# Robust Statistics}
\CommentTok{\# library(timeDate) \# 日期处理}
\CommentTok{\# library(timeSeries) \# 序列处理}
\CommentTok{\# library(fPortfolio) \# 投资组合}
\CommentTok{\# library(prophet) \# 时间序列预测}
\CommentTok{\# https://github.com/business{-}science/timetk}
\CommentTok{\# library(timetk) \# 处理时间序列数据的工具箱}
\end{Highlighting}
\end{Shaded}

首先介绍时序数据对象及操作，处理时序数据的工具，包括时序图、相关图、平稳性检验，相关检验，之后才是时序建模。\href{https://cran.r-project.org/package=timeDate}{timeDate} \href{https://cran.r-project.org/package=timeSeries}{timeSeries} 是处理日期和时间序列的 R 包，有专门的官网 \url{https://www.rmetrics.org/}，扩展到时间序列、组合优化、金融市场、投资管理等一系列书籍，非常值得一看。此外，北大李东风老师的\href{https://www.math.pku.edu.cn/teachers/lidf/course/}{金融时间序列分析讲义} 是这方面非常好的中文参考材料。David R. Brillinger 在 1975 年出版的书 《Time Series: Data Analysis and Theory》 \citep{Brillinger_2001_TSD} 是经典著作，我们可以从时间序列分析的综述上开始入手，比如从 ARIMA 过渡到异方差和非高斯分布 \url{https://mason.gmu.edu/~jgentle/talks/CompFin_Tutorial.pdf}， \url{https://www.stat.berkeley.edu/~brill/Papers/encysbs.pdf} 和 ARCH or GARCH 的综述 \url{http://public.econ.duke.edu/~boller/Papers/glossary_arch.pdf} ，宾州州立大学开设的 Applied Time Series Analysis 课程 \url{https://newonlinecourses.science.psu.edu/stat510/}，以及 《Time Series Analysis and Its Applications With R Examples》 已经出到第四版了，和 R 语言结合，理论和应用结合 \url{https://www.stat.pitt.edu/stoffer/tsa4/}。从时间序列中寻找规律，这样才是真的数据建模，从数据到模型，而不是相反 \href{https://mason.gmu.edu/~jgentle/papers/FindingPatternsTimeSeriesDraft.pdf}{Finding Patterns in Time Series}，识别金融时间序列的模式和统计规律。现在工业界做时序分析和预测的工具，如 facebook 出品的 \href{https://github.com/facebook/prophet/tree/master/R}{prophet}，微软收集了一些时间序列预测的最佳实战案例 \url{https://github.com/microsoft/forecasting}

\href{https://github.com/nredell/forecastML/}{forecastML} 自回归模型结合机器学习方法。

\href{https://github.com/google/CausalImpact}{CausalImpact} 借助贝叶斯分析方法推断时间序列中的因果关系，比如广告促销带来的点击效果。

\href{https://r-forge.r-project.org/projects/robustbase/}{robustbase} \citep{robustbase2006} 提供稳健统计方法。

\href{https://github.com/facebook/prophet}{prophet} 基于可加模型的时间序列预测

\href{https://github.com/twitter/AnomalyDetection}{AnomalyDetection} 时间序列数据中的异常值检测

\hypertarget{sec-ts-data}{%
\section{时序数据}\label{sec-ts-data}}

以数据集 AirPassengers 为例说明一下 R 内置的存储时间序列数据的数据结构 --- ts 数据对象。函数 \texttt{class()} 、 \texttt{mode()} 和 \texttt{str()} 分别可以查看其数据类型、存储类型和数据结构。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据类型}
\FunctionTok{class}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ts"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 存储类型}
\FunctionTok{mode}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "numeric"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据结构}
\FunctionTok{str}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  Time-Series [1:144] from 1949 to 1961: 112 118 132 129 121 135 148 148 136 119 ...
\end{verbatim}

查看该数据集开始和结束的时间点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{c}\NormalTok{(}\FunctionTok{start}\NormalTok{(AirPassengers), }\FunctionTok{end}\NormalTok{(AirPassengers))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1949    1 1960   12
\end{verbatim}

数据集 AirPassengers 在以上时间区间的划分

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{time}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Jan      Feb      Mar      Apr      May      Jun      Jul      Aug
## 1949 1949.000 1949.083 1949.167 1949.250 1949.333 1949.417 1949.500 1949.583
## 1950 1950.000 1950.083 1950.167 1950.250 1950.333 1950.417 1950.500 1950.583
## 1951 1951.000 1951.083 1951.167 1951.250 1951.333 1951.417 1951.500 1951.583
## 1952 1952.000 1952.083 1952.167 1952.250 1952.333 1952.417 1952.500 1952.583
## 1953 1953.000 1953.083 1953.167 1953.250 1953.333 1953.417 1953.500 1953.583
## 1954 1954.000 1954.083 1954.167 1954.250 1954.333 1954.417 1954.500 1954.583
## 1955 1955.000 1955.083 1955.167 1955.250 1955.333 1955.417 1955.500 1955.583
## 1956 1956.000 1956.083 1956.167 1956.250 1956.333 1956.417 1956.500 1956.583
## 1957 1957.000 1957.083 1957.167 1957.250 1957.333 1957.417 1957.500 1957.583
## 1958 1958.000 1958.083 1958.167 1958.250 1958.333 1958.417 1958.500 1958.583
## 1959 1959.000 1959.083 1959.167 1959.250 1959.333 1959.417 1959.500 1959.583
## 1960 1960.000 1960.083 1960.167 1960.250 1960.333 1960.417 1960.500 1960.583
##           Sep      Oct      Nov      Dec
## 1949 1949.667 1949.750 1949.833 1949.917
## 1950 1950.667 1950.750 1950.833 1950.917
## 1951 1951.667 1951.750 1951.833 1951.917
## 1952 1952.667 1952.750 1952.833 1952.917
## 1953 1953.667 1953.750 1953.833 1953.917
## 1954 1954.667 1954.750 1954.833 1954.917
## 1955 1955.667 1955.750 1955.833 1955.917
## 1956 1956.667 1956.750 1956.833 1956.917
## 1957 1957.667 1957.750 1957.833 1957.917
## 1958 1958.667 1958.750 1958.833 1958.917
## 1959 1959.667 1959.750 1959.833 1959.917
## 1960 1960.667 1960.750 1960.833 1960.917
\end{verbatim}

期初和期末的周期

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tsp}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1949.000 1960.917   12.000
\end{verbatim}

函数 \texttt{diff()} 实现差分算子，默认参数 \texttt{lag\ =\ 1} ，\texttt{differences\ =\ 1} 表示延迟期数为 1 的一阶差分。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 差分前}
\NormalTok{AirPassengers}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
## 1949 112 118 132 129 121 135 148 148 136 119 104 118
## 1950 115 126 141 135 125 149 170 170 158 133 114 140
## 1951 145 150 178 163 172 178 199 199 184 162 146 166
## 1952 171 180 193 181 183 218 230 242 209 191 172 194
## 1953 196 196 236 235 229 243 264 272 237 211 180 201
## 1954 204 188 235 227 234 264 302 293 259 229 203 229
## 1955 242 233 267 269 270 315 364 347 312 274 237 278
## 1956 284 277 317 313 318 374 413 405 355 306 271 306
## 1957 315 301 356 348 355 422 465 467 404 347 305 336
## 1958 340 318 362 348 363 435 491 505 404 359 310 337
## 1959 360 342 406 396 420 472 548 559 463 407 362 405
## 1960 417 391 419 461 472 535 622 606 508 461 390 432
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 差分后}
\FunctionTok{diff}\NormalTok{(AirPassengers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
## 1949         6   14   -3   -8   14   13    0  -12  -17  -15   14
## 1950   -3   11   15   -6  -10   24   21    0  -12  -25  -19   26
## 1951    5    5   28  -15    9    6   21    0  -15  -22  -16   20
## 1952    5    9   13  -12    2   35   12   12  -33  -18  -19   22
## 1953    2    0   40   -1   -6   14   21    8  -35  -26  -31   21
## 1954    3  -16   47   -8    7   30   38   -9  -34  -30  -26   26
## 1955   13   -9   34    2    1   45   49  -17  -35  -38  -37   41
## 1956    6   -7   40   -4    5   56   39   -8  -50  -49  -35   35
## 1957    9  -14   55   -8    7   67   43    2  -63  -57  -42   31
## 1958    4  -22   44  -14   15   72   56   14 -101  -45  -49   27
## 1959   23  -18   64  -10   24   52   76   11  -96  -56  -45   43
## 1960   12  -26   28   42   11   63   87  -16  -98  -47  -71   42
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 延迟一期的二阶差分}
\FunctionTok{diff}\NormalTok{(AirPassengers, }\AttributeTok{lag =} \DecValTok{1}\NormalTok{, }\AttributeTok{differences =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
## 1949              8  -17   -5   22   -1  -13  -12   -5    2   29
## 1950  -17   14    4  -21   -4   34   -3  -21  -12  -13    6   45
## 1951  -21    0   23  -43   24   -3   15  -21  -15   -7    6   36
## 1952  -15    4    4  -25   14   33  -23    0  -45   15   -1   41
## 1953  -20   -2   40  -41   -5   20    7  -13  -43    9   -5   52
## 1954  -18  -19   63  -55   15   23    8  -47  -25    4    4   52
## 1955  -13  -22   43  -32   -1   44    4  -66  -18   -3    1   78
## 1956  -35  -13   47  -44    9   51  -17  -47  -42    1   14   70
## 1957  -26  -23   69  -63   15   60  -24  -41  -65    6   15   73
## 1958  -27  -26   66  -58   29   57  -16  -42 -115   56   -4   76
## 1959   -4  -41   82  -74   34   28   24  -65 -107   40   11   88
## 1960  -31  -38   54   14  -31   52   24 -103  -82   51  -24  113
\end{verbatim}

\hypertarget{sec-ts-plot}{%
\section{时序图}\label{sec-ts-plot}}

美国纽黑文自1912年至1971年的年平均气温变化见图 \ref{fig:new-haven-temp}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(nhtemp, }\AttributeTok{main =} \StringTok{"美国纽黑文的年平均气温"}\NormalTok{, }\AttributeTok{family =} \StringTok{"source{-}han{-}sans{-}cn"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{time-series-analysis_files/figure-latex/new-haven-temp-1} 

}

\caption{美国纽黑文的年平均气温，单位：华氏温度}\label{fig:new-haven-temp}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 构造多个 ts 序列}
\NormalTok{tmp }\OtherTok{\textless{}{-}} \FunctionTok{ts}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{pay\_one =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{),}
    \AttributeTok{pay\_two =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{),}
    \AttributeTok{pay\_three =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1961}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{frequency =} \DecValTok{12}
\NormalTok{)}

\FunctionTok{plot}\NormalTok{(tmp, }\AttributeTok{main =} \StringTok{"pay cnt"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{time-series-analysis_files/figure-latex/unnamed-chunk-7-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(tmp, }\AttributeTok{plot.type =} \StringTok{"single"}\NormalTok{, }\AttributeTok{col =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"pay cnt"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{time-series-analysis_files/figure-latex/unnamed-chunk-7-2} \end{center}

\hypertarget{sec:frequency}{%
\section{基本概念}\label{sec:frequency}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 从某个完整的一天开始统计数据}
\CommentTok{\# 分钟级 ts 数据}
\NormalTok{time\_min }\OtherTok{\textless{}{-}} \FunctionTok{format}\NormalTok{(}\FunctionTok{seq.POSIXt}\NormalTok{(}
  \AttributeTok{from =} \FunctionTok{as.POSIXct}\NormalTok{(}\StringTok{"2020{-}01{-}01 00:00"}\NormalTok{),}
  \AttributeTok{to =} \FunctionTok{as.POSIXct}\NormalTok{(}\StringTok{"2020{-}01{-}01 23:59"}\NormalTok{), }\AttributeTok{by =} \StringTok{"1 min"}
\NormalTok{),}
\AttributeTok{format =} \StringTok{"\%H:\%M"}
\NormalTok{)}
\NormalTok{tmp }\OtherTok{=} \FunctionTok{ts}\NormalTok{(}\AttributeTok{data =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{1440} \SpecialCharTok{*} \DecValTok{3}\NormalTok{), }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{2020}\NormalTok{, }\DecValTok{12}\NormalTok{),}
         \AttributeTok{frequency =} \DecValTok{24}\SpecialCharTok{*}\DecValTok{60}\SpecialCharTok{*}\FloatTok{365.25}\NormalTok{, }\AttributeTok{names =} \StringTok{"访问量"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(tmp)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{time-series-analysis_files/figure-latex/unnamed-chunk-8-1} \end{center}

frequency: the number of observations per unit of time.

frequency 里面乘以 365.25 而不是 365 是因为每隔 4 年出现一次 366 天，多出的这一天分摊到每一年。 frequency 表示单位时间内发生的次数，ts 对象的时间基准为 1 年，所以，frequency = 4 表示一年出现四次，依此类推。关于季节性周期的说明 \url{https://robjhyndman.com/hyndsight/seasonal-periods/}。

序列长度一样，但是周期不一样，这里的单位时间指的是1年

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 季数据}
\NormalTok{op }\OtherTok{=} \FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\NormalTok{tmp }\OtherTok{=} \FunctionTok{ts}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{), }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1961}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{frequency =} \DecValTok{4}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(tmp, }\AttributeTok{main =} \StringTok{"Quarterly"}\NormalTok{, }\AttributeTok{type =} \StringTok{"b"}\NormalTok{)}
\CommentTok{\# 月数据}
\NormalTok{tmp }\OtherTok{=} \FunctionTok{ts}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{), }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1961}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{frequency =} \DecValTok{12}\NormalTok{) }\CommentTok{\# 自然时间周期是一年，每月采样}
\FunctionTok{plot}\NormalTok{(tmp, }\AttributeTok{main =} \StringTok{"Monthly"}\NormalTok{, }\AttributeTok{type =} \StringTok{"b"}\NormalTok{)}
\CommentTok{\# 日数据}
\NormalTok{tmp }\OtherTok{=} \FunctionTok{ts}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{), }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1961}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{frequency =} \FloatTok{365.25}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(tmp, }\AttributeTok{main =} \StringTok{"Daily"}\NormalTok{, }\AttributeTok{type =} \StringTok{"b"}\NormalTok{)}
\CommentTok{\# 分钟数据}
\NormalTok{tmp }\OtherTok{=} \FunctionTok{ts}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{), }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1961}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{frequency =} \DecValTok{24}\SpecialCharTok{*}\DecValTok{60}\SpecialCharTok{*}\FloatTok{365.25}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(tmp, }\AttributeTok{main =} \StringTok{"Minutely"}\NormalTok{, }\AttributeTok{type =} \StringTok{"b"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{time-series-analysis_files/figure-latex/unnamed-chunk-9-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

默认情况下，自然时间周期是一年，每月采样。那可不可以设置自然时间周期是一周，每天采样呢？ 当然可以，只是 Base R 暂不支持，其实表达数据粒度的能力没有变化，以年或周为基准，都可以表达上面的季、月、日、分钟数据。

deltat 和 frequency 只需提供一个参数值即可 deltat = 1/12 和 frequency = 12 表示同样的含义。

R 4.0.0 开始，frequency 不必是整数，还可以是小数，frequency = .2 表示每 5 个时间单位抽样一次，根据周期 T 和频率 f 的关系 T = 1/f

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tmp }\OtherTok{=} \FunctionTok{ts}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{), }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1961}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{frequency =}\NormalTok{ .}\DecValTok{2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(tmp, }\AttributeTok{type =} \StringTok{"b"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{time-series-analysis_files/figure-latex/unnamed-chunk-10-1} \end{center}

ts 和 seq 构造时间向量的关系是什么？

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{1961}\NormalTok{, }\AttributeTok{to =} \DecValTok{2056}\NormalTok{, }\AttributeTok{by =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 1961 1966 1971 1976 1981 1986 1991 1996 2001 2006 2011 2016 2021 2026 2031
## [16] 2036 2041 2046 2051 2056
\end{verbatim}

即每隔5年抽样一次，采一个数据点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ts}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{20}\NormalTok{), }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1961}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{frequency =} \FloatTok{365.25}\SpecialCharTok{/}\DecValTok{7}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Time Series:
## Start = 1961 
## End = 1961.36413415469 
## Frequency = 52.1785714285714 
##  [1] -0.44021231  0.80094706 -0.46946422  1.24030728 -0.62299352  0.03338371
##  [7]  0.43744907 -1.18495649 -0.83943090  1.83015189 -0.21806832  0.89690710
## [13] -0.79384850 -0.69578553  0.55509629  0.10128423 -1.18784469 -0.52445056
## [19] -0.59235331  0.34218749
\end{verbatim}

周数据，一周采一个点，采了 20 个点

\hypertarget{sec-ts-tests}{%
\section{时序检验}\label{sec-ts-tests}}

参数的计算公式，实现的 R 代码

\begin{itemize}
\tightlist
\item
  Applies linear filtering to a univariate time series or to each series separately of a multivariate time series. 过滤
\end{itemize}

一元时间序列的线性过滤，或者对多元时间序列的单个序列分别做线性过滤

\[
y[i] = x[i] + f[1]*y[i-1] +\ldots+ f[p]*y[i-p]
\]

\[
y[i] = f[1]*x[i+o] + \ldots + f[p]*x[i+o-(p-1)]
\]

其中 \(o\) 代表 offset

介绍 FTT 算法细节

不同的方法对时间序列平滑的影响 FTT 快速傅里叶变换算法

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{usage}\NormalTok{(stats}\SpecialCharTok{::}\NormalTok{filter)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## filter(x, filter, method = c("convolution", "recursive"), sides = 2L,
##     circular = FALSE, init = NULL)
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{filter()} 时间序列线性过滤
\item
  \texttt{fft()} 快速离散傅里叶变换
\end{itemize}

\hypertarget{sec-exponential-smoothing}{%
\section{指数平滑}\label{sec-exponential-smoothing}}

\hypertarget{sec-holt-winters}{%
\section{Holt-Winters}\label{sec-holt-winters}}

\textbf{可加} Holt-Winters \citep{Winters_1960_Forecasting, Holt_2004_Forecasting} 预测函数，周期长度为 p

\[
\hat{Y}[t+h] = a[t] + h * b[t] + s[t - p + 1 + (h - 1) \mod p
\]

其中 \(a[t], b[t], s[t]\) 由以下决定

\begin{align}
a[t] &= \alpha (Y[t] - s[t-p]) + (1-\alpha) (a[t-1] + b[t-1]) \\
b[t] &= \beta (a[t] - a[t-1]) + (1-\beta) b[t-1] \\
s[t] &= \gamma (Y[t] - a[t]) + (1-\gamma) s[t-p]
\end{align}

可乘 Holt-Winters

\[
\hat{Y}[t+h] = (a[t] + h * b[t]) * s[t - p + 1 + (h - 1) \mod p]
\]

其中 \(a[t], b[t], s[t]\) 由如下决定

\begin{align}
a[t] &= \alpha (Y[t] / s[t-p]) + (1-\alpha) (a[t-1] + b[t-1]) \\
b[t] &= \beta (a[t] - a[t-1]) + (1-\beta) b[t-1] \\
s[t] &= \gamma (Y[t] / a[t]) + (1-\gamma) s[t-p]
\end{align}

\texttt{HoltWinters()} 用 Shiny App / 动画的形式展示 \(\alpha, \beta, \gamma\) 三个参数对模型预测的影响，参数的确定通过最小化预测均方误差

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Seasonal Holt{-}Winters}
\NormalTok{(m }\OtherTok{\textless{}{-}} \FunctionTok{HoltWinters}\NormalTok{(co2))}
\FunctionTok{plot}\NormalTok{(m)}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{fitted}\NormalTok{(m))}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(m, }\DecValTok{50}\NormalTok{, }\AttributeTok{prediction.interval =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(m, p)}

\NormalTok{(m }\OtherTok{\textless{}{-}} \FunctionTok{HoltWinters}\NormalTok{(AirPassengers, }\AttributeTok{seasonal =} \StringTok{"mult"}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(m)}

\DocumentationTok{\#\# 指数平滑 Exponential Smoothing}
\NormalTok{m2 }\OtherTok{\textless{}{-}} \FunctionTok{HoltWinters}\NormalTok{(x, }\AttributeTok{gamma =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{beta =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{fitted}\NormalTok{(m2)[,}\DecValTok{1}\NormalTok{], }\AttributeTok{col =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-sunspots}{%
\section{1749-2013 年太阳黑子数据}\label{sec-sunspots}}

再从官网拿到最近的数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(sunspot.month, }\AttributeTok{xlab =} \StringTok{"Year"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Monthly sunspot numbers"}\NormalTok{,}
     \AttributeTok{main =} \StringTok{"Monthly mean relative sunspot numbers from 1749 to 2013"}\NormalTok{)}

\FunctionTok{autoplot}\NormalTok{(sunspot.month,}
  \AttributeTok{main =} \StringTok{"Monthly mean relative sunspot numbers from 1749 to 2013"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Year"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Monthly sunspot numbers"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{time-series-analysis_files/figure-latex/sunspot-month-1} \includegraphics{time-series-analysis_files/figure-latex/sunspot-month-2} 

}

\caption{时序图：太阳黑子月均数量}\label{fig:sunspot-month}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{autoplot}\NormalTok{(sunspots)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{time-series-analysis_files/figure-latex/unnamed-chunk-15-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{autoplot}\NormalTok{(sunspot.year, }\AttributeTok{xlab =} \StringTok{"Year"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Yearly Sunspot Data, 1700{-}1988"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{time-series-analysis_files/figure-latex/sunspots-year-tsplot-1} 

}

\caption{太阳黑子数量年平均时序图}\label{fig:sunspots-year-tsplot}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dygraphs)}
\NormalTok{hw }\OtherTok{\textless{}{-}} \FunctionTok{HoltWinters}\NormalTok{(sunspot.month)}
\NormalTok{predicted }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(hw, }\AttributeTok{n.ahead =} \DecValTok{72}\NormalTok{, }\AttributeTok{prediction.interval =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{dygraph}\NormalTok{(predicted, }\AttributeTok{main =} \StringTok{"Predicted sunspot numbers"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{dyAxis}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\AttributeTok{drawGrid =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{dySeries}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"lwr"}\NormalTok{, }\StringTok{"fit"}\NormalTok{, }\StringTok{"upr"}\NormalTok{), }\AttributeTok{label =} \StringTok{"sunspot"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{dyOptions}\NormalTok{(}\AttributeTok{colors =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{family =} \StringTok{"source{-}han{-}sans{-}cn"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(sunspot.month, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(sunspots, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topright"}\NormalTok{, }\AttributeTok{legend =} \FunctionTok{c}\NormalTok{(}\StringTok{"1749 至今"}\NormalTok{, }\StringTok{"1749{-}1983"}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"black"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{time-series-analysis_files/figure-latex/sunspot-1} 

}

\caption{月均太阳黑子数}\label{fig:sunspot}
\end{figure}

\hypertarget{sec-EuStockMarkets}{%
\section{1991-1998 年欧洲主要股票市场日闭市价格指数}\label{sec-EuStockMarkets}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{matplot}\NormalTok{(}\FunctionTok{time}\NormalTok{(EuStockMarkets), EuStockMarkets,}
  \AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Date"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"closing prices"}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{col =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topleft"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(EuStockMarkets), }\AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{time-series-analysis_files/figure-latex/unnamed-chunk-16-1} 

}

\caption{1991-1998年间欧洲主要股票市场日闭市价格指数图 
 德国 DAX (Ibis), Switzerland SMI, 法国 CAC 和 英国 FTSE}\label{fig:unnamed-chunk-16}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 考虑收集加入最新的数据 1991\textasciitilde{}1998年的数据}
\FunctionTok{plot}\NormalTok{(EuStockMarkets, }\AttributeTok{plot.type =} \StringTok{"single"}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topleft"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(EuStockMarkets),}
  \AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{text.col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{lty =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{inset =} \FloatTok{0.05}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{time-series-analysis_files/figure-latex/EuStockMarkets-1} \end{center}

\hypertarget{sec-autoregressive}{%
\section{自回归模型}\label{sec-autoregressive}}

\texttt{ar()}

\hypertarget{sec-moving-average}{%
\section{移动平均模型}\label{sec-moving-average}}

\texttt{arima()}

\hypertarget{sec-autoregressive-movement-average}{%
\section{自回归移动平均模型}\label{sec-autoregressive-movement-average}}

\texttt{arima()} ARIMA

\hypertarget{sec-autoregressive-conditional-heteroskedasticity}{%
\section{自回归条件异方差模型}\label{sec-autoregressive-conditional-heteroskedasticity}}

自回归条件异方差模型 ARCH

\hypertarget{sec-generalized-autoregressive-conditional-heteroskedasticity}{%
\section{广义自回归条件异方差模型}\label{sec-generalized-autoregressive-conditional-heteroskedasticity}}

广义自回归条件异方差模型 （Generalized Autoregressive Conditional Heteroskedasticity，简称 GARCH ）

\hypertarget{sec-other-ts}{%
\section{其它特征的时间序列}\label{sec-other-ts}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(JohnsonJohnson)}
\FunctionTok{plot}\NormalTok{(AirPassengers)}
\FunctionTok{plot}\NormalTok{(nottem)}
\FunctionTok{plot}\NormalTok{(lynx)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[1960-1980年强生公司每股季度收益\label{fig:other-ts-1}]{\includegraphics[width=0.45\linewidth]{time-series-analysis_files/figure-latex/other-ts-1} }\subfloat[1949-1960年月均航班乘客数量\label{fig:other-ts-2}]{\includegraphics[width=0.45\linewidth]{time-series-analysis_files/figure-latex/other-ts-2} }\newline\subfloat[1920-1939 年诺丁汉月均气温\label{fig:other-ts-3}]{\includegraphics[width=0.45\linewidth]{time-series-analysis_files/figure-latex/other-ts-3} }\subfloat[1821-1934 年加拿大山猫陷阱数量\label{fig:other-ts-4}]{\includegraphics[width=0.45\linewidth]{time-series-analysis_files/figure-latex/other-ts-4} }

}

\caption{时间序列：非平稳、周期性、非线性}\label{fig:other-ts}
\end{figure}

\hypertarget{sec-hk-stock}{%
\section{港股走势}\label{sec-hk-stock}}

美团、阿里巴巴在香港上市

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 美团}
\NormalTok{meituan }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"3690.HK"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{, }\AttributeTok{from =} \StringTok{\textquotesingle{}2019{-}06{-}30\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 阿里}
\NormalTok{ali }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"9988.HK"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{, }\AttributeTok{from =} \StringTok{\textquotesingle{}2019{-}06{-}30\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 京东}
\NormalTok{sw }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"9618.HK"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{, }\AttributeTok{from =} \StringTok{\textquotesingle{}2019{-}06{-}30\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 腾讯}
\NormalTok{tx }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"0700.HK"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{, }\AttributeTok{from =} \StringTok{\textquotesingle{}2019{-}06{-}30\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 如何共 x 轴，右对齐}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{as.ts}\NormalTok{(meituan[, }\StringTok{"3690.HK.Close"}\NormalTok{]), }\AttributeTok{col =} \StringTok{"orange"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"股价"}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{as.ts}\NormalTok{(ali[, }\StringTok{"9988.HK.Close"}\NormalTok{]), }\AttributeTok{col =} \StringTok{"springgreen4"}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{as.ts}\NormalTok{(sw[, }\StringTok{"9618.HK.Close"}\NormalTok{]), }\AttributeTok{col =} \StringTok{"purple4"}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{as.ts}\NormalTok{(tx[, }\StringTok{"0700.HK.Close"}\NormalTok{]), }\AttributeTok{col =} \StringTok{"lightsteelblue4"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topright"}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"Orange"}\NormalTok{, }\StringTok{"springgreen4"}\NormalTok{, }\StringTok{"purple4"}\NormalTok{, }\StringTok{"lightsteelblue4"}\NormalTok{), }
       \AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{legend =} \FunctionTok{c}\NormalTok{(}\StringTok{"美团"}\NormalTok{, }\StringTok{"阿里"}\NormalTok{, }\StringTok{"京东"}\NormalTok{, }\StringTok{"腾讯"}\NormalTok{) )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-us-stock}{%
\section{美股走势}\label{sec-us-stock}}

拼多多、京东、阿里巴巴、51Talk 在美股上市

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 拼多多}
\NormalTok{pdd }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"PDD"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{)}
\CommentTok{\# 京东}
\NormalTok{jd }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"JD"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{)}
\CommentTok{\# 阿里巴巴}
\NormalTok{baba }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"BABA"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{)}
\CommentTok{\# 51Talk}
\NormalTok{coe }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"COE"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{, }\AttributeTok{from =} \StringTok{\textquotesingle{}2016{-}06{-}30\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-coe-stock}{%
\section{51Talk 股价走势}\label{sec-coe-stock}}

Joshua M. Ulrich 开发维护的 \href{https://github.com/joshuaulrich/quantmod}{quantmod} 包可以下载国内外股票市场的数据

51talk 于 2016年6月10日在美国纽交所上市，股票代码 COE， 2020年1月22日，武汉封城，受新冠肺炎病毒影响，政府停课不停学的号召，线下教育纷纷转线上，线上教育的春天来临，股价开始回升到发行价的水平，在公司将资源转变为能力后，预期公司股价继续翻倍，回到理性的水平。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coe }\OtherTok{\textless{}{-}}\NormalTok{ quantmod}\SpecialCharTok{::}\FunctionTok{getSymbols}\NormalTok{(}\StringTok{"COE"}\NormalTok{, }\AttributeTok{auto.assign =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{src =} \StringTok{"yahoo"}\NormalTok{, }\AttributeTok{from =} \StringTok{\textquotesingle{}2016{-}06{-}30\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

读者可以从雅虎财经获取数据源 \url{https://finance.yahoo.com/}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(coe[, }\StringTok{"COE.Close"}\NormalTok{],}
  \AttributeTok{subset =} \StringTok{"2016{-}06{-}30/2021{-}06{-}30"}\NormalTok{,}
  \AttributeTok{col =} \StringTok{"Orange"}\NormalTok{, }\AttributeTok{main =} \StringTok{"COE Stock Close Price"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{time-series-analysis_files/figure-latex/coe-close-price-1} 

}

\caption{51Talk公司上市以来的股价走势}\label{fig:coe-close-price}
\end{figure}

COE 股价变化趋势见下图，包含开盘价 Open、最低价 Low、最高价 High、闭市价 Close 和调整价 Adjust 和交易额 Volume

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{autoplot}\NormalTok{(coe)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.85\linewidth]{time-series-analysis_files/figure-latex/coe-price-1} 

}

\caption{CEO 股价变化趋势}\label{fig:coe-price}
\end{figure}

\hypertarget{sec-tsa-sessioninfo}{%
\section{运行环境}\label{sec-tsa-sessioninfo}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] dygraphs_1.1.1.6  highcharter_0.8.2 ggfortify_0.4.12  ggplot2_3.3.5    
## [5] formatR_1.11     
## 
## loaded via a namespace (and not attached):
##  [1] zoo_1.8-9         tidyselect_1.1.1  xfun_0.26         purrr_0.3.4      
##  [5] lattice_0.20-45   colorspace_2.0-2  vctrs_0.3.8       generics_0.1.0   
##  [9] htmltools_0.5.2   yaml_2.2.1        utf8_1.2.2        rlang_0.4.11     
## [13] pillar_1.6.3      glue_1.4.2        withr_2.4.2       DBI_1.1.1        
## [17] TTR_0.24.2        lifecycle_1.0.1   quantmod_0.4.18   stringr_1.4.0    
## [21] munsell_0.5.0     gtable_0.3.0      htmlwidgets_1.5.4 evaluate_0.14    
## [25] labeling_0.4.2    knitr_1.36        fastmap_1.1.0     curl_4.3.2       
## [29] fansi_0.5.0       broom_0.7.9       xts_0.12.1        Rcpp_1.0.7       
## [33] scales_1.1.1      backports_1.2.1   showtext_0.9-4    jsonlite_1.7.2   
## [37] sysfonts_0.8.5    farver_2.1.0      gridExtra_2.3     digest_0.6.28    
## [41] stringi_1.7.4     showtextdb_3.0    rlist_0.4.6.2     bookdown_0.24    
## [45] dplyr_1.0.7       grid_4.1.1        tools_4.1.1       magrittr_2.0.1   
## [49] tibble_3.1.5      crayon_1.4.1      tidyr_1.1.4       pkgconfig_2.0.3  
## [53] ellipsis_0.3.2    data.table_1.14.2 lubridate_1.7.10  assertthat_0.2.1 
## [57] rmarkdown_2.11    R6_2.5.1          igraph_1.2.6      compiler_4.1.1
\end{verbatim}

\hypertarget{part-ux65f6ux7a7aux6570ux636e}{%
\part{时空数据}\label{part-ux65f6ux7a7aux6570ux636e}}

\hypertarget{chap-spatio-temporal-data}{%
\chapter*{介绍}\label{chap-spatio-temporal-data}}
\addcontentsline{toc}{chapter}{介绍}

数据建模

\hypertarget{chap-spatial-analysis}{%
\chapter{空间数据分析}\label{chap-spatial-analysis}}

Robert Hijmans 开发的 \href{https://github.com/rspatial/terra}{terra} 用以替代 \href{https://github.com/rspatial/raster}{raster}，提供栅格数据和向量数据处理，基于回归和机器学习方法的空间差值和预测，能够处理相当大的数据集，包括卫星遥感数据，新的 R 包更加简洁、速度更快、功能更强。Edzer Pebesma 创建的 \href{https://github.com/r-spatial/}{r-spatial} 开源组织提供了一系列非常流行的空间分析相关的 R 包，如 \href{https://edzer.github.io/sp/}{sp}、 \href{https://github.com/r-spatial/sf}{sf}、 \href{https://github.com/r-spatial/stars}{stars}、 \href{https://github.com/r-spatial/mapedit}{mapedit} 和 \href{https://github.com/r-spatial/mapview}{mapview}。Edzer Pebesma 长期致力于地理信息和空间统计的软件开发，可以说目前已打造了一个生态。

Timothée Giraud 创建的 \href{https://github.com/riatelab/}{riatelab} 组织开发系列 R 包工具，可以绘制各种类型和风格的地图，专题地图工具已经从 \href{https://github.com/riatelab/cartography/}{cartography} 过渡到 \href{https://github.com/riatelab/mapsf}{mapsf}，它更加友好、轻量和稳健。类似的 R 包还有 \href{https://github.com/trulia/choroplethr}{choroplethr}，只是上次更新在 2015 年。

空间数据可视化常常离不开基础地图数据，不同的 R 包依赖的地图服务有所不同，比如 \href{https://github.com/markusloecher/rgooglemaps}{RgoogleMaps}、\href{https://github.com/dkahle/ggmap}{ggmap} 和 \href{https://github.com/SymbolixAU/googleway}{googleway} 主要依赖谷歌的地图数据。 而 \href{https://github.com/SymbolixAU/mapdeck}{mapdeck} 基于 \href{https://github.com/visgl/deck.gl}{deck.gl} 和 \href{https://github.com/mapbox/mapbox-gl-js}{Mapbox} 支持移动和网页应用，GPU 渲染等。\href{https://github.com/rstudio/leaflet}{leaflet} 则基于开源的\href{https://github.com/Leaflet/Leaflet}{Leaflet}库提供交互式空间数据可视化的能力。

\href{https://spatial.uchicago.edu/}{芝加哥大学空间数据科学中心} 开发的 R 包 \href{https://github.com/GeoDaCenter/rgeoda}{rgeoda} 基于开源的 C++ 库\href{https://github.com/GeoDaCenter/geoda}{GeoDa}，提供一系列空间数据分析能力，包括探索性空间数据分析、空间聚类检测和聚类分析。

Edzer Pebesma 和 Roger Bivand 合著的 \href{https://www.r-spatial.org/book}{Spatial Data Science with applications in R}，Christopher K. Wikle, Andrew Zammit-Mangion 和 Noel Cressie 合著的 \href{https://spacetimewithr.org/}{Spatio-Temporal Statistics with R}。推荐学习 Edzer Pebesma 在几届国际 R 语言大会上的材料，2021 年的\href{https://edzer.github.io/UseR2021/}{R Spatial}，2020 年的\href{https://edzer.github.io/UseR2020/}{Analyzing and visualising spatial and spatiotemporal data cubes Part I}， 2019 年的\href{https://edzer.github.io/UseR2019/part1.html}{Spatial workshop part I} 和 \href{https://edzer.github.io/UseR2019/part2.html}{Spatial workshop part II}， 2017 年的\href{https://edzer.github.io/UseR2017/}{Spatial Data in R: New Directions} 2016 年的\href{https://edzer.github.io/UseR2016/}{Handling and Analyzing Spatial, Spatiotemporal and Movement Data}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sp)}
\FunctionTok{library}\NormalTok{(RColorBrewer)}
\FunctionTok{library}\NormalTok{(raster)}
\FunctionTok{library}\NormalTok{(lattice)}
\FunctionTok{library}\NormalTok{(latticeExtra)}
\FunctionTok{library}\NormalTok{(terra) }\CommentTok{\# }
\FunctionTok{library}\NormalTok{(rasterVis) }\CommentTok{\# https://oscarperpinan.github.io/rastervis/}
\CommentTok{\# https://oscarperpinan.github.io/rastervis/FAQ.html}
\FunctionTok{library}\NormalTok{(sf)}
\FunctionTok{library}\NormalTok{(sfarrow) }\CommentTok{\# https://github.com/wcjochem/sfarrow}
\CommentTok{\# library(arrow) \# 列式存储}
\CommentTok{\# library(rgdal) \# 要替换掉}
\CommentTok{\# library(highcharter) \# 要替换掉}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(maps)}
\FunctionTok{library}\NormalTok{(mapdata)}
\FunctionTok{map}\NormalTok{(}\StringTok{"china"}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ F, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{100}\NormalTok{))}

\FunctionTok{library}\NormalTok{(leaflet)}

\NormalTok{mapChina }\OtherTok{=} \FunctionTok{map}\NormalTok{(}\StringTok{"china"}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ F, }\AttributeTok{plot =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{leaflet}\NormalTok{(}\AttributeTok{data =}\NormalTok{ mapChina) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{addTiles}\NormalTok{() }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{addPolygons}\NormalTok{(}\AttributeTok{fillColor =} \FunctionTok{topo.colors}\NormalTok{(}\DecValTok{10}\NormalTok{, }\AttributeTok{alpha =} \ConstantTok{NULL}\NormalTok{), }\AttributeTok{stroke =} \ConstantTok{FALSE}\NormalTok{)}


\CommentTok{\# From https://leafletjs.com/examples/choropleth/us{-}states.js}
\CommentTok{\# 返回 sp 对象}
\NormalTok{states }\OtherTok{\textless{}{-}}\NormalTok{ geojsonio}\SpecialCharTok{::}\FunctionTok{geojson\_read}\NormalTok{(}\StringTok{"json/us{-}states.geojson"}\NormalTok{, }\AttributeTok{what =} \StringTok{"sp"}\NormalTok{)}

\NormalTok{bins }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{1000}\NormalTok{, }\ConstantTok{Inf}\NormalTok{)}
\NormalTok{pal }\OtherTok{\textless{}{-}} \FunctionTok{colorBin}\NormalTok{(}\StringTok{"YlOrRd"}\NormalTok{, }\AttributeTok{domain =}\NormalTok{ states}\SpecialCharTok{$}\NormalTok{density, }\AttributeTok{bins =}\NormalTok{ bins)}

\NormalTok{labels }\OtherTok{\textless{}{-}} \FunctionTok{sprintf}\NormalTok{(}
  \StringTok{"\textless{}strong\textgreater{}\%s\textless{}/strong\textgreater{}\textless{}br/\textgreater{}\%g people / mi\textless{}sup\textgreater{}2\textless{}/sup\textgreater{}"}\NormalTok{,}
\NormalTok{  states}\SpecialCharTok{$}\NormalTok{name, states}\SpecialCharTok{$}\NormalTok{density}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{lapply}\NormalTok{(htmltools}\SpecialCharTok{::}\NormalTok{HTML)}

\FunctionTok{leaflet}\NormalTok{(states) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{setView}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{96}\NormalTok{, }\FloatTok{37.8}\NormalTok{, }\DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{addProviderTiles}\NormalTok{(}\StringTok{"MapBox"}\NormalTok{, }\AttributeTok{options =} \FunctionTok{providerTileOptions}\NormalTok{(}
    \AttributeTok{id =} \StringTok{"mapbox.light"}\NormalTok{,}
    \AttributeTok{accessToken =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{\textquotesingle{}MAPBOX\_ACCESS\_TOKEN\textquotesingle{}}\NormalTok{))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{addPolygons}\NormalTok{(}
    \AttributeTok{fillColor =} \SpecialCharTok{\textasciitilde{}}\FunctionTok{pal}\NormalTok{(density),}
    \AttributeTok{weight =} \DecValTok{2}\NormalTok{,}
    \AttributeTok{opacity =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{color =} \StringTok{"white"}\NormalTok{,}
    \AttributeTok{dashArray =} \StringTok{"3"}\NormalTok{,}
    \AttributeTok{fillOpacity =} \FloatTok{0.7}\NormalTok{,}
    \AttributeTok{highlight =} \FunctionTok{highlightOptions}\NormalTok{(}
      \AttributeTok{weight =} \DecValTok{5}\NormalTok{,}
      \AttributeTok{color =} \StringTok{"\#666"}\NormalTok{,}
      \AttributeTok{dashArray =} \StringTok{""}\NormalTok{,}
      \AttributeTok{fillOpacity =} \FloatTok{0.7}\NormalTok{,}
      \AttributeTok{bringToFront =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{label =}\NormalTok{ labels,}
    \AttributeTok{labelOptions =} \FunctionTok{labelOptions}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{list}\NormalTok{(}\StringTok{"font{-}weight"} \OtherTok{=} \StringTok{"normal"}\NormalTok{, }\AttributeTok{padding =} \StringTok{"3px 8px"}\NormalTok{),}
      \AttributeTok{textsize =} \StringTok{"15px"}\NormalTok{,}
      \AttributeTok{direction =} \StringTok{"auto"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{addLegend}\NormalTok{(}\AttributeTok{pal =}\NormalTok{ pal, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{density, }\AttributeTok{opacity =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{title =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{position =} \StringTok{"bottomright"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sp)}
\FunctionTok{data}\NormalTok{(meuse)}
\FunctionTok{coordinates}\NormalTok{(meuse) }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\NormalTok{x}\SpecialCharTok{+}\NormalTok{y}
\FunctionTok{proj4string}\NormalTok{(meuse) }\OtherTok{\textless{}{-}} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+init=epsg:28992"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(meuse)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sp)}
\FunctionTok{demo}\NormalTok{(meuse, }\AttributeTok{ask =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{echo =} \ConstantTok{FALSE}\NormalTok{) }\CommentTok{\# loads the meuse data sets}
\FunctionTok{library}\NormalTok{(maptools)}
\NormalTok{crs.longlat }\OtherTok{=} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+init=epsg:4326"}\NormalTok{)}
\NormalTok{meuse.longlat }\OtherTok{=} \FunctionTok{spTransform}\NormalTok{(meuse, crs.longlat)}
\FunctionTok{plot}\NormalTok{(meuse.longlat, }\AttributeTok{axes =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{library}\NormalTok{(mapview)}
\FunctionTok{library}\NormalTok{(rgdal) }\CommentTok{\# for readOGR}
\NormalTok{nc }\OtherTok{\textless{}{-}} \FunctionTok{readOGR}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"shapes/"}\NormalTok{, }\AttributeTok{package=}\StringTok{"maptools"}\NormalTok{), }\StringTok{"sids"}\NormalTok{)}
\FunctionTok{proj4string}\NormalTok{(nc) }\OtherTok{\textless{}{-}} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+proj=longlat +datum=NAD27"}\NormalTok{)}
\FunctionTok{class}\NormalTok{(nc)}
\FunctionTok{mapview}\NormalTok{(nc, }\AttributeTok{zcol =} \FunctionTok{c}\NormalTok{(}\StringTok{"SID74"}\NormalTok{, }\StringTok{"SID79"}\NormalTok{), }\AttributeTok{alpha.regions =} \FloatTok{1.0}\NormalTok{, }\AttributeTok{legend =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(RgoogleMaps)}
\FunctionTok{library}\NormalTok{(mapdeck)}
\FunctionTok{library}\NormalTok{(mapsf)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-gambia-malaria}{%
\section{冈比亚儿童疟疾}\label{sec-gambia-malaria}}

冈比亚地形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sp\_path }\OtherTok{\textless{}{-}} \StringTok{"data/"} \CommentTok{\# 存储临时地形文件}
\ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{dir.exists}\NormalTok{(sp\_path)) }\FunctionTok{dir.create}\NormalTok{(sp\_path, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# Gambia 海拔数据}
\NormalTok{gambia\_alt }\OtherTok{\textless{}{-}}\NormalTok{ raster}\SpecialCharTok{::}\FunctionTok{getData}\NormalTok{(}\AttributeTok{name =} \StringTok{"alt"}\NormalTok{, }\AttributeTok{country =} \StringTok{"GMB"}\NormalTok{, }\AttributeTok{mask =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{path =}\NormalTok{ sp\_path)}
\CommentTok{\# Gambia 市级行政边界数据}
\NormalTok{gambia\_map }\OtherTok{\textless{}{-}}\NormalTok{ raster}\SpecialCharTok{::}\FunctionTok{getData}\NormalTok{(}\StringTok{"GADM"}\NormalTok{, }\AttributeTok{country =} \StringTok{"GMB"}\NormalTok{, }\AttributeTok{level =} \DecValTok{2}\NormalTok{, }\AttributeTok{path =}\NormalTok{ sp\_path)}
\CommentTok{\# 绘制冈比亚地形}
\NormalTok{rasterVis}\SpecialCharTok{::}\FunctionTok{levelplot}\NormalTok{(gambia\_alt,}
  \AttributeTok{margin =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"Elevation"}\NormalTok{,}
  \AttributeTok{colorkey =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{space =} \StringTok{"top"}\NormalTok{,}
    \AttributeTok{labels =} \FunctionTok{list}\NormalTok{(}\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{to =} \DecValTok{65}\NormalTok{, }\AttributeTok{by =} \DecValTok{10}\NormalTok{)),}
    \AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{draw =} \ConstantTok{FALSE}\NormalTok{),}
  \AttributeTok{col.regions =}\NormalTok{ hcl.colors,}
  \AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{65}\NormalTok{, }\AttributeTok{len =} \DecValTok{101}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{+}
\NormalTok{  latticeExtra}\SpecialCharTok{::}\FunctionTok{layer}\NormalTok{(sp}\SpecialCharTok{::}\FunctionTok{sp.polygons}\NormalTok{(gambia\_map, }\AttributeTok{lwd =} \FloatTok{1.5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{spatial-analysis_files/figure-latex/gambia-altitude-1} 

}

\caption{冈比亚地形海拔数据}\label{fig:gambia-altitude}
\end{figure}

\href{https://rgdal.r-forge.r-project.org/}{rgdal} 包可以实现坐标变换

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载数据}
\FunctionTok{data}\NormalTok{(gambia, }\AttributeTok{package =} \StringTok{"geoR"}\NormalTok{)}
\CommentTok{\# 坐标变换}
\FunctionTok{library}\NormalTok{(sp)}
\NormalTok{sps }\OtherTok{\textless{}{-}} \FunctionTok{SpatialPoints}\NormalTok{(gambia[, }\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{)],}
  \AttributeTok{proj4string =} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+proj=utm +zone=28"}\NormalTok{)}
\NormalTok{)}
\NormalTok{spst }\OtherTok{\textless{}{-}} \FunctionTok{spTransform}\NormalTok{(sps, }\FunctionTok{CRS}\NormalTok{(}\StringTok{"+proj=longlat +datum=WGS84"}\NormalTok{))}
\NormalTok{gambia[, }\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{coordinates}\NormalTok{(spst)}
\CommentTok{\# 聚合数据}
\NormalTok{gambia\_agg }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}
  \AttributeTok{formula =} \FunctionTok{cbind}\NormalTok{(pos, netuse, treated) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{+}\NormalTok{ y }\SpecialCharTok{+}\NormalTok{ green }\SpecialCharTok{+}\NormalTok{ phc,}
  \AttributeTok{data =}\NormalTok{ gambia, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{sum}\NormalTok{(x) }\SpecialCharTok{/} \FunctionTok{length}\NormalTok{(x)}
\NormalTok{)}
\CommentTok{\# 抽取指定位置的海拔数据}
\CommentTok{\# raster::extract(gambia\_alt, gambia[, c("x", "y")])}
\end{Highlighting}
\end{Shaded}

\(Y \sim b(1,p)\) 每个人检验结果，就是感染 1 或是没有感染 0，感染率 \(p\) 的建模分析，个体水平

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(mapdeck)}
\CommentTok{\# 多边形}
\FunctionTok{mapdeck}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_polygon}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ spatialwidget}\SpecialCharTok{::}\NormalTok{widget\_melbourne, }
    \AttributeTok{fill\_colour =} \StringTok{"SA2\_NAME"}\NormalTok{,}
    \AttributeTok{palette =} \StringTok{"spectral"}
\NormalTok{  )}

\FunctionTok{mapdeck}\NormalTok{( }\AttributeTok{location =} \FunctionTok{c}\NormalTok{(}\DecValTok{145}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{37.8}\NormalTok{), }\AttributeTok{zoom =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_geojson}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ mapdeck}\SpecialCharTok{::}\NormalTok{geojson}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://github.com/geodacenter/rgeoda/}
\FunctionTok{library}\NormalTok{(rgeoda)}
\FunctionTok{library}\NormalTok{(sf)}

\NormalTok{guerry\_path }\OtherTok{\textless{}{-}} \FunctionTok{system.file}\NormalTok{(}\StringTok{"extdata"}\NormalTok{, }\StringTok{"Guerry.shp"}\NormalTok{, }\AttributeTok{package =} \StringTok{"rgeoda"}\NormalTok{)}
\NormalTok{guerry }\OtherTok{\textless{}{-}} \FunctionTok{st\_read}\NormalTok{(guerry\_path)}

\NormalTok{crm\_prp }\OtherTok{=}\NormalTok{ guerry[}\StringTok{"Crm\_prp"}\NormalTok{]}
\NormalTok{queen\_w }\OtherTok{\textless{}{-}} \FunctionTok{queen\_weights}\NormalTok{(guerry)}

\NormalTok{lisa }\OtherTok{\textless{}{-}} \FunctionTok{local\_moran}\NormalTok{(queen\_w, crm\_prp)}

\NormalTok{lisa\_colors }\OtherTok{\textless{}{-}} \FunctionTok{lisa\_colors}\NormalTok{(lisa)}
\NormalTok{lisa\_labels }\OtherTok{\textless{}{-}} \FunctionTok{lisa\_labels}\NormalTok{(lisa)}
\NormalTok{lisa\_clusters }\OtherTok{\textless{}{-}} \FunctionTok{lisa\_clusters}\NormalTok{(lisa)}

\FunctionTok{plot}\NormalTok{(}\FunctionTok{st\_geometry}\NormalTok{(guerry),}
     \AttributeTok{col =} \FunctionTok{sapply}\NormalTok{(lisa\_clusters, }\ControlFlowTok{function}\NormalTok{(x) \{}
       \FunctionTok{return}\NormalTok{(lisa\_colors[[x }\SpecialCharTok{+} \DecValTok{1}\NormalTok{]])}
\NormalTok{     \}),}
     \AttributeTok{border =} \StringTok{"\#333333"}\NormalTok{, }\AttributeTok{lwd =} \FloatTok{0.2}
\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Local Moran Map of Crm\_prs"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{,}
       \AttributeTok{legend =}\NormalTok{ lisa\_labels,}
       \AttributeTok{fill =}\NormalTok{ lisa\_colors, }\AttributeTok{border =} \StringTok{"\#eeeeee"}
\NormalTok{)}


\FunctionTok{library}\NormalTok{(spData)}

\FunctionTok{library}\NormalTok{(sf)}
\NormalTok{wheat }\OtherTok{\textless{}{-}} \FunctionTok{st\_read}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"shapes/wheat.shp"}\NormalTok{, }\AttributeTok{package=}\StringTok{"spData"}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(wheat)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-spatial-analysis-session}{%
\section{运行环境}\label{sec-spatial-analysis-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] sfarrow_0.4.0       sf_1.0-2            rasterVis_0.50.3   
## [4] terra_1.3-22        latticeExtra_0.6-29 lattice_0.20-45    
## [7] raster_3.4-13       RColorBrewer_1.1-2  sp_1.4-5           
## 
## loaded via a namespace (and not attached):
##  [1] zoo_1.8-9          tidyselect_1.1.1   xfun_0.26          purrr_0.3.4       
##  [5] vctrs_0.3.8        generics_0.1.0     htmltools_0.5.2    viridisLite_0.4.0 
##  [9] yaml_2.2.1         utf8_1.2.2         rlang_0.4.11       e1071_1.7-9       
## [13] hexbin_1.28.2      pillar_1.6.3       glue_1.4.2         DBI_1.1.1         
## [17] jpeg_0.1-9         lifecycle_1.0.1    stringr_1.4.0      codetools_0.2-18  
## [21] evaluate_0.14      knitr_1.36         fastmap_1.1.0      parallel_4.1.1    
## [25] curl_4.3.2         class_7.3-19       fansi_0.5.0        Rcpp_1.0.7        
## [29] KernSmooth_2.23-20 classInt_0.4-3     png_0.1-7          digest_0.6.28     
## [33] stringi_1.7.4      bookdown_0.24      dplyr_1.0.7        grid_4.1.1        
## [37] rgdal_1.5-27       tools_4.1.1        magrittr_2.0.1     proxy_0.4-26      
## [41] tibble_3.1.5       crayon_1.4.1       pkgconfig_2.0.3    ellipsis_0.3.2    
## [45] assertthat_0.2.1   rmarkdown_2.11     R6_2.5.1           units_0.7-2       
## [49] compiler_4.1.1
\end{verbatim}

\hypertarget{chap-spatial-modeling}{%
\chapter{空间数据建模}\label{chap-spatial-modeling}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(geoR)}
\CommentTok{\# library(INLA)}
\FunctionTok{library}\NormalTok{(leaflet)}
\FunctionTok{library}\NormalTok{(highcharter)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-cameroon-eyeworm}{%
\section{西非眼线虫病}\label{sec-cameroon-eyeworm}}

loaloa 眼线虫病，人群感染，村庄水平， 响应变量服从二项分布 \(Y \sim b(n,p)\)，每个村庄感染的人数 \(Y_i \sim b(n_i, p_i)\) 其中 \(n_i\) 是第 \(i\) 个村庄调查的人数， \(p_i\) 是观测的感染率

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"loaloa"}\NormalTok{, }\AttributeTok{package =} \StringTok{"PrevMap"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hcmap}\NormalTok{(}\AttributeTok{map =} \StringTok{"countries/cm/cm{-}all.js"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{hc\_title}\NormalTok{(}\AttributeTok{text =} \StringTok{"喀麦隆及其周边地区眼线虫病流行度"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-spatial-modeling-session}{%
\section{运行环境}\label{sec-spatial-modeling-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
## [1] highcharter_0.8.2 leaflet_2.0.4.1   geoR_1.8-1        INLA_21.02.23    
## [5] sp_1.4-5          foreach_1.5.1     Matrix_1.3-4     
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.7              lubridate_1.7.10        lattice_0.20-45        
##  [4] tidyr_1.1.4             zoo_1.8-9               assertthat_0.2.1       
##  [7] digest_0.6.28           utf8_1.2.2              R6_2.5.1               
## [10] RandomFields_3.3.10     backports_1.2.1         evaluate_0.14          
## [13] pillar_1.6.3            rlang_0.4.11            curl_4.3.2             
## [16] data.table_1.14.2       TTR_0.24.2              rmarkdown_2.11         
## [19] splines_4.1.1           stringr_1.4.0           htmlwidgets_1.5.4      
## [22] igraph_1.2.6            broom_0.7.9             compiler_4.1.1         
## [25] xfun_0.26               pkgconfig_2.0.3         htmltools_0.5.2        
## [28] tcltk_4.1.1             tidyselect_1.1.1        tibble_3.1.5           
## [31] bookdown_0.24           codetools_0.2-18        fansi_0.5.0            
## [34] crayon_1.4.1            dplyr_1.0.7             MASS_7.3-54            
## [37] grid_4.1.1              jsonlite_1.7.2          lifecycle_1.0.1        
## [40] DBI_1.1.1               magrittr_2.0.1          rlist_0.4.6.2          
## [43] quantmod_0.4.18         stringi_1.7.4           ellipsis_0.3.2         
## [46] xts_0.12.1              generics_0.1.0          vctrs_0.3.8            
## [49] iterators_1.0.13        tools_4.1.1             glue_1.4.2             
## [52] purrr_0.3.4             splancs_2.01-42         crosstalk_1.1.1        
## [55] fastmap_1.1.0           yaml_2.2.1              knitr_1.36             
## [58] RandomFieldsUtils_0.5.4
\end{verbatim}

\hypertarget{chap-spatial-viz}{%
\chapter{空间数据可视化}\label{chap-spatial-viz}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sp)}
\FunctionTok{library}\NormalTok{(rgdal)}
\FunctionTok{library}\NormalTok{(maps)}
\FunctionTok{library}\NormalTok{(mapproj)}
\FunctionTok{library}\NormalTok{(maptools)}
\FunctionTok{library}\NormalTok{(sf)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(raster)}
\FunctionTok{library}\NormalTok{(abind)}
\FunctionTok{library}\NormalTok{(cubelyr)}
\FunctionTok{library}\NormalTok{(stars)}
\FunctionTok{library}\NormalTok{(echarts4r)}
\FunctionTok{library}\NormalTok{(ggthemes)}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/Jianghao}{王江浩} \href{https://www.beijingcitylab.com/}{北京城市实验室}

Robert J. Hijmans \footnote{Department of Environmental Science and Policy at the University of California, Davis. \href{https://biogeo.ucdavis.edu/}{Ecology, Geography, and Agriculture}} 开发了 \href{https://github.com/rspatial/raster}{raster} 包用于网格空间数据的读、写、操作、分析和建模，同时维护了空间数据分析的网站 \url{https://www.rspatial.org}。Edzer Pebesma \footnote{Institute for Geoinformatics of the University of Münster.} 和 Roger Bivand 等创建了 \href{https://github.com/edzer/sp/}{sp} 包定义了空间数据类型和方法，提供了大量的空间数据操作方法，同时维护了空间数据对象 sp 的绘图网站 \url{https://edzer.github.io/sp/}，他们也一起合作写了新书 \href{https://keen-swartz-3146c4.netlify.com/}{Spatial Data Science}，提供了在线 \href{https://www.r-spatial.org/book/}{网页版} 书籍及其 \href{https://github.com/edzer/sdsr}{源代码}。Edzer Pebesma 后来开发了 \href{https://github.com/r-spatial/sf/}{sf} 包重新定义了空间数据对象和操作方法，并维护了空间数据分析、建模和可视化网站 \url{https://www.r-spatial.org/}

课程案例学习

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \href{https://datacarpentry.org/r-raster-vector-geospatial/}{2018-Introduction to Geospatial Raster and Vector Data with R} 空间数据分析课程
\item
  \href{http://freerangestats.info}{Peter Ellis} 新西兰大选和普查数据 \href{http://freerangestats.info/blog/nz.html}{More cartograms of New Zealand census data: district and city level}
\item
  \href{http://sharpsightlabs.com/blog/map-oil-production-country-r/}{2017-Mapping oil production by country in R} 石油产量在全球的分布
\item
  \href{https://www.sharpsightlabs.com/blog/highlight-countries-on-map/}{2017-How to highlight countries on a map} 高亮地图上的国家
\item
  \href{https://ryanpeek.github.io/2017-11-21-mapping-with-sf-part-3/}{2017-Mapping With Sf: Part 3}
\item
  \href{https://ignaciomsarmiento.github.io/software.html}{Data Visualization Shiny Apps} 数据可视化核密度估计 In this app I identify crime hotspots using a bivariate density estimation strategy
\item
  \href{http://www.rpubs.com/cgarey/ProjectOneFinal}{Association of Statisticians of American Religious Bodies (ASARB) viridis USA map}
\item
  \href{https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page}{出租车行车轨迹数据}
\item
  \href{https://carto.com/blog/geospatial-processing-with-clickhouse/}{Geospatial processing with Clickhouse-CARTO Blog}
\end{enumerate}

\hypertarget{sec-spatial-data}{%
\section{空间数据}\label{sec-spatial-data}}

空间数据存储在数据库中，比如 \href{https://postgis.net/}{PostGIS}，它是对象关系数据库 \href{https://postgresql.org/}{PostgreSQL} 在空间数据库方面的扩展。

\hypertarget{subsec-dataframe}{%
\subsection{data.frame}\label{subsec-dataframe}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"quakes"}\NormalTok{)}
\NormalTok{quakes}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         lat   long depth mag stations
## 1    -20.42 181.62   562 4.8       41
## 2    -20.62 181.03   650 4.2       15
## 3    -26.00 184.10    42 5.4       43
## 4    -17.97 181.66   626 4.1       19
## 5    -20.42 181.96   649 4.0       11
....
\end{verbatim}

\hypertarget{subsec-sp}{%
\subsection{sp}\label{subsec-sp}}

\href{https://edzer.github.io/sp/}{sp-gallery}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sp)}
\end{Highlighting}
\end{Shaded}

空间数据对象，以类 sp 方式存储 \citep{Pebesma_2005_sp}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sp)}
\FunctionTok{data}\NormalTok{(}\StringTok{"meuse"}\NormalTok{)}
\FunctionTok{coordinates}\NormalTok{(meuse) }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\NormalTok{x}\SpecialCharTok{+}\NormalTok{y}
\FunctionTok{proj4string}\NormalTok{(meuse) }\OtherTok{\textless{}{-}} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+init=epsg:28992"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO", prefer_proj =
## prefer_proj): Discarded datum Amersfoort in Proj4 definition
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(meuse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "SpatialPointsDataFrame"
## attr(,"package")
## [1] "sp"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{proj4string}\NormalTok{(meuse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in proj4string(meuse): CRS object has comment, which is lost in output
\end{verbatim}

\begin{verbatim}
## [1] "+proj=sterea +lat_0=52.1561605555556 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +no_defs"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(meuse, }\AttributeTok{axes =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.5833\linewidth]{spatial-viz_files/figure-latex/unnamed-chunk-5-1} 

}

\caption{sp 对象}\label{fig:unnamed-chunk-5}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rgdal)}
\NormalTok{crs.longlat }\OtherTok{\textless{}{-}} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+init=epsg:4326"}\NormalTok{)}
\NormalTok{meuse.longlat }\OtherTok{\textless{}{-}} \FunctionTok{spTransform}\NormalTok{(meuse, crs.longlat)}
\FunctionTok{plot}\NormalTok{(meuse.longlat, }\AttributeTok{axes =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.5833\linewidth]{spatial-viz_files/figure-latex/unnamed-chunk-6-1} 

}

\caption{sp 对象}\label{fig:unnamed-chunk-6}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(maptools)}
\NormalTok{fname }\OtherTok{\textless{}{-}} \FunctionTok{system.file}\NormalTok{(}\StringTok{"shapes/sids.shp"}\NormalTok{, }\AttributeTok{package =} \StringTok{"maptools"}\NormalTok{)}
\NormalTok{p4s }\OtherTok{\textless{}{-}} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+proj=longlat +datum=NAD27"}\NormalTok{)}
\NormalTok{nc }\OtherTok{\textless{}{-}} \FunctionTok{readShapePoly}\NormalTok{(fname, }\AttributeTok{proj4string =}\NormalTok{ p4s)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: readShapePoly is deprecated; use rgdal::readOGR or sf::st_read
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(nc, }\AttributeTok{axes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{grey}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ nc}\SpecialCharTok{$}\NormalTok{SID79 }\SpecialCharTok{/} \DecValTok{57}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{spatial-viz_files/figure-latex/unnamed-chunk-7-1} \end{center}

\begin{rmdwarn}{警告}
maptools 提供的 \texttt{readShapePoly} 函数去读取 shp 文件的方式已经过时，推荐使用 \texttt{rgdal::readOGR} 或者 \texttt{sf::st\_read} 方式读取

\end{rmdwarn}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Trellis maps}
\NormalTok{arrow }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"SpatialPolygonsRescale"}\NormalTok{,}
  \FunctionTok{layout.north.arrow}\NormalTok{(}\DecValTok{2}\NormalTok{),}
  \AttributeTok{offset =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{76}\NormalTok{, }\DecValTok{34}\NormalTok{), }\AttributeTok{scale =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{which =} \DecValTok{2}
\NormalTok{)}
\FunctionTok{spplot}\NormalTok{(nc, }\FunctionTok{c}\NormalTok{(}\StringTok{"SID74"}\NormalTok{, }\StringTok{"SID79"}\NormalTok{),}
  \AttributeTok{as.table =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{draw =}\NormalTok{ T), }\AttributeTok{sp.layout =}\NormalTok{ arrow}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{spatial-viz_files/figure-latex/unnamed-chunk-8-1} \end{center}

\hypertarget{subsec-sf}{%
\subsection{sf}\label{subsec-sf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sf)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{nc }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"gpkg/nc.gpkg"}\NormalTok{, }\AttributeTok{package =} \StringTok{"sf"}\NormalTok{))}
\NormalTok{nc2 }\OtherTok{\textless{}{-}}\NormalTok{ nc }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(SID74, SID79) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  tidyr}\SpecialCharTok{::}\FunctionTok{gather}\NormalTok{(VAR, SID, }\SpecialCharTok{{-}}\NormalTok{geom)}
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ nc2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ SID)) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{VAR, }\AttributeTok{ncol =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{spatial-viz_files/figure-latex/unnamed-chunk-9-1} \end{center}

\hypertarget{subsec-raster}{%
\subsection{raster}\label{subsec-raster}}

raster 包定义了获取和操作空间 raster 类型数据集的类和方法，rasterVis 补充加强了 raster 包在数据可视化和交互方面的功能。可视化是基于 lattice 的

\href{https://github.com/rspatial/raster}{raster} 包的开发已经被作者 \href{https://desp.ucdavis.edu/people/robert-j-hijmans}{Robert J. Hijmans} 迁移到 Github 上啦，官方文档 \url{https://www.rspatial.org/}

星号 * 标记的是 S3 方法

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{methods}\NormalTok{(plot)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] plot,ANY,ANY-method                       
##  [2] plot,color,ANY-method                     
##  [3] plot,Extent,missing-method                
##  [4] plot,Raster,ANY-method                    
##  [5] plot,Raster,Raster-method                 
##  [6] plot,Spatial,missing-method               
##  [7] plot,SpatialGrid,missing-method           
##  [8] plot,SpatialGridDataFrame,missing-method  
##  [9] plot,SpatialLines,missing-method          
## [10] plot,SpatialMultiPoints,missing-method    
## [11] plot,SpatialPixels,missing-method         
## [12] plot,SpatialPixelsDataFrame,missing-method
## [13] plot,SpatialPoints,missing-method         
## [14] plot,SpatialPolygons,missing-method       
## [15] plot.acf*                                 
## [16] plot.bclust*                              
## [17] plot.classIntervals*                      
## [18] plot.data.frame*                          
## [19] plot.decomposed.ts*                       
## [20] plot.default                              
## [21] plot.dendrogram*                          
## [22] plot.density*                             
## [23] plot.ecdf                                 
## [24] plot.factor*                              
## [25] plot.formula*                             
## [26] plot.function                             
## [27] plot.ggplot*                              
## [28] plot.gtable*                              
## [29] plot.hcl_palettes*                        
## [30] plot.hclust*                              
## [31] plot.histogram*                           
## [32] plot.HoltWinters*                         
## [33] plot.ica*                                 
## [34] plot.isoreg*                              
## [35] plot.lm*                                  
## [36] plot.medpolish*                           
## [37] plot.mlm*                                 
## [38] plot.ppr*                                 
## [39] plot.prcomp*                              
## [40] plot.princomp*                            
## [41] plot.profile.nls*                         
## [42] plot.R6*                                  
## [43] plot.raster*                              
## [44] plot.sf*                                  
## [45] plot.sfc_CIRCULARSTRING*                  
## [46] plot.sfc_GEOMETRY*                        
## [47] plot.sfc_GEOMETRYCOLLECTION*              
## [48] plot.sfc_LINESTRING*                      
## [49] plot.sfc_MULTILINESTRING*                 
## [50] plot.sfc_MULTIPOINT*                      
## [51] plot.sfc_MULTIPOLYGON*                    
## [52] plot.sfc_POINT*                           
## [53] plot.sfc_POLYGON*                         
## [54] plot.sfg*                                 
## [55] plot.shingle*                             
## [56] plot.SOM*                                 
## [57] plot.somgrid*                             
## [58] plot.spec*                                
## [59] plot.stars*                               
## [60] plot.stars_proxy*                         
## [61] plot.stepfun                              
## [62] plot.stft*                                
## [63] plot.stl*                                 
## [64] plot.svm*                                 
## [65] plot.table*                               
## [66] plot.trans*                               
## [67] plot.trellis*                             
## [68] plot.ts                                   
## [69] plot.tskernel*                            
## [70] plot.TukeyHSD*                            
## [71] plot.tune*                                
## [72] plot.units*                               
## [73] plot.wk_crc*                              
## [74] plot.wk_rct*                              
## [75] plot.wk_wkb*                              
## [76] plot.wk_wkt*                              
## [77] plot.wk_xy*                               
## see '?methods' for accessing help and source code
\end{verbatim}

查看函数的定义

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{getAnywhere}\NormalTok{(plot.raster)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## A single object matching 'plot.raster' was found
## It was found in the following places
##   registered S3 method for plot from namespace graphics
##   namespace:graphics
## with value
## 
## function (x, y, xlim = c(0, ncol(x)), ylim = c(0, nrow(x)), xaxs = "i", 
##     yaxs = "i", asp = 1, add = FALSE, ...) 
## {
##     if (!add) {
##         plot.new()
##         plot.window(xlim = xlim, ylim = ylim, asp = asp, xaxs = xaxs, 
##             yaxs = yaxs)
##     }
##     rasterImage(x, 0, 0, ncol(x), nrow(x), ...)
## }
## <bytecode: 0x5588ba0cfb98>
## <environment: namespace:graphics>
\end{verbatim}

rasterImage 函数来绘制图像，如果想知道 \texttt{rasterImage} 的内容可以继续看 \texttt{getAnywhere(rasterImage)}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{getAnywhere}\NormalTok{(rasterImage)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## A single object matching 'rasterImage' was found
## It was found in the following places
##   package:graphics
##   namespace:graphics
## with value
## 
## function (image, xleft, ybottom, xright, ytop, angle = 0, interpolate = TRUE, 
##     ...) 
## {
##     .External.graphics(C_raster, if (inherits(image, "nativeRaster")) image else as.raster(image), 
##         as.double(xleft), as.double(ybottom), as.double(xright), 
##         as.double(ytop), as.double(angle), as.logical(interpolate), 
##         ...)
##     invisible()
## }
## <bytecode: 0x5588ba44e780>
## <environment: namespace:graphics>
\end{verbatim}

通过查看函数的帮助 \texttt{?rasterImage} ，我们需要重点关注一下 参数 \emph{image} 传递的 raster 对象

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{250}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{300}\NormalTok{, }\DecValTok{450}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{)}
\NormalTok{image }\OtherTok{\textless{}{-}} \FunctionTok{as.raster}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{5}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{3}\NormalTok{))}
\FunctionTok{rasterImage}\NormalTok{(image, }\DecValTok{100}\NormalTok{, }\DecValTok{300}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{350}\NormalTok{, }\AttributeTok{interpolate =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{rasterImage}\NormalTok{(image, }\DecValTok{100}\NormalTok{, }\DecValTok{400}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{450}\NormalTok{)}
\FunctionTok{rasterImage}\NormalTok{(image, }\DecValTok{200}\NormalTok{, }\DecValTok{300}\NormalTok{, }\DecValTok{200} \SpecialCharTok{+} \FunctionTok{xinch}\NormalTok{(.}\DecValTok{5}\NormalTok{), }\DecValTok{300} \SpecialCharTok{+} \FunctionTok{yinch}\NormalTok{(.}\DecValTok{3}\NormalTok{),}
  \AttributeTok{interpolate =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{rasterImage}\NormalTok{(image, }\DecValTok{200}\NormalTok{, }\DecValTok{400}\NormalTok{, }\DecValTok{250}\NormalTok{, }\DecValTok{450}\NormalTok{, }
            \AttributeTok{angle =} \DecValTok{15}\NormalTok{, }\AttributeTok{interpolate =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.5\linewidth]{spatial-viz_files/figure-latex/unnamed-chunk-13-1} 

}

\caption{raster 图像}\label{fig:unnamed-chunk-13}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(raster)}
\NormalTok{meuse.test }\OtherTok{\textless{}{-}} \FunctionTok{raster}\NormalTok{(}\AttributeTok{x =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"external/test.grd"}\NormalTok{, }\AttributeTok{package=}\StringTok{"raster"}\NormalTok{))}
\FunctionTok{class}\NormalTok{(meuse.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "RasterLayer"
## attr(,"package")
## [1] "raster"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(meuse.test, }\AttributeTok{legend =}\NormalTok{ F)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{spatial-viz_files/figure-latex/unnamed-chunk-15-1} 

}

\caption{raster 对象}\label{fig:unnamed-chunk-15}
\end{figure}

\hypertarget{subsec-stars}{%
\subsection{stars}\label{subsec-stars}}

Edzer Pebesma 开发了 stars 包

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://resources.rstudio.com/rstudio{-}conf{-}2019/spatial{-}data{-}science{-}in{-}the{-}tidyverse}
\FunctionTok{library}\NormalTok{(abind)}
\FunctionTok{library}\NormalTok{(sf)}
\FunctionTok{library}\NormalTok{(cubelyr)}
\FunctionTok{library}\NormalTok{(stars)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read\_stars}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"tif/L7\_ETMs.tif"}\NormalTok{, }\AttributeTok{package =} \StringTok{"stars"}\NormalTok{))}

\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_stars}\NormalTok{(}\AttributeTok{data =}\NormalTok{ x) }\SpecialCharTok{+}
  \FunctionTok{coord\_equal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{band) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_discrete}\NormalTok{(}\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_discrete}\NormalTok{(}\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{spatial-viz_files/figure-latex/unnamed-chunk-16-1} \end{center}

\hypertarget{sec-viz-echarts4r}{%
\section{可视化}\label{sec-viz-echarts4r}}

\hypertarget{subsec-fiji-quakes}{%
\subsection{斐济地震带分布}\label{subsec-fiji-quakes}}

相比于 \textbf{plotly}，\textbf{echarts4r} 更加轻量，这得益于 JavaScript 库 \href{https://github.com/apache/echarts}{Apache ECharts}。 前者 MIT 协议，后者采用 Apache-2.0 协议，都可以商用。Apache ECharts 是 Apache 旗下顶级开源项目，由百度前端技术团队贡献，中文文档也比较全，学习起来门槛会低一些。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(echarts4r)}
\NormalTok{quakes }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_charts}\NormalTok{(}\AttributeTok{x =}\NormalTok{ long) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_geo}\NormalTok{(}
    \AttributeTok{roam =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{boundingCoords =} \FunctionTok{list}\NormalTok{(}
      \FunctionTok{c}\NormalTok{(}\DecValTok{185}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{),}
      \FunctionTok{c}\NormalTok{(}\DecValTok{165}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{40}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_scatter}\NormalTok{(}
    \AttributeTok{serie =}\NormalTok{ lat,}
    \AttributeTok{size =}\NormalTok{ mag, }\CommentTok{\# 点的大小映射到震级}
    \CommentTok{\# legend = F, \# 是否移除图例}
    \AttributeTok{name =} \StringTok{"斐济地震带"}\NormalTok{,}
    \AttributeTok{coord\_system =} \StringTok{"geo"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_visual\_map}\NormalTok{(}
    \AttributeTok{serie =}\NormalTok{ mag, }\AttributeTok{scale =}\NormalTok{ e\_scale,}
    \AttributeTok{inRange =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{10}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_tooltip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-usa-unemp}{%
\subsection{美国各城镇失业率}\label{subsec-usa-unemp}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据来源 https://datasets.flowingdata.com/unemployment09.csv}
\NormalTok{unemp }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}
  \AttributeTok{file =} \StringTok{"http://datasets.flowingdata.com/unemployment09.csv"}\NormalTok{,}
  \AttributeTok{header =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{names}\NormalTok{(unemp) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"id"}\NormalTok{, }\StringTok{"state\_fips"}\NormalTok{, }\StringTok{"county\_fips"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"year"}\NormalTok{,}
  \StringTok{"?"}\NormalTok{, }\StringTok{"?"}\NormalTok{, }\StringTok{"?"}\NormalTok{, }\StringTok{"rate"}
\NormalTok{)}
\NormalTok{unemp}\SpecialCharTok{$}\NormalTok{county }\OtherTok{\textless{}{-}} \FunctionTok{tolower}\NormalTok{(}\FunctionTok{gsub}\NormalTok{(}\StringTok{" County, [A{-}Z]\{2\}"}\NormalTok{, }\StringTok{""}\NormalTok{, unemp}\SpecialCharTok{$}\NormalTok{name))}
\NormalTok{unemp}\SpecialCharTok{$}\NormalTok{state }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}.*([A{-}Z]\{2\}).*$"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, unemp}\SpecialCharTok{$}\NormalTok{name)}

\NormalTok{county\_df }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"county"}\NormalTok{)}
\FunctionTok{names}\NormalTok{(county\_df) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"long"}\NormalTok{, }\StringTok{"lat"}\NormalTok{, }\StringTok{"group"}\NormalTok{, }\StringTok{"order"}\NormalTok{, }\StringTok{"state\_name"}\NormalTok{, }\StringTok{"county"}\NormalTok{)}
\NormalTok{county\_df}\SpecialCharTok{$}\NormalTok{state }\OtherTok{\textless{}{-}}\NormalTok{ state.abb[}\FunctionTok{match}\NormalTok{(county\_df}\SpecialCharTok{$}\NormalTok{state\_name, }\FunctionTok{tolower}\NormalTok{(state.name))]}
\NormalTok{county\_df}\SpecialCharTok{$}\NormalTok{state\_name }\OtherTok{\textless{}{-}} \ConstantTok{NULL}

\NormalTok{state\_df }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"state"}\NormalTok{)}
\CommentTok{\# Combine together}
\NormalTok{choropleth }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(county\_df, unemp, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"state"}\NormalTok{, }\StringTok{"county"}\NormalTok{))}
\NormalTok{choropleth }\OtherTok{\textless{}{-}}\NormalTok{ choropleth[}\FunctionTok{order}\NormalTok{(choropleth}\SpecialCharTok{$}\NormalTok{order), ]}
\NormalTok{choropleth}\SpecialCharTok{$}\NormalTok{rate\_d }\OtherTok{\textless{}{-}} \FunctionTok{cut}\NormalTok{(choropleth}\SpecialCharTok{$}\NormalTok{rate, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{by =} \DecValTok{2}\NormalTok{), }\DecValTok{35}\NormalTok{))}

\FunctionTok{library}\NormalTok{(ggthemes)}
\FunctionTok{ggplot}\NormalTok{(choropleth, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ rate\_d), }\AttributeTok{colour =} \FunctionTok{alpha}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\DecValTok{1} \SpecialCharTok{/} \DecValTok{4}\NormalTok{), }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{data =}\NormalTok{ state\_df, }\AttributeTok{colour =} \StringTok{"white"}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{NA}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"PuRd"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{fill =} \StringTok{"ratio"}\NormalTok{, }\AttributeTok{title =} \StringTok{"ratio of unemployment by county, 2009"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"data source: http://datasets.flowingdata.com/unemployment09.csv"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}\StringTok{"polyconic"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_map}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{spatial-viz_files/figure-latex/unemploymentGG-1} 

}

\caption{2009年美国各城镇失业率}\label{fig:unemploymentGG}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 来自帮助文档 ?map }
\FunctionTok{library}\NormalTok{(mapproj)    }\CommentTok{\# mapproj is used for  projection="polyconic"}
\CommentTok{\# color US county map by 2009 unemployment rate}
\CommentTok{\# match counties to map using FIPS county codes}
\CommentTok{\# Based on J\textquotesingle{}s solution to the "Choropleth Challenge"}
\CommentTok{\# http://blog.revolutionanalytics.com/2009/11/choropleth{-}challenge{-}result.html}

\CommentTok{\# load data}
\CommentTok{\# unemp includes data for some counties not on the "lower 48 states" county}
\CommentTok{\# map, such as those in Alaska, Hawaii, Puerto Rico, and some tiny Virginia cities}
\FunctionTok{data}\NormalTok{(unemp)}
\FunctionTok{data}\NormalTok{(county.fips)}

\CommentTok{\# define color buckets}
\NormalTok{colors }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\#F1EEF6"}\NormalTok{, }\StringTok{"\#D4B9DA"}\NormalTok{, }\StringTok{"\#C994C7"}\NormalTok{, }\StringTok{"\#DF65B0"}\NormalTok{, }\StringTok{"\#DD1C77"}\NormalTok{, }\StringTok{"\#980043"}\NormalTok{)}
\NormalTok{unemp}\SpecialCharTok{$}\NormalTok{colorBuckets }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{cut}\NormalTok{(unemp}\SpecialCharTok{$}\NormalTok{unemp, }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{)))}
\NormalTok{leg.txt }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}2\%"}\NormalTok{, }\StringTok{"2{-}4\%"}\NormalTok{, }\StringTok{"4{-}6\%"}\NormalTok{, }\StringTok{"6{-}8\%"}\NormalTok{, }\StringTok{"8{-}10\%"}\NormalTok{, }\StringTok{"\textgreater{}10\%"}\NormalTok{)}

\CommentTok{\# align data with map definitions by (partial) matching state,county}
\CommentTok{\# names, which include multiple polygons for some counties}
\NormalTok{cnty.fips }\OtherTok{\textless{}{-}}\NormalTok{ county.fips}\SpecialCharTok{$}\NormalTok{fips[}\FunctionTok{match}\NormalTok{(}
  \FunctionTok{map}\NormalTok{(}\StringTok{"county"}\NormalTok{, }\AttributeTok{plot =} \ConstantTok{FALSE}\NormalTok{)}\SpecialCharTok{$}\NormalTok{names,}
\NormalTok{  county.fips}\SpecialCharTok{$}\NormalTok{polyname}
\NormalTok{)]}
\NormalTok{colorsmatched }\OtherTok{\textless{}{-}}\NormalTok{ unemp}\SpecialCharTok{$}\NormalTok{colorBuckets[}\FunctionTok{match}\NormalTok{(cnty.fips, unemp}\SpecialCharTok{$}\NormalTok{fips)]}

\CommentTok{\# draw map}
\FunctionTok{map}\NormalTok{(}\StringTok{"county"}\NormalTok{,}
  \AttributeTok{col =}\NormalTok{ colors[colorsmatched], }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{resolution =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{lty =} \DecValTok{0}\NormalTok{, }\AttributeTok{projection =} \StringTok{"polyconic"}
\NormalTok{)}
\FunctionTok{map}\NormalTok{(}\StringTok{"state"}\NormalTok{,}
  \AttributeTok{col =} \StringTok{"white"}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{lwd =} \FloatTok{0.2}\NormalTok{,}
  \AttributeTok{projection =} \StringTok{"polyconic"}
\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\StringTok{"unemployment by county, 2009"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topright"}\NormalTok{, leg.txt, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ colors)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{spatial-viz_files/figure-latex/unnamed-chunk-17-1} \end{center}

美国各地区失业率地图，配不同颜色， \href{https://github.com/bhaskarvk/colormap}{colormap} 适合给静态图配色

\hypertarget{chap-case-study}{%
\chapter{案例研究}\label{chap-case-study}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(gganimate)}

\FunctionTok{library}\NormalTok{(formattable)}
\FunctionTok{library}\NormalTok{(packagemetrics)}
\end{Highlighting}
\end{Shaded}

提升回归模型的10个提示 \href{https://statmodeling.stat.columbia.edu/wp-content/uploads/2020/07/raos_tips.pdf}{10 quick tips to improve your regression modeling}

\href{https://github.com/tidymodels/tidymodels}{tidymodels} 和 \href{https://github.com/easystats/easystats}{easystats} 都是基于 \href{https://github.com/tidyverse/tidyverse}{tidyverse} \citep{Hadley_2019_tidyverse} 的统计模型套件，\href{https://github.com/strengejacke/strengejacke}{strengejacke}、 \href{https://github.com/mlr-org/mlr3verse}{mlr3verse} 目的和 tidymodels 差不多，都是提供做数据建模的完整解决方案，区别在于它不基于 tidyverse 这套东西。

\href{https://github.com/easystats/easystats}{easystats} 包含 \href{https://github.com/easystats/insight}{insight} \citep{ludecke2019insight} 和 \href{https://github.com/easystats/bayestestR}{bayestestR} \citep{makowski2019bayestestr} 等共 9 个R 包，\href{https://github.com/tidymodels/tidymodels}{tidymodels} 也包含差不多量的 R 包。 \href{https://github.com/ModelOriented/DrWhy}{DrWhy} \href{https://github.com/harrelfe/rms}{rms} Regression Modeling Strategies

\href{https://github.com/ddsjoberg/gtsummary}{gtsummary} \href{https://github.com/vincentarelbundock/modelsummary}{modelsummary} 整理模型输出，提供丰富的格式输出，如 PDF, Text/Markdown, LaTeX, MS Word, RTF, JPG, and PNG.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\FunctionTok{library}\NormalTok{(modelsummary)}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/rfordatascience}{R for Data Science Online Learning Community} 在线学习社区以 \href{https://github.com/rfordatascience/tidytuesday}{tidytuesday} 闻名遐迩。

\begin{verbatim}
#padding: 25
#fontsize: 18
#stroke: #26A63A
#linewidth: 2

[Import] -> [Understand]

[Understand |
  [Wrangle] -> [Visualize]
  [Visualize] -> [Model]
  [Model] -> [Wrangle]
]

[Understand] -> [Communicate]
\end{verbatim}

统计建模：两种文化 \citep{Breiman_2001_Modeling}

\begin{quote}
这些案例来自 Kaggle、 Tudesday 或者自己找的数据集，而不是论文里，或者 R 包里的小数据集，应该更加真实，贴近实际问题，考虑更多细节
\end{quote}

\hypertarget{sec-life-of-statisticians}{%
\section{统计学家生平}\label{sec-life-of-statisticians}}

世纪统计学家 100 位统计学家，寿命的影响因素，关联分析，图展示数据本身的

注明每位统计学家所在的年代经历的重大事件，如欧洲中世纪霍乱，第二次世界大战，文化大革命，用图形来讲故事，展现数据可视化的魅力，参考文献 \citep{Statisticians_1997_Johnson}

\hypertarget{sec-history-of-r}{%
\section{R 语言发展历史}\label{sec-history-of-r}}

R 语言发展历史和现状，用图来表达

\hypertarget{sec-PlantGrowth}{%
\section{不同实验条件下植物生长情况}\label{sec-PlantGrowth}}

PlantGrowth 数据集收集自 Annette J. Dobson 所著书籍《An Introduction to Statistical Modelling》\citep{Dobson_1983_Modelling} 第 2 章第 2 节的案例 --- 研究植物在两种不同试验条件下的生长情况，植物通过光合作用吸收土壤的养分和空气中的二氧化碳，完成积累，故以植物的干重来刻画植物的生长情况，首先将几乎相同的种子随机地分配到实验组和对照组，基于完全随机实验设计（completely randomized experimental design），经过预定的时间后，将植物收割，干燥并称重，结果如表 \ref{tab:PlantGrowth-data} 所示

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# do.call("cbind", lapply(split(PlantGrowth, f = PlantGrowth$group), subset, select = "weight"))}
\DocumentationTok{\#\# 或者}
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{split}\NormalTok{(PlantGrowth, }\AttributeTok{f =}\NormalTok{ PlantGrowth}\SpecialCharTok{$}\NormalTok{group) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 分组}
  \FunctionTok{lapply}\NormalTok{(., subset, }\AttributeTok{select =} \StringTok{"weight"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 计算}
  \FunctionTok{Reduce}\NormalTok{(}\StringTok{"cbind"}\NormalTok{, .) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 合并}
  \FunctionTok{setNames}\NormalTok{(., }\FunctionTok{levels}\NormalTok{(PlantGrowth}\SpecialCharTok{$}\NormalTok{group)) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 重命名 \textasciigrave{}colnames\textless{}{-}\textasciigrave{}(., levels(PlantGrowth$group))}
\NormalTok{  t }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(.,}
    \AttributeTok{caption =} \StringTok{"不同生长环境下植物的干重"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{align =} \StringTok{"c"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:PlantGrowth-data}不同生长环境下植物的干重}
\centering
\begin{tabular}[t]{l|c|c|c|c|c|c|c|c|c|c}
\hline
  & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10\\
\hline
ctrl & 4.17 & 5.58 & 5.18 & 6.11 & 4.50 & 4.61 & 5.17 & 4.53 & 5.33 & 5.14\\
\hline
trt1 & 4.81 & 4.17 & 4.41 & 3.59 & 5.87 & 3.83 & 6.03 & 4.89 & 4.32 & 4.69\\
\hline
trt2 & 6.31 & 5.12 & 5.54 & 5.50 & 5.37 & 5.29 & 4.92 & 6.15 & 5.80 & 5.26\\
\hline
\end{tabular}
\end{table}

设立对照组（控制组）ctrl 和实验组 trt1 和 trt2，比较不同的处理方式对植物干重的影响

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      weight       group   
##  Min.   :3.590   ctrl:10  
##  1st Qu.:4.550   trt1:10  
##  Median :5.155   trt2:10  
##  Mean   :5.073            
##  3rd Qu.:5.530            
##  Max.   :6.310
\end{verbatim}

每个组都有10颗植物，生长情况如图\ref{fig:plant-growth-fig}所示

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{case-study_files/figure-latex/plant-growth-fig-1} \includegraphics[width=0.45\linewidth]{case-study_files/figure-latex/plant-growth-fig-2} 

}

\caption{植物干重}\label{fig:plant-growth-fig}
\end{figure}

实验条件 trt1 和 trt2 对植物生长状况有显著的影响，为了量化这种影响，建立线性回归模型

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_sublm }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group,}
  \AttributeTok{data =}\NormalTok{ PlantGrowth,}
  \AttributeTok{subset =}\NormalTok{ group }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"ctrl"}\NormalTok{, }\StringTok{"trt1"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{anova}\NormalTok{(fit\_sublm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Response: weight
##           Df Sum Sq Mean Sq F value Pr(>F)
## group      1 0.6882 0.68820  1.4191  0.249
## Residuals 18 8.7292 0.48496
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(fit\_sublm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = weight ~ group, data = PlantGrowth, subset = group %in% 
##     c("ctrl", "trt1"))
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.0710 -0.4938  0.0685  0.2462  1.3690 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept)   5.0320     0.2202  22.850 9.55e-15 ***
## grouptrt1    -0.3710     0.3114  -1.191    0.249    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.6964 on 18 degrees of freedom
## Multiple R-squared:  0.07308,    Adjusted R-squared:  0.02158 
## F-statistic: 1.419 on 1 and 18 DF,  p-value: 0.249
\end{verbatim}

下面再通过检验的方式比较实验组和对照组相比，是否有显著作用

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 控制组和实验组1比较}
\FunctionTok{t.test}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{subset =}\NormalTok{ group }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"ctrl"}\NormalTok{, }\StringTok{"trt1"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  weight by group
## t = 1.1913, df = 16.524, p-value = 0.2504
## alternative hypothesis: true difference in means between group ctrl and group trt1 is not equal to 0
## 95 percent confidence interval:
##  -0.2875162  1.0295162
## sample estimates:
## mean in group ctrl mean in group trt1 
##              5.032              4.661
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 控制组和实验组2比较}
\FunctionTok{t.test}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{subset =}\NormalTok{ group }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"ctrl"}\NormalTok{, }\StringTok{"trt2"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  weight by group
## t = -2.134, df = 16.786, p-value = 0.0479
## alternative hypothesis: true difference in means between group ctrl and group trt2 is not equal to 0
## 95 percent confidence interval:
##  -0.98287213 -0.00512787
## sample estimates:
## mean in group ctrl mean in group trt2 
##              5.032              5.526
\end{verbatim}

检验结果表明，实验条件 trt2 会对植物生长产生显著效果，而实验条件 trt1 不会。在假定同方差的情况下，建立线性回归模型，同时考虑实验条件 trt1 和 trt2

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 模型拟合}
\NormalTok{fit\_lm }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth)}

\DocumentationTok{\#\# 模型输出}
\FunctionTok{summary}\NormalTok{(fit\_lm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = weight ~ group, data = PlantGrowth)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.0710 -0.4180 -0.0060  0.2627  1.3690 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept)   5.0320     0.1971  25.527   <2e-16 ***
## grouptrt1    -0.3710     0.2788  -1.331   0.1944    
## grouptrt2     0.4940     0.2788   1.772   0.0877 .  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.6234 on 27 degrees of freedom
## Multiple R-squared:  0.2641, Adjusted R-squared:  0.2096 
## F-statistic: 4.846 on 2 and 27 DF,  p-value: 0.01591
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 方差分析}
\FunctionTok{anova}\NormalTok{(fit\_lm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Response: weight
##           Df  Sum Sq Mean Sq F value  Pr(>F)  
## group      2  3.7663  1.8832  4.8461 0.01591 *
## Residuals 27 10.4921  0.3886                  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 参数估计}
\FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(fit\_lm))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             Estimate Std. Error   t value     Pr(>|t|)
## (Intercept)    5.032  0.1971284 25.526514 1.936575e-20
## grouptrt1     -0.371  0.2787816 -1.330791 1.943879e-01
## grouptrt2      0.494  0.2787816  1.771996 8.768168e-02
\end{verbatim}

模型输出整理成表 \ref{tab:lm-plant-growth-output} 所示

\begin{table}

\caption{\label{tab:lm-plant-growth-output}线性回归的输出}
\centering
\begin{tabular}[t]{l|r|r|r|r}
\hline
  & 估计值 & 标准差 & t 统计量 & P 值\\
\hline
$\alpha$ & 5.032 & 0.1971 & 25.5265 & 0.0000\\
\hline
$\beta_1$ & -0.371 & 0.2788 & -1.3308 & 0.1944\\
\hline
$\beta_2$ & 0.494 & 0.2788 & 1.7720 & 0.0877\\
\hline
\end{tabular}
\end{table}

还可以将模型转化为数学公式

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 理论模型}
\NormalTok{equatiomatic}\SpecialCharTok{::}\FunctionTok{extract\_eq}\NormalTok{(fit\_lm)}
\end{Highlighting}
\end{Shaded}

\begin{equation}
\operatorname{weight} = \alpha + \beta_{1}(\operatorname{group}_{\operatorname{trt1}}) + \beta_{2}(\operatorname{group}_{\operatorname{trt2}}) + \epsilon
\end{equation}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 拟合模型}
\NormalTok{equatiomatic}\SpecialCharTok{::}\FunctionTok{extract\_eq}\NormalTok{(fit\_lm, }\AttributeTok{use\_coefs =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{equation}
\operatorname{\widehat{weight}} = 5.03 - 0.37(\operatorname{group}_{\operatorname{trt1}}) + 0.49(\operatorname{group}_{\operatorname{trt2}})
\end{equation}

进一步地，我们在线性模型的基础上考虑每个实验组有不同的方差，先做方差齐性检验。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{bartlett.test}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Bartlett test of homogeneity of variances
## 
## data:  weight by group
## Bartlett's K-squared = 2.8786, df = 2, p-value = 0.2371
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fligner.test}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fligner-Killeen test of homogeneity of variances
## 
## data:  weight by group
## Fligner-Killeen:med chi-squared = 2.3499, df = 2, p-value = 0.3088
\end{verbatim}

检验的结果显示，可以认为三个组的方差没有显著差异，但我们还是考虑每个组有不同的方差，看看放开假设能获得多少提升，后续会发现，从对数似然的角度来看，实际提升量很小，只有 7.72\%

上面同时比较多个总体的方差，会发现方差没有显著差异，那么接下来在假定方差齐性的条件下，比较均值的差异是否显著？

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 参数检验，假定异方差}
\FunctionTok{oneway.test}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{var.equal =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  One-way analysis of means (not assuming equal variances)
## 
## data:  weight and group
## F = 5.181, num df = 2.000, denom df = 17.128, p-value = 0.01739
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 参数检验，假定方差齐性}
\FunctionTok{oneway.test}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{var.equal =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  One-way analysis of means
## 
## data:  weight and group
## F = 4.8461, num df = 2, denom df = 27, p-value = 0.01591
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 非参数检验}
\FunctionTok{kruskal.test}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Kruskal-Wallis rank sum test
## 
## data:  weight by group
## Kruskal-Wallis chi-squared = 7.9882, df = 2, p-value = 0.01842
\end{verbatim}

检验结果显示它们的均值是有显著差异的！

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 固定效应模型}
\NormalTok{fit\_gls }\OtherTok{\textless{}{-}}\NormalTok{ nlme}\SpecialCharTok{::}\FunctionTok{gls}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{,}
  \AttributeTok{weights =}\NormalTok{ nlme}\SpecialCharTok{::}\FunctionTok{varIdent}\NormalTok{(}\AttributeTok{form =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ group),}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{method =} \StringTok{"REML"}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_gls)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Generalized least squares fit by REML
##   Model: weight ~ 1 
##   Data: PlantGrowth 
##        AIC      BIC    logLik
##   70.48628 75.95547 -31.24314
## 
## Variance function:
##  Structure: Different standard deviations per stratum
##  Formula: ~1 | group 
##  Parameter estimates:
##      ctrl      trt1      trt2 
## 1.0000000 1.5825700 0.9230865 
## 
## Coefficients:
##                Value Std.Error  t-value p-value
## (Intercept) 5.199759 0.1162421 44.73214       0
## 
## Standardized residuals:
##         Min          Q1         Med          Q3         Max 
## -1.74647988 -0.91870713 -0.07591108  0.60676033  2.03987301 
## 
## Residual standard error: 0.5896195 
## Degrees of freedom: 30 total; 29 residual
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 随机效应模型}
\NormalTok{fit\_lme }\OtherTok{\textless{}{-}}\NormalTok{ nlme}\SpecialCharTok{::}\FunctionTok{lme}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{random =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth)}
\FunctionTok{summary}\NormalTok{(fit\_lme)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Linear mixed-effects model fit by REML
##   Data: PlantGrowth 
##        AIC      BIC    logLik
##   67.44473 71.54662 -30.72237
## 
## Random effects:
##  Formula: ~1 | group
##         (Intercept)  Residual
## StdDev:   0.3865976 0.6233746
## 
## Fixed effects:  weight ~ 1 
##             Value Std.Error DF  t-value p-value
## (Intercept) 5.073 0.2505443 27 20.24792       0
## 
## Standardized Within-Group Residuals:
##          Min           Q1          Med           Q3          Max 
## -1.854449795 -0.688750457  0.006389611  0.406096866  2.059729645 
## 
## Number of Observations: 30
## Number of Groups: 3
\end{verbatim}

\(\sigma_i^2 = Var(\epsilon_{ij}), i = 1,2,3\) 表示第 \(i\) 组的方差，

\[
y_{ij} = \mu + \epsilon_{ij}, i = 1,2,3
\]

其中 \(\mu\) 是固定的未知参数，我们和之前假定同方差情形下的模型比较一下，现在异方差情况下模型提升的情况，从对数似然的角度来看

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{logLik}\NormalTok{(fit\_lm)}
\DocumentationTok{\#\# \textquotesingle{}log Lik.\textquotesingle{} {-}26.80952 (df=4)}
\FunctionTok{logLik}\NormalTok{(fit\_lm, }\AttributeTok{REML =} \ConstantTok{TRUE}\NormalTok{)}
\DocumentationTok{\#\# \textquotesingle{}log Lik.\textquotesingle{} {-}29.00481 (df=4)}
\FunctionTok{logLik}\NormalTok{(fit\_gls)}
\DocumentationTok{\#\# \textquotesingle{}log Lik.\textquotesingle{} {-}31.24314 (df=4)}
\FunctionTok{logLik}\NormalTok{(fit\_lme)}
\DocumentationTok{\#\# \textquotesingle{}log Lik.\textquotesingle{} {-}30.72237 (df=3)}
\end{Highlighting}
\end{Shaded}

进一步地，我们考虑两水平模型，认为不同的实验组其均值和方差都不一样，检验三样本均值是否相等？

\(\mu_1 = \mu_2 = \mu_3\) 检验，这里因为每组的样本量都一样，因此考虑 Turkey 的 T 法检验，检验均值是否有显著差别，实际上这里因为实验组数量只有2个，可以两两比对，如前所述。但是这里我们想扩展一下，考虑多组比较的问题。

和上面用 \texttt{gls} 拟合的模型是一致的。

\begin{align}
y_{ij}& = \mu_i + \epsilon_{ij}, \\
\mu_i & = \mu_{\theta} + \xi_i. \quad i  = 1,\ldots,3; \quad j = 1, \ldots, 10.
\end{align}

其中 \(\mu_i\) 是随机的未知变量，服从均值为 \(\mu_{\theta}\) 方差为 \(Var(\xi_i) = \tau^2\) 的正态分布

我们用 \textbf{MASS} 包提供的 \texttt{glmmPQL()} 函数拟合该数据集

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_lme\_pql }\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{glmmPQL}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{,}
  \AttributeTok{random =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ group, }\AttributeTok{verbose =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{family =} \FunctionTok{gaussian}\NormalTok{(), }\AttributeTok{data =}\NormalTok{ PlantGrowth}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_lme\_pql)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Linear mixed-effects model fit by maximum likelihood
##   Data: PlantGrowth 
##   AIC BIC logLik
##    NA  NA     NA
## 
## Random effects:
##  Formula: ~1 | group
##         (Intercept)  Residual
## StdDev:   0.2944234 0.6233746
## 
## Variance function:
##  Structure: fixed weights
##  Formula: ~invwt 
## Fixed effects:  weight ~ 1 
##             Value Std.Error DF  t-value p-value
## (Intercept) 5.073 0.2080656 27 24.38174       0
## 
## Standardized Within-Group Residuals:
##          Min           Q1          Med           Q3          Max 
## -1.922640850 -0.734727623  0.004564386  0.405111223  1.991538416 
## 
## Number of Observations: 30
## Number of Groups: 3
\end{verbatim}

我们再借助 \textbf{brms} 包从贝叶斯的角度来分析数据，并建模

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 贝叶斯模型}
\NormalTok{fit\_brm }\OtherTok{\textless{}{-}}\NormalTok{ brms}\SpecialCharTok{::}\FunctionTok{brm}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth)}
\CommentTok{\# 参考 https://www.xiangyunhuang.com.cn/2019/05/normal{-}hierarchical{-}model/}
\FunctionTok{library}\NormalTok{(Rcpp)}
\NormalTok{fit\_lme\_brm }\OtherTok{\textless{}{-}}\NormalTok{ brms}\SpecialCharTok{::}\FunctionTok{brm}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}} \DecValTok{1} \SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{|}\NormalTok{ group),}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{family =} \FunctionTok{gaussian}\NormalTok{(), }
  \AttributeTok{refresh =} \DecValTok{0}\NormalTok{, }\AttributeTok{seed =} \DecValTok{2019}
\NormalTok{)}
\FunctionTok{summary}\NormalTok{(fit\_lme\_brm)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-orange}{%
\section{橘树生长情况}\label{sec-orange}}

Orange 数据集包含三个变量，记录了加利福尼亚南部的一个小树林中的五棵橘树的生长情况，在 \textbf{datasets} 包里，数据集保存为 \texttt{c("nfnGroupedData",\ "nfGroupedData",\ "groupedData",\ "data.frame")} 类型的数据，同时具有着四个类的特点。

\begin{itemize}
\tightlist
\item
  Tree: 有序的指示变量，根据5棵橘树的最大直径划分，测量值很可能是根据林务员常用的``胸围周长''
\item
  age: 橘树的树龄，自 1968 年 12 月 31 日起按天计算
\item
  circumference: 橘树树干的周长，单位是毫米
\end{itemize}

查看部分数据的情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(Orange)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Grouped Data: circumference ~ age | Tree
##   Tree  age circumference
## 1    1  118            30
## 2    1  484            58
## 3    1  664            87
## 4    1 1004           115
## 5    1 1231           120
## 6    1 1372           142
\end{verbatim}

查看变量的属性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(Orange)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   35 obs. of  3 variables:
##  $ Tree         : Ord.factor w/ 5 levels "3"<"1"<"5"<"2"<..: 2 2 2 2 2 2 2 4 4 4 ...
##  $ age          : num  118 484 664 1004 1231 ...
##  $ circumference: num  30 58 87 115 120 142 145 33 69 111 ...
##  - attr(*, "formula")=Class 'formula'  language circumference ~ age | Tree
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Time since December 31, 1968"
##   ..$ y: chr "Trunk circumference"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(days)"
##   ..$ y: chr "(mm)"
\end{verbatim}

说明 5 棵树之间的大小关系是 \texttt{3\ \textless{}\ 1\ \textless{}\ 5\ \textless{}\ 2\ \textless{}\ 4}，这里的数字 1，2，3，4，5 只是对树的编号，第一次测量时树的大小关系在 R 内用有序因子来表示。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{levels}\NormalTok{(Orange}\SpecialCharTok{$}\NormalTok{Tree)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "3" "1" "5" "2" "4"
\end{verbatim}

表 \ref{tab:orange-data} 记录了 5 颗橘树自 1968 年 12 月 31 日以来的生长情况

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# aggregate(data = Orange, circumference \textasciitilde{}  age, FUN = mean)}
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{reshape}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ Orange, }\AttributeTok{v.names =} \StringTok{"circumference"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"Tree"}\NormalTok{,}
  \AttributeTok{timevar =} \StringTok{"age"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(.,}
    \AttributeTok{caption =} \StringTok{"躯干周长（毫米）随时间（天）的变化"}\NormalTok{,}
    \AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col.names =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(circumference)"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{names}\NormalTok{(.)),}
    \AttributeTok{align =} \StringTok{"c"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:orange-data}躯干周长（毫米）随时间（天）的变化}
\centering
\begin{tabular}[t]{c|c|c|c|c|c|c|c}
\hline
Tree & 118 & 484 & 664 & 1004 & 1231 & 1372 & 1582\\
\hline
1 & 30 & 58 & 87 & 115 & 120 & 142 & 145\\
\hline
2 & 33 & 69 & 111 & 156 & 172 & 203 & 203\\
\hline
3 & 30 & 51 & 75 & 108 & 115 & 139 & 140\\
\hline
4 & 32 & 62 & 112 & 167 & 179 & 209 & 214\\
\hline
5 & 30 & 49 & 81 & 125 & 142 & 174 & 177\\
\hline
\end{tabular}
\end{table}

图 \ref{fig:orange-tree} 以直观的方式展示 5 颗橘树的生长变化，相比于表 \ref{tab:orange-data} 我们能更加明确读取数据中的变化

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ Orange, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ circumference, }\AttributeTok{color =}\NormalTok{ Tree)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"age (day)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"circumference (mm)"}\NormalTok{)}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{case-study_files/figure-latex/orange-tree-1} 

}

\caption{橘树生长模型}\label{fig:orange-tree}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gganimate)}
\NormalTok{p }\SpecialCharTok{+} \FunctionTok{transition\_reveal}\NormalTok{(age)}
\end{Highlighting}
\end{Shaded}

\begin{center}\animategraphics[,controls,loop]{10}{case-study_files/figure-latex/orange-animate-}{1}{100}\end{center}

\hypertarget{pkg-network}{%
\section{R 包网络分析}\label{pkg-network}}

首先我们从 CRAN 官网下载 R 包描述信息

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdb }\OtherTok{\textless{}{-}}\NormalTok{ tools}\SpecialCharTok{::}\FunctionTok{CRAN\_package\_db}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

接着，我们可以看看CRAN 上发布的 R 包数量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(pdb[, }\StringTok{"Package"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 18349
\end{verbatim}

经过与官网发布的数据来对比，我们发现这里计算的结果与实际不符，多出来了几十个R包，所以我们再观察一下是否有重复的 R 包描述信息

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdb[, }\StringTok{"Package"}\NormalTok{][}\FunctionTok{duplicated}\NormalTok{(pdb[, }\StringTok{"Package"}\NormalTok{])]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "boot"       "class"      "cluster"    "codetools"  "foreign"   
##  [6] "KernSmooth" "lattice"    "MASS"       "Matrix"     "mgcv"      
## [11] "nlme"       "nnet"       "rpart"      "spatial"    "survival"  
## [16] "RODBC"      "XML"
\end{verbatim}

不难发现，果然有！所以去掉重复的 R 包信息，就是 CRAN 上实际发布的 R 包数量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(}\FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{subset =} \SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(pdb[, }\StringTok{"Package"}\NormalTok{])))[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 18332
\end{verbatim}

接下来就是分析去掉重复信息后的数据矩阵 pdb

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{subset =} \SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(pdb[, }\StringTok{"Package"}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

\hypertarget{R-Core-Team}{%
\subsection{R 核心团队}\label{R-Core-Team}}

R 核心团队除了维护开发 Base R 包以外，还开发了哪些 R 包，我们依据这些开发者邮箱 \texttt{\textless{}Firstname\textgreater{}.\textless{}Lastname\textgreater{}@R-project.org} 的特点，从数据集 pdb 中提取他们开发的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{core\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb,}
  \AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ pdb[, }\StringTok{"Maintainer"}\NormalTok{],}
    \AttributeTok{pattern =} \StringTok{"(@R{-}project}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.org)"}
\NormalTok{  ),}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Maintainer"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{dim}\NormalTok{(core\_pdb[}\FunctionTok{order}\NormalTok{(core\_pdb[, }\StringTok{"Maintainer"}\NormalTok{]), ])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 104   2
\end{verbatim}

这么少，是不是有点意外，看来很多大佬更喜欢用自己的邮箱，比如 Paul Murrell， 他的邮箱是 \href{mailto:paul@stat.auckland.ac.nz}{\nolinkurl{paul@stat.auckland.ac.nz}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(pdb,}
  \AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =}\NormalTok{ pdb[, }\StringTok{"Maintainer"}\NormalTok{], }\AttributeTok{pattern =} \StringTok{"(Paul Murrell)"}\NormalTok{),}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Maintainer"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Package                              Maintainer
## 2517       compare Paul Murrell <p.murrell@auckland.ac.nz>
## 5725         gdiff Paul Murrell <paul@stat.auckland.ac.nz>
## 6472      gridBase Paul Murrell <paul@stat.auckland.ac.nz>
## 6473    gridBezier Paul Murrell <paul@stat.auckland.ac.nz>
## 6474     gridDebug Paul Murrell <p.murrell@auckland.ac.nz>
## 6476  gridGeometry Paul Murrell <paul@stat.auckland.ac.nz>
## 6477  gridGraphics Paul Murrell <paul@stat.auckland.ac.nz>
## 6478  gridGraphviz Paul Murrell <p.murrell@auckland.ac.nz>
## 6482       gridSVG Paul Murrell <paul@stat.auckland.ac.nz>
## 6485      grImport Paul Murrell <p.murrell@auckland.ac.nz>
## 6486     grImport2 Paul Murrell <paul@stat.auckland.ac.nz>
## 6808       hexView Paul Murrell <paul@stat.auckland.ac.nz>
## 9223      metapost Paul Murrell <paul@stat.auckland.ac.nz>
## 12884    rasterize Paul Murrell <paul@stat.auckland.ac.nz>
## 13618    RGraphics Paul Murrell <paul@stat.auckland.ac.nz>
## 14049        roloc Paul Murrell <paul@stat.auckland.ac.nz>
## 14050 rolocISCCNBS Paul Murrell <paul@stat.auckland.ac.nz>
## 17870       vwline Paul Murrell <paul@stat.auckland.ac.nz>
\end{verbatim}

所以这种方式不行了，只能列举所有 R Core Team 成员，挨个去匹配，幸好 \texttt{contributors()} 函数已经收集了成员名单，不需要我们去官网找了。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{core\_team }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}
  \AttributeTok{text =} \StringTok{"}
\StringTok{Douglas Bates}
\StringTok{John Chambers}
\StringTok{Peter Dalgaard}
\StringTok{Robert Gentleman}
\StringTok{Kurt Hornik}
\StringTok{Ross Ihaka}
\StringTok{Tomas Kalibera}
\StringTok{Michael Lawrence}
\StringTok{Friedrich Leisch}
\StringTok{Uwe Ligges}
\StringTok{Thomas Lumley}
\StringTok{Martin Maechler}
\StringTok{Martin Morgan}
\StringTok{Paul Murrell}
\StringTok{Martyn Plummer}
\StringTok{Brian Ripley}
\StringTok{Deepayan Sarkar}
\StringTok{Duncan Temple Lang}
\StringTok{Luke Tierney}
\StringTok{Simon Urbanek}
\StringTok{Heiner Schwarte}
\StringTok{Guido Masarotto}
\StringTok{Stefano Iacus}
\StringTok{Seth Falcon}
\StringTok{Duncan Murdoch}
\StringTok{David Meyer}
\StringTok{Simon Wood}
\StringTok{"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }
  \AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{colClasses =} \StringTok{"character"}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, }\AttributeTok{col.names =} \StringTok{"name"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

R 核心团队维护的 R 包及其最新发布的日期

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{core\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb,}
  \AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ pdb[, }\StringTok{"Maintainer"}\NormalTok{],}
    \AttributeTok{pattern =} \FunctionTok{paste}\NormalTok{(}\StringTok{"("}\NormalTok{, core\_team}\SpecialCharTok{$}\NormalTok{name, }\StringTok{")"}\NormalTok{, }\AttributeTok{collapse =} \StringTok{"|"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Maintainer"}\NormalTok{, }\StringTok{"Published"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

清理 Maintainer 字段中的邮箱部分，方便表格展示

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{clean\_maintainer }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \CommentTok{\# 去掉邮箱}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\textless{}([\^{}\textless{}\textgreater{}]*)\textgreater{}"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \CommentTok{\# 去掉 \textbackslash{}n \textbackslash{}t \textbackslash{}\textquotesingle{} \textbackslash{}" 和 \textquotesingle{}}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}n}\StringTok{)|(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}t}\StringTok{)|(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}"}\StringTok{)|(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textquotesingle{}}\StringTok{)|(\textquotesingle{})"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \CommentTok{\# 去掉末尾空格}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{" +$"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
\NormalTok{\}}
\NormalTok{core\_pdb[, }\StringTok{"Maintainer"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{clean\_maintainer}\NormalTok{(core\_pdb[, }\StringTok{"Maintainer"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

我们可以看到 R 核心团队总共开发维护有 175 个 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(core\_pdb)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 175   3
\end{verbatim}

篇幅所限，就展示部分人和R包，见表 \ref{tab:r-core-team} 按照拼音顺序 Brian Ripley 是第一位

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(}\FunctionTok{head}\NormalTok{(core\_pdb[}\FunctionTok{order}\NormalTok{(}
\NormalTok{  core\_pdb[, }\StringTok{"Maintainer"}\NormalTok{],}
\NormalTok{  core\_pdb[, }\StringTok{"Published"}\NormalTok{]}
\NormalTok{), ], }\DecValTok{6}\NormalTok{),}
\AttributeTok{caption =} \StringTok{"R Core Team 维护的 R 包（展示部分）"}\NormalTok{, }
\AttributeTok{booktabs =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:r-core-team}R Core Team 维护的 R 包（展示部分）}
\centering
\begin{tabular}[t]{lll}
\toprule
Package & Maintainer & Published\\
\midrule
mix & Brian Ripley & 2017-06-12\\
pspline & Brian Ripley & 2017-06-12\\
gee & Brian Ripley & 2019-11-07\\
boot & Brian Ripley & 2021-05-03\\
class & Brian Ripley & 2021-05-03\\
\addlinespace
KernSmooth & Brian Ripley & 2021-05-03\\
\bottomrule
\end{tabular}
\end{table}

分组计数，看看核心开发者维护的 R 包有多少

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ core\_pdb, Package }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Maintainer, }\AttributeTok{FUN =}\NormalTok{ length) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{reorder}\NormalTok{(Maintainer, Package), }\AttributeTok{y =}\NormalTok{ Package)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"R 核心团队"}\NormalTok{, }\AttributeTok{y =} \StringTok{"R 包数量"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_family =} \StringTok{"source{-}han{-}serif{-}cn"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{case-study_files/figure-latex/unnamed-chunk-21-1} \end{center}

\hypertarget{Top-Creators}{%
\subsection{高产的开发者}\label{Top-Creators}}

\begin{quote}
这些人的个人简介
\end{quote}

接下来，我们再来查看一些比较高产的 R 包开发者谢益辉都维护了哪些R包，如表 \ref{tab:rmarkdown-ecology} 所示

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{yihui\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb,}
  \AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Yihui Xie"}\NormalTok{, pdb[, }\StringTok{"Maintainer"}\NormalTok{]),}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Title"}\NormalTok{)}
\NormalTok{)}
\NormalTok{yihui\_pdb[, }\StringTok{"Title"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}n}\StringTok{)"}\NormalTok{, }\StringTok{" "}\NormalTok{, yihui\_pdb[, }\StringTok{"Title"}\NormalTok{])}
\NormalTok{knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(yihui\_pdb,}
  \AttributeTok{caption =} \StringTok{"谢益辉维护的 R Markdown 生态"}\NormalTok{,}
  \AttributeTok{booktabs =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:rmarkdown-ecology}谢益辉维护的 R Markdown 生态}
\centering
\begin{tabular}[t]{ll}
\toprule
Package & Title\\
\midrule
animation & A Gallery of Animations in Statistics and Utilities to Create Animations\\
blogdown & Create Blogs and Websites with R Markdown\\
bookdown & Authoring Books and Technical Documents with R Markdown\\
DT & A Wrapper of the JavaScript Library 'DataTables'\\
evaluate & Parsing and Evaluation Tools that Provide More Details than the Default\\
\addlinespace
formatR & Format R Code Automatically\\
fun & Use R for Fun\\
highr & Syntax Highlighting for R Source Code\\
knitr & A General-Purpose Package for Dynamic Report Generation in R\\
markdown & Render Markdown with the C Library 'Sundown'\\
\addlinespace
mime & Map Filenames to MIME Types\\
MSG & Data and Functions for the Book Modern Statistical Graphics\\
pagedown & Paginate the HTML Output of R Markdown with CSS for Print\\
printr & Automatically Print R Objects to Appropriate Formats According to the 'knitr' Output Format\\
Rd2roxygen & Convert Rd to 'Roxygen' Documentation\\
\addlinespace
rmarkdown & Dynamic Documents for R\\
rolldown & R Markdown Output Formats for Storytelling\\
rticles & Article Formats for R Markdown\\
servr & A Simple HTTP Server to Serve Static Files or Dynamic Documents\\
testit & A Simple Package for Testing R Packages\\
\addlinespace
tinytex & Helper Functions to Install and Maintain TeX Live, and Compile LaTeX Documents\\
tufte & Tufte's Styles for R Markdown Documents\\
xaringan & Presentation Ninja\\
xfun & Supporting Functions for Packages Maintained by 'Yihui Xie'\\
\bottomrule
\end{tabular}
\end{table}

Jeroen Ooms 维护从 C++ 世界搬运进来的库，如图像处理 magick 包、 视频处理 av 包、 PDF 文档操作 qpdf 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Jeroen Ooms"}\NormalTok{, pdb[, }\StringTok{"Maintainer"}\NormalTok{]),}
       \AttributeTok{select =} \StringTok{\textquotesingle{}Package\textquotesingle{}}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "antiword"    "askpass"     "av"          "base64"      "bcrypt"     
##  [6] "brotli"      "cld2"        "cld3"        "commonmark"  "credentials"
## [11] "curl"        "gert"        "gifski"      "gpg"         "graphql"    
## [16] "hunspell"    "jose"        "js"          "jsonld"      "jsonlite"   
## [21] "katex"       "magick"      "maketools"   "minimist"    "mongolite"  
## [26] "opencpu"     "opencv"      "openssl"     "pdftools"    "protolite"  
## [31] "qpdf"        "RAppArmor"   "rjade"       "RMySQL"      "rsvg"       
## [36] "rzmq"        "sodium"      "spelling"    "ssh"         "sys"        
## [41] "tesseract"   "unix"        "unrtf"       "V8"          "webp"       
## [46] "webutils"    "writexl"     "xslt"
\end{verbatim}

Dirk Eddelbuettel 维护 Rcpp 生态

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Dirk Eddelbuettel"}\NormalTok{, pdb[, }\StringTok{"Maintainer"}\NormalTok{]),}
       \AttributeTok{select =} \StringTok{\textquotesingle{}Package\textquotesingle{}}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "anytime"             "AsioHeaders"         "BH"                 
##  [4] "binb"                "corels"              "dang"               
##  [7] "digest"              "drat"                "gaussfacts"         
## [10] "gcbd"                "gettz"               "gunsales"           
## [13] "inline"              "linl"                "littler"            
## [16] "nanotime"            "pinp"                "pkgKitten"          
## [19] "prrd"                "random"              "RApiDatetime"       
## [22] "RApiSerialize"       "Rblpapi"             "Rcpp"               
## [25] "RcppAnnoy"           "RcppAPT"             "RcppArmadillo"      
## [28] "RcppBDT"             "RcppCCTZ"            "RcppClassic"        
## [31] "RcppClassicExamples" "RcppCNPy"            "RcppDate"           
## [34] "RcppDE"              "RcppEigen"           "RcppExamples"       
## [37] "RcppFarmHash"        "RcppFastFloat"       "RcppGetconf"        
## [40] "RcppGSL"             "RcppMsgPack"         "RcppNLoptExample"   
## [43] "RcppQuantuccia"      "RcppRedis"           "RcppSimdJson"       
## [46] "RcppSMC"             "RcppSpdlog"          "RcppStreams"        
## [49] "RcppTOML"            "RcppXts"             "RcppZiggurat"       
## [52] "RDieHarder"          "rfoaas"              "RInside"            
## [55] "rmsfact"             "RProtoBuf"           "RPushbullet"        
## [58] "RQuantLib"           "RVowpalWabbit"       "sanitizers"         
## [61] "td"                  "tidyCpp"             "tiledb"             
## [64] "tint"                "ttdo"                "x13binary"
\end{verbatim}

Hadley Wickham 维护 tidyverse 生态

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Hadley Wickham"}\NormalTok{, pdb[, }\StringTok{"Maintainer"}\NormalTok{]),}
       \AttributeTok{select =} \StringTok{\textquotesingle{}Package\textquotesingle{}}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "assertthat"    "babynames"     "bigrquery"     "classifly"    
##  [5] "conflicted"    "cubelyr"       "dbplyr"        "diffviewer"   
##  [9] "downlit"       "dplyr"         "dtplyr"        "ellipsis"     
## [13] "feather"       "forcats"       "fueleconomy"   "generics"     
## [17] "ggplot2movies" "gtable"        "haven"         "hflights"     
## [21] "highlight"     "httr"          "httr2"         "lazyeval"     
## [25] "lobstr"        "lvplot"        "meifly"        "modelr"       
## [29] "multidplyr"    "nasaweather"   "nycflights13"  "pins"         
## [33] "pkgdown"       "plyr"          "productplots"  "profr"        
## [37] "proto"         "pryr"          "rappdirs"      "reshape"      
## [41] "reshape2"      "roxygen2"      "rvest"         "scales"       
## [45] "sloop"         "stringr"       "testthat"      "tidyr"        
## [49] "tidyverse"     "waldo"
\end{verbatim}

\href{https://scottchamberlain.info/}{Scott Chamberlain} 是非营利性组织 \href{https://ropensci.org/}{rOpenSci} 的联合创始人，但是没几个 R 包听说过

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Scott Chamberlain"}\NormalTok{, pdb[, }\StringTok{"Maintainer"}\NormalTok{]),}
       \AttributeTok{select =} \StringTok{\textquotesingle{}Package\textquotesingle{}}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "analogsea"   "bold"        "brranching"  "charlatan"   "citecorp"   
##  [6] "ckanr"       "conditionz"  "cowsay"      "crul"        "discgolf"   
## [11] "elastic"     "fauxpas"     "finch"       "fulltext"    "geojson"    
## [16] "geojsonio"   "geojsonlint" "getlandsat"  "ghql"        "gistr"      
## [21] "handlr"      "hoardr"      "httpcode"    "httping"     "isdparser"  
## [26] "jaod"        "jqr"         "mapr"        "microdemic"  "mregions"   
## [31] "natserv"     "oai"         "openadds"    "pangaear"    "parzer"     
## [36] "phylocomr"   "pubchunks"   "randgeo"     "rbace"       "rbhl"       
## [41] "rbison"      "rcitoid"     "rcol"        "rcoreoa"     "rcrossref"  
## [46] "rdatacite"   "rdryad"      "request"     "rgbif"       "rgnparser"  
## [51] "ritis"       "rnoaa"       "rorcid"      "rphylopic"   "rplos"      
## [56] "rredlist"    "rvertnet"    "sofa"        "solrium"     "spocc"      
## [61] "taxize"      "taxizedb"    "traits"      "vcr"         "webmockr"   
## [66] "wellknown"   "wikitaxa"    "worrms"      "zbank"
\end{verbatim}

\hypertarget{R-Package-Developers}{%
\subsection{社区开发者}\label{R-Package-Developers}}

接下来，我们想看看 R 包维护者数量有多少

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(pdb[, }\StringTok{"Maintainer"}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10691
\end{verbatim}

可实际上没有这么多的开发者，因为存在这样的情况，以 R 包维护者 Hadley Wickham 为例，由于他曾使用过不同的邮箱，所以在维护者字段出现了不一致的情况，实际却是同一个人。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(pdb,}
  \AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Hadley Wickham"}\NormalTok{, pdb[, }\StringTok{"Maintainer"}\NormalTok{]),}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Maintainer"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             Package                             Maintainer
## 604      assertthat    Hadley Wickham <hadley@rstudio.com>
## 761       babynames    Hadley Wickham <hadley@rstudio.com>
## 1211      bigrquery    Hadley Wickham <hadley@rstudio.com>
## 2200      classifly   Hadley Wickham <h.wickham@gmail.com>
## 2598     conflicted    Hadley Wickham <hadley@rstudio.com>
....
\end{verbatim}

因此，有必要先把 Maintainer 字段中的邮箱部分去掉，这样我们可以得到比较靠谱的R包维护者数量了！

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdb[, }\StringTok{"Maintainer"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{clean\_maintainer}\NormalTok{(pdb[, }\StringTok{"Maintainer"}\NormalTok{])}
\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(pdb[, }\StringTok{"Maintainer"}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 9885
\end{verbatim}

接下来，我们还想把 R 包维护者，按照其维护的R包数量排个序，用条形图\ref{fig:top-maintainers} 表示，其中 Orphaned 表示之前的R包维护者不愿意继续维护了，后来有人接手维护，Orphaned 表示这一类接盘侠。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_maintainer }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{table}\NormalTok{(pdb[, }\StringTok{"Maintainer"}\NormalTok{]), }\AttributeTok{decreasing =} \ConstantTok{TRUE}\NormalTok{), }\DecValTok{20}\NormalTok{)}

\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{barCenters }\OtherTok{\textless{}{-}} \FunctionTok{barplot}\NormalTok{(top\_maintainer,}
  \AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{axisnames =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}
\NormalTok{)}
\FunctionTok{text}\NormalTok{(}
  \AttributeTok{y =}\NormalTok{ barCenters, }\AttributeTok{x =} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{],}
  \AttributeTok{adj =} \DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{names}\NormalTok{(top\_maintainer), }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{90}\NormalTok{, }\AttributeTok{by =} \DecValTok{10}\NormalTok{), }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{90}\NormalTok{, }\AttributeTok{by =} \DecValTok{10}\NormalTok{),}
  \AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \StringTok{"gray"}
\NormalTok{)}
\FunctionTok{grid}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{case-study_files/figure-latex/top-maintainers-1} 

}

\caption{维护 R 包数量最多的 20 个人}\label{fig:top-maintainers}
\end{figure}

调用 ggplot2 包绘图要求输入的数据类型是 \texttt{data.frame}，所以我们首先将 \texttt{top\_maintainer} 转化为数据框类型

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_maintainer }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(top\_maintainer)}
\FunctionTok{colnames}\NormalTok{(top\_maintainer) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Maintainer"}\NormalTok{, }\StringTok{"Freq"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(top\_maintainer) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Maintainer, }\AttributeTok{y =}\NormalTok{ Freq), }\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Maintainer"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Numbers of Package"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{case-study_files/figure-latex/unnamed-chunk-29-1} \end{center}

条形图在柱子很多的情况下，点线图是一种更加简洁的替代方式

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(top\_maintainer, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Freq, }\AttributeTok{y =}\NormalTok{ Maintainer)) }\SpecialCharTok{+}
  \FunctionTok{geom\_segment}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \DecValTok{20}\NormalTok{, }\AttributeTok{xend =}\NormalTok{ Freq, }\AttributeTok{yend =}\NormalTok{ Maintainer), }\AttributeTok{colour =} \StringTok{"grey50"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{colour =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{" \# of Packages "}\NormalTok{, }\AttributeTok{y =} \StringTok{" Maintainer "}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{case-study_files/figure-latex/unnamed-chunk-30-1} \end{center}

接下来，我们想看看开发者维护的 R 包数量的分布，仅从上图，我们知道有的人能维护 80 多个 R 包，总体的分布情况又是如何呢？如图所示，我们将纵轴刻度设置为 log 模式，随着开发的R包数量的增加，开发者人数是指数级递减，可见开发R包依然是一个门槛很高的工作！

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(}\FunctionTok{table}\NormalTok{(pdb[, }\StringTok{"Maintainer"}\NormalTok{])),}
  \AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{log =} \StringTok{"y"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"\# of Packages"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"\# of Maintainers (log)"}\NormalTok{,}
  \AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{case-study_files/figure-latex/unnamed-chunk-31-1} \end{center}

只开发一个 R 包的人数达到 5276 人，占开发者总数的 67.31\%，约为2/3。

\hypertarget{first-commit}{%
\subsection{首次贡献 R 包}\label{first-commit}}

我们还想进一步了解这些人是不是就自己开发自己维护，基本没有其他人参与，答案是 Almost Sure. 这些人其实占了大部分，相比于前面的 R 核心开发团队或者 R Markdown 生态的维护者，他们绝大部分属于金字塔底部的人，二八定律似乎在这里再次得到印证。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sub\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Maintainer"}\NormalTok{, }\StringTok{"Author"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

接着先清理一下 Maintainer 和 Author 字段，Author 字段的内容比起 Maintainer 复杂一些

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{clean\_author }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \CommentTok{\# 去掉中括号及其内容 [aut] [aut, cre]}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[.*?}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{])"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \CommentTok{\# 去掉小括号及其内容 ()}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(.*?}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{))"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \CommentTok{\# 去掉尖括号及其内容 \textless{} \textgreater{}}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(\textless{}.*?\textgreater{})"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \CommentTok{\# 去掉 \textbackslash{}n}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}n}\StringTok{)"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \CommentTok{\# 去掉制表符、双引号、单引号和 \textbackslash{}\textquotesingle{}，如 \textquotesingle{}Hadley Wickham\textquotesingle{} 中的单引号 \textquotesingle{} 等}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}t}\StringTok{)|(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}"}\StringTok{)|(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textquotesingle{}}\StringTok{)|(\textquotesingle{})|(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{))"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \CommentTok{\# Christian P. Robert, Universite Paris Dauphine, and Jean{-}Michel\textbackslash{}n        Marin, Universite Montpellier 2}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(and)"}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \CommentTok{\# 两个以上的空格替换为一个空格}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"( \{2,\})"}\NormalTok{,}\StringTok{" "}\NormalTok{,x)}
\NormalTok{  x}
\NormalTok{\}}

\NormalTok{sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{clean\_maintainer}\NormalTok{(sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{])}
\NormalTok{sub\_pdb[, }\StringTok{"Author"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{clean\_author}\NormalTok{(sub\_pdb[, }\StringTok{"Author"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

维护多个 R 包的开发者数量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{][}\FunctionTok{duplicated}\NormalTok{(sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{])]))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3239
\end{verbatim}

总的开发者中去掉开发了多个R包的人，就剩下只维护1个R包的开发者，共有

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{first\_ctb }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}
\NormalTok{  sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{][}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{])],}
  \FunctionTok{unique}\NormalTok{(sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{][}\FunctionTok{duplicated}\NormalTok{(sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{])])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

按照每个R包贡献者的数量分组，如图所示，有一个或者没有贡献者的占总数占 70.60\%，说明这些 R 包的开发者基本在单干，有 4 个及以下的贡献者占总数（这个总数是指只开发了一个R包的那些开发者）的 90.85\%。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ctb\_num }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}
  \FunctionTok{lapply}\NormalTok{(}
    \FunctionTok{strsplit}\NormalTok{(}
      \FunctionTok{subset}\NormalTok{(sub\_pdb,}
             \AttributeTok{subset =}\NormalTok{ sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{] }\SpecialCharTok{\%in\%}\NormalTok{ first\_ctb,}
             \AttributeTok{select =} \StringTok{"Author"}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{TRUE} \CommentTok{\# drop out data.frame return vector}
\NormalTok{      ),}
      \AttributeTok{split =} \StringTok{","}
\NormalTok{    ), length}
\NormalTok{  )}
\NormalTok{)}

\FunctionTok{hist}\NormalTok{(ctb\_num, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }
     \AttributeTok{probability =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{labels =} \ConstantTok{TRUE}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"\# of Contributors"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Proportion"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}
     \AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(), }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{case-study_files/figure-latex/unnamed-chunk-36-1} \end{center}

这些基本单干的R包开发者是否参与其它 R 包的贡献？如果不参与，则他们对社区的贡献非常有限，仅限于为社区带来数量上的堆积！

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(ctb\_num)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ctb_num
##    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16 
## 3004 1384  930  580  279  162  105   57   41   28   15   10    7    8    5    4 
##   17   18   19   20   21   22   23   27   28   56   60  133 
##    7    5    2    3    1    1    3    1    1    1    1    1
\end{verbatim}

有意思的是，有一个开发者虽然只开发了一个 R 包，但是却引来37位贡献者（包括开发者本人在内），下面把这个颇受欢迎的 R 包找出来

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 找到开发者}
\NormalTok{first\_ctb[}\FunctionTok{which.max}\NormalTok{(ctb\_num)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Ryan Curtin"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 找到 R 包}
\FunctionTok{subset}\NormalTok{(sub\_pdb, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Matt Dowle"}\NormalTok{, sub\_pdb[, }\StringTok{"Maintainer"}\NormalTok{]), }\AttributeTok{select =} \StringTok{"Package"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         Package
## 3169 data.table
\end{verbatim}

哇，大名鼎鼎的 \href{https://github.com/Rdatatable/data.table}{data.table} 包！！ I JUST find it!! 这是个异数，我们知道 data.table 在R社区享有盛名，影响范围很广，从 Matt Dowle 的 \href{https://github.com/mattdowle}{Github 主页} 来看，他确实只开发了这一个 R 包！黑天鹅在这里出现了！如果按照谁的贡献者多谁影响力大的规律来看，有 10 个以上贡献者的其它几个 R 包也必定是名器！这里留给读者把它找出来吧！

\hypertarget{Contribution-Network}{%
\subsection{贡献关系网络}\label{Contribution-Network}}

接下来进入本节最核心的部分，分析所有的开发者之间的贡献网络，在第\ref{first-commit}节清理 Author 字段的正则表达式几乎不可能覆盖到所有的情况，所以既然 Maintainer 字段是比较好清理的，不妨以它作为匹配的模式去匹配 Author 字段，这样做的代价就是迭代次数会很多，增加一定的计算负担，但是为了更加准确的清理结果，也是拼了！

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{net\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Maintainer"}\NormalTok{, }\StringTok{"Author"}\NormalTok{))}
\NormalTok{net\_pdb[, }\StringTok{"Maintainer"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{clean\_maintainer}\NormalTok{(net\_pdb[, }\StringTok{"Maintainer"}\NormalTok{])}
\NormalTok{total\_maintainer }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(net\_pdb[, }\StringTok{"Maintainer"}\NormalTok{])}
\NormalTok{clean\_author }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(maintainer) \{}
  \FunctionTok{sapply}\NormalTok{(net\_pdb[, }\StringTok{"Author"}\NormalTok{], grepl, }\AttributeTok{pattern =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"("}\NormalTok{, maintainer, }\StringTok{")"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

接下来是非常耗时的一步，实际是两层循环 1.2 亿次左右的查找计算， \texttt{grepl} 耗时 30分钟左右，正则表达式本身的性能优化问题，\texttt{maintainer\_author} 逻辑型矩阵占用内存空间 430 M 左右

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{maintainer\_author }\OtherTok{\textless{}{-}} \FunctionTok{Reduce}\NormalTok{(}\StringTok{"cbind"}\NormalTok{, }\FunctionTok{lapply}\NormalTok{(total\_maintainer, clean\_author))}
\FunctionTok{colnames}\NormalTok{(maintainer\_author) }\OtherTok{\textless{}{-}}\NormalTok{ total\_maintainer}
\FunctionTok{rownames}\NormalTok{(maintainer\_author) }\OtherTok{\textless{}{-}}\NormalTok{ net\_pdb[, }\StringTok{"Maintainer"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

为了重复运行这段耗时很长的代码，我们将中间结果保存到磁盘，推荐保存为 R 支持的序列化后的数据格式 \texttt{*.rds}，相比于 \texttt{*.csv} 格式能极大地减少磁盘存储空间，读者可运行下面两行保存数据的代码，比较看看！

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{saveRDS}\NormalTok{(maintainer\_author, }\AttributeTok{file =} \StringTok{"data/maintainer\_author.rds"}\NormalTok{)}
\FunctionTok{write.table}\NormalTok{(maintainer\_author,}\AttributeTok{file =} \StringTok{"data/maintainer\_author.csv"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

查看 \texttt{maintainer\_author} 数据集占用内存空间的大小

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{object.size}\NormalTok{(maintainer\_author), }\AttributeTok{units =} \StringTok{"auto"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

看几个数字，R 包贡献者最多的有 62 人,这个 R 包的粉丝是真多！有一个开发者对 137 个 R 包的做出过贡献，其中包括自己开发的 R 包，快来快来抓住他！

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{max}\NormalTok{(}\FunctionTok{rowSums}\NormalTok{(maintainer\_author))}
\FunctionTok{max}\NormalTok{(}\FunctionTok{colSums}\NormalTok{(maintainer\_author))}
\end{Highlighting}
\end{Shaded}

继续看看每个开发者对外贡献的量的分布情况，由图可知，绝大部分开发者对外输出不超过 3，其表示对其它 R 包的贡献不超过 3个

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(}\FunctionTok{colSums}\NormalTok{(maintainer\_author)[}\FunctionTok{colSums}\NormalTok{(maintainer\_author) }\SpecialCharTok{\textless{}=} \DecValTok{10}\NormalTok{], }
     \AttributeTok{probability =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

每个 R 包参与贡献的人数分布又是如何呢？如图所示，基本集中在1\textasciitilde2个人的样子

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rowSums}\NormalTok{(maintainer\_author)[}\FunctionTok{rowSums}\NormalTok{(maintainer\_author) }\SpecialCharTok{\textless{}=} \DecValTok{20}\NormalTok{], }
     \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}\AttributeTok{probability =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

好了，接下来我们要深入挖掘贡献协作网络中的结构特点，看看是不是由几位领导人在完全掌控，还有一大群人其实是自己搞自己的那点事，写论文、发布 R 包、投稿等如此循环。其实这就是 R 社区的特点，也决定了它不会像 Python 那样应用性强，有足够多的工程开发人员加入。大多数人写 R 包只是为了配合发论文而已，并不关心有没有人来用自己的 R 包！此外，没有人来做功能整合和持续维护，所以发展缓慢！各自造轮子的事情太多！

接着，先从表面看看开发者和贡献者的关系矩阵，\texttt{maintainer\_author} 是一个大型的超稀疏矩阵，非零元素最多的行、列分别只占 0.79\% 和 0.95\%，都不到百分之一。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 非零元素最多的行}
\FunctionTok{max}\NormalTok{(}\FunctionTok{rowMeans}\NormalTok{(maintainer\_author))}
\CommentTok{\# 非零元素最多的列}
\FunctionTok{max}\NormalTok{(}\FunctionTok{colMeans}\NormalTok{(maintainer\_author))}
\end{Highlighting}
\end{Shaded}

\begin{quote}
用稀疏索引的方式重新编码矩阵，然后用\href{https://bommaritollc.com/2012/06/17/summary-community-detection-algorithms-igraph-0-6/}{社群检测的算法}找到其中的结构，网络关系图用 Gephi 画，igraph 肯定是不行了，参考文献 \href{https://cosx.org/2011/04/exploring-renren-social-network}{社会网络分析：探索人人网好友推荐系统} 网络的统计建模分析 \footnote{Statistical Modeling of Networks in R \url{https://user2010.org/Invited/handcockuser2010.pdf}}
\end{quote}

重新获取 \texttt{maintainer\_author} 矩阵，存储指标向量，然后调用 Matrix 生成稀疏矩阵，后续的数据操作就好办了，因为 Matrix 包是内置的，它定义的稀疏矩阵类其它 R 包也都支持。先以一个简单的例子说明构造稀疏矩阵的过程

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Matrix)}
\NormalTok{spM }\OtherTok{\textless{}{-}} \FunctionTok{spMatrix}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{i =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{), }
                \AttributeTok{j =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{),}
                \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\NormalTok{spM}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 3 x 4 sparse Matrix of class "dgTMatrix"
##             
## [1,] 4 . . 4
## [2,] . 1 . .
## [3,] 4 . 8 .
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{image}\NormalTok{(spM)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{case-study_files/figure-latex/vis-sparse-mat-1} 

}

\caption{稀疏矩阵的图表示}\label{fig:vis-sparse-mat}
\end{figure}

\texttt{i} 和 \texttt{j} 表示矩阵中有值的位置，\texttt{x} 表示对应位置上的值，\texttt{i}，\texttt{j} 和 \texttt{x} 是三个长度相等的数值型向量，我们还可以调用 \texttt{image}函数，把稀疏矩阵可视化出来，对于大型稀疏矩阵可视化其稀疏模式是重要的。

\begin{quote}
贡献网络可视化 \footnote{Network Analysis and Visualization with R and igraph \url{https://kateto.net/networks-r-igraph} with \href{https://kateto.net/wp-content/uploads/2016/01/NetSciX_2016_Workshop.pdf}{PDF}}
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{clean\_net\_pdb }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(maintainer) \{}
\NormalTok{  index }\OtherTok{\textless{}{-}} \FunctionTok{clean\_author}\NormalTok{(maintainer)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(index) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
    \FunctionTok{return}\NormalTok{(}\ConstantTok{NULL}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{from\_id =}\NormalTok{ maintainer,}
    \AttributeTok{to\_id =}\NormalTok{ net\_pdb[, }\StringTok{"Maintainer"}\NormalTok{][index],}
    \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{  )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# maintainer\_author \textless{}{-} data.table::rbindlist(lapply(total\_maintainer, clean\_net\_pdb))}
\CommentTok{\# saveRDS(maintainer\_author, file = "data/maintainer\_author.rds")}
\NormalTok{toc }\OtherTok{\textless{}{-}} \FunctionTok{system.time}\NormalTok{(\{}
\NormalTok{  maintainer\_author\_net }\OtherTok{\textless{}{-}} \FunctionTok{Reduce}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, }\FunctionTok{lapply}\NormalTok{(total\_maintainer, clean\_net\_pdb))}
\NormalTok{\}, }\AttributeTok{gcFirst =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

分组统计开发者之间贡献次数，从开发者到

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{maintainer\_author\_net}\SpecialCharTok{$}\NormalTok{weight }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{edges }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ from\_id }\SpecialCharTok{+}\NormalTok{ to\_id, }\AttributeTok{data =}\NormalTok{ maintainer\_author\_net, sum)}

\NormalTok{dup\_edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[edges[, }\DecValTok{1}\NormalTok{] }\SpecialCharTok{!=}\NormalTok{ edges[, }\DecValTok{2}\NormalTok{], ]}

\FunctionTok{library}\NormalTok{(geomnet)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dup\_edges, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{from\_id =}\NormalTok{ from\_id, }\AttributeTok{to\_id =}\NormalTok{ to\_id)) }\SpecialCharTok{+}
  \FunctionTok{geom\_net}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{linewidth =}\NormalTok{ weight),}
    \AttributeTok{layout.alg =} \StringTok{"kamadakawai"}\NormalTok{,}
    \AttributeTok{labelon =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{directed =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ealpha =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{ecolour =} \StringTok{"grey70"}\NormalTok{, }\AttributeTok{arrowsize =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_net}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://smallstats.blogspot.jp/2012/12/loading{-}huge{-}graphs{-}with{-}igraph{-}and{-}r.html}
\FunctionTok{library}\NormalTok{(igraph)}
\CommentTok{\# 贡献矩阵}
\NormalTok{ctb\_df }\OtherTok{\textless{}{-}} \FunctionTok{graph.data.frame}\NormalTok{(maintainer\_author, }\AttributeTok{directed =} \ConstantTok{TRUE}\NormalTok{)}

\NormalTok{vertex.attrs }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{name =} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(ctb\_df}\SpecialCharTok{$}\NormalTok{from\_id, ctb\_df}\SpecialCharTok{$}\NormalTok{to\_id)))}
\NormalTok{edges }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(}
  \FunctionTok{match}\NormalTok{(ctb\_df}\SpecialCharTok{$}\NormalTok{from\_id, vertex.attrs}\SpecialCharTok{$}\NormalTok{name),}
  \FunctionTok{match}\NormalTok{(ctb\_df}\SpecialCharTok{$}\NormalTok{to\_id, vertex.attrs}\SpecialCharTok{$}\NormalTok{name)}
\NormalTok{)}

\NormalTok{ctb\_net }\OtherTok{\textless{}{-}} \FunctionTok{graph.empty}\NormalTok{(}\AttributeTok{n =} \DecValTok{0}\NormalTok{, }\AttributeTok{directed =}\NormalTok{ T)}
\NormalTok{ctb\_net }\OtherTok{\textless{}{-}} \FunctionTok{add.vertices}\NormalTok{(ctb\_net, }\FunctionTok{length}\NormalTok{(vertex.attrs}\SpecialCharTok{$}\NormalTok{name), }\AttributeTok{attr =}\NormalTok{ vertex.attrs)}
\NormalTok{ctb\_net }\OtherTok{\textless{}{-}} \FunctionTok{add.edges}\NormalTok{(ctb\_net, edges)}
\end{Highlighting}
\end{Shaded}

\hypertarget{CRAN-Update-Packages}{%
\subsection{更新知多少}\label{CRAN-Update-Packages}}

这节标题取其字面意思表达 CRAN 服务器的特殊日子 2012-10-29，那天 CRAN 更新了一大波 R 包，像一根擎天柱一样支撑这幅图！

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{update\_pdb }\OtherTok{\textless{}{-}}\NormalTok{ pdb[, }\FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Published"}\NormalTok{)]}
\CommentTok{\# 这天要更新的R包最多}
\FunctionTok{sort}\NormalTok{(}\FunctionTok{table}\NormalTok{(update\_pdb[,}\StringTok{"Published"}\NormalTok{]), }\AttributeTok{decreasing =} \ConstantTok{TRUE}\NormalTok{)[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 2021-09-02 
##        103
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(update\_pdb, }\FunctionTok{aes}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(Published))) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{color =} \StringTok{"skyblue4"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}
    \AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}
      \AttributeTok{date =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2011{-}01{-}01"}\NormalTok{, }\StringTok{"2012{-}10{-}20"}\NormalTok{)),}
      \AttributeTok{count =} \FunctionTok{c}\NormalTok{(}\DecValTok{80}\NormalTok{, }\DecValTok{87}\NormalTok{)}
\NormalTok{    ), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ date, }\AttributeTok{y =}\NormalTok{ count),}
    \AttributeTok{arrow =} \FunctionTok{arrow}\NormalTok{(}\AttributeTok{angle =} \DecValTok{15}\NormalTok{, }\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.15}\NormalTok{, }\StringTok{"inches"}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2010{-}11{-}01"}\NormalTok{), }\AttributeTok{y =} \DecValTok{75}\NormalTok{, }\AttributeTok{label =} \StringTok{"(2012{-}10{-}29,87)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_date}\NormalTok{(}\AttributeTok{date\_breaks =} \StringTok{"1 year"}\NormalTok{, }\AttributeTok{date\_labels =} \StringTok{"\%Y"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Published Date"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Count"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{case-study_files/figure-latex/pdb-update-history-1} 

}

\caption{R 包更新历史}\label{fig:pdb-update-history}
\end{figure}

当日发布的R包，不论是新增还是更新之前发布的R包都视为最新版，当日之前的都是旧版本，它们可能存在已经修复的 BUG！这句子好奇怪是吧，因为很多 R 包要么托管在 Github 上，要么托管在 \href{https://r-forge.r-project.org/}{R-Forge} 上开发，而 CRAN 上的版本除了发布日外，一般来讲都会落后。如图所示待更新的 R 包在日期上的分布，有的已经10来年没有更新了，最老的 R 包可以追溯到 2006-03-15，它是 coxrobust！！

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(update\_pdb, }\AttributeTok{subset =}\NormalTok{ update\_pdb[, }\StringTok{"Published"}\NormalTok{] }\SpecialCharTok{==} \FunctionTok{min}\NormalTok{(update\_pdb[, }\StringTok{"Published"}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Package  Published
## 2830 coxrobust 2006-03-15
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{update\_pdb[}\FunctionTok{which.min}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(update\_pdb[, }\StringTok{"Published"}\NormalTok{])), }\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "coxrobust"
\end{verbatim}

\hypertarget{Package-Licenses}{%
\subsection{使用许可证}\label{Package-Licenses}}

\begin{quote}
列举 R 社区使用的许可证及其区别和联系 R 开源还体现在许可证信息，顺便谈谈美国和中国技术封锁，开源社区可能面临的风险
\end{quote}

社区主要使用 GPL 及其相关授权协议，因为 R 软件本身也是授权在 GPL-2 或 GPL-3 下

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{license\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{table}\NormalTok{(pdb[, }\StringTok{"License"}\NormalTok{]), }\AttributeTok{decreasing =} \ConstantTok{TRUE}\NormalTok{), }\DecValTok{20}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{12}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e1}\NormalTok{, }\FloatTok{1e2}\NormalTok{, }\FloatTok{1e3}\NormalTok{, }\FloatTok{1e4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{20}\NormalTok{),}
     \AttributeTok{type =} \StringTok{"n"}\NormalTok{,}\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(),}
     \AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{log =} \StringTok{"x"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
     \AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e1}\NormalTok{, }\FloatTok{1e2}\NormalTok{, }\FloatTok{1e3}\NormalTok{, }\FloatTok{1e4}\NormalTok{),}
     \AttributeTok{labels =} \FunctionTok{expression}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{1}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{)}
\NormalTok{)}
\FunctionTok{text}\NormalTok{(}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\FunctionTok{length}\NormalTok{(license\_pdb)), }\AttributeTok{x =} \DecValTok{1}\NormalTok{, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{, }\AttributeTok{offset =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{pos =} \DecValTok{2}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{names}\NormalTok{(license\_pdb), }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\FloatTok{1e3}\NormalTok{, }\DecValTok{15}\NormalTok{, }\StringTok{"CRAN"}\NormalTok{)}
\FunctionTok{segments}\NormalTok{(}\AttributeTok{x0 =} \DecValTok{1}\NormalTok{, }\AttributeTok{y0 =} \FunctionTok{seq}\NormalTok{(}\FunctionTok{length}\NormalTok{(license\_pdb)), }
         \AttributeTok{x1 =}\NormalTok{ license\_pdb, }\AttributeTok{y1 =} \FunctionTok{seq}\NormalTok{(}\FunctionTok{length}\NormalTok{(license\_pdb)), }
         \AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{case-study_files/figure-latex/license-cran-1} 

}

\caption{CRAN 上采用的发布协议}\label{fig:license-cran}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rforge\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{available.packages}\NormalTok{(}\AttributeTok{repos =} \StringTok{"https://R{-}Forge.R{-}project.org"}\NormalTok{)}
\NormalTok{license\_rforge\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{table}\NormalTok{(rforge\_pdb[, }\StringTok{"License"}\NormalTok{]), }\AttributeTok{decreasing =} \ConstantTok{TRUE}\NormalTok{), }\DecValTok{20}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{12}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e1}\NormalTok{, }\FloatTok{1e2}\NormalTok{, }\FloatTok{1e3}\NormalTok{), }\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{1}\NormalTok{, }\AttributeTok{to =} \DecValTok{20}\NormalTok{,}\AttributeTok{length.out =} \DecValTok{4}\NormalTok{),}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{,}\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(),}
  \AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{log =} \StringTok{"x"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e1}\NormalTok{, }\FloatTok{1e2}\NormalTok{, }\FloatTok{1e3}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{expression}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{1}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{)}
\NormalTok{)}

\FunctionTok{text}\NormalTok{(}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\FunctionTok{length}\NormalTok{(license\_rforge\_pdb)), }\AttributeTok{x =} \DecValTok{1}\NormalTok{, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{, }\AttributeTok{offset =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{pos =} \DecValTok{2}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{names}\NormalTok{(license\_rforge\_pdb), }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\FloatTok{1e2}\NormalTok{, }\DecValTok{15}\NormalTok{, }\StringTok{"R{-}Forge"}\NormalTok{)}
\FunctionTok{segments}\NormalTok{(}\AttributeTok{x0 =} \DecValTok{1}\NormalTok{, }\AttributeTok{y0 =} \FunctionTok{seq}\NormalTok{(}\FunctionTok{length}\NormalTok{(license\_rforge\_pdb)), }
         \AttributeTok{x1 =}\NormalTok{ license\_rforge\_pdb, }\AttributeTok{y1 =} \FunctionTok{seq}\NormalTok{(}\FunctionTok{length}\NormalTok{(license\_rforge\_pdb)), }
         \AttributeTok{lwd =} \DecValTok{4}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{case-study_files/figure-latex/license-rforge-1} 

}

\caption{R-Forge 开发者采用的发布协议}\label{fig:license-rforge}
\end{figure}

\begin{quote}
改进的方向是含义相同的进行合并，这需要研究一下各个许可证，然后使用对比型条形图合并上面两个图
\end{quote}

CRAN 会检测 R 包的授权，只有授权协议包含在数据库中的才可以在 CRAN 上发布 \url{https://svn.r-project.org/R/trunk/share/licenses/license.db}

\hypertarget{Choose-Package}{%
\subsection{选择 R 包}\label{Choose-Package}}

R 社区开发的 R 包实在太多了，重复造的轮子也很多，哪个轮子结实好用就选哪个，挑选合适的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# remotes::install\_github("ropenscilabs/packagemetrics")}
\FunctionTok{library}\NormalTok{(formattable)}
\FunctionTok{library}\NormalTok{(packagemetrics)}
\NormalTok{packages }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb, Maintainer }\SpecialCharTok{==} \FunctionTok{maintainer}\NormalTok{(}\StringTok{"rmarkdown"}\NormalTok{), }\AttributeTok{select =} \StringTok{"Package"}\NormalTok{)}

\NormalTok{pdb\_metrics }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(packages, }\DecValTok{1}\NormalTok{, combine\_metrics)}
\NormalTok{pdb\_metrics }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(pdb\_metrics, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{)}

\NormalTok{pd }\OtherTok{=} \FunctionTok{subset}\NormalTok{(pdb\_metrics, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"package"}\NormalTok{, }\StringTok{"published"}\NormalTok{, }\StringTok{"dl\_last\_month"}\NormalTok{,}
    \StringTok{"stars"}\NormalTok{, }\StringTok{"forks"}\NormalTok{, }\StringTok{"last\_commit"}\NormalTok{,}
    \StringTok{"depends\_count"}\NormalTok{, }\StringTok{"watchers"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{last\_commit =} \FunctionTok{round}\NormalTok{(last\_commit, }\DecValTok{1}\NormalTok{))}

\NormalTok{pd[}\FunctionTok{is.na}\NormalTok{(pd)] }\OtherTok{\textless{}{-}} \StringTok{""}

\FunctionTok{formattable}\NormalTok{(}
\NormalTok{  pd,}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{package =} \FunctionTok{formatter}\NormalTok{(}\StringTok{"span"}\NormalTok{,}
      \AttributeTok{style =}\NormalTok{ x }\SpecialCharTok{\textasciitilde{}} \FunctionTok{style}\NormalTok{(}\AttributeTok{font.weight =} \StringTok{"bold"}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{contributors =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"\#1CC2E3"}\NormalTok{),}
    \AttributeTok{depends\_count =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"\#1CC2E3"}\NormalTok{),}
    \AttributeTok{reverse\_count =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"\#1CC2E3"}\NormalTok{),}
    \AttributeTok{tidyverse\_happy =} \FunctionTok{formatter}\NormalTok{(}\StringTok{"span"}\NormalTok{,}
      \AttributeTok{style =}\NormalTok{ x }\SpecialCharTok{\textasciitilde{}} \FunctionTok{style}\NormalTok{(}\AttributeTok{color =} \FunctionTok{ifelse}\NormalTok{(x, }\StringTok{"purple"}\NormalTok{, }\StringTok{"white"}\NormalTok{)),}
\NormalTok{      x }\SpecialCharTok{\textasciitilde{}} \FunctionTok{icontext}\NormalTok{(}\FunctionTok{ifelse}\NormalTok{(x, }\StringTok{"glass"}\NormalTok{, }\StringTok{"glass"}\NormalTok{))}
\NormalTok{    ),}
    \AttributeTok{vignette =} \FunctionTok{formatter}\NormalTok{(}\StringTok{"span"}\NormalTok{,}
      \AttributeTok{style =}\NormalTok{ x }\SpecialCharTok{\textasciitilde{}} \FunctionTok{style}\NormalTok{(}\AttributeTok{color =} \FunctionTok{ifelse}\NormalTok{(x, }\StringTok{"green"}\NormalTok{, }\StringTok{"white"}\NormalTok{)),}
\NormalTok{      x }\SpecialCharTok{\textasciitilde{}} \FunctionTok{icontext}\NormalTok{(}\FunctionTok{ifelse}\NormalTok{(x, }\StringTok{"ok"}\NormalTok{, }\StringTok{"ok"}\NormalTok{))}
\NormalTok{    ),}
    \AttributeTok{has\_tests =} \FunctionTok{formatter}\NormalTok{(}\StringTok{"span"}\NormalTok{,}
      \AttributeTok{style =}\NormalTok{ x }\SpecialCharTok{\textasciitilde{}} \FunctionTok{style}\NormalTok{(}\AttributeTok{color =} \FunctionTok{ifelse}\NormalTok{(x, }\StringTok{"green"}\NormalTok{, }\StringTok{"red"}\NormalTok{)),}
\NormalTok{      x }\SpecialCharTok{\textasciitilde{}} \FunctionTok{icontext}\NormalTok{(}\FunctionTok{ifelse}\NormalTok{(x, }\StringTok{"ok"}\NormalTok{, }\StringTok{"remove"}\NormalTok{))}
\NormalTok{    ),}
    \AttributeTok{dl\_last\_month =} \FunctionTok{color\_bar}\NormalTok{(}\StringTok{"\#56A33E"}\NormalTok{),}
    \AttributeTok{forks =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"\#56A33E"}\NormalTok{),}
    \AttributeTok{stars =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"\#56A33E"}\NormalTok{),}
    \AttributeTok{last\_commit =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"\#F06B13"}\NormalTok{, }\StringTok{"white"}\NormalTok{, }\AttributeTok{na.rm =}\NormalTok{ T)}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{pkg-growth}{%
\subsection{R 包增长速度}\label{pkg-growth}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 抓取网页数据}
\NormalTok{pkgs }\OtherTok{\textless{}{-}}\NormalTok{ pdb }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{count =} \FunctionTok{rev}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(pdb)), }\AttributeTok{Date =} \FunctionTok{as.Date}\NormalTok{(Date)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{Month =} \FunctionTok{format}\NormalTok{(Date, }\AttributeTok{format =} \StringTok{"\%Y{-}\%m"}\NormalTok{))}

\NormalTok{pkgs }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Month, }\AttributeTok{data =}\NormalTok{ pkgs, }\AttributeTok{FUN =}\NormalTok{ min)}

\NormalTok{pkgs }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(pkgs, }\AttributeTok{Date =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{paste}\NormalTok{(Month, }\StringTok{"{-}01"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{subset}\NormalTok{(Date }\SpecialCharTok{\textgreater{}} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2012{-}12{-}31"}\NormalTok{))}

\CommentTok{\# 计算自2013年以来 R 包增长速度}
\NormalTok{new\_pkgs }\OtherTok{\textless{}{-}}\NormalTok{ pkgs }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{subset}\NormalTok{(Date }\SpecialCharTok{\textgreater{}} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2012{-}12{-}31"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{publishedGrowth =} \FunctionTok{c}\NormalTok{(}\FunctionTok{tail}\NormalTok{(.}\SpecialCharTok{$}\NormalTok{count, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\ConstantTok{NA}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ count) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{counter =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(.))}

\CommentTok{\# 绘图}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(grid)}

\NormalTok{gg }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(pkgs, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Date, }\AttributeTok{y =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\AttributeTok{size =} \FloatTok{1.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_log10}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{1000}\NormalTok{, }\DecValTok{10000}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"10"}\NormalTok{, }\StringTok{"100"}\NormalTok{, }\StringTok{"1.000"}\NormalTok{, }\StringTok{"10.000"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{"\# Packages (log)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Packages published on CRAN ever since"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \DecValTok{14}\NormalTok{, }\AttributeTok{base\_family =} \StringTok{"sans"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{panel.grid.major.x =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{colour =} \StringTok{"\#535353"}\NormalTok{)}

\NormalTok{gg2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(new\_pkgs, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Date, }\AttributeTok{y =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ new\_pkgs, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ (}\FunctionTok{min}\NormalTok{(count) }\SpecialCharTok{*} \FloatTok{1.048}\SpecialCharTok{\^{}}\NormalTok{counter)),}
    \AttributeTok{color =} \StringTok{"red"}\NormalTok{, }\AttributeTok{size =}\NormalTok{ .}\DecValTok{7}\NormalTok{, }\AttributeTok{linetype =} \DecValTok{1}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"segment"}\NormalTok{,}
    \AttributeTok{x =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2015{-}04{-}01"}\NormalTok{), }\AttributeTok{xend =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2015{-}08{-}01"}\NormalTok{),}
    \AttributeTok{y =} \DecValTok{1000}\NormalTok{, }\AttributeTok{yend =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colour =} \StringTok{"red"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{,}
    \AttributeTok{x =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2016{-}12{-}01"}\NormalTok{),}
    \AttributeTok{y =} \DecValTok{1000}\NormalTok{, }\AttributeTok{label =} \StringTok{"4.6\% growth estimation"}\NormalTok{, }\AttributeTok{size =} \FloatTok{3.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{12000}\NormalTok{, }\AttributeTok{by =} \DecValTok{2000}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{12000}\NormalTok{, }\AttributeTok{by =} \DecValTok{2000}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{y =} \StringTok{"\# Packages"}\NormalTok{, }\AttributeTok{x =} \StringTok{""}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"Packages published on CRAN since 2013"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}
    \AttributeTok{base\_size =} \DecValTok{11}\NormalTok{, }\AttributeTok{base\_family =} \StringTok{"sans"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{panel.grid.major.x =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{size =}\NormalTok{ .}\DecValTok{6}\NormalTok{, }\AttributeTok{colour =} \StringTok{"\#535353"}\NormalTok{)}

\NormalTok{gg}
\FunctionTok{print}\NormalTok{(gg2, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(.}\DecValTok{70}\NormalTok{, .}\DecValTok{31}\NormalTok{, .}\DecValTok{43}\NormalTok{, .}\DecValTok{43}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{chap-data-explorer}{%
\chapter{数据探索}\label{chap-data-explorer}}

\href{https://github.com/boxuancui/DataExplorer}{DataExplorer}

\href{https://github.com/ModelOriented/DALEX}{DALEX} 提供探索性模型分析，支持 mlr、 caret、 keras、 h2o 和 xgboost 等一系列统计建模分析的 R 包。

\href{https://github.com/pbiecek/breakDown}{breakDown} Model Agnostic Explainers for Individual Predictions

\hypertarget{part-ux673aux5668ux5b66ux4e60}{%
\part{机器学习}\label{part-ux673aux5668ux5b66ux4e60}}

\hypertarget{chap-machine-learning}{%
\chapter*{介绍}\label{chap-machine-learning}}
\addcontentsline{toc}{chapter}{介绍}

机器学习与统计的关系

Torsten Hothorn 大数据和大知识 \url{https://user.math.uzh.ch/hothorn/talks/big_data_Ittingen_2015.pdf} 机器学习和随机森林 \url{https://user.math.uzh.ch/hothorn/talks/tf_RAAN_2019.pdf}

Machine Learning 的漫画解释 \url{https://xkcd.com/1838/}

mlpack 是一个机器学习的算法库，开发站点 \url{https://github.com/mlpack/mlpack} 和 \href{https://www.mlpack.org/doc/mlpack-3.4.2/r_documentation.html}{文档}

\href{https://github.com/mlr-org/mlr3verse}{mlr3verse} 机器学习与 R 语言 \href{https://github.com/tidymodels/tidymodels}{tidymodels} 统计分析和建模与 R 语言 \href{https://github.com/tidyverse/tidyverse}{tidyverse} 数据操作和可视化与 R 语言

\href{https://github.com/DoubleML/doubleml-for-r/}{DoubleML}

\hypertarget{chap-gradient-boosting-machine}{%
\chapter{梯度提升机}\label{chap-gradient-boosting-machine}}

关于决策树和梯度提升的扩展包/库，近年来层出不穷。2001 年 Jerome H. Friedman 提出梯度提升机后 \citep{Friedman2001}， 2003 年 Greg Ridgeway 开发了 gbm 包，目前 Brandon Greenwell 在维护。\href{https://github.com/gbm-developers/gbm}{gbm} 实现了 Freund and Schapire's AdaBoost 算法和 Friedman 的梯度提升机。\href{https://github.com/h2oai/h2o-3/tree/master/h2o-r}{h2o} 是基于 Java 平台的机器学习平台，学习材料 \href{https://github.com/h2oai/h2o-tutorials}{h2o-tutorials}。基于决策树的分类和回归方法 \href{https://github.com/topepo/caret/}{caret} 和基于模型的提升方法 \url{https://github.com/boost-R} 偏向统计学习，侧重各类统计模型，仅提供 R 语言接口。\href{https://github.com/dmlc/xgboost/tree/master/R-package}{xgboost} 目前已然成为做梯度提升的决策树的工业标准，使用案例丰富，中文帮助文档 \url{https://xgboost.apachecn.org/cn/latest/}，也提供多种语言接口。类似的还有 \href{https://github.com/schalkdaniel/compboost}{compboost}，其它比较小众的提升库还有 \href{https://github.com/aksnzhy/xlearn}{xLearn}。\href{https://github.com/catboost/catboost}{catboost} 开源的基于决策树的梯度提升库，支持分类特征，提供 R 和 Python 接口，详见官网 \url{https://catboost.ai}。 \href{https://github.com/Microsoft/LightGBM/tree/master/R-package}{LightGBM} 提供了 R 包，微软的工具主要支持 Windows 平台和 VS 编译工具。 Python 接口的中文文档 \url{https://lightgbm.apachecn.org/}， 顺便一提，袁进辉 等人开发的\href{https://github.com/Microsoft/lightlda}{LightLDA} 是大规模主题建模的框架。

\hypertarget{sec-xgboost}{%
\section{XGBoost}\label{sec-xgboost}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(xgboost)}
\end{Highlighting}
\end{Shaded}

\hypertarget{chap-numerical-optimization}{%
\chapter{数值优化}\label{chap-numerical-optimization}}

R 语言提供了相当多的优化求解器，比较完整的概览见\href{https://CRAN.R-project.org/view=Optimization}{优化视图}。 本章介绍一些常用的优化算法及其R实现，涵盖线性规划、整数规划、二次规划、非线性规划等。

商业优化求解器的能力都覆盖非线性规划（NLP），线性（LP）、二次（QP）和锥规划（SOCP），混合整数线性规划（MILP），多目标优化，最小二乘和方程求解。此外，还有很多文档介绍， \href{https://www.lindo.com/}{LINGO}提供\href{https://www.lindo.com/downloads/PDF/LINGO.pdf}{用户手册}， \href{https://ww2.mathworks.cn/products/optimization.html}{Matlab 优化工具箱} 提供 \href{https://ww2.mathworks.cn/help/releases/R2021a/pdf_doc/optim/optim.pdf}{Optimization 工具箱使用指南}， \href{https://github.com/MOSEK}{MOSEK} (\url{https://www.mosek.com/}) 提供 \href{https://docs.mosek.com/modeling-cookbook/index.html}{MOSEK 建模食谱}，\href{https://www.localsolver.com/}{LocalSolver} 提供\href{https://www.localsolver.com/docs/last/index.html}{基本使用手册}， \href{https://www.gurobi.com/}{Gurobi} 提供 \href{https://www.gurobi.com/documentation/9.1/refman/index.html}{Gurobi 参考手册}，\href{https://www.ibm.com/cn-zh/products/ilog-cplex-optimization-studio}{CPLEX Optimization Studio}。

开源社区有不少工具，也能求解常见的优化问题，如 Julia 的 \href{https://github.com/jump-dev}{JuMP} (\url{https://jump.dev/})，Octave (\url{https://www.gnu.org/software/octave/}) 内置的优化函数，Python 模块 \href{https://github.com/scipy/scipy}{SciPy} 提供 \href{https://docs.scipy.org/doc/scipy/reference/tutorial/optimize.html}{Optimization 优化求解器}，\href{https://github.com/cvxopt/cvxopt}{cvxopt} 凸优化求解器，主要基于内点法，提供 Julia、Python、Matlab 接口，算法介绍见 \href{http://www.seas.ucla.edu/~vandenbe/publications/coneprog.pdf}{锥优化} \href{http://www.seas.ucla.edu/~vandenbe/publications/mlbook.pdf}{机器学习优化}。 课程见 \href{https://github.com/epfml/OptML_course}{Optimization for Machine Learning}，书籍见\href{https://stanford.edu/~boyd/cvxbook/}{Convex Optimization}，相关综述见\href{https://arxiv.org/pdf/1405.4980.pdf}{Convex Optimization: Algorithms and Complexity}。

Berwin A. Turlach 开发的 \href{https://CRAN.R-project.org/package=quadprog}{quadprog} 主要用于求解二次规划问题。\href{https://web.stanford.edu/~anqif/}{Anqi Fu} 开发的 \href{https://github.com/anqif/CVXR}{CVXR} 可解很多凸优化问题 \citep{CVXR2020}，详见网站 \url{https://cvxr.rbind.io/}，\href{https://www.ucl.ac.uk/~uctpjyy/nloptr.html}{Jelmer Ypma} 开发的 \href{https://github.com/jyypma/nloptr}{nloptr} 可解无约束和有约束的非线性规划问题 \citep{nloptr}，\href{https://github.com/mbinois/GPareto}{GPareto} 求解多目标优化问题，帕雷托前沿优化和估计\citep{GPareto2019}。\href{https://github.com/igraph/igraph/}{igraph} 可以用来解决最短路径、最大网络流、最小生成树等图优化相关的问题。 \url{https://palomar.home.ece.ust.hk/MAFS6010R_lectures/Rsession_solvers.html} 提供了一般的求解器介绍。ROI 包力图统一各个求解器的调用接口，打造一个优化算法的基础设施平台。\citet{ROI2020} 详细介绍了目前优化算法发展情况及 R 社区提供的优化能力。\href{https://github.com/luca-scr/GA}{GA} 包实现了遗传算法，支持连续和离散的空间搜索，可以并行 \citep{GA2013, GA2017}，是求解 TSP 问题的重要方法。NMOF 包实现了差分进化、遗传算法、粒子群算法、模拟退火算法等启发式优化算法，还提供网格搜索和贪婪搜索工具，\citet{NMOF2019} 提供了详细的介绍。\citet{Nash2014} 总结了 R 语言环境下最优化问题的最佳实践。\href{https://github.com/coatless/rcppensmallen}{RcppEnsmallen} 数值优化 通用标准的优化方法，前沿最新的优化方法，包含小批量/全批量梯度下降技术、无梯度优化器，约束优化技术。\href{https://github.com/yixuan/RcppNumerical}{RcppNumerical} 无约束数值优化，一维/多维数值积分。

谷歌开源的运筹优化工具 \href{https://github.com/google/or-tools}{or-tools} 提供了约束优化、线性优化、混合整数优化、装箱和背包算法、TSP（Traveling Salesman Problem）、VRP（Vehicle Routing Problem）、图算法（最短路径、最小成本流、最大流等）等算法和求解器。「运筹OR帷幄」社区开源的 \href{https://github.com/Operations-Research-Science/Ebook-Linear_Programming}{线性规划} 一书值得一看。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载 ROI 时不要自动加载插件}
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{ROI\_LOAD\_PLUGINS =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{library}\NormalTok{(lpSolve)    }\CommentTok{\# 线性规划求解器}
\FunctionTok{library}\NormalTok{(ROI)        }\CommentTok{\# 优化工具箱}
\FunctionTok{library}\NormalTok{(ROI.plugin.alabama)  }\CommentTok{\# 注册 alabama 求解器}
\FunctionTok{library}\NormalTok{(ROI.plugin.nloptr)   }\CommentTok{\# 注册 nloptr 求解器}
\FunctionTok{library}\NormalTok{(ROI.plugin.lpsolve)  }\CommentTok{\# 注册 lpsolve 求解器}
\FunctionTok{library}\NormalTok{(ROI.plugin.quadprog) }\CommentTok{\# 注册 quadprog 求解器}
\FunctionTok{library}\NormalTok{(lattice)    }\CommentTok{\# 图形绘制}
\FunctionTok{library}\NormalTok{(kernlab)    }\CommentTok{\# 优化问题和机器学习的关系}

\FunctionTok{library}\NormalTok{(rootSolve)       }\CommentTok{\# 非线性方程}
\FunctionTok{library}\NormalTok{(BB)              }\CommentTok{\# 非线性方程组}
\FunctionTok{library}\NormalTok{(deSolve)         }\CommentTok{\# ODE 常微分方程}
\FunctionTok{library}\NormalTok{(scatterplot3d)   }\CommentTok{\# 三维曲线图}

\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{library}\NormalTok{(ReacTran)        }\CommentTok{\# PDE 偏微分方程}
\FunctionTok{library}\NormalTok{(PBSddesolve)     }\CommentTok{\# DAE 延迟微分方程}

\FunctionTok{library}\NormalTok{(nlme)            }\CommentTok{\# 混合效应模型}
\FunctionTok{library}\NormalTok{(nlmeODE)         }\CommentTok{\# ODE 应用于混合效应模型}

\FunctionTok{library}\NormalTok{(Sim.DiffProc)    }\CommentTok{\# SDE 随机微分方程}

\CommentTok{\# library(nlmixr)          \# Population ODE modeling}
\end{Highlighting}
\end{Shaded}

表 \ref{tab:roi-plugin-latex} 对目前的优化器按优化问题做了分类

\begin{table}

\caption{\label{tab:roi-plugin-latex}ROI 插件按优化问题分类}
\centering
\begin{tabular}[t]{>{\raggedright\arraybackslash}p{2cm}>{\raggedright\arraybackslash}p{2cm}>{\raggedright\arraybackslash}p{2cm}>{\raggedright\arraybackslash}p{2cm}>{\raggedright\arraybackslash}p{2cm}}
\toprule
  & Linear & Quadratic & Conic & Functional\\
\midrule
No &  &  &  & \\
Box &  &  &  & optimx\\
Linear & $\mathrm{clp}^\star$, $\mathrm{cbc}^{\star+}$, $\mathrm{glpk}^{\star+}$, $\mathrm{lpsolve}^{\star+}$, $\mathrm{msbinlp}^{\star+}$, $\mathrm{symphony}^{\star+}$ & ipop, $\mathrm{quadprog}^{\star}$, qpoases &  & \\
Quadratic &  & $\mathrm{cplex}^{+}$, $\mathrm{gurobi}^{\star+}$, $\mathrm{mosek}^{\star+}$, $\mathrm{neos}^{+}$ &  & \\
Conic &  &  & $\mathrm{ecos}^{\star+}$, $\mathrm{scs}^{\star}$ & \\
\addlinespace
Functional &  &  &  & alabama, deoptim, nlminb, nloptr\\
\bottomrule
\multicolumn{5}{l}{\rule{0pt}{1em}\textsuperscript{*} 求解器受限于凸优化问题}\\
\multicolumn{5}{l}{\rule{0pt}{1em}\textsuperscript{+} 求解器可以处理整型约束}\\
\end{tabular}
\end{table}

\hypertarget{sec-linear-programming}{%
\section{线性规划}\label{sec-linear-programming}}

\href{https://cran.r-project.org/package=clpAPI}{clpAPI} 线性规划求解器。\href{https://www.gnu.org/software/glpk/}{glpk} 的两个 R 接口 -- \href{https://cran.r-project.org/package=glpkAPI}{glpkAPI} 和 \href{https://CRAN.R-project.org/package=Rglpk}{Rglpk} 提供线性规划和混合整数规划的求解能力。\href{http://lpsolve.sourceforge.net/}{lp\_solve} 的两个 R 接口 -- \href{https://cran.r-project.org/package=lpSolveAPI}{lpSolveAPI} 和 \href{https://github.com/gaborcsardi/lpSolve}{lpSolve} 也提供类似的能力。\href{https://github.com/dirkschumacher/ompr}{ompr} 求解混合整数线性规划问题。

举个例子，如下

\begin{equation*}
\begin{array}{l}
  \min_x \quad -6x_1 -5x_2 \\
    s.t.\left\{ 
    \begin{array}{l}
    x_1  + 4x_2 \leq 16\\
    6x_1 + 4x_2 \leq 28\\
    2x_1 - 5x_2 \leq 6
    \end{array} \right.
\end{array}
\end{equation*}

写成矩阵形式

\begin{equation*}
\begin{array}{l}
\min_x \quad
  \begin{bmatrix}
  -6  \\
  -5
  \end{bmatrix}
  ^{T} x \\
s.t.\left\{ 
 \begin{array}{l}
  \begin{bmatrix}
  1 & 4  \\
  6 & 4  \\
  2 & -5 
  \end{bmatrix}
  x \leq
  \begin{bmatrix}
   16 \\
   28 \\
   6
  \end{bmatrix}
 \end{array} \right.
\end{array} 
\end{equation*}

对应成 R 代码如下

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# lpSolve 添加约束条件}
\FunctionTok{library}\NormalTok{(lpSolve)}
\CommentTok{\# 目标}
\NormalTok{f.obj }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{)}
\CommentTok{\# 约束}
\NormalTok{f.con }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 方向}
\NormalTok{f.dir }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{)}
\CommentTok{\# 右手边}
\NormalTok{f.rhs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{28}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{lp}\NormalTok{(}\StringTok{"min"}\NormalTok{, f.obj, f.con, f.dir, f.rhs)}
\NormalTok{res}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -31.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.4 3.4
\end{verbatim}

\hypertarget{sec-integer-programming}{%
\section{整数规划}\label{sec-integer-programming}}

\hypertarget{common-integer-programming}{%
\subsection{一般整数规划}\label{common-integer-programming}}

\begin{equation*}
\begin{array}{l}
  \max_x \quad 0.2x_1 + 0.6x_2 \\
    s.t.\left\{ 
    \begin{array}{l}
    5x_1  + 3x_2 \leq 250\\
    -3x_1 + 2x_2 \leq 4\\
    x_1,x_2 \geq 0, \quad x_1,x_2 \in \mathbb{Z}
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标}
\NormalTok{f.obj }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.6}\NormalTok{)}
\CommentTok{\# 约束}
\NormalTok{f.con }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 方向}
\NormalTok{f.dir }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{)}
\CommentTok{\# 右手边}
\NormalTok{f.rhs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{250}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\CommentTok{\# 限制两个变量都是整数}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{lp}\NormalTok{(}\StringTok{"max"}\NormalTok{, f.obj, f.con, f.dir, f.rhs, }\AttributeTok{int.vec=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{)}
\NormalTok{res}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 29.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 26 40
\end{verbatim}

\hypertarget{binary-integer-programming}{%
\subsection{0-1 整数规划}\label{binary-integer-programming}}

\begin{equation*}
\begin{array}{l}
  \max_x \quad 0.2x_1 + 0.6x_2 \\
    s.t.\left\{ 
    \begin{array}{l}
    5x_1  + 3x_2 \leq 250\\
    -3x_1 + 2x_2 \leq 4\\
    x_1,x_2 \in \{0,1\}
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标}
\NormalTok{f.obj }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.6}\NormalTok{)}
\CommentTok{\# 约束}
\NormalTok{f.con }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 方向}
\NormalTok{f.dir }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{)}
\CommentTok{\# 右手边}
\NormalTok{f.rhs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{250}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\CommentTok{\# 限制两个变量都是0{-}1整数}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{lp}\NormalTok{(}\StringTok{"max"}\NormalTok{, f.obj, f.con, f.dir, f.rhs, }\AttributeTok{int.vec=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\AttributeTok{all.bin =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{res}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 1
\end{verbatim}

\hypertarget{mixed-integer-programming}{%
\subsection{混合整数规划}\label{mixed-integer-programming}}

一部分变量要求是整数

\begin{equation*}
\begin{array}{l}
  \max_x \quad 3x_1 + 7x_2 - 12x_3 \\
    s.t.\left\{ 
    \begin{array}{l}
    5x_1 + 7x_2 + 2x_3 \leq 61\\
    3x_1 + 2x_2 - 9x_3 \leq 35\\
    x_1 + 3x_2 + x_3 \leq 31\\
    x_1,x_2 \geq 0, \quad x_2, x_3 \in \mathbb{Z}, \quad x_3 \in [-10, 10]
    \end{array} \right.
\end{array}
\end{equation*}

矩阵形式如下

\begin{equation*}
\begin{array}{l}
\min_x \quad
  \begin{bmatrix}
  3  \\
  7  \\
  -12
  \end{bmatrix}
  ^{T} x \\
s.t.\left\{ 
 \begin{array}{l}
  \begin{bmatrix}
  5 & 7 & 2 \\
  3 & 2 & -9\\
  1 & 3 & 1
  \end{bmatrix}
  x \leq
  \begin{bmatrix}
   61 \\
   35 \\
   31
  \end{bmatrix}
 \end{array} \right.
\end{array} 
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{L\_objective}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{7}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{12}\NormalTok{)),}
  \CommentTok{\# 指定变量类型：第1个变量是连续值，第2、3个变量是整数}
  \AttributeTok{types =} \FunctionTok{c}\NormalTok{(}\StringTok{"C"}\NormalTok{, }\StringTok{"I"}\NormalTok{, }\StringTok{"I"}\NormalTok{),}
  \AttributeTok{constraints =} \FunctionTok{L\_constraint}\NormalTok{(}
    \AttributeTok{L =} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
      \DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{2}\NormalTok{,}
      \DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{9}\NormalTok{,}
      \DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}
\NormalTok{    ), }\AttributeTok{ncol =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{dir =} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{),}
    \AttributeTok{rhs =} \FunctionTok{c}\NormalTok{(}\DecValTok{61}\NormalTok{, }\DecValTok{35}\NormalTok{, }\DecValTok{31}\NormalTok{)}
\NormalTok{  ),}
  \CommentTok{\# 添加约束：第3个变量的下、上界分别是 {-}10 和 10}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{li =} \DecValTok{3}\NormalTok{, }\AttributeTok{ui =} \DecValTok{3}\NormalTok{, }\AttributeTok{lb =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{ub =} \DecValTok{10}\NormalTok{, }\AttributeTok{nobj =} \DecValTok{3}\NormalTok{),}
  \AttributeTok{maximum =} \ConstantTok{TRUE}
\NormalTok{)}
\NormalTok{op}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ROI Optimization Problem:
## 
## Maximize a linear objective function of length 3 with
## - 1 continuous objective variable,
## - 2 integer objective variables,
## 
## subject to
## - 3 constraints of type linear.
## - 1 lower and 1 upper non-standard variable bound.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"lpsolve"}\NormalTok{)}
\NormalTok{res}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  0.3333333  8.0000000 -2.0000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 81
\end{verbatim}

\hypertarget{sec-quadratic-programming}{%
\section{二次规划}\label{sec-quadratic-programming}}

\hypertarget{sec-strictly-convex-quadratic-program}{%
\subsection{凸二次规划}\label{sec-strictly-convex-quadratic-program}}

在 R 中使用 \textbf{quadprog} \citep{quadprog2019} 包求解二次规划\footnote{\url{https://rwalk.xyz/solving-quadratic-progams-with-rs-quadprog-package/}}，\textbf{quadprogXT} 包用来求解带绝对值约束的二次规划，\textbf{pracma} \citep{pracma2021}包提供 \texttt{quadprog()} 函数就是对 \textbf{quadprog} 包的 \texttt{solve.QP()} 进行封装，调用风格更像 Matlab。\textbf{quadprog} 包实现了 Goldfarb and Idnani (1982, 1983) 提出的对偶方法，主要用来求解带线性约束的严格凸二次规划问题。quadprog 求解的二次型的形式如下：

\[\min_b - d^{\top}b +\frac{1}{2}b^{\top}Db , \quad A^{\top}b \geq b_{0}\]

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{solve.QP}\NormalTok{(Dmat, dvec, Amat, bvec, }\AttributeTok{meq =} \DecValTok{0}\NormalTok{, }\AttributeTok{factorized =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

参数 \texttt{Dmat}、\texttt{dvec}、\texttt{Amat}、\texttt{bvec} 分别对应二次规划问题中的 \(D,d,A,b_{0}\)。下面举个二次规划的具体例子

\[
D = \begin{bmatrix}2 & -1\\
-1 & 2
\end{bmatrix}, \quad
d = (-3,2), \quad
A = \begin{bmatrix}1 & 1\\
-1 & 1 \\
0  & -1
\end{bmatrix}, \quad
b_{0} = (2,-2,-3)
\] 即目标函数 \[Q(x,y) = x^2 + y^2 -xy+3x-2y+4\] 它的可行域如图\ref{fig:feasible-region}所示

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\FloatTok{5.5}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\FloatTok{3.5}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"x"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"y"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Feasible Region"}
\NormalTok{)}
\FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{border =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/feasible-region-1} 

}

\caption{可行域}\label{fig:feasible-region}
\end{figure}

调用 \textbf{quadprog} 包的 \texttt{solve.QP()} 函数求解此二次规划问题

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(quadprog)}
\NormalTok{Dmat }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{dvec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{A }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{bvec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{)}
\NormalTok{Amat }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(A)}
\NormalTok{sol }\OtherTok{\textless{}{-}} \FunctionTok{solve.QP}\NormalTok{(}\AttributeTok{Dmat =}\NormalTok{ Dmat, }\AttributeTok{dvec =}\NormalTok{ dvec, }\AttributeTok{Amat =}\NormalTok{ Amat, }\AttributeTok{bvec =}\NormalTok{ bvec)}
\NormalTok{sol}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $solution
## [1] 0.1666667 1.8333333
## 
## $value
## [1] -0.08333333
## 
## $unconstrained.solution
## [1] -1.3333333  0.3333333
## 
## $iterations
## [1] 2 0
## 
## $Lagrangian
## [1] 1.5 0.0 0.0
## 
## $iact
## [1] 1
\end{verbatim}

ROI 默认的二次规划的标准形式为 \(\frac{1}{2}x^{\top}Qx + a^{\top}x\)，在传递参数值的时候注意和上面的区别。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ROI)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{Q\_objective}\NormalTok{(}\AttributeTok{Q =}\NormalTok{ Dmat, }\AttributeTok{L =} \SpecialCharTok{{-}}\NormalTok{dvec),}
  \AttributeTok{constraints =} \FunctionTok{L\_constraint}\NormalTok{(A, }\FunctionTok{rep}\NormalTok{(}\StringTok{"\textgreater{}="}\NormalTok{, }\DecValTok{3}\NormalTok{), bvec),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 默认求最小}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.slsqp"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.08333333
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.1666667 1.8333333
\end{verbatim}

对变量 \(x\) 添加整型约束，原二次规划即变成混合整数二次规划 （Mixed Integer Quadratic Programming，简称 MIQP）

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目前开源的求解器都不能处理 MIQP 问题}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{Q\_objective}\NormalTok{(}\AttributeTok{Q =}\NormalTok{ Dmat, }\AttributeTok{L =} \SpecialCharTok{{-}}\NormalTok{dvec),}
  \AttributeTok{constraints =} \FunctionTok{L\_constraint}\NormalTok{(A, }\FunctionTok{rep}\NormalTok{(}\StringTok{"\textgreater{}="}\NormalTok{, }\DecValTok{3}\NormalTok{), bvec),}
  \AttributeTok{types =} \FunctionTok{c}\NormalTok{(}\StringTok{"I"}\NormalTok{, }\StringTok{"C"}\NormalTok{),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 默认求最小}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.slsqp"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

在可行域上画出等高线，标记目标解的位置，图中红点表示无约束下的解，黄点表示线性约束下的解

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{qp\_sol }\OtherTok{\textless{}{-}}\NormalTok{ sol}\SpecialCharTok{$}\NormalTok{solution }\CommentTok{\# 二次规划的解}
\NormalTok{uc\_sol }\OtherTok{\textless{}{-}}\NormalTok{ sol}\SpecialCharTok{$}\NormalTok{unconstrained.solution }\CommentTok{\# 无约束情况下的解}
\CommentTok{\# 画图}
\FunctionTok{library}\NormalTok{(lattice)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\FloatTok{5.5}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{500}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\FloatTok{3.5}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{500}\NormalTok{)}
\NormalTok{grid }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)}
\CommentTok{\# 二次规划的目标函数}
\NormalTok{grid}\SpecialCharTok{$}\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(grid, x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x }\SpecialCharTok{{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ y }\SpecialCharTok{+} \DecValTok{4}\NormalTok{)}
\FunctionTok{levelplot}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y, grid,}
  \AttributeTok{cuts =} \DecValTok{40}\NormalTok{,}
  \AttributeTok{panel =} \ControlFlowTok{function}\NormalTok{(...) \{}
    \FunctionTok{panel.levelplot}\NormalTok{(...)}
    \FunctionTok{panel.polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{),}
      \AttributeTok{border =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"transparent"}
\NormalTok{    )}
    \FunctionTok{panel.points}\NormalTok{(}
      \FunctionTok{c}\NormalTok{(uc\_sol[}\DecValTok{1}\NormalTok{], qp\_sol[}\DecValTok{1}\NormalTok{]),}
      \FunctionTok{c}\NormalTok{(uc\_sol[}\DecValTok{2}\NormalTok{], qp\_sol[}\DecValTok{2}\NormalTok{]),}
      \AttributeTok{lwd =} \DecValTok{5}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"red"}\NormalTok{, }\StringTok{"yellow"}\NormalTok{), }\AttributeTok{pch =} \DecValTok{19}
\NormalTok{    )}
\NormalTok{  \},}
  \AttributeTok{colorkey =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{col.regions =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{40}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/quadprog-1} 

}

\caption{无约束和有约束条件下的解}\label{fig:quadprog}
\end{figure}

\hypertarget{subsec-semidefinite-optimization}{%
\subsection{半正定二次优化}\label{subsec-semidefinite-optimization}}

kernlab 提供基于核的机器学习方法，可用于分类、回归、聚类、异常检测、分位回归、降维等场景，包含支撑向量机、谱聚类、核PCA、高斯过程和二次规划求解器，将优化方法用于机器学习，展示二者的关系。

R 包 kernlab 的函数 \texttt{ipop()} 实现内点法可以求解半正定的二次规划问题，对应到上面的例子，就是要求 \(A \geq 0\)，而 R 包 quadprog 只能求解正定的二次规划问题，即要求 \(A > 0\)。

以二分类问题为例，采用 SMO (Sequential Minimization Optimization) 求解器，将 SVM 的二次优化问题分解。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(kernlab)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{120}\NormalTok{), }\DecValTok{60}\NormalTok{, }\DecValTok{2}\NormalTok{), }\FunctionTok{matrix}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{120}\NormalTok{, }\AttributeTok{mean =} \DecValTok{3}\NormalTok{), }\DecValTok{60}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{60}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{60}\NormalTok{)))}
\NormalTok{svp }\OtherTok{\textless{}{-}} \FunctionTok{ksvm}\NormalTok{(x, y, }\AttributeTok{type =} \StringTok{"C{-}svc"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(svp, }\AttributeTok{data =}\NormalTok{ x)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/toy-binary-1} 

}

\caption{二分类问题}\label{fig:toy-binary}
\end{figure}

\hypertarget{sec-nonlinear-programming}{%
\section{非线性规划}\label{sec-nonlinear-programming}}

开源的非线性优化求解器，推荐使用 nloptr，它支持全局优化，同时推荐 ROI，它有统一的接口函数。

\hypertarget{sec-one-dimensional-optimization}{%
\subsection{一元非线性优化}\label{sec-one-dimensional-optimization}}

下面考虑一个稍微复杂的一元函数优化问题，求复合函数的极值

\[
g(x) = \int_{0}^{x} -\sqrt{t}\exp(-t^2) \mathrm{dt}, \quad f(y) = \int_{0}^{y} g(s) \exp(-s) \mathrm{ds}
\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{g }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{integrate}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(t) \{}
    \SpecialCharTok{{-}}\FunctionTok{sqrt}\NormalTok{(t) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{t}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{  \}, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =}\NormalTok{ x)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{\}}

\NormalTok{f }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y) \{}
  \FunctionTok{integrate}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(s) \{}
    \FunctionTok{Vectorize}\NormalTok{(g, }\StringTok{"x"}\NormalTok{)(s) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{s)}
\NormalTok{  \}, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =}\NormalTok{ y)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{\}}

\FunctionTok{optimize}\NormalTok{(f, }\AttributeTok{interval =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{maximum =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $minimum
## [1] 66.84459
## 
## $objective
## [1] -0.3201572
\end{verbatim}

\begin{rmdtip}{提示}

计算积分的时候，输入了一系列 s 值，参数是向量，而函数 g 只支持输入参数是单个值，\texttt{g(c(1,2))} 会报错，因此上面对函数 \texttt{g()} 用了向量化函数 \texttt{Vectorize()} 操作。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{g}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.453392
\end{verbatim}

类似地，同时计算多个目标函数 \texttt{f(y)} 的值，也需要\texttt{Vectorize()} 实现向量化操作。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Vectorize}\NormalTok{(f, }\StringTok{"y"}\NormalTok{)(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.1103310 -0.2373865
\end{verbatim}

\end{rmdtip}

\hypertarget{sec-nonlinear-unconstrained-optimization}{%
\subsection{多元非线性无约束优化}\label{sec-nonlinear-unconstrained-optimization}}

下面这些用来测试优化算法的函数来自\href{https://en.wikipedia.org/wiki/Test_functions_for_optimization}{维基百科}

\hypertarget{himmelblau}{%
\subsubsection{Himmelblau 函数}\label{himmelblau}}

Himmelblau 函数是一个多摸函数，常用于比较优化算法的优劣。

\[f(x_1,x_2) = (x_1^2 + x_2 -11)^2 + (x_1 + x_2^2 -7)^2\] 它在四个位置取得一样的极小值，分别是 \(f(-3.7793, -3.2832) = 0\)，\(f(-2.8051, 3.1313) = 0\)，\(f(3, 2) = 0\)，\(f(3.5844, -1.8481) = 0\)。函数图像见图 \ref{fig:himmelblau}。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{   (x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{11}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}} \DecValTok{7}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{library}\NormalTok{(lattice)}
\CommentTok{\# 减少三维图形的边空}
\FunctionTok{lattice.options}\NormalTok{(}
  \AttributeTok{layout.widths =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{left.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\NormalTok{.}\DecValTok{6}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{),}
    \AttributeTok{right.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\FloatTok{1.0}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{layout.heights =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{bottom.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\NormalTok{.}\DecValTok{8}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{),}
    \AttributeTok{top.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\FloatTok{1.0}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \SpecialCharTok{{-}}\DecValTok{240}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/himmelblau-1} 

}

\caption{Himmelblau 函数图像}\label{fig:himmelblau}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 梯度函数}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{])) }
\NormalTok{\}}
\FunctionTok{optim}\NormalTok{(}\AttributeTok{par =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =}\NormalTok{ gr, }\AttributeTok{method =} \StringTok{"BFGS"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] -2.805118  3.131313
## 
## $value
## [1] 2.069971e-27
## 
## $counts
## function gradient 
##       42       15 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
\end{verbatim}

\hypertarget{rosenbrock}{%
\subsubsection{Rosenbrock 函数}\label{rosenbrock}}

\href{https://en.wikipedia.org/wiki/Rosenbrock_function}{香蕉函数} 定义如下：

\[f(x_1,x_2) = 100 (x_2 -x_1^2)^2 + (1 - x_1)^2\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  (}\DecValTok{100} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{2.5}\NormalTok{, }\FloatTok{2.5}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{2.5}\NormalTok{, }\FloatTok{2.5}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/rosenbrock-1} 

}

\caption{香蕉函数图像}\label{fig:rosenbrock}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{r }\OtherTok{\textless{}{-}}\NormalTok{ raster}\SpecialCharTok{::}\FunctionTok{rasterFromXYZ}\NormalTok{(df, }\AttributeTok{crs =} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+proj=longlat +datum=WGS84"}\NormalTok{))}
\NormalTok{rasterVis}\SpecialCharTok{::}\FunctionTok{vectorplot}\NormalTok{(r, }\AttributeTok{par.settings =} \FunctionTok{RdBuTheme}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 梯度函数}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{])) }
\NormalTok{\}}
\FunctionTok{optim}\NormalTok{(}\AttributeTok{par =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =}\NormalTok{ gr, }\AttributeTok{method =} \StringTok{"BFGS"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] 1 1
## 
## $value
## [1] 9.595012e-18
## 
## $counts
## function gradient 
##      110       43 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 2L, }\AttributeTok{G =}\NormalTok{ gr),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\AttributeTok{ud =} \DecValTok{3}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 2L)}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.lbfgs"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.364878e-17
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 1
\end{verbatim}

\hypertarget{ackley}{%
\subsubsection{Ackley 函数}\label{ackley}}

Ackley 函数是一个非凸函数，有大量局部极小值点，获取全局极小值点是一个比较有挑战的事。它的 \(n\) 维形式如下： \[f(\mathbf{x}) = - a \mathrm{e}^{-b\sqrt{\frac{1}{n}\sum_{i=1}^{n}x_{i}^{2}}} - \mathrm{e}^{\frac{1}{n}\sum_{i=1}^{n}\cos(cx_i)} + a + \mathrm{e}\] 其中，\(a = 20, b = 0.2, c = 2\pi\)，对 \(\forall i = 1,2,\cdots, n\)，\(x_i \in [-10, 10]\)，\(f(\mathbf{x})\) 在 \(\mathbf{x}^{\star} = (0,0,\cdot,0)\) 取得全局最小值 \(f(\mathbf{x}^{\star}) = 0\)，二维图像如图 \ref{fig:ackley}。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{a =} \DecValTok{20}\NormalTok{, }\AttributeTok{b =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{c =} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi) \{}
\NormalTok{  mean1 }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{  mean2 }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(}\FunctionTok{cos}\NormalTok{(c }\SpecialCharTok{*}\NormalTok{ x))}
  \SpecialCharTok{{-}}\NormalTok{a }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{b }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(mean1)) }\SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(mean2) }\SpecialCharTok{+}\NormalTok{ a }\SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/ackley-1} 

}

\caption{二维 Ackley 函数图像}\label{fig:ackley}
\end{figure}

以 10 维的 Ackley 函数为例，先试一下普通的局部优化算法 --- Nelder--Mead 算法，选择初值 \((2,2,\cdots,2)\) ，看下效果，再与全局优化算法比较。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 10L),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{ud =} \DecValTok{10}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 10L)}
\NormalTok{)}

\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.neldermead"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 2 2 2 2 2 2 2 2 2 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6.593599
\end{verbatim}

可以说完全没有优化效果，已经陷入局部极小值。根据\href{https://nlopt.readthedocs.io/en/latest/NLopt_Algorithms/\#global-optimization}{nloptr 全局优化算法}的介绍，这里采用 directL 算法，因为是全局优化，不用选择初值。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 调全局优化器}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.directL"}\NormalTok{)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 0 0 0 0 0 0 0 0 0 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4.440892e-16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6.593599
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6.593599
\end{verbatim}

\hypertarget{radistrigin}{%
\subsubsection{Radistrigin 函数}\label{radistrigin}}

这里，还有另外一个例子，Radistrigin 函数也是多摸函数

\[f(\mathbf{x})= \sum_{i=1}^{n}\big(x_i^2 - 10 \cos(2\pi x_i) + 10\big)\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}} \DecValTok{10} \SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{*}\NormalTok{ x) }\SpecialCharTok{+} \DecValTok{10}\NormalTok{)}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{65}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/radistrigin-1} 

}

\caption{Radistrigin 函数}\label{fig:radistrigin}
\end{figure}

设置 10 维 的优化

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 10L),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\AttributeTok{ud =} \DecValTok{50}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 10L)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调全局优化器求解非凸优化问题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.directL"}\NormalTok{)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 0 0 0 0 0 0 0 0 0 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

\hypertarget{schaffer}{%
\subsubsection{Schaffer 函数}\label{schaffer}}

\[
f(x_1,x_2) = 0.5 + \frac{\sin^2(x_1^2 - x_2^2) - 0.5}{ [1 + 0.001(x_1^2 + x_2^2)]^2}
\] 在 \(\mathbf{x}^\star = (0,0)\) 处取得全局最小值 \(f(\mathbf{x}^\star) = 0\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FloatTok{0.5} \SpecialCharTok{+}\NormalTok{ ((}\FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FloatTok{0.001}\SpecialCharTok{*}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{length =} \DecValTok{201}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{length =} \DecValTok{201}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/schaffer-01-1} 

}

\caption{Schaffer 函数}\label{fig:schaffer-01}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/schaffer-02-1} 

}

\caption{Schaffer 函数}\label{fig:schaffer-02}
\end{figure}

\hypertarget{holder}{%
\subsubsection{Hölder 函数}\label{holder}}

Hölder 桌面函数

\[
f(x_1,x_2) = - | \sin(x_1)\cos(x_2)\exp\big(| 1 - \frac{\sqrt{x_1^2 + x_2^2}}{\pi}|\big) |
\]

在 \((8.05502, 9.66459)\)、\((-8.05502, 9.66459)\)、\((8.05502, -9.66459)\)、\((-8.05502, -9.66459)\) 同时取得最小值 \(-19.2085\)。



\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \SpecialCharTok{{-}}\FunctionTok{abs}\NormalTok{(}\FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\FunctionTok{abs}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{sqrt}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ pi))}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{60}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/holder-1} 

}

\caption{Hölder 函数}\label{fig:holder}
\end{figure}

\hypertarget{trid}{%
\subsubsection{Trid 函数}\label{trid}}

\(n \geq 2\) 维 Trid 函数

\[
f(x) = \sum_{i=1}^{n}(x_i - 1)^2 - \sum_{i=2}^{n}x_i x_{i-1}
\] \(\forall i = 1,2,\cdots, n\)，\(f(x)\) 在 \(x_i = i(n+1-i)\) 处取得全局极小值 \(f(\mathbf{x}^\star)=-n(n+4)(n-1)/6\)，取值区间 \(x \in [-n^2, n^2], \forall i = 1,2,\cdots,n\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(x)}
  \FunctionTok{sum}\NormalTok{((x }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\SpecialCharTok{{-}}\NormalTok{n])}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \SpecialCharTok{{-}}\DecValTok{60}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/trid-1} 

}

\caption{Trid 函数}\label{fig:trid}
\end{figure}

\hypertarget{super-complex-function}{%
\subsubsection{超级复杂函数}\label{super-complex-function}}

有如下复杂的目标函数

\begin{equation*}
\begin{array}{l}
  \min_x \quad \cos(x_1)\cos(x_2) - \sum_{i=1}^{5}\Big( (-1)^i \cdot i \cdot 2 \cdot \exp\big(-500 \cdot ( (x_1 - i \cdot 2)^2 + (x_2 - i\cdot 2)^2 ) \big) \Big) \\
    s.t. \quad -50 \leq x_1, x_2 \leq 50
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{subfun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(i, m) \{}
\NormalTok{  (}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{i }\SpecialCharTok{*}\NormalTok{ i }\SpecialCharTok{*} \DecValTok{2} \SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{500} \SpecialCharTok{*}\NormalTok{ ((m[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ i }\SpecialCharTok{*} \DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (m[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ i }\SpecialCharTok{*} \DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\NormalTok{\}}

\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{cos}\NormalTok{(x[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(x[}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{{-}}
    \FunctionTok{sum}\NormalTok{(}\FunctionTok{mapply}\NormalTok{(}\AttributeTok{FUN =}\NormalTok{ subfun, }\AttributeTok{i =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{m =}\NormalTok{ x)))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

目标函数的图像见图 \ref{fig:super-function}，搜索区域 \([-50, 50] \times [-50, 50]\) 内几乎没有变化的梯度，给寻优过程带来很大困难。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{65}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/super-function-1} 

}

\caption{函数图像}\label{fig:super-function}
\end{figure}

将区域 \([0, 12] \times [0, 12]\) 的图像绘制出来，不难发现，有不少局部陷阱。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{65}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/zoom-super-function-1} 

}

\caption{局部放大函数图像}\label{fig:zoom-super-function}
\end{figure}

最优解在 \((7.999982, 7.999982)\) 取得，目标函数值为 -7.978832。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{7.999982}\NormalTok{, }\FloatTok{7.999982}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -7.978832
\end{verbatim}

面对如此复杂的函数，调用全局优化器

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 2L),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\AttributeTok{ud =} \DecValTok{50}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 2L)}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.directL"}\NormalTok{)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 22.22222  0.00000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.9734211
\end{verbatim}

实际上，还是陷入局部最优解。

\begin{verbatim}
SETS:
P/1..5/;
Endsets
Min=@cos(x1) * @cos(x2) - @Sum(P(j): (-1)^j * j * 2 * @exp(-500 * ((x1 - j * 2)^2 + (x2 - j * 2)^2)));
@Bnd(-50, x1, 50);
@Bnd(-50, x2, 50);
\end{verbatim}

Lingo 18.0 启用全局优化求解器后，在 \((x_1 = 7.999982, x_2 = 7.999982)\) 取得最小值 -7.978832。而默认未启用全局优化求解器的情况下，在 \((x_1 = 18.84956, x_2 = -40.84070)\) 取得局部极小值 -1.000000。

\hypertarget{sec-nonlinear-constrained-optimization}{%
\subsection{多元非线性约束优化}\label{sec-nonlinear-constrained-optimization}}

R 自带的函数 \texttt{nlminb()} 可求解无约束、箱式约束优化问题，\texttt{constrOptim()} 还可求解线性不等式约束优化，其中包括带线性约束的二次规划。\texttt{optim()} 提供一大类优化算法，且包含随机优化算法---模拟退火算法，可求解无约束、箱式约束优化问题。

\hypertarget{box-constrained-optimization}{%
\subsubsection{普通箱式约束}\label{box-constrained-optimization}}

有如下箱式约束优化问题，目标函数和\href{https://en.wikipedia.org/wiki/Rosenbrock_function}{香蕉函数}有些相似。

\begin{equation*}
\begin{array}{l}
  \min_x \quad (x_1 - 1)^2 + 4\sum_{i =1}^{n -1}(x_{i+1} -x_i^2)^2  \\
    s.t. \quad 2 \leq x_1,x_2,\cdots,x_n \leq 4
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(x)}
  \FunctionTok{sum}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{*}\NormalTok{ (x }\SpecialCharTok{{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, x[}\SpecialCharTok{{-}}\NormalTok{n])}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\(n\) 维目标函数是非线性的，给定初值 \((3, 3, \cdots, 3)\)，下面求解 25 维的箱式约束，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nlminb}\NormalTok{(}\AttributeTok{start =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{objective =}\NormalTok{ fn, }\AttributeTok{lower =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
##  [9] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
## [17] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.109093
## [25] 4.000000
## 
## $objective
## [1] 368.1059
## 
## $convergence
## [1] 0
## 
## $iterations
## [1] 6
## 
## $evaluations
## function gradient 
##       10      177 
## 
## $message
## [1] "relative convergence (4)"
\end{verbatim}

\texttt{nlminb()} 出于历史兼容性的原因尚且存在，最优解的第24个分量没有在可行域的边界上。使用 \texttt{constrOptim()} 函数求解，默认求极小，需将箱式或线性不等式约束写成矩阵形式，即 \(Ax \geq b\) 的形式，参数 ui 是 \(k \times n\) 的约束矩阵 \(A\)，ci 是右侧 \(k\) 维约束向量 \(b\)。以上面的优化问题为例，将箱式约束 \(2 \leq x_1,x_2 \leq 4\) 转化为矩阵形式，约束矩阵和向量分别为：

\[
A = \begin{bmatrix}
1  & 0  \\
0  & 1 \\
-1 & 0 \\
0  & -1
\end{bmatrix}, \quad
b = (2, 2, -4, -4)
\]

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{constrOptim}\NormalTok{(}
  \AttributeTok{theta =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\CommentTok{\# 初始值}
  \AttributeTok{f =}\NormalTok{ fn, }\CommentTok{\# 目标函数}
  \AttributeTok{method =} \StringTok{"Nelder{-}Mead"}\NormalTok{, }\CommentTok{\# 没有提供梯度，则必须用 Nelder{-}Mead 方法}
  \AttributeTok{ui =} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{)), }\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{))),}
  \AttributeTok{ci =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.006142 2.002260 2.003971 2.003967 2.004143 2.004255 2.001178 2.002990
##  [9] 2.003883 2.006029 2.017345 2.009236 2.000949 2.007793 2.025831 2.007896
## [17] 2.004514 2.004381 2.008771 2.015695 2.005803 2.009127 2.017988 2.257782
## [25] 3.999846
## 
## $value
## [1] 378.4208
## 
## $counts
## function gradient 
##    12048       NA 
## 
## $convergence
## [1] 1
## 
## $message
## NULL
## 
## $outer.iterations
## [1] 25
## 
## $barrier.value
## [1] -0.003278963
\end{verbatim}

从求解的结果来看，convergence = 1 意味着迭代次数到达默认的极限 maxit = 500，结合 \texttt{nlminb()} 函数的求解结果来看，实际上还没有收敛。如果没有提供梯度，则必须用 Nelder-Mead 方法，下面增加迭代次数到 1000。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{constrOptim}\NormalTok{(}
  \AttributeTok{theta =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\CommentTok{\# 初始值}
  \AttributeTok{f =}\NormalTok{ fn, }\CommentTok{\# 目标函数}
  \AttributeTok{method =} \StringTok{"Nelder{-}Mead"}\NormalTok{, }
  \AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maxit =} \DecValTok{1000}\NormalTok{),}
  \AttributeTok{ui =} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{)), }\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{))),}
  \AttributeTok{ci =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.000081 2.000142 2.001919 2.000584 2.000007 2.000003 2.001097 2.001600
##  [9] 2.000207 2.000042 2.000250 2.000295 2.000580 2.002165 2.000453 2.000932
## [17] 2.000456 2.000363 2.000418 2.000474 2.009483 2.001156 2.003173 2.241046
## [25] 3.990754
## 
## $value
## [1] 370.8601
## 
## $counts
## function gradient 
##    18036       NA 
## 
## $convergence
## [1] 1
## 
## $message
## NULL
## 
## $outer.iterations
## [1] 19
## 
## $barrier.value
## [1] -0.003366467
\end{verbatim}

还是没有收敛，可见 Nelder-Mead 方法在这个优化问题上收敛速度比较慢。下面考虑调用基于梯度的优化算法 --- BFGS 方法。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 输入 n 维向量，输出 n 维向量}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(x)}
  \FunctionTok{c}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{))}
  \SpecialCharTok{+}\DecValTok{8} \SpecialCharTok{*} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\SpecialCharTok{{-}}\NormalTok{n]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
  \SpecialCharTok{{-}}\DecValTok{16} \SpecialCharTok{*} \FunctionTok{c}\NormalTok{(x[}\SpecialCharTok{{-}}\NormalTok{n], }\DecValTok{0}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{c}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\SpecialCharTok{{-}}\NormalTok{n]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{\}}

\FunctionTok{constrOptim}\NormalTok{(}
  \AttributeTok{theta =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\CommentTok{\# 初始值}
  \AttributeTok{f =}\NormalTok{ fn, }\CommentTok{\# 目标函数}
  \AttributeTok{grad =}\NormalTok{ gr,}
  \AttributeTok{method =} \StringTok{"BFGS"}\NormalTok{, }
  \AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maxit =} \DecValTok{1000}\NormalTok{),}
  \AttributeTok{ui =} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{)), }\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{))),}
  \AttributeTok{ci =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
##  [9] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
## [17] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000001
## [25] 3.000000
## 
## $value
## [1] 373
## 
## $counts
## function gradient 
##     3721      464 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
## 
## $outer.iterations
## [1] 3
## 
## $barrier.value
## [1] -0.003327104
\end{verbatim}

相比于 Nelder-Mead 方法，目标值 373 更大，可见已陷入局部最优解，下面通过 ROI 包，分别调用求解器 L-BFGS 和 directL，发现前者同样陷入局部最优解，而后者可以获得与 \texttt{nlminb()} 函数一致的结果。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 调用改进的 BFGS 算法}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 25L, }\AttributeTok{G =}\NormalTok{ gr),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \DecValTok{2}\NormalTok{, }\AttributeTok{ud =} \DecValTok{4}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 25L)}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.lbfgs"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 373
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 调全局优化算法}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.directL"}\NormalTok{)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 368.1059
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000
## [10] 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000
## [19] 2.00000 2.00000 2.00000 2.00000 2.00000 2.10913 4.00000
\end{verbatim}

下面再与函数 \texttt{optim()} 提供的 L-BFGS-B 算法比较

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{optim}\NormalTok{(}
  \AttributeTok{par =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{method =} \StringTok{"L{-}BFGS{-}B"}\NormalTok{,}
  \AttributeTok{lower =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
##  [9] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
## [17] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.109093
## [25] 4.000000
## 
## $value
## [1] 368.1059
## 
## $counts
## function gradient 
##        6        6 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH"
\end{verbatim}

值得注意的是，当提供梯度信息的时候，虽然求解速度提升了，但是最优解变差了。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{optim}\NormalTok{(}
  \AttributeTok{par =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =}\NormalTok{ gr, }\AttributeTok{method =} \StringTok{"L{-}BFGS{-}B"}\NormalTok{,}
  \AttributeTok{lower =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3
## 
## $value
## [1] 373
## 
## $counts
## function gradient 
##        2        2 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: NORM OF PROJECTED GRADIENT <= PGTOL"
\end{verbatim}

\hypertarget{nonlinear-strictly-inequality-constraints}{%
\subsubsection{非线性严格不等式约束}\label{nonlinear-strictly-inequality-constraints}}

第一个例子，目标函数是非线性的，约束条件也是非线性的，非线性不等式约束不包含等号。

\begin{equation*}
\begin{array}{l}
  \min_x \quad (x_1 + 3x_2 + x_3)^2 + 4(x_1 - x_2)^2 \\
    s.t.\left\{ 
    \begin{array}{l}
     x_1 + x_2 + x_3 = 1 \\
     6 x_2 + 4 x_3 - x_1^3 > 3 \\
     x_1, x_2, x_3 > 0
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \DecValTok{4} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{+} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]), }\CommentTok{\# 对 x[1] 求偏导}
    \DecValTok{6} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{{-}} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]), }\CommentTok{\# 对 x[2] 求偏导}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\CommentTok{\# 对 x[3] 求偏导}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 等式约束}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{1} 
\NormalTok{\}}
\CommentTok{\# 等式约束的雅可比矩阵}
\CommentTok{\# 这里只有一个等式约束，所以雅可比矩阵行数为 1}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ncol =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\CommentTok{\# 不等式约束}
\CommentTok{\# 要求必须是严格不等式，不能带等号，方向是 x \textgreater{} 0 }
\NormalTok{hin }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}\DecValTok{6} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+} \DecValTok{4} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{{-}} \DecValTok{3}\NormalTok{, x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{], x[}\DecValTok{3}\NormalTok{])}
\NormalTok{\}}
\CommentTok{\# 不等式约束的雅可比矩阵}
\CommentTok{\# 其实是有 4 个不等式约束，3 个目标变量约束，雅可比矩阵行数是 4}
\NormalTok{hin.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \SpecialCharTok{{-}}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{4}\NormalTok{,}
    \DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
    \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{,}
    \DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}
\NormalTok{  ), }\AttributeTok{ncol =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

调用 \textbf{alabama} 包的求解器

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\CommentTok{\# 初始值}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\CommentTok{\# 求目标函数的极小值}
\NormalTok{ans }\OtherTok{\textless{}{-}}\NormalTok{ alabama}\SpecialCharTok{::}\FunctionTok{constrOptim.nl}\NormalTok{(}
  \AttributeTok{par =}\NormalTok{ p0,}
  \CommentTok{\# 目标函数}
  \AttributeTok{fn =}\NormalTok{ fn,}
  \AttributeTok{gr =}\NormalTok{ gr,}
  \CommentTok{\# 等式约束}
  \AttributeTok{heq =}\NormalTok{ heq,}
  \AttributeTok{heq.jac =}\NormalTok{ heq.jac,}
  \CommentTok{\# 不等式约束}
  \AttributeTok{hin =}\NormalTok{ hin,}
  \AttributeTok{hin.jac =}\NormalTok{ hin.jac,}
  \CommentTok{\# 不显示迭代过程}
  \AttributeTok{control.outer =} \FunctionTok{list}\NormalTok{(}\AttributeTok{trace =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{)}
\NormalTok{ans}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] 7.390292e-04 4.497160e-12 9.992610e-01
## 
## $value
## [1] 1.000002
## 
## $counts
## function gradient 
##     1230      163 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
## 
## $hessian
##           [,1]      [,2]      [,3]
## [1,] 120517098 120517087 120517091
## [2,] 120517087 120517115 120517095
## [3,] 120517091 120517095 120517091
## 
## $outer.iterations
## [1] 13
## 
## $lambda
## [1] 4.481599
## 
## $sigma
## [1] 120517089
## 
## $barrier.value
## [1] 0.003472071
## 
## $K
## [1] 4.269112e-08
\end{verbatim}

ans 是 \texttt{constrOptim.nl()} 返回的一个 list， convergence = 0 表示迭代成功收敛，value 表示目标函数在迭代终止时的取直，par 表示满足约束条件，成功收敛的情况下，目标函数的参数值，counts 表示迭代过程中目标函数及其梯度计算的次数。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 不提供梯度函数，照样可以求解}
\NormalTok{ans }\OtherTok{\textless{}{-}}\NormalTok{ alabama}\SpecialCharTok{::}\FunctionTok{constrOptim.nl}\NormalTok{(}\AttributeTok{par =}\NormalTok{ p0, }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{heq =}\NormalTok{ heq, }\AttributeTok{hin =}\NormalTok{ hin)}
\end{Highlighting}
\end{Shaded}

\begin{rmdtip}{注意}
等式和不等式约束的雅可比矩阵必须以 matrix 数据类型存储，而不能以 vector 类型存储。要注意和后面 ROI 包的调用形式区别。

\end{rmdtip}

实际上，可以用 ROI 调用 alabama 求解器的方式，这种方式可以简化目标函数梯度和约束条件的表示

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \DecValTok{4} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{+} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]),}
    \DecValTok{6} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{{-}} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]),}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{])}
\NormalTok{  )}
\NormalTok{\}}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}
\NormalTok{\}}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{\}}
\NormalTok{hin }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \DecValTok{6} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+} \DecValTok{4} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3}
\NormalTok{\}}
\NormalTok{hin.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
   \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

通过 ROI 调用 alabama 求解器

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\CommentTok{\# 初始值}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 3L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 4 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq =}\NormalTok{ heq, }\AttributeTok{hin =}\NormalTok{ hin),}
    \AttributeTok{dir =} \FunctionTok{c}\NormalTok{(}\StringTok{"=="}\NormalTok{, }\StringTok{"\textgreater{}"}\NormalTok{),}
    \AttributeTok{rhs =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{),}
    \CommentTok{\# 等式和不等式约束的雅可比}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq.jac =}\NormalTok{ heq.jac, }\AttributeTok{hin.jac =}\NormalTok{ hin.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \DecValTok{0}\NormalTok{, }\AttributeTok{ud =} \SpecialCharTok{+}\ConstantTok{Inf}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 3L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"alabama"}\NormalTok{, }\AttributeTok{start =}\NormalTok{ p0)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.674812e-06 9.994336e-08 9.999982e-01
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\hypertarget{nonlinear-and-box-constrained}{%
\subsubsection{非线性和箱式约束}\label{nonlinear-and-box-constrained}}

与上面的例子不同，下面这个例子的不等式约束包含等号，还有箱式约束，优化问题来源于\href{https://coin-or.github.io/Ipopt/INTERFACES.html}{Ipopt 官网}，提供的初始值为 \(x_0 = (1,5,5,1)\)，最优解为 \(x_{\star} = (1.00000000,4.74299963,3.82114998,1.37940829)\)。优化问题的具体内容如下：

\begin{equation*}
\begin{array}{l}
  \min_x \quad x_1 x_4 (x_1 + x_2 + x_3) + x_3 \\
    s.t.\left\{ 
    \begin{array}{l}
     x_1^2 + x_2^2 + x_3^2 + x_4^2 = 40 \\
     x_1 x_2 x_3 x_4 \geq 25 \\
     1 \leq x_1, x_2, x_3, x_4 \leq 5
    \end{array} \right.
\end{array}
\end{equation*}

考虑用 ROI 调 nloptr 实现，看结果是否和例子一致，nloptr 支持不等式约束包含等号，支持箱式约束。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 一个 4 维的目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}
\NormalTok{\}}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
\NormalTok{    x[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]), x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{],}
\NormalTok{    x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{])}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 等式约束}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\CommentTok{\# 等式约束的雅可比}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \DecValTok{2} \SpecialCharTok{*} \FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{], x[}\DecValTok{3}\NormalTok{], x[}\DecValTok{4}\NormalTok{])}
\NormalTok{\}}
\CommentTok{\# 不等式约束}
\NormalTok{hin }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{prod}\NormalTok{(x)}
\NormalTok{\}}
\CommentTok{\# 不等式约束的雅可比}
\NormalTok{hin.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]), }\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{]), }\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{]), }\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{]))}
\NormalTok{\}}
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 4L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 4 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq =}\NormalTok{ heq, }\AttributeTok{hin =}\NormalTok{ hin),}
    \AttributeTok{dir =} \FunctionTok{c}\NormalTok{(}\StringTok{"=="}\NormalTok{, }\StringTok{"\textgreater{}="}\NormalTok{),}
    \AttributeTok{rhs =} \FunctionTok{c}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{25}\NormalTok{),}
    \CommentTok{\# 等式和不等式约束的雅可比}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq.jac =}\NormalTok{ heq.jac, }\AttributeTok{hin.jac =}\NormalTok{ hin.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \DecValTok{1}\NormalTok{, }\AttributeTok{ud =} \DecValTok{5}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 4L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数初始值}
\FunctionTok{fn}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数最优值}
\FunctionTok{fn}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{1.00000000}\NormalTok{, }\FloatTok{4.74299963}\NormalTok{, }\FloatTok{3.82114998}\NormalTok{, }\FloatTok{1.37940829}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 17.01402
\end{verbatim}

求解一般的非线性约束问题，求解器 nloptr.mma / nloptr.cobyla 仅支持非线性不等式约束，不支持等式约束，而 nlminb 只支持等式约束，因此，下面分别调用 nloptr.auglag、nloptr.slsqp 和 nloptr.isres 来求解上述优化问题。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.auglag"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.000000 4.743025 3.821117 1.379413
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 17.01402
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.slsqp"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.000000 4.742996 3.821155 1.379408
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 17.01402
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.isres"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.160664 4.593461 4.018491 1.189610
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 17.51191
\end{verbatim}

可以看出，nloptr 提供的优化能力可以覆盖\href{https://github.com/coin-or/Ipopt}{Ipopt 求解器}，推荐使用 nloptr.slsqp 求解器。

\hypertarget{nonlinear-mixed-integer-constrained}{%
\subsubsection{非线性混合整数约束}\label{nonlinear-mixed-integer-constrained}}

\begin{equation*}
\begin{array}{l}
  \max_x \quad 1.5(x_1 - \sin(x_1 - x_2))^2 + 0.5x_2^2 + x_3^2 - x_1 x_2 - 2x_1 + x_2 x_3 \\
    s.t.\left\{ 
    \begin{array}{l}
     -20 < x_1 < 20 \\
     -20 < x_2 < 20 \\
     -10 < x_3 < 10 \\
     x_1, x_2 \in \mathbb{R}, \quad x_3 \in \mathbb{Z}
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FloatTok{1.5} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]))}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \FloatTok{0.5} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}
  \SpecialCharTok{{-}}\NormalTok{x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}
\NormalTok{\}}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \DecValTok{3} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{cos}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{,}
    \DecValTok{3} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{],}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}
\NormalTok{  )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

目前 ROI 还解不了

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 初始值}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{2.1}\NormalTok{, }\FloatTok{5.1}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 3L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 3 个目标变量}
  \AttributeTok{types =} \FunctionTok{c}\NormalTok{(}\StringTok{"C"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"I"}\NormalTok{), }\CommentTok{\# 目标变量的类型}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{lb =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{20}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{20}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{), }\AttributeTok{ub =} \FunctionTok{c}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{nobj =}\NormalTok{ 3L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"auto"}\NormalTok{, }\AttributeTok{start =}\NormalTok{ p0)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

目标函数在 \((4.49712, 9.147501, -4)\) 取得最小值 -86.72165

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.49712}\NormalTok{, }\FloatTok{9.147501}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -86.72165
\end{verbatim}

\hypertarget{complex-object-function}{%
\subsubsection{含复杂目标函数}\label{complex-object-function}}

下面这个目标函数比较复杂，约束条件也是非线性的

\begin{equation*}
\begin{array}{l}
  \max_x \quad \frac{(\sin(2\pi x_1))^3 \sin(2\pi x_2)}{x_1^3 (x_1 + x_2)} \\
    s.t.\left\{ 
    \begin{array}{l}
     x_1^2 - x_2 + 1 \leq 0 \\
     1 - x_1 + (x_2 - 4)^2 \geq 0 \\
     0 \leq x_1, x_2 \leq 10
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) (}\FunctionTok{sin}\NormalTok{(}\DecValTok{2}\SpecialCharTok{*}\NormalTok{pi}\SpecialCharTok{*}\NormalTok{x[}\DecValTok{1}\NormalTok{]))}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(}\DecValTok{2}\SpecialCharTok{*}\NormalTok{pi}\SpecialCharTok{*}\NormalTok{x[}\DecValTok{2}\NormalTok{])}\SpecialCharTok{/}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3}\SpecialCharTok{*}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]))}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]))}
\NormalTok{\}}

\NormalTok{hin }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
\NormalTok{    x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+} \DecValTok{1}\NormalTok{,}
    \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ (x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{4}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{hin.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{], }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
    \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}
\NormalTok{  ),}
  \AttributeTok{ncol =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{  )}
\NormalTok{\}}

\CommentTok{\# 初始值}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 2L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 2 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{hin =}\NormalTok{ hin),}
    \AttributeTok{dir =} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{),}
    \AttributeTok{rhs =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \CommentTok{\# 不等式约束的雅可比}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{hin.jac =}\NormalTok{ hin.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \DecValTok{0}\NormalTok{, }\AttributeTok{ud =} \DecValTok{10}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 2L),}
  \AttributeTok{maximum =} \ConstantTok{TRUE} \CommentTok{\# 求最大}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.isres"}\NormalTok{, }\AttributeTok{start =}\NormalTok{ p0)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.227969 4.245375
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.09582504
\end{verbatim}

下面再给一个来自 \href{https://octave.org/doc/v6.2.0/Nonlinear-Programming.html}{Octave 优化文档} 的示例，该优化问题包含多个非线性的等式约束。

\begin{equation*}
\begin{array}{l}
  \min_x \quad \mathrm{e}^{\prod_{i=1}^{5} x_i} - \frac{1}{2}(x_1^3 + x_2^3 + 1)^2 \\
    s.t.\left\{ 
    \begin{array}{l}
     \sum_{i=1}^{5}x_i^2 - 10 = 0 \\
     x_2 x_3 - 5x_4 x_5 = 0 \\
     x_1^3 + x_2^3 + 1 = 0
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 一个 5 维的目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x)) }\SpecialCharTok{{-}} \FloatTok{0.5} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{\}}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{{-}} \DecValTok{3}\SpecialCharTok{*}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{{-}} \DecValTok{3}\SpecialCharTok{*}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{]), }
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{]),}
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{])}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 等式约束}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{10}\NormalTok{,}
\NormalTok{    x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{5}\NormalTok{],}
\NormalTok{    x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+} \DecValTok{1}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 等式约束的雅可比}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{], }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{], }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{], }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{], }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{5}\NormalTok{],}
    \DecValTok{0}\NormalTok{, x[}\DecValTok{3}\NormalTok{], x[}\DecValTok{2}\NormalTok{], }\SpecialCharTok{{-}}\DecValTok{5} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{5}\NormalTok{], }\SpecialCharTok{{-}}\DecValTok{5} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{],}
    \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{ncol =} \DecValTok{5}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{  )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 5L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 5 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq =}\NormalTok{ heq),}
    \AttributeTok{dir =} \StringTok{"=="}\NormalTok{,}
    \AttributeTok{rhs =} \DecValTok{0}\NormalTok{,}
    \CommentTok{\# 等式的雅可比}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq.jac =}\NormalTok{ heq.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\ConstantTok{Inf}\NormalTok{, }\AttributeTok{ud =} \ConstantTok{Inf}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 5L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调用 SQP（序列二次规划） 求解器

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.slsqp"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.8}\NormalTok{, }\FloatTok{1.7}\NormalTok{, }\FloatTok{1.9}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.8}\NormalTok{,}\SpecialCharTok{{-}}\FloatTok{0.8}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1.7171435  1.5957096  1.8272458 -0.7636431 -0.7636431
\end{verbatim}

计算结果和 Octave 的示例一致。

\hypertarget{complex-constrained-function}{%
\subsubsection{含复杂约束条件}\label{complex-constrained-function}}

\begin{equation*}
\begin{array}{l}
  \min_x \quad \exp(\sin(50\cdot x)) + \sin(60\cdot \exp(y)) + \sin(70\cdot\sin(x)) \\
         \qquad + \sin(\sin(80\cdot y)) - \sin(10\cdot (x +y)) + \frac{(x^2 + y^2)^{\sin(y)}}{4} \\
    s.t. \quad \left\{ 
    \begin{array}{l}
     x - \big((\cos(y))^x - x\big)^y = 0 \\
    -50 \leq x_1,x_2 \leq 50
    \end{array} \right.
\end{array}
\end{equation*}

Lingo 代码如下：

\begin{verbatim}
Min = @exp(@sin(50 * x)) + @sin(60 * @exp(y)) + @sin(70 * @sin(x)) 
      + @sin(@sin(80 * y)) - @sin(10 * (x + y)) + (x^2 + y^2)^@sin(y) / 4;

x - (( @cos(y) )^x - x)^y = 0;

@bnd(-50, x, 50);
@bnd(-50, y, 50);
\end{verbatim}

启用全局优化求解器，求解 14 分钟，在 \((0.08256372, 24.56510)\) 取得极小值 -2.863497。不启用全局优化器就没法解，Lingo 会报错，找不到最优解，勉强找到一个可行解 \((0.06082750, 44.12793)\)，目标值为 -1.29816。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{exp}\NormalTok{(}\FunctionTok{sin}\NormalTok{(}\DecValTok{50} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{])) }\SpecialCharTok{+} \FunctionTok{sin}\NormalTok{(}\DecValTok{60} \SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{+}
    \FunctionTok{sin}\NormalTok{(}\DecValTok{70} \SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{])) }\SpecialCharTok{+} \FunctionTok{sin}\NormalTok{(}\FunctionTok{sin}\NormalTok{(}\DecValTok{80} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{{-}}
    \FunctionTok{sin}\NormalTok{(}\DecValTok{10} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{+}\NormalTok{ (x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{(}\FunctionTok{sin}\NormalTok{(x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{/} \DecValTok{4}
\NormalTok{\}}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]))}
\NormalTok{\}}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ ( (}\FunctionTok{cos}\NormalTok{(x[}\DecValTok{2}\NormalTok{]))}\SpecialCharTok{\^{}}\NormalTok{x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{] )}\SpecialCharTok{\^{}}\NormalTok{x[}\DecValTok{2}\NormalTok{]}
\NormalTok{\}}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(heq, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]))}
\NormalTok{\}}

\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.06082750}\NormalTok{, }\FloatTok{44.12793}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1.29816
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.966877
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.06082750}\NormalTok{, }\FloatTok{44.12793}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.923673e-08
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 2L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 2 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq =}\NormalTok{ heq),}
    \AttributeTok{dir =} \StringTok{"=="}\NormalTok{,}
    \AttributeTok{rhs =} \DecValTok{0}\NormalTok{,}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq.jac =}\NormalTok{ heq.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\AttributeTok{ud =} \DecValTok{50}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 2L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

nloptr.auglag 无法求解此优化问题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.auglag"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

调 nloptr.isres 求解器，每次执行都会得到不同的局部最优解

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.isres"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 19.9253682 -0.3396662
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -2.833693
\end{verbatim}

比如下面三组

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{40.95941}\NormalTok{, }\FloatTok{41.52914}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1.025926
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{40.95941}\NormalTok{, }\FloatTok{41.52914}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NaN
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{21.88091}\NormalTok{, }\FloatTok{28.96994}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1.467513
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{21.88091}\NormalTok{, }\FloatTok{28.96994}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NaN
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{49.921967437}\NormalTok{, }\FloatTok{4.8499336803}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -3.466596
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{49.921967437}\NormalTok{, }\FloatTok{4.8499336803}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -8.515447e+208
\end{verbatim}

\hypertarget{sec-nonlinear-equations}{%
\section{非线性方程}\label{sec-nonlinear-equations}}

\hypertarget{subsec-equation}{%
\subsection{一元非线性方程}\label{subsec-equation}}

\href{https://blog.hamaluik.ca/posts/solving-equations-using-the-newton-raphson-method/}{牛顿-拉弗森方法}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rootSolve)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-equations}{%
\subsection{非线性方程组}\label{subsec-equations}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(BB)}
\end{Highlighting}
\end{Shaded}

二项混合泊松分布的参数最大似然估计

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poissmix.loglik }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p, y) \{}
  \CommentTok{\# Log{-}likelihood for a binary Poisson mixture distribution}
\NormalTok{  i }\OtherTok{\textless{}{-}} \DecValTok{0}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(y) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
  
\NormalTok{  loglik }\OtherTok{\textless{}{-}}\NormalTok{ y }\SpecialCharTok{*} \FunctionTok{log}\NormalTok{(p[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{p[}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{*}\NormalTok{ p[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\NormalTok{i }\SpecialCharTok{/} \FunctionTok{exp}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
\NormalTok{    (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ p[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{p[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{*}\NormalTok{ p[}\DecValTok{3}\NormalTok{]}\SpecialCharTok{\^{}}\NormalTok{i }\SpecialCharTok{/} \FunctionTok{exp}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)))}

  \FunctionTok{sum}\NormalTok{(loglik)}
\NormalTok{\}}
\CommentTok{\# Data from Hasselblad (JASA 1969)}
\CommentTok{\# 介绍实际应用场景}
\NormalTok{poissmix.dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{death =} \DecValTok{0}\SpecialCharTok{:}\DecValTok{9}\NormalTok{, }
                           \AttributeTok{freq =} \FunctionTok{c}\NormalTok{(}\DecValTok{162}\NormalTok{, }\DecValTok{267}\NormalTok{, }\DecValTok{271}\NormalTok{, }\DecValTok{185}\NormalTok{, }\DecValTok{111}\NormalTok{, }\DecValTok{61}\NormalTok{, }\DecValTok{27}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{lo }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{) }\CommentTok{\# lower limits for parameters}
\NormalTok{hi }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\ConstantTok{Inf}\NormalTok{, }\ConstantTok{Inf}\NormalTok{) }\CommentTok{\# upper limits for parameters}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{3}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{)) }
\CommentTok{\# a randomly generated vector of length 3}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{162}\NormalTok{, }\DecValTok{267}\NormalTok{, }\DecValTok{271}\NormalTok{, }\DecValTok{185}\NormalTok{, }\DecValTok{111}\NormalTok{, }\DecValTok{61}\NormalTok{, }\DecValTok{27}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{)}

\NormalTok{ans1 }\OtherTok{\textless{}{-}} \FunctionTok{spg}\NormalTok{(}
  \AttributeTok{par =}\NormalTok{ p0, }\AttributeTok{fn =}\NormalTok{ poissmix.loglik, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{lower =}\NormalTok{ lo, }\AttributeTok{upper =}\NormalTok{ hi,}
  \AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maximize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{trace =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{)}
\NormalTok{ans2 }\OtherTok{\textless{}{-}} \FunctionTok{BBoptim}\NormalTok{(}
  \AttributeTok{par =}\NormalTok{ p0, }\AttributeTok{fn =}\NormalTok{ poissmix.loglik, }\AttributeTok{y =}\NormalTok{ y,}
  \AttributeTok{lower =}\NormalTok{ lo, }\AttributeTok{upper =}\NormalTok{ hi, }\AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maximize =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## iter:  0  f-value:  -2136.431  pgrad:  236.9752 
## iter:  10  f-value:  -1995.89  pgrad:  2.961353 
## iter:  20  f-value:  -2041.139  pgrad:  2.57697 
## iter:  30  f-value:  -1989.974  pgrad:  0.4742151 
## iter:  40  f-value:  -1989.949  pgrad:  0.2614752 
## iter:  50  f-value:  -1989.946  pgrad:  0.01959506 
## iter:  60  f-value:  -1989.946  pgrad:  0.002494289 
##   Successful convergence.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ans2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] 0.3598829 1.2560906 2.6634011
## 
## $value
## [1] -1989.946
## 
## $gradient
## [1] 0.0001000444
## 
## $fn.reduction
## [1] -146.4848
## 
## $iter
## [1] 68
## 
## $feval
## [1] 170
## 
## $convergence
## [1] 0
## 
## $message
## [1] "Successful convergence"
## 
## $cpar
## method      M 
##      2     50
\end{verbatim}

计算最大似然处的黑塞矩阵以及参数的标准差

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hess }\OtherTok{\textless{}{-}}\NormalTok{ numDeriv}\SpecialCharTok{::}\FunctionTok{hessian}\NormalTok{(}\AttributeTok{x =}\NormalTok{ ans2}\SpecialCharTok{$}\NormalTok{par, }\AttributeTok{func =}\NormalTok{ poissmix.loglik, }\AttributeTok{y =}\NormalTok{ y)}
\CommentTok{\# Note that we have to supplied data vector \textquotesingle{}y\textquotesingle{}}
\NormalTok{hess}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           [,1]      [,2]      [,3]
## [1,] -907.1105  270.2287  341.2543
## [2,]  270.2287 -113.4794  -61.6819
## [3,]  341.2543  -61.6819 -192.7822
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{se }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{solve}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{hess)))}
\NormalTok{se}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.1946836 0.3500308 0.2504769
\end{verbatim}

从不同初始值出发尝试寻找全局最大值，实际找的是一系列局部最大值

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 3 randomly generated starting values}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{30}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{8}\NormalTok{)), }\DecValTok{10}\NormalTok{, }\DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{ans }\OtherTok{\textless{}{-}} \FunctionTok{multiStart}\NormalTok{(}
  \AttributeTok{par =}\NormalTok{ p0, }\AttributeTok{fn =}\NormalTok{ poissmix.loglik, }\AttributeTok{action =} \StringTok{"optimize"}\NormalTok{,}
  \AttributeTok{y =}\NormalTok{ y, }\AttributeTok{lower =}\NormalTok{ lo, }\AttributeTok{upper =}\NormalTok{ hi, }\AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maximize =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Parameter set :  1 ... 
## iter:  0  f-value:  -2076.377  pgrad:  266.5811 
## iter:  10  f-value:  -1991.788  pgrad:  3.394882 
## iter:  20  f-value:  -1990.932  pgrad:  8.266675 
## iter:  30  f-value:  -1989.958  pgrad:  0.2441652 
## iter:  40  f-value:  -1989.946  pgrad:  0.001411991 
##   Successful convergence.
## Parameter set :  2 ... 
## iter:  0  f-value:  -3999.343  pgrad:  6.350898 
## iter:  10  f-value:  -2015.457  pgrad:  2.400803 
##   Successful convergence.
## Parameter set :  3 ... 
## iter:  0  f-value:  -2526.385  pgrad:  3.959104 
## iter:  10  f-value:  -1997.785  pgrad:  4.651176 
## iter:  20  f-value:  -2041.124  pgrad:  130.6335 
## iter:  30  f-value:  -1989.979  pgrad:  0.4133676 
## iter:  40  f-value:  -1989.953  pgrad:  0.2001525 
## iter:  50  f-value:  -1989.946  pgrad:  0.02953584 
##   Successful convergence.
## Parameter set :  4 ... 
## iter:  0  f-value:  -4036.966  pgrad:  7.725057 
## iter:  10  f-value:  -1993.146  pgrad:  3.356279 
## iter:  20  f-value:  -1992.445  pgrad:  3.162911 
## iter:  30  f-value:  -1999.964  pgrad:  3.124857 
## iter:  40  f-value:  -1990.201  pgrad:  0.9762675 
## iter:  50  f-value:  -1989.962  pgrad:  0.3950169 
## iter:  60  f-value:  -1989.946  pgrad:  0.0507498 
## iter:  70  f-value:  -1989.946  pgrad:  0.0001978151 
##   Successful convergence.
## Parameter set :  5 ... 
## iter:  0  f-value:  -2048.809  pgrad:  2.862445 
## iter:  10  f-value:  -1992.344  pgrad:  2.68979 
## iter:  20  f-value:  -1990.604  pgrad:  7.2791 
## iter:  30  f-value:  -1989.978  pgrad:  0.3772993 
## iter:  40  f-value:  -1989.946  pgrad:  0.004172307 
## iter:  50  f-value:  -1989.946  pgrad:  0.004260983 
##   Successful convergence.
## Parameter set :  6 ... 
## iter:  0  f-value:  -4777.283  pgrad:  7.596832 
## iter:  10  f-value:  -1991.838  pgrad:  11.02078 
## iter:  20  f-value:  -1990.272  pgrad:  0.5307333 
## iter:  30  f-value:  -1989.963  pgrad:  2.230793 
## iter:  40  f-value:  -1989.946  pgrad:  0.008421921 
## iter:  50  f-value:  -1989.946  pgrad:  0.0001841727 
##   Successful convergence.
## Parameter set :  7 ... 
## iter:  0  f-value:  -2019.928  pgrad:  3.485709 
## iter:  10  f-value:  -1990.626  pgrad:  1.833378 
## iter:  20  f-value:  -1989.999  pgrad:  1.098717 
## iter:  30  f-value:  -1989.947  pgrad:  0.3092782 
## iter:  40  f-value:  -1989.946  pgrad:  0.007039489 
##   Successful convergence.
## Parameter set :  8 ... 
## iter:  0  f-value:  -2764.625  pgrad:  4.891128 
## iter:  10  f-value:  -2001.398  pgrad:  2.273737e-06 
##   Successful convergence.
## Parameter set :  9 ... 
## iter:  0  f-value:  -2167.165  pgrad:  195.5499 
## iter:  10  f-value:  -2001.54  pgrad:  2.194864 
## iter:  20  f-value:  -2000.825  pgrad:  0.6559458 
## iter:  30  f-value:  -1992.777  pgrad:  7.064828 
## iter:  40  f-value:  -1991.747  pgrad:  3.357115 
## iter:  50  f-value:  -1989.983  pgrad:  2.772795 
## iter:  60  f-value:  -1989.946  pgrad:  0.03392643 
## iter:  70  f-value:  -1989.946  pgrad:  0.0003728928 
##   Successful convergence.
## Parameter set :  10 ... 
## iter:  0  f-value:  -2100.94  pgrad:  317.5313 
## iter:  10  f-value:  -1991.327  pgrad:  2.7843 
## iter:  20  f-value:  -1990.415  pgrad:  1.435174 
## iter:  30  f-value:  -1990.046  pgrad:  3.248585 
## iter:  40  f-value:  -1989.946  pgrad:  0.06813025 
## iter:  50  f-value:  -1989.946  pgrad:  0.001450644 
##   Successful convergence.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# selecting only converged solutions}
\NormalTok{pmat }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(ans}\SpecialCharTok{$}\NormalTok{fvalue[ans}\SpecialCharTok{$}\NormalTok{conv], ans}\SpecialCharTok{$}\NormalTok{par[ans}\SpecialCharTok{$}\NormalTok{conv, ]), }\DecValTok{4}\NormalTok{)}
\FunctionTok{dimnames}\NormalTok{(pmat) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\ConstantTok{NULL}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"fvalue"}\NormalTok{, }\StringTok{"parameter 1"}\NormalTok{, }\StringTok{"parameter 2"}\NormalTok{, }\StringTok{"parameter 3"}\NormalTok{))}
\NormalTok{pmat[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(pmat), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         fvalue parameter 1 parameter 2 parameter 3
## [1,] -1989.946      0.6401      2.6634      1.2561
## [2,] -1997.263      0.4922      2.4559      1.8567
## [3,] -1989.946      0.3599      1.2561      2.6634
## [4,] -2000.039      0.7931      2.0681      2.4778
## [5,] -1989.946      0.3599      1.2560      2.6634
\end{verbatim}

用一个具体的参数估计问题，求极大似然点，混合正态分布 隐函数方程组 求解非线性方程组 \citep{BB2019}

\hypertarget{sec-multi-objective-optimization}{%
\section{多目标规划}\label{sec-multi-objective-optimization}}

多目标规划的基本想法是将多目标问题转化为单目标问题，常见方法有理想点法、线性加权法、非劣解集法、极大极小法。理想点法是先在给定约束条件下分别求解单个目标的最优值，构造新的单目标函数。线性加权法是给每个目标函数赋予权重系数，各个权重系数之和等于1。非劣解集法是先求解其中一个单目标函数的最优值，然后将其设为等式约束，将其最优值从最小值开始递增，然后求解另一个目标函数的最小值。极大极小法是采用标准的简面体爬山法和通用全局优化法求解多目标优化问题。

R 环境中，\href{https://github.com/mbinois/GPareto}{GPareto} 主要用来求解多目标规划问题。\href{https://bookdown.org/gerhard_krennrich/doe_and_optimization/}{试验设计和过程优化与R语言} 的 \href{https://bookdown.org/gerhard_krennrich/doe_and_optimization/optimization.html\#constrained-optimization}{约束优化} 章节，\href{https://www.stat.umn.edu/geyer/3701/notes/optimize.html}{优化和解方程}。另外，《Search Methodologies: Introductory Tutorials in Optimization and Decision Support Techniques》\citep{Deb2005} 多目标优化方法

\begin{equation*}
\begin{array}{l}
  \min_x \left\{
      \begin{array}{l}  
        f_1(x) = 0.5x_1 + 0.6x_2 + 0.7 \exp(\frac{x_1 + x_3}{10}) \\
        f_2(x) = (x_1 - 2x_2)^2 + (2x_2 - 3x_3)^2 + (5x_3 -x_1)^2
      \end{array} \right. \\
    s.t. \quad x_1 \in [10, 80], x_2 \in [20, 90], x_3 \in [15, 100]
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DiceKriging)}
\FunctionTok{library}\NormalTok{(emoa)}
\FunctionTok{library}\NormalTok{(GPareto)}
\FunctionTok{library}\NormalTok{(DiceDesign)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Ternary)}
\FunctionTok{TernaryPlot}\NormalTok{(}
  \AttributeTok{atip =} \StringTok{"Top"}\NormalTok{, }\AttributeTok{btip =} \StringTok{"Bottom"}\NormalTok{, }\AttributeTok{ctip =} \StringTok{"Right"}\NormalTok{, }
  \AttributeTok{axis.col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{col =} \FunctionTok{rgb}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.8}\NormalTok{)}
\NormalTok{)}
\FunctionTok{HorizontalGrid}\NormalTok{(}\AttributeTok{grid.lines =} \DecValTok{2}\NormalTok{, }\AttributeTok{grid.col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{grid.lty =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-classic-optimization}{%
\section{经典优化问题}\label{sec-classic-optimization}}

旅行商问题、背包问题、指派问题、选址问题、网络流量问题

规划快递员送餐的路线：从快递员出发地到各个取餐地，再到顾客家里，如何规划路线使得每个顾客下单到拿到餐的时间间隔小于 50 分钟，完成送餐，快递员的总时间最少？

\hypertarget{sec-regression-optimization}{%
\section{回归与优化}\label{sec-regression-optimization}}

简单线性回归

\href{https://cran.r-project.org/package=nlsr}{nlsr}

是否能给大家提供一些思路？

Lasso \citep{lasso1996}

Least Angle Regression \citep{lar2004}

为了解决Lasso的有偏估计问题，自适应 Lasso、松弛 Lasso SCAD (Smoothly Clipped Absolute Deviation)\citep{scad2008} MCP (Minimax Concave Penalty)\citep{mcp2010}

由于缺少高效的求解算法，Lasso 在高维小样本特征选择研究中没有广泛流行，最小角回归(Least Angle Regression, LAR)算法 \citep{lar2004} 的出现有力促进了Lasso在高维小样本数据中的应用

\href{https://github.com/ryantibs/best-subset/}{bestsubset} 最优子集回归

经典的普通最小二乘、广义最小二乘、岭回归、逐步回归、Lasso 回归、最优子集回归都可转化为优化问题，一般形式如下

\[
\underbrace{\hat{\theta}_{\lambda_n}}_{\text{待估参数}} \in \arg \min_{\theta \in \Omega} \left\{ \underbrace{\mathcal{L}(\theta;Z_{1}^{n})}_{\text{损失函数}} + \lambda_n \underbrace{\mathcal{R}(\theta)}_{\text{正则化项}} \right\}.
\]

下面尝试以 nloptr 包的优化器来展示求解过程，并与 Base R、\textbf{glmnet} 和 \textbf{MASS} 实现的回归模型比较。

\[
\arg \min_{\beta,\lambda} ~~ \frac{1}{2} || \mathbf{y} - \mathbf{X} \beta ||_2^2 +  \lambda ||\beta||_1
\] 其中，\(X \in \mathbb{R}^{m\times n}\)， \(y \in \mathbb{R}^m\)，\(\beta \in \mathbb{R}^n\)， \(0 < \lambda \in \mathbb{R}\)

\[y = X\beta + \epsilon\]

\(\hat{\beta} = (X^{\top}X)^{-1}X^{\top}y, \quad \hat{Y} = X(X^{\top}X)^{-1}X^{\top}y\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{p }\OtherTok{\textless{}{-}} \DecValTok{50}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n }\SpecialCharTok{*}\NormalTok{ p), n)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(n)}
\FunctionTok{lm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{+} \DecValTok{0}\NormalTok{)}
\CommentTok{\# y 的估计}
\CommentTok{\# 教科书版}
\NormalTok{fit\_base }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  x }\SpecialCharTok{\%*\%} \FunctionTok{solve}\NormalTok{(}\FunctionTok{t}\NormalTok{(x) }\SpecialCharTok{\%*\%}\NormalTok{ x) }\SpecialCharTok{\%*\%} \FunctionTok{t}\NormalTok{(x) }\SpecialCharTok{\%*\%}\NormalTok{ y}
\NormalTok{\}}
\CommentTok{\# 先向量计算，然后矩阵计算}
\NormalTok{fit\_vector }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  x }\SpecialCharTok{\%*\%}\NormalTok{ (}\FunctionTok{solve}\NormalTok{(}\FunctionTok{t}\NormalTok{(x) }\SpecialCharTok{\%*\%}\NormalTok{ x) }\SpecialCharTok{\%*\%}\NormalTok{ (}\FunctionTok{t}\NormalTok{(x) }\SpecialCharTok{\%*\%}\NormalTok{ y))}
\NormalTok{\}}
\CommentTok{\# X\textquotesingle{}X 是对称的，防止求逆}
\NormalTok{fit\_inv }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  x }\SpecialCharTok{\%*\%} \FunctionTok{solve}\NormalTok{(}\FunctionTok{crossprod}\NormalTok{(x), }\FunctionTok{crossprod}\NormalTok{(x, y))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

QR 分解 \(X_{n\times p} = Q_{n\times p} R_{p\times p}\)，\(n > p\)，\(Q^{\top}Q = I\)，\(R\) 是上三角矩阵，\(\hat{Y} = X(X^{\top}X)^{-1}X^{\top}y = QQ^{\top}y\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_qr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  decomp }\OtherTok{\textless{}{-}} \FunctionTok{qr}\NormalTok{(x)}
  \FunctionTok{qr.qy}\NormalTok{(decomp, }\FunctionTok{qr.qty}\NormalTok{(decomp, y))}
\NormalTok{\}}
\FunctionTok{lm.fit}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

若 \(A = X^{\top}X\) 是正定矩阵，则 \(A = LL^{\top}\)，\(L\) 是下三角矩阵

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_chol }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  decomp }\OtherTok{\textless{}{-}} \FunctionTok{chol}\NormalTok{(}\FunctionTok{crossprod}\NormalTok{(x))}
\NormalTok{  lxy }\OtherTok{\textless{}{-}} \FunctionTok{backsolve}\NormalTok{(decomp, }\FunctionTok{crossprod}\NormalTok{(x, y), }\AttributeTok{transpose =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{backsolve}\NormalTok{(decomp, lxy)}
\NormalTok{  x }\SpecialCharTok{\%*\%}\NormalTok{ b}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Using C/C++}
\FunctionTok{system.time}\NormalTok{(RcppEigen}\SpecialCharTok{::}\FunctionTok{fastLmPure}\NormalTok{(x, y, }\AttributeTok{method =} \DecValTok{1}\NormalTok{)) }\DocumentationTok{\#\# QR}
\FunctionTok{system.time}\NormalTok{(RcppEigen}\SpecialCharTok{::}\FunctionTok{fastLmPure}\NormalTok{(x, y, }\AttributeTok{method =} \DecValTok{2}\NormalTok{)) }\DocumentationTok{\#\# Cholesky}
\FunctionTok{system.time}\NormalTok{(RcppArmadillo}\SpecialCharTok{::}\FunctionTok{fastLmPure}\NormalTok{(x, y, }\AttributeTok{method =} \DecValTok{1}\NormalTok{)) }\DocumentationTok{\#\# QR}
\FunctionTok{system.time}\NormalTok{(RcppArmadillo}\SpecialCharTok{::}\FunctionTok{fastLmPure}\NormalTok{(x, y, }\AttributeTok{method =} \DecValTok{2}\NormalTok{)) }\DocumentationTok{\#\# Cholesky}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-log-likelihood}{%
\section{对数似然}\label{sec-log-likelihood}}

随机变量 X 服从参数为 \(\lambda > 0\) 的指数分布，密度函数 \(p(x)\) 为

\begin{equation*}
\begin{array}{l}
 p(x) = \left\{ 
    \begin{array}{l}
    \lambda\mathrm{e}^{-\lambda x},  x \geq 0\\
    0, \quad x < 0
    \end{array} \right.
\end{array}
\end{equation*}

其中，\(\lambda > 0\)，下面给定一系列模拟样本观察值 \(x_1, x_2, \cdots, x_n\)，估计参数 \(\lambda\)。对数似然函数 \(\ell(\lambda) = \log \prod_{i=1}^{n} f(x_i) = n \log \lambda - \lambda \sum_{i=1}^{n}x_i\)。解此方程即可得到 \(\lambda\) 的极大似然估计 \(\lambda_{mle} = \frac{1}{\bar{X}}\)，极大值 \(\ell(\lambda_{mle}) = - n(1 + \log \bar{X})\)。

根据上述样本，计算样本均值 \((\mu - 1.5*\sigma/\sqrt{n}, \mu + 1.5*\sigma/\sqrt{n})\) 和方差 \((0.8\sigma, 1.5\sigma)\)。 已知正态分布 \(f(x) = \frac{1}{\sqrt{2\pi}\sigma}\mathrm{e}^{- \frac{(x - \mu)^2}{2\sigma^2}}\) 的对数似然形式 \(\ell(\mu,\sigma^2) = \log \prod_{i=1}^{n} f(x_i) = \sum_{i=1}^{n}\log f(x_i)\)。正态分布的密度函数的对数可用 \texttt{dnorm(...,\ log\ =\ TRUE)} 计算。

生成服从指数分布的样本，计算样本的均值和方差，依据均值和方差构造区间，然后将区间网格化，在此网格上绘制正态分布的对数似然函数。绕那么大一个圈子，其实就是绘制正态分布的对数似然函数。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2021}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{20} \CommentTok{\# 随机数的个数}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rexp}\NormalTok{(n, }\AttributeTok{rate =} \DecValTok{5}\NormalTok{) }\CommentTok{\# 服从指数分布的随机数}
\NormalTok{m }\OtherTok{\textless{}{-}} \DecValTok{40} \CommentTok{\# 网格数}

\NormalTok{mu }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}
  \FunctionTok{mean}\NormalTok{(x) }\SpecialCharTok{{-}} \FloatTok{1.5} \SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(x) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n),}
  \FunctionTok{mean}\NormalTok{(x) }\SpecialCharTok{+} \FloatTok{1.5} \SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(x) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n),}
  \AttributeTok{length.out =}\NormalTok{ m}
\NormalTok{)}
\NormalTok{sigma }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.8} \SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(x), }\FloatTok{1.5} \SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(x), }\AttributeTok{length.out =}\NormalTok{ m)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mu, }\AttributeTok{y =}\NormalTok{ sigma)}
\CommentTok{\# 正态分布的对数似然}
\NormalTok{loglik }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(b, x0) }\SpecialCharTok{{-}}\FunctionTok{sum}\NormalTok{(}\FunctionTok{dnorm}\NormalTok{(x0, b[}\DecValTok{1}\NormalTok{], b[}\DecValTok{2}\NormalTok{], }\AttributeTok{log =} \ConstantTok{TRUE}\NormalTok{))}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, loglik, }\AttributeTok{x0 =}\NormalTok{ x)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(mu), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(sigma), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{loglik}\NormalTok{(mu, sigma)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/log-likelihood-1} 

}

\caption{正态分布参数的负对数似然函数}\label{fig:log-likelihood}
\end{figure}

\hypertarget{sec-non-linear-tseries}{%
\section{微分方程}\label{sec-non-linear-tseries}}

\href{https://blog.hamaluik.ca/posts/solving-systems-of-partial-differential-equations/}{ode45 求解偏微分方程}

\textbf{pracma} 实现了 ode23, ode23s, ode45 等几个自适应的 Runge-Kutta 求解器，\textbf{deSolve} 包求解 ODE（常微分方程）, DAE（微分代数方程）, DDE（延迟微分方程，包含刚性和非刚性方程）和 PDE（偏微分方程），\textbf{bvpSolve}包求解 DAE/ODE 方程的边值问题。\textbf{ReacTran} \citep{ReacTran2012} 可将偏微分方程转为常微分方程组，解决反应运输问题，在笛卡尔、极坐标、圆柱形和球形网格上离散偏微分方程。 \href{https://github.com/LLNL/sundials}{sundials} 提供一系列非线性方程、常微分方程、微分代数方程求解器，Satyaprakash Nayak 开发了相应的 \href{https://github.com/sn248/sundialr}{\textbf{sundialr}} 包。

\hypertarget{subsec-ordinary-differential-equations}{%
\subsection{常微分方程}\label{subsec-ordinary-differential-equations}}

\href{https://en.wikipedia.org/wiki/Lorenz_system}{洛伦兹系统}是一个常微分方程组，系统参数的默认值为 \((\sigma = 10, \rho = 28, \beta = 8/3)\)，初值为 \((-13, -14, 47)\)。

\begin{equation*}
\left\{ 
  \begin{array}{l}
    \frac{\partial x}{\partial t} = \sigma (y - x) \\
    \frac{\partial y}{\partial t} = x(\rho -z) - y \\
    \frac{\partial x}{\partial t} = xy - \beta z
  \end{array} \right.
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(deSolve)}
\CommentTok{\# 参数}
\NormalTok{pars }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{a =} \SpecialCharTok{{-}}\DecValTok{8} \SpecialCharTok{/} \DecValTok{3}\NormalTok{, }\AttributeTok{b =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{c =} \DecValTok{28}\NormalTok{)}
\CommentTok{\# 初值}
\NormalTok{state }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{X =} \DecValTok{1}\NormalTok{, }\AttributeTok{Y =} \DecValTok{1}\NormalTok{, }\AttributeTok{Z =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# 时间间隔}
\NormalTok{times }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.01}\NormalTok{)}
\CommentTok{\# 定义方程组}
\NormalTok{lorenz\_fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t, state, parameters) \{}
  \FunctionTok{with}\NormalTok{(}\FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(state, parameters)), \{}
\NormalTok{    dX }\OtherTok{\textless{}{-}}\NormalTok{ a }\SpecialCharTok{*}\NormalTok{ X }\SpecialCharTok{+}\NormalTok{ Y }\SpecialCharTok{*}\NormalTok{ Z}
\NormalTok{    dY }\OtherTok{\textless{}{-}}\NormalTok{ b }\SpecialCharTok{*}\NormalTok{ (Y }\SpecialCharTok{{-}}\NormalTok{ Z)}
\NormalTok{    dZ }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\NormalTok{X }\SpecialCharTok{*}\NormalTok{ Y }\SpecialCharTok{+}\NormalTok{ c }\SpecialCharTok{*}\NormalTok{ Y }\SpecialCharTok{{-}}\NormalTok{ Z}
    \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(dX, dY, dZ))}
\NormalTok{  \})}
\NormalTok{\}}
\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{ode}\NormalTok{(}
  \AttributeTok{y =}\NormalTok{ state, }\AttributeTok{times =}\NormalTok{ times,}
  \AttributeTok{func =}\NormalTok{ lorenz\_fun, }\AttributeTok{parms =}\NormalTok{ pars}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调用 \textbf{scatterplot3d} 绘制三维曲线图，如图\ref{fig:ode-lorenz} 所示

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(scatterplot3d)}

\FunctionTok{scatterplot3d}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ out[, }\StringTok{"X"}\NormalTok{], }\AttributeTok{y =}\NormalTok{ out[, }\StringTok{"Y"}\NormalTok{], }\AttributeTok{z =}\NormalTok{ out[, }\StringTok{"Z"}\NormalTok{],}
  \AttributeTok{col.axis =} \StringTok{"black"}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{color =} \StringTok{"gray"}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x), }\AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(y), }\AttributeTok{zlab =} \FunctionTok{expression}\NormalTok{(z),}
  \AttributeTok{col.grid =} \StringTok{"gray"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Lorenz"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/ode-lorenz-1} 

}

\caption{洛伦兹曲线}\label{fig:ode-lorenz}
\end{figure}

\hypertarget{subsec-partial-differential-equations}{%
\subsection{偏微分方程}\label{subsec-partial-differential-equations}}

ReacTran 的几个关键函数介绍

一维热传导方程

\begin{equation*}
\left\{ 
  \begin{array}{l}
    \frac{\partial y}{\partial t} = D \frac{\partial^2 y}{\partial x^2}
  \end{array} \right.
\end{equation*}

参数 \(D = 0.01\)，边界条件 \(y_{t,x=0} = 0, y_{t, x = 1} = 1\)，初始条件 \(y_{t=0,x} = \sin(\pi x)\)。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ReacTran)}

\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{100}
\NormalTok{xgrid }\OtherTok{\textless{}{-}} \FunctionTok{setup.grid.1D}\NormalTok{(}\AttributeTok{x.up =} \DecValTok{0}\NormalTok{, }\AttributeTok{x.down =} \DecValTok{1}\NormalTok{, }\AttributeTok{N =}\NormalTok{ N)}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ xgrid}\SpecialCharTok{$}\NormalTok{x.mid}
\NormalTok{D.coeff }\OtherTok{\textless{}{-}} \FloatTok{0.01}
\NormalTok{Diffusion }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t, Y, parms) \{}
\NormalTok{  tran }\OtherTok{\textless{}{-}} \FunctionTok{tran.1D}\NormalTok{(}
    \AttributeTok{C =}\NormalTok{ Y, }\AttributeTok{C.up =} \DecValTok{0}\NormalTok{, }\AttributeTok{C.down =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{D =}\NormalTok{ D.coeff, }\AttributeTok{dx =}\NormalTok{ xgrid}
\NormalTok{  )}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{dY =}\NormalTok{ tran}\SpecialCharTok{$}\NormalTok{dC, }
    \AttributeTok{flux.up =}\NormalTok{ tran}\SpecialCharTok{$}\NormalTok{flux.up,}
    \AttributeTok{flux.down =}\NormalTok{ tran}\SpecialCharTok{$}\NormalTok{flux.down}
\NormalTok{  )}
\NormalTok{\}}
\NormalTok{yini }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(pi }\SpecialCharTok{*}\NormalTok{ x)}
\NormalTok{times }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{5}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.01}\NormalTok{)}
\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{ode.1D}\NormalTok{(}
  \AttributeTok{y =}\NormalTok{ yini, }\AttributeTok{times =}\NormalTok{ times, }\AttributeTok{func =}\NormalTok{ Diffusion,}
  \AttributeTok{parms =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{dimens =}\NormalTok{ N}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{image}\NormalTok{(out,}
  \AttributeTok{grid =}\NormalTok{ xgrid}\SpecialCharTok{$}\NormalTok{x.mid, }\AttributeTok{xlab =} \StringTok{"times"}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"Distance"}\NormalTok{, }\AttributeTok{main =} \StringTok{"PDE"}\NormalTok{, }\AttributeTok{add.contour =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/pde-1d-1} 

}

\caption{一维热传导方程的数值解热力图}\label{fig:pde-1d}
\end{figure}

二维拉普拉斯方程

\begin{equation*}
\left\{ 
  \begin{array}{l}
    \frac{\partial^2 u}{\partial^2 x} + \frac{\partial^2 u}{\partial y^2} = 0
  \end{array} \right.
\end{equation*}

边界条件

\begin{equation*}
\left\{ 
  \begin{array}{l}
    u_{x=0,y} = u_{x=1,y} = 0 \\
    \frac{\partial u_{x, y=0}}{\partial y} = 0 \\
    \frac{\partial u_{x,y=1}}{\partial y} = \pi\sinh(\pi)\sin(\pi x)
  \end{array} \right.
\end{equation*}

它有解析解

\[
u(x,y) = \sin(\pi x)\cosh(\pi y)
\]

其中 \(x \in [0,1], y\in [0,1]\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, y) \{}
  \FunctionTok{sin}\NormalTok{(pi }\SpecialCharTok{*}\NormalTok{ x) }\SpecialCharTok{*} \FunctionTok{cosh}\NormalTok{(pi }\SpecialCharTok{*}\NormalTok{ y)}
\NormalTok{\}}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{101}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{101}\NormalTok{)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{outer}\NormalTok{(x, y, fn)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{image}\NormalTok{(z, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{20}\NormalTok{))}
\FunctionTok{contour}\NormalTok{(z, }\AttributeTok{method =} \StringTok{"flattest"}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/laplace-eq-image-1} 

}

\caption{解析解的二维图像}\label{fig:laplace-eq-image}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{persp}\NormalTok{(z, }
  \AttributeTok{theta =} \DecValTok{30}\NormalTok{, }\AttributeTok{phi =} \DecValTok{20}\NormalTok{, }
  \AttributeTok{r =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{expand =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{ltheta =} \DecValTok{90}\NormalTok{, }\AttributeTok{lphi =} \DecValTok{180}\NormalTok{,}
  \AttributeTok{shade =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{ticktype =} \StringTok{"detailed"}\NormalTok{, }\AttributeTok{nticks =} \DecValTok{5}\NormalTok{, }\AttributeTok{box =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{drapecol}\NormalTok{(z, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{20}\NormalTok{)),}
  \AttributeTok{border =} \StringTok{"transparent"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"X"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Y"}\NormalTok{, }\AttributeTok{zlab =} \StringTok{"Z"}\NormalTok{, }
  \AttributeTok{main =} \StringTok{""}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/laplace-eq-persp-1} 

}

\caption{解析解的三维透视图像}\label{fig:laplace-eq-persp}
\end{figure}

求解 PDE

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dx }\OtherTok{\textless{}{-}} \FloatTok{0.2}
\NormalTok{xgrid }\OtherTok{\textless{}{-}} \FunctionTok{setup.grid.1D}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{dx.1 =}\NormalTok{ dx)}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ xgrid}\SpecialCharTok{$}\NormalTok{x.mid}
\NormalTok{N }\OtherTok{\textless{}{-}}\NormalTok{ xgrid}\SpecialCharTok{$}\NormalTok{N}

\NormalTok{uini }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.05} \SpecialCharTok{*}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{vini }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, N)}
\NormalTok{yini }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(uini, vini)}
\NormalTok{times }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{50}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{)}

\NormalTok{wave }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t, y, parms) \{}
\NormalTok{  u1 }\OtherTok{\textless{}{-}}\NormalTok{ y[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{N]}
\NormalTok{  u2 }\OtherTok{\textless{}{-}}\NormalTok{ y[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{N)]}
\NormalTok{  du1 }\OtherTok{\textless{}{-}}\NormalTok{ u2}
\NormalTok{  du2 }\OtherTok{\textless{}{-}} \FunctionTok{tran.1D}\NormalTok{(}\AttributeTok{C =}\NormalTok{ u1, }\AttributeTok{C.up =} \DecValTok{0}\NormalTok{, }\AttributeTok{C.down =} \DecValTok{0}\NormalTok{, }\AttributeTok{D =} \DecValTok{1}\NormalTok{, }\AttributeTok{dx =}\NormalTok{ xgrid)}\SpecialCharTok{$}\NormalTok{dC}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(du1, du2)))}
\NormalTok{\}}

\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{ode.1D}\NormalTok{(}
  \AttributeTok{func =}\NormalTok{ wave, }\AttributeTok{y =}\NormalTok{ yini, }\AttributeTok{times =}\NormalTok{ times, }\AttributeTok{parms =} \ConstantTok{NULL}\NormalTok{,}
  \AttributeTok{nspec =} \DecValTok{2}\NormalTok{, }\AttributeTok{method =} \StringTok{"ode45"}\NormalTok{, }\AttributeTok{dimens =}\NormalTok{ N, }\AttributeTok{names =} \FunctionTok{c}\NormalTok{(}\StringTok{"u"}\NormalTok{, }\StringTok{"v"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-delay-differential-equations}{%
\subsection{延迟微分方程}\label{subsec-delay-differential-equations}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(PBSddesolve)    }\CommentTok{\# DAE 延迟微分方程}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/pbs-software/pbs-ddesolve}{\textbf{PBSddesolve}} \citep{PBSddesolve} \textbf{PBSmodelling} \textbf{PBSmapping}

\textbf{nlmeODE} 通过微分方程整合用于混合效应模型的 odesolve 和 nlme 包。

\hypertarget{subsec-stochastic-differential-equations}{%
\subsection{随机微分方程}\label{subsec-stochastic-differential-equations}}

\href{https://github.com/acguidoum/Sim.DiffProc}{Sim.DiffProc}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Sim.DiffProc)}
\end{Highlighting}
\end{Shaded}

种群 ODE 建模，

\href{https://github.com/nlmixrdevelopment/nlmixr}{nlmixr} 借助 \href{https://github.com/nlmixrdevelopment/RxODE/}{RxODE} 求解基于常微分方程的非线性混合效应模型

\hypertarget{sec-numerical-optimization-session}{%
\section{运行环境}\label{sec-numerical-optimization-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] quadprog_1.5-8            kableExtra_1.3.4         
##  [3] tibble_3.1.5              Sim.DiffProc_4.8         
##  [5] nlmeODE_1.1               nlme_3.1-153             
##  [7] PBSddesolve_1.12.6        ReacTran_1.4.3.1         
##  [9] shape_1.4.6               scatterplot3d_0.3-41     
## [11] deSolve_1.29              BB_2019.10-1             
## [13] rootSolve_1.8.2.3         kernlab_0.9-29           
## [15] lattice_0.20-45           ROI.plugin.quadprog_1.0-0
## [17] ROI.plugin.lpsolve_1.0-1  ROI.plugin.nloptr_1.0-0  
## [19] ROI.plugin.alabama_1.0-0  ROI_1.0-0                
## [21] lpSolve_5.6.15           
## 
## loaded via a namespace (and not attached):
##  [1] svglite_2.0.0           digest_0.6.28           utf8_1.2.2             
##  [4] slam_0.1-48             R6_2.5.1                alabama_2015.3-1       
##  [7] evaluate_0.14           httr_1.4.2              pillar_1.6.3           
## [10] rlang_0.4.11            curl_4.3.2              rstudioapi_0.13        
## [13] nloptr_1.2.2.2          rmarkdown_2.11          webshot_0.5.2          
## [16] stringr_1.4.0           munsell_0.5.0           compiler_4.1.1         
## [19] numDeriv_2016.8-1.1     Deriv_4.1.3             xfun_0.26              
## [22] systemfonts_1.0.2       pkgconfig_2.0.3         htmltools_0.5.2        
## [25] bookdown_0.24           viridisLite_0.4.0       fansi_0.5.0            
## [28] crayon_1.4.1            MASS_7.3-54             grid_4.1.1             
## [31] lifecycle_1.0.1         registry_0.5-1          magrittr_2.0.1         
## [34] scales_1.1.1            stringi_1.7.4           xml2_1.3.2             
## [37] ellipsis_0.3.2          vctrs_0.3.8             lpSolveAPI_5.5.2.0-17.7
## [40] tools_4.1.1             glue_1.4.2              parallel_4.1.1         
## [43] fastmap_1.1.0           yaml_2.2.1              colorspace_2.0-2       
## [46] rvest_1.0.1             knitr_1.36
\end{verbatim}

\hypertarget{appendix}{%
\appendix}


\hypertarget{chap-linux-command-bash}{%
\chapter{命令行操作}\label{chap-linux-command-bash}}

Bash 文件查找、查看（内容、大小）、移动（重命名）、删除、创建、修改权限

Linux 命令行工具是非常强大的，命令行中的数据科学 \url{https://www.datascienceatthecommandline.com/}，Linux 命令行 \url{https://github.com/jaywcjlove/linux-command}

\href{https://github.com/trevorld/r-optparse}{optparse}、\href{https://github.com/docopt/docopt.R}{docopt} 、\href{https://github.com/eddelbuettel/littler}{littler} 包提供了很多便捷的命令行工具，\href{https://github.com/jeroen/sys}{sys}， \href{https://github.com/r-lib/fs}{fs} 在 R 中运行操作系统命令

如表\ref{tab:r-vs-shell}所示，总结了 R 和 Shell 命令的等价表示，下面以 \texttt{list.files()} 和 \texttt{ls} 为例，介绍其等价的内容

\begin{longtable}[]{@{}lll@{}}
\caption[\label{tab:r-vs-shell} R 和 Shell 命令的等价表示 ]{\label{tab:r-vs-shell} R 和 Shell 命令的等价表示 \footnote{CentOS 系统默认没有安装 tree 软件，需要先安装才能使用此命令 \texttt{sudo\ dnf\ install\ -y\ tree}}}\tabularnewline
\toprule
& R & Shell \\
\midrule
\endfirsthead
\toprule
& R & Shell \\
\midrule
\endhead
查看文件 & \texttt{list.files()} & \texttt{ls} \\
查看目录 & \texttt{list.dirs()} & \texttt{dir} \\
目录层次 & \texttt{fs::dir\_tree()} & \texttt{tree} \\
\bottomrule
\end{longtable}

\hypertarget{sec-ls}{%
\section{查看文件}\label{sec-ls}}

\texttt{ls}/\texttt{mkdir}/\texttt{mv}/\texttt{du}

查看文件

\begin{verbatim}
```bash
ls -a
```

列出目录下所有文件

```bash
ls -1 
```

一行显示一个文件或文件夹

```bash
ls -l 
```

按从 aA-zZ 的顺序列出所有文件以及所属权限

```bash
ls -rl 
```

相比于 `ls -l` 文件是逆序排列

```bash
ls -lh
```

列出文件或文件夹（不包含子文件夹）的大小 

```bash
ls -ld 
```

列出当前目录本身，而不是其所包含的内容
\end{verbatim}

\hypertarget{sec-mkdir}{%
\section{创建文件夹}\label{sec-mkdir}}

\begin{verbatim}
```bash
mkdir images
```

创建文件用 `touch` 如 `touch .Rprofile` 

```bash
# 删除文件夹及子文件夹，递归删除
rm -rf images/
# 删除文件
rm .Rprofile
```
\end{verbatim}

\hypertarget{sec-mv}{%
\section{移动文件}\label{sec-mv}}

\begin{verbatim}
在当前目录下

```bash
# 移动文件夹 images 下的所有文件到 figures 文件夹下
mv images/* figures/
# images 文件夹移动到 figures 文件夹下
mv images/ figures/
# 移动特定的文件
mv images/*.png figures/
```

同一目录下有两个文件 `R-3.5.1.tar.gz` 未下载完整 和 `R-3.5.1.tar.gz.1` 完全下载

```bash
# 删除 R-3.5.1.tar.gz
rm R-3.5.1.tar.gz
# 重命名 R-3.5.1.tar.gz.1 
mv R-3.5.1.tar.gz.1  R-3.5.1.tar.gz
```
\end{verbatim}

\hypertarget{sec-du}{%
\section{查看文件大小}\label{sec-du}}

\begin{verbatim}
当前目录下各文件夹的大小， `-h` 表示人类（相对于机器来说）可读的方式显示，如 Kb、Mb、Gb，`-d` 表示目录深度 `du --human-readable --max-depth=1 ./`

```bash
du -h -d 1 ./
```

```bash
# 对当前目录下的文件/夹 按大小排序
du -sh * | sort -nr
```
\end{verbatim}

\hypertarget{sec-shell}{%
\section{终端模拟器}\label{sec-shell}}

\href{https://ohmyz.sh/}{oh-my-zsh} 是 \href{https://www.zsh.org/}{Z Shell} 扩展，开发在 Github 上 \url{https://github.com/ohmyzsh/ohmyzsh}。

zsh 相比于 bash， 在语法高亮、自动补全等方面有优势

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ zsh}
\FunctionTok{sh} \AttributeTok{{-}c} \StringTok{"}\VariableTok{$(}\ExtensionTok{curl} \AttributeTok{{-}fsSL}\NormalTok{ https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh}\VariableTok{)}\StringTok{"}
\end{Highlighting}
\end{Shaded}

RStudio 集成的终端支持 Zsh，操作路径 Tools -\textgreater{} Global Options -\textgreater{} Terminal， 见图 \ref{fig:zsh-rstudio}

\begin{figure}
\centering
\includegraphics[width=0.75\textwidth,height=\textheight]{screenshots/zsh-rstudio.png}
\caption{\label{fig:zsh-rstudio} RStudio IDE 集成的 Zsh 终端模拟器}
\end{figure}

\hypertarget{sec-tar}{%
\section{压缩和解压缩}\label{sec-tar}}

最常见的压缩文件格式有 \texttt{.tar}、\texttt{.tar.gz}、\texttt{.tar.bz2}、\texttt{.zip} 和 \texttt{.rar}，分别对应于 Tar \url{https://www.gnu.org/software/tar/}、 Gzip \url{https://www.gzip.org/} 、 Bzip2 \url{https://www.bzip.org/} 、 UnZip/Zip \url{http://www.info-zip.org} 和 WinRAR \url{https://www.rarlab.com/}。 Tar 提供了基本的打包和解包工具，Gzip 和 Bzip2 在 Tar 打包的基础上提供了压缩功能， UnZip/Zip 是兼容 Windows 原生压缩/解压缩功能的程序，WinRAR 是广泛流行于 Windows 系统的压缩/解压缩收费软件，除了 WinRAR，其它都是免费甚至开源软件。 下面以 \texttt{.tar.gz} 和\texttt{.tar.bz2} 两种格式的压缩文件为例，介绍文件压缩和解压缩的操作，其它文件格式的操作类似\footnote{zip 格式的文件需要额外安装 zip 和 unzip 两款软件实现压缩和解压缩。}。WinRAR \url{https://www.rarlab.com/} 是收费的压缩和解压缩工具，也支持 Linux 和 macOS 系统，鉴于它是收费软件，这里就不多展开介绍了，详情请见官网。

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ tar gzip zip unzip }
\CommentTok{\# 将目录 \textasciitilde{}/tmp 压缩成文件 filename.tar.gz}
\FunctionTok{tar} \AttributeTok{{-}czf} \PreprocessorTok{**}\NormalTok{.tar.gz \textasciitilde{}/tmp}
\CommentTok{\# 将文件 filename.tar.gz 解压到目录 \textasciitilde{}/tmp}
\FunctionTok{tar} \AttributeTok{{-}xzf} \PreprocessorTok{**}\NormalTok{.tar.gz }\AttributeTok{{-}C}\NormalTok{ \textasciitilde{}/tmp}
\end{Highlighting}
\end{Shaded}

\end{column}

\begin{column}{0.05\textwidth}
~

\end{column}

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ bzip2}
\CommentTok{\# 将目录 \textasciitilde{}/tmp 压缩成文件 filename.tar.bz2}
\FunctionTok{tar} \AttributeTok{{-}cjf}\NormalTok{ filename.tar.bz2 \textasciitilde{}/tmp}
\CommentTok{\# 将文件 filename.tar.bz2 解压到目录 \textasciitilde{}/tmp}
\FunctionTok{tar} \AttributeTok{{-}xjf}\NormalTok{ filename.tar.bz2 }\AttributeTok{{-}C}\NormalTok{ \textasciitilde{}/tmp}
\end{Highlighting}
\end{Shaded}

\end{column}

解压不带 tar 的 .gz 文件，比如 \href{http://www-cs-faculty.stanford.edu/~knuth/tex.eps.gz}{tex.eps.gz} 解压后变成 tex.eps

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gzip}\NormalTok{ filename.gz }\AttributeTok{{-}d}\NormalTok{ \textasciitilde{}/tmp}
\end{Highlighting}
\end{Shaded}

\hypertarget{repo-install}{%
\section{从仓库安装 R}\label{repo-install}}

\hypertarget{ubuntu}{%
\subsection{Ubuntu}\label{ubuntu}}

安装 openssh zsh 和 Git

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install zsh openssh{-}server}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:git{-}core/ppa}
\FunctionTok{sudo}\NormalTok{ apt update }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ apt install git}
\FunctionTok{sh} \AttributeTok{{-}c} \StringTok{"}\VariableTok{$(}\ExtensionTok{curl} \AttributeTok{{-}fsSL}\NormalTok{ https://raw.githubusercontent.com/robbyrussell/oh{-}my{-}zsh/master/tools/install.sh}\VariableTok{)}\StringTok{"}
\end{Highlighting}
\end{Shaded}

只考虑最新的 Ubuntu 18.04 因为本书写成的时候，该版本应该已经大规模使用了，默认版本的安装和之前版本的安装就不再展示了。安装最新版 R-3.5.x，无论安装哪个版本，都要先导入密钥

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}key adv }\AttributeTok{{-}{-}keyserver}\NormalTok{ hkp://keyserver.ubuntu.com:80 }\AttributeTok{{-}{-}recv}\NormalTok{ E084DAB9}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\item
  Ubuntu 14.04.5 提供的默认版本 R 3.0.2，安装 R 3.5.x 系列之前的版本，如 R 3.4.4

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}add{-}repository }\AttributeTok{{-}y} \StringTok{"deb http://cran.rstudio.com/bin/linux/ubuntu }\KeywordTok{\textasciigrave{}}\ExtensionTok{lsb\_release} \AttributeTok{{-}cs}\KeywordTok{\textasciigrave{}}\StringTok{/"}
\FunctionTok{sudo}\NormalTok{ apt{-}get install r{-}base{-}dev}
\end{Highlighting}
\end{Shaded}

  添加完仓库后，都需要更新源\texttt{sudo\ apt-get\ update}，安装 R 3.5.x 系列最新版

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}add{-}repository }\AttributeTok{{-}y} \StringTok{"deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu trusty{-}cran35/"}
\end{Highlighting}
\end{Shaded}
\item
  Ubuntu 16.04.5 提供的默认版本 R 3.4.4，这是 R 3.4.x 系列的最新版，安装目前最新的 R 3.5.x 版本需要

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}add{-}repository }\AttributeTok{{-}y} \StringTok{"deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu xenial{-}cran35/"}
\end{Highlighting}
\end{Shaded}
\item
  Ubuntu 18.04.1 提供的默认版本 R 3.4.4，安装目前的最新版本需要

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}add{-}repository }\AttributeTok{{-}y} \StringTok{"deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu bionic{-}cran35/"}
\end{Highlighting}
\end{Shaded}

  接下来安装 R，详细安装指导见 \href{https://cran.r-project.org/bin/linux/debian/index.html}{CRAN 官网}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ r{-}base{-}dev}
\end{Highlighting}
\end{Shaded}

  Michael Rutter 维护了编译好的二进制版本 \url{https://launchpad.net/~marutter}，比如 rstan 包可以通过安装 r-cran-rstan 完成

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# R packages for Ubuntu LTS. Based on CRAN Task Views.}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:marutter/c2d4u3.5}
\FunctionTok{sudo}\NormalTok{ apt{-}get install r{-}cran{-}rstan}
\end{Highlighting}
\end{Shaded}
\end{itemize}

\hypertarget{centos}{%
\subsection{CentOS}\label{centos}}

同样适用于 Fedora

安装指导\footnote{在 CentOS 7 上打造 R 语言编程环境}

\hypertarget{source-install}{%
\section{源码安装}\label{source-install}}

\hypertarget{ubuntu-1}{%
\subsection{Ubuntu}\label{ubuntu-1}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  首先启用源码仓库，否则执行 \texttt{sudo\ apt-get\ build-dep\ r-base} 会报如下错误
\end{enumerate}

\begin{verbatim}
E: You must put some 'source' URIs in your sources.list
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ sed }\AttributeTok{{-}i} \AttributeTok{{-}{-}} \StringTok{\textquotesingle{}s/\#deb{-}src/deb{-}src/g\textquotesingle{}}\NormalTok{ /etc/apt/sources.list }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ sed }\AttributeTok{{-}i} \AttributeTok{{-}{-}} \StringTok{\textquotesingle{}s/\# deb{-}src/deb{-}src/g\textquotesingle{}}\NormalTok{ /etc/apt/sources.list}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  安装编译 R 所需的系统依赖
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get build{-}dep r{-}base{-}dev}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  编译安装 R
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{./configure}
\FunctionTok{make} \KeywordTok{\&\&} \FunctionTok{make}\NormalTok{ install }
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  自定义编译选项
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{./configure} \AttributeTok{{-}{-}help}
\end{Highlighting}
\end{Shaded}

\hypertarget{centos-1}{%
\subsection{CentOS}\label{centos-1}}

基于 CentOS 7 和 GCC 4.8.5，参考 R-admin 手册

\begin{itemize}
\item
  下载源码包

  最新发布的稳定版

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{curl} \AttributeTok{{-}fLo}\NormalTok{ ./R{-}latest.tar.gz https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R{-}latest.tar.gz}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
 10 28.7M   10 3232k    0     0   107k      0  0:04:34  0:00:30  0:04:04  118k
\end{verbatim}
\item
  安装依赖

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install }\AttributeTok{{-}y}\NormalTok{ yum{-}utils epel{-}release }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ yum{-}builddep R{-}devel}
\FunctionTok{sudo}\NormalTok{ dnf update }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ dnf builddep R{-}devel }\CommentTok{\# Fedora 30}
\end{Highlighting}
\end{Shaded}
\item
  解压配置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mkdir}\NormalTok{ R{-}latest }\KeywordTok{\&\&} \FunctionTok{tar} \AttributeTok{{-}xzf}\NormalTok{ ./R{-}latest.tar.gz }\AttributeTok{{-}C}\NormalTok{ ./R{-}latest }\KeywordTok{\&\&} \BuiltInTok{cd}\NormalTok{ R{-}3.5.2}

\ExtensionTok{./configure} \AttributeTok{{-}{-}enable{-}R{-}shlib} \AttributeTok{{-}{-}enable{-}byte{-}compiled{-}packages} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}BLAS{-}shlib} \AttributeTok{{-}{-}enable{-}memory{-}profiling}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R is now configured for x86\_64{-}pc{-}linux{-}gnu}

\NormalTok{  Source directory:          .}
\NormalTok{  Installation directory:    /usr/local}

\NormalTok{  C compiler:                gcc {-}std=gnu99  {-}g {-}O2}
\NormalTok{  Fortran 77 compiler:       gfortran  {-}g {-}O2}

\NormalTok{  Default C++ compiler:      g++   {-}g {-}O2}
\NormalTok{  C++98 compiler:            g++ {-}std=gnu++98 {-}g {-}O2}
\NormalTok{  C++11 compiler:            g++ {-}std=gnu++11 {-}g {-}O2}
\NormalTok{  C++14 compiler:}
\NormalTok{  C++17 compiler:}
\NormalTok{  Fortran 90/95 compiler:    gfortran {-}g {-}O2}
\NormalTok{  Obj{-}C compiler:            gcc {-}g {-}O2 {-}fobjc{-}exceptions}

\NormalTok{  Interfaces supported:      X11, tcltk}
\NormalTok{  External libraries:        readline, curl}
\NormalTok{  Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU}
\NormalTok{  Options enabled:           shared R library, shared BLAS, R profiling, memory profiling}

\NormalTok{  Capabilities skipped:}
\NormalTok{  Options not enabled:}

\NormalTok{  Recommended packages:      yes}
\end{Highlighting}
\end{Shaded}
\item
  编译安装

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{make} \AttributeTok{{-}j}\NormalTok{ 2 all}
\FunctionTok{sudo}\NormalTok{ make install}
\end{Highlighting}
\end{Shaded}
\item
  BLAS 加持（可选）

  BLAS 对于加快矩阵计算至关重要，编译 R 带 \href{https://cran.r-project.org/doc/manuals/r-release/R-admin.html\#BLAS}{BLAS 支持}，添加 OpenBLAS 支持 \texttt{-\/-with-blas="-lopenblas"} 或 ATLAS 支持 \texttt{-\/-with-blas="-L/usr/lib64/atlas\ -lsatlas"}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install }\AttributeTok{{-}y}\NormalTok{ openblas openblas{-}threads openblas{-}openmp }

\ExtensionTok{./configure} \AttributeTok{{-}{-}enable{-}R{-}shlib} \AttributeTok{{-}{-}enable{-}byte{-}compiled{-}packages} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}BLAS{-}shlib} \AttributeTok{{-}{-}enable{-}memory{-}profiling} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}with{-}blas}\OperatorTok{=}\StringTok{"{-}lopenblas"}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R is now configured for x86\_64{-}pc{-}linux{-}gnu}

\NormalTok{Source directory:          .}
\NormalTok{Installation directory:    /usr/local}

\NormalTok{C compiler:                gcc {-}std=gnu99  {-}g {-}O2}
\NormalTok{Fortran 77 compiler:       gfortran  {-}g {-}O2}

\NormalTok{Default C++ compiler:      g++   {-}g {-}O2}
\NormalTok{C++98 compiler:            g++ {-}std=gnu++98 {-}g {-}O2}
\NormalTok{C++11 compiler:            g++ {-}std=gnu++11 {-}g {-}O2}
\NormalTok{C++14 compiler:}
\NormalTok{C++17 compiler:}
\NormalTok{Fortran 90/95 compiler:    gfortran {-}g {-}O2}
\NormalTok{Obj{-}C compiler:            gcc {-}g {-}O2 {-}fobjc{-}exceptions}

\NormalTok{Interfaces supported:      X11, tcltk}
\NormalTok{External libraries:        readline, **BLAS(OpenBLAS)**, curl}
\NormalTok{Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU}
\NormalTok{Options enabled:           shared R library, shared BLAS, R profiling, memory profiling}

\NormalTok{Capabilities skipped:}
\NormalTok{Options not enabled:}

\NormalTok{Recommended packages:      yes}
\end{Highlighting}
\end{Shaded}

  配置成功的标志，如 OpenBLAS

\begin{verbatim}
checking for dgemm_ in -lopenblas... yes
checking whether double complex BLAS can be used... yes
checking whether the BLAS is complete... yes
\end{verbatim}

  ATLAS 加持

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install }\AttributeTok{{-}y}\NormalTok{ atlas}
\ExtensionTok{./configure} \AttributeTok{{-}{-}enable{-}R{-}shlib} \AttributeTok{{-}{-}enable{-}byte{-}compiled{-}packages} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}BLAS{-}shlib} \AttributeTok{{-}{-}enable{-}memory{-}profiling} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}with{-}blas}\OperatorTok{=}\StringTok{"{-}L/usr/lib64/atlas {-}lsatlas"}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R is now configured for x86\_64{-}pc{-}linux{-}gnu}

\NormalTok{Source directory:          .}
\NormalTok{Installation directory:    /usr/local}

\NormalTok{C compiler:                gcc {-}std=gnu99  {-}g {-}O2}
\NormalTok{Fortran 77 compiler:       gfortran  {-}g {-}O2}

\NormalTok{Default C++ compiler:      g++   {-}g {-}O2}
\NormalTok{C++98 compiler:            g++ {-}std=gnu++98 {-}g {-}O2}
\NormalTok{C++11 compiler:            g++ {-}std=gnu++11 {-}g {-}O2}
\NormalTok{C++14 compiler:}
\NormalTok{C++17 compiler:}
\NormalTok{Fortran 90/95 compiler:    gfortran {-}g {-}O2}
\NormalTok{Obj{-}C compiler:            gcc {-}g {-}O2 {-}fobjc{-}exceptions}

\NormalTok{Interfaces supported:      X11, tcltk}
\NormalTok{External libraries:        readline, **BLAS(generic)**, curl}
\NormalTok{Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU}
\NormalTok{Options enabled:           shared R library, shared BLAS, R profiling, memory profiling}

\NormalTok{Capabilities skipped:}
\NormalTok{Options not enabled:}

\NormalTok{Recommended packages:      yes}
\end{Highlighting}
\end{Shaded}

  ATLAS 配置成功

\begin{verbatim}
checking for dgemm_ in -L/usr/lib64/atlas -lsatlas... yes
checking whether double complex BLAS can be used... yes
checking whether the BLAS is complete... yes
\end{verbatim}
\end{itemize}

后续步骤同上

\hypertarget{ninja-install}{%
\section{忍者安装}\label{ninja-install}}

从源码自定义安装：加速 Intel MKL 和 大文件支持

\url{https://software.intel.com/en-us/articles/using-intel-mkl-with-r}

\hypertarget{settings}{%
\section{配置}\label{settings}}

\hypertarget{init-session}{%
\subsection{\texorpdfstring{初始会话 \texttt{.Rprofile}}{初始会话 .Rprofile}}\label{init-session}}

\texttt{.Rprofile} 文件位于 \texttt{\textasciitilde{}/} 目录下或者 R 项目的根目录下

查看帮助 \texttt{?.Rprofile}

更多配置设置 \href{https://github.com/HenrikBengtsson/startup}{startup}

\hypertarget{environ-vars}{%
\subsection{\texorpdfstring{环境变量 \texttt{.Renviron}}{环境变量 .Renviron}}\label{environ-vars}}

\texttt{.Renviron} 文件位于 \texttt{\textasciitilde{}/} 目录下

\hypertarget{make-vars}{%
\subsection{\texorpdfstring{编译选项 \texttt{Makevars}}{编译选项 Makevars}}\label{make-vars}}

\texttt{Makevars} 文件位于 \texttt{\textasciitilde{}/.R/} 目录下

\hypertarget{command-line-arguments}{%
\section{命令行参数}\label{command-line-arguments}}

\texttt{commandArgs} 从终端命令行中传递参数

\begin{itemize}
\tightlist
\item
  \href{https://github.com/mdequeljoe/rdoc}{rdoc} 高亮 R 帮助文档中的 R 函数、关键字 \texttt{NULL}。启用需要在R控制台中执行 \texttt{rdoc::use\_rdoc()}
\item
  \href{https://github.com/randy3k/radian}{radian} 代码自动补全和语法高亮，进入 R 控制台，终端中输入\texttt{radian}
\item
  \href{https://github.com/docopt/docopt.R}{docopt} 提供R命令行工具，如 \href{https://github.com/eddelbuettel/littler}{littler} 包，\href{https://github.com/trevorld/r-getopt}{getopt} 从终端命令行接受参数
\item
  \href{https://github.com/trevorld/r-optparse}{optparse} 命令行选项参数的解析器
\end{itemize}

安装完 R-littler R-littler-examples (centos) 或 littler r-cran-littler (ubuntu) 后，执行

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# centos}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib64/R/library/littler/examples/install.r /usr/bin/install.r }
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib64/R/library/littler/examples/install2.r /usr/bin/install2.r}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib64/R/library/littler/examples/installGithub.r /usr/bin/installGithub.r }
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib64/R/library/littler/examples/testInstalled.r /usr/bin/testInstalled.r}
\CommentTok{\# ubuntu}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib/R/site{-}library/littler/examples/install.r /usr/bin/install.r }
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib/R/site{-}library/littler/examples/install2.r /usr/bin/install2.r}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib/R/site{-}library/littler/examples/installGithub.r /usr/bin/installGithub.r }
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib/R/site{-}library/littler/examples/testInstalled.r /usr/bin/testInstalled.r}
\end{Highlighting}
\end{Shaded}

这样可以载终端中安装 R 包了

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{install.r docopt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
#!/usr/bin/env Rscript
# 安装 optparse 提供更加灵活的传参方式
# 也可参考 littler https://github.com/eddelbuettel/littler
# if("optparse" %in% .packages(TRUE)) install.packages('optparse',repos = "https://cran.rstudio.com")
# https://cran.r-project.org/doc/manuals/R-intro.html#Invoking-R-from-the-command-line
# http://www.cureffi.org/2014/01/15/running-r-batch-mode-linux/
args = commandArgs(trailingOnly=TRUE)

# 函数功能：在浏览器中同时打开多个 PDF 文档
open_pdf <- function(pdf_path = "./figures/", n = 1) {
  # pdf_path:     PDF文件所在目录
  # n:            默认打开1个PDF文档
  # PDF文档目录
  pdfs <- list.files(pdf_path, pattern = '\\.pdf$')
  # PDF 文档路径
  path_to_pdfs <- paste(pdf_path, pdfs, sep = .Platform$file.sep)
  # 打开 PDF 文档
  invisible(lapply(head(path_to_pdfs, n), browseURL))
}

open_pdf(pdf_path, n = args[1])

# 使用： Rscript --vanilla code/batch-open-pdf.R 20
\end{verbatim}

\hypertarget{sec-build-source-code}{%
\section{从源码安装 R}\label{sec-build-source-code}}

从源码编译 R 的需求大概有以下几点：

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  爱折腾的极客：玩配置，学习 make 相关工具和 Linux 世界的依赖
\item
  追求性能：如 \href{http://users.suse.com/~aj/linux_lfs.html}{LFS 支持} 和 \href{http://dirk.eddelbuettel.com/blog/2018/04/15/\#018_mkl_for_debian_ubuntu}{Intel MKL 加速}
\item
  环境限制：CentOS 或者红帽系统，自带的 R 版本比较落后
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{./configure} \AttributeTok{{-}{-}prefix}\OperatorTok{=}\NormalTok{/opt/R/R{-}devel }\DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}R{-}shlib} \AttributeTok{{-}{-}enable{-}byte{-}compiled{-}packages} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}BLAS{-}shlib} \AttributeTok{{-}{-}enable{-}memory{-}profiling} \AttributeTok{{-}{-}with{-}blas}\OperatorTok{=}\StringTok{"{-}lopenblas"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
R is now configured for x86_64-pc-linux-gnu

  Source directory:            .
  Installation directory:      /opt/R/R-devel

  C compiler:                  gcc  -g -O2
  Fortran fixed-form compiler: gfortran -fno-optimize-sibling-calls -g -O2

  Default C++ compiler:        g++ -std=gnu++11  -g -O2
  C++14 compiler:              g++ -std=gnu++14  -g -O2
  C++17 compiler:              g++ -std=gnu++17  -g -O2
  C++20 compiler:              g++ -std=gnu++2a  -g -O2
  Fortran free-form compiler:  gfortran -fno-optimize-sibling-calls -g -O2
  Obj-C compiler:               

  Interfaces supported:        X11, tcltk
  External libraries:          pcre2, readline, BLAS(OpenBLAS), curl
  Additional capabilities:     PNG, JPEG, TIFF, NLS, cairo, ICU
  Options enabled:             shared R library, shared BLAS, R profiling, memory profiling

  Capabilities skipped:        
  Options not enabled:         

  Recommended packages:        yes
\end{verbatim}

配置好了以后，可以编译安装了

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{make} \KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ make install}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/Enchufa2/r-flexiblas}{flexiblas} 支持多种 BLAS 库自由切换

\hypertarget{install-softwares}{%
\section{安装软件}\label{install-softwares}}

本书在后续章节中陆续用到新的 R 包，其安装过程不会在正文中呈现，下面以在 CentOS 8 上安装 \textbf{sf} 包为例介绍。首先需要安装一些系统依赖，具体安装哪些依赖参见 \textbf{sf} 包开发站点 \url{https://github.com/r-spatial/sf}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf config{-}manager }\AttributeTok{{-}{-}set{-}disabled}\NormalTok{ PowerTools }\CommentTok{\# openblas{-}devel}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ sqlite{-}devel gdal{-}devel }\DataTypeTok{\textbackslash{}}
\NormalTok{  proj{-}devel geos{-}devel udunits2{-}devel}
\end{Highlighting}
\end{Shaded}

然后，在 R 命令行窗口中，执行安装命令：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}sf\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

至此，安装完成。如遇本地未安装的新 R 包，可从其官方文档中找寻安装方式。如果你完全不知道自己应该安装哪些，考虑把下面的依赖都安装上

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y} \DataTypeTok{\textbackslash{}}
  \CommentTok{\# magick}
  \ExtensionTok{ImageMagick{-}c++{-}devel} \DataTypeTok{\textbackslash{} }
  \CommentTok{\# pdftools}
  \ExtensionTok{poppler{-}cpp{-}devel} \DataTypeTok{\textbackslash{} }
  \CommentTok{\# gifski}
  \ExtensionTok{cargo} 
\end{Highlighting}
\end{Shaded}

软件包管理器架构图，各个命令分别担负什么样的功能，每个命令学习的一般路径是什么，而不是详细介绍每个命令、每个参数的使用，只需给出一个命令的完整使用即可，其余给出一个查询命令帮助手册

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{dnf}\NormalTok{ copr}
\ExtensionTok{dnf}\NormalTok{ config{-}manager}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-install-r-pkgs}{%
\section{安装 R 包}\label{sec-install-r-pkgs}}

Iñaki Ucar 开发的 \href{https://github.com/Enchufa2/cran2copr}{cran2copr} 项目实现在 Fedora 上安装预编译好的二进制 R 包，项目目的类似 Debian 平台上的 \href{https://github.com/r-builder/cran2deb}{cran2deb}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \href{https://github.com/r-lib/devtools}{devtools} 是开发 R 包的常用工具，同时具有很重的依赖，请看

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(}\StringTok{\textquotesingle{}devtools\textquotesingle{}}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $devtools
##  [1] "usethis"     "callr"       "cli"         "desc"        "ellipsis"   
##  [6] "fs"          "httr"        "lifecycle"   "memoise"     "pkgbuild"   
## [11] "pkgload"     "rcmdcheck"   "remotes"     "rlang"       "roxygen2"   
## [16] "rstudioapi"  "rversions"   "sessioninfo" "stats"       "testthat"   
## [21] "tools"       "utils"       "withr"       "processx"    "R6"         
## [26] "glue"        "crayon"      "rprojroot"   "methods"     "curl"       
## [31] "jsonlite"    "mime"        "openssl"     "cachem"      "prettyunits"
## [36] "digest"      "xopen"       "brew"        "commonmark"  "knitr"      
## [41] "purrr"       "stringi"     "stringr"     "xml2"        "cpp11"      
## [46] "brio"        "evaluate"    "magrittr"    "praise"      "ps"         
## [51] "waldo"       "clipr"       "gert"        "gh"          "rappdirs"   
## [56] "whisker"     "yaml"        "graphics"    "grDevices"   "fastmap"    
## [61] "askpass"     "credentials" "sys"         "zip"         "gitcreds"   
## [66] "ini"         "highr"       "xfun"        "diffobj"     "fansi"      
## [71] "rematch2"    "tibble"      "pillar"      "pkgconfig"   "vctrs"      
## [76] "utf8"
\end{verbatim}

  其中，依赖关系见表 \ref{tab:devtools-sys-dep}

  \begin{longtable}[]{@{}llll@{}}
  \caption{\label{tab:devtools-sys-dep} devtools 的系统依赖}\tabularnewline
  \toprule
  & curl & git2r & openssl \\
  \midrule
  \endfirsthead
  \toprule
  & curl & git2r & openssl \\
  \midrule
  \endhead
  Ubuntu & libcurl-dev\footnote{libcurl-dev 是一个虚包 virtual package，由 libcurl4-openssl-dev 或 libcurl4-nss-dev 或 libcurl4-gnutls-dev 实际提供，选择其中一个安装即可。} & libgit2-dev & libssl-dev \\
  CentOS & libcurl-devel & libgit2-devel & openssl-devel \\
  \bottomrule
  \end{longtable}
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \href{https://github.com/r-spatial/sf}{sf} 是处理空间数据的常用工具

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(}\StringTok{\textquotesingle{}sf\textquotesingle{}}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $sf
##  [1] "methods"    "classInt"   "DBI"        "graphics"   "grDevices" 
##  [6] "grid"       "magrittr"   "Rcpp"       "s2"         "stats"     
## [11] "tools"      "units"      "utils"      "e1071"      "class"     
## [16] "KernSmooth" "wk"         "MASS"       "proxy"      "cpp11"
\end{verbatim}

  其主要的系统依赖分别是 GEOS 3.5.1, GDAL 2.2.2, PROJ 4.9.2

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:ubuntugis/ubuntugis{-}unstable}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ libudunits2{-}dev libgdal{-}dev libgeos{-}dev libproj{-}dev }
\end{Highlighting}
\end{Shaded}

  这样也同时解决了 \href{https://github.com/pacificclimate/Rudunits2}{udunits2}、 \href{https://r-forge.r-project.org/projects/rgdal/}{rgdal} 和 \href{https://r-forge.r-project.org/projects/rgeos/}{rgeos} 等 3个 R 包的系统依赖，其中 udunits2 使用如下命令安装

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(’udunits2’, }\AttributeTok{configure.args =} \StringTok{\textquotesingle{}{-}{-}with{-}udunits2{-}include=/usr/include/udunits2\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  图形设备支持 cairo png jpeg tiff

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ libcairo2{-}dev libjpeg{-}dev libpng{-}dev libtiff{-}dev }
\end{Highlighting}
\end{Shaded}
\item
  图像处理 \href{https://github.com/dahtah/imager}{imager} 和 \href{https://github.com/ropensci/magick}{magick}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install fftw{-}devel }\CommentTok{\# CentOS}
\FunctionTok{sudo}\NormalTok{ apt{-}get install libfftw3{-}dev }\CommentTok{\# Ubuntu}
\end{Highlighting}
\end{Shaded}

  在 Ubuntu 系统上安装最新的 libmagick++-dev 库

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:opencpu/imagemagick}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ libmagick++{-}dev }
\end{Highlighting}
\end{Shaded}

  在 CentOS 系统上

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install }\AttributeTok{{-}y}\NormalTok{ ImageMagick{-}c++{-}devel}
\end{Highlighting}
\end{Shaded}

  然后安装 R 包 \texttt{install.packages(c(\textquotesingle{}imager\textquotesingle{},\ \textquotesingle{}magick\textquotesingle{}))}
\item
  \href{https://r-forge.r-project.org/projects/rgl/}{rgl} 是绘制真三维图形的重量级 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install libcgal{-}dev libglu1{-}mesa{-}dev libx11{-}dev }\CommentTok{\# Ubuntu}
\FunctionTok{sudo}\NormalTok{ yum install mesa{-}libGLU mesa{-}libGLU{-}devel }\CommentTok{\# CentOS}
\end{Highlighting}
\end{Shaded}

  然后安装 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}rgl\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

  在 Ubuntu 系统上还可以这样安装

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository ppa:marutter/rrutter3.5}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install r{-}cran{-}rgl}
\end{Highlighting}
\end{Shaded}
\item
  \href{https://github.com/s-u/rJava}{rJava} 是 Java 语言和 R 语言之间实现通信交流的桥梁

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ default{-}jdk}
\FunctionTok{sudo}\NormalTok{ R CMD javareconf}
\end{Highlighting}
\end{Shaded}

  然后安装 rJava 包 \texttt{install.packages(’rJava’)}
\item
  \href{https://igraph.org/}{igraph} 是网络数据分析的必备 R 包，为了发挥其最大性能，需要安装三个系统依赖

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ libgmp{-}dev libxml2{-}dev libglpk{-}dev}
\end{Highlighting}
\end{Shaded}

  然后安装 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}igraph\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  \href{https://github.com/cdeterman/gpuR}{gpuR} 是基于 GPU 进行矩阵计算的扩展包，依赖 RcppEigen 确保安装 OpenCL 和 RViennaCL 或者 安装 Nvidia 驱动和 CUDA，使用 \href{https://github.com/gpuRcore/gpuRcuda}{gpuRcuda} 和 \href{https://github.com/nullsatz/gputools}{gputools} 扩展包，下面安装指导来自其 Wiki

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Install OpenCL headers}
\FunctionTok{sudo}\NormalTok{ apt{-}get install opencl{-}headers opencv{-}dev}

\CommentTok{\# Install NVIDIA Drivers and CUDA}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:xorg{-}edgers/ppa}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install nvidia{-}346 nvidia{-}settings}
\end{Highlighting}
\end{Shaded}
\item
  \href{https://github.com/jyypma/nloptr}{nloptr} 是 \href{https://github.com/stevengj/NLopt/}{NLopt} 的 R 语言接口，首先安装 NLopt 程序库 \texttt{sudo\ apt-get\ install\ libnlopt-dev} 然后安装 R 包\texttt{install.packages(\textquotesingle{}nloptr\textquotesingle{})}，nloptr 被 700+ R 包依赖，如 \textbf{lme4}， \textbf{spaMM}， \textbf{glmmTMB}， \textbf{rstanarm} 等。
\item
  Rmpfr

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install libmpfr{-}dev}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(’Rmpfr’)}
\end{Highlighting}
\end{Shaded}
\item
  geojson

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install jq{-}devel protobuf{-}devel}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}geojson\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}geojsonio\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}jqr\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}protolite\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}
\item
  lgcp

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install bwidget}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}rpanel\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}lgcp\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}
\item
  ijtiff

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install jbigkit{-}devel}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}ijtiff\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  webshot 包用于截图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt install phantomjs}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(’webshot’)}
\end{Highlighting}
\end{Shaded}
\item
  gifski 包合成 GIF 动图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install cargo}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}gifski\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

\hypertarget{sec-software-manager}{%
\section{软件包管理器}\label{sec-software-manager}}

\hypertarget{subsec-dnf-yum}{%
\subsection{dnf}\label{subsec-dnf-yum}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  清理升级后的 CentOS 8 系统内核
\end{enumerate}

查找系统安装的内核

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{rpm} \AttributeTok{{-}qa} \KeywordTok{|} \FunctionTok{sort} \KeywordTok{|} \FunctionTok{grep}\NormalTok{ kernel}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
kernel-4.18.0-147.8.1.el8_1.x86_64
kernel-4.18.0-193.6.3.el8_2.x86_64
kernel-core-4.18.0-147.8.1.el8_1.x86_64
kernel-core-4.18.0-193.6.3.el8_2.x86_64
kernel-headers-4.18.0-193.6.3.el8_2.x86_64
kernel-modules-4.18.0-147.8.1.el8_1.x86_64
kernel-modules-4.18.0-193.6.3.el8_2.x86_64
kernel-tools-4.18.0-193.6.3.el8_2.x86_64
kernel-tools-libs-4.18.0-193.6.3.el8_2.x86_64
\end{verbatim}

仅保留一个版本的内核，其它旧的内核都删除掉

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf remove }\VariableTok{$(}\ExtensionTok{dnf}\NormalTok{ repoquery }\AttributeTok{{-}{-}installonly} \AttributeTok{{-}{-}latest{-}limit}\OperatorTok{=}\NormalTok{{-}1 }\AttributeTok{{-}q}\VariableTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
模块依赖问题

 问题 1: conflicting requests
  - nothing provides module(perl:5.26) needed by module perl-DBD-MySQL:4.046:8010020191114030811:073fa5fe-0.x86_64
 问题 2: conflicting requests
  - nothing provides module(perl:5.26) needed by module perl-DBI:1.641:8010020191113222731:16b3ab4d-0.x86_64
 问题 3: conflicting requests
  - nothing provides module(perl:5.26) needed by module perl-YAML:1.24:8010020191114031501:a5949e2e-0.x86_64
依赖关系解决。
=======================================================================================================================
 软件包                        架构                  版本                                 仓库                    大小
=======================================================================================================================
移除:
 kernel                        x86_64                4.18.0-147.8.1.el8_1                 @BaseOS                  0  
 kernel-core                   x86_64                4.18.0-147.8.1.el8_1                 @BaseOS                 58 M
 kernel-modules                x86_64                4.18.0-147.8.1.el8_1                 @BaseOS                 20 M

事务概要
=======================================================================================================================
移除  3 软件包

将会释放空间：78 M
确定吗？[y/N]： y
运行事务检查
事务检查成功。
运行事务测试
事务测试成功。
运行事务
  准备中  :                                                                                                        1/1 
  删除    : kernel-4.18.0-147.8.1.el8_1.x86_64                                                                     1/3 
  运行脚本: kernel-4.18.0-147.8.1.el8_1.x86_64                                                                     1/3 
  删除    : kernel-modules-4.18.0-147.8.1.el8_1.x86_64                                                             2/3 
  运行脚本: kernel-modules-4.18.0-147.8.1.el8_1.x86_64                                                             2/3 
  运行脚本: kernel-core-4.18.0-147.8.1.el8_1.x86_64                                                                3/3 
  删除    : kernel-core-4.18.0-147.8.1.el8_1.x86_64                                                                3/3 
  运行脚本: kernel-core-4.18.0-147.8.1.el8_1.x86_64                                                                3/3 
  验证    : kernel-4.18.0-147.8.1.el8_1.x86_64                                                                     1/3 
  验证    : kernel-core-4.18.0-147.8.1.el8_1.x86_64                                                                2/3 
  验证    : kernel-modules-4.18.0-147.8.1.el8_1.x86_64                                                             3/3 

已移除:
  kernel-4.18.0-147.8.1.el8_1.x86_64                          kernel-core-4.18.0-147.8.1.el8_1.x86_64                 
  kernel-modules-4.18.0-147.8.1.el8_1.x86_64                 

完毕！
\end{verbatim}

\href{https://unix.stackexchange.com/questions/587853/centos-8-modular-dependency-problems}{解决上述模块依赖问题的办法} 是重置三个 Perl 模块

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf module reset perl{-}DBD{-}MySQL perl{-}YAML perl{-}DBI}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
依赖关系解决。
=======================================================================================================================
 软件包                      架构                       版本                         仓库                         大小
=======================================================================================================================
重置模块:
 perl-DBD-MySQL                                                                                                       
 perl-DBI                                                                                                             
 perl-YAML                                                                                                            

事务概要
=======================================================================================================================

确定吗？[y/N]： y
完毕！
\end{verbatim}

\hypertarget{subsec-apt-get}{%
\subsection{apt}\label{subsec-apt-get}}

添加或删除 PPA (Personal Package Archive)，比如在 Ubuntu 20.04 及之前的版本上安装\href{https://inkscape.org/release/inkscape-1.0/gnulinux/ubuntu/ppa/dl/}{新版 Inkscape}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository ppa:inkscape.dev/stable}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}{-}remove}\NormalTok{ ppa:inkscape.dev/stable}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install build{-}essential }\CommentTok{\# 修复依赖问题}
\FunctionTok{sudo}\NormalTok{ apt update }\CommentTok{\# 更新资源列表}
\FunctionTok{sudo}\NormalTok{ apt{-}get upgrade }\CommentTok{\# 更新软件包}
\FunctionTok{sudo}\NormalTok{ apt{-}get autoclean }\CommentTok{\# 删除已卸的软件的备份}
\FunctionTok{sudo}\NormalTok{ apt{-}get clean }\CommentTok{\# 删除已装或已卸的软件的备份}
\FunctionTok{sudo}\NormalTok{ apt{-}get autoremove }\AttributeTok{{-}{-}purge} \PreprocessorTok{*} \CommentTok{\# 推荐卸载软件的方式}
\ExtensionTok{apt{-}get}\NormalTok{ list }\AttributeTok{{-}{-}upgradable} \CommentTok{\# 列出可升级的包}
\end{Highlighting}
\end{Shaded}

找到并删除旧的内核

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{dpkg} \AttributeTok{{-}{-}list} \KeywordTok{|} \FunctionTok{grep}\NormalTok{ linux{-}image}
\FunctionTok{sudo}\NormalTok{ apt{-}get purge linux{-}image{-}3.19.0{-}}\DataTypeTok{\{18}\OperatorTok{,}\DataTypeTok{20}\OperatorTok{,}\DataTypeTok{21}\OperatorTok{,}\DataTypeTok{25\}}
\FunctionTok{sudo}\NormalTok{ update{-}grub2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 搜索}
\ExtensionTok{apt{-}cache}\NormalTok{ search octave }\KeywordTok{|} \FunctionTok{grep}\NormalTok{ octave}
\CommentTok{\# 查询}
\ExtensionTok{apt}\NormalTok{ show octave}
\CommentTok{\# 安装}
\FunctionTok{sudo}\NormalTok{ apt install octave}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install lsb{-}core}
\ExtensionTok{lsb\_release} \AttributeTok{{-}a}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{adduser}\NormalTok{ cloud2016 }\CommentTok{\# 添加用户}
\FunctionTok{passwd}\NormalTok{ cloud2016  }\CommentTok{\# 用户密码设为 cloud}
\FunctionTok{whereis}\NormalTok{ sudoers   }\CommentTok{\# 查找文件位置}
\FunctionTok{chmod} \AttributeTok{{-}v}\NormalTok{ u+w /etc/sudoers }\CommentTok{\# 给文件 sudoers 添加写权限}
\ExtensionTok{vim}\NormalTok{ /etc/sudoers }\CommentTok{\# 添加 cloud2016 管理员权限}
\FunctionTok{chmod} \AttributeTok{{-}v}\NormalTok{ u{-}w /etc/sudoers }\CommentTok{\# 收回权限}
\end{Highlighting}
\end{Shaded}

安装确认 openssh-server 服务

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt install openssh{-}server}
\FunctionTok{sudo}\NormalTok{ /etc/init.d/ssh start}
\FunctionTok{ps} \AttributeTok{{-}aux} \KeywordTok{|} \FunctionTok{grep}\NormalTok{ ssh}
\end{Highlighting}
\end{Shaded}

\hypertarget{chap-matrix-operations}{%
\chapter{矩阵运算}\label{chap-matrix-operations}}

\begin{quote}
Eigenvectors from Eigenvalues \citep{Denton_2019_Eigen}
\end{quote}

\begin{quote}
参考 \href{https://github.com/friendly/matlib}{matlib} 和 Matrix 包，\href{https://CRAN.R-project.org/package=SparseM}{SparseM} 更加强调稀疏矩阵的 Cholesky 分解和后退法，矩阵取子集和 Kronecker 积。矩阵计算一般介绍参考在线书籍 Stephen Boyd and Lieven Vandenberghe 最新著作 Introduction to Applied Linear Algebra -- Vectors, Matrices, and Least Squares \citep{Boyd_2018_matrix} 及其 \href{https://web.stanford.edu/~boyd/vmls/vmls-julia-companion.pdf}{Julia 语言实现}，矩阵分解部分参考 \href{http://math.mit.edu/~gs/linearalgebra/linearalgebra5_Matrix.pdf}{Introduction to Linear Algebra, 5th Edition}、\href{https://shainarace.github.io/LinearAlgebra}{Linear Algebra for Data Science with examples in R}
\end{quote}

\href{https://github.com/faosorios/fastmatrix}{fastmatrix}、\href{https://cran.r-project.org/package=abind}{abind} 各种矩阵操作。

\href{https://web.evanchen.cc/}{Evan Chen} 的书\href{https://github.com/vEnhance/napkin}{An Infinitely Large Napkin} 介绍矩阵代数的内积空间、群、环、域等高级内容，作者提供免费的电子书。

分块矩阵操作，各类分解算法，及其 R 实现

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Matrix)}
\end{Highlighting}
\end{Shaded}

以 attitude 数据集为例介绍各种矩阵操作

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(attitude)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   rating complaints privileges learning raises critical advance
## 1     43         51         30       39     61       92      45
## 2     63         64         51       54     63       73      47
## 3     71         70         68       69     76       86      48
## 4     61         63         45       47     54       84      35
## 5     81         78         56       66     71       83      47
## 6     43         55         49       44     54       49      34
\end{verbatim}

rating 总体评价 complaints 处理员工投诉 privileges 不允许特权 learning 学习机会 raises 根据表现晋升 critical 批评 advancel 进步

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(rating }\SpecialCharTok{\textasciitilde{}}\NormalTok{. , }\AttributeTok{data =}\NormalTok{ attitude)}
\FunctionTok{summary}\NormalTok{(fit) }\CommentTok{\# 模型是显著的，很多变量的系数不显著}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = rating ~ ., data = attitude)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -10.9418  -4.3555   0.3158   5.5425  11.5990 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept) 10.78708   11.58926   0.931 0.361634    
## complaints   0.61319    0.16098   3.809 0.000903 ***
## privileges  -0.07305    0.13572  -0.538 0.595594    
## learning     0.32033    0.16852   1.901 0.069925 .  
## raises       0.08173    0.22148   0.369 0.715480    
## critical     0.03838    0.14700   0.261 0.796334    
## advance     -0.21706    0.17821  -1.218 0.235577    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 7.068 on 23 degrees of freedom
## Multiple R-squared:  0.7326, Adjusted R-squared:  0.6628 
## F-statistic:  10.5 on 6 and 23 DF,  p-value: 1.24e-05
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Analysis of Variance Table
## 
## Response: rating
##            Df  Sum Sq Mean Sq F value    Pr(>F)    
## complaints  1 2927.58 2927.58 58.6026 9.056e-08 ***
## privileges  1    7.52    7.52  0.1505    0.7016    
## learning    1  137.25  137.25  2.7473    0.1110    
## raises      1    0.94    0.94  0.0189    0.8920    
## critical    1    0.56    0.56  0.0113    0.9163    
## advance     1   74.11   74.11  1.4835    0.2356    
## Residuals  23 1149.00   49.96                      
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{attitude\_mat }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix.data.frame}\NormalTok{(attitude)}
\CommentTok{\# 生成演示用的矩阵}
\NormalTok{demo\_mat }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(attitude\_mat[, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{\%*\%}\NormalTok{ attitude\_mat[, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-matrix-multiplication}{%
\section{矩阵乘法}\label{subsec-matrix-multiplication}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{)}
\NormalTok{A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    2
## [2,]    2    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{B }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{), }\AttributeTok{nrow =}\DecValTok{2}\NormalTok{)}
\NormalTok{B}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2] [,3]
## [1,]    1    3    5
## [2,]    2    4    6
\end{verbatim}

通常的矩阵乘法也叫矩阵内积

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{\%*\%}\NormalTok{ B}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2] [,3]
## [1,]    5   11   17
## [2,]    8   18   28
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{**} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    4
## [2,]    4    9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{\^{}} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    4
## [2,]    4    9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{**}\NormalTok{ A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    4
## [2,]    4   27
\end{verbatim}

\hypertarget{subsec-hadamard-product}{%
\section{Hadamard 积}\label{subsec-hadamard-product}}

Hadamard 积（法国数学家 Jacques Hadamard）也叫 Schur 积（德国数学家Issai Schur ）或 entrywise 积是两个维数相同的矩阵对应元素相乘，特别地，\(A^2\) 表示将矩阵 \(A\) 的每个元素平方

\[
(A\circ B)_{ij} = (A)_{ij}(B)_{ij}
\]

\[
\begin{bmatrix}
 a_{11} & a_{12}  & a_{13} \\ 
 a_{21} & a_{22}  & a_{23} \\ 
 a_{31} & a_{32}  & a_{33} 
\end{bmatrix}
\circ
\begin{bmatrix}
 b_{11} & b_{12}  & b_{13} \\ 
 b_{21} & b_{22}  & b_{23} \\ 
 b_{31} & b_{32}  & b_{33} 
\end{bmatrix}
= 
\begin{bmatrix}
 a_{11}b_{11} & a_{12}b_{12}  & a_{13}b_{13} \\ 
 a_{21}b_{21} & a_{22}b_{22}  & a_{23}b_{23} \\ 
 a_{31}b_{31} & a_{32}b_{32}  & a_{33}b_{33} 
\end{bmatrix}
\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A}\SpecialCharTok{\^{}}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    4
## [2,]    4    9
\end{verbatim}

\hypertarget{subsec-matrix-transpose}{%
\section{矩阵转置}\label{subsec-matrix-transpose}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t}\NormalTok{(B)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    2
## [2,]    3    4
## [3,]    5    6
\end{verbatim}

\hypertarget{subsec-outer-product}{%
\section{矩阵外积}\label{subsec-outer-product}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{\%o\%}\NormalTok{ B }\CommentTok{\# outer(A, B, FUN = "*")}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , 1, 1
## 
##      [,1] [,2]
## [1,]    1    2
## [2,]    2    3
## 
## , , 2, 1
## 
##      [,1] [,2]
## [1,]    2    4
## [2,]    4    6
## 
## , , 1, 2
## 
##      [,1] [,2]
## [1,]    3    6
## [2,]    6    9
## 
## , , 2, 2
## 
##      [,1] [,2]
## [1,]    4    8
## [2,]    8   12
## 
## , , 1, 3
## 
##      [,1] [,2]
## [1,]    5   10
## [2,]   10   15
## 
## , , 2, 3
## 
##      [,1] [,2]
## [1,]    6   12
## [2,]   12   18
\end{verbatim}

直积/克罗内克积

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{\%x\%}\NormalTok{ B }\CommentTok{\# kronecker(A, B, FUN = "*")}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2] [,3] [,4] [,5] [,6]
## [1,]    1    3    5    2    6   10
## [2,]    2    4    6    4    8   12
## [3,]    2    6   10    3    9   15
## [4,]    4    8   12    6   12   18
\end{verbatim}

\hypertarget{subsec-matrix-exp}{%
\section{矩阵乘方}\label{subsec-matrix-exp}}

矩阵 A 首先是一个方阵，对称性和正定性未知，n 个 矩阵 A 相乘

统计之都论坛讨论如何求矩阵的乘方 \url{https://d.cosx.org/d/5619-svd}

\begin{Shaded}
\begin{Highlighting}[]
\StringTok{"\%\^{}\%"} \OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(mat, pow) \{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.matrix}\NormalTok{(mat)) mat }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(mat)}
  \FunctionTok{stopifnot}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{diff}\NormalTok{(}\FunctionTok{dim}\NormalTok{(mat)))}
  \ControlFlowTok{if}\NormalTok{ (pow }\SpecialCharTok{\textless{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    pow }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\NormalTok{pow}
\NormalTok{    mat }\OtherTok{\textless{}{-}} \FunctionTok{solve}\NormalTok{(mat)}
\NormalTok{  \}}
\NormalTok{  pow }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(pow)}
  \ControlFlowTok{switch}\NormalTok{(pow }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, }\FunctionTok{return}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(mat))), }\FunctionTok{return}\NormalTok{(mat))}
\NormalTok{  get.exponents }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(pow)}
    \ControlFlowTok{if}\NormalTok{ (pow }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\ConstantTok{NULL} \ControlFlowTok{else} \FunctionTok{c}\NormalTok{(k }\OtherTok{\textless{}{-}} \DecValTok{2}\SpecialCharTok{\^{}}\FunctionTok{floor}\NormalTok{(}\FunctionTok{log2}\NormalTok{(pow)), }\FunctionTok{get.exponents}\NormalTok{(pow }\SpecialCharTok{{-}}\NormalTok{ k))}
\NormalTok{  ans }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(mat))}
\NormalTok{  dlog2exp }\OtherTok{\textless{}{-}} \FunctionTok{rev}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{diff}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{log2}\NormalTok{(}\FunctionTok{get.exponents}\NormalTok{(pow)), }\DecValTok{0}\NormalTok{)))}
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(dlog2exp)) \{}
    \ControlFlowTok{if}\NormalTok{ (dlog2exp[j]) }\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{dlog2exp[j]) mat }\OtherTok{\textless{}{-}}\NormalTok{ mat }\SpecialCharTok{\%*\%}\NormalTok{ mat}
\NormalTok{    ans }\OtherTok{\textless{}{-}}\NormalTok{ ans }\SpecialCharTok{\%*\%}\NormalTok{ mat}
\NormalTok{  \}}
\NormalTok{  ans}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

奇异值分解

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s }\OtherTok{\textless{}{-}} \FunctionTok{svd}\NormalTok{(A)}
\FunctionTok{all.equal}\NormalTok{(s}\SpecialCharTok{$}\NormalTok{u}\SpecialCharTok{\%*\%}\FunctionTok{diag}\NormalTok{(s}\SpecialCharTok{$}\NormalTok{d)}\SpecialCharTok{\%*\%}\FunctionTok{t}\NormalTok{(s}\SpecialCharTok{$}\NormalTok{v),A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

特征值及分解 \(A = V \Lambda V^{-1}\) 求解矩阵 A 的 n 次方

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{eigen}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## eigen() decomposition
## $values
## [1]  4.236068 -0.236068
## 
## $vectors
##           [,1]       [,2]
## [1,] 0.5257311 -0.8506508
## [2,] 0.8506508  0.5257311
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{eigen}\NormalTok{(A)}\SpecialCharTok{$}\NormalTok{vectors }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(}\FunctionTok{eigen}\NormalTok{(A)}\SpecialCharTok{$}\NormalTok{values) }\SpecialCharTok{\%*\%} \FunctionTok{solve}\NormalTok{(}\FunctionTok{eigen}\NormalTok{(A)}\SpecialCharTok{$}\NormalTok{vectors)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    2
## [2,]    2    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{eigen}\NormalTok{(A)}\SpecialCharTok{$}\NormalTok{vectors }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(}\FunctionTok{eigen}\NormalTok{(A)}\SpecialCharTok{$}\NormalTok{values)}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{\%*\%} \FunctionTok{solve}\NormalTok{(}\FunctionTok{eigen}\NormalTok{(A)}\SpecialCharTok{$}\NormalTok{vectors)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]   21   34
## [2,]   34   55
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{\%*\%}\NormalTok{ A }\SpecialCharTok{\%*\%}\NormalTok{ A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]   21   34
## [2,]   34   55
\end{verbatim}

\hypertarget{subsec-matrix-power}{%
\section{矩阵求幂}\label{subsec-matrix-power}}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{2}\SpecialCharTok{\^{}}\NormalTok{A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    2    4
## [2,]    4    8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{exp}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          [,1]      [,2]
## [1,] 2.718282  7.389056
## [2,] 7.389056 20.085537
\end{verbatim}

\href{https://cran.r-project.org/web/packages/expm/index.html}{expm} 包含 更多关于矩阵开方、取对数等计算

\hypertarget{subsec-matrix-crossproduct}{%
\section{矩阵交叉积}\label{subsec-matrix-crossproduct}}

交叉积 \(A^{\top}A\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{crossprod}\NormalTok{(A, A)  }\CommentTok{\#  t(x) \%*\% y}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    5    8
## [2,]    8   13
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tcrossprod}\NormalTok{(A, A) }\CommentTok{\#  x \%*\% t(y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    5    8
## [2,]    8   13
\end{verbatim}

\hypertarget{subsec-matrix-determinant}{%
\section{矩阵行列式}\label{subsec-matrix-determinant}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{det}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1
\end{verbatim}

expm 包计算矩阵 \(e^{\mathbf{A}}\)

\hypertarget{subsec-matrix-cond-num}{%
\section{矩阵条件数}\label{subsec-matrix-cond-num}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Matrix)}
\NormalTok{base}\SpecialCharTok{::}\FunctionTok{rcond}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.04
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{kappa}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 21.85714
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Matrix}\SpecialCharTok{::}\FunctionTok{rcond}\NormalTok{(Matrix}\SpecialCharTok{::}\FunctionTok{Hilbert}\NormalTok{(}\DecValTok{6}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.439939e-08
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Matrix}\SpecialCharTok{::}\FunctionTok{rcond}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.04
\end{verbatim}

\hypertarget{subsec-matrix-inverse}{%
\section{矩阵求逆}\label{subsec-matrix-inverse}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{solve}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]   -3    2
## [2,]    2   -1
\end{verbatim}

应用之线性方程组

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{B }\OtherTok{\textless{}{-}} \FunctionTok{Hilbert}\NormalTok{(}\DecValTok{6}\NormalTok{)}
\NormalTok{b }\OtherTok{\textless{}{-}} \FunctionTok{rowSums}\NormalTok{(B)}
\CommentTok{\# not inv}
\FunctionTok{solve}\NormalTok{(B,b) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 6 x 1 Matrix of class "dgeMatrix"
##      [,1]
## [1,]    1
## [2,]    1
## [3,]    1
## [4,]    1
## [5,]    1
## [6,]    1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# inv}
\FunctionTok{solve}\NormalTok{(B) }\SpecialCharTok{\%*\%}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 6 x 1 Matrix of class "dgeMatrix"
##      [,1]
## [1,]    1
## [2,]    1
## [3,]    1
## [4,]    1
## [5,]    1
## [6,]    1
\end{verbatim}

Moore-Penrose generalized inverse 广义逆，如果 A 可逆则，广义逆就是逆

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(MASS) }\CommentTok{\# ginv 来自 MASS 包}
\FunctionTok{ginv}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]   -3    2
## [2,]    2   -1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{\%*\%} \FunctionTok{ginv}\NormalTok{(A) }\SpecialCharTok{\%*\%}\NormalTok{ A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    2
## [2,]    2    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ginv}\NormalTok{(A) }\SpecialCharTok{\%*\%}\NormalTok{ A }\SpecialCharTok{\%*\%} \FunctionTok{ginv}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]   -3    2
## [2,]    2   -1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t}\NormalTok{(A }\SpecialCharTok{\%*\%} \FunctionTok{ginv}\NormalTok{(A))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               [,1]         [,2]
## [1,]  1.000000e+00 8.881784e-16
## [2,] -8.881784e-16 1.000000e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\SpecialCharTok{\%*\%} \FunctionTok{ginv}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              [,1]          [,2]
## [1,] 1.000000e+00 -8.881784e-16
## [2,] 8.881784e-16  1.000000e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t}\NormalTok{(}\FunctionTok{ginv}\NormalTok{(A) }\SpecialCharTok{\%*\%}\NormalTok{ A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              [,1]          [,2]
## [1,] 1.000000e+00 -8.881784e-16
## [2,] 8.881784e-16  1.000000e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ginv}\NormalTok{(A) }\SpecialCharTok{\%*\%}\NormalTok{ A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               [,1]         [,2]
## [1,]  1.000000e+00 8.881784e-16
## [2,] -8.881784e-16 1.000000e+00
\end{verbatim}

\hypertarget{subsec-matrix-adjoint}{%
\section{矩阵伴随}\label{subsec-matrix-adjoint}}

伴随矩阵 \(A*A^{\star} = A^{\star} *A = |A|*I, A^{\star} = |A|*A^{-1}\)

\begin{itemize}
\tightlist
\item
  \(|A^{\star}| = |A|^{n-1}, A \in \mathbb{R}^{n\times n},n \geq 2\)
\item
  \((A^{\star})^{\star} = |A|^{n-2}A, A \in \mathbb{R}^{n\times n},n \geq 2\)
\item
  \((A^{\star})^{\star}\) A 的 n 次伴随是？
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{det}\NormalTok{(A)}\SpecialCharTok{*}\FunctionTok{solve}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    3   -2
## [2,]   -2    1
\end{verbatim}

\hypertarget{subsec-matrix-norm}{%
\section{矩阵范数}\label{subsec-matrix-norm}}

向量和矩阵的范数，包括1，2，无穷范数，其他操作看 Matrix 包，尤其关于稀疏矩阵计算部分

\begin{description}
\tightlist
\item[\(1\)-范数]
列和绝对值最大的
\item[\(\infty\) - 范数]
行和绝对值最大的
\item[Frobenius - 范数]
Euclidean 范数
\item[\(M\) - 范数]
矩阵里模最大的元素，矩阵里面的元素可能含有复数，所以取模最大
\item[\(2\) - 范数]
又称谱范数，矩阵最大的奇异值，如果是方阵，就是最大的特征值
\end{description}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{norm}\NormalTok{(A, }\AttributeTok{type =} \StringTok{"1"}\NormalTok{) }\CommentTok{\# max(abs(colSums(A)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{norm}\NormalTok{(A, }\AttributeTok{type =} \StringTok{"I"}\NormalTok{) }\CommentTok{\# max(abs(rowSums(A)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{norm}\NormalTok{(A, }\AttributeTok{type =} \StringTok{"F"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4.242641
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{norm}\NormalTok{(A, }\AttributeTok{type =} \StringTok{"M"}\NormalTok{) }\CommentTok{\#}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{norm}\NormalTok{(A, }\AttributeTok{type =} \StringTok{"2"}\NormalTok{) }\CommentTok{\# max(svd(A)$d)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4.236068
\end{verbatim}

显然，\(1-,\infty-,M-\) 的范数计算比 \(F-\) 范数快，函数 \texttt{norm} 默认情况下求 \(1-\) 范数

\hypertarget{subsec-matrix-rank}{%
\section{矩阵求秩}\label{subsec-matrix-rank}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qr}\NormalTok{(A)}\SpecialCharTok{$}\NormalTok{rank }\CommentTok{\# or qr.default(A)$rank}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\hypertarget{subsec-matrix-trace}{%
\section{矩阵求迹}\label{subsec-matrix-trace}}

若

\[
A = \begin{bmatrix}
 a_{11} & a_{12}  & a_{13} \\ 
 a_{21} & a_{22}  & a_{23} \\ 
 a_{31} & a_{32}  & a_{33} 
\end{bmatrix}
\]

则矩阵 \(A\) 的迹 \(\operatorname{tr}(A) = \sum_{i=1}^{n}a_{ii}\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sum}\NormalTok{(}\FunctionTok{diag}\NormalTok{(A))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4
\end{verbatim}

特殊矩阵的构造

\hypertarget{subsec-identity-matrix}{%
\section{单位矩阵}\label{subsec-identity-matrix}}

矩阵对角线上全是1，其余位置都是0

\[
A = \begin{bmatrix}
 1 & 0  & 0 \\ 
 0 & 1  & 0 \\ 
 0 & 0  & 1 
\end{bmatrix}
\]

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2] [,3]
## [1,]    1    0    0
## [2,]    0    1    0
## [3,]    0    0    1
\end{verbatim}

而全1矩阵是所有元素都是1的矩阵，可以借助外积运算构造，如3阶全1矩阵

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{) }\SpecialCharTok{\%o\%} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2] [,3]
## [1,]    1    1    1
## [2,]    1    1    1
## [3,]    1    1    1
\end{verbatim}

\hypertarget{subsec-matrix-diagonals}{%
\section{对角矩阵}\label{subsec-matrix-diagonals}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{diag}\NormalTok{(A)       }\CommentTok{\# diagonal of a matrix}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{diag}\NormalTok{(}\FunctionTok{diag}\NormalTok{(A)) }\CommentTok{\# construct a diagonal matrix}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    0
## [2,]    0    3
\end{verbatim}

\hypertarget{subsec-upper-matrix}{%
\section{上/下三角矩阵}\label{subsec-upper-matrix}}

矩阵下三角

row 和 col

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{row}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    1
## [2,]    2    2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{col}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    2
## [2,]    1    2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A[}\FunctionTok{row}\NormalTok{(A)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{upper.tri}\NormalTok{(A) }\CommentTok{\# 矩阵上三角}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       [,1]  [,2]
## [1,] FALSE  TRUE
## [2,] FALSE FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A[}\FunctionTok{upper.tri}\NormalTok{(A)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A[}\FunctionTok{lower.tri}\NormalTok{(A)] }\OtherTok{\textless{}{-}} \DecValTok{0} \CommentTok{\# 获得上三角矩阵}
\NormalTok{A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    2
## [2,]    0    3
\end{verbatim}

\begin{itemize}
\tightlist
\item
  下三角矩阵
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{)}
\NormalTok{A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    2
## [2,]    2    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lower.tri}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       [,1]  [,2]
## [1,] FALSE FALSE
## [2,]  TRUE FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A[}\FunctionTok{lower.tri}\NormalTok{(A)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A[}\FunctionTok{upper.tri}\NormalTok{(A)] }\OtherTok{\textless{}{-}} \DecValTok{0} \CommentTok{\# 获得下三角矩阵}
\NormalTok{A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    0
## [2,]    2    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{A }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{)}
\NormalTok{A[}\FunctionTok{row}\NormalTok{(A) }\SpecialCharTok{\textless{}} \FunctionTok{col}\NormalTok{(A)] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{A}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    0
## [2,]    2    3
\end{verbatim}

\hypertarget{subsec-sparse-matrix}{%
\section{稀疏矩阵}\label{subsec-sparse-matrix}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dn }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(LETTERS[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{])}
\DocumentationTok{\#\# pointer vectors can be used, and the (i,x) slots are sorted if necessary:}
\DocumentationTok{\#\# 使用指针构造}
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{sparseMatrix}\NormalTok{(}\AttributeTok{i =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{, }\DecValTok{3}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{1}\NormalTok{), }\AttributeTok{p=} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{), }\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\AttributeTok{dimnames =}\NormalTok{ dn)}
\NormalTok{m}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 3 x 5 sparse Matrix of class "dgCMatrix"
##   a b c d e
## A . 2 . . 6
## B . . 4 . 5
## C 1 . 3 . .
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 典型构造方式}
\NormalTok{i }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\SpecialCharTok{:}\DecValTok{8}\NormalTok{); j }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{9}\NormalTok{,}\DecValTok{6}\SpecialCharTok{:}\DecValTok{10}\NormalTok{); x }\OtherTok{\textless{}{-}} \DecValTok{7} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1}\SpecialCharTok{:}\DecValTok{7}\NormalTok{)}
\NormalTok{(AA }\OtherTok{\textless{}{-}} \FunctionTok{sparseMatrix}\NormalTok{(i, j, }\AttributeTok{x =}\NormalTok{ x))                    }\DocumentationTok{\#\#  8 x 10 "dgCMatrix"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 8 x 10 sparse Matrix of class "dgCMatrix"
##                              
## [1,] . 7 . . .  .  .  .  .  .
## [2,] . . . . .  .  .  .  .  .
## [3,] . . . . .  .  .  . 14  .
## [4,] . . . . . 21  .  .  .  .
## [5,] . . . . .  . 28  .  .  .
## [6,] . . . . .  .  . 35  .  .
## [7,] . . . . .  .  .  . 42  .
## [8,] . . . . .  .  .  .  . 49
\end{verbatim}

\hypertarget{subsec-triangular-matrix}{%
\section{三对角矩阵}\label{subsec-triangular-matrix}}

\hypertarget{subsec-lu-decomposition}{%
\section{LU 分解}\label{subsec-lu-decomposition}}

\hypertarget{subsec-schur-decomposition}{%
\section{Schur 分解}\label{subsec-schur-decomposition}}

\hypertarget{subsec-choleski-decomposition}{%
\section{Cholesky 分解}\label{subsec-choleski-decomposition}}

实对称正定矩阵的 Choleski 分解

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{chol}\NormalTok{(A }\SpecialCharTok{+} \FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          [,1] [,2]
## [1,] 1.414214    0
## [2,] 0.000000    2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Inverse from Choleski (or QR) Decomposition}
\NormalTok{Matrix}\SpecialCharTok{::}\FunctionTok{chol2inv}\NormalTok{(A }\SpecialCharTok{+} \FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]   [,2]
## [1,] 0.25 0.0000
## [2,] 0.00 0.0625
\end{verbatim}

\texttt{Matrix::Cholesky} 实现稀疏 Cholesky 分解

\hypertarget{subsec-eigenvalues-decomposition}{%
\section{特征值分解}\label{subsec-eigenvalues-decomposition}}

特征值分解（Eigenvalues Decomposition）也叫谱分解（Spectral Decomposition）

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{eigen}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## eigen() decomposition
## $values
## [1] 3 1
## 
## $vectors
##      [,1]       [,2]
## [1,]    0  0.7071068
## [2,]    1 -0.7071068
\end{verbatim}

\hypertarget{subsec-Singular-Value-Decomposition}{%
\section{SVD 分解}\label{subsec-Singular-Value-Decomposition}}

\href{https://github.com/bwlewis/irlba}{Fast truncated singular value decompositions} 奇异值分解是特征值分解的推广

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{svd}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $d
## [1] 3.6502815 0.8218544
## 
## $u
##            [,1]       [,2]
## [1,] -0.1601822 -0.9870875
## [2,] -0.9870875  0.1601822
## 
## $v
##            [,1]       [,2]
## [1,] -0.5847103 -0.8112422
## [2,] -0.8112422  0.5847103
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{svd}\NormalTok{(A)}\SpecialCharTok{$}\NormalTok{d}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.6502815 0.8218544
\end{verbatim}

邱怡轩将奇异值分解用于图像压缩 \url{https://cosx.org/2014/02/svd-and-image-compression} 并制作了 \href{https://yihui.shinyapps.io/imgsvd/}{Shiny App} 交互式演示

\hypertarget{subsec-QR-Decomposition}{%
\section{QR 分解}\label{subsec-QR-Decomposition}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qr.default}\NormalTok{(A)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $qr
##            [,1]      [,2]
## [1,] -2.2360680 -2.683282
## [2,]  0.8944272  1.341641
## 
## $rank
## [1] 2
## 
## $qraux
## [1] 1.447214 1.341641
## 
## $pivot
## [1] 1 2
## 
## attr(,"class")
## [1] "qr"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qr.X}\NormalTok{(}\FunctionTok{qr.default}\NormalTok{(A))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2]
## [1,]    1    0
## [2,]    2    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qr.Q}\NormalTok{(}\FunctionTok{qr.default}\NormalTok{(A))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            [,1]       [,2]
## [1,] -0.4472136 -0.8944272
## [2,] -0.8944272  0.4472136
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qr.R}\NormalTok{(}\FunctionTok{qr.default}\NormalTok{(A))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           [,1]      [,2]
## [1,] -2.236068 -2.683282
## [2,]  0.000000  1.341641
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qr.Q}\NormalTok{(}\FunctionTok{qr.default}\NormalTok{(A)) }\SpecialCharTok{\%*\%} \FunctionTok{qr.R}\NormalTok{(}\FunctionTok{qr.default}\NormalTok{(A))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]          [,2]
## [1,]    1 -2.220446e-16
## [2,]    2  3.000000e+00
\end{verbatim}

用 \href{https://www.wikiwand.com/en/Householder_transformation}{Householder 变换} 做 QR 分解 \citep{Bates_1988_Nonlinear} 及其 R 语言实现 \url{https://rpubs.com/aaronsc32/qr-decomposition-householder}

Householder 变换是平面反射的一般情况： 要计算 \(N\times P\) 维矩阵 \(X\) 的 QR 分解，我们采用 Householder 变换

\[
\mathbf{H}_{u} = \mathbf{I} -2\mathbf{u}\mathbf{u}^{\top}
\]

其中 \(I\) 是 \(N\times N\) 维的单位矩阵，\(u\) 是 \(N\) 维单位向量，即 \(\| \mathbf{u}\| = \sqrt{\mathbf{u}\mathbf{u}^{\top}} = 1\)。则 \(H_u\) 是对称正交的，因为

\[
\mathbf{H}_{u}^{\top} = \mathbf{I}^{\top} - 2\mathbf{u}\mathbf{u}^{\top} = \mathbf{H}_{u}
\]

并且

\[
\mathbf{H}_{u}^{\top}\mathbf{H}_{u} =  \mathbf{I} -4\mathbf{u}\mathbf{u}^{\top} + 4\mathbf{u}\mathbf{u}^{\top}\mathbf{u}\mathbf{u}^{\top} = \mathbf{I}
\]

让 \(\mathbf{H}_{u}\) 乘以向量 \(\mathbf{y}\)，即

\[
\mathbf{H}_{u}\mathbf{y} = \mathbf{y} - 2\mathbf{u}\mathbf{u}^{\top}\mathbf{y}
\]

它是 \(y\) 关于垂直于过原点的 \(u\) 的直线的反射，只要

\begin{equation}
\mathbf{u} = \frac{\mathbf{y} - \| \mathbf{y} \|\mathbf{e}_{1}}{\| \mathbf{y} - \| \mathbf{y} \|\mathbf{e}_{1}\|} \label{eq:householder-negative}
\end{equation}

或者

\begin{equation}
\mathbf{u} = \frac{\mathbf{y} + \| \mathbf{y} \|\mathbf{e}_{1}}{\| \mathbf{y} + \| \mathbf{y} \|\mathbf{e}_{1}\|} \label{eq:householder-positive}
\end{equation}

其中 \(\mathbf{e}_{1} = (1,0,\ldots,0)^{\top}\)，Householder 变换使得向量 \(y\) 成为 \(x\) 轴，在新的坐标系统中，向量 \(H_{u}y\) 的坐标为 \((\pm\|y\|, 0, \ldots, 0)^\top\)

举个例子

借助 Householder 变换做 QR 分解的优势：

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  更快、数值更稳定比直接构造 Q，特别当 N 大于 P 的时候
\item
  相比于存储矩阵 Q 的 \(N^2\) 个元素，Householder 变换只存储 P 个向量 \(u_1,\ldots,u_P\)
\item
  QR 分解的真实实现，比如在 LINPACK 中，定义 \(u\) 的时候，公式 \eqref{eq:householder-negative} 或 \eqref{eq:householder-positive} 的选择基于\(y\)的第一个坐标的符号。如果坐标是负的，使用公式\eqref{eq:householder-negative}，如果是正的，使用公式 \eqref{eq:householder-positive}， 这个做法可以使得数值计算更加稳定。
\end{enumerate}

Stan 实现的 QR 分解在贝叶斯线性回归模型中的应用\footnote{\url{https://mc-stan.org/users/documentation/case-studies/qr_regression.html}}

\hypertarget{subsec-jordan-Decomposition}{%
\section{Jordan 分解}\label{subsec-jordan-Decomposition}}

\hypertarget{subsec-Givens-Rotation}{%
\section{Givens 旋转}\label{subsec-Givens-Rotation}}

\begin{itemize}
\item
  Givens 旋转 \url{https://www.wikiwand.com/en/Givens_rotation}
\item
  帽子矩阵在统计中的应用 回归与方差分析 \citep{David_1978_Hat}
\end{itemize}

\hypertarget{sec-special-functions}{%
\section{特殊函数}\label{sec-special-functions}}

\hypertarget{factorial}{%
\subsection{阶乘}\label{factorial}}

\begin{itemize}
\tightlist
\item
  阶乘 \(n! = 1\times 2\times 3\cdots n\)
\item
  双阶乘 \((2n+1)!! = 1 \times 3\times 5 \times \cdots \times (2n+1), n = 0,1,2,\cdots\)
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{factorial}\NormalTok{(}\DecValTok{5}\NormalTok{) }\CommentTok{\# 阶乘}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 120
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{1}\NormalTok{, }\AttributeTok{to =} \DecValTok{5}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prod}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{1}\NormalTok{, }\AttributeTok{to =} \DecValTok{5}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{3}\NormalTok{)) }\CommentTok{\# 连乘 双阶乘}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 15
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2 3 4 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cumprod}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{5}\NormalTok{)) }\CommentTok{\# 累积}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]   1   2   6  24 120
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cumsum}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{5}\NormalTok{)) }\CommentTok{\# 累和}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  1  3  6 10 15
\end{verbatim}

此外还有 \texttt{cummax} 和 \texttt{cummin}

\begin{itemize}
\tightlist
\item
  组合数 \(C_{n}^{k} = \frac{n(n-1)…(n-k+1)}{k!}\)
\end{itemize}

\(C_{5}^{3} = \frac{5 \times 4 \times 3}{3 \times 2 \times 1}\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{choose}\NormalTok{(}\DecValTok{5}\NormalTok{,}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10
\end{verbatim}

\begin{quote}
斯特林公式
\end{quote}

\hypertarget{gamma}{%
\subsection{伽马函数}\label{gamma}}

\(\Gamma(x) = \int_{0}^{\infty} t^{x-1}\exp(-t)dt\) \(\Gamma(n) = (n-1)!, n \in \mathbb{Z}^{+}\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gamma}\NormalTok{(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gamma}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 362880
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gamma2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t,x)\{}
\NormalTok{  t}\SpecialCharTok{\^{}}\NormalTok{(x}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{*}\FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{t)}
\NormalTok{\}}
\FunctionTok{integrate}\NormalTok{(gamma2, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =} \SpecialCharTok{+} \ConstantTok{Inf}\NormalTok{, }\AttributeTok{x =} \DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 362880 with absolute error < 0.025
\end{verbatim}

\begin{itemize}
\tightlist
\item
  psigamma(x, deriv) 表示 \(\psi(x)\) 的 \texttt{deriv} 阶导数
\end{itemize}

\(\mathrm{digamma}(x) \triangleq \psi(x) = \frac{d}{dx}{\ln \Gamma(x)} = \Gamma'(x) / \Gamma(x)\)

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 例1}
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{2}
\FunctionTok{eval}\NormalTok{(}\FunctionTok{deriv}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{gamma}\NormalTok{(x), }\StringTok{"x"}\NormalTok{))}\SpecialCharTok{/}\FunctionTok{gamma}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
## attr(,"gradient")
##              x
## [1,] 0.4227843
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 与此等价}
\FunctionTok{psigamma}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.4227843
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{digamma}\NormalTok{(x) }\CommentTok{\# psi(x) 的一阶导数}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.4227843
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trigamma}\NormalTok{(x) }\CommentTok{\# psi(x) 的二阶导数}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.6449341
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 例2}
\FunctionTok{eval}\NormalTok{(}\FunctionTok{deriv}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{psigamma}\NormalTok{(x, }\DecValTok{1}\NormalTok{), }\StringTok{"x"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.6449341
## attr(,"gradient")
##               x
## [1,] -0.4041138
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 与此等价}
\FunctionTok{psigamma}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.4041138
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 注意与下面这个例子比较}
\NormalTok{dx2x }\OtherTok{\textless{}{-}} \FunctionTok{deriv}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{, }\StringTok{"x"}\NormalTok{)}
\FunctionTok{eval}\NormalTok{(dx2x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 8
## attr(,"gradient")
##       x
## [1,] 12
\end{verbatim}

\hypertarget{beta}{%
\subsection{贝塔函数}\label{beta}}

\(B(a,b) = \Gamma(a)\Gamma(b)/\Gamma(a+b) = \int_{0}^{1} t^{a-1} (1-t)^{b-1} dt\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{beta}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{beta}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.08333333
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t, a, b) \{}
\NormalTok{  t}\SpecialCharTok{\^{}}\NormalTok{(a }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ t)}\SpecialCharTok{\^{}}\NormalTok{(b }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{integrate}\NormalTok{(beta2, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =} \DecValTok{1}\NormalTok{, }\AttributeTok{a =} \DecValTok{2}\NormalTok{, }\AttributeTok{b =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 0.08333333 with absolute error < 9.3e-16
\end{verbatim}

\hypertarget{bessel}{%
\subsection{贝塞尔函数}\label{bessel}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{besselI}\NormalTok{(x, nu, }\AttributeTok{expon.scaled =} \ConstantTok{FALSE}\NormalTok{) }\CommentTok{\# 修正的第一类}
\FunctionTok{besselK}\NormalTok{(x, nu, }\AttributeTok{expon.scaled =} \ConstantTok{FALSE}\NormalTok{) }\CommentTok{\# 修正的第二类}
\FunctionTok{besselJ}\NormalTok{(x, nu) }\CommentTok{\# 第一类}
\FunctionTok{besselY}\NormalTok{(x, nu) }\CommentTok{\# 第二类}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  \(\nu\) 贝塞尔函数的阶，可以是分数
\item
  expon.scaled 是否使用指数表示
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nus }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{501}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, x,}
  \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{6}\NormalTok{), }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"Bessel Functions  I\_nu(x)"}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (nu }\ControlFlowTok{in}\NormalTok{ nus) }\FunctionTok{lines}\NormalTok{(x, }\FunctionTok{besselI}\NormalTok{(x, }\AttributeTok{nu =}\NormalTok{ nu), }\AttributeTok{col =}\NormalTok{ nu }\SpecialCharTok{+} \DecValTok{2}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{6}\NormalTok{, }\AttributeTok{legend =} \FunctionTok{paste}\NormalTok{(}\StringTok{"nu="}\NormalTok{, nus), }\AttributeTok{col =}\NormalTok{ nus }\SpecialCharTok{+} \DecValTok{2}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{matrix-operations_files/figure-latex/modified-bessel-1} \end{center}

介绍复数矩阵的计算，矩阵的指数计算，介绍一点分形

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 考虑用 gganimate 实现，去掉 caTools 依赖}
\FunctionTok{library}\NormalTok{(caTools)}
\NormalTok{jet.colors }\OtherTok{\textless{}{-}} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
  \StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{, }\StringTok{"cyan"}\NormalTok{, }\StringTok{"\#7FFF7F"}\NormalTok{,}
  \StringTok{"yellow"}\NormalTok{, }\StringTok{"\#FF7F00"}\NormalTok{, }\StringTok{"red"}\NormalTok{, }\StringTok{"\#7F0000"}
\NormalTok{))}
\NormalTok{m }\OtherTok{\textless{}{-}} \DecValTok{1000} \CommentTok{\# define size}
\NormalTok{C }\OtherTok{\textless{}{-}} \FunctionTok{complex}\NormalTok{(}
  \AttributeTok{real =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.8}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\AttributeTok{length.out =}\NormalTok{ m), }\AttributeTok{each =}\NormalTok{ m),}
  \AttributeTok{imag =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\AttributeTok{length.out =}\NormalTok{ m), m)}
\NormalTok{)}
\NormalTok{C }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(C, m, m) }\CommentTok{\# reshape as square matrix of complex numbers}
\NormalTok{Z }\OtherTok{\textless{}{-}} \DecValTok{0} \CommentTok{\# initialize Z to zero}
\NormalTok{X }\OtherTok{\textless{}{-}} \FunctionTok{array}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{c}\NormalTok{(m, m, }\DecValTok{20}\NormalTok{)) }\CommentTok{\# initialize output 3D array}
\ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{) \{ }\CommentTok{\# loop with 20 iterations}
\NormalTok{  Z }\OtherTok{\textless{}{-}}\NormalTok{ Z}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ C }\CommentTok{\# the central difference equation}
\NormalTok{  X[, , k] }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{abs}\NormalTok{(Z)) }\CommentTok{\# capture results}
\NormalTok{\}}
\FunctionTok{write.gif}\NormalTok{(X, }\StringTok{"Mandelbrot.gif"}\NormalTok{, }\AttributeTok{col =}\NormalTok{ jet.colors, }\AttributeTok{delay =} \DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{chap-symbolic-computation}{%
\chapter{符号计算}\label{chap-symbolic-computation}}

相比于数值计算，符号计算可以无限精度，包括微分、积分运法，求解线性、非线性方程（组），常微分、偏微分方程（组）等，R 自带几个函数如 \texttt{deriv()}、\texttt{D()} 等可以做一些简单的微分运算，扩展包 \href{https://github.com/r-cas/ryacas}{Ryacas} 提供 \href{https://github.com/grzegorzmazur/yacas/}{Yacas} 核心计算引擎，\href{https://github.com/symengine/symengine.R}{symengine} 引入 C++ 符号计算库\href{https://github.com/symengine/}{SymEngine}，相比于 \textbf{Ryacas}\citep{Ryacas}，\textbf{symengine} 不会和 Base R 函数冲突。Python 的符号计算模块 \href{https://github.com/sympy/sympy}{sympy} \citep{SymPy} 不仅支持简单的四则运算，还支持微分、积分、解方程等，详见官方文档 \url{https://sympy.org/}。

16年在统计之都灌水\href{https://cosx.org/2016/07/r-symbol-calculate}{符号计算与R语言}，相应的 Rmd 源文件放在\href{https://github.com/XiangyunHuang/Symbolic-Computing}{Github}上。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 多元函数求偏导}
\NormalTok{ft }\OtherTok{\textless{}{-}} \FunctionTok{deriv}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{sin}\NormalTok{(x1) }\SpecialCharTok{+} \FunctionTok{sin}\NormalTok{(x2) }\SpecialCharTok{+} \FunctionTok{cos}\NormalTok{(}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ x1 }\SpecialCharTok{*}\NormalTok{ x2) }\SpecialCharTok{+}\NormalTok{ x1}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x2}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{),}
  \AttributeTok{namevec =} \FunctionTok{c}\NormalTok{(}\StringTok{"x1"}\NormalTok{, }\StringTok{"x2"}\NormalTok{), }\AttributeTok{function.arg =} \ConstantTok{TRUE}
\NormalTok{)}
\CommentTok{\# 隐函数求偏导}
\FunctionTok{deriv}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{sin}\NormalTok{(}\FunctionTok{cos}\NormalTok{(x) }\SpecialCharTok{*}\NormalTok{ y), }\AttributeTok{namevec =} \FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{,}\StringTok{"y"}\NormalTok{), }\AttributeTok{function.arg =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (x, y) 
## {
##     .expr1 <- cos(x)
##     .expr2 <- .expr1 * y
##     .expr4 <- cos(.expr2)
##     .value <- sin(.expr2)
##     .grad <- array(0, c(length(.value), 2L), list(NULL, c("x", 
##         "y")))
##     .grad[, "x"] <- -(.expr4 * (sin(x) * y))
##     .grad[, "y"] <- .expr4 * .expr1
##     attr(.value, "gradient") <- .grad
##     .value
## }
\end{verbatim}

下面以标准正态分布的密度函数为例，

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{NormDensity }\OtherTok{\textless{}{-}} \FunctionTok{expression}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{/} \DecValTok{2}\NormalTok{))}
\CommentTok{\# 递归的方法求高阶倒数}
\NormalTok{DD }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(expr, name, }\AttributeTok{order =} \DecValTok{1}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (order }\SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"\textquotesingle{}order\textquotesingle{} must be \textgreater{}= 1"}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (order }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{D}\NormalTok{(expr, name)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{DD}\NormalTok{(}\FunctionTok{D}\NormalTok{(expr, name), name, order }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}
\CommentTok{\# 计算三阶导数}
\FunctionTok{DD}\NormalTok{(NormDensity, }\StringTok{"x"}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 1/sqrt(2 * pi) * (exp(-x^2/2) * (2 * x/2) * (2/2) + ((exp(-x^2/2) * 
##     (2/2) - exp(-x^2/2) * (2 * x/2) * (2 * x/2)) * (2 * x/2) + 
##     exp(-x^2/2) * (2 * x/2) * (2/2)))
\end{verbatim}

Deriv 可以将 R 表达式简化

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Deriv)}
\FunctionTok{Simplify}\NormalTok{(}\FunctionTok{DD}\NormalTok{(NormDensity, }\StringTok{"x"}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## x * (3 - x^2) * exp(-(x^2/2))/sqrt(2 * pi)
\end{verbatim}

即 \(x (3 - x^2) \mathrm{e}^{-x^2/2}/\sqrt{2 \pi}\)，\texttt{eval()} 将表达式转为函数，代入数值运算。

\[\tau(x) = \frac{(-1)^{j-1}}{\sqrt{j!}}\phi^{(j)}(x)\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Tetrachoric }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, j) \{}
\NormalTok{  (}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{(j }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{factorial}\NormalTok{(j)) }\SpecialCharTok{*} \FunctionTok{eval}\NormalTok{(}\FunctionTok{DD}\NormalTok{(NormDensity, }\StringTok{"x"}\NormalTok{, j))}
\NormalTok{\}}
\FunctionTok{Tetrachoric}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.04408344
\end{verbatim}

\begin{figure}

{\centering \includegraphics{symbolic-computation_files/figure-latex/Tetrachoric-1} 

}

\caption{Tetrachoric 函数}\label{fig:Tetrachoric}
\end{figure}

表达式转函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ExpToFun}\OtherTok{\textless{}{-}}\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{eval}\NormalTok{(}\FunctionTok{Simplify}\NormalTok{(}\FunctionTok{DD}\NormalTok{(NormDensity, }\StringTok{"x"}\NormalTok{, }\DecValTok{4}\NormalTok{)))}
\FunctionTok{ExpToFun}\NormalTok{(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.2699548
\end{verbatim}

函数求积分

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{integrate}\NormalTok{(ExpToFun, }\DecValTok{0}\NormalTok{, pi)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## -0.06192048 with absolute error < 5.8e-12
\end{verbatim}

对函数求微分

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) x }\SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(x)}
\CommentTok{\# D(body(fun),\textquotesingle{}x\textquotesingle{})}
\FunctionTok{Simplify}\NormalTok{(}\FunctionTok{D}\NormalTok{(}\FunctionTok{body}\NormalTok{(fun), }\StringTok{"x"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 0.5 * pi/sqrt(x)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Dfun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{\}}
\FunctionTok{body}\NormalTok{(Dfun) }\OtherTok{\textless{}{-}} \FunctionTok{Simplify}\NormalTok{(}\FunctionTok{D}\NormalTok{(}\FunctionTok{body}\NormalTok{(fun), }\StringTok{"x"}\NormalTok{))}
\NormalTok{Dfun}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (x) 
## 0.5 * pi/sqrt(x)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Dfun}\NormalTok{(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.7853982
\end{verbatim}

下面简单介绍 symengine 的符号计算能力

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(symengine)}
\CommentTok{\# 声明几个符号变量}
\FunctionTok{use\_vars}\NormalTok{(x, y, z)}
\CommentTok{\# 表达式展开}
\NormalTok{expr }\OtherTok{\textless{}{-}}\NormalTok{ (x }\SpecialCharTok{+}\NormalTok{ y }\SpecialCharTok{+}\NormalTok{ z) }\SpecialCharTok{\^{}}\NormalTok{ 2L }\SpecialCharTok{{-}}\NormalTok{ 42L}
\FunctionTok{expand}\NormalTok{(expr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (Add)    -42 + 2*x*y + 2*x*z + 2*y*z + x^2 + y^2 + z^2
\end{verbatim}

变量替换

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OtherTok{\textless{}{-}} \FunctionTok{S}\NormalTok{(}\StringTok{"a"}\NormalTok{)}
\CommentTok{\# z 用 a 替换}
\NormalTok{expr }\OtherTok{\textless{}{-}} \FunctionTok{subs}\NormalTok{(expr, z, a)}
\CommentTok{\# y 用 x\^{}2 替换}
\NormalTok{expr }\OtherTok{\textless{}{-}} \FunctionTok{subs}\NormalTok{(expr, y, x}\SpecialCharTok{\^{}}\NormalTok{2L)}
\NormalTok{expr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (Add)    -42 + (a + x + x^2)^2
\end{verbatim}

表达式求 2 阶偏导

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1\_expr }\OtherTok{\textless{}{-}} \FunctionTok{DD}\NormalTok{(expr, }\StringTok{"x"}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\FunctionTok{expand}\NormalTok{(d1\_expr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (Add)    2 + 4*a + 12*x + 12*x^2
\end{verbatim}

求解带参数 \(a\) 的一元二次方程

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{solutions }\OtherTok{\textless{}{-}} \FunctionTok{solve}\NormalTok{(d1\_expr, }\StringTok{"x"}\NormalTok{)}
\NormalTok{solutions}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## VecBasic of length 2
## V( -1/2 + (-1/2)*sqrt(1 + (-1/3)*(2 + 4*a)), -1/2 + (1/2)*sqrt(1 + (-1/3)*(2 + 4*a)) )
\end{verbatim}

\hypertarget{chap-mixed-programming}{%
\chapter{混合编程}\label{chap-mixed-programming}}

R 语言 \citep{Ross_1996_R} 是一个统计计算和绘图的环境，以下各个节不介绍具体 R 包函数用法和参数设置，重点在历史发展趋势脉络，详细介绍去见\href{https://bookdown.org/xiangyun/msg}{《现代统计图形》}的相应章节。R 语言的目标在于统计计算和绘图，设计优势在数据结构、图形语法、动态文档和交互图形

\hypertarget{sec-function-source}{%
\section{函数源码}\label{sec-function-source}}

\href{https://github.com/moodymudskipper/funflow}{funflow} 包可以将函数调用的过程以流程图的方式呈现，代码结构一目了然，快速理清源代码

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{remotes}\SpecialCharTok{::}\FunctionTok{install\_github}\NormalTok{(}\StringTok{\textquotesingle{}moodymudskipper/funflow\textquotesingle{}}\NormalTok{)}
\NormalTok{funflow}\SpecialCharTok{::}\FunctionTok{view\_flow}\NormalTok{(}\StringTok{\textquotesingle{}median.default\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{methods}\NormalTok{(predict)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] predict.ar*                predict.Arima*            
##  [3] predict.arima0*            predict.glm               
##  [5] predict.HoltWinters*       predict.lm                
##  [7] predict.loess*             predict.mlm*              
##  [9] predict.nls*               predict.poly*             
## [11] predict.ppr*               predict.prcomp*           
## [13] predict.princomp*          predict.smooth.spline*    
## [15] predict.smooth.spline.fit* predict.StructTS*         
## see '?methods' for accessing help and source code
\end{verbatim}

stats 包里找不到这个函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:stats"}\NormalTok{, }\AttributeTok{all.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"predict.poly"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## character(0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{predict.poly}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in eval(expr, envir, enclos): object 'predict.poly' not found
\end{verbatim}

可见函数 \texttt{predict.poly()} 默认没有导出

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stats}\SpecialCharTok{:::}\NormalTok{predict.poly}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (object, newdata, ...) 
## {
##     if (missing(newdata)) 
##         object
##     else if (is.null(attr(object, "coefs"))) 
##         poly(newdata, degree = max(attr(object, "degree")), raw = TRUE, 
##             simple = TRUE)
##     else poly(newdata, degree = max(attr(object, "degree")), 
##         coefs = attr(object, "coefs"), simple = TRUE)
## }
## <bytecode: 0x55da9fe55e58>
## <environment: namespace:stats>
\end{verbatim}

或者

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{getAnywhere}\NormalTok{(predict.poly)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## A single object matching 'predict.poly' was found
## It was found in the following places
##   registered S3 method for predict from namespace stats
##   namespace:stats
## with value
## 
## function (object, newdata, ...) 
## {
##     if (missing(newdata)) 
##         object
##     else if (is.null(attr(object, "coefs"))) 
##         poly(newdata, degree = max(attr(object, "degree")), raw = TRUE, 
##             simple = TRUE)
##     else poly(newdata, degree = max(attr(object, "degree")), 
##         coefs = attr(object, "coefs"), simple = TRUE)
## }
## <bytecode: 0x55da9fe55e58>
## <environment: namespace:stats>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{getAnywhere}\NormalTok{(}\StringTok{"predict.poly"}\NormalTok{)}\SpecialCharTok{$}\NormalTok{where}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "registered S3 method for predict from namespace stats"
## [2] "namespace:stats"
\end{verbatim}

函数参数个数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(}\FunctionTok{formals}\NormalTok{(read.table))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "file"             "header"           "sep"              "quote"           
##  [5] "dec"              "numerals"         "row.names"        "col.names"       
##  [9] "as.is"            "na.strings"       "colClasses"       "nrows"           
## [13] "skip"             "check.names"      "fill"             "strip.white"     
## [17] "blank.lines.skip" "comment.char"     "allowEscapes"     "flush"           
## [21] "stringsAsFactors" "fileEncoding"     "encoding"         "text"            
## [25] "skipNul"
\end{verbatim}

\hypertarget{sec-naming-conventions}{%
\section{命名约定}\label{sec-naming-conventions}}

R 语言当前的命名状态 \url{https://journal.r-project.org/archive/2012-2/RJournal_2012-2_Baaaath.pdf} 和 \url{https://essentials.togaware.com/StyleO.pdf}

R 与不同的编程语言如何交互

\hypertarget{sec-r-javascripts}{%
\section{R 与 JavaScripts}\label{sec-r-javascripts}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(htmlwidgets)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-r-python}{%
\section{R 与 Python}\label{sec-r-python}}

R 包 knitr 和 reticulate 支持 R Markdown 文档中嵌入 Python 代码块， reticulate 包还支持 Python 和 R 之间的数据对象通信交流。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(reticulate)}
\end{Highlighting}
\end{Shaded}

如图 \ref{fig:reticulate-matplotlib} 所示，在 R Markdown 中执行 Python 绘图代码，并且将图形插入文档。

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\NormalTok{plt.switch\_backend(}\StringTok{\textquotesingle{}agg\textquotesingle{}}\NormalTok{)}

\NormalTok{plt.plot([}\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{])}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=.8\textwidth]{mixed-programming_files/figure-latex/reticulate-matplotlib-1} 

}

\caption{Python 图形}\label{fig:reticulate-matplotlib}
\end{figure}

\hypertarget{sec-r-c}{%
\section{R 与 C}\label{sec-r-c}}

knitr 支持在 R Markdown 中嵌入 C 语言代码

\begin{Shaded}
\begin{Highlighting}[]
\DataTypeTok{void}\NormalTok{ useC}\OperatorTok{(}\DataTypeTok{int} \OperatorTok{*}\NormalTok{i}\OperatorTok{)\{}
\NormalTok{  i}\OperatorTok{[}\DecValTok{0}\OperatorTok{]} \OperatorTok{=} \DecValTok{11}\OperatorTok{;}
\OperatorTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## make[1]: Entering directory '/home/runner/work/masr/masr'
## gcc -I"/opt/R/4.1.1/lib/R/include" -DNDEBUG   -I/usr/local/include   -fpic  -g -O2  -c ce2f157e03b95.c -o ce2f157e03b95.o
## gcc -shared -L/opt/R/4.1.1/lib/R/lib -L/usr/local/lib -o ce2f157e03b95.so ce2f157e03b95.o -L/opt/R/4.1.1/lib/R/lib -lR
## make[1]: Leaving directory '/home/runner/work/masr/masr'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{10}\NormalTok{)}
\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{.C}\NormalTok{(}\StringTok{"useC"}\NormalTok{, }\AttributeTok{b =} \FunctionTok{as.integer}\NormalTok{(a))}
\NormalTok{out}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $b
##  [1] 11  2  2  2  2  2  2  2  2  2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{out}\SpecialCharTok{$}\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 11  2  2  2  2  2  2  2  2  2
\end{verbatim}

一步一步地命令行操作

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{R}\NormalTok{ CMD SHLIB useC1.c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dyn.load}\NormalTok{(}\StringTok{"useC1.dll"}\NormalTok{)}
\NormalTok{a }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{10}\NormalTok{)}
\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{.C}\NormalTok{(}\StringTok{"useC"}\NormalTok{, }\AttributeTok{b =} \FunctionTok{as.integer}\NormalTok{(a))}
\NormalTok{out}\SpecialCharTok{$}\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-r-cpp}{%
\section{R 与 C++}\label{sec-r-cpp}}

\href{https://dirk.eddelbuettel.com}{Dirk Eddelbuettel} 是 Rcpp 的核心开发者。

\begin{itemize}
\tightlist
\item
  Dirk Eddelbuettel celebRtion 2020, Copenhagen, Denmark \href{https://dirk.eddelbuettel.com/papers/celebRtion_feb2020_rcpp.pdf}{Introduction to Rcpp: from simple examples to machine learning}
\item
  Online Tutorial for useR! 2020 \href{https://dirk.eddelbuettel.com/papers/useR2020_rcpp_tutorial.pdf}{Seamless R and C++ Introduction with Rcpp} 视频 \url{https://vimeo.com/438283959}
\item
  James Balamuta \href{https://thecoatlessprofessor.com/programming/unofficial-rcpp-api-documentation/}{unofficial rcpp api documentation} \url{https://github.com/coatless/rcpp-api}
\item
  Rcpp for everyone \url{https://github.com/teuder/rcpp4everyone_en}
\item
  课程 \href{https://ds4ps.org/cpp-526-sum-2020/}{Foundations of Data Science}
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Rcpp)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-r-latex}{%
\section{R 与 LaTeX}\label{sec-r-latex}}

\textbf{tikzDevice} 包将 LaTeX 公式和绘图系统 \href{https://en.wikipedia.org/wiki/PGF/TikZ}{TikZ} 引入 R 语言生态，贡献在于提供更加漂亮的公式输出，对图形进行后期布局排版加工，达到设计师出品的质量水平。图 \ref{fig:tex-system} 展示了复杂的 TeX 生态系统， R 语言只是取其精华，使用 TikZ 绘制。

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{\textbackslash{}begin}\NormalTok{\{}\ExtensionTok{tikzpicture}\NormalTok{\}}
  \FunctionTok{\textbackslash{}path}\NormalTok{ [}
\NormalTok{    mindmap,}
\NormalTok{    text = white,}
\NormalTok{    level 1 concept/.append style =}
\NormalTok{      \{font=}\FunctionTok{\textbackslash{}Large\textbackslash{}bfseries\textbackslash{}sffamily}\NormalTok{, sibling angle=90, level distance=125\},}
\NormalTok{    level 2 concept/.append style =}
\NormalTok{      \{font=}\FunctionTok{\textbackslash{}normalsize\textbackslash{}bfseries\textbackslash{}sffamily}\NormalTok{\},}
\NormalTok{    level 3 concept/.append style =}
\NormalTok{      \{font=}\FunctionTok{\textbackslash{}small\textbackslash{}bfseries\textbackslash{}sffamily}\NormalTok{\},}
\NormalTok{    tex/.style     = \{concept, ball color=blue,}
\NormalTok{      font=}\FunctionTok{\textbackslash{}Huge\textbackslash{}bfseries}\NormalTok{\},}
\NormalTok{    engines/.style = \{concept, ball color=green!50!black\},}
\NormalTok{    formats/.style = \{concept, ball color=purple!50!black\},}
\NormalTok{    systems/.style = \{concept, ball color=red!90!black\},}
\NormalTok{    editors/.style = \{concept, ball color=orange!90!black\}}
\NormalTok{  ]}
\NormalTok{  node [tex] \{}\FunctionTok{\textbackslash{}TeX}\NormalTok{\} [clockwise from=0]}
\NormalTok{    child[concept color=green!50!black, nodes=\{engines\}] \{}
\NormalTok{      node \{Engines\} [clockwise from=90]}
\NormalTok{        child \{ node \{}\FunctionTok{\textbackslash{}TeX}\NormalTok{\} \}}
\NormalTok{        child \{ node \{pdf}\FunctionTok{\textbackslash{}TeX}\NormalTok{\} \}}
\NormalTok{        child \{ node \{XeTeX\} \}}
\NormalTok{        child \{ node \{Lua}\FunctionTok{\textbackslash{}TeX}\NormalTok{\} \}\}}
\NormalTok{    child [concept color=purple, nodes=\{formats\}] \{}
\NormalTok{      node \{Formats\} [clockwise from=300]}
\NormalTok{        child \{ node \{}\FunctionTok{\textbackslash{}LaTeX}\NormalTok{\} \}}
\NormalTok{        child \{ node \{Con}\FunctionTok{\textbackslash{}TeX}\NormalTok{ t\} \}\}}
\NormalTok{    child [concept color=red, nodes=\{systems\}] \{}
\NormalTok{      node \{Systems\} [clockwise from=210]}
\NormalTok{        child \{ node \{}\FunctionTok{\textbackslash{}TeX}\NormalTok{ Live\} [clockwise from=300]}
\NormalTok{          child \{ node \{Mac }\FunctionTok{\textbackslash{}TeX}\NormalTok{\} \}\}}
\NormalTok{        child \{ node \{MiK}\FunctionTok{\textbackslash{}TeX}\NormalTok{\} [clockwise from=60]}
\NormalTok{          child \{ node \{Pro }\FunctionTok{\textbackslash{}TeX}\NormalTok{ t\} \}\}\}}
\NormalTok{    child [concept color=orange, nodes=\{editors\}] \{}
\NormalTok{      node \{Editors\} [clockwise from=180]}
\NormalTok{        child \{ node \{WinEdt\} \}}
\NormalTok{        child \{ node \{}\FunctionTok{\textbackslash{}TeX}\NormalTok{ works\} \}}
\NormalTok{        child \{ node \{}\FunctionTok{\textbackslash{}TeX}\NormalTok{ studio\} \}}
\NormalTok{        child \{ node \{}\FunctionTok{\textbackslash{}TeX}\NormalTok{ maker\} \}\};}
\KeywordTok{\textbackslash{}end}\NormalTok{\{}\ExtensionTok{tikzpicture}\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{mixed-programming_files/figure-latex/tex-system-1} 

}

\caption{TeX 系统}\label{fig:tex-system}
\end{figure}

\hypertarget{sec-mixed-programming-session-info}{%
\section{运行环境}\label{sec-mixed-programming-session-info}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] Rcpp_1.0.7        reticulate_1.22   htmlwidgets_1.5.4 shiny_1.7.0      
## [5] magrittr_2.0.1   
## 
## loaded via a namespace (and not attached):
##  [1] knitr_1.36       lattice_0.20-45  xtable_1.8-4     R6_2.5.1        
##  [5] rlang_0.4.11     fastmap_1.1.0    stringr_1.4.0    tools_4.1.1     
##  [9] grid_4.1.1       xfun_0.26        png_0.1-7        tinytex_0.34    
## [13] htmltools_0.5.2  ellipsis_0.3.2   yaml_2.2.1       digest_0.6.28   
## [17] lifecycle_1.0.1  bookdown_0.24    Matrix_1.3-4     later_1.3.0     
## [21] promises_1.2.0.1 curl_4.3.2       evaluate_0.14    mime_0.12       
## [25] rmarkdown_2.11   stringi_1.7.4    compiler_4.1.1   jsonlite_1.7.2  
## [29] httpuv_1.6.3
\end{verbatim}

\hypertarget{chap-object-oriented-programming}{%
\chapter{面向对象编程}\label{chap-object-oriented-programming}}

进入这一章的读者都是对编程感兴趣的读者，希望在工程能力上有所提升的读者。那么最重要的是：

\begin{quote}
Code should be written to minimize the time it would take for someone else to understand it.

\hspace*{\fill} --- The Art of Readable Code, Boswell, D. / Foucher, T.
\end{quote}

代码可读性，代码复用性，代码维护性，代码扩展性，代码简洁性，代码高效性，代码容错性，我们共勉吧！如果读者已投身商业公司，应当以完成任务为第一，这自不必说！

\hypertarget{sec-environment}{%
\section{环境}\label{sec-environment}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{environment}\NormalTok{(}\AttributeTok{fun =} \ConstantTok{NULL}\NormalTok{)}
\FunctionTok{environment}\NormalTok{(fun) }\OtherTok{\textless{}{-}}\NormalTok{ value}

\FunctionTok{is.environment}\NormalTok{(x)}

\NormalTok{.GlobalEnv}
\FunctionTok{globalenv}\NormalTok{()}
\NormalTok{.BaseNamespaceEnv}

\FunctionTok{emptyenv}\NormalTok{()}
\FunctionTok{baseenv}\NormalTok{()}

\FunctionTok{new.env}\NormalTok{(}\AttributeTok{hash =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{parent =} \FunctionTok{parent.frame}\NormalTok{(), }\AttributeTok{size =}\NormalTok{ 29L)}

\FunctionTok{parent.env}\NormalTok{(env)}
\FunctionTok{parent.env}\NormalTok{(env) }\OtherTok{\textless{}{-}}\NormalTok{ value}

\FunctionTok{environmentName}\NormalTok{(env)}

\FunctionTok{env.profile}\NormalTok{(env)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-quote}{%
\section{引用}\label{sec-quote}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{get}\NormalTok{(x, }\AttributeTok{pos =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{as.environment}\NormalTok{(pos), }\AttributeTok{mode =} \StringTok{"any"}\NormalTok{,}
    \AttributeTok{inherits =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{mget}\NormalTok{(x, }\AttributeTok{envir =} \FunctionTok{as.environment}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{mode =} \StringTok{"any"}\NormalTok{, ifnotfound,}
     \AttributeTok{inherits =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{dynGet}\NormalTok{(x, }\AttributeTok{ifnotfound =}\NormalTok{ , }\AttributeTok{minframe =}\NormalTok{ 1L, }\AttributeTok{inherits =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get Return the Value of a Named Object}

\NormalTok{exists Is an Object Defined?}

\FunctionTok{exists}\NormalTok{(x, }\AttributeTok{where =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ , frame, }\AttributeTok{mode =} \StringTok{"any"}\NormalTok{,}
       \AttributeTok{inherits =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{get0}\NormalTok{(x, }\AttributeTok{envir =} \FunctionTok{pos.to.env}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{1L), }\AttributeTok{mode =} \StringTok{"any"}\NormalTok{, }\AttributeTok{inherits =} \ConstantTok{TRUE}\NormalTok{,}
     \AttributeTok{ifnotfound =} \ConstantTok{NULL}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-call-stack}{%
\section{调用栈}\label{sec-call-stack}}

Functions to Access the Function Call Stack

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sys.call}\NormalTok{(}\AttributeTok{which =} \DecValTok{0}\NormalTok{)}
\FunctionTok{sys.frame}\NormalTok{(}\AttributeTok{which =} \DecValTok{0}\NormalTok{)}
\FunctionTok{sys.nframe}\NormalTok{()}
\FunctionTok{sys.function}\NormalTok{(}\AttributeTok{which =} \DecValTok{0}\NormalTok{)}
\FunctionTok{sys.parent}\NormalTok{(}\AttributeTok{n =} \DecValTok{1}\NormalTok{)}

\FunctionTok{sys.calls}\NormalTok{()}
\FunctionTok{sys.frames}\NormalTok{()}
\FunctionTok{sys.parents}\NormalTok{()}
\FunctionTok{sys.on.exit}\NormalTok{()}
\FunctionTok{sys.status}\NormalTok{()}
\FunctionTok{parent.frame}\NormalTok{(}\AttributeTok{n =} \DecValTok{1}\NormalTok{)}

\NormalTok{sys.source Parse and Evaluate Expressions from a File}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-closure}{%
\section{闭包}\label{sec-closure}}

An illustration of lexical scoping.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{demo}\NormalTok{(scoping)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-recursion}{%
\section{递归}\label{sec-recursion}}

Using recursion for adaptive integration

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{demo}\NormalTok{(recursion)}
\end{Highlighting}
\end{Shaded}

斐波那契数列

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 递归 Recall}
\NormalTok{fibonacci }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n) \{}
  \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{\textless{}=} \DecValTok{2}\NormalTok{) \{}
    \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{Recall}\NormalTok{(n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{Recall}\NormalTok{(n }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}
\FunctionTok{fibonacci}\NormalTok{(}\DecValTok{10}\NormalTok{) }\CommentTok{\# 55}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 55
\end{verbatim}

\hypertarget{sec-catching-and-handling-errors}{%
\section{异常}\label{sec-catching-and-handling-errors}}

异常捕获和处理

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{demo}\NormalTok{(error.catching)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-is-things}{%
\section{对象}\label{sec-is-things}}

判断对象类型

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{demo}\NormalTok{(is.things)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-generic}{%
\section{泛型}\label{sec-generic}}

\begin{quote}
I'd like to prefix all these solutions with `Here's how to do it, but don't actually do it you crazy fool'. It's on a par with redefining pi, or redefining `+'. And then redefining `\textless-'. These techniques have their proper place, and that would be in the currently non-existent obfuscated R contest. No, the R-ish (iRish?) way is to index vectors from 1. That's what the R gods intended!

\hspace*{\fill} --- Barry Rowlingson \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2004-March/048688.html}}
\end{quote}

如果要让下标从 0 开始的话，我们需要在现有的向量类型 vector 上定义新的向量类型 vector0，在其上并且实现索引运算 \texttt{{[}} 和赋值修改元素的运算 \texttt{{[}\textless{}-}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://stat.ethz.ch/pipermail/r{-}help/2004{-}March/048682.html}
\NormalTok{as.vector0 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{structure}\NormalTok{(x, }\AttributeTok{class =} \StringTok{"vector0"}\NormalTok{) }\CommentTok{\# 创建一种新的数据结构 vector0}
\NormalTok{as.vector.vector0 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{unclass}\NormalTok{(x)}
\StringTok{"[.vector0"} \OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, i) }\FunctionTok{as.vector0}\NormalTok{(}\FunctionTok{as.vector.vector0}\NormalTok{(x)[i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{]) }\CommentTok{\# 索引操作}
\StringTok{"[\textless{}{-}.vector0"} \OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, i, value) \{ }\CommentTok{\# 赋值操作}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{as.vector.vector0}\NormalTok{(x)}
\NormalTok{  x[i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ value}
  \FunctionTok{as.vector0}\NormalTok{(x)}
\NormalTok{\}}
\NormalTok{print.vector0 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{print}\NormalTok{(}\FunctionTok{as.vector.vector0}\NormalTok{(x)) }\CommentTok{\# 实现 print 方法}
\end{Highlighting}
\end{Shaded}

举个例子看看

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\SpecialCharTok{:}\DecValTok{10} \CommentTok{\# 是一个内置的现有向量类型 vector}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  1  2  3  4  5  6  7  8  9 10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{as.vector0}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) }\CommentTok{\# 转化为新建的 vector0 类型}
\NormalTok{x[}\DecValTok{0}\SpecialCharTok{:}\DecValTok{4}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{100} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{0}\SpecialCharTok{:}\DecValTok{4}\NormalTok{] }\CommentTok{\# 对 x 的元素替换修改}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 100 200 300 400 500   6   7   8   9  10
\end{verbatim}

第三方 R 包大大扩展了 Base R 函数 \texttt{plot()} 的功能，比如 \textbf{mgcv} ，\textbf{nlme} 包和 \textbf{lattice} 包等，表 \ref{tab:generic-functions} 列出当前环境下， \texttt{plot()} 绘图方法。

\begin{table}

\caption{\label{tab:generic-functions}泛型函数}
\centering
\begin{tabular}[t]{l|l|l}
\hline
A & B & C\\
\hline
plot.acf & plot.HoltWinters & plot.profile.nls\\
\hline
plot.ACF & plot.intervals.lmList & plot.ranef.lme\\
\hline
plot.augPred & plot.isoreg & plot.ranef.lmList\\
\hline
plot.compareFits & plot.jam & plot.raster\\
\hline
plot.data.frame & plot.lm & plot.shingle\\
\hline
plot.decomposed.ts & plot.lme & plot.simulate.lme\\
\hline
plot.default & plot.lmList & plot.spec\\
\hline
plot.dendrogram & plot.medpolish & plot.spline\\
\hline
plot.density & plot.mlm & plot.stepfun\\
\hline
plot.ecdf & plot.nffGroupedData & plot.stl\\
\hline
plot.factor & plot.nfnGroupedData & plot.table\\
\hline
plot.formula & plot.nls & plot.trellis\\
\hline
plot.function & plot.nmGroupedData & plot.ts\\
\hline
plot.gam & plot.pdMat & plot.tskernel\\
\hline
plot.gls & plot.ppr & plot.TukeyHSD\\
\hline
plot.hclust & plot.prcomp & plot.Variogram\\
\hline
plot.histogram & plot.princomp & plot.xyVector\\
\hline
\end{tabular}
\end{table}

\hypertarget{sec-code-debug}{%
\section{除虫}\label{sec-code-debug}}

\href{https://support.rstudio.com/hc/en-us/articles/205612627}{Debugging with RStudio}

\hypertarget{sec-code-performance}{%
\section{性能}\label{sec-code-performance}}

\hypertarget{sec-code-quality}{%
\section{质量}\label{sec-code-quality}}

Github Action 提供的测试环境支持单元测试 testthat、静态代码检查 lintr、覆盖测试 covr、集成测试 Travis-CI、集成部署 Netlify 等一系列代码检查，还有额外的辅助工具，见 \href{https://github.com/sdras/awesome-actions}{Github Action 工具合集}，相关学习材料见快速参考手册 \url{https://github.com/github/actions-cheat-sheet} \href{https://github.github.io/actions-cheat-sheet/actions-cheat-sheet.pdf}{PDF 版本}，以创建 R 包为例，展示工程开发的流程 \url{https://mdneuzerling.com/post/data-science-workflows/}

标准计算和非标准计算 Standard and non-standard evaluation in R \url{https://www.brodieg.com/2020/05/05/on-nse/}

\hypertarget{chap-file-operations}{%
\chapter{文件操作}\label{chap-file-operations}}

\begin{quote}
考虑添加 Shell 下的命令实现，参考 \href{https://github.com/jlevy/the-art-of-command-line/blob/master/README-zh.md}{命令行的艺术}
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr) }\CommentTok{\# 提供管道命令 \%\textgreater{}\%}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/r-lib/fs}{fs} 由 \href{https://www.jimhester.com/}{Jim Hester} 开发，提供文件系统操作的统一接口，相比于 R 默认的文件系统的操作函数有显而易见的优点，详情请看 \url{https://fs.r-lib.org/}

对于文件操作，Jim Hester 开发了 \href{https://github.com/r-lib/fs}{fs 包} 目的是统一文件操作的命令，由于时间和历史原因，R内置的文件操作函数的命名很不统一，如 \texttt{path.expand()} 和 \texttt{normalizePath()}，\texttt{Sys.chmod()} 和 \texttt{file.access()} 等

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载 R 包}
\FunctionTok{library}\NormalTok{(fs)}
\end{Highlighting}
\end{Shaded}

\hypertarget{list}{%
\section{查看文件}\label{list}}

文件夹只包含文件，目录既包含文件又包含文件夹，\texttt{list.dirs} 列出目录或文件夹，\texttt{list.files} 列出文件或文件夹

\begin{itemize}
\item
  \texttt{list.dirs(path\ =\ ".",\ full.names\ =\ TRUE,\ recursive\ =\ TRUE)}

  \begin{itemize}
  \tightlist
  \item
    path: 指定完整路径名，默认使用当前路径 \texttt{getwd()}
  \item
    full.names: TRUE 返回相对路径，FALSE 返回目录的名称
  \item
    recursive: 是否递归的方式列出目录，如果是的话，目录下的子目录也会列出
  \end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# list.dirs(path = \textquotesingle{}.\textquotesingle{}, full.names = TRUE, recursive = TRUE)}
\FunctionTok{list.dirs}\NormalTok{(}\AttributeTok{path =} \StringTok{\textquotesingle{}.\textquotesingle{}}\NormalTok{, }\AttributeTok{full.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "./_book"                           "./_bookdown_files"                
##  [3] "./.git"                            "./.github"                        
##  [5] "./bayesian-models_files"           "./case-study_cache"               
##  [7] "./case-study_files"                "./code"                           
##  [9] "./dashboard"                       "./data"                           
## [11] "./data-manipulation_files"         "./data-transportation_files"      
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{list.dirs}\NormalTok{(}\AttributeTok{path =} \StringTok{\textquotesingle{}.\textquotesingle{}}\NormalTok{, }\AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "_book"                           "_bookdown_files"                
##  [3] ".git"                            ".github"                        
##  [5] "bayesian-models_files"           "case-study_cache"               
##  [7] "case-study_files"                "code"                           
##  [9] "dashboard"                       "data"                           
## [11] "data-manipulation_files"         "data-transportation_files"      
....
\end{verbatim}
\item
  \texttt{list.files(path\ =\ ".",\ pattern\ =\ NULL,\ all.files\ =\ FALSE,\ full.names\ =\ FALSE,\ recursive\ =\ FALSE,ignore.case\ =\ FALSE,\ include.dirs\ =\ FALSE,\ no..\ =\ FALSE)}

  是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

  \begin{itemize}
  \tightlist
  \item
    path: 指定完整路径名，默认使用当前路径 \texttt{getwd()}
  \item
    full.names: TRUE 返回相对路径，FALSE 返回目录的名称
  \item
    recursive: 是否递归的方式列出目录，如果是的话，目录下的子目录也会列出
  \end{itemize}
\item
  \texttt{file.show(...,\ header\ =\ rep("",\ nfiles),\ title\ =\ "R\ Information",\ delete.file\ =\ FALSE,\ pager\ =\ getOption("pager"),encoding\ =\ "")}

  打开文件内容，\texttt{file.show} 会在R终端中新开一个窗口显示文件

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rinternals }\OtherTok{\textless{}{-}} \FunctionTok{file.path}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(}\StringTok{"include"}\NormalTok{), }\StringTok{"Rinternals.h"}\NormalTok{)}
\CommentTok{\# file.show(rinternals)}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{file.info(...,\ extra\_cols\ =\ TRUE)}

  获取文件信息，此外 \texttt{file.mode(...)} 、 \texttt{file.mtime(...)} 和 \texttt{file.size(...)} 分别表示文件的读写权限，修改时间和文件大小。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.info}\NormalTok{(rinternals)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                          size isdir mode               mtime
## /opt/R/4.1.1/lib/R/include/Rinternals.h 63180 FALSE  644 2021-08-10 08:11:27
##                                                       ctime               atime
## /opt/R/4.1.1/lib/R/include/Rinternals.h 2021-10-05 07:45:56 2021-10-05 07:54:38
##                                         uid gid uname grname
## /opt/R/4.1.1/lib/R/include/Rinternals.h   0   0  root   root
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.mode}\NormalTok{(rinternals)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "644"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.mtime}\NormalTok{(rinternals)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-08-10 08:11:27 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.size}\NormalTok{(rinternals)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 63180
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看当前目录的权限}
\FunctionTok{file.info}\NormalTok{(}\StringTok{"."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    size isdir mode               mtime               ctime               atime
## . 16384  TRUE  755 2021-10-05 09:04:53 2021-10-05 09:04:53 2021-10-05 09:04:54
##    uid gid  uname grname
## . 1001 121 runner docker
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看指定目录权限}
\FunctionTok{file.info}\NormalTok{(}\StringTok{"./\_book/"}\NormalTok{)    }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           size isdir mode               mtime               ctime
## ./_book/ 12288  TRUE  755 2021-10-05 08:57:49 2021-10-05 08:57:49
##                        atime  uid gid  uname grname
## ./_book/ 2021-10-05 09:00:31 1001 121 runner docker
\end{verbatim}
\item
  \texttt{file.access(names,\ mode\ =\ 0)}

  文件是否可以被访问，第二个参数 mode 一共有四种取值 0，1，2，4，分别表示文件的存在性，可执行，可写和可读四种，返回值 0 表示成功，返回值 -1 表示失败。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.access}\NormalTok{(rinternals,}\AttributeTok{mode =} \DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## /opt/R/4.1.1/lib/R/include/Rinternals.h 
##                                       0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.access}\NormalTok{(rinternals,}\AttributeTok{mode =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## /opt/R/4.1.1/lib/R/include/Rinternals.h 
##                                      -1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.access}\NormalTok{(rinternals,}\AttributeTok{mode =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## /opt/R/4.1.1/lib/R/include/Rinternals.h 
##                                      -1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.access}\NormalTok{(rinternals,}\AttributeTok{mode =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## /opt/R/4.1.1/lib/R/include/Rinternals.h 
##                                       0
\end{verbatim}
\item
  \texttt{dir(path\ =\ ".",\ pattern\ =\ NULL,\ all.files\ =\ FALSE,\ full.names\ =\ FALSE,\ recursive\ =\ FALSE,\ ignore.case\ =\ FALSE,\ include.dirs\ =\ FALSE,\ no..\ =\ FALSE)}

  查看目录，首先看看和目录操作有关的函数列表

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{apropos}\NormalTok{(}\StringTok{"\^{}dir."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "dir_copy"   "dir_create" "dir_delete" "dir_exists" "dir_info"  
##  [6] "dir_ls"     "dir_map"    "dir_tree"   "dir_walk"   "dir.create"
## [11] "dir.exists" "dirname"
\end{verbatim}

  显而易见，\texttt{dir.create} 和 \texttt{dir.exists} 分别是创建目录和查看目录的存在性。\texttt{dirname} 和 \texttt{basename} 是一对函数用来操作文件路径。以当前目录/home/runner/work/masr/masr为例，\texttt{dirname(getwd())} 返回 /home/runner/work/masr 而 \texttt{basename(getwd())} 返回 masr。对于文件路径而言，\texttt{dirname(rinternals)} 返回文件所在的目录/opt/R/4.1.1/lib/R/include， \texttt{basename(rinternals)} 返回文件名Rinternals.h。\texttt{dir} 函数查看指定路径或目录下的文件，支持以模式匹配和递归的方式查找目录下的文件

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 当前目录下的子目录和文件}
\FunctionTok{dir}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] "_book"                                      
##   [2] "_bookdown_files"                            
##   [3] "_bookdown.yml"                              
##   [4] "_build.sh"                                  
##   [5] "_common.R"                                  
##   [6] "_deploy-book.R"                             
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看指定目录的子目录和文件}
\FunctionTok{dir}\NormalTok{(}\AttributeTok{path =} \StringTok{"./"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] "_book"                                      
##   [2] "_bookdown_files"                            
##   [3] "_bookdown.yml"                              
##   [4] "_build.sh"                                  
##   [5] "_common.R"                                  
##   [6] "_deploy-book.R"                             
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 只列出以字母R开头的子目录和文件}
\FunctionTok{dir}\NormalTok{(}\AttributeTok{path =} \StringTok{"./"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}R"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "README.md"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 列出目录下所有目录和文件，包括隐藏文件}
\FunctionTok{dir}\NormalTok{(}\AttributeTok{path =} \StringTok{"./"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] "_book"                                      
##   [2] "_bookdown_files"                            
##   [3] "_bookdown.yml"                              
##   [4] "_build.sh"                                  
##   [5] "_common.R"                                  
##   [6] "_deploy-book.R"                             
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 支持正则表达式}
\FunctionTok{dir}\NormalTok{(}\AttributeTok{pattern =} \StringTok{\textquotesingle{}\^{}[A{-}Z]+[.]txt$\textquotesingle{}}\NormalTok{, }\AttributeTok{full.names=}\ConstantTok{TRUE}\NormalTok{, }\FunctionTok{system.file}\NormalTok{(}\StringTok{\textquotesingle{}doc\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SuiteSparse\textquotesingle{}}\NormalTok{, }\AttributeTok{package=}\StringTok{\textquotesingle{}Matrix\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/opt/R/4.1.1/lib/R/library/Matrix/doc/SuiteSparse/AMD.txt"    
## [2] "/opt/R/4.1.1/lib/R/library/Matrix/doc/SuiteSparse/CHOLMOD.txt"
## [3] "/opt/R/4.1.1/lib/R/library/Matrix/doc/SuiteSparse/COLAMD.txt" 
## [4] "/opt/R/4.1.1/lib/R/library/Matrix/doc/SuiteSparse/SPQR.txt"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 在临时目录下递归创建一个目录}
\FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\FunctionTok{tempdir}\NormalTok{(), }\StringTok{"/\_book/tmp"}\NormalTok{), }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\end{itemize}

查看当前目录下的文件和文件夹 \texttt{tree\ -L\ 2\ .} 或者 \texttt{ls\ -l\ .}

\hypertarget{manipulation}{%
\section{操作文件}\label{manipulation}}

实现文件增删改查的函数如下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{apropos}\NormalTok{(}\StringTok{"\^{}file."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "file_access"    "file_chmod"     "file_chown"     "file_copy"     
##  [5] "file_create"    "file_delete"    "file_exists"    "file_info"     
##  [9] "file_move"      "file_show"      "file_size"      "file_temp"     
## [13] "file_temp_pop"  "file_temp_push" "file_test"      "file_touch"    
## [17] "file.access"    "file.append"    "file.choose"    "file.copy"     
## [21] "file.create"    "file.edit"      "file.exists"    "file.info"     
## [25] "file.link"      "file.mode"      "file.mtime"     "file.path"     
## [29] "file.remove"    "file.rename"    "file.show"      "file.size"     
## [33] "file.symlink"   "fileSnapshot"
\end{verbatim}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \texttt{file.create(...,\ showWarnings\ =\ TRUE)}

  创建/删除文件，检查文件的存在性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.create}\NormalTok{(}\StringTok{\textquotesingle{}demo.txt\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.exists}\NormalTok{(}\StringTok{\textquotesingle{}demo.txt\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.remove}\NormalTok{(}\StringTok{\textquotesingle{}demo.txt\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.exists}\NormalTok{(}\StringTok{\textquotesingle{}demo.txt\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE
\end{verbatim}
\item
  \texttt{file.rename(from,\ to)} 文件重命名

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.create}\NormalTok{(}\StringTok{\textquotesingle{}demo.txt\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.rename}\NormalTok{(}\AttributeTok{from =} \StringTok{\textquotesingle{}demo.txt\textquotesingle{}}\NormalTok{, }\AttributeTok{to =} \StringTok{\textquotesingle{}tmp.txt\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.exists}\NormalTok{(}\StringTok{\textquotesingle{}tmp.txt\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}
\item
  \texttt{file.append(file1,\ file2)} 追加文件 \texttt{file2} 的内容到文件 \texttt{file1} 上

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{dir.exists}\NormalTok{(}\AttributeTok{paths =} \StringTok{\textquotesingle{}data/\textquotesingle{}}\NormalTok{)) }\FunctionTok{dir.create}\NormalTok{(}\AttributeTok{path =} \StringTok{\textquotesingle{}data/\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 创建两个临时文件}
\CommentTok{\# file.create(c(\textquotesingle{}data/tmp1.md\textquotesingle{},\textquotesingle{}data/tmp2.md\textquotesingle{}))}
\CommentTok{\# 写入内容}
\FunctionTok{cat}\NormalTok{(}\StringTok{"AAA}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{file =} \StringTok{\textquotesingle{}data/tmp1.md\textquotesingle{}}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"BBB}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{file =} \StringTok{\textquotesingle{}data/tmp2.md\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 追加文件}
\FunctionTok{file.append}\NormalTok{(}\AttributeTok{file1 =} \StringTok{\textquotesingle{}data/tmp1.md\textquotesingle{}}\NormalTok{, }\AttributeTok{file2 =} \StringTok{\textquotesingle{}data/tmp2.md\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 展示文件内容}
\FunctionTok{readLines}\NormalTok{(}\StringTok{\textquotesingle{}data/tmp1.md\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "AAA" "BBB"
\end{verbatim}
\item
  \texttt{file.copy(from,\ to,\ overwrite\ =\ recursive,\ recursive\ =\ FALSE,copy.mode\ =\ TRUE,\ copy.date\ =\ FALSE)} 复制文件，参考 \url{https://blog.csdn.net/wzj_110/article/details/86497860}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.copy}\NormalTok{(}\AttributeTok{from =} \StringTok{\textquotesingle{}Makefile\textquotesingle{}}\NormalTok{, }\AttributeTok{to =} \StringTok{\textquotesingle{}data/Makefile\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE
\end{verbatim}
\item
  \texttt{file.symlink(from,\ to)} 创建符号链接 \texttt{file.link(from,\ to)} 创建硬链接
\item
  \texttt{Sys.junction(from,\ to)} windows 平台上的函数，提供类似符号链接的功能
\item
  \texttt{Sys.readlink(paths)} 读取文件的符号链接（软链接）
\item
  \texttt{choose.files} 在 Windows 环境下交互式地选择一个或多个文件，所以该函数只运行于 Windows 环境

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 选择 zip 格式的压缩文件或其它}
\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{interactive}\NormalTok{())}
     \FunctionTok{choose.files}\NormalTok{(}\AttributeTok{filters =}\NormalTok{ Filters[}\FunctionTok{c}\NormalTok{(}\StringTok{"zip"}\NormalTok{, }\StringTok{"All"}\NormalTok{),])}
\end{Highlighting}
\end{Shaded}

  \texttt{Filters} 参数传递一个矩阵，用来描述或标记R识别的文件类型，上面这个例子就能筛选出 zip 格式的文件
\item
  \texttt{download.file} 文件下载

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{download.file}\NormalTok{(}\AttributeTok{url =} \StringTok{\textquotesingle{}https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R{-}latest.tar.gz\textquotesingle{}}\NormalTok{,}
              \AttributeTok{destfile =} \StringTok{\textquotesingle{}data/R{-}latest.tar.gz\textquotesingle{}}\NormalTok{, }\AttributeTok{method =} \StringTok{\textquotesingle{}auto\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

\hypertarget{compression}{%
\section{压缩文件}\label{compression}}

tar 和 zip 是两种常见的压缩文件工具，具有免费和跨平台的特点，因此应用范围广\footnote{\url{https://github.com/libarchive/libarchive/wiki/FormatTar}}。 R 内对应的压缩与解压缩命令是 \texttt{tar/untar}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tar}\NormalTok{(tarfile, }\AttributeTok{files =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{compression =} \FunctionTok{c}\NormalTok{(}\StringTok{"none"}\NormalTok{, }\StringTok{"gzip"}\NormalTok{, }\StringTok{"bzip2"}\NormalTok{, }\StringTok{"xz"}\NormalTok{),}
    \AttributeTok{compression\_level =} \DecValTok{6}\NormalTok{, }\AttributeTok{tar =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"tar"}\NormalTok{),}
    \AttributeTok{extra\_flags =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

比较常用的压缩文件格式是 \texttt{.tar.gz} 和 \texttt{.tar.bz2}，将目录 \texttt{\_book/}及其文件分别压缩成 \texttt{\_book.tar.gz} 和 \texttt{\_book.tar.bz2} 压缩包的名字可以任意取，后者压缩比率高。\texttt{.tar.xz} 的压缩比率最高，需要确保系统中安装了 gzip，bzip2 和 xz-utils 软件，R 软件自带的 tar 软件来自 \href{https://github.com/rwinlib/rtools35}{Rtools}\footnote{继 Rtools35 之后， \href{https://cloud.r-project.org/bin/windows/testing/rtools40.html}{RTools40} 主要为 R 3.6.0 准备的，包含有 GCC 8 及其它编译R包需要的\href{https://github.com/r-windows/rtools-packages}{工具包}，详情请看的\href{https://jeroen.github.io/uros2018}{幻灯片}}，我们可以通过设置系统环境变量 \texttt{Sys.setenv(tar="path/to/tar")} 指定外部 tar。\texttt{tar} 实际支持的压缩类型只有 \texttt{.tar.gz}\footnote{\url{https://github.com/rwinlib/utils}}。\texttt{zip/unzip} 压缩与解压缩就不赘述了。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 打包目录 \_book}
\FunctionTok{tar}\NormalTok{(}\AttributeTok{tarfile =} \StringTok{\textquotesingle{}data/\_book.tar\textquotesingle{}}\NormalTok{, }\AttributeTok{files =} \StringTok{\textquotesingle{}\_book\textquotesingle{}}\NormalTok{, }\AttributeTok{compression =} \StringTok{\textquotesingle{}none\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 文件压缩成 \_book.xz 格式}
\FunctionTok{tar}\NormalTok{(}\AttributeTok{tarfile =} \StringTok{\textquotesingle{}data/\_book.tar.xz\textquotesingle{}}\NormalTok{, }\AttributeTok{files =} \StringTok{\textquotesingle{}data/\_book\textquotesingle{}}\NormalTok{, }\AttributeTok{compression =} \StringTok{\textquotesingle{}xz\textquotesingle{}}\NormalTok{)}
\CommentTok{\# tar {-}cf data/\_book.tar \_book 然后 xz {-}z data/\_book.tar.xz data/\_book.tar}
\CommentTok{\# 或者一次压缩到位 tar {-}Jcf data/\_book.tar.xz \_book/}

\CommentTok{\# 解压 xz {-}d data/\_book.tar.xz 再次解压 tar {-}xf data/\_book.tar}
\CommentTok{\# 或者一次解压 tar {-}Jxf data/\_book.tar.xz}

\CommentTok{\# 文件压缩成 \_book.tar.gz 格式}
\CommentTok{\# tar {-}czf data/\_book.tar.gz \_book}
\FunctionTok{tar}\NormalTok{(}\AttributeTok{tarfile =} \StringTok{\textquotesingle{}data/\_book.tar.gz\textquotesingle{}}\NormalTok{, }\AttributeTok{files =} \StringTok{\textquotesingle{}\_book\textquotesingle{}}\NormalTok{, }\AttributeTok{compression =} \StringTok{\textquotesingle{}gzip\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 解压 tar {-}xzf data/\_book.tar.gz}

\CommentTok{\# 文件压缩成 .tar.bz2 格式}
\CommentTok{\# tar {-}cjf data/book2.tar.bz2 \_book}
\FunctionTok{tar}\NormalTok{(}\AttributeTok{tarfile =} \StringTok{\textquotesingle{}data/\_book.tar.bz2\textquotesingle{}}\NormalTok{, }\AttributeTok{files =} \StringTok{\textquotesingle{}\_book\textquotesingle{}}\NormalTok{, }\AttributeTok{compression =} \StringTok{\textquotesingle{}bzip2\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 解压 tar {-}xjf data/book2.tar.bz2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{untar}\NormalTok{(tarfile, }\AttributeTok{files =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{list =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{exdir =} \StringTok{"."}\NormalTok{,}
      \AttributeTok{compressed =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{extras =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{FALSE}\NormalTok{,}
      \AttributeTok{restore\_times =}  \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{tar =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"TAR"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{paths}{%
\section{路径操作}\label{paths}}

环境变量算是路径操作

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 获取环境变量}
\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"PATH"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/home/runner/.TinyTeX/bin/x86_64-linux:/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:/home/runner/.local/bin:/opt/pipx_bin:/usr/share/rust/.cargo/bin:/home/runner/.config/composer/vendor/bin:/usr/local/.ghcup/bin:/home/runner/.dotnet/tools:/snap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 设置环境变量 Windows}
\CommentTok{\# Sys.setenv(R\_GSCMD = "C:/Program Files/gs/gs9.26/bin/gswin64c.exe")}
\CommentTok{\# 设置 pandoc 环境变量}
\NormalTok{pandoc\_path }\OtherTok{\textless{}{-}} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"RSTUDIO\_PANDOC"}\NormalTok{, }\ConstantTok{NA}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{Sys.which}\NormalTok{(}\StringTok{"pandoc"}\NormalTok{) }\SpecialCharTok{==} \StringTok{""} \SpecialCharTok{\&\&} \SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(pandoc\_path)) \{}
  \FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{PATH =} \FunctionTok{paste}\NormalTok{(}
    \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"PATH"}\NormalTok{), pandoc\_path,}
    \AttributeTok{sep =} \ControlFlowTok{if}\NormalTok{ (.Platform}\SpecialCharTok{$}\NormalTok{OS.type }\SpecialCharTok{==} \StringTok{"unix"}\NormalTok{) }\StringTok{":"} \ControlFlowTok{else} \StringTok{";"}
\NormalTok{  ))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

操作文件路径

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \texttt{file.path} Construct Path to File

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.path}\NormalTok{(}\StringTok{\textquotesingle{}./\_book\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "./_book"
\end{verbatim}
\item
  \texttt{path.expand(path)} Expand File Paths

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{path.expand}\NormalTok{(}\StringTok{\textquotesingle{}./\_book\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "./_book"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{path.expand}\NormalTok{(}\StringTok{\textquotesingle{}\textasciitilde{}\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/home/runner"
\end{verbatim}
\item
  \texttt{normalizePath()} Express File Paths in Canonical Form

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{normalizePath}\NormalTok{(}\StringTok{\textquotesingle{}\textasciitilde{}\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/home/runner"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{normalizePath}\NormalTok{(}\StringTok{\textquotesingle{}./\_book\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/home/runner/work/masr/masr/_book"
\end{verbatim}
\item
  \texttt{shortPathName(path)} 只在 Windows 下可用，Express File Paths in Short Form

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\FunctionTok{shortPathName}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(), }\FunctionTok{tempdir}\NormalTok{())), }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{Sys.glob} Wildcard Expansion on File Paths

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.glob}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(), }\StringTok{"library"}\NormalTok{, }\StringTok{"compiler"}\NormalTok{, }\StringTok{"R"}\NormalTok{, }\StringTok{"*.rdx"}\NormalTok{)) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/opt/R/4.1.1/lib/R/library/compiler/R/compiler.rdx"
\end{verbatim}
\end{enumerate}

\hypertarget{find}{%
\section{查找文件}\label{find}}

\href{https://github.com/r-lib/here}{here} 包用来查找你的文件，查找文件、可执行文件的完整路径、R 包

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \texttt{Sys.which} Find Full Paths to Executables

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.which}\NormalTok{(}\StringTok{\textquotesingle{}pandoc\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            pandoc 
## "/usr/bin/pandoc"
\end{verbatim}
\item
  \texttt{system.file} Find Names of R System Files

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{system.file}\NormalTok{(}\StringTok{\textquotesingle{}CITATION\textquotesingle{}}\NormalTok{,}\AttributeTok{package =} \StringTok{\textquotesingle{}base\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/opt/R/4.1.1/lib/R/library/base/CITATION"
\end{verbatim}
\item
  \texttt{R.home}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# R 安装目录}
\FunctionTok{R.home}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/opt/R/4.1.1/lib/R"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# R执行文件目录}
\FunctionTok{R.home}\NormalTok{(}\StringTok{\textquotesingle{}bin\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/opt/R/4.1.1/lib/R/bin"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 配置文件目录}
\FunctionTok{R.home}\NormalTok{(}\StringTok{\textquotesingle{}etc\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/opt/R/4.1.1/lib/R/etc"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# R 基础扩展包存放目录}
\FunctionTok{R.home}\NormalTok{(}\StringTok{\textquotesingle{}library\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/opt/R/4.1.1/lib/R/library"
\end{verbatim}
\item
  \texttt{.libPaths()} R 包存放的路径有哪些

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{.libPaths}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/home/runner/work/_temp/Library" "/opt/R/4.1.1/lib/R/library"
\end{verbatim}
\item
  \texttt{find.package} 查找R包所在目录

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{find.package}\NormalTok{(}\AttributeTok{package =} \StringTok{\textquotesingle{}MASS\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/opt/R/4.1.1/lib/R/library/MASS"
\end{verbatim}
\item
  \texttt{file.exist} 检查文件是否存在

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(}\StringTok{\textquotesingle{}etc\textquotesingle{}}\NormalTok{),}\StringTok{"Rprofile.site"}\NormalTok{,}\AttributeTok{sep =}\NormalTok{ .Platform}\SpecialCharTok{$}\NormalTok{file.sep))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE
\end{verbatim}
\item
  \texttt{apropos} 和 \texttt{find} 查找对象
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{apropos}\NormalTok{(what, }\AttributeTok{where =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ignore.case =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{mode =} \StringTok{"any"}\NormalTok{)}
\FunctionTok{find}\NormalTok{(what, }\AttributeTok{mode =} \StringTok{"any"}\NormalTok{, }\AttributeTok{numeric =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{simple.words =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

匹配含有 find 的函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{apropos}\NormalTok{(}\StringTok{"find"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "find"                 "Find"                 "find.package"        
##  [4] "findClass"            "findFunction"         "findInterval"        
##  [7] "findLineNum"          "findMethod"           "findMethods"         
## [10] "findMethodSignatures" "findPackageEnv"       "findRestart"         
## [13] "findUnique"
\end{verbatim}

问号 \texttt{?} 加函数名搜索R软件内置函数的帮助文档，如 \texttt{?regrex}。如果不知道具体的函数名，可采用关键词搜索，如

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{help.search}\NormalTok{(}\AttributeTok{keyword =} \StringTok{"character"}\NormalTok{, }\AttributeTok{package =} \StringTok{"base"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{browseEnv} 函数用来在浏览器中查看当前环境下，对象的列表，默认环境是 \texttt{sys.frame()}

\hypertarget{permissions}{%
\section{文件权限}\label{permissions}}

操作目录和文件的权限 Manipulation of Directories and File Permissions

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \texttt{dir.exists(paths)} 检查目录是否存在

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dir.exists}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}./\_book\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}./book\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  TRUE FALSE
\end{verbatim}
\item
  \texttt{dir.create(path,\ showWarnings\ =\ TRUE,\ recursive\ =\ FALSE,\ mode\ =\ "0777")} 创建目录

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dir.create}\NormalTok{(}\StringTok{\textquotesingle{}./\_book/tmp\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in dir.create("./_book/tmp"): './_book/tmp' already exists
\end{verbatim}
\item
  \texttt{Sys.chmod(paths,\ mode\ =\ "0777",\ use\_umask\ =\ TRUE)} 修改权限

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.chmod}\NormalTok{(}\StringTok{\textquotesingle{}./\_book/tmp\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{Sys.umask(mode\ =\ NA)}
\end{enumerate}

\hypertarget{locale}{%
\section{区域设置}\label{locale}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \texttt{Sys.getlocale(category\ =\ "LC\_ALL")} 查看当前区域设置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.getlocale}\NormalTok{(}\AttributeTok{category =} \StringTok{"LC\_ALL"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "LC_CTYPE=en_US.UTF-8;LC_NUMERIC=C;LC_TIME=en_US.UTF-8;LC_COLLATE=en_US.UTF-8;LC_MONETARY=en_US.UTF-8;LC_MESSAGES=en_US.UTF-8;LC_PAPER=en_US.UTF-8;LC_NAME=C;LC_ADDRESS=C;LC_TELEPHONE=C;LC_MEASUREMENT=en_US.UTF-8;LC_IDENTIFICATION=C"
\end{verbatim}
\item
  \texttt{Sys.setlocale(category\ =\ "LC\_ALL",\ locale\ =\ "")} 设置区域

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 默认设置}
\FunctionTok{Sys.setlocale}\NormalTok{(}\AttributeTok{category =} \StringTok{"LC\_ALL"}\NormalTok{, }\AttributeTok{locale =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "LC_CTYPE=en_US.UTF-8;LC_NUMERIC=C;LC_TIME=en_US.UTF-8;LC_COLLATE=en_US.UTF-8;LC_MONETARY=en_US.UTF-8;LC_MESSAGES=en_US.UTF-8;LC_PAPER=en_US.UTF-8;LC_NAME=C;LC_ADDRESS=C;LC_TELEPHONE=C;LC_MEASUREMENT=en_US.UTF-8;LC_IDENTIFICATION=C"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 保存当前区域设置}
\NormalTok{old }\OtherTok{\textless{}{-}} \FunctionTok{Sys.getlocale}\NormalTok{()}

\FunctionTok{Sys.setlocale}\NormalTok{(}\StringTok{"LC\_MONETARY"}\NormalTok{, }\AttributeTok{locale =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "en_US.UTF-8"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.localeconv}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     decimal_point     thousands_sep          grouping   int_curr_symbol 
##               "."                ""                ""            "USD " 
##   currency_symbol mon_decimal_point mon_thousands_sep      mon_grouping 
##               "$"               "."               ","        "\003\003" 
##     positive_sign     negative_sign   int_frac_digits       frac_digits 
##                ""               "-"               "2"               "2" 
##     p_cs_precedes    p_sep_by_space     n_cs_precedes    n_sep_by_space 
##               "1"               "0"               "1"               "0" 
##       p_sign_posn       n_sign_posn 
##               "1"               "1"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.setlocale}\NormalTok{(}\StringTok{"LC\_MONETARY"}\NormalTok{, }\StringTok{"de\_AT"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in Sys.setlocale("LC_MONETARY", "de_AT"): OS reports request to set
## locale to "de_AT" cannot be honored
\end{verbatim}

\begin{verbatim}
## [1] ""
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.localeconv}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     decimal_point     thousands_sep          grouping   int_curr_symbol 
##               "."                ""                ""            "USD " 
##   currency_symbol mon_decimal_point mon_thousands_sep      mon_grouping 
##               "$"               "."               ","        "\003\003" 
##     positive_sign     negative_sign   int_frac_digits       frac_digits 
##                ""               "-"               "2"               "2" 
##     p_cs_precedes    p_sep_by_space     n_cs_precedes    n_sep_by_space 
##               "1"               "0"               "1"               "0" 
##       p_sign_posn       n_sign_posn 
##               "1"               "1"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 恢复区域设置}
\FunctionTok{Sys.setlocale}\NormalTok{(}\AttributeTok{locale =}\NormalTok{ old)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in Sys.setlocale(locale = old): OS reports request to set locale to
## "LC_CTYPE=en_US.UTF-8;LC_NUMERIC=C;LC_TIME=en_US.UTF-8;LC_COLLATE=en_US.UTF-8;LC_MONETARY=en_US.UTF-8;LC_MESSAGES=en_US.UTF-8;LC_PAPER=en_US.UTF-8;LC_NAME=C;LC_ADDRESS=C;LC_TELEPHONE=C;LC_MEASUREMENT=en_US.UTF-8;LC_IDENTIFICATION=C"
## cannot be honored
\end{verbatim}

\begin{verbatim}
## [1] ""
\end{verbatim}
\item
  \texttt{Sys.localeconv()} 当前区域设置下，数字和货币的表示

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.localeconv}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     decimal_point     thousands_sep          grouping   int_curr_symbol 
##               "."                ""                ""            "USD " 
##   currency_symbol mon_decimal_point mon_thousands_sep      mon_grouping 
##               "$"               "."               ","        "\003\003" 
##     positive_sign     negative_sign   int_frac_digits       frac_digits 
##                ""               "-"               "2"               "2" 
##     p_cs_precedes    p_sep_by_space     n_cs_precedes    n_sep_by_space 
##               "1"               "0"               "1"               "0" 
##       p_sign_posn       n_sign_posn 
##               "1"               "1"
\end{verbatim}

  本地化信息

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{l10n\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $MBCS
## [1] TRUE
## 
## $`UTF-8`
## [1] TRUE
## 
## $`Latin-1`
## [1] FALSE
## 
## $codeset
## [1] "UTF-8"
\end{verbatim}
\end{enumerate}

\hypertarget{process}{%
\section{进程管理}\label{process}}

\href{https://github.com/r-lib/ps}{ps} 包用来查询进程信息

\begin{itemize}
\item
  \texttt{Sys.getpid} 获取当前运行中的 R 控制台（会话）的进程 ID

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.getpid}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 58222
\end{verbatim}
\item
  \texttt{proc.time()} R 会话运行时间，常用于计算R程序在当前R控制台的运行时间

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t1 }\OtherTok{\textless{}{-}} \FunctionTok{proc.time}\NormalTok{()}
\NormalTok{tmp }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\FloatTok{1e6}\NormalTok{)}
\FunctionTok{proc.time}\NormalTok{() }\SpecialCharTok{{-}}\NormalTok{ t1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    user  system elapsed 
##   0.064   0.004   0.067
\end{verbatim}
\item
  \texttt{system.time} 计算 R 表达式/程序块运行耗费的CPU时间

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{system.time}\NormalTok{(\{}
  \FunctionTok{rnorm}\NormalTok{(}\FloatTok{1e6}\NormalTok{)}
\NormalTok{\}, }\AttributeTok{gcFirst =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    user  system elapsed 
##   0.062   0.004   0.066
\end{verbatim}
\item
  \texttt{gc.time} 报告垃圾回收耗费的时间

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gc.time}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0 0 0 0 0
\end{verbatim}
\end{itemize}

\hypertarget{system-commands}{%
\section{系统命令}\label{system-commands}}

\texttt{system} 和 \texttt{system2} 调用系统命令，推荐使用后者，它更灵活更便携。此外，Jeroen Ooms 开发的 \href{https://github.com/jeroen/sys}{sys 包} 可看作 \texttt{base::system2} 的替代品

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{system }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(...) }\FunctionTok{cat}\NormalTok{(base}\SpecialCharTok{::}\FunctionTok{system}\NormalTok{(..., }\AttributeTok{intern =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{sep =} \StringTok{\textquotesingle{}}\SpecialCharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{system2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(...) }\FunctionTok{cat}\NormalTok{(base}\SpecialCharTok{::}\FunctionTok{system2}\NormalTok{(..., }\AttributeTok{stdout =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{system}\NormalTok{(}\AttributeTok{command =} \StringTok{"xelatex {-}{-}version"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## XeTeX 3.141592653-2.6-0.999993 (TeX Live 2021)
## kpathsea version 6.3.3
## Copyright 2021 SIL International, Jonathan Kew and Khaled Hosny.
## There is NO warranty.  Redistribution of this software is
## covered by the terms of both the XeTeX copyright and
## the Lesser GNU General Public License.
## For more information about these matters, see the file
## named COPYING and the XeTeX source.
## Primary author of XeTeX: Jonathan Kew.
## Compiled with ICU version 68.2; using 68.2
## Compiled with zlib version 1.2.11; using 1.2.11
## Compiled with FreeType2 version 2.10.4; using 2.10.4
## Compiled with Graphite2 version 1.3.14; using 1.3.14
## Compiled with HarfBuzz version 2.7.4; using 2.7.4
## Compiled with libpng version 1.6.37; using 1.6.37
## Compiled with pplib version v2.05 less toxic i hope
## Compiled with fontconfig version 2.11.0; using 2.13.1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{system2}\NormalTok{(}\AttributeTok{command =} \StringTok{\textquotesingle{}pdflatex\textquotesingle{}}\NormalTok{, }\AttributeTok{args =} \StringTok{\textquotesingle{}{-}{-}version\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## pdfTeX 3.141592653-2.6-1.40.23 (TeX Live 2021)
## kpathsea version 6.3.3
## Copyright 2021 Han The Thanh (pdfTeX) et al.
## There is NO warranty.  Redistribution of this software is
## covered by the terms of both the pdfTeX copyright and
## the Lesser GNU General Public License.
## For more information about these matters, see the file
## named COPYING and the pdfTeX source.
## Primary author of pdfTeX: Han The Thanh (pdfTeX) et al.
## Compiled with libpng 1.6.37; using libpng 1.6.37
## Compiled with zlib 1.2.11; using zlib 1.2.11
## Compiled with xpdf version 4.03
\end{verbatim}

\hypertarget{time}{%
\section{时间管理}\label{time}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \texttt{Sys.timezone} 获取时区信息

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.timezone}\NormalTok{(}\AttributeTok{location =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "UTC"
\end{verbatim}
\item
  \texttt{Sys.time} 系统时间，可以给定时区下，显示当前时间，精确到秒，返回数据类型为 \texttt{POSIXct}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 此时美国洛杉矶时间}
\FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\AttributeTok{tz =} \StringTok{\textquotesingle{}America/Los\_Angeles\textquotesingle{}}\NormalTok{, }\AttributeTok{usetz =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 02:04:54 PDT"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 此时加拿大东部时间}
\FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\AttributeTok{tz =} \StringTok{\textquotesingle{}Canada/Eastern\textquotesingle{}}\NormalTok{, }\AttributeTok{usetz =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 05:04:54 EDT"
\end{verbatim}
\item
  \texttt{Sys.Date} 显示当前时区下的日期，精确到日，返回数据类型为 \texttt{date}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.Date}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05"
\end{verbatim}
\item
  \texttt{date} 返回当前系统日期和时间，数据类型是字符串

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{date}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Tue Oct  5 09:04:54 2021"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 也可以这样表示}
\FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\StringTok{"\%a \%b \%d \%H:\%M:\%S \%Y"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Tue Oct 05 09:04:54 2021"
\end{verbatim}
\item
  \texttt{as.POSIX*} 是一个 Date-time 转换函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as.POSIXlt}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\StringTok{"GMT"}\NormalTok{) }\CommentTok{\# the current time in GMT}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 09:04:54 GMT"
\end{verbatim}
\item
  时间计算

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(z }\OtherTok{\textless{}{-}} \FunctionTok{Sys.time}\NormalTok{())             }\CommentTok{\# the current date, as class "POSIXct"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 09:04:54 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.time}\NormalTok{() }\SpecialCharTok{{-}} \DecValTok{3600}             \CommentTok{\# an hour ago}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 08:04:54 UTC"
\end{verbatim}
\item
  \texttt{.leap.seconds} 是内置的日期序列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{.leap.seconds}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "1972-07-01 GMT" "1973-01-01 GMT" "1974-01-01 GMT" "1975-01-01 GMT"
##  [5] "1976-01-01 GMT" "1977-01-01 GMT" "1978-01-01 GMT" "1979-01-01 GMT"
##  [9] "1980-01-01 GMT" "1981-07-01 GMT" "1982-07-01 GMT" "1983-07-01 GMT"
## [13] "1985-07-01 GMT" "1988-01-01 GMT" "1990-01-01 GMT" "1991-01-01 GMT"
## [17] "1992-07-01 GMT" "1993-07-01 GMT" "1994-07-01 GMT" "1996-01-01 GMT"
## [21] "1997-07-01 GMT" "1999-01-01 GMT" "2006-01-01 GMT" "2009-01-01 GMT"
## [25] "2012-07-01 GMT" "2015-07-01 GMT" "2017-01-01 GMT"
\end{verbatim}

  计算日期对应的星期\texttt{weekdays}，月 \texttt{months} 和季度 \texttt{quarters}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{weekdays}\NormalTok{(.leap.seconds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "Saturday"  "Monday"    "Tuesday"   "Wednesday" "Thursday"  "Saturday" 
##  [7] "Sunday"    "Monday"    "Tuesday"   "Wednesday" "Thursday"  "Friday"   
## [13] "Monday"    "Friday"    "Monday"    "Tuesday"   "Wednesday" "Thursday" 
## [19] "Friday"    "Monday"    "Tuesday"   "Friday"    "Sunday"    "Thursday" 
## [25] "Sunday"    "Wednesday" "Sunday"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{months}\NormalTok{(.leap.seconds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "July"    "January" "January" "January" "January" "January" "January"
##  [8] "January" "January" "July"    "July"    "July"    "July"    "January"
## [15] "January" "January" "July"    "July"    "July"    "January" "July"   
## [22] "January" "January" "January" "July"    "July"    "January"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{quarters}\NormalTok{(.leap.seconds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "Q3" "Q1" "Q1" "Q1" "Q1" "Q1" "Q1" "Q1" "Q1" "Q3" "Q3" "Q3" "Q3" "Q1" "Q1"
## [16] "Q1" "Q3" "Q3" "Q3" "Q1" "Q3" "Q1" "Q1" "Q1" "Q3" "Q3" "Q1"
\end{verbatim}
\item
  \texttt{Sys.setFileTime()} 使用系统调用 system call 设置文件或目录的时间

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 修改时间前}
\FunctionTok{file.info}\NormalTok{(}\StringTok{\textquotesingle{}./\_common.R\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             size isdir mode               mtime               ctime
## ./_common.R 1636 FALSE  644 2021-10-05 08:36:44 2021-10-05 08:36:44
##                           atime  uid gid  uname grname
## ./_common.R 2021-10-05 08:36:52 1001 121 runner docker
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 修改时间后，对比一下}
\FunctionTok{Sys.setFileTime}\NormalTok{(}\AttributeTok{path =} \StringTok{\textquotesingle{}./\_common.R\textquotesingle{}}\NormalTok{, }\AttributeTok{time =} \FunctionTok{Sys.time}\NormalTok{())}
\FunctionTok{file.info}\NormalTok{(}\StringTok{\textquotesingle{}./\_common.R\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             size isdir mode               mtime               ctime
## ./_common.R 1636 FALSE  644 2021-10-05 09:04:54 2021-10-05 09:04:54
##                           atime  uid gid  uname grname
## ./_common.R 2021-10-05 09:04:54 1001 121 runner docker
\end{verbatim}
\item
  \texttt{strptime} 用于字符串与 \texttt{POSIXlt}、 \texttt{POSIXct} 类对象之间的转化，\texttt{format} 默认 \texttt{tz\ =\ ""} 且 \texttt{usetz\ =\ TRUE}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 存放时区信息的数据库所在目录}
\FunctionTok{list.files}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(}\StringTok{"share"}\NormalTok{), }\StringTok{"zoneinfo"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## character(0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 比较不同的打印方式}
\FunctionTok{strptime}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\AttributeTok{format =}\StringTok{"\%Y{-}\%m{-}\%d \%H:\%M:\%S"}\NormalTok{, }\AttributeTok{tz =} \StringTok{"Asia/Taipei"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 09:04:54 CST"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d \%H:\%M:\%S"}\NormalTok{) }\CommentTok{\# 默认情形}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 09:04:54"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d \%H:\%M:\%S"}\NormalTok{, }\AttributeTok{tz =} \StringTok{"Asia/Taipei"}\NormalTok{, }\AttributeTok{usetz =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021-10-05 17:04:54 CST"
\end{verbatim}
\item
  设置时区

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.timezone}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{TZ =} \StringTok{"Asia/Shanghai"}\NormalTok{)}
\FunctionTok{Sys.timezone}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Asia/Shanghai"
\end{verbatim}

  全局修改，在文件 /opt/R/4.1.1/lib/R/etc/Rprofile.site 内添加\texttt{Sys.setenv(TZ="Asia/Shanghai")}。 局部修改，就是在本地R项目下，创建 \texttt{.Rprofile}，然后同样添加 \texttt{Sys.setenv(TZ="Asia/Shanghai")}。
\end{enumerate}

\hypertarget{package}{%
\section{R 包管理}\label{package}}

相关的函数大致有

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{apropos}\NormalTok{(}\StringTok{\textquotesingle{}package\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] ".packages"                      ".packageStartupMessage"        
##  [3] "$.package_version"              "as.package_version"            
##  [5] "aspell_package_C_files"         "aspell_package_R_files"        
##  [7] "aspell_package_Rd_files"        "aspell_package_vignettes"      
##  [9] "available.packages"             "download.packages"             
## [11] "find.package"                   "findPackageEnv"                
## [13] "format.packageInfo"             "getPackageName"                
## [15] "install.packages"               "installed.packages"            
## [17] "is.package_version"             "make.packages.html"            
## [19] "methodsPackageMetaName"         "new.packages"                  
....
\end{verbatim}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \texttt{.packages(T)} 已安装的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{.packages}\NormalTok{(T) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{length}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 519
\end{verbatim}
\item
  \texttt{available.packages} 查询可用的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{available.packages}\NormalTok{()[,}\StringTok{"Package"}\NormalTok{] }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         A3      aaSEA   AATtools     ABACUS     abbyyR        abc 
##       "A3"    "aaSEA" "AATtools"   "ABACUS"   "abbyyR"      "abc"
\end{verbatim}

  查询 repos 的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rforge }\OtherTok{\textless{}{-}} \FunctionTok{available.packages}\NormalTok{(}\AttributeTok{repos =} \StringTok{"https://r{-}forge.r{-}project.org/"}\NormalTok{)}
\NormalTok{cran }\OtherTok{\textless{}{-}} \FunctionTok{available.packages}\NormalTok{(}\AttributeTok{repos =} \StringTok{"https://mirrors.tuna.tsinghua.edu.cn/CRAN/"}\NormalTok{)}
\FunctionTok{setdiff}\NormalTok{(rforge[, }\StringTok{"Package"}\NormalTok{], cran[, }\StringTok{"Package"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{download.packages} 下载 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{download.packages}\NormalTok{(}\StringTok{"Rbooks"}\NormalTok{, }\AttributeTok{destdir =} \StringTok{"\textasciitilde{}/"}\NormalTok{, }\AttributeTok{repos =} \StringTok{"https://r{-}forge.r{-}project.org/"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{install.packages} 安装 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"rmarkdown"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{installed.packages} 已安装的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{installed.packages}\NormalTok{(}\AttributeTok{fields =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{,}\StringTok{"Version"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{remove.packages} 卸载/删除/移除已安装的R包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{remove.packages}\NormalTok{(}\StringTok{\textquotesingle{}rmarkdown\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{update.packages} 更新已安装的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{update.packages}\NormalTok{(}\AttributeTok{ask =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  \texttt{old.packages} 查看过时/可更新的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{old.packages}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              Package        LibPath                           Installed Built  
## colourpicker "colourpicker" "/home/runner/work/_temp/Library" "1.1.0"   "4.1.1"
## deldir       "deldir"       "/home/runner/work/_temp/Library" "0.2-10"  "4.1.1"
## diffobj      "diffobj"      "/home/runner/work/_temp/Library" "0.3.4"   "4.1.1"
## echarts4r    "echarts4r"    "/home/runner/work/_temp/Library" "0.4.1"   "4.1.1"
## fda          "fda"          "/home/runner/work/_temp/Library" "5.1.9"   "4.1.1"
## keras        "keras"        "/home/runner/work/_temp/Library" "2.6.0"   "4.1.1"
##              ReposVer Repository                               
## colourpicker "1.1.1"  "https://cloud.r-project.org/src/contrib"
## deldir       "1.0-2"  "https://cloud.r-project.org/src/contrib"
## diffobj      "0.3.5"  "https://cloud.r-project.org/src/contrib"
## echarts4r    "0.4.2"  "https://cloud.r-project.org/src/contrib"
## fda          "5.4.0"  "https://cloud.r-project.org/src/contrib"
## keras        "2.6.1"  "https://cloud.r-project.org/src/contrib"
\end{verbatim}
\item
  \texttt{new.packages} 还没有安装的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{new.packages}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A3"       "aaSEA"    "AATtools" "ABACUS"   "abbyyR"   "abc"
\end{verbatim}
\item
  \texttt{packageStatus} 查看已安装的 R 包状态，可更新、可下载等

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{packageStatus}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Number of installed packages:
##                                  
##                                    ok upgrade unavailable
##   /home/runner/work/_temp/Library 468      13          13
##   /opt/R/4.1.1/lib/R/library       25       4           0
## 
## Number of available packages (each package counted only once):
##                                          
##                                           installed not installed
##   https://cloud.r-project.org/src/contrib       492         17823
\end{verbatim}
\item
  \texttt{packageDescription} 查询 R 包描述信息

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{packageDescription}\NormalTok{(}\StringTok{\textquotesingle{}graphics\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Package: graphics
## Version: 4.1.1
## Priority: base
## Title: The R Graphics Package
## Author: R Core Team and contributors worldwide
## Maintainer: R Core Team <do-use-Contact-address@r-project.org>
....
\end{verbatim}
\item
  查询 R 包的依赖关系

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# rmarkdown 依赖的 R 包}
\NormalTok{tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(}\StringTok{\textquotesingle{}rmarkdown\textquotesingle{}}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $rmarkdown
##  [1] "tools"     "utils"     "knitr"     "yaml"      "htmltools" "evaluate" 
##  [7] "jsonlite"  "tinytex"   "xfun"      "jquerylib" "methods"   "stringr"  
## [13] "digest"    "grDevices" "base64enc" "rlang"     "fastmap"   "highr"    
## [19] "glue"      "magrittr"  "stringi"   "stats"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 依赖 rmarkdown 的 R 包}
\NormalTok{tools}\SpecialCharTok{::}\FunctionTok{dependsOnPkgs}\NormalTok{(}\StringTok{\textquotesingle{}rmarkdown\textquotesingle{}}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "bookdown"       "flexdashboard"  "formattable"    "hrbrthemes"    
##  [5] "kableExtra"     "prettydoc"      "reprex"         "tint"          
##  [9] "packagemetrics" "tidyverse"      "projpred"       "brms"
\end{verbatim}

  ggplot2 生态，仅列出以 gg 开头的 R 包

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdb }\OtherTok{\textless{}{-}} \FunctionTok{available.packages}\NormalTok{()}
\NormalTok{gg }\OtherTok{\textless{}{-}}\NormalTok{ tools}\SpecialCharTok{::}\FunctionTok{dependsOnPkgs}\NormalTok{(}\StringTok{"ggplot2"}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{installed =}\NormalTok{ pdb)}
\FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}gg"}\NormalTok{, gg, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] "gg.gap"            "ggallin"           "ggalluvial"       
##   [4] "ggalt"             "gganimate"         "ggasym"           
##   [7] "ggbeeswarm"        "ggborderline"      "ggbreak"          
##  [10] "ggBubbles"         "ggbuildr"          "ggbump"           
##  [13] "ggcharts"          "ggChernoff"        "ggcleveland"      
##  [16] "ggconf"            "ggcorrplot"        "ggdag"            
##  [19] "ggdark"            "ggDCA"             "ggdemetra"        
##  [22] "ggdendro"          "ggdist"            "ggdmc"            
##  [25] "ggeasy"            "ggedit"            "ggenealogy"       
##  [28] "ggetho"            "ggExtra"           "ggfan"            
##  [31] "ggfittext"         "ggfocus"           "ggforce"          
##  [34] "ggformula"         "ggfortify"         "ggfun"            
##  [37] "ggfx"              "gggap"             "gggenes"          
##  [40] "ggghost"           "gggibbous"         "ggguitar"         
##  [43] "ggh4x"             "gghalfnorm"        "gghalves"         
##  [46] "ggheatmap"         "gghighlight"       "gghilbertstrings" 
##  [49] "ggHoriPlot"        "ggimage"           "ggimg"            
##  [52] "gginference"       "gginnards"         "ggip"             
##  [55] "ggiraph"           "ggiraphExtra"      "ggjoy"            
##  [58] "gglm"              "gglogo"            "ggloop"           
##  [61] "gglorenz"          "ggmap"             "ggmcmc"           
##  [64] "ggmosaic"          "ggmotif"           "ggmuller"         
##  [67] "ggmulti"           "ggnetwork"         "ggnewscale"       
##  [70] "ggnormalviolin"    "ggnuplot"          "ggpacman"         
##  [73] "ggpage"            "ggparallel"        "ggparliament"     
##  [76] "ggparty"           "ggperiodic"        "ggplot.multistats"
##  [79] "ggplotAssist"      "ggplotgui"         "ggplotify"        
##  [82] "ggplotlyExtra"     "ggpmisc"           "ggPMX"            
##  [85] "ggpointdensity"    "ggpol"             "ggpolypath"       
##  [88] "ggpp"              "ggprism"           "ggpubr"           
##  [91] "ggpval"            "ggQC"              "ggQQunif"         
##  [94] "ggquickeda"        "ggquiver"          "ggRandomForests"  
##  [97] "ggraph"            "ggraptR"           "ggrasp"           
## [100] "ggrastr"           "ggrepel"           "ggResidpanel"     
## [103] "ggridges"          "ggrisk"            "ggROC"            
## [106] "ggsci"             "ggseas"            "ggseg"            
## [109] "ggseqlogo"         "ggshadow"          "ggside"           
## [112] "ggsignif"          "ggsn"              "ggsoccer"         
## [115] "ggsolvencyii"      "ggsom"             "ggspatial"        
## [118] "ggspectra"         "ggstance"          "ggstar"           
## [121] "ggstatsplot"       "ggstream"          "ggstudent"        
## [124] "ggswissmaps"       "ggtern"            "ggtext"           
## [127] "ggThemeAssist"     "ggthemes"          "ggtikz"           
## [130] "ggupset"           "ggvenn"            "ggVennDiagram"    
## [133] "ggvoronoi"         "ggwordcloud"       "ggx"
\end{verbatim}
\item
  重装R包，与 R 版本号保持一致

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{db }\OtherTok{\textless{}{-}} \FunctionTok{installed.packages}\NormalTok{()}
\NormalTok{db }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(db, }\AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{pkgs }\OtherTok{\textless{}{-}}\NormalTok{ db[db}\SpecialCharTok{$}\NormalTok{Built }\SpecialCharTok{\textless{}} \FunctionTok{getRversion}\NormalTok{(), }\StringTok{"Package"}\NormalTok{]}
\FunctionTok{install.packages}\NormalTok{(pkgs)}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

\hypertarget{lookup-function}{%
\section{查找函数}\label{lookup-function}}

\href{https://github.com/jimhester/lookup}{lookup} R 函数完整定义，包括编译的代码，S3 和 S4 方法。目前 lookup 包处于开发版，我们可以用 \texttt{remotes::install\_github} 函数来安装它

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# install.packages("remotes")}
\NormalTok{remotes}\SpecialCharTok{::}\FunctionTok{install\_github}\NormalTok{(}\StringTok{"jimhester/lookup"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

R-level 的源代码都可以直接看

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{body}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (fun = sys.function(sys.parent())) 
## {
##     if (is.character(fun)) 
##         fun <- get(fun, mode = "function", envir = parent.frame())
##     .Internal(body(fun))
## }
## <bytecode: 0x5639ef77db70>
## <environment: namespace:base>
\end{verbatim}

此外，\texttt{lookup} 可以定位到 C-level 的源代码，需要联网才能查看，lookup 基于 Winston Chang 在 Github 上维护的 \href{https://github.com/wch/r-source}{R 源码镜像}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lookup}\NormalTok{(body)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
base::body [closure] 
function (fun = sys.function(sys.parent())) 
{
    if (is.character(fun)) 
        fun <- get(fun, mode = "function", envir = parent.frame())
    .Internal(body(fun))
}
<bytecode: 0x00000000140d6158>
<environment: namespace:base>
// c source: src/main/builtin.c#L264-L277
SEXP attribute_hidden do_body(SEXP call, SEXP op, SEXP args, SEXP rho)
{
    checkArity(op, args);
    if (TYPEOF(CAR(args)) == CLOSXP) {
        SEXP b = BODY_EXPR(CAR(args));
        RAISE_NAMED(b, NAMED(CAR(args)));
        return b;
    } else {
        if(!(TYPEOF(CAR(args)) == BUILTINSXP ||
             TYPEOF(CAR(args)) == SPECIALSXP))
            warningcall(call, _("argument is not a function"));
        return R_NilValue;
    }
}
\end{verbatim}

\hypertarget{files-session-info}{%
\section{运行环境}\label{files-session-info}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] rmarkdown_2.11 fs_1.5.0       magrittr_2.0.1
## 
## loaded via a namespace (and not attached):
##  [1] compiler_4.1.1  fastmap_1.1.0   bookdown_0.24   htmltools_0.5.2
##  [5] tools_4.1.1     yaml_2.2.1      curl_4.3.2      stringi_1.7.4  
##  [9] knitr_1.36      stringr_1.4.0   digest_0.6.28   xfun_0.26      
## [13] rlang_0.4.11    evaluate_0.14
\end{verbatim}

\hypertarget{chap-other-softwares}{%
\chapter{其它软件}\label{chap-other-softwares}}

\begin{quote}
I think, therefore I R.

\hspace*{\fill} --- William B. King \footnote{\url{https://ww2.coastal.edu/kingw/statistics/R-tutorials/}}
\end{quote}

\hypertarget{sec-text-editor}{%
\section{文本编辑器}\label{sec-text-editor}}

代码文件也是纯文本，RStudio 集成了编辑器，支持语法高亮。Windows 系统上优秀的代码编辑器有 Notepad++ 非常轻量。Markdown 文本编辑器我们推荐 Typora 编辑器，它是跨平台的，下面以 Ubuntu 环境为例，介绍安装和使用过程：

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# or run:}
\CommentTok{\# sudo apt{-}key adv {-}{-}keyserver keyserver.ubuntu.com {-}{-}recv{-}keys BA300B7755AFCFAE}
\FunctionTok{wget} \AttributeTok{{-}qO} \AttributeTok{{-}}\NormalTok{ https://typora.io/linux/public{-}key.asc }\KeywordTok{|} \FunctionTok{sudo}\NormalTok{ apt{-}key add }\AttributeTok{{-}}

\CommentTok{\# add Typora\textquotesingle{}s repository}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\StringTok{\textquotesingle{}deb https://typora.io/linux ./\textquotesingle{}}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}

\CommentTok{\# install typora}
\FunctionTok{sudo}\NormalTok{ apt{-}get install typora}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[默认的主题\label{fig:typora-theme-1}]{\includegraphics[width=0.45\linewidth]{screenshots/typora-theme-default} }\subfloat[Vue 主题\label{fig:typora-theme-2}]{\includegraphics[width=0.45\linewidth]{screenshots/typora-theme-vue} }

}

\caption{Typora 主题}\label{fig:typora-theme}
\end{figure}

设置中文环境，并且将主题风格样式配置为 Vue，见图\ref{fig:typora-theme}（右），Vue 主题可从 Typora 官网下载 \url{https://theme.typora.io/theme/Vue/}。

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Atom 编辑器 \url{https://atom.io/}
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository ppa:webupd8team/atom}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install atom}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Code 编辑器微软出品 \url{https://code.visualstudio.com/}
\item
  Notepad++ 开源的 Windows 平台上的编辑器 \url{https://notepad-plus-plus.org/}
\item
  VI \& VIM 开源的跨平台编辑器
\item
  Atom 和 Code 有商业公司支持的开源免费的跨平台的编辑器
\item
  VI/VIM 和 Emacs 是跨平台的编辑器
\item
  Markdown 编辑器 + blogdown 记笔记
\item
  Typora Markdown 编辑器，支持自定义 CSS 样式
\end{enumerate}

\hypertarget{sec-code-editor}{%
\section{代码编辑器}\label{sec-code-editor}}

VS Code, Sublime Text 和 Atom

\hypertarget{sec-rstudio-ide}{%
\section{集成开发环境}\label{sec-rstudio-ide}}

\href{https://rstudio.com/slides/rstudio-pbc/}{RStudio 公司的愿景}，介绍 RStudio 开发环境提供的效率提升工具或功能

\hypertarget{rstudio-desktop-ide}{%
\subsection{RStudio 桌面版}\label{rstudio-desktop-ide}}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{screenshots/rstudio-desktop} 

}

\caption{开源桌面版 RStudio 集成开发环境}\label{fig:rstudio-desktop}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# mongolite}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{  openssl{-}devel cyrus{-}sasl{-}devel}
\CommentTok{\# sodium}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{  libsodium{-}devel}
\CommentTok{\# rJava}
\ExtensionTok{R}\NormalTok{ CMD javareconf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://github.com/s{-}u/rJava}
\CommentTok{\# shinytest::installDependencies()}
\NormalTok{db }\OtherTok{\textless{}{-}}\NormalTok{ rstudioapi}\SpecialCharTok{::}\FunctionTok{getRStudioPackageDependencies}\NormalTok{()}

\FunctionTok{invisible}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(db}\SpecialCharTok{$}\NormalTok{name, }\ControlFlowTok{function}\NormalTok{(pkg) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{system.file}\NormalTok{(}\AttributeTok{package =}\NormalTok{ pkg) }\SpecialCharTok{==} \StringTok{""}\NormalTok{) \{}
    \FunctionTok{install.packages}\NormalTok{(pkg)}
\NormalTok{  \}}
\NormalTok{\}))}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/gadenbuie/rsthemes}{rsthemes} 主题

\hypertarget{rstudio-server-ide}{%
\subsection{RStudio 服务器版}\label{rstudio-server-ide}}

RStudio Server 开源服务器版可以放在虚拟机里或者容器里，RStudio 桌面版装在服务器上，服务器为 Ubuntu/CentOS/Windows 系统，然后本地是 Windows 系统，可以通过远程桌面连接服务器，使用 RStudio；

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{screenshots/rstudio-vbox} 

}

\caption{虚拟机里的 RStudio}\label{fig:vbox-rstudio}
\end{figure}

服务器上启动 Docker ，运行 RStudio 镜像，本地通过桌面浏览器，如谷歌浏览器登陆连接。

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{screenshots/rstudio-docker} 

}

\caption{容器里的 RStudio}\label{fig:docker-rstudio}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  下载 RStudio IDE

  我们从 RStudio 官网\href{https://www.rstudio.com/products/rstudio/download/}{下载}开源桌面或服务器版本，服务器版本的使用介绍见\href{https://docs.rstudio.com/ide/server-pro/}{文档}，最常见的就是设置端口

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wget}\NormalTok{ https://download2.rstudio.org/rstudio{-}server{-}1.1.456{-}amd64.deb}
\FunctionTok{sudo}\NormalTok{ apt{-}get install gdebi}
\FunctionTok{sudo}\NormalTok{ gdebi rstudio{-}server{-}1.1.456{-}amd64.deb}
\end{Highlighting}
\end{Shaded}
\item
  设置端口

  在文件 \texttt{/etc/rstudio/rserver.conf} 下，设置

\begin{verbatim}
www-port=8181
\end{verbatim}

  注意：修改 \texttt{rserver.conf} 文件后需要重启才会生效

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ rstudio{-}server stop}
\FunctionTok{sudo}\NormalTok{ rstudio{-}server start}
\end{Highlighting}
\end{Shaded}

  接着获取机器的 IP 地址，如 192.168.141.3

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{ip}\NormalTok{ addr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
 inet 127.0.0.1/8 scope host lo
    valid_lft forever preferred_lft forever
 inet6 ::1/128 scope host
    valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:59:c0:fb brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic enp0s3
       valid_lft 83652sec preferred_lft 83652sec
    inet6 fe80::a00:27ff:fe59:c0fb/64 scope link
       valid_lft forever preferred_lft forever
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:09:33:0d brd ff:ff:ff:ff:ff:ff
    inet 192.168.141.3/24 brd 192.168.141.255 scope global dynamic enp0s8
       valid_lft 547sec preferred_lft 547sec
    inet6 fe80::a00:27ff:fe09:330d/64 scope link
       valid_lft forever preferred_lft forever
\end{verbatim}

  然后，就可以从本地浏览器登陆 RStudio 服务器版本，如 \url{http://192.168.141.3:8181/}
\end{enumerate}

\begin{rmdtip}{提示}
rstudio-server 已经收录在 Fedora 33+ 仓库中了，详情见 \url{https://cran.r-project.org/bin/linux/fedora/}

\end{rmdtip}

授权问题 \href{https://community.rstudio.com/t/rserver-1692-error-system-error-13-permission-denied/46972/10}{ERROR system error 13 (Permission denied)} \href{https://www.tecmint.com/disable-selinux-in-centos-rhel-fedora/}{How to Disable SELinux Temporarily or Permanently}

\hypertarget{shiny-server}{%
\subsection{Shiny 服务器版}\label{shiny-server}}

shiny 开源服务器版

\hypertarget{eclipse-plus-statet}{%
\subsection{Eclipse + StatET}\label{eclipse-plus-statet}}

Eclipse 配合 StatET 插件 \url{http://www.walware.de/goto/statet} 提供R语言的集成开发环境 \url{https://projects.eclipse.org/projects/science.statet}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{screenshots/eclipse-statet} 

}

\caption{基于 Eclipse 的 R 集成开发环境 StatET}\label{fig:eclipse-statet}
\end{figure}

StatET 基于 Eclipse 首次建立索引很慢，估计半小时到一个小时，添加新的 R 包后，每次启动 StatET 也会建立索引缓存，此外，Eclipse 开发环境占用内存比较多，配置 StatET 的过程如下

\hypertarget{emacs-plus-ess}{%
\subsection{Emacs + ESS}\label{emacs-plus-ess}}

Emacs 配合 ESS 插件 \url{https://ess.r-project.org/}

\hypertarget{vim-plus-r}{%
\subsection{Nvim-R}\label{vim-plus-r}}

Nvim-R 是一个基于 Vim 的集成开发环境 \url{https://github.com/jalvesaq/Nvim-R}

\hypertarget{sec-version-control}{%
\section{Git 版本控制}\label{sec-version-control}}

Git 操作

MacOS 上用 Homebrew 安装 \href{https://github.com/dandavison/delta}{git-delta}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{brew}\NormalTok{ install git{-}delta}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/Thinkr-open/gitdown}{gitdown}

只考虑 Ubuntu 18.04 环境下的三剑客 Git \& Github \& Gitlab

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(git2r}\SpecialCharTok{::}\FunctionTok{repository}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Local:    devel /home/runner/work/masr/masr
## Remote:   devel @ origin (https://github.com/XiangyunHuang/masr)
## Head:     [1266732] 2021-10-05: fix ! Unable to load picture or PDF file 'figures/mai.png'.
## 
## Branches:         1
## Tags:             0
## Commits:          5
## Contributors:     1
## Stashes:          0
## Ignored files:   14
## Untracked files: 94
## Unstaged files:   0
## Staged files:     0
## 
## Latest commits:
## [1266732] 2021-10-05: fix ! Unable to load picture or PDF file 'figures/mai.png'.
## [f521da0] 2021-10-05: fix warnings
## [0fe63c5] 2021-10-05: dev fix
## [fe724c6] 2021-10-05: fix
## [0a5f787] 2021-10-05: add deps
\end{verbatim}

仓库 \href{https://github.com/XiangyunHuang/masr}{masr} 哪些人给我点赞加星了

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gh)}
\NormalTok{my\_repos }\OtherTok{\textless{}{-}} \FunctionTok{gh}\NormalTok{(}\StringTok{"GET /repos/:owner/:repo/stargazers"}\NormalTok{, }\AttributeTok{owner =} \StringTok{"xiangyunhuang"}\NormalTok{, }\AttributeTok{repo =} \StringTok{"masr"}\NormalTok{, }\AttributeTok{page =} \DecValTok{1}\NormalTok{)}
\FunctionTok{vapply}\NormalTok{(my\_repos, }\StringTok{"[["}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"login"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] "dddd1007"        "boltomli"        "JackieMium"      "AXGL"            "fyemath"        
 [6] "rogerclarkgc"    "swsoyee"         "joegaotao"       "YTLogos"         "Accelerator086" 
[11] "yimingfish"      "gaospecial"      "shenxiangzhuang" "shuaiwang88"     "LusiXie"        
[16] "llxlr"           "TingjieGuo"      "oiatz"           "XiaogangHe"      "xwydq"          
[21] "guohongwang1"    "yinandong"       "algony-tony"     "XiangyunHuang"   "perlatex"       
[26] "talegari"        "hao-shefer"      "zhouyisu"        "tsitong"         "liuyadong" 
\end{verbatim}

\begin{figure}

{\centering \href{https://www.ardata.fr/img/hexbin/git.svg}{\includegraphics[width=0.23\linewidth]{images/git} }

}

\caption{Git 代码版本管理}\label{fig:git}
\end{figure}

\href{https://github.com/jeroen}{Jeroen Ooms} 开发的 \href{https://github.com/r-lib/gert}{gert} 包实现在 R 环境中操作 Git，我们可以从幻灯片 --- \href{https://jeroen.github.io/gert2019}{Gert: A minimal git client for R} 学习重点内容。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gert)}
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{git\_log}\NormalTok{(}\AttributeTok{max =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{subset}\NormalTok{(}\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Yihui Xie"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ author), }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"author"}\NormalTok{, }\StringTok{"message"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

提供了 \texttt{git\_rm()}、 \texttt{git\_status()}、 \texttt{git\_add()} 和 \texttt{git\_commit()} 等函数，其中包含 \texttt{git\_reset()} 高级的 Git 操作。此外， 还有 \texttt{git\_branch\_*()} 系列分支操作函数

\hypertarget{git-setup}{%
\subsection{安装配置}\label{git-setup}}

Ubuntu 16.04.5 默认安装的 Git 版本是 2.7.4，下面安装最新版本Git和配置自己的GitHub账户

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  根据官网安装指导 \url{https://git-scm.com/download/linux}，在 Ubuntu 14.04.5 和 Ubuntu 16.04.5 安装最新版 GIT

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:git{-}core/ppa}
\FunctionTok{sudo}\NormalTok{ apt update }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ apt install git}
\end{Highlighting}
\end{Shaded}
\item
  配置账户

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ config }\AttributeTok{{-}{-}global}\NormalTok{ user.name }\StringTok{"你的名字"}
\FunctionTok{git}\NormalTok{ config }\AttributeTok{{-}{-}global}\NormalTok{ user.email }\StringTok{"你的邮件地址"}
\FunctionTok{touch}\NormalTok{ .git{-}credentials}
\CommentTok{\# 记住密码}
\BuiltInTok{echo} \StringTok{"https://username:password@github.com"} \OperatorTok{\textgreater{}\textgreater{}}\NormalTok{ .git{-}credentials}
\FunctionTok{git}\NormalTok{ config }\AttributeTok{{-}{-}global}\NormalTok{ credential.helper store}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

以 Fedora 为例 \href{https://github.com/jonas/tig/blob/master/INSTALL.adoc}{安装 tig}，首先安装必要的依赖，然后从官网下载源码，编译安装，之后切到任意本地 Git 仓库下，输入 \texttt{tig} 就可以看到如图 \ref{fig:tig} 所示的样子了

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install readline{-}devel ncurses{-}devel asciidoc docbook{-}utils xmlto}
\end{Highlighting}
\end{Shaded}

tig 主要用于查看 git 提交的历史日志

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{screenshots/git-tig} 

}

\caption{Git 日志查看器}\label{fig:tig}
\end{figure}

\hypertarget{git-add}{%
\subsection{追踪文件}\label{git-add}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ add .}
\end{Highlighting}
\end{Shaded}

提交新文件(new)和被修改(modified)文件，不包括被删除(deleted)文件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ add }\AttributeTok{{-}u}
\end{Highlighting}
\end{Shaded}

提交被修改(modified)和被删除(deleted)文件，不包括新文件(new)，\texttt{git\ add\ -\/-update}的缩写

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ add }\AttributeTok{{-}A}
\end{Highlighting}
\end{Shaded}

提交所有变化，\texttt{git\ add\ -\/-all} 的缩写

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ init}
\FunctionTok{git}\NormalTok{ remote add origin https://github.com/XiangyunHuang/masr.git}
\FunctionTok{git}\NormalTok{ add }\AttributeTok{{-}A}
\FunctionTok{git}\NormalTok{ commit }\AttributeTok{{-}m} \StringTok{"添加提交说明"}
\FunctionTok{git}\NormalTok{ push }\AttributeTok{{-}u}\NormalTok{ origin master}
\end{Highlighting}
\end{Shaded}

往远程的空的 Github 仓库添加本地文件

\hypertarget{git-upstream}{%
\subsection{合并上流}\label{git-upstream}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ clone }\AttributeTok{{-}{-}depth}\OperatorTok{=}\NormalTok{5 https://github.com/XiangyunHuang/cosx.org.git}
\FunctionTok{git}\NormalTok{ submodule update }\AttributeTok{{-}{-}init} \AttributeTok{{-}{-}recursive}
\end{Highlighting}
\end{Shaded}

查看远程分支

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{cd}\NormalTok{ cosx.org}
\FunctionTok{git}\NormalTok{ remote }\AttributeTok{{-}v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
origin  https://github.com/XiangyunHuang/cosx.org.git (fetch)
origin  https://github.com/XiangyunHuang/cosx.org.git (push)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 添加上流分支}
\FunctionTok{git}\NormalTok{ remote add upstream https://github.com/cosname/cosx.org.git}
\CommentTok{\# 查看远程分支}
\FunctionTok{git}\NormalTok{ remote }\AttributeTok{{-}v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
origin  https://github.com/XiangyunHuang/cosx.org.git (fetch)
origin  https://github.com/XiangyunHuang/cosx.org.git (push)
upstream        https://github.com/cosname/cosx.org.git (fetch)
upstream        https://github.com/cosname/cosx.org.git (push)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 获取上流 commit 并且合并到我的 master 分支}
\FunctionTok{git}\NormalTok{ fetch upstream}
\FunctionTok{git}\NormalTok{ merge upstream/master master}
\FunctionTok{git}\NormalTok{ push origin master}
\end{Highlighting}
\end{Shaded}

\hypertarget{git-lfs}{%
\subsection{大文件支持}\label{git-lfs}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt install git{-}lfs}
\FunctionTok{git}\NormalTok{ lfs install}
\FunctionTok{git}\NormalTok{ lfs track }\StringTok{"*.psd"}
\FunctionTok{git}\NormalTok{ add .gitattributes}
\FunctionTok{git}\NormalTok{ commit }\AttributeTok{{-}m} \StringTok{"track *.psd files using Git LFS"}
\FunctionTok{git}\NormalTok{ push origin master}
\end{Highlighting}
\end{Shaded}

这玩意迟早需要你购买存储空间，慎用

\hypertarget{git-checkout}{%
\subsection{新建分支}\label{git-checkout}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ checkout }\AttributeTok{{-}b}\NormalTok{ stan     }\CommentTok{\# 新建 stan 分支}
\FunctionTok{git}\NormalTok{ branch }\AttributeTok{{-}v}            \CommentTok{\# 查看本地分支 stan 前有个星号标记}
\FunctionTok{git}\NormalTok{ pull }\AttributeTok{{-}{-}rebase}\NormalTok{ git@github.com:XiangyunHuang/cosx.org.git master}
\CommentTok{\# 同步到远程分支 stan}
\FunctionTok{git}\NormalTok{ push }\AttributeTok{{-}{-}set{-}upstream}\NormalTok{ origin stan}
\FunctionTok{git}\NormalTok{ push origin master:stan}

\FunctionTok{git}\NormalTok{ add .}
\FunctionTok{git}\NormalTok{ commit }\AttributeTok{{-}m} \StringTok{"balabala"}
\FunctionTok{git}\NormalTok{ push }\AttributeTok{{-}{-}set{-}upstream}\NormalTok{ origin stan}
\end{Highlighting}
\end{Shaded}

本地新建仓库推送至远程分支

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ remote add origin https://github.com/XiangyunHuang/notesdown.git}
\FunctionTok{git}\NormalTok{ add .}
\FunctionTok{git}\NormalTok{ commit }\AttributeTok{{-}m} \StringTok{"init cos{-}art"}
\CommentTok{\# 此时远程仓库 notesdown 还没有 cos{-}art 分支}
\FunctionTok{git}\NormalTok{ push origin master:cos{-}art}
\end{Highlighting}
\end{Shaded}

位于 \href{https://github.com/liuhui998/gitbook}{Github} \href{http://gitbook.liuhui998.com/}{Git Community Book 中译本}

\hypertarget{git-github-pages}{%
\subsection{创建 Github Pages 站点}\label{git-github-pages}}

基于 GitHub Pages 创建站点用于存放图片和数据

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  在Github上创建一个空的仓库，命名为 uploads，没有 readme.md 和 LICENSE
\item
  在本地创建目录 uploads
\item
  切换到 uploads 目录下
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ init }
\FunctionTok{git}\NormalTok{ checkout }\AttributeTok{{-}b}\NormalTok{ gh{-}pages}
\FunctionTok{git}\NormalTok{ remote add origin https://github.com/XiangyunHuang/uploads.git}
\end{Highlighting}
\end{Shaded}

添加图片或者数据，并且 git add 和 commit 后

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ push }\AttributeTok{{-}{-}set{-}upstream}\NormalTok{ origin gh{-}pages}
\end{Highlighting}
\end{Shaded}

这样仓库 uploads 只包含 gh-pages 分支，数据地址即为以日期为分割线

\url{https://xiangyunhuang.github.io/uploads/data/eqList2018_05_18.xls}

\hypertarget{blog-hugo-theme}{%
\subsection{博客主题}\label{blog-hugo-theme}}

初始化博客网站

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ subtree add }\AttributeTok{{-}{-}squash} \AttributeTok{{-}{-}prefix}\OperatorTok{=}\NormalTok{themes/hugo{-}lithium }\DataTypeTok{\textbackslash{}}
\NormalTok{  git@github.com:yihui/hugo{-}lithium.git master}
\end{Highlighting}
\end{Shaded}

在 Github 创建新的空仓库，本地创建空的目录 xiangyun

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{cd}\NormalTok{ xiangyun}
\FunctionTok{git}\NormalTok{ init}
\FunctionTok{git}\NormalTok{ remote add origin https://github.com/XiangyunHuang/xiangyun.git}

\FunctionTok{git}\NormalTok{ add .gitignore}
\FunctionTok{git}\NormalTok{ commit }\AttributeTok{{-}m} \StringTok{\textquotesingle{}upload\textquotesingle{}} 
\FunctionTok{git}\NormalTok{ push }\AttributeTok{{-}{-}set{-}upstream}\NormalTok{ origin master}
\end{Highlighting}
\end{Shaded}

\texttt{git\ subtree} 将另外一个仓库收缩为当前仓库的一个目录，且只产生一条提交记录

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 子库分支}
\FunctionTok{git}\NormalTok{ subtree add }\AttributeTok{{-}{-}squash} \AttributeTok{{-}{-}prefix}\OperatorTok{=}\NormalTok{themes/hugo{-}xmag }\DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}m} \StringTok{"add hugo{-}xmag"}\NormalTok{ git@github.com:yihui/hugo{-}xmag.git master }
\CommentTok{\# 或者子库分支}
\FunctionTok{git}\NormalTok{ subtree add }\AttributeTok{{-}{-}squash} \AttributeTok{{-}{-}prefix}\OperatorTok{=}\NormalTok{themes/hugo{-}xmag }\DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}m} \StringTok{"add hugo{-}xmag"}\NormalTok{ https://github.com/yihui/hugo{-}xmag.git master }

\CommentTok{\# 移除 git subtree 添加的 hugo 主题}
\FunctionTok{git}\NormalTok{ filter{-}branch }\AttributeTok{{-}{-}index{-}filter} \StringTok{\textquotesingle{}git rm {-}{-}cached {-}{-}ignore{-}unmatch {-}rf themes/hugo{-}xmag\textquotesingle{}} \AttributeTok{{-}{-}prune{-}empty} \AttributeTok{{-}f}\NormalTok{ HEAD}
\end{Highlighting}
\end{Shaded}

\hypertarget{transform-repo}{%
\subsection{修改远程仓库的位置}\label{transform-repo}}

有时候我们将自己的仓库转移给别人/组织，或者我们将远程仓库的名字改变了，这时候需要修改远程仓库的位置。比如最近我将博客仓库从 \url{https://github.com/XiangyunHuang/xiangyun} 转移到 \url{https://github.com/rbind/xiangyun}

\begin{quote}
转移前
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ remote }\AttributeTok{{-}v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
origin  https://github.com/XiangyunHuang/xiangyun.git (fetch)
origin  https://github.com/XiangyunHuang/xiangyun.git (push)
\end{verbatim}

转移命令

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ remote set{-}url origin https://github.com/rbind/xiangyun.git}
\end{Highlighting}
\end{Shaded}

\begin{quote}
转移后
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ remote }\AttributeTok{{-}v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
origin  https://github.com/rbind/xiangyun.git (fetch)
origin  https://github.com/rbind/xiangyun.git (push)
\end{verbatim}

\hypertarget{count-commits}{%
\subsection{统计代码仓库的提交量}\label{count-commits}}

比如统计之都的主站仓库，提交量最大的20个人

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ shortlog }\AttributeTok{{-}sn} \KeywordTok{|} \FunctionTok{head} \AttributeTok{{-}n}\NormalTok{ 20}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  153   Dawei Lang
  106   Yihui Xie
  89    Beilei Bian
  46    王佳
  42    雷博文
  39    Ryan Feng Lin
  35    Xiangyun Huang
  32    fanchao
  32    闫晗
  30    Lin Feng
  28    Jiaao Yu
  25    fyears
  24    Yixuan Qiu
  24    Miao YU
  22    Yuxuan Li
  22    qinwf
  20    Alice敏
  19    yanshi
  18    Shuyi.Yang
  13    黄湘云
\end{verbatim}

\hypertarget{multi-accounts}{%
\subsection{账户共存}\label{multi-accounts}}

\begin{quote}
本节介绍如何使 Gitlab/Github 账户共存在一台机器上
\end{quote}

如何生成 SSH 密钥见 Github 文档 --- \href{https://help.github.com/cn/github/authenticating-to-github/connecting-to-github-with-ssh}{使用 SSH 连接到 GitHub}。有了密钥之后只需在目录 \texttt{\textasciitilde{}/.ssh} 下创建一个配置文件 config

生成 SSH Key

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ssh{-}keygen} \AttributeTok{{-}t}\NormalTok{ rsa }\AttributeTok{{-}f}\NormalTok{ \textasciitilde{}/.ssh/id\_rsa\_github }\AttributeTok{{-}C} \StringTok{"name1@xxx1.com"}
\FunctionTok{ssh{-}keygen} \AttributeTok{{-}t}\NormalTok{ rsa }\AttributeTok{{-}f}\NormalTok{ \textasciitilde{}/.ssh/id\_rsa\_gitlab }\AttributeTok{{-}C} \StringTok{"name2@xxx2.com"}
\end{Highlighting}
\end{Shaded}

将 GitHub/GitLab 公钥分别上传至服务器，然后创建配置文件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{touch}\NormalTok{ \textasciitilde{}/.ssh/config}
\end{Highlighting}
\end{Shaded}

配置文件内容如下

\begin{verbatim}
#
# Github
#
Host github.com // 个人的代码仓库服务器地址
HostName github.com
User XiangyunHuang
IdentityFile ~/.ssh/id_rsa_github

#
# company
#
Host xx.xx.xx.xx //
IdentityFile ~/.ssh/id_rsa_gitlab
\end{verbatim}

配置成功，你会看到

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ssh} \AttributeTok{{-}T}\NormalTok{ git@xx.xx.xx.xx}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Welcome to GitLab, xiangyunhuang!
\end{verbatim}

和

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ssh} \AttributeTok{{-}T}\NormalTok{ git@github.com}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Hi XiangyunHuang! You've successfully authenticated, but GitHub does not provide shell access.
\end{verbatim}

\hypertarget{git-crlf}{%
\subsection{回车换行}\label{git-crlf}}

CR (Carriage Return) 表示回车，LF (Line Feed) 表示换行，Windows 下用回车加换行表示下一行，UNIX/Linux 采用换行符 (LF) 表示下一行，MAC OS 则采用回车符 (CR) 表示下一行

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ config }\AttributeTok{{-}{-}global}\NormalTok{ core.autocrlf false}
\end{Highlighting}
\end{Shaded}

\hypertarget{git-submodule}{%
\subsection{子模块}\label{git-submodule}}

\begin{itemize}
\tightlist
\item
  添加子模块到目录 \texttt{templates/} 下
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ submodule add git://github.com/jgm/pandoc{-}templates.git templates}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  移除子模块
\end{itemize}

\url{https://stackoverflow.com/questions/1260748/how-do-i-remove-a-submodule/}

\hypertarget{git-clone}{%
\subsection{克隆项目}\label{git-clone}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ clone }\AttributeTok{{-}{-}depth}\OperatorTok{=}\NormalTok{10 }\AttributeTok{{-}{-}branch}\OperatorTok{=}\NormalTok{master }\AttributeTok{{-}{-}recursive} \DataTypeTok{\textbackslash{}}
\NormalTok{    git@github.com:XiangyunHuang/pandoc4everything.git}
\end{Highlighting}
\end{Shaded}

\hypertarget{git-create-pr}{%
\subsection{创建 PR}\label{git-create-pr}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ pull }\AttributeTok{{-}{-}rebase}\NormalTok{ git@github.com:yihui/xaringan.git master}
\CommentTok{\# then force push to your master branch}
\end{Highlighting}
\end{Shaded}

参考 \url{https://github.com/yihui/xaringan/pull/107}

\begin{quote}
I don't recommend you to use your master branch for pull requests, because all commits will be squashed before merging, e.g.~c2c2055 Then you will have some trouble with syncing your master branch with the master branch here (your choices are (1) delete your repo and fork again; or (2) force push; either option is not good). For pull requests, I recommend that you always use different branches for different pull requests.
\end{quote}

\hypertarget{git-edit-pr}{%
\subsection{修改 PR}\label{git-edit-pr}}

\begin{quote}
之前一直有一个思想在阻止自己，就是别人的 repo 我是不能修改的，但是在这里，我拥有修改原始仓的权限，那么别人的复制品衍生的分支，我也有修改权限
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ fetch origin refs/pull/771/head:patch{-}2}
\CommentTok{\# 771 是 PR 对应的编号}
\FunctionTok{git}\NormalTok{ checkout patch{-}2}

\CommentTok{\# 你的修改}

\FunctionTok{git}\NormalTok{ add }\AttributeTok{{-}u}
\FunctionTok{git}\NormalTok{ commit }\AttributeTok{{-}m} \StringTok{"描述你的修改"}

\FunctionTok{git}\NormalTok{ remote add LalZzy https://github.com/LalZzy/cosx.org.git}

\FunctionTok{git}\NormalTok{ push }\AttributeTok{{-}{-}set{-}upstream}\NormalTok{ LalZzy patch{-}2}
\end{Highlighting}
\end{Shaded}

\begin{quote}
整理自统计之都论坛的讨论 \url{https://d.cosx.org/d/420363}
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  GitHub/Git 小抄英文版 \url{https://www.runoob.com/manual/github-git-cheat-sheet.pdf}
\item
  GitHub/Git 小抄中文版 \url{https://github.github.com/training-kit/downloads/zh_CN/github-git-cheat-sheet/}
\item
  Github 秘籍 \url{https://github.com/tiimgreen/github-cheat-sheet/blob/master/README.zh-cn.md}
\item
  Git 简明指南 \url{https://rogerdudler.github.io/git-guide/index.zh.html}
\item
  Git 奇技淫巧 \url{https://github.com/521xueweihan/git-tips}
\item
  Git 官方书籍 \url{https://git-scm.com/book/zh/v2}
\item
  Git 时代的 VIM 不完全使用教程 \url{http://beiyuu.com/git-vim-tutorial}
\item
  最佳搭档：利用 SSH 及其配置文件节省你的生命 \url{https://liam.page/2017/09/12/rescue-your-life-with-SSH-config-file/}
\end{enumerate}

\hypertarget{sec-pandoc}{%
\section{Pandoc 文档处理}\label{sec-pandoc}}

Pandoc 是一个万能文档转化器，安装 pandoc，下载网址 \url{https://github.com/jgm/pandoc/releases/latest}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install gdebi{-}core}
\FunctionTok{wget}\NormalTok{ https://github.com/jgm/pandoc/releases/download/2.9.2/pandoc{-}2.9.2{-}1{-}amd64.deb}
\FunctionTok{sudo}\NormalTok{ chmod +x pandoc{-}2.9.2{-}1{-}amd64.deb}
\FunctionTok{sudo}\NormalTok{ gdebi pandoc{-}2.9.2{-}1{-}amd64.deb}
\end{Highlighting}
\end{Shaded}

rmarkdown 包裹了 Pandoc 工具，使用 \texttt{rmarkdown::render()} 函数即可将 R Markdown 文档转化为 HTML、LaTeX 和 Markdown 等格式。

\hypertarget{sec-calibre}{%
\section{Calibre 书籍管理}\label{sec-calibre}}

\href{https://calibre-ebook.com}{Calibre} 是一款电子书转化和管理软件，首先安装 calibre

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo} \AttributeTok{{-}v} \KeywordTok{\&\&} \FunctionTok{wget} \AttributeTok{{-}nv} \AttributeTok{{-}O{-}}\NormalTok{ https://download.calibre{-}ebook.com/linux{-}installer.sh }\KeywordTok{|} \FunctionTok{sudo}\NormalTok{ sh /dev/stdin}
\end{Highlighting}
\end{Shaded}

calibre 可以将 epub 格式电子书文档转化为 mobi 格式，bookdown 已经给这个工具穿上了一件马甲，用户只需调用 \texttt{bookdown::calibre()} 函数即可实现电子书格式的转换。

\hypertarget{sec-ImageMagick}{%
\section{ImageMagick 图像处理}\label{sec-ImageMagick}}

图像的各种操作，包括合成、转换、旋转等等

首先安装 ImageMagick 软件包中的 convert 程序

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{asy} \AttributeTok{{-}f}\NormalTok{ jpg test.asy}
\end{Highlighting}
\end{Shaded}

指定分辨率

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{convert} \AttributeTok{{-}geometry}\NormalTok{ 1000x3000 }\AttributeTok{{-}density}\NormalTok{ 300 }\AttributeTok{{-}units}\NormalTok{ PixelsPerInch example.eps example.png}
\end{Highlighting}
\end{Shaded}

这样不改变图像的像素数，只是给出一个每个像素应该显示多大的提示。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{convert} \AttributeTok{{-}quality}\NormalTok{ 100 }\AttributeTok{{-}density}\NormalTok{ 300x300 filename.pdf filename.png}
\end{Highlighting}
\end{Shaded}

高质量大图，给定像素，转化 eps 格式图片，需要先安装 Ghostscript

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{convert} \AttributeTok{{-}geometry}\NormalTok{ 1000x3000 example.eps example.png}
\end{Highlighting}
\end{Shaded}

多页的 PDF 文件转化为多张 PNG 图片

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{convert} \AttributeTok{{-}quality}\NormalTok{ 100 }\AttributeTok{{-}density}\NormalTok{ 300x300  input.pdf output.png}
\end{Highlighting}
\end{Shaded}

将多页 PDF 文件合成为 GIF 动图

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{convert} \AttributeTok{{-}delay}\NormalTok{ 60 }\AttributeTok{{-}density}\NormalTok{ 300x300 }\AttributeTok{{-}background}\NormalTok{ white }\AttributeTok{{-}alpha}\NormalTok{ remove }\DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}dispose}\NormalTok{ previous pdf{-}mobile.pdf }\AttributeTok{{-}layers}\NormalTok{ coalesce pdf{-}mobile.gif}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-optipng}{%
\section{OptiPNG 图片优化}\label{sec-optipng}}

\href{http://optipng.sourceforge.net/}{OptiPNG} 是一个非常好的图片压缩、优化工具

现在，我们设置 chunk 选项 \texttt{optipng} 为非空(non-\texttt{NULL})的值，例如，\texttt{\textquotesingle{}\textquotesingle{}} 去激活这个 hook （益辉称之为钩子，这里勾的是 optipng 这个图片优化工具）

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{knitr}\SpecialCharTok{::}\NormalTok{knit\_hooks}\SpecialCharTok{$}\FunctionTok{set}\NormalTok{(}\AttributeTok{optipng =}\NormalTok{ knitr}\SpecialCharTok{::}\NormalTok{hook\_optipng)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{other-softwares_files/figure-latex/optipng-1} 

}

\caption{没有优化}\label{fig:optipng}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{other-softwares_files/figure-latex/optimize-png-1} 

}

\caption{优化}\label{fig:optimize-png}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{optipng} \AttributeTok{{-}o5}\NormalTok{ filename.png}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-pdfcrop}{%
\section{PDFCrop 裁剪边空}\label{sec-pdfcrop}}

\href{http://pdfcrop.sourceforge.net/}{PDFCrop} 可将 PDF 图片中留白的部分裁去，再也不用纠结 par 了

\hypertarget{sec-phantomjs}{%
\section{PhantomJS 网页截图}\label{sec-phantomjs}}

Winston Chang 开发了 \href{https://github.com/wch/webshot}{webshot} 包网页截图，它依赖 \href{https://github.com/ariya/phantomjs/}{PhantomJS}，所以首先需要安装

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"webshot"}\NormalTok{)}
\NormalTok{webshot}\SpecialCharTok{::}\FunctionTok{install\_phantomjs}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

以截取网页 \url{https://www.r-project.org/} 为例，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(webshot)}
\FunctionTok{webshot}\NormalTok{(}\StringTok{"https://www.r{-}project.org/"}\NormalTok{, }\StringTok{"r.png"}\NormalTok{)}
\FunctionTok{webshot}\NormalTok{(}\StringTok{"https://www.r{-}project.org/"}\NormalTok{, }\StringTok{"r.pdf"}\NormalTok{) }\CommentTok{\# Can also output to PDF}
\end{Highlighting}
\end{Shaded}

还可以截取 R Markdown 文档内容，注意是先编译 R Markdown 文档为 HTML 文档，然后截取网页

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rmdshot}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"examples/knitr{-}minimal.Rmd"}\NormalTok{, }\AttributeTok{package =} \StringTok{"knitr"}\NormalTok{), }\AttributeTok{file =} \StringTok{"screenshots/knitr{-}minimal.png"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

裁剪出特定大小的图片，需要额外的系统依赖 GraphicsMagick (recommended) or ImageMagick installed

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Can specify pixel dimensions for resize()}
\FunctionTok{webshot}\NormalTok{(}\StringTok{"https://www.r{-}project.org/"}\NormalTok{, }\StringTok{"r{-}small.png"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{resize}\NormalTok{(}\StringTok{"400x"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{shrink}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
** Processing: r-small.png
400x442 pixels, 4x8 bits/pixel, RGB+alpha
Reducing image to 3x8 bits/pixel, RGB
Input IDAT size = 70570 bytes
Input file size = 70867 bytes

Trying:
  zc = 9  zm = 8  zs = 0  f = 0         IDAT size = 59441
  zc = 9  zm = 8  zs = 1  f = 0
  zc = 1  zm = 8  zs = 2  f = 0
  zc = 9  zm = 8  zs = 3  f = 0
  zc = 9  zm = 8  zs = 0  f = 5
  zc = 9  zm = 8  zs = 1  f = 5
  zc = 1  zm = 8  zs = 2  f = 5
  zc = 9  zm = 8  zs = 3  f = 5
                               
Selecting parameters:
  zc = 9  zm = 8  zs = 0  f = 0         IDAT size = 59441

Output IDAT size = 59441 bytes (11129 bytes decrease)
Output file size = 59714 bytes (11153 bytes = 15.74% decrease)
\end{verbatim}

\hypertarget{sec-inkscape}{%
\section{Inkscape 矢量绘图}\label{sec-inkscape}}

\href{https://inkscape.org/}{Inkscape} 是一款开源、免费、跨平台的矢量绘图软件。是替代 Adobe Illustrator（简称 AI） 最佳工具，没有之一

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Ubuntu 20.04 及之前版本}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository ppa:inkscape.dev/stable}
\FunctionTok{sudo}\NormalTok{ apt update}
\FunctionTok{sudo}\NormalTok{ apt install inkscape}
\end{Highlighting}
\end{Shaded}

PDF 图片格式转化为 SVG 格式

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{inkscape} \AttributeTok{{-}l}\NormalTok{ output{-}filename.svg input{-}filename.pdf}
\end{Highlighting}
\end{Shaded}

SVG 转 PDF 格式

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{inkscape} \AttributeTok{{-}f}\NormalTok{ input{-}filename.svg }\AttributeTok{{-}A}\NormalTok{ output{-}filename.pdf}
\end{Highlighting}
\end{Shaded}

Jeroen Ooms 开发的 \href{https://github.com/jeroen/rsvg}{rsvg} 包支持将 SVG 格式图片导出为 PNG、PDF、PS 等格式。使用它可以批量将 SVG 格式文件转化为其它格式文件，比如 PDF（\texttt{rsvg::rsvg\_pdf}），PS （\texttt{rsvg::rsvg\_ps}）和 PNG（\texttt{rsvg::rsvg\_png}）

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{svg\_paths }\OtherTok{=} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"images"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.svg"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ T)}
\ControlFlowTok{for}\NormalTok{ (svg }\ControlFlowTok{in}\NormalTok{ svg\_paths) \{}
\NormalTok{  rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_pdf}\NormalTok{(svg, }\AttributeTok{file =} \FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern  =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.svg"}\NormalTok{, }\AttributeTok{replacement=}  \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf"}\NormalTok{, svg))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-qpdf}{%
\section{QPDF PDF 文件操作}\label{sec-qpdf}}

Jeroen Ooms 开发的另一个 \href{https://github.com/ropensci/qpdf}{qpdf} 包将 C++ 库 \href{https://github.com/qpdf/qpdf}{qpdf} 搬运到 R 环境中，用于 PDF 文件的拆分 \texttt{pdf\_split()}，组合 \texttt{pdf\_combine()}，加密（ 传递 \texttt{password} 参数值即可加密），提取 \texttt{pdf\_subset()} 和压缩 \texttt{pdf\_compress()} 等。下面以组合为例，就是将多个 PDF 文件合成一个 PDF 文件。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(qpdf)}
\NormalTok{pdf\_paths }\OtherTok{=} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"images"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.pdf"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ T)}
\FunctionTok{pdf\_combine}\NormalTok{(}\AttributeTok{input =}\NormalTok{ pdf\_paths, }\AttributeTok{output =} \StringTok{"images/all.pdf"}\NormalTok{, }\AttributeTok{password =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

PDF 操作：价值数百美元的开源替代方案，参考 Adobe Acrobat 的功能

\hypertarget{sec-nomnoml}{%
\section{UML 标准建模图}\label{sec-nomnoml}}

UML (Unified Modeling Language) 表示统一建模语言

\begin{figure}

{\centering \includegraphics{other-softwares_files/figure-latex/convert-figure-1} 

}

\caption{图片制作、合成、优化、转换等常用工具}\label{fig:convert-figure}
\end{figure}

\href{https://github.com/javierluraschi}{Javier Luraschi} 将 UML 绘图库 \href{https://github.com/skanaar/nomnoml}{nomnoml} 引入 R 社区，开发了 \href{https://github.com/rstudio/nomnoml}{nomnoml} 包，相比于 DiagrammeR 包，它显得非常轻量，网站 \url{https://www.nomnoml.com/} 还可以在线编辑、预览、下载 UML 图。 \textbf{webshot} 包可以将网页截图并插入 PDF 文档中。其它制作图形的工具见 \ref{fig:convert-figure}。

nomnoml 调 webshot 包对网页截图生成 PNG 格式的图片，其中 webshot 调 phantomjs 软件。 nomnoml 制作 R Markdown 生态图，导出为 PNG 格式

安装 nomnoml

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"nomnoml"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

安装 PhantomJS

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{brew}\NormalTok{ install }\AttributeTok{{-}{-}cask}\NormalTok{ phantomjs }
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nomnoml}\SpecialCharTok{::}\FunctionTok{nomnoml}\NormalTok{(}\StringTok{" }
\StringTok{\#stroke: \#26A63A}
\StringTok{\#.box: dashed visual=ellipse}
\StringTok{\#direction: down}

\StringTok{[\textless{}box\textgreater{}HTML]       {-}\textgreater{} [网页三剑客]}
\StringTok{[\textless{}box\textgreater{}JavaScript] {-}\textgreater{} [网页三剑客]}
\StringTok{[\textless{}box\textgreater{}CSS]        {-}\textgreater{} [\textless{}table\textgreater{}网页三剑客|htmlwidgets|htmltools||sass|bslib||thematic|jquerylib]}

\StringTok{[设计布局|bs4Dash|flexdashboard|shinydashboard] {-}\textgreater{} [\textless{}actor\textgreater{}开发应用|R Shiny]}
\StringTok{[设计交互|waiter|shinyFeedback|shinyToastify] {-}\textgreater{} [\textless{}actor\textgreater{}开发应用|R Shiny]}
\StringTok{[权限代理|shinyproxy|shinyauthr|shinymanager] {-}\textgreater{} [\textless{}actor\textgreater{}开发应用|R Shiny]}

\StringTok{[网页三剑客]  {-}\textgreater{} [\textless{}actor\textgreater{}开发应用|R Shiny]}
\StringTok{[网页三剑客]  {-}\textgreater{} [\textless{}actor\textgreater{}开发应用|R Shiny]}
\StringTok{[网页三剑客]  {-}\textgreater{} [\textless{}actor\textgreater{}开发应用|R Shiny]}

\StringTok{[开发应用] \textless{}{-} [\textless{}table\textgreater{}处理数据|Base R|SQL||data.table|dplyr||tidyr|purrr]}
\StringTok{[开发应用] \textless{}{-} [\textless{}table\textgreater{}制作表格|DT|gt||reactable|formattable||kableExtra|sparkline]}
\StringTok{[开发应用] \textless{}{-} [\textless{}table\textgreater{}制作图形|ggplot2|plotly||echarts4r|leaflet||dygraphs|visNetwork]}
\StringTok{"}\NormalTok{, }\AttributeTok{png =} \StringTok{"shiny{-}app.png"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-graphviz}{%
\section{Graphviz 流程图}\label{sec-graphviz}}

Graphviz 官网 \url{http://www.graphviz.org/}，常用于绘制流程图，广泛用于 tensorflow 和 mxnet 的模型描述中

\begin{figure}

{\centering \includegraphics{other-softwares_files/figure-latex/data-workflow-1} 

}

\caption{数据分析流程图}\label{fig:data-workflow}
\end{figure}

\href{https://github.com/rich-iannone/DiagrammeR}{\textbf{DiagrammeR}} 包将 Graphviz 引入 R 语言

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DiagrammeR)}
\FunctionTok{library}\NormalTok{(DiagrammeRsvg)}
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{library}\NormalTok{(rsvg)}

\NormalTok{graph }\OtherTok{\textless{}{-}}
  \StringTok{"graph \{}
\StringTok{        rankdir=LR; // Left to Right, instead of Top to Bottom}
\StringTok{        a {-}{-} \{ b c d \};}
\StringTok{        b {-}{-} \{ c e \};}
\StringTok{        c {-}{-} \{ e f \};}
\StringTok{        d {-}{-} \{ f g \};}
\StringTok{        e {-}{-} h;}
\StringTok{        f {-}{-} \{ h i j g \};}
\StringTok{        g {-}{-} k;}
\StringTok{        h {-}{-} \{ o l \};}
\StringTok{        i {-}{-} \{ l m j \};}
\StringTok{        j {-}{-} \{ m n k \};}
\StringTok{        k {-}{-} \{ n r \};}
\StringTok{        l {-}{-} \{ o m \};}
\StringTok{        m {-}{-} \{ o p n \};}
\StringTok{        n {-}{-} \{ q r \};}
\StringTok{        o {-}{-} \{ s p \};}
\StringTok{        p {-}{-} \{ s t q \};}
\StringTok{        q {-}{-} \{ t r \};}
\StringTok{        r {-}{-} t;}
\StringTok{        s {-}{-} z;}
\StringTok{        t {-}{-} z;}
\StringTok{    \}}
\StringTok{"}
\CommentTok{\# 导出图形}
\FunctionTok{grViz}\NormalTok{(graph) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  export\_svg }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ charToRaw }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{rsvg\_pdf}\NormalTok{(}\StringTok{"graph.pdf"}\NormalTok{)}
\FunctionTok{grViz}\NormalTok{(graph) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  export\_svg }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ charToRaw }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{rsvg\_png}\NormalTok{(}\StringTok{"graph.png"}\NormalTok{)}
\FunctionTok{grViz}\NormalTok{(graph) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  export\_svg }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ charToRaw }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{rsvg\_svg}\NormalTok{(}\StringTok{"graph.svg"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-latex}{%
\section{LaTeX 排版工具}\label{sec-latex}}

另外值得一提的是 TikZ 和 PGF（Portable Graphic Format）宏包，支持强大的绘图功能，图形质量达到出版级别，详细的使用说明见宏包手册 \url{https://pgf-tikz.github.io/pgf/pgfmanual.pdf}。

\hypertarget{sub:latex-tinytex}{%
\subsection{TinyTeX 发行版}\label{sub:latex-tinytex}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tinytex)}
\CommentTok{\# 升级 TinyTeX 发行版}
\NormalTok{upgrade\_tinytex }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{repos =} \ConstantTok{NULL}\NormalTok{) \{}
  \CommentTok{\# 此处还要考虑用户输错的情况和选择离用户最近（快）的站点}
  \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(repos)) repos }\OtherTok{=} \StringTok{"https://mirrors.tuna.tsinghua.edu.cn/CTAN/"}
  
\NormalTok{  file\_ext }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (.Platform}\SpecialCharTok{$}\NormalTok{OS.type }\SpecialCharTok{==} \StringTok{"windows"}\NormalTok{) }\StringTok{".exe"} \ControlFlowTok{else} \StringTok{".sh"}
\NormalTok{  tlmgr\_url }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(repos, }\StringTok{"/systems/texlive/tlnet/update{-}tlmgr{-}latest"}\NormalTok{, file\_ext, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  file\_name }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"update{-}tlmgr{-}latest"}\NormalTok{, file\_ext)}
  \FunctionTok{download.file}\NormalTok{(}\AttributeTok{url =}\NormalTok{ tlmgr\_url, }\AttributeTok{destfile =}\NormalTok{ file\_name, }
                \AttributeTok{mode =} \ControlFlowTok{if}\NormalTok{ (.Platform}\SpecialCharTok{$}\NormalTok{OS.type }\SpecialCharTok{==} \StringTok{"windows"}\NormalTok{) }\StringTok{"wb"} \ControlFlowTok{else} \StringTok{"w"}\NormalTok{)}
  
  \CommentTok{\# window下 命令行窗口下 如何执行 exe 文件}
  \ControlFlowTok{if}\NormalTok{(.Platform}\SpecialCharTok{$}\NormalTok{OS.type }\SpecialCharTok{==} \StringTok{"windows"}\NormalTok{)\{}
    \FunctionTok{shell.exec}\NormalTok{(}\AttributeTok{file =}\NormalTok{ file\_name)}
    \FunctionTok{file.remove}\NormalTok{(}\StringTok{"update{-}tlmgr{-}latest.exe"}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{else}\NormalTok{\{}
    \FunctionTok{system}\NormalTok{(}\StringTok{"sudo sh update{-}tlmgr{-}latest.sh  {-}{-} {-}{-}upgrade"}\NormalTok{)}
    
    \FunctionTok{file.remove}\NormalTok{(}\StringTok{"update{-}tlmgr{-}latest.sh"}\NormalTok{)}
\NormalTok{  \}}
  
  \CommentTok{\# 类似地 Linux 下执行 sh}
  \CommentTok{\# 升级完了 删除 update{-}tlmgr{-}latest.exe}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/wch}{Winston Chang} 整理了一份 LaTeX 常用命令速查小抄 \url{https://wch.github.io/latexsheet/latexsheet.pdf}

\hypertarget{subsec-tlmgr-setup}{%
\subsection{安装和更新}\label{subsec-tlmgr-setup}}

tlmgr (TeXLive Manager) 是 LaTeX 包管理器

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 就近选择 CTAN 镜像站点}
\ExtensionTok{tlmgr}\NormalTok{ option repository https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/tlnet}
\ExtensionTok{tlmgr}\NormalTok{ option repository http://mirror.ctan.org/systems/texlive/tlnet}
\CommentTok{\# 可更新的 TeX 包列表}
\ExtensionTok{tlmgr}\NormalTok{ update }\AttributeTok{{-}{-}list}
\CommentTok{\# 更新所有已经安装的 TeX 包}
\ExtensionTok{tlmgr}\NormalTok{ update }\AttributeTok{{-}{-}all}
\CommentTok{\# 更新 tlmgr 管理器本身}
\ExtensionTok{tlmgr}\NormalTok{ update }\AttributeTok{{-}{-}self}
\CommentTok{\# 安装}
\ExtensionTok{tlmgr}\NormalTok{ install ctex fandol}
\CommentTok{\# 列出套装}
\ExtensionTok{tlmgr}\NormalTok{ list schemes}
\ExtensionTok{tlmgr}\NormalTok{ list collections}
\CommentTok{\# 列出已经安装的 TeX 包}
\ExtensionTok{tlmgr}\NormalTok{ list }\AttributeTok{{-}{-}only{-}installed}
\CommentTok{\# 安装 GPG 公钥（只限Win/Mac）}
\ExtensionTok{tlmgr} \AttributeTok{{-}{-}repository}\NormalTok{ http://www.preining.info/tlgpg/ install tlgpg}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-tlmgr-search}{%
\subsection{查询和搜索}\label{subsec-tlmgr-search}}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr}\NormalTok{ search }\PreprocessorTok{*}\NormalTok{what}\PreprocessorTok{*}
\end{Highlighting}
\end{Shaded}

参数 \texttt{\textbackslash{}*what\textbackslash{}*} 是正则表达式

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr}\NormalTok{ search }\AttributeTok{{-}{-}file}\NormalTok{ tikz.sty}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## langsci:
##  texmf-dist/tex/xelatex/langsci/langsci-tikz.sty
## pgf:
##  texmf-dist/tex/latex/pgf/frontendlayer/tikz.sty
\end{verbatim}

等价于

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tinytex}\SpecialCharTok{::}\FunctionTok{tlmgr\_search}\NormalTok{(}\StringTok{\textquotesingle{}tikz.sty\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

这样，我们就可以知道要使用 \texttt{\textbackslash{}usepackage\{tikz\}} 就得先安装 \textbf{pgf} 包，此外，管道命令也是支持的

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr}\NormalTok{ search }\AttributeTok{{-}{-}file}\NormalTok{ font }\KeywordTok{|} \FunctionTok{grep}\NormalTok{ math}
\end{Highlighting}
\end{Shaded}

查询 CTAN 仓库列表

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr}\NormalTok{ repository list}
\end{Highlighting}
\end{Shaded}

一般地， 只显示已安装的 LaTeX 宏包的名字及大小

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr}\NormalTok{ info }\AttributeTok{{-}{-}list} \AttributeTok{{-}{-}only{-}installed} \AttributeTok{{-}{-}data}\NormalTok{ name,size}
\end{Highlighting}
\end{Shaded}

更多命令详见\href{https://www.tug.org/texlive/doc/tlmgr.html\#install-option-...-pkg}{tlmgr 管理器手册}

\hypertarget{subsec-latex-tikz}{%
\subsection{TikZ 绘图工具}\label{subsec-latex-tikz}}

TikZ 绘制书籍封面 \url{https://latexdraw.com/how-to-create-a-beautiful-cover-page-in-latex-using-tikz/}

TikZ 绘制知识清单，书籍章节结构等 \url{https://www.latexstudio.net/index/lists/barsearch/author/1680.html}

更多例子参考 \url{https://github.com/FriendlyUser/LatexDiagrams}

\hypertarget{sec-octave}{%
\section{Octave 科学计算}\label{sec-octave}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\%\% fig1}
\NormalTok{tx }\OperatorTok{=}\NormalTok{ ty }\OperatorTok{=} \FunctionTok{linspace}\NormalTok{ (}\OperatorTok{{-}}\FloatTok{8}\OperatorTok{,} \FloatTok{8}\OperatorTok{,} \FloatTok{41}\NormalTok{)}\OperatorTok{\textquotesingle{};}
\NormalTok{[xx}\OperatorTok{,}\NormalTok{ yy] }\OperatorTok{=} \FunctionTok{meshgrid}\NormalTok{ (tx}\OperatorTok{,}\NormalTok{ ty)}\OperatorTok{;}
\NormalTok{r }\OperatorTok{=} \FunctionTok{sqrt}\NormalTok{ (xx }\OperatorTok{.\^{}} \FloatTok{2} \OperatorTok{+}\NormalTok{ yy }\OperatorTok{.\^{}} \FloatTok{2}\NormalTok{) }\OperatorTok{+} \BuiltInTok{eps}\OperatorTok{;}
\NormalTok{tz }\OperatorTok{=} \FunctionTok{sin}\NormalTok{ (r) }\OperatorTok{./}\NormalTok{ r}\OperatorTok{;}
\FunctionTok{mesh}\NormalTok{ (tx}\OperatorTok{,}\NormalTok{ ty}\OperatorTok{,}\NormalTok{ tz)}\OperatorTok{;}
\FunctionTok{xlabel}\NormalTok{ (}\StringTok{"tx"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{ylabel}\NormalTok{ (}\StringTok{"ty"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{zlabel}\NormalTok{ (}\StringTok{"tz"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{title}\NormalTok{ (}\StringTok{"3{-}D Sombrero plot"}\NormalTok{)}\OperatorTok{;}


\CommentTok{\% fig2}
\NormalTok{x }\OperatorTok{=} \FloatTok{0}\OperatorTok{:}\FloatTok{0.01}\OperatorTok{:}\FloatTok{3}\OperatorTok{;}
\NormalTok{hf }\OperatorTok{=} \FunctionTok{figure}\NormalTok{ ()}\OperatorTok{;}
\FunctionTok{plot}\NormalTok{ (x}\OperatorTok{,} \FunctionTok{erf}\NormalTok{ (x))}\OperatorTok{;}
\FunctionTok{hold}\NormalTok{ on}\OperatorTok{;}
\FunctionTok{plot}\NormalTok{ (x}\OperatorTok{,}\NormalTok{ x}\OperatorTok{,} \StringTok{"r"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{axis}\NormalTok{ ([}\FloatTok{0}\OperatorTok{,} \FloatTok{3}\OperatorTok{,} \FloatTok{0}\OperatorTok{,} \FloatTok{1}\NormalTok{])}\OperatorTok{;}
\FunctionTok{text}\NormalTok{ (}\FloatTok{0.65}\OperatorTok{,} \FloatTok{0.6175}\OperatorTok{,}\NormalTok{ [}\StringTok{\textquotesingle{}$\textbackslash{}displaystyle\textbackslash{}leftarrow x = \{2\textbackslash{}over\textbackslash{}sqrt\{\textbackslash{}pi\}\}\textquotesingle{}}\OperatorTok{...}
                     \StringTok{\textquotesingle{}\textbackslash{}int\_\{0\}\^{}\{x\}e\^{}\{{-}t\^{}2\} dt = 0.6175$\textquotesingle{}}\NormalTok{])}\OperatorTok{;}
\FunctionTok{xlabel}\NormalTok{ (}\StringTok{"x"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{ylabel}\NormalTok{ (}\StringTok{"erf (x)"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{title}\NormalTok{ (}\StringTok{"erf (x) with text annotation"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{set}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"visible"}\OperatorTok{,} \StringTok{"off"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{print}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"plot15\_7.pdf"}\OperatorTok{,} \StringTok{"{-}dpdflatexstandalone"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{set}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"visible"}\OperatorTok{,} \StringTok{"on"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{system}\NormalTok{ (}\StringTok{"pdflatex plot15\_7"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{open}\NormalTok{ (}\StringTok{"plot15\_7.pdf"}\NormalTok{)}\OperatorTok{;}

\CommentTok{\%\% fig3}

\FunctionTok{clf}\NormalTok{ ()}\OperatorTok{;}
\FunctionTok{surf}\NormalTok{ (}\FunctionTok{peaks}\NormalTok{)}\OperatorTok{;}
\FunctionTok{peaks}\NormalTok{(}\FloatTok{50}\NormalTok{)}
\FunctionTok{print} \OperatorTok{{-}}\NormalTok{dpswrite }\OperatorTok{{-}}\NormalTok{PPS\_printer}

\CommentTok{\%\% images/peaks{-}inc}
\NormalTok{hf }\OperatorTok{=} \FunctionTok{figure}\NormalTok{ (}\FloatTok{1}\NormalTok{)}\OperatorTok{;}
\FunctionTok{surf}\NormalTok{ (}\FunctionTok{peaks}\NormalTok{)}\OperatorTok{;}
\FunctionTok{print}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"peaks.pdf"}\OperatorTok{,} \StringTok{"{-}dpdflatexstandalone"}\NormalTok{)}\OperatorTok{;}

\CommentTok{\%\% windows}
\NormalTok{hf }\OperatorTok{=} \FunctionTok{figure}\NormalTok{ (}\FloatTok{1}\NormalTok{)}\OperatorTok{;}
\FunctionTok{peaks}\NormalTok{(}\FloatTok{10}\NormalTok{)}\OperatorTok{;}
\FunctionTok{print}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"peaks.pdf"}\OperatorTok{,} \StringTok{"{-}dpdf"}\NormalTok{)}\OperatorTok{;}
\FunctionTok{print}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"peaks.eps"}\OperatorTok{,} \StringTok{"{-}color"}\OperatorTok{,}\StringTok{" {-}deps"}\NormalTok{)}\OperatorTok{;}

\FunctionTok{print}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"peaks.svg"}\OperatorTok{,} \StringTok{"{-}color"}\OperatorTok{,}\StringTok{" {-}dsvg"}\NormalTok{)}\OperatorTok{;}


\CommentTok{\%\% windows}
\NormalTok{hf }\OperatorTok{=} \FunctionTok{figure}\NormalTok{ (}\FloatTok{1}\NormalTok{)}\OperatorTok{;}
\FunctionTok{peaks}\NormalTok{(}\FloatTok{50}\NormalTok{)}\OperatorTok{;}
\FunctionTok{print}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"peaks{-}more.eps"}\OperatorTok{,} \StringTok{"{-}color"}\OperatorTok{,}\StringTok{" {-}deps"}\NormalTok{)}\OperatorTok{;}

\FunctionTok{print}\NormalTok{ (hf}\OperatorTok{,} \StringTok{"peaks{-}more.svg"}\OperatorTok{,} \StringTok{"{-}color"}\OperatorTok{,}\StringTok{" {-}dsvg"}\NormalTok{)}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-setup-python}{%
\section{Python 环境配置}\label{sec-setup-python}}

首先创建一个 Python 虚拟环境，环境隔离可以减少对系统的侵入，方便迭代更新和项目管理。创建一个虚拟环境，步骤非常简单，下面以 CentOS 8 为例：

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  安装虚拟模块 virtualenv

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ virtualenv}
\end{Highlighting}
\end{Shaded}
\item
  准备 Python 虚拟环境存放位置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ mkdir }\AttributeTok{{-}p}\NormalTok{ /opt/.virtualenvs/r{-}tensorflow}
\end{Highlighting}
\end{Shaded}
\item
  给虚拟环境必要的访问权限

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ chown }\AttributeTok{{-}R} \VariableTok{$(}\FunctionTok{whoami}\VariableTok{)}\NormalTok{:}\VariableTok{$(}\FunctionTok{whoami}\VariableTok{)}\NormalTok{ /opt/.virtualenvs/r{-}tensorflow}
\end{Highlighting}
\end{Shaded}
\item
  初始化虚拟环境

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{virtualenv} \AttributeTok{{-}p}\NormalTok{ /usr/bin/python3 /opt/.virtualenvs/r{-}tensorflow}
\end{Highlighting}
\end{Shaded}
\item
  激活虚拟环境，安装必要的模块

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{source}\NormalTok{ /opt/.virtualenvs/r{-}tensorflow/bin/activate}
\ExtensionTok{pip}\NormalTok{ install numpy}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

一般来讲，系统自带的 pip 版本较低，可以考虑升级 pip 版本。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{pip}\NormalTok{ install }\AttributeTok{{-}i}\NormalTok{ https://pypi.tuna.tsinghua.edu.cn/simple pip }\AttributeTok{{-}U}
\end{Highlighting}
\end{Shaded}

根据项目配置文件 requirements.txt 安装多个 Python 模块，每个 Python 项目都应该有这么个文件来描述项目需要的依赖环境，包含 Python 模块及其版本号。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{pip}\NormalTok{ install }\AttributeTok{{-}i}\NormalTok{ https://pypi.tuna.tsinghua.edu.cn/simple }\AttributeTok{{-}r}\NormalTok{ requirements.txt}
\end{Highlighting}
\end{Shaded}

指定 Python 模块的镜像地址，加快下载速度，特别是对于国内的环境，加速镜像站点非常有意义，特别是遇到大型的 Python 模块，比如 tensorflow 框架

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{pip}\NormalTok{ install }\AttributeTok{{-}i}\NormalTok{ https://pypi.tuna.tsinghua.edu.cn/simple tensorflow}
\end{Highlighting}
\end{Shaded}

conda 创建 Python 3.8 虚拟环境，并命名为 tensorflow

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{conda}\NormalTok{ create }\AttributeTok{{-}n}\NormalTok{ tensorflow python=3.8}
\end{Highlighting}
\end{Shaded}

激活 tensorflow 环境

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{conda}\NormalTok{ activate tensorflow}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plot-python}{%
\section{Python 基础绘图}\label{sec-plot-python}}

Python 的 matplotlib 模块支持保存的图片格式有 eps, pdf, pgf, png, ps, raw, rgba, svg, svgz，不支持 cairo\_pdf 绘图设备，所以这里使用 pdf 设备，但是这样会导致图形没有字体嵌入，从而不符合出版要求。一个解决办法是在后期嵌入字体，图形默认使用数学字体 \href{http://www.stixfonts.org/}{STIX} 和英文字体 \href{https://dejavu-fonts.github.io/}{DejaVu Sans}，所以需要预先安装这些字体。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# CentOS 8}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ dejavu{-}fonts{-}common dejavu{-}sans{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  dejavu{-}serif{-}fonts dejavu{-}sans{-}mono{-}fonts}
\end{Highlighting}
\end{Shaded}

借助 \textbf{grDevices} 包提供的 \texttt{embedFonts()} 函数，它支持 postscript 和 pdf 图形设备，嵌入字体借助了 \href{https://www.ghostscript.com/}{Ghostscript} 以及 PDF 阅读器 \href{https://www.mupdf.com/}{MuPDF}

\begin{rmdnote}{注意}

Windows 系统下需要手动指定 Ghostscript 安装路径，特别地，如果你想增加可选字体范围，需要指定相应字体搜索路径，而 Linux/MacOS 平台下不需要关心 Ghostscript 的安装路径问题，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{R\_GSCMD =} \StringTok{"C:/Program Files/gs/gs9.26/bin/gswin64c.exe"}\NormalTok{)}
\FunctionTok{embedFonts}\NormalTok{(}
  \AttributeTok{file =} \StringTok{"cm.pdf"}\NormalTok{, }\AttributeTok{outfile =} \StringTok{"cm{-}embed.pdf"}\NormalTok{,}
  \AttributeTok{fontpaths =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"fonts"}\NormalTok{, }\AttributeTok{package =} \StringTok{"fontcm"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{embedFonts}\NormalTok{(}\AttributeTok{file =} \StringTok{"cm.pdf"}\NormalTok{, }\AttributeTok{outfile =} \StringTok{"cm{-}embed.pdf"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\end{rmdnote}

另一个解决办法是使用 LaTeX 渲染图片中的文字，这就需要额外安装一些 LaTeX 宏包，此时默认执行渲染的 LaTeX 引擎是 PDFLaTeX。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr}\NormalTok{ install type1cm cm{-}super dvipng psnfss ucs ncntrsbk helvetic}
\end{Highlighting}
\end{Shaded}

每年 4 月是 TeX Live 的升级月，升级指导见 \url{https://www.tug.org/texlive/upgrade.html}，升级之后，需要更新所有 LaTeX 宏包。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr}\NormalTok{ update }\AttributeTok{{-}{-}self} \AttributeTok{{-}{-}all}
\end{Highlighting}
\end{Shaded}

如图 \ref{fig:matplotlib} 所示，我们采用第二个方法，它可以支持更好的数学公式显示，更多详情见 \url{https://matplotlib.org/tutorials/text/mathtext.html}。

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{other-softwares_files/figure-latex/matplotlib-1} 

}

\caption{matplotlib 示例}\label{fig:matplotlib}
\end{figure}

\begin{rmdtip}{提示}

如果你的系统是 Windows/MacOS 可以添加 GPG 验证以增加安全性，最简单的方式就是：

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{tlmgr} \AttributeTok{{-}{-}repository}\NormalTok{ http://www.preining.info/tlgpg/ install tlgpg}
\end{Highlighting}
\end{Shaded}

\end{rmdtip}

二维函数 \(f(x,y) = 20 + x^2 + y^2 - 10*\cos(2*\pi*x) - 10*\cos(2*\pi*y)\) 最小值 0，最大值 80

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ math }\ImportTok{import}\NormalTok{ cos, pi}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{from}\NormalTok{ mpl\_toolkits.mplot3d }\ImportTok{import}\NormalTok{ Axes3D}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ cm}

\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ rcParams}
\NormalTok{rcParams.update(\{}\StringTok{\textquotesingle{}font.size\textquotesingle{}}\NormalTok{: }\DecValTok{18}\NormalTok{, }\StringTok{\textquotesingle{}text.usetex\textquotesingle{}}\NormalTok{: }\VariableTok{True}\NormalTok{\}) }
\CommentTok{\# 其它可配置选项见 rcParams.keys()}
\NormalTok{plt.switch\_backend(}\StringTok{\textquotesingle{}agg\textquotesingle{}}\NormalTok{)}

\NormalTok{xDomain }\OperatorTok{=}\NormalTok{ np.arange(}\OperatorTok{{-}}\FloatTok{5.12}\NormalTok{, }\FloatTok{5.12}\NormalTok{, }\FloatTok{.08}\NormalTok{)}
\NormalTok{yDomain }\OperatorTok{=}\NormalTok{ np.arange(}\OperatorTok{{-}}\FloatTok{5.12}\NormalTok{, }\FloatTok{5.12}\NormalTok{, }\FloatTok{.08}\NormalTok{)}

\NormalTok{X, Y }\OperatorTok{=}\NormalTok{ np.meshgrid(xDomain, yDomain)}
\NormalTok{z }\OperatorTok{=}\NormalTok{ [}\DecValTok{20} \OperatorTok{+}\NormalTok{ x}\OperatorTok{**}\DecValTok{2} \OperatorTok{+}\NormalTok{ y}\OperatorTok{**}\DecValTok{2} \OperatorTok{{-}}\NormalTok{ (}\DecValTok{10}\OperatorTok{*}\NormalTok{(cos(}\DecValTok{2}\OperatorTok{*}\NormalTok{pi}\OperatorTok{*}\NormalTok{x) }\OperatorTok{+}\NormalTok{ cos(}\DecValTok{2}\OperatorTok{*}\NormalTok{pi}\OperatorTok{*}\NormalTok{y))) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ xDomain }\ControlFlowTok{for}\NormalTok{ y }\KeywordTok{in}\NormalTok{ yDomain]}
\NormalTok{Z }\OperatorTok{=}\NormalTok{ np.array(z).reshape(}\DecValTok{128}\NormalTok{,}\DecValTok{128}\NormalTok{)}

\NormalTok{fig }\OperatorTok{=}\NormalTok{ plt.figure(figsize }\OperatorTok{=}\NormalTok{ (}\DecValTok{12}\NormalTok{,}\DecValTok{10}\NormalTok{))}
\NormalTok{ax }\OperatorTok{=}\NormalTok{ fig.gca(projection}\OperatorTok{=}\StringTok{\textquotesingle{}3d\textquotesingle{}}\NormalTok{)}
\CommentTok{\#\# \textless{}string\textgreater{}:1: MatplotlibDeprecationWarning: Calling gca() with keyword arguments was deprecated in Matplotlib 3.4. Starting two minor releases later, gca() will take no keyword arguments. The gca() function should only be used to get the current axes, or if no axes exist, create new axes with default keyword arguments. To create a new axes with non{-}default arguments, use plt.axes() or plt.subplot().}
\NormalTok{surf }\OperatorTok{=}\NormalTok{ ax.plot\_surface(X, Y, Z, cmap}\OperatorTok{=}\NormalTok{cm.RdYlGn, linewidth}\OperatorTok{=}\DecValTok{1}\NormalTok{, antialiased}\OperatorTok{=}\VariableTok{False}\NormalTok{)}

\NormalTok{ax.set\_xlim(}\OperatorTok{{-}}\FloatTok{5.12}\NormalTok{, }\FloatTok{5.12}\NormalTok{)}
\CommentTok{\#\# ({-}5.12, 5.12)}
\NormalTok{ax.set\_ylim(}\OperatorTok{{-}}\FloatTok{5.12}\NormalTok{, }\FloatTok{5.12}\NormalTok{)}
\CommentTok{\#\# ({-}5.12, 5.12)}
\NormalTok{ax.set\_zlim(}\DecValTok{0}\NormalTok{, }\DecValTok{80}\NormalTok{)}
\CommentTok{\# fig.colorbar(surf, aspect=30)}
\CommentTok{\# plt.title(r\textquotesingle{}Rastrigin Function in Two Dimensions\textquotesingle{})}
\CommentTok{\#\# (0.0, 80.0)}
\NormalTok{plt.tight\_layout()}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{other-softwares_files/figure-latex/rastrigin-function-3} 

}

\caption{Python 绘制三维图形：Rastrigin 函数图形}\label{fig:rastrigin-function}
\end{figure}

\hypertarget{sec-basic-python}{%
\section{Python 基础操作}\label{sec-basic-python}}

\begin{itemize}
\tightlist
\item
  张量操作 \href{https://github.com/numpy/numpy}{numpy} \url{https://numpy.org/} 向量、矩阵操作
\item
  科学计算 \href{https://github.com/scipy/scipy}{scipy} \url{https://scipy.org/} 统计、优化和方程
\item
  数据操作 \href{https://github.com/pandas-dev/pandas/}{pandas} \url{https://pandas.pydata.org/} 面向数据分析
\item
  数据可视化 \href{https://github.com/matplotlib/matplotlib}{matplotlib} \url{https://matplotlib.org/} 静态图形
\item
  交互可视化 \href{https://github.com/bokeh/bokeh}{bokeh} \url{https://bokeh.org/}
\item
  机器学习 \href{https://github.com/scikit-learn/scikit-learn}{scikit-learn} \url{https://scikit-learn.org/} 面向机器学习
\item
  深度学习 \href{https://github.com/tensorflow/tensorflow}{tensorflow} \url{https://tensorflow.org/} 面向深度学习
\end{itemize}

A Python implementation of global optimization with gaussian processes. \href{https://github.com/fmfn/BayesianOptimization}{Bayesian Optimization}

用 numpy 实现一个统计类的算法，比如线性回归、稳健的线性回归、广义线性回归，数据集用 Python 内置的

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\NormalTok{np.zeros(}\DecValTok{3}\NormalTok{) }\CommentTok{\# vector}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## array([0., 0., 0.])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones(}\DecValTok{3}\NormalTok{) }\CommentTok{\# vector}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## array([1., 1., 1.])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.diag([}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]) }\CommentTok{\# identy matrix}
\CommentTok{\# np.multiply()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## array([[1, 0, 0],
##        [0, 1, 0],
##        [0, 0, 1]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.cumsum([}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## array([1, 2, 3])
\end{verbatim}

Python 模块 scikit-learn \citep{scikit-learn} 内置的数据集 iris 为例 \url{https://scikit-learn.org/stable/datasets/index.html}

导入正则表达式库，

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ re}
\NormalTok{m }\OperatorTok{=}\NormalTok{ re.search(}\StringTok{\textquotesingle{}(?\textless{}=abc)def\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}abcdef\textquotesingle{}}\NormalTok{)}
\NormalTok{m.group(}\DecValTok{0}\NormalTok{) }\CommentTok{\# 必须调用 print 函数打印结果}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'def'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(m.group(}\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## def
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ sys}
\BuiltInTok{print}\NormalTok{(sys.path)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ['', '/usr/bin', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/opt/.virtualenvs/r-tensorflow/lib/python3.8/site-packages', '/home/runner/work/_temp/Library/reticulate/python', '/opt/.virtualenvs/r-tensorflow/lib/python38.zip', '/opt/.virtualenvs/r-tensorflow/lib/python3.8', '/opt/.virtualenvs/r-tensorflow/lib/python3.8/lib-dynload']
\end{verbatim}

字符串基本操作，如拆分

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{dir}\NormalTok{(}\BuiltInTok{str}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ['__add__', '__class__', '__contains__', '__delattr__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getitem__', '__getnewargs__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__iter__', '__le__', '__len__', '__lt__', '__mod__', '__mul__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__rmod__', '__rmul__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', 'capitalize', 'casefold', 'center', 'count', 'encode', 'endswith', 'expandtabs', 'find', 'format', 'format_map', 'index', 'isalnum', 'isalpha', 'isascii', 'isdecimal', 'isdigit', 'isidentifier', 'islower', 'isnumeric', 'isprintable', 'isspace', 'istitle', 'isupper', 'join', 'ljust', 'lower', 'lstrip', 'maketrans', 'partition', 'replace', 'rfind', 'rindex', 'rjust', 'rpartition', 'rsplit', 'rstrip', 'split', 'splitlines', 'startswith', 'strip', 'swapcase', 'title', 'translate', 'upper', 'zfill']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\BuiltInTok{dir}\NormalTok{(}\BuiltInTok{str}\NormalTok{.split))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ['__call__', '__class__', '__delattr__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__get__', '__getattribute__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__name__', '__ne__', '__new__', '__objclass__', '__qualname__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__text_signature__']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ re}
\BuiltInTok{print}\NormalTok{(}\BuiltInTok{dir}\NormalTok{(re.split))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ['__annotations__', '__call__', '__class__', '__closure__', '__code__', '__defaults__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__get__', '__getattribute__', '__globals__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__kwdefaults__', '__le__', '__lt__', '__module__', '__name__', '__ne__', '__new__', '__qualname__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ sys}
\CommentTok{\# 模块存放路径}
\BuiltInTok{print}\NormalTok{(sys.path)}
\CommentTok{\# 已安装的模块}
\NormalTok{sys.modules.keys()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dict\_keys([}\StringTok{\textquotesingle{}sys\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}builtins\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_frozen\_importlib\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_imp\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_warnings\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_frozen\_importlib\_external\textquotesingle{}}\NormalTok{,}
\StringTok{\textquotesingle{}\_io\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}marshal\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}posix\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_thread\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_weakref\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}time\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}zipimport\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_codecs\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}codecs\textquotesingle{}}\NormalTok{,}
\StringTok{\textquotesingle{}encodings.aliases\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}encodings.cp437\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}encodings\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}encodings.utf\_8\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_signal\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_\_main\_\_\textquotesingle{}}\NormalTok{,}
\StringTok{\textquotesingle{}encodings.latin\_1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_abc\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}abc\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}io\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_stat\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}stat\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_collections\_abc\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}genericpath\textquotesingle{}}\NormalTok{,}
\StringTok{\textquotesingle{}posixpath\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}os.path\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}os\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_sitebuiltins\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}site\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}readline\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}atexit\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}rlcompleter\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{pip3}\NormalTok{ install virtualenv}
\ExtensionTok{virtualenv} \AttributeTok{{-}p}\NormalTok{ python3 }\OperatorTok{\textless{}}\NormalTok{desired{-}path}\OperatorTok{\textgreater{}}
\BuiltInTok{source} \OperatorTok{\textless{}}\NormalTok{desired{-}path}\OperatorTok{\textgreater{}}\NormalTok{/bin/activate}
\BuiltInTok{source}\NormalTok{ /opt/virtualenv/tensorflow/bin/activate}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  LaTeX 专家黄晨成写的译文 \href{https://liam.page/2014/09/11/matplotlib-tutorial-zh-cn/}{Matplotlib 教程}
\item
  \href{https://morvanzhou.github.io/}{周沫凡} 制作的莫烦 Python 系列视频教程之 \href{https://morvanzhou.github.io/tutorials/data-manipulation/plt/}{Matplotlib 数据可视化神器}
\item
  陈治兵维护的在线 \href{https://www.matplotlib.org.cn/}{Matplotlib 中文文档}
\item
  Sebastian Raschka 和 Vahid Mirjalili 合著的 \href{https://github.com/rasbt/python-machine-learning-book-3rd-edition}{Python Machine Learning (3rd Edition)} \citep{Raschka_2017_Python}
\end{itemize}

编译书籍使用的 Python 3 模块有

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{pip3}\NormalTok{ list }\AttributeTok{{-}{-}format}\OperatorTok{=}\NormalTok{columns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule
Package & Version \\
\midrule
\endhead
absl-py & 0.14.1 \\
astunparse & 1.6.3 \\
cachetools & 4.2.4 \\
certifi & 2021.5.30 \\
charset-normalizer & 2.0.6 \\
clang & 5.0 \\
cycler & 0.10.0 \\
flatbuffers & 1.12 \\
gast & 0.4.0 \\
google-auth & 1.35.0 \\
google-auth-oauthlib & 0.4.6 \\
google-pasta & 0.2.0 \\
graphviz & 0.8.4 \\
grpcio & 1.41.0 \\
h5py & 3.1.0 \\
idna & 3.2 \\
joblib & 1.0.1 \\
kaleido & 0.2.1 \\
keras & 2.6.0 \\
Keras-Preprocessing & 1.1.2 \\
kiwisolver & 1.3.2 \\
Markdown & 3.3.4 \\
matplotlib & 3.4.3 \\
mpmath & 1.2.1 \\
mxnet & 1.8.0.post0 \\
numpy & 1.21.2 \\
oauthlib & 3.1.1 \\
opt-einsum & 3.3.0 \\
pandas & 1.3.3 \\
patsy & 0.5.2 \\
Pillow & 8.3.2 \\
pip & 20.0.2 \\
pkg-resources & 0.0.0 \\
plotly & 5.3.1 \\
protobuf & 3.18.0 \\
pyasn1 & 0.4.8 \\
pyasn1-modules & 0.2.8 \\
pyparsing & 2.4.7 \\
python-dateutil & 2.8.2 \\
pytz & 2021.3 \\
requests & 2.26.0 \\
requests-oauthlib & 1.3.0 \\
rsa & 4.7.2 \\
scikit-learn & 1.0 \\
scipy & 1.7.1 \\
setuptools & 44.0.0 \\
six & 1.15.0 \\
statsmodels & 0.13.0 \\
sympy & 1.8 \\
tenacity & 8.0.1 \\
tensorboard & 2.6.0 \\
tensorboard-data-server & 0.6.1 \\
tensorboard-plugin-wit & 1.8.0 \\
tensorflow & 2.6.0 \\
tensorflow-estimator & 2.6.0 \\
termcolor & 1.1.0 \\
threadpoolctl & 3.0.0 \\
typing-extensions & 3.7.4.3 \\
urllib3 & 1.26.7 \\
Werkzeug & 2.0.1 \\
wheel & 0.37.0 \\
wrapt & 1.12.1 \\
\bottomrule
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 安装 Python 虚拟环境管理器 virtualenv}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ python3{-}pip python3{-}virtualenv}
\CommentTok{\# 创建虚拟环境}
\ExtensionTok{virtualenv} \AttributeTok{{-}p}\NormalTok{ /usr/bin/python3 }\VariableTok{$RETICULATE\_PYTHON\_ENV}
\CommentTok{\# 激活虚拟环境}
\BuiltInTok{source} \VariableTok{$RETICULATE\_PYTHON\_ENV}\NormalTok{/bin/activate}
\CommentTok{\# 将虚拟环境位置写入配置文件}
\BuiltInTok{echo} \StringTok{"export RETICULATE\_PYTHON\_ENV=}\VariableTok{$HOME}\StringTok{/.virtualenvs/r{-}tensorflow"} \OperatorTok{\textgreater{}\textgreater{}}\NormalTok{ \textasciitilde{}/.bashrc}
\BuiltInTok{source}\NormalTok{ \textasciitilde{}/.bashrc}
\CommentTok{\# 安装 numpy matplotlib 等模块}
\ExtensionTok{pip}\NormalTok{ install }\AttributeTok{{-}r}\NormalTok{ requirements.txt}
\CommentTok{\# 导出模块版本信息}
\ExtensionTok{pip}\NormalTok{ freeze }\OperatorTok{\textgreater{}\textgreater{}}\NormalTok{ requirements.txt}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ os}
\NormalTok{os.listdir(}\StringTok{\textquotesingle{}.git\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ['info', 'logs', 'branches', 'config', 'HEAD', 'hooks', 'objects', 'description', 'FETCH_HEAD', 'shallow', 'index', 'refs']
\end{verbatim}

多个代码块共享同一个 Python 进程

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{os.path}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## <module 'posixpath' from '/usr/lib/python3.8/posixpath.py'>
\end{verbatim}

matplotlib 绘图，支持交叉引用\footnote{早些时候，在 R Markdown 中设置 \texttt{python.reticulate\ =\ TRUE} 调用 reticulate 包，带来的副作用是不支持交叉引用的 \url{https://d.cosx.org/d/420680-python-reticulate-true}。RStudio 1.2 已经很好地集成了 reticulate，对 Python 的支持更加到位了 \url{https://blog.rstudio.com/2018/10/09/rstudio-1-2-preview-reticulated-python/}。截至本文写作时间 2021年10月05日 使用 reticulate 版本 1.22，本文没有对之前的版本进行测试。}，如图 \ref{fig:matplotlib-copy} 所示

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ rcParams}
\CommentTok{\# 其它可配置选项见 rcParams.keys()}
\NormalTok{rcParams.update(\{}\StringTok{\textquotesingle{}font.size\textquotesingle{}}\NormalTok{: }\DecValTok{10}\NormalTok{, }\StringTok{\textquotesingle{}text.usetex\textquotesingle{}}\NormalTok{: }\VariableTok{True}\NormalTok{\}) }
\CommentTok{\# rcParams.update(\{\textquotesingle{}font.family\textquotesingle{}:     [\textquotesingle{}sans{-}serif\textquotesingle{}], }
\CommentTok{\#                  \textquotesingle{}font.monospace\textquotesingle{}:  [\textquotesingle{}DejaVu Sans Mono\textquotesingle{}], }
\CommentTok{\#                  \textquotesingle{}font.sans{-}serif\textquotesingle{}: [\textquotesingle{}DejaVu Sans\textquotesingle{}], }
\CommentTok{\#                  \textquotesingle{}font.serif\textquotesingle{}:      [\textquotesingle{}DejaVu Serif\textquotesingle{}]\})}
\NormalTok{plt.switch\_backend(}\StringTok{\textquotesingle{}agg\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.plot([}\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{])}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Coord $x$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Coord $y$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.tight\_layout()}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{other-softwares_files/figure-latex/matplotlib-copy-1} 

}

\caption{matplotlib 复制示例}\label{fig:matplotlib-copy}
\end{figure}

有了 reticulate 包，我们可以把任意想要导入到 R 环境中的 Python 模块导进来，实现 R 与 Python 的数据交换和函数调用 \footnote{朱俊辉的帖子 --- 在 R 中使用 gluon \url{https://d.cosx.org/d/419785-r-gluon}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{os }\OtherTok{\textless{}{-}}\NormalTok{ reticulate}\SpecialCharTok{::}\FunctionTok{import}\NormalTok{(}\StringTok{"os"}\NormalTok{) }\CommentTok{\# 导入 Python 模块}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ os}\SpecialCharTok{$}\FunctionTok{listdir}\NormalTok{(}\StringTok{".git"}\NormalTok{) }\CommentTok{\# 调用 os.listdir() 函数}
\NormalTok{x }\CommentTok{\# 得到 python 中的向量 vector 或数组 array}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "info"        "logs"        "branches"    "config"      "HEAD"       
##  [6] "hooks"       "objects"     "description" "FETCH_HEAD"  "shallow"    
## [11] "index"       "refs"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://docs.bokeh.org/en/latest/docs/user\_guide/quickstart.html\#userguide{-}quickstart}
\ImportTok{from}\NormalTok{ bokeh.plotting }\ImportTok{import}\NormalTok{ figure, output\_file, show}
\CommentTok{\# 准备一些数据}
\NormalTok{x }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{]}
\NormalTok{y }\OperatorTok{=}\NormalTok{ [}\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{]}
\CommentTok{\# 将动态图形以静态 HTML 文件的方式保存}
\NormalTok{output\_file(}\StringTok{"lines.html"}\NormalTok{)}
\CommentTok{\# 创建一个简单的图形，设置标题、x,y 轴标签}
\NormalTok{p }\OperatorTok{=}\NormalTok{ figure(title}\OperatorTok{=}\StringTok{"simple line example"}\NormalTok{, x\_axis\_label}\OperatorTok{=}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, y\_axis\_label}\OperatorTok{=}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 添加一条折线，设置图例，线宽}
\NormalTok{p.line(x, y, legend\_label}\OperatorTok{=}\StringTok{"Temp."}\NormalTok{, line\_width}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\CommentTok{\# 显示结果}
\NormalTok{show(p)}
\end{Highlighting}
\end{Shaded}

将静态图形嵌入到 R Markdown 中

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{htmltools}\SpecialCharTok{::}\FunctionTok{includeHTML}\NormalTok{(}\StringTok{"lines.html"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

R 和 Python 之间的交互，Python 负责数据处理和建模， R 负责绘图，有些复杂的机器学习模型及其相关数据操作需要在 Python 中完成，数据集清理至数据框的形式后导入到 R 中，画各种静态或者动态图，这时候需要加载 reticulate 包，只是设置 \texttt{python.reticulate\ =\ TRUE} 还不够

\begin{rmdtip}{提示}
R Markdown 文档 \citep{xie2018} 中的 Python 代码块是由 knitr 包 \citep{xie2015} 负责调度处理的，展示 Matplotlib 绘图的结果使用了 reticulate 包 \citep{reticulate} 提供的 Python 引擎而不是 knitr 自带的。

在 \texttt{knitr::opts\_chunk} 中设置 \texttt{python.reticulate\ =\ TRUE} 意味着所有的 Python 代码块共享一个 Python Session，而 \texttt{python.reticulate\ =\ FALSE} 意味着使用 knitr 提供的 Python 引擎，所有的 Python 代码块独立运行。

\end{rmdtip}

pandas 读取数据，整理后由 reticulate 包传递给 R 环境中的 data.frame 对象，加载 ggplot2 绘图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{theme\_set}\NormalTok{(}\FunctionTok{theme\_minimal}\NormalTok{())}
\FunctionTok{library}\NormalTok{(patchwork)}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(py}\SpecialCharTok{$}\NormalTok{iris2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Call iris from Python"}\NormalTok{)}
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Call iris from R"}\NormalTok{)}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{other-softwares_files/figure-latex/plot-iris-1} 

}

\caption{从 R 调用 Python 数据对象}\label{fig:plot-iris}
\end{figure}

以 NumPy 为例

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\NormalTok{a }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{15}\NormalTok{).reshape(}\DecValTok{3}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## array([[ 0,  1,  2,  3,  4],
##        [ 5,  6,  7,  8,  9],
##        [10, 11, 12, 13, 14]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.shape}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (3, 5)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.ndim}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.dtype.name}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'int64'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.itemsize}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.size}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 15
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(a)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## <class 'numpy.ndarray'>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{])}
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## array([6, 7, 8])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## <class 'numpy.ndarray'>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.transpose() }\OperatorTok{@}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## array([115, 136, 157, 178, 199])
\end{verbatim}

Python 里面的点号\(\cdot\)对应于R里面的 \texttt{\$}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(reticulate)}
\NormalTok{np }\OtherTok{\textless{}{-}} \FunctionTok{import}\NormalTok{(}\StringTok{"numpy"}\NormalTok{, }\AttributeTok{convert=}\ConstantTok{FALSE}\NormalTok{) }\CommentTok{\# 导入 Python 模块}
\NormalTok{a }\OtherTok{\textless{}{-}}\NormalTok{ np}\SpecialCharTok{$}\FunctionTok{arange}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{15}\NormalTok{)}\SpecialCharTok{$}\FunctionTok{reshape}\NormalTok{(3L, 5L)}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[ 0.  1.  2.  3.  4.]
##  [ 5.  6.  7.  8.  9.]
##  [10. 11. 12. 13. 14.]]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\NormalTok{shape}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (3, 5)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\NormalTok{ndim}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\NormalTok{dtype}\SpecialCharTok{$}\NormalTok{name}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\NormalTok{itemsize}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\NormalTok{size}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 15
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\NormalTok{ctypes}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## <numpy.core._internal._ctypes>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\NormalTok{dtype }\CommentTok{\# data type 数据类型}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\NormalTok{astype}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## <built-in method astype of numpy.ndarray>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{builtins }\OtherTok{\textless{}{-}} \FunctionTok{import\_builtins}\NormalTok{() }\CommentTok{\# Python 内建的函数，不需要导入第三方模块}
\NormalTok{builtins}\SpecialCharTok{$}\FunctionTok{type}\NormalTok{(a)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## <class 'numpy.ndarray'>
\end{verbatim}

基本线性代数运算

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\FunctionTok{transpose}\NormalTok{() }\CommentTok{\# 转置}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[ 0.  5. 10.]
##  [ 1.  6. 11.]
##  [ 2.  7. 12.]
##  [ 3.  8. 13.]
##  [ 4.  9. 14.]]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\FunctionTok{trace}\NormalTok{() }\CommentTok{\# 迹}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 18.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np}\SpecialCharTok{$}\FunctionTok{eye}\NormalTok{(2L) }\CommentTok{\# 单位矩阵}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1. 0.]
##  [0. 1.]]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}\SpecialCharTok{$}\FunctionTok{diagonal}\NormalTok{() }\CommentTok{\# 对角}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [ 0.  6. 12.]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个矩阵的乘法}
\NormalTok{b }\OtherTok{\textless{}{-}}\NormalTok{ np}\SpecialCharTok{$}\FunctionTok{array}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{10}\NormalTok{))}\SpecialCharTok{$}\FunctionTok{reshape}\NormalTok{(5L, 1L)}
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[ 6.]
##  [ 7.]
##  [ 8.]
##  [ 9.]
##  [10.]]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b}\SpecialCharTok{$}\NormalTok{shape}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (5, 1)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np}\SpecialCharTok{$}\FunctionTok{multiply}\NormalTok{(b}\SpecialCharTok{$}\FunctionTok{transpose}\NormalTok{(), a) }\CommentTok{\# b 乘以 a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[  0.   7.  16.  27.  40.]
##  [ 30.  42.  56.  72.  90.]
##  [ 60.  77.  96. 117. 140.]]
\end{verbatim}

Python 对象转化为 R 对象

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{py\_to\_r}\NormalTok{(b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]
## [1,]    6
## [2,]    7
## [3,]    8
## [4,]    9
## [5,]   10
\end{verbatim}

\hypertarget{sec-virtual-vbox}{%
\section{VBox 虚拟机}\label{sec-virtual-vbox}}

\hypertarget{subsec-cmd-start-vbox}{%
\subsection{从命令行启动虚拟机}\label{subsec-cmd-start-vbox}}

当前我的虚拟机里安装了两个系统 Fedora 29 和 CentOS 8.2

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{VBoxManage}\NormalTok{ list vms}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
"Fedora 29" {d316fe8d-c053-4941-8a45-a59fd476898d}
"CentOS 8.2" {f1613f26-ea65-4f02-9cb6-6a79a758a60e}
\end{verbatim}

以无图形化界面的方式启动虚拟机 CentOS 8.2

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{VBoxManage}\NormalTok{ startvm }\StringTok{"CentOS 8.2"} \AttributeTok{{-}{-}type}\NormalTok{ headless}
\CommentTok{\# 或者}
\ExtensionTok{VBoxHeadless} \AttributeTok{{-}{-}startvm} \StringTok{"CentOS 8.2"}
\end{Highlighting}
\end{Shaded}

其它常用的命令还有

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{VBoxManage}\NormalTok{ list runningvms }\CommentTok{\# 列出运行中的虚拟机}
\ExtensionTok{VBoxManage}\NormalTok{ controlvm }\StringTok{"CentOS 8.2"}\NormalTok{ acpipowerbutton }\CommentTok{\# 关闭虚拟机，等价于点击系统关闭按钮，正常关机}
\ExtensionTok{VBoxManage}\NormalTok{ controlvm }\StringTok{"CentOS 8.2"}\NormalTok{ poweroff }\CommentTok{\# 关闭虚拟机，等价于直接关闭电源，非正常关机}
\ExtensionTok{VBoxManage}\NormalTok{ controlvm }\StringTok{"CentOS 8.2"}\NormalTok{ pause }\CommentTok{\# 暂停虚拟机的运行}
\ExtensionTok{VBoxManage}\NormalTok{ controlvm }\StringTok{"CentOS 8.2"}\NormalTok{ resume }\CommentTok{\# 恢复暂停的虚拟机}
\ExtensionTok{VBoxManage}\NormalTok{ controlvm }\StringTok{"CentOS 8.2"}\NormalTok{ savestate }\CommentTok{\# 保存当前虚拟机的运行状态}
\end{Highlighting}
\end{Shaded}

更多细节解释见 \href{https://www.virtualbox.org/manual/ch07.html\#man_vboxheadless}{VBox 官方文档}

\hypertarget{sec-virtual-docker}{%
\section{Docker 虚拟环境}\label{sec-virtual-docker}}

docker 创建云实例 rstudio \href{https://cerebralmastication.com/2019/07/10/starting-a-digital-ocean-instance-from-docker-machine/}{DigitalOcean}，docker 支持的驱动类型 \url{https://docs.docker.com/machine/drivers/}。Rocker 项目组提供的 shiny 容器 \url{https://github.com/rocker-org/shiny} 和构建过程 \url{https://hub.docker.com/r/rocker/shiny/dockerfile}

主机 80 端口映射给 shiny 容器 3838 端口

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}{-}user}\NormalTok{ shiny }\AttributeTok{{-}d} \AttributeTok{{-}p}\NormalTok{ 80:3838 }\DataTypeTok{\textbackslash{}}
    \AttributeTok{{-}v}\NormalTok{ /srv/shinyapps/:/srv/shiny{-}server/ }\DataTypeTok{\textbackslash{}}
    \AttributeTok{{-}v}\NormalTok{ /srv/shinylog/:/var/log/shiny{-}server/ }\DataTypeTok{\textbackslash{}}
\NormalTok{    rocker/shiny}
\end{Highlighting}
\end{Shaded}

shiny 服务器默认支持从 80 端口访问 \url{http://localhost:80}，shiny 应用放在目录 \texttt{/srv/shinyapps/appdir}，访问 Shiny 应用的位置 \url{http://localhost/appdir/}，使用 boot2docker 则访问 \url{http://192.168.59.103:80/appdir/}

Docker 相比虚拟机占用资源少，拉起来就可以用，虚拟机还需要各种环境配置，很多与R有关的项目现在都提供Docker镜像，大大方便了开发人员和数据分析师。当然 docker 的环境隔离性，对主机系统侵入小，即使挂了，再拉起来也就是了，安全性和可靠性高。

基于 \href{https://www.rocker-project.org/}{The Rocker Project} 快速构建数据分析环境，\href{https://github.com/rocker-org/rocker}{Rocker项目} 站在 \href{https://www.debian.org/}{Debian} 和 \href{https://www.r-project.org/}{R} 的肩膀上，在 \href{https://www.docker.com/}{Docker} 内配置众多数据分析和开发的工具，免去用户手动配置的复杂性。此事非有心者不能为之 ，因为需费时费力找寻依赖库，编译 R 包，还要尽可能地给 Docker 镜像减负，以便部署。如果想抢先试水的赶快去 Rocker 项目主页。

\begin{itemize}
\tightlist
\item
  由 Dirk Eddelbuettel 等人担纲的 Rocker 项目， \href{https://github.com/rocker-org/rocker}{项目主页} 和 \href{https://hub.docker.com/u/rocker/}{Docker镜像}
\item
  Wei-Chen Chen 等人的大数据编程项目 Programming with Big Data in R， \href{https://rbigdata.github.io/}{项目主页} 和 \href{https://hub.docker.com/u/rbigdata/}{Docker 镜像}
\item
  \href{http://m.blog.csdn.net/sdgihshdv/article/details/75142367}{非常详细的 docker 笔记}
\item
  Dockerfile 最佳实践 \url{https://docs.docker.com/develop/develop-images/dockerfile_best-practices/}
\item
  build 构建 \url{https://docs.docker.com/engine/reference/builder/\#usage}
\end{itemize}

其它容器相关项目有 \href{https://github.com/bwlewis/r-and-singularity}{Singularity} 和 \href{https://www.kubernetes.org.cn}{Kubernetes 容器集群管理}，更多参见高策的博客 \url{https://gaocegege.com}

本节介绍与本书配套的 VBox 镜像和 Docker 容器镜像，方便读者直接运行书籍原稿中的例子，尽量不限于软件环境配置的苦海中，因为对于大多数初学者来说，软件配置是一件不小的麻烦事。

本书依赖的 R 包和配置环境比较复杂，所以将整个运行环境打包成 Docker 镜像，方便读者重现，构建镜像的 Dockerfile 文件随同书籍源文件一起托管在 Github 上，方便读者研究。本地编译书籍只需三步走，先将存放在 Github 上的书籍项目克隆到本地，如果本地环境中没有 Git，你需要从它的官网 \url{https://git-scm.com/} 下载安装适配本地系统的 Git 软件。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ clone https://github.com/XiangyunHuang/masr.git}
\end{Highlighting}
\end{Shaded}

然后在 Git Bash 的模拟终端器中，启动虚拟机，拉取准备好的镜像文件。为了方便读者重现本书的内容，特将书籍的编译环境打包成 Docker 镜像。在启动镜像前需要确保本地已经安装 Docker 软件 \url{https://www.docker.com/products/docker-desktop}，安装过程请看官网教程。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker{-}machine.exe}\NormalTok{ start default}
\ExtensionTok{docker}\NormalTok{ pull xiangyunhuang/masr}
\end{Highlighting}
\end{Shaded}

最后 \texttt{cd} 进入书籍项目所在目录，运行如下命令编译书籍

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}{-}rm} \AttributeTok{{-}u}\NormalTok{ docker }\AttributeTok{{-}v} \StringTok{"/}\VariableTok{$\{PWD\}}\StringTok{://home/docker/workspace"} \DataTypeTok{\textbackslash{}}
\NormalTok{  xiangyunhuang/masr make gitbook}
\end{Highlighting}
\end{Shaded}

编译成功后，可以在目录 \texttt{\_book/} 下看到生成的文件，点击文件 \texttt{index.html} 选择谷歌浏览器打开，不要使用 IE 浏览器，推荐使用谷歌浏览器获取最佳阅读体验，尽情地阅读吧！

如果你想了解编译书籍的环境和过程，我推荐你阅读随书籍源文件一起的 Dockerfile 文件， \href{https://hub.docker.com/}{Docker Hub} 是根据此文件构建的镜像，打包成功后，大约占用空间 2 Gb，本书在 RStudio IDE 下用 R Markdown \citep{xie2018} 编辑的，编译本书获得电子版还需要一些 R 包和软件。Pandoc \url{https://pandoc.org/} 软件是系统 Fedora 30 仓库自带的，版本是 2.2.1，较新的 RStudio IDE 捆绑的 Pandoc 软件一般会高于此版本。如果你打算在本地系统上编译书籍，RStudio IDE 捆绑的 Pandoc 软件版本已经足够，当然你也可以在 \url{https://github.com/jgm/pandoc/releases/latest} 下载安装最新版本，此外，你还需参考书籍随附的 Dockerfile 文件配置 C++ 代码编译环境，安装所需的 R 包，并确保本地安装的版本不低于镜像内的版本。

镜像中已安装的 R 包列表可运行如下命令查看。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}{-}rm}\NormalTok{ xiangyunhuang/masr }\DataTypeTok{\textbackslash{} }
  \ExtensionTok{Rscript} \AttributeTok{{-}e} \StringTok{\textquotesingle{}xfun::session\_info(.packages(TRUE))\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

Docker \& Docker Machine \& Docker Swarm

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  容器与镜像的操作

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker} \AttributeTok{{-}{-}version}
\CommentTok{\# Docker version 18.03.0{-}ce, build 0520e24302}
\end{Highlighting}
\end{Shaded}

  查看容器

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ ps }\AttributeTok{{-}a}
\end{Highlighting}
\end{Shaded}

  删除容器 \texttt{docker\ rm\ 容器\ ID}，删除前要确认已经停止该容器的运行

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ rm 6f932357e6ce}
\end{Highlighting}
\end{Shaded}

  查看镜像

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ images}
\end{Highlighting}
\end{Shaded}

  删除镜像

  \texttt{docker\ rmi\ 镜像\ ID}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ rmi 811281c54b23}
\end{Highlighting}
\end{Shaded}
\item
  拉取镜像

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ pull rocker/verse:latest}
\end{Highlighting}
\end{Shaded}
\item
  运行容器

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}{-}name}\NormalTok{ verse }\AttributeTok{{-}d} \AttributeTok{{-}p}\NormalTok{ 8282:8080 }\AttributeTok{{-}e}\NormalTok{ ROOT=TRUE }\DataTypeTok{\textbackslash{}}
   \AttributeTok{{-}e}\NormalTok{ USER=rstudio }\AttributeTok{{-}e}\NormalTok{ PASSWORD=cloud rocker/verse}
\end{Highlighting}
\end{Shaded}

  将主机端口 8282 映射给虚拟机/容器的 8080 端口，RStudio Server 默认使用的端口是 8787，因此改为 8080 需要修改 \texttt{/etc/rstudio/rserver.conf} 文件，添加

\begin{verbatim}
www-port=8080
\end{verbatim}

  然后重启 RStudio Server，之后可以在浏览器中登陆，登陆网址为 \url{http://ip-addr:8080}，其中 \texttt{ip-addr} 可在容器中运行如下一行命令获得

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{ip}\NormalTok{ addr}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

更多关于服务器版本的 RStudio 介绍，请参考 \url{https://docs.rstudio.com/ide/server-pro/access-and-security.html}

\href{https://github.com/docker/machine}{Docker Machine}

基本命令

\begin{itemize}
\item
  查看 docker machine 版本信息

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker{-}machine} \AttributeTok{{-}{-}version}
\CommentTok{\# docker{-}machine.exe version 0.14.0, build 89b8332}
\end{Highlighting}
\end{Shaded}
\item
  列出创建的虚拟机

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 启动前}
\ExtensionTok{docker{-}machine}\NormalTok{ ls}
\CommentTok{\# NAME      ACTIVE   DRIVER       STATE     URL   SWARM   DOCKER    ERRORS}
\CommentTok{\# default   {-}        virtualbox   Stopped                 Unknown}
\CommentTok{\# 启动后}
\ExtensionTok{docker{-}machine}\NormalTok{ ls}
\CommentTok{\# NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS}
\CommentTok{\# default   *        virtualbox   Running   tcp://192.168.99.100:2376           v18.03.0{-}ce}
\end{Highlighting}
\end{Shaded}
\item
  查看虚拟机 default 的 ip

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker{-}machine}\NormalTok{ ip default}
\CommentTok{\# 192.168.99.100}
\end{Highlighting}
\end{Shaded}
\item
  启动虚拟机

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker{-}machine}\NormalTok{ start default}
\CommentTok{\# Starting "default"...}
\CommentTok{\# (default) Check network to re{-}create if needed...}
\CommentTok{\# (default) Windows might ask for the permission to configure a dhcp server. Sometimes, such confirmation window is minimized in the taskbar.}
\CommentTok{\# (default) Waiting for an IP...}
\CommentTok{\# Machine "default" was started.}
\CommentTok{\# Waiting for SSH to be available...}
\CommentTok{\# Detecting the provisioner...}
\CommentTok{\# Started machines may have new IP addresses. You may need to re{-}run the \textasciigrave{}docker{-}machine env\textasciigrave{} command.}
\end{Highlighting}
\end{Shaded}
\item
  进入 Docker 环境

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker{-}machine}\NormalTok{ ssh default}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                        ##         .
                  ## ## ##        ==
               ## ## ## ## ##    ===
           /"""""""""""""""""\___/ ===
      ~~~ {~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~
           \______ o           __/
             \    \         __/
              \____\_______/
 _                 _   ____     _            _
| |__   ___   ___ | |_|___ \ __| | ___   ___| | _____ _ __
| '_ \ / _ \ / _ \| __| __) / _` |/ _ \ / __| |/ / _ \ '__|
| |_) | (_) | (_) | |_ / __/ (_| | (_) | (__|   <  __/ |
|_.__/ \___/ \___/ \__|_____\__,_|\___/ \___|_|\_\___|_|
Boot2Docker version 18.03.0-ce, build HEAD : 404ee40 - Thu Mar 22 17:12:23 UTC 2018
Docker version 18.03.0-ce, build 0520e24
\end{verbatim}
\item
  查看容器

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ ps }\AttributeTok{{-}a}
\CommentTok{\# CONTAINER ID        IMAGE               COMMAND             CREATED            STATUS                   PORTS               NAMES}
\CommentTok{\# 69e6929d269e        rocker/verse        "/init"             3 weeks ago        Exited (0) 10 days ago                       verse}
\end{Highlighting}
\end{Shaded}
\item
  启动/停止容器

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ start verse}
\CommentTok{\# verse}
\ExtensionTok{docker}\NormalTok{ stop verse}
\CommentTok{\# verse}
\end{Highlighting}
\end{Shaded}
\item
  查看虚拟机 default 的环境

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker{-}machine}\NormalTok{ env default}
\CommentTok{\# export DOCKER\_TLS\_VERIFY="1"}
\CommentTok{\# export DOCKER\_HOST="tcp://192.168.99.100:2376"}
\CommentTok{\# export DOCKER\_CERT\_PATH="D:\textbackslash{}Docker\textbackslash{}machines\textbackslash{}default"}
\CommentTok{\# export DOCKER\_MACHINE\_NAME="default"}
\CommentTok{\# export COMPOSE\_CONVERT\_WINDOWS\_PATHS="true"}
\CommentTok{\# \# Run this command to configure your shell:}
\CommentTok{\# \# eval $("C:\textbackslash{}Program Files\textbackslash{}Docker Toolbox\textbackslash{}docker{-}machine.exe" env default)}
\end{Highlighting}
\end{Shaded}
\item
  关闭虚拟机 default

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker{-}machine}\NormalTok{ stop default}
\CommentTok{\# Stopping "default"...}
\CommentTok{\# Machine "default" was stopped.}
\end{Highlighting}
\end{Shaded}
\end{itemize}

更多详情见帮助文档 \url{https://docs.docker.com/machine/get-started}

\hypertarget{setup-r}{%
\section{安装的 R 包}\label{setup-r}}

\begin{rmdwarn}{警告}
本小节仅用于展示目前书籍写作过程中安装的 R 包依赖，不会出现在最终的书稿中

\end{rmdwarn}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{.packages}\NormalTok{(T)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
##  [1] base      compiler  datasets  graphics  grDevices grid      methods  
##  [8] parallel  splines   stats     stats4    tcltk     tools     utils    
## 
## other attached packages:
##   [1] ABCoptim_0.15.0            abind_1.4-5               
##   [3] agridat_1.18               alabama_2015.3-1          
##   [5] arrow_5.0.0.2              arules_1.6-8              
##   [7] ash_1.0-15                 askpass_1.1               
##   [9] assertive.base_0.0-9       assertive.properties_0.0-4
##  [11] assertive.types_0.0-3      assertthat_0.2.1          
##  [13] autoplotly_0.1.4           backports_1.2.1           
##  [15] base64enc_0.1-3            bayesplot_1.8.1           
##  [17] BB_2019.10-1               bbmle_1.0.24              
##  [19] bdsmatrix_1.3-4            beanplot_1.2              
##  [21] beeswarm_0.4.0             BH_1.75.0-0               
##  [23] BiocGenerics_0.38.0        BiocManager_1.30.16       
##  [25] BiocVersion_3.13.1         bit_4.0.4                 
##  [27] bit64_4.0.5                bitops_1.0-7              
##  [29] blob_1.2.2                 BMA_3.18.15               
##  [31] bookdown_0.24              boot_1.3-28               
##  [33] brew_1.0-6                 bridgesampling_1.1-2      
##  [35] brio_1.1.2                 brms_2.16.1               
##  [37] Brobdingnag_1.2-6          broom_0.7.9               
##  [39] broom.mixed_0.2.7          bslib_0.3.0               
##  [41] cachem_1.0.6               Cairo_1.5-12.2            
##  [43] callr_3.7.0                car_3.0-11                
##  [45] carData_3.0-4              cellranger_1.1.0          
##  [47] checkmate_2.0.0            circlize_0.4.13           
##  [49] class_7.3-19               classInt_0.4-3            
##  [51] cli_3.0.1                  clipr_0.7.1               
##  [53] clue_0.3-59                cluster_2.1.2             
##  [55] cmdstanr_0.4.0             coda_0.19-4               
##  [57] codetools_0.2-18           colorspace_2.0-2          
##  [59] colourpicker_1.1.0         combinat_0.0-8            
##  [61] commonmark_1.7             ComplexHeatmap_2.8.0      
##  [63] config_0.3.1               conquer_1.0.2             
##  [65] corrplot_0.90              countrycode_1.3.0         
##  [67] cowplot_1.1.1              cpp11_0.4.0               
##  [69] cranlogs_2.1.1             crayon_1.4.1              
##  [71] credentials_1.3.1          crosstalk_1.1.1           
##  [73] cubature_2.0.4.2           cubelyr_1.0.1             
##  [75] curl_4.3.2                 data.table_1.14.2         
##  [77] DBI_1.1.1                  dbplyr_2.1.1              
##  [79] deldir_0.2-10              dendextend_1.15.1         
##  [81] DEoptimR_1.0-9             Deriv_4.1.3               
##  [83] desc_1.4.0                 deSolve_1.29              
##  [85] devtools_2.4.2             dfidx_0.0-4               
##  [87] DiagrammeR_1.0.6.1         diffobj_0.3.4             
##  [89] digest_0.6.28              distributional_0.2.2      
##  [91] doParallel_1.0.16          dotCall64_1.0-1           
##  [93] downlit_0.2.1              downloader_0.4            
##  [95] dplyr_1.0.7                DT_0.19                   
##  [97] dtplyr_1.1.0               dygraphs_1.1.1.6          
##  [99] e1071_1.7-9                Ecdat_0.3-9               
## [101] Ecfun_0.2-5                echarts4r_0.4.1           
## [103] egg_0.4.5                  ellipsis_0.3.2            
## [105] emo_0.0.0.9000             equatiomatic_0.3.0        
## [107] evaluate_0.14              evd_2.3-3                 
## [109] expm_0.999-6               extrafont_0.17            
## [111] extrafontdb_1.0            fansi_0.5.0               
## [113] farver_2.1.0               fastmap_1.1.0             
## [115] fda_5.1.9                  fds_1.8                   
## [117] fields_12.5                filehash_2.4-2            
## [119] flexdashboard_0.5.2.9000   FNN_1.1.3                 
## [121] fontawesome_0.2.2          fontcm_1.1                
## [123] forcats_0.5.1              foreach_1.5.1             
## [125] foreign_0.8-81             forge_0.2.0               
## [127] formatR_1.11               formattable_0.2.1         
## [129] Formula_1.2-4              fs_1.5.0                  
## [131] future_1.22.1              GA_3.2.1                  
## [133] gamm4_0.2-6                gapminder_0.3.0           
## [135] gargle_1.2.0               gclus_1.3.2               
## [137] gdata_2.18.0               gdtools_0.2.3             
## [139] generics_0.1.0             geoR_1.8-1                
## [141] gert_1.4.1                 GetoptLong_1.0.5          
## [143] ggalluvial_0.12.3          gganimate_1.0.7           
## [145] ggbeeswarm_0.6.0           ggbump_0.1.0              
## [147] ggdendro_0.1.22            ggfittext_0.9.1           
## [149] ggfortify_0.4.12           ggiraph_0.7.10            
## [151] ggmosaic_0.3.3             ggnormalviolin_0.1.2      
## [153] ggplot2_3.3.5              ggpubr_0.4.0              
## [155] ggrepel_0.9.1              ggridges_0.5.3            
## [157] ggsci_2.9                  ggsignif_0.6.3            
## [159] ggstream_0.1.0             ggthemes_4.2.4            
## [161] gh_1.3.0                   gifski_1.4.3-1            
## [163] git2r_0.28.0               gitcreds_0.1.1            
## [165] glmmTMB_1.1.2.3            glmnet_4.1-2              
## [167] GlobalOptions_0.1.2        globals_0.14.0            
## [169] glue_1.4.2                 gmodels_2.18.1            
## [171] gmp_0.6-2                  googledrive_2.0.0         
## [173] googlesheets4_1.0.0        graph_1.70.0              
## [175] gridBase_0.4-7             gridExtra_2.3             
## [177] gt_0.3.1                   gtable_0.3.0              
## [179] gtools_3.9.2               haven_2.4.3               
## [181] hdrcde_3.4                 heatmaply_1.2.1           
## [183] here_1.0.1                 hexbin_1.28.2             
## [185] highcharter_0.8.2          highr_0.9                 
## [187] HKprocess_0.0-2            Hmisc_4.5-0               
## [189] hms_1.1.1                  hrbrthemes_0.8.0          
## [191] htmlTable_2.2.1            htmltools_0.5.2           
## [193] htmlwidgets_1.5.4          httpuv_1.6.3              
## [195] httr_1.4.2                 hunspell_3.0.1            
## [197] idbr_1.0                   ids_1.0.1                 
## [199] igraph_1.2.6               influenceR_0.1.0.1        
## [201] ini_0.3.1                  INLA_21.02.23             
## [203] inline_0.3.19              IRanges_2.26.0            
## [205] isoband_0.2.5              iterators_1.0.13          
## [207] janeaustenr_0.1.5          janitor_2.1.0             
## [209] jpeg_0.1-9                 jquerylib_0.1.4           
## [211] jsonlite_1.7.2             kableExtra_1.3.4          
## [213] Kendall_2.2                keras_2.6.0               
## [215] kernlab_0.9-29             KernSmooth_2.23-20        
## [217] knitr_1.36                 ks_1.13.2                 
## [219] labeling_0.4.2             later_1.3.0               
## [221] lattice_0.20-45            latticeExtra_0.6-29       
## [223] lazyeval_0.2.2             leaflet_2.0.4.1           
## [225] leaflet.providers_1.9.0    leafletCN_0.2.1           
## [227] leaps_3.1                  LearnBayes_2.15.1         
## [229] lifecycle_1.0.1            lightgbm_3.2.1            
## [231] listenv_0.8.0              lme4_1.1-27.1             
## [233] lmtest_0.9-38              locfit_1.5-9.4            
## [235] loo_2.4.1                  lpSolve_5.6.15            
## [237] lpSolveAPI_5.5.2.0-17.7    lubridate_1.7.10          
## [239] lwgeom_0.2-7               magick_2.7.3              
## [241] magrittr_2.0.1             mapdata_2.3.0             
## [243] mapproj_1.2.7              maps_3.4.0                
## [245] maptools_1.1-2             markdown_1.1              
## [247] MASS_7.3-54                mathjaxr_1.4-0            
## [249] Matrix_1.3-4               MatrixModels_0.5-0        
## [251] matrixStats_0.61.0         maxLik_1.5-2              
## [253] mclust_5.4.7               mcmc_0.9-7                
## [255] MCMCpack_1.5-0             memoise_2.0.0             
## [257] mgcv_1.8-37                microbenchmark_1.4-7      
## [259] mime_0.12                  miniUI_0.1.1.1            
## [261] minqa_1.2.4                misc3d_0.9-0              
## [263] miscTools_0.6-26           mlogit_1.1-1              
## [265] mnormt_2.0.2               modelr_0.1.8              
## [267] mpoly_1.1.1                multicool_0.1-12          
## [269] multipol_1.0-7             munsell_0.5.0             
## [271] mvtnorm_1.1-2              networkD3_0.4             
## [273] nleqslv_3.3.2              nlme_3.1-153              
## [275] nlmeODE_1.1                nloptr_1.2.2.2            
## [277] NMOF_2.4-1                 nnet_7.3-16               
## [279] nomnoml_0.2.3              numDeriv_2016.8-1.1       
## [281] odbc_1.3.2                 openssl_1.4.5             
## [283] openxlsx_4.2.4             optimx_2021-6.12          
## [285] orthopolynom_1.0-5         packagemetrics_0.0.1.9001 
## [287] packrat_0.7.0              palmerpenguins_0.1.0      
## [289] parallelly_1.28.1          partitions_1.10-2         
## [291] patchwork_1.1.1            pbkrtest_0.5.1            
## [293] PBSddesolve_1.12.6         pcaPP_1.9-74              
## [295] pdftools_3.0.1             pdist_1.2                 
## [297] pillar_1.6.3               pixmap_0.4-12             
## [299] pkgbuild_1.2.0             pkgconfig_2.0.3           
## [301] pkgload_1.2.2              plogr_0.2.0               
## [303] plot3D_1.4                 plotly_4.9.4.1            
## [305] plyr_1.8.6                 png_0.1-7                 
## [307] polynom_1.4-0              posterior_1.1.0           
## [309] pracma_2.3.3               praise_1.0.0              
## [311] prettydoc_0.4.1            prettyunits_1.1.1         
## [313] PrevMap_1.5.3              processx_3.5.2            
## [315] productplots_0.1.1         progress_1.2.2            
## [317] projpred_2.0.2             promises_1.2.0.1          
## [319] proxy_0.4-26               ps_1.6.0                  
## [321] pso_1.0.3                  pspearman_0.3-0           
## [323] purrr_0.3.4                pwr_1.3-0                 
## [325] qap_0.1-1                  qpdf_1.1                  
## [327] quadprog_1.5-8             quantmod_0.4.18           
## [329] quantreg_5.86              r2d3_0.2.5                
## [331] R6_2.5.1                   rainbow_3.6               
## [333] RandomFields_3.3.10        RandomFieldsUtils_0.5.4   
## [335] rappdirs_0.3.3             raster_3.4-13             
## [337] rasterly_0.2.0             rasterVis_0.50.3          
## [339] rbibutils_2.2.3            rcmdcheck_1.4.0           
## [341] RColorBrewer_1.1-2         Rcpp_1.0.7                
## [343] RcppArmadillo_0.10.6.0.0   RcppEigen_0.3.3.9.1       
## [345] RcppParallel_5.1.4         RCurl_1.98-1.5            
## [347] Rdpack_2.1.2               reactable_0.2.3           
## [349] reactR_0.4.4               ReacTran_1.4.3.1          
## [351] readr_2.0.2                readxl_1.3.1              
## [353] registry_0.5-1             rematch_1.0.1             
## [355] rematch2_2.1.2             remotes_2.4.1             
## [357] renv_0.14.0                reprex_2.0.1              
## [359] reshape2_1.4.4             reticulate_1.22           
## [361] rgdal_1.5-27               rgeos_0.5-8               
## [363] rgl_0.107.14               RgoogleMaps_1.4.5.3       
## [365] Rgraphviz_2.36.0           rio_0.5.27                
## [367] rJava_1.0-5                rjson_0.2.20              
## [369] rlang_0.4.11               rlist_0.4.6.2             
## [371] rmarkdown_2.11             rnaturalearthdata_0.1.0   
## [373] rngtools_1.5.2             robustbase_0.93-9         
## [375] ROI_1.0-0                  ROI.plugin.alabama_1.0-0  
## [377] ROI.plugin.lpsolve_1.0-1   ROI.plugin.nloptr_1.0-0   
## [379] ROI.plugin.quadprog_1.0-0  rootSolve_1.8.2.3         
## [381] roxygen2_7.1.2             rpart_4.1-15              
## [383] rprojroot_2.0.2            rrcov_1.6-0               
## [385] rsconnect_0.8.24           RSQLite_2.2.8             
## [387] rstan_2.26.3               rstantools_2.1.1          
## [389] rstatix_0.7.0              rstudioapi_0.13           
## [391] Rttf2pt1_1.3.9             rversions_2.1.1           
## [393] rvest_1.0.1                s2_1.0.7                  
## [395] S4Vectors_0.30.0           sandwich_3.0-1            
## [397] sass_0.4.0                 scales_1.1.1              
## [399] scatterplot3d_0.3-41       selectr_0.4-2             
## [401] seriation_1.3.0            sessioninfo_1.1.1         
## [403] sets_1.0-18                sf_1.0-2                  
## [405] sfarrow_0.4.0              shades_1.4.0              
## [407] shape_1.4.6                shiny_1.7.0               
## [409] shinyjs_2.0.0              shinystan_2.5.0           
## [411] shinythemes_1.2.0          showtext_0.9-4            
## [413] showtextdb_3.0             Sim.DiffProc_4.8          
## [415] slam_0.1-48                sm_2.2-5.7                
## [417] sn_2.0.0                   snakecase_0.11.0          
## [419] SnowballC_0.7.0            sourcetools_0.1.7         
## [421] sp_1.4-5                   spam_2.7-0                
## [423] sparkline_2.0              sparklyr_1.7.2            
## [425] SparseM_1.81               spatial_7.3-14            
## [427] spData_0.3.10              spDataLarge_0.5.4         
## [429] spdep_1.1-11               splancs_2.01-42           
## [431] splines2_0.4.5             stackr_0.0.0.9000         
## [433] StanHeaders_2.26.3         stars_0.5-3               
## [435] statmod_1.4.36             stringi_1.7.4             
## [437] stringr_1.4.0              SuppDists_1.1-9.5         
## [439] survival_3.2-13            svglite_2.0.0             
## [441] symengine_0.1.5            symmoments_1.2.1          
## [443] sys_3.4                    sysfonts_0.8.5            
## [445] systemfonts_1.0.2          TeachingDemos_2.12        
## [447] tensorA_0.36.2             tensorflow_2.6.0          
## [449] terra_1.3-22               testthat_3.0.4            
## [451] tfautograph_0.3.2          tfruns_1.5.0              
## [453] threejs_0.3.3              tibble_3.1.5              
## [455] tidyr_1.1.4                tidyselect_1.1.1          
## [457] tidytext_0.3.1             tidyverse_1.3.1           
## [459] tikzDevice_0.12.3.1        timeline_0.9              
## [461] timelineS_0.1.1            tint_0.1.3                
## [463] tinytex_0.34               tis_1.38                  
## [465] TMB_1.7.22                 tmvnsim_1.0-2             
## [467] tokenizers_0.2.1           transformr_0.1.3          
## [469] treemap_2.4-3              treemapify_2.5.5          
## [471] truncnorm_1.0-8            TSP_1.1-10                
## [473] TTR_0.24.2                 tweenr_1.0.2              
## [475] tzdb_0.1.2                 units_0.7-2               
## [477] usethis_2.0.1              utf8_1.2.2                
## [479] uuid_0.1-4                 V8_3.4.2                  
## [481] vctrs_0.3.8                vioplot_0.3.7             
## [483] vipor_0.4.5                viridis_0.6.1             
## [485] viridisLite_0.4.0          visNetwork_2.1.0          
## [487] vistime_1.2.1              vroom_1.5.5               
## [489] waldo_0.3.1                webshot_0.5.2             
## [491] whisker_0.4                withr_2.4.2               
## [493] wk_0.5.0                   xfun_0.26                 
## [495] xgboost_1.4.1.1            xkcd_0.0.6                
## [497] XML_3.99-0.8               xml2_1.3.2                
## [499] xopen_1.0.0                xtable_1.8-4              
## [501] xts_0.12.1                 yaml_2.2.1                
## [503] zeallot_0.1.0              zip_2.2.0                 
## [505] zoo_1.8-9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\NormalTok{pdb }\OtherTok{\textless{}{-}}\NormalTok{ tools}\SpecialCharTok{::}\FunctionTok{CRAN\_package\_db}\NormalTok{()}
\NormalTok{pkg }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(desc}\SpecialCharTok{::}\FunctionTok{desc\_get\_deps}\NormalTok{(), }\AttributeTok{subset =}\NormalTok{ type }\SpecialCharTok{==} \StringTok{"Imports"}\NormalTok{, }\AttributeTok{select =} \StringTok{"package"}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{pkg }\OtherTok{\textless{}{-}}\NormalTok{ tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(}\AttributeTok{packages =}\NormalTok{ pkg, }\AttributeTok{db =}\NormalTok{ pdb, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 是否包含递归依赖}
  \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as.vector}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{c}\NormalTok{(., pkg) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{unique}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{sort}\NormalTok{()}

\NormalTok{pkg\_quote }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"Armadillo"}\NormalTok{, }\StringTok{"Rcpp"}\NormalTok{, }\StringTok{"R"}\NormalTok{, }\StringTok{"Stan"}\NormalTok{, }\StringTok{"DataTables"}\NormalTok{, }\StringTok{"Dygraphs"}\NormalTok{, }\StringTok{"ggplot2"}\NormalTok{,}
  \StringTok{"Grobs"}\NormalTok{, }\StringTok{"Geospatial"}\NormalTok{, }\StringTok{"Eigen"}\NormalTok{, }\StringTok{"Sundown"}\NormalTok{, }\StringTok{"plog"}\NormalTok{, }\StringTok{"TeX Live"}\NormalTok{, }\StringTok{"Tidyverse"}\NormalTok{,}
  \StringTok{"LaTeX"}\NormalTok{, }\StringTok{"ADMB"}\NormalTok{, }\StringTok{"matplotlib"}\NormalTok{, }\StringTok{"Yihui Xie"}\NormalTok{, }\StringTok{"With"}\NormalTok{, }\StringTok{"Highcharts"}\NormalTok{,}
  \StringTok{"kable"}\NormalTok{, }\StringTok{"plotly.js"}\NormalTok{, }\StringTok{"Python"}\NormalTok{, }\StringTok{"Formattable"}
\NormalTok{)}
\CommentTok{\# 单引号}
\NormalTok{pkg\_regexp }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"\textquotesingle{}("}\NormalTok{, }\FunctionTok{paste}\NormalTok{(pkg\_quote, }\AttributeTok{collapse =} \StringTok{"|"}\NormalTok{), }\StringTok{")\textquotesingle{}"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\CommentTok{\# R 包列表}
\FunctionTok{subset}\NormalTok{(pdb,}
  \AttributeTok{subset =} \SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(pdb}\SpecialCharTok{$}\NormalTok{Package) }\SpecialCharTok{\&}\NormalTok{ Package }\SpecialCharTok{\%in\%}\NormalTok{ pkg,}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Version"}\NormalTok{, }\StringTok{"Title"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(.,}
    \AttributeTok{Title =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}n}\StringTok{)"}\NormalTok{, }\StringTok{" "}\NormalTok{, Title),}
    \AttributeTok{Package =} \FunctionTok{paste}\NormalTok{(}\StringTok{"**"}\NormalTok{, Package, }\StringTok{"**"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(., }\AttributeTok{Title =} \FunctionTok{gsub}\NormalTok{(pkg\_regexp, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, Title)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(., }\AttributeTok{Title =} \FunctionTok{gsub}\NormalTok{(}\StringTok{\textquotesingle{}"(Grid)"\textquotesingle{}}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, Title)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(.,}
    \AttributeTok{caption =} \StringTok{"依赖的 R 包"}\NormalTok{, }\AttributeTok{format =} \StringTok{"pandoc"}\NormalTok{,}
    \AttributeTok{booktabs =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:all-pkgs}依赖的 R 包}\tabularnewline
\toprule
Package & Version & Title \\
\midrule
\endfirsthead
\toprule
Package & Version & Title \\
\midrule
\endhead
\textbf{abind} & 1.4-5 & Combine Multidimensional Arrays \\
\textbf{agridat} & 1.18 & Agricultural Datasets \\
\textbf{alabama} & 2015.3-1 & Constrained Nonlinear Optimization \\
\textbf{arrow} & 5.0.0.2 & Integration to `Apache' `Arrow' \\
\textbf{arules} & 1.6-8 & Mining Association Rules and Frequent Itemsets \\
\textbf{assertive.types} & 0.0-3 & Assertions to Check Types of Variables \\
\textbf{assertthat} & 0.2.1 & Easy Pre and Post Assertions \\
\textbf{autoplotly} & 0.1.4 & Automatic Generation of Interactive Visualizations for Statistical Results \\
\textbf{backports} & 1.2.1 & Reimplementations of Functions Introduced Since R-3.0.0 \\
\textbf{base64enc} & 0.1-3 & Tools for base64 encoding \\
\textbf{bayesplot} & 1.8.1 & Plotting for Bayesian Models \\
\textbf{bbmle} & 1.0.24 & Tools for General Maximum Likelihood Estimation \\
\textbf{bdsmatrix} & 1.3-4 & Routines for Block Diagonal Symmetric Matrices \\
\textbf{beanplot} & 1.2 & Visualization via Beanplots (like Boxplot/Stripchart/Violin Plot) \\
\textbf{beeswarm} & 0.4.0 & The Bee Swarm Plot, an Alternative to Stripchart \\
\textbf{BH} & 1.75.0-0 & Boost C++ Header Files \\
\textbf{BiocManager} & 1.30.16 & Access the Bioconductor Project Package Repository \\
\textbf{bit64} & 4.0.5 & A S3 Class for Vectors of 64bit Integers \\
\textbf{bitops} & 1.0-7 & Bitwise Operations \\
\textbf{blob} & 1.2.2 & A Simple S3 Class for Representing Vectors of Binary Data (`BLOBS') \\
\textbf{bookdown} & 0.24 & Authoring Books and Technical Documents with R Markdown \\
\textbf{boot} & 1.3-28 & Bootstrap Functions (Originally by Angelo Canty for S) \\
\textbf{bridgesampling} & 1.1-2 & Bridge Sampling for Marginal Likelihoods and Bayes Factors \\
\textbf{brio} & 1.1.2 & Basic R Input Output \\
\textbf{brms} & 2.16.1 & Bayesian Regression Models using Stan \\
\textbf{broom} & 0.7.9 & Convert Statistical Objects into Tidy Tibbles \\
\textbf{broom.mixed} & 0.2.7 & Tidying Methods for Mixed Models \\
\textbf{bslib} & 0.3.0 & Custom `Bootstrap' `Sass' Themes for `shiny' and `rmarkdown' \\
\textbf{cachem} & 1.0.6 & Cache R Objects with Automatic Pruning \\
\textbf{callr} & 3.7.0 & Call R from R \\
\textbf{checkmate} & 2.0.0 & Fast and Versatile Argument Checks \\
\textbf{classInt} & 0.4-3 & Choose Univariate Class Intervals \\
\textbf{cli} & 3.0.1 & Helpers for Developing Command Line Interfaces \\
\textbf{coda} & 0.19-4 & Output Analysis and Diagnostics for MCMC \\
\textbf{colorspace} & 2.0-2 & A Toolbox for Manipulating and Assessing Colors and Palettes \\
\textbf{commonmark} & 1.7 & High Performance CommonMark and Github Markdown Rendering in R \\
\textbf{config} & 0.3.1 & Manage Environment Specific Configuration Values \\
\textbf{conquer} & 1.0.2 & Convolution-Type Smoothed Quantile Regression \\
\textbf{corrplot} & 0.90 & Visualization of a Correlation Matrix \\
\textbf{countrycode} & 1.3.0 & Convert Country Names and Country Codes \\
\textbf{cowplot} & 1.1.1 & Streamlined Plot Theme and Plot Annotations for ggplot2 \\
\textbf{crayon} & 1.4.1 & Colored Terminal Output \\
\textbf{crosstalk} & 1.1.1 & Inter-Widget Interactivity for HTML Widgets \\
\textbf{curl} & 4.3.2 & A Modern and Flexible Web Client for R \\
\textbf{data.table} & 1.14.2 & Extension of \texttt{data.frame} \\
\textbf{DBI} & 1.1.1 & R Database Interface \\
\textbf{dbplyr} & 2.1.1 & A `dplyr' Back End for Databases \\
\textbf{dendextend} & 1.15.1 & Extending `dendrogram' Functionality in R \\
\textbf{Deriv} & 4.1.3 & Symbolic Differentiation \\
\textbf{desc} & 1.4.0 & Manipulate DESCRIPTION Files \\
\textbf{deSolve} & 1.29 & Solvers for Initial Value Problems of Differential Equations (`ODE', `DAE', `DDE') \\
\textbf{devtools} & 2.4.2 & Tools to Make Developing R Packages Easier \\
\textbf{DiagrammeR} & 1.0.6.1 & Graph/Network Visualization \\
\textbf{digest} & 0.6.28 & Create Compact Hash Digests of R Objects \\
\textbf{downlit} & 0.2.1 & Syntax Highlighting and Automatic Linking \\
\textbf{downloader} & 0.4 & Download Files over HTTP and HTTPS \\
\textbf{dplyr} & 1.0.7 & A Grammar of Data Manipulation \\
\textbf{DT} & 0.19 & A Wrapper of the JavaScript Library DataTables \\
\textbf{dtplyr} & 1.1.0 & Data Table Back-End for `dplyr' \\
\textbf{echarts4r} & 0.4.2 & Create Interactive Graphs with `Echarts JavaScript' Version 5 \\
\textbf{egg} & 0.4.5 & Extensions for ggplot2: Custom Geom, Custom Themes, Plot Alignment, Labelled Panels, Symmetric Scales, and Fixed Panel Size \\
\textbf{ellipsis} & 0.3.2 & Tools for Working with \ldots{} \\
\textbf{equatiomatic} & 0.3.0 & Transform Models into LaTeX Equations \\
\textbf{evaluate} & 0.14 & Parsing and Evaluation Tools that Provide More Details than the Default \\
\textbf{extrafont} & 0.17 & Tools for using fonts \\
\textbf{extrafontdb} & 1.0 & Package for holding the database for the extrafont package \\
\textbf{fansi} & 0.5.0 & ANSI Control Sequence Aware String Functions \\
\textbf{fastmap} & 1.1.0 & Fast Data Structures \\
\textbf{filehash} & 2.4-2 & Simple Key-Value Database \\
\textbf{fontawesome} & 0.2.2 & Easily Work with `Font Awesome' Icons \\
\textbf{fontcm} & 1.1 & Computer Modern font for use with extrafont package \\
\textbf{forcats} & 0.5.1 & Tools for Working with Categorical Variables (Factors) \\
\textbf{foreach} & 1.5.1 & Provides Foreach Looping Construct \\
\textbf{forge} & 0.2.0 & Casting Values into Shape \\
\textbf{formatR} & 1.11 & Format R Code Automatically \\
\textbf{fs} & 1.5.0 & Cross-Platform File System Operations Based on `libuv' \\
\textbf{future} & 1.22.1 & Unified Parallel and Distributed Processing in R for Everyone \\
\textbf{gapminder} & 0.3.0 & Data from Gapminder \\
\textbf{gdtools} & 0.2.3 & Utilities for Graphical Rendering \\
\textbf{generics} & 0.1.0 & Common S3 Generics not Provided by Base R Methods Related to Model Fitting \\
\textbf{geoR} & 1.8-1 & Analysis of Geostatistical Data \\
\textbf{ggalluvial} & 0.12.3 & Alluvial Plots in ggplot2 \\
\textbf{gganimate} & 1.0.7 & A Grammar of Animated Graphics \\
\textbf{ggbeeswarm} & 0.6.0 & Categorical Scatter (Violin Point) Plots \\
\textbf{ggbump} & 0.1.0 & Bump Chart and Sigmoid Curves \\
\textbf{ggfittext} & 0.9.1 & Fit Text Inside a Box in ggplot2 \\
\textbf{ggfortify} & 0.4.12 & Data Visualization Tools for Statistical Analysis Results \\
\textbf{ggmosaic} & 0.3.3 & Mosaic Plots in the ggplot2 Framework \\
\textbf{ggnormalviolin} & 0.1.2 & A ggplot2 Extension to Make Normal Violin Plots \\
\textbf{ggplot2} & 3.3.5 & Create Elegant Data Visualisations Using the Grammar of Graphics \\
\textbf{ggpubr} & 0.4.0 & ggplot2 Based Publication Ready Plots \\
\textbf{ggrepel} & 0.9.1 & Automatically Position Non-Overlapping Text Labels with ggplot2 \\
\textbf{ggridges} & 0.5.3 & Ridgeline Plots in ggplot2 \\
\textbf{ggsci} & 2.9 & Scientific Journal and Sci-Fi Themed Color Palettes for ggplot2 \\
\textbf{ggsignif} & 0.6.3 & Significance Brackets for ggplot2 \\
\textbf{ggstream} & 0.1.0 & Create Streamplots in ggplot2 \\
\textbf{gifski} & 1.4.3-1 & Highest Quality GIF Encoder \\
\textbf{git2r} & 0.28.0 & Provides Access to Git Repositories \\
\textbf{glmmTMB} & 1.1.2.3 & Generalized Linear Mixed Models using Template Model Builder \\
\textbf{glmnet} & 4.1-2 & Lasso and Elastic-Net Regularized Generalized Linear Models \\
\textbf{globals} & 0.14.0 & Identify Global Objects in R Expressions \\
\textbf{glue} & 1.4.2 & Interpreted String Literals \\
\textbf{googledrive} & 2.0.0 & An Interface to Google Drive \\
\textbf{googlesheets4} & 1.0.0 & Access Google Sheets using the Sheets API V4 \\
\textbf{gridBase} & 0.4-7 & Integration of base and grid graphics \\
\textbf{gridExtra} & 2.3 & Miscellaneous Functions for Grid Graphics \\
\textbf{gt} & 0.3.1 & Easily Create Presentation-Ready Display Tables \\
\textbf{gtable} & 0.3.0 & Arrange Grobs in Tables \\
\textbf{haven} & 2.4.3 & Import and Export `SPSS', `Stata' and `SAS' Files \\
\textbf{heatmaply} & 1.2.1 & Interactive Cluster Heat Maps Using `plotly' and ggplot2 \\
\textbf{here} & 1.0.1 & A Simpler Way to Find Your Files \\
\textbf{hexbin} & 1.28.2 & Hexagonal Binning Routines \\
\textbf{highcharter} & 0.8.2 & A Wrapper for the Highcharts Library \\
\textbf{highr} & 0.9 & Syntax Highlighting for R Source Code \\
\textbf{Hmisc} & 4.5-0 & Harrell Miscellaneous \\
\textbf{hms} & 1.1.1 & Pretty Time of Day \\
\textbf{hrbrthemes} & 0.8.0 & Additional Themes, Theme Components and Utilities for ggplot2 \\
\textbf{htmltools} & 0.5.2 & Tools for HTML \\
\textbf{htmlwidgets} & 1.5.4 & HTML Widgets for R \\
\textbf{httpuv} & 1.6.3 & HTTP and WebSocket Server Library \\
\textbf{httr} & 1.4.2 & Tools for Working with URLs and HTTP \\
\textbf{igraph} & 1.2.6 & Network Analysis and Visualization \\
\textbf{influenceR} & 0.1.0.1 & Software Tools to Quantify Structural Importance of Nodes in a Network \\
\textbf{inline} & 0.3.19 & Functions to Inline C, C++, Fortran Function Calls from R \\
\textbf{isoband} & 0.2.5 & Generate Isolines and Isobands from Regularly Spaced Elevation Grids \\
\textbf{jquerylib} & 0.1.4 & Obtain `jQuery' as an HTML Dependency Object \\
\textbf{jsonlite} & 1.7.2 & A Simple and Robust JSON Parser and Generator for R \\
\textbf{kableExtra} & 1.3.4 & Construct Complex Table with kable and Pipe Syntax \\
\textbf{Kendall} & 2.2 & Kendall rank correlation and Mann-Kendall trend test \\
\textbf{knitr} & 1.36 & A General-Purpose Package for Dynamic Report Generation in R \\
\textbf{later} & 1.3.0 & Utilities for Scheduling Functions to Execute Later with Event Loops \\
\textbf{lattice} & 0.20-45 & Trellis Graphics for R \\
\textbf{latticeExtra} & 0.6-29 & Extra Graphical Utilities Based on Lattice \\
\textbf{lazyeval} & 0.2.2 & Lazy (Non-Standard) Evaluation \\
\textbf{leaflet} & 2.0.4.1 & Create Interactive Web Maps with the JavaScript `Leaflet' Library \\
\textbf{leaflet.providers} & 1.9.0 & Leaflet Providers \\
\textbf{leafletCN} & 0.2.1 & An R Gallery for China and Other Geojson Choropleth Map in Leaflet \\
\textbf{lifecycle} & 1.0.1 & Manage the Life Cycle of your Package Functions \\
\textbf{lightgbm} & 3.2.1 & Light Gradient Boosting Machine \\
\textbf{lme4} & 1.1-27.1 & Linear Mixed-Effects Models using Eigen and S4 \\
\textbf{loo} & 2.4.1 & Efficient Leave-One-Out Cross-Validation and WAIC for Bayesian Models \\
\textbf{lpSolve} & 5.6.15 & Interface to `Lp\_solve' v. 5.5 to Solve Linear/Integer Programs \\
\textbf{lpSolveAPI} & 5.5.2.0-17.7 & R Interface to `lp\_solve' Version 5.5.2.0 \\
\textbf{lubridate} & 1.7.10 & Make Dealing with Dates a Little Easier \\
\textbf{magick} & 2.7.3 & Advanced Graphics and Image-Processing in R \\
\textbf{magrittr} & 2.0.1 & A Forward-Pipe Operator for R \\
\textbf{mapdata} & 2.3.0 & Extra Map Databases \\
\textbf{mapproj} & 1.2.7 & Map Projections \\
\textbf{maps} & 3.4.0 & Draw Geographical Maps \\
\textbf{markdown} & 1.1 & Render Markdown with the C Library Sundown \\
\textbf{MASS} & 7.3-54 & Support Functions and Datasets for Venables and Ripley's MASS \\
\textbf{Matrix} & 1.3-4 & Sparse and Dense Matrix Classes and Methods \\
\textbf{MatrixModels} & 0.5-0 & Modelling with Sparse and Dense Matrices \\
\textbf{matrixStats} & 0.61.0 & Functions that Apply to Rows and Columns of Matrices (and to Vectors) \\
\textbf{maxLik} & 1.5-2 & Maximum Likelihood Estimation and Related Tools \\
\textbf{mcmc} & 0.9-7 & Markov Chain Monte Carlo \\
\textbf{memoise} & 2.0.0 & Memoisation of Functions \\
\textbf{mgcv} & 1.8-37 & Mixed GAM Computation Vehicle with Automatic Smoothness Estimation \\
\textbf{mime} & 0.12 & Map Filenames to MIME Types \\
\textbf{minqa} & 1.2.4 & Derivative-free optimization algorithms by quadratic approximation \\
\textbf{modelr} & 0.1.8 & Modelling Functions that Work with the Pipe \\
\textbf{mvtnorm} & 1.1-2 & Multivariate Normal and t Distributions \\
\textbf{networkD3} & 0.4 & D3 JavaScript Network Graphs from R \\
\textbf{nleqslv} & 3.3.2 & Solve Systems of Nonlinear Equations \\
\textbf{nlme} & 3.1-153 & Linear and Nonlinear Mixed Effects Models \\
\textbf{nloptr} & 1.2.2.2 & R Interface to NLopt \\
\textbf{nomnoml} & 0.2.3 & Sassy `UML' Diagrams \\
\textbf{numDeriv} & 2016.8-1.1 & Accurate Numerical Derivatives \\
\textbf{odbc} & 1.3.2 & Connect to ODBC Compatible Databases (using the DBI Interface) \\
\textbf{openssl} & 1.4.5 & Toolkit for Encryption, Signatures and Certificates Based on OpenSSL \\
\textbf{palmerpenguins} & 0.1.0 & Palmer Archipelago (Antarctica) Penguin Data \\
\textbf{patchwork} & 1.1.1 & The Composer of Plots \\
\textbf{pdftools} & 3.0.1 & Text Extraction, Rendering and Converting of PDF Documents \\
\textbf{pdist} & 1.2 & Partitioned Distance Function \\
\textbf{pillar} & 1.6.3 & Coloured Formatting for Columns \\
\textbf{pkgbuild} & 1.2.0 & Find Tools Needed to Build R Packages \\
\textbf{pkgconfig} & 2.0.3 & Private Configuration for R Packages \\
\textbf{pkgload} & 1.2.2 & Simulate Package Installation and Attach \\
\textbf{plogr} & 0.2.0 & The plog C++ Logging Library \\
\textbf{plotly} & 4.9.4.1 & Create Interactive Web Graphics via plotly.js \\
\textbf{plyr} & 1.8.6 & Tools for Splitting, Applying and Combining Data \\
\textbf{png} & 0.1-7 & Read and write PNG images \\
\textbf{polynom} & 1.4-0 & A Collection of Functions to Implement a Class for Univariate Polynomial Manipulations \\
\textbf{posterior} & 1.1.0 & Tools for Working with Posterior Distributions \\
\textbf{prettydoc} & 0.4.1 & Creating Pretty Documents from R Markdown \\
\textbf{PrevMap} & 1.5.3 & Geostatistical Modelling of Spatially Referenced Prevalence Data \\
\textbf{processx} & 3.5.2 & Execute and Control System Processes \\
\textbf{productplots} & 0.1.1 & Product Plots for R \\
\textbf{progress} & 1.2.2 & Terminal Progress Bars \\
\textbf{projpred} & 2.0.2 & Projection Predictive Feature Selection \\
\textbf{promises} & 1.2.0.1 & Abstractions for Promise-Based Asynchronous Programming \\
\textbf{pspearman} & 0.3-0 & Spearman's rank correlation test \\
\textbf{purrr} & 0.3.4 & Functional Programming Tools \\
\textbf{pwr} & 1.3-0 & Basic Functions for Power Analysis \\
\textbf{qpdf} & 1.1 & Split, Combine and Compress PDF Files \\
\textbf{quadprog} & 1.5-8 & Functions to Solve Quadratic Programming Problems \\
\textbf{quantmod} & 0.4.18 & Quantitative Financial Modelling Framework \\
\textbf{quantreg} & 5.86 & Quantile Regression \\
\textbf{r2d3} & 0.2.5 & Interface to `D3' Visualizations \\
\textbf{R6} & 2.5.1 & Encapsulated Classes with Reference Semantics \\
\textbf{RandomFields} & 3.3.10 & Simulation and Analysis of Random Fields \\
\textbf{rappdirs} & 0.3.3 & Application Directories: Determine Where to Save Data, Caches, and Logs \\
\textbf{raster} & 3.4-13 & Geographic Data Analysis and Modeling \\
\textbf{rasterly} & 0.2.0 & Easily and Rapidly Generate Raster Image Data with Support for `Plotly.js' \\
\textbf{rasterVis} & 0.50.3 & Visualization Methods for Raster Data \\
\textbf{rcmdcheck} & 1.4.0 & Run `R CMD check' from R and Capture Results \\
\textbf{RColorBrewer} & 1.1-2 & ColorBrewer Palettes \\
\textbf{Rcpp} & 1.0.7 & Seamless R and C++ Integration \\
\textbf{RcppArmadillo} & 0.10.7.0.0 & Rcpp Integration for the Armadillo Templated Linear Algebra Library \\
\textbf{RcppEigen} & 0.3.3.9.1 & Rcpp Integration for the Eigen Templated Linear Algebra Library \\
\textbf{RcppParallel} & 5.1.4 & Parallel Programming Tools for Rcpp \\
\textbf{reactable} & 0.2.3 & Interactive Data Tables Based on `React Table' \\
\textbf{reactR} & 0.4.4 & React Helpers \\
\textbf{readr} & 2.0.2 & Read Rectangular Text Data \\
\textbf{readxl} & 1.3.1 & Read Excel Files \\
\textbf{registry} & 0.5-1 & Infrastructure for R Package Registries \\
\textbf{remotes} & 2.4.1 & R Package Installation from Remote Repositories, Including `GitHub' \\
\textbf{reprex} & 2.0.1 & Prepare Reproducible Example Code via the Clipboard \\
\textbf{reshape2} & 1.4.4 & Flexibly Reshape Data: A Reboot of the Reshape Package \\
\textbf{reticulate} & 1.22 & Interface to Python \\
\textbf{rgdal} & 1.5-27 & Bindings for the Geospatial Data Abstraction Library \\
\textbf{rgeos} & 0.5-8 & Interface to Geometry Engine - Open Source (`GEOS') \\
\textbf{rjson} & 0.2.20 & JSON for R \\
\textbf{rlang} & 0.4.11 & Functions for Base Types and Core R and Tidyverse Features \\
\textbf{rlist} & 0.4.6.2 & A Toolbox for Non-Tabular Data Manipulation \\
\textbf{rmarkdown} & 2.11 & Dynamic Documents for R \\
\textbf{ROI} & 1.0-0 & R Optimization Infrastructure \\
\textbf{ROI.plugin.alabama} & 1.0-0 & `alabama' Plug-in for the R Optimization Infrastructure \\
\textbf{ROI.plugin.lpsolve} & 1.0-1 & `lp\_solve' Plugin for the R Optimization Infrastructure \\
\textbf{ROI.plugin.nloptr} & 1.0-0 & `nloptr' Plug-in for the R Optimization Infrastructure \\
\textbf{ROI.plugin.quadprog} & 1.0-0 & `quadprog' Plug-in for the R Optimization Infrastructure \\
\textbf{rootSolve} & 1.8.2.3 & Nonlinear Root Finding, Equilibrium and Steady-State Analysis of Ordinary Differential Equations \\
\textbf{roxygen2} & 7.1.2 & In-Line Documentation for R \\
\textbf{rprojroot} & 2.0.2 & Finding Files in Project Subdirectories \\
\textbf{RSQLite} & 2.2.8 & `SQLite' Interface for R \\
\textbf{rstan} & 2.21.2 & R Interface to Stan \\
\textbf{rstantools} & 2.1.1 & Tools for Developing R Packages Interfacing with Stan \\
\textbf{rstatix} & 0.7.0 & Pipe-Friendly Framework for Basic Statistical Tests \\
\textbf{rstudioapi} & 0.13 & Safely Access the RStudio API \\
\textbf{Rttf2pt1} & 1.3.9 & `ttf2pt1' Program \\
\textbf{rversions} & 2.1.1 & Query R Versions, Including `r-release' and `r-oldrel' \\
\textbf{rvest} & 1.0.1 & Easily Harvest (Scrape) Web Pages \\
\textbf{s2} & 1.0.7 & Spherical Geometry Operators Using the S2 Geometry Library \\
\textbf{sass} & 0.4.0 & Syntactically Awesome Style Sheets (`Sass') \\
\textbf{scales} & 1.1.1 & Scale Functions for Visualization \\
\textbf{scatterplot3d} & 0.3-41 & 3D Scatter Plot \\
\textbf{seriation} & 1.3.0 & Infrastructure for Ordering Objects Using Seriation \\
\textbf{sessioninfo} & 1.1.1 & R Session Information \\
\textbf{sf} & 1.0-2 & Simple Features for R \\
\textbf{shape} & 1.4.6 & Functions for Plotting Graphical Shapes, Colors \\
\textbf{shiny} & 1.7.1 & Web Application Framework for R \\
\textbf{shinystan} & 2.5.0 & Interactive Visual and Numerical Diagnostics and Posterior Analysis for Bayesian Models \\
\textbf{showtext} & 0.9-4 & Using Fonts More Easily in R Graphs \\
\textbf{showtextdb} & 3.0 & Font Files for the `showtext' Package \\
\textbf{slam} & 0.1-48 & Sparse Lightweight Arrays and Matrices \\
\textbf{sm} & 2.2-5.7 & Smoothing Methods for Nonparametric Regression and Density Estimation \\
\textbf{sourcetools} & 0.1.7 & Tools for Reading, Tokenizing and Parsing R Code \\
\textbf{sp} & 1.4-5 & Classes and Methods for Spatial Data \\
\textbf{sparkline} & 2.0 & `jQuery' Sparkline `htmlwidget' \\
\textbf{sparklyr} & 1.7.2 & R Interface to Apache Spark \\
\textbf{SparseM} & 1.81 & Sparse Linear Algebra \\
\textbf{splancs} & 2.01-42 & Spatial and Space-Time Point Pattern Analysis \\
\textbf{splines2} & 0.4.5 & Regression Spline Functions and Classes \\
\textbf{StanHeaders} & 2.21.0-7 & C++ Header Files for Stan \\
\textbf{stringi} & 1.7.5 & Character String Processing Facilities \\
\textbf{stringr} & 1.4.0 & Simple, Consistent Wrappers for Common String Operations \\
\textbf{SuppDists} & 1.1-9.5 & Supplementary Distributions \\
\textbf{survival} & 3.2-13 & Survival Analysis \\
\textbf{svglite} & 2.0.0 & An `SVG' Graphics Device \\
\textbf{symengine} & 0.1.5 & Interface to the `SymEngine' Library \\
\textbf{sysfonts} & 0.8.5 & Loading Fonts into R \\
\textbf{tensorflow} & 2.6.0 & R Interface to `TensorFlow' \\
\textbf{terra} & 1.4-7 & Spatial Data Analysis \\
\textbf{testthat} & 3.1.0 & Unit Testing for R \\
\textbf{tfautograph} & 0.3.2 & Autograph R for `Tensorflow' \\
\textbf{tfruns} & 1.5.0 & Training Run Tools for `TensorFlow' \\
\textbf{tibble} & 3.1.5 & Simple Data Frames \\
\textbf{tidyr} & 1.1.4 & Tidy Messy Data \\
\textbf{tidyselect} & 1.1.1 & Select from a Set of Strings \\
\textbf{tidyverse} & 1.3.1 & Easily Install and Load the Tidyverse \\
\textbf{tikzDevice} & 0.12.3.1 & R Graphics Output in LaTeX Format \\
\textbf{timeline} & 0.9 & Timelines for a Grammar of Graphics \\
\textbf{timelineS} & 0.1.1 & Timeline and Time Duration-Related Tools \\
\textbf{tint} & 0.1.3 & `tint' is not `Tufte' \\
\textbf{tinytex} & 0.34 & Helper Functions to Install and Maintain TeX Live, and Compile LaTeX Documents \\
\textbf{TMB} & 1.7.22 & Template Model Builder: A General Random Effect Tool Inspired by ADMB \\
\textbf{transformr} & 0.1.3 & Polygon and Path Transformations \\
\textbf{treemap} & 2.4-3 & Treemap Visualization \\
\textbf{treemapify} & 2.5.5 & Draw Treemaps in ggplot2 \\
\textbf{truncnorm} & 1.0-8 & Truncated Normal Distribution \\
\textbf{TSP} & 1.1-10 & Traveling Salesperson Problem (TSP) \\
\textbf{tweenr} & 1.0.2 & Interpolate Data for Smooth Animations \\
\textbf{units} & 0.7-2 & Measurement Units for R Vectors \\
\textbf{usethis} & 2.0.1 & Automate Package and Project Setup \\
\textbf{uuid} & 0.1-4 & Tools for Generating and Handling of UUIDs \\
\textbf{V8} & 3.4.2 & Embedded JavaScript and WebAssembly Engine for R \\
\textbf{vctrs} & 0.3.8 & Vector Helpers \\
\textbf{vioplot} & 0.3.7 & Violin Plot \\
\textbf{vipor} & 0.4.5 & Plot Categorical Data Using Quasirandom Noise and Density Estimates \\
\textbf{viridis} & 0.6.1 & Colorblind-Friendly Color Maps for R \\
\textbf{viridisLite} & 0.4.0 & Colorblind-Friendly Color Maps (Lite Version) \\
\textbf{visNetwork} & 2.1.0 & Network Visualization using `vis.js' Library \\
\textbf{vistime} & 1.2.1 & Pretty Timelines in R \\
\textbf{webshot} & 0.5.2 & Take Screenshots of Web Pages \\
\textbf{withr} & 2.4.2 & Run Code With Temporarily Modified Global State \\
\textbf{xfun} & 0.26 & Supporting Functions for Packages Maintained by Yihui Xie \\
\textbf{xgboost} & 1.4.1.1 & Extreme Gradient Boosting \\
\textbf{xkcd} & 0.0.6 & Plotting ggplot2 Graphics in an XKCD Style \\
\textbf{xml2} & 1.3.2 & Parse XML \\
\textbf{xtable} & 1.8-4 & Export Tables to LaTeX or HTML \\
\textbf{xts} & 0.12.1 & eXtensible Time Series \\
\textbf{yaml} & 2.2.1 & Methods to Convert R Data to YAML and Back \\
\textbf{zoo} & 1.8-9 & S3 Infrastructure for Regular and Irregular Time Series (Z's Ordered Observations) \\
\bottomrule
\end{longtable}

\begin{rmdtip}{提示}
本书意欲覆盖的内容

\end{rmdtip}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{inla\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Package =} \StringTok{"INLA"}\NormalTok{,}
  \AttributeTok{Title =} \FunctionTok{paste}\NormalTok{(}
    \StringTok{"Full Bayesian Analysis of Latent Gaussian Models"}\NormalTok{,}
    \StringTok{"using Integrated Nested Laplace Approximations"}
\NormalTok{  )}
\NormalTok{)}
\NormalTok{pkgs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"ggplot2"}\NormalTok{, }\StringTok{"cowplot"}\NormalTok{, }\StringTok{"patchwork"}\NormalTok{, }\StringTok{"rgl"}\NormalTok{, }\StringTok{"MASS"}\NormalTok{, }\StringTok{"nlme"}\NormalTok{, }\StringTok{"mgcv"}\NormalTok{,}
  \StringTok{"lme4"}\NormalTok{, }\StringTok{"gee"}\NormalTok{, }\StringTok{"gam"}\NormalTok{, }\StringTok{"gamm4"}\NormalTok{, }\StringTok{"cgam"}\NormalTok{, }\StringTok{"cglm"}\NormalTok{, }\StringTok{"pscl"}\NormalTok{,}
  \StringTok{"GLMMadaptive"}\NormalTok{, }\StringTok{"gee4"}\NormalTok{, }\StringTok{"geoR"}\NormalTok{, }\StringTok{"LaplacesDemon"}\NormalTok{, }\StringTok{"glmnet"}\NormalTok{,}
  \StringTok{"betareg"}\NormalTok{, }\StringTok{"quantreg"}\NormalTok{, }\StringTok{"agridat"}\NormalTok{, }\StringTok{"moments"}\NormalTok{, }\StringTok{"R2BayesX"}\NormalTok{,}
  \StringTok{"geoRglm"}\NormalTok{, }\StringTok{"spaMM"}\NormalTok{, }\StringTok{"spBayes"}\NormalTok{, }\StringTok{"CARBayes"}\NormalTok{, }\StringTok{"PrevMap"}\NormalTok{,}
  \StringTok{"FRK"}\NormalTok{, }\StringTok{"lgcp"}\NormalTok{, }\StringTok{"HSAR"}\NormalTok{, }\StringTok{"spNNGP"}\NormalTok{, }\StringTok{"MuMIn"}\NormalTok{, }\StringTok{"BANOVA"}\NormalTok{,}
  \StringTok{"rpql"}\NormalTok{, }\StringTok{"QGglmm"}\NormalTok{, }\StringTok{"glmmsr"}\NormalTok{, }\StringTok{"glmmboot"}\NormalTok{, }\StringTok{"glmm"}\NormalTok{,}
  \StringTok{"glmmML"}\NormalTok{, }\StringTok{"glmmEP"}\NormalTok{, }\StringTok{"r2glmm"}\NormalTok{, }\StringTok{"hglm"}\NormalTok{, }\StringTok{"glmmLasso"}\NormalTok{,}
  \StringTok{"blme"}\NormalTok{, }\StringTok{"MCMCglmm"}\NormalTok{, }\StringTok{"MCMCpack"}\NormalTok{, }\StringTok{"glmmTMB"}\NormalTok{, }\StringTok{"geepack"}\NormalTok{,}
  \StringTok{"glmmfields"}\NormalTok{, }\StringTok{"rstan"}\NormalTok{, }\StringTok{"rstanarm"}\NormalTok{, }\StringTok{"brms"}\NormalTok{, }\StringTok{"greta"}\NormalTok{,}
  \StringTok{"BayesX"}\NormalTok{, }\StringTok{"Boom"}\NormalTok{, }\StringTok{"nimble"}\NormalTok{, }\StringTok{"rjags"}\NormalTok{, }\StringTok{"R2OpenBUGS"}\NormalTok{,}
  \StringTok{"R2BayesX"}\NormalTok{, }\StringTok{"BoomSpikeSlab"}\NormalTok{, }\StringTok{"inlabru"}\NormalTok{, }\StringTok{"INLABMA"}\NormalTok{,}
  \StringTok{"lmtest"}\NormalTok{, }\StringTok{"VGAM"}\NormalTok{, }\StringTok{"plotly"}\NormalTok{, }\StringTok{"leaflet"}\NormalTok{, }\StringTok{"LatticeKrig"}
\NormalTok{)}
\NormalTok{pdb }\OtherTok{\textless{}{-}}\NormalTok{ tools}\SpecialCharTok{::}\FunctionTok{CRAN\_package\_db}\NormalTok{()}
\NormalTok{book\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(pdb,}
  \AttributeTok{subset =} \SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(pdb}\SpecialCharTok{$}\NormalTok{Package) }\SpecialCharTok{\&}\NormalTok{ Package }\SpecialCharTok{\%in\%}\NormalTok{ pkgs,}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Title"}\NormalTok{)}
\NormalTok{)}
\NormalTok{book\_pdb }\OtherTok{\textless{}{-}} \FunctionTok{rbind.data.frame}\NormalTok{(book\_pdb, inla\_pdb)}
\NormalTok{book\_pdb}\SpecialCharTok{$}\NormalTok{Title }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}n}\StringTok{)"}\NormalTok{, }\StringTok{" "}\NormalTok{, book\_pdb}\SpecialCharTok{$}\NormalTok{Title)}
\NormalTok{book\_pdb}\SpecialCharTok{$}\NormalTok{Title }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\textquotesingle{}(Armadillo|BayesX|Eigen|ggplot2|lme4|mgcv|Stan|Leaflet|plotly.js)\textquotesingle{}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, book\_pdb}\SpecialCharTok{$}\NormalTok{Title)}
\NormalTok{book\_pdb}\SpecialCharTok{$}\NormalTok{Package }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"**"}\NormalTok{, book\_pdb}\SpecialCharTok{$}\NormalTok{Package, }\StringTok{"**"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(book\_pdb,}
  \AttributeTok{caption =} \StringTok{"本书使用的 R 包"}\NormalTok{, }\AttributeTok{format =} \StringTok{"pandoc"}\NormalTok{,}
  \AttributeTok{booktabs =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:book-pkgs}本书使用的 R 包}\tabularnewline
\toprule
Package & Title \\
\midrule
\endfirsthead
\toprule
Package & Title \\
\midrule
\endhead
\textbf{agridat} & Agricultural Datasets \\
\textbf{BANOVA} & Hierarchical Bayesian ANOVA Models \\
\textbf{BayesX} & R Utilities Accompanying the Software Package BayesX \\
\textbf{betareg} & Beta Regression \\
\textbf{blme} & Bayesian Linear Mixed-Effects Models \\
\textbf{Boom} & Bayesian Object Oriented Modeling \\
\textbf{BoomSpikeSlab} & MCMC for Spike and Slab Regression \\
\textbf{brms} & Bayesian Regression Models using Stan \\
\textbf{CARBayes} & Spatial Generalised Linear Mixed Models for Areal Unit Data \\
\textbf{cgam} & Constrained Generalized Additive Model \\
\textbf{cglm} & Fits Conditional Generalized Linear Models \\
\textbf{cowplot} & Streamlined Plot Theme and Plot Annotations for ggplot2 \\
\textbf{FRK} & Fixed Rank Kriging \\
\textbf{gam} & Generalized Additive Models \\
\textbf{gamm4} & Generalized Additive Mixed Models using mgcv and lme4 \\
\textbf{gee} & Generalized Estimation Equation Solver \\
\textbf{geepack} & Generalized Estimating Equation Package \\
\textbf{geoR} & Analysis of Geostatistical Data \\
\textbf{ggplot2} & Create Elegant Data Visualisations Using the Grammar of Graphics \\
\textbf{glmm} & Generalized Linear Mixed Models via Monte Carlo Likelihood Approximation \\
\textbf{GLMMadaptive} & Generalized Linear Mixed Models using Adaptive Gaussian Quadrature \\
\textbf{glmmEP} & Generalized Linear Mixed Model Analysis via Expectation Propagation \\
\textbf{glmmfields} & Generalized Linear Mixed Models with Robust Random Fields for Spatiotemporal Modeling \\
\textbf{glmmLasso} & Variable Selection for Generalized Linear Mixed Models by L1-Penalized Estimation \\
\textbf{glmmML} & Generalized Linear Models with Clustering \\
\textbf{glmmsr} & Fit a Generalized Linear Mixed Model \\
\textbf{glmmTMB} & Generalized Linear Mixed Models using Template Model Builder \\
\textbf{glmnet} & Lasso and Elastic-Net Regularized Generalized Linear Models \\
\textbf{greta} & Simple and Scalable Statistical Modelling in R \\
\textbf{hglm} & Hierarchical Generalized Linear Models \\
\textbf{HSAR} & Hierarchical Spatial Autoregressive Model \\
\textbf{INLABMA} & Bayesian Model Averaging with INLA \\
\textbf{inlabru} & Bayesian Latent Gaussian Modelling using INLA and Extensions \\
\textbf{LaplacesDemon} & Complete Environment for Bayesian Inference \\
\textbf{LatticeKrig} & Multi-Resolution Kriging Based on Markov Random Fields \\
\textbf{leaflet} & Create Interactive Web Maps with the JavaScript Leaflet Library \\
\textbf{lgcp} & Log-Gaussian Cox Process \\
\textbf{lme4} & Linear Mixed-Effects Models using Eigen and S4 \\
\textbf{lmtest} & Testing Linear Regression Models \\
\textbf{MASS} & Support Functions and Datasets for Venables and Ripley's MASS \\
\textbf{MCMCglmm} & MCMC Generalised Linear Mixed Models \\
\textbf{MCMCpack} & Markov Chain Monte Carlo (MCMC) Package \\
\textbf{mgcv} & Mixed GAM Computation Vehicle with Automatic Smoothness Estimation \\
\textbf{moments} & Moments, cumulants, skewness, kurtosis and related tests \\
\textbf{MuMIn} & Multi-Model Inference \\
\textbf{nimble} & MCMC, Particle Filtering, and Programmable Hierarchical Modeling \\
\textbf{nlme} & Linear and Nonlinear Mixed Effects Models \\
\textbf{patchwork} & The Composer of Plots \\
\textbf{plotly} & Create Interactive Web Graphics via plotly.js \\
\textbf{PrevMap} & Geostatistical Modelling of Spatially Referenced Prevalence Data \\
\textbf{pscl} & Political Science Computational Laboratory \\
\textbf{QGglmm} & Estimate Quantitative Genetics Parameters from Generalised Linear Mixed Models \\
\textbf{quantreg} & Quantile Regression \\
\textbf{r2glmm} & Computes R Squared for Mixed (Multilevel) Models \\
\textbf{R2OpenBUGS} & Running OpenBUGS from R \\
\textbf{rgl} & 3D Visualization Using OpenGL \\
\textbf{rjags} & Bayesian Graphical Models using MCMC \\
\textbf{rpql} & Regularized PQL for Joint Selection in GLMMs \\
\textbf{rstan} & R Interface to Stan \\
\textbf{rstanarm} & Bayesian Applied Regression Modeling via Stan \\
\textbf{spaMM} & Mixed-Effect Models, with or without Spatial Random Effects \\
\textbf{spBayes} & Univariate and Multivariate Spatial-Temporal Modeling \\
\textbf{spNNGP} & Spatial Regression Models for Large Datasets using Nearest Neighbor Gaussian Processes \\
\textbf{VGAM} & Vector Generalized Linear and Additive Models \\
\textbf{INLA} & Full Bayesian Analysis of Latent Gaussian Models using Integrated Nested Laplace Approximations \\
\bottomrule
\end{longtable}

\hypertarget{chap-notations}{%
\chapter{符号说明}\label{chap-notations}}

\begin{quote}
Fabio Mulazzani: I need to obtain all the 9.somethingExp157 permutations that can be given from the numbers from 1 to 100.

Ted Harding: To an adequate approximation there are 10\textsuperscript{158} of them. Simply to obtain them all (at a rate of 10\textsuperscript{10} per second, which is faster than the CPU frequency of most desktop computers) would take 10\textsuperscript{148} seconds, or slightly longer than \(3\times 10^{140}\) years. Current estimates of the age of the Universe are of the order of \(1.5\times 10^{10}\) years, so the Universe will have to last about \(2\times 10^{130}\) times as long as it has already existed, before the task could be finished.

So: why do you want to do this?

\hspace*{\fill} --- Fabio Mulazzani and Ted Harding \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2008-November/180820.html}}
\end{quote}

数学符号约定参考花书 \url{https://github.com/goodfeli/dlbook_notation}

\href{https://github.com/stefvanbuuren/fimdbook}{Flexible Imputation of Missing Data} 的 \href{https://stefvanbuuren.name/fimd/symbol-description.html}{符号约定章节}

\begin{quote}
矩阵、向量用粗体大写表示，特殊情况下，Y 只有一列
\end{quote}

\[
\mathsf{Y} = \mathbf{\mathsf{X}}\beta + \epsilon
\]

Y 叫做因变量或者响应变量 response variables，X 叫做自变量、协变量 covariate 或者预报变量 predictor variables

线性回归模型

\[y = X \beta + \epsilon\] 其中 \(y\) 是 \(n \times 1\) 的观测向量， \(X\) 为 \(n \times p\) 的设计矩阵，\(\beta\) 为未知参数向量，\(\beta_0\) 为常数项， \(\beta_1, \ldots, \beta_{p-1}\) 为回归系数， \(\epsilon\) 为 \(n \times 1\) 随机误差向量，其均值为 0，即 \(E(\epsilon_i) = 0\)

模型假设

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  误差项方差齐性，即

  \[Var(\epsilon_i) = \sigma^2, \quad i = 1, 2, \ldots, n\]
\item
  误差项彼此不相关，即

  \[Cov(\epsilon_i, \epsilon_j) = 0, \quad i \neq j,\quad i,j = 1, \ldots, n\]
\end{enumerate}

线性模型中\textbf{线性}二字实质上是指 y 关于未知参数 \(\beta_i\) 的关系是线性的。

\(A,B,C,D\) 斜体表示普通的集合，\(X,Y,Z\) 表示矩阵，\(a,b,c,d\) 表示常数，\(\alpha,\beta,\theta,\phi,\kappa\) 表示模型或者分布函数的参数，\(\Theta\) 表示参数空间，\(\mathbb{R}^{n},\mathbb{C}^{n}\) 表示特殊的 \(n\) 维实（复）数域，\(\mathscr{A,B,C,D}\) 表示一般的数域，\(\mathcal{S,P,G}\) 分别表示随机过程、概率空间和图

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.15}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.35}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.15}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.35}}@{}}
\caption{\label{tab:math-symbols} 数学符号表}\tabularnewline
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
符号
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
符号
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} \\
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
符号
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
符号
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} \\
\midrule
\endhead
\(\mathbf{A}\) & 粗体 & \(\Omega\) & 全集 \\
\(\mathit{A}\) & 集合 & \(\mathbb{R,C}\) & 实（复）数集 \\
\(\mathcal{A}\) & 集族 & \(\varnothing\) & 空集 \\
\(\mathsf{A}\) & 矩阵 & \(\mathsf{A}^{-}\) & 矩阵的广义逆 \\
\(\mathsf{A}^\top\) & 矩阵转置 & \(\bar{x}\) & 平均值 \\
\(\mathsf{A}^{-1}\) & 矩阵的逆 & \(\vert a \vert\) & 标量绝对值 \\
\(\mathsf{A}^{\star}\) & 伴随矩阵 & \(\mathop{\mathrm{diag}}(\mathsf{A})\) & 矩阵的对角 \\
\(\lVert \mathsf{A} \rVert_{1}\) & 矩阵的1范数 & \(\mathsf{I}\) & 单位矩阵 \\
\(\lVert \mathsf{A} \rVert_{2}\) & 矩阵的2范数 & \(\mathsf{I}_{n}\) & \(n\) 阶单位矩阵 \\
\(\lVert \mathsf{A} \rVert_{\infty}\) & 矩阵的无穷范数 & \(\mathsf{1}\) & 全1矩阵 \\
\(\lVert \mathsf{X} \rVert_{1}\) & 向量的1范数 & \(\mathsf{1}_{n}\) & \(n\) 阶全1矩阵 \\
\(\lVert \mathsf{X} \rVert_{2}\) & 向量的2范数 & \(\lVert \mathsf{X} \rVert_{\infty}\) & 向量的无穷范数 \\
\(\langle\mathsf{X},\mathsf{Y}\rangle\) & 向量的内积 & \(f(\mathsf{X})\) & 随机变量的函数 \\
\(\mathsf{X} \wedge \mathsf{Y}\) & 向量的外积 & \(\nabla{\mathsf{X}}\) & 向量微分或梯度 \\
\(\beta\) & 模型系数 & \(\theta\) & 模型或分布参数 \\
\(\alpha\) & 模型截距 & \(\Theta\) & 参数空间 \\
\(\hat{\beta}_{ls}\) & 模型系数的LS估计 & \(f(x)\) & 标量值函数 \\
\(\hat{\beta}_{mle}\) & 模型系数的MLE估计 & \(f(\mathsf{X})\) & 向量的函数 \\
\(\hat{\beta}_{bayes}\) & 模型系数的Bayes估计 & \(\mathcal{X}\) & 概率空间 \\
\(\rho\) & 相关系数 & \(\kappa\) & 贝塞尔函数的阶 \\
\(\phi\) & 尺度参数 & \(u\) & 距离 \(\lVert \mathsf{x}_1 -\mathsf{x}_2\rVert\) \\
\(\mathbb{R}^2\) & 二维实数域 & \(S(x)\) & 空间过程 \\
\(\mathcal{S}\) & \(\mathcal{S} = \{S(x):x \in \mathbb{R}^2\}\) & \(\mathcal{S}^{\star}\) & 随机过程 \(\mathcal{S}\) 的近似 \\
\(\triangleq\) & 定义为或记为 & \(\hat{\beta}_{ridge}\) & \(\beta\) 的岭回归估计 \\
\(A \geq 0\) & 矩阵 A 半正定 & \(\hat{\beta}_{lar}\) & \(\beta\) 的最小角回归估计 \\
\(A > 0\) & 矩阵 A 正定 & \(\hat{\beta}_{subset}\) & \(\beta\) 的最优子集回归估计 \\
\(A\otimes B\) & 矩阵 A 与 B 的 Kronecher 积 & MSE 均方误差 & \(\frac{1}{n}\sum_{i=1}^{n}(y_i - \hat{y_i})^2\) \\
\(\mathcal{M}(A)\) & 矩阵 A 的列向量张成的子空间 & RMSE 均方根误差 & \(\sqrt{\frac{1}{n}\sum_{i=1}^{n}(y_i - \hat{y_i})^2}\) \\
\(\|A\|\) & 矩阵 A 的范数 & MAE 平均绝对误差 & \(\frac{1}{n}\sum_{i=1}^{n}|y_i-\hat{y_i}|\) \\
\(|A|\) & 矩阵 A 的行列式 & LSE & 最小二乘估计 \\
\(rk(A)\) & 矩阵 A 的秩 & BLUE & 最佳线性无偏估计 \\
\(tr(A)\) & 方阵 A 的迹 & MVUE & 最小方差无偏估计 \\
\(A^{-1}\) & 矩阵 A 的逆 & UMVUE & 一致最小方差无偏估计 \\
\(A^{-}\) & 矩阵 A 的广义逆 & MINQUE & 最小范数二次无偏估计 \\
\(\hat{\beta}_{ols}\) & \(\beta\) 的普通最小二乘估计 & OLS & 普通最小二乘估计 \\
\(\hat{\beta}_{pca}\) & \(\beta\) 的主成分分析估计 & PLS & 偏最小二乘估计 \\
\(\hat{\beta}_{pls}\) & \(\beta\) 的偏最小二乘估计 & GLS & 广义最小二乘估计 \\
\(\hat{\beta}_{svm}\) & \(\beta\) 的支持向量机估计 & WLS & 带权最小二乘估计 \\
\(\hat{\beta}_{lasso}\) & \(\beta\) 的 Lasso 估计 & - & - \\
\bottomrule
\end{longtable}

多元统计分析 高惠璇 矩阵符号表示，深度学习符号表示 \url{https://github.com/XiangyunHuang/dlbook}

举例，线性模型的表示，此处 \(Y\) 为 \(n\times 1\)列向量，\(X\) 为\(p\times n\)的矩阵，\(\beta\) 为 \(p\times 1\)的列向量 ，\(\epsilon\) 为\(n\times1\)列向量 \[Y = X'\beta + \epsilon\] \[\mathsf{A} = \varGamma^\top\Lambda\varGamma\] \[\mathsf{u} = (u_1,u_2,\cdots,u_n)\] \[\mathsf{x} = (x_1,x_2,\cdots,x_n)\] 期望 \(\mathsf{E}\) 正态分布 \(\mathcal{N}(\mathsf{x};\mu,\Sigma)\) 对数 \(\mathsf{\log}\) 协方差 \(\mathsf{Cov},\mathsf{Var}\)

矩阵 \[\mathsf{Y} = (\mathsf{y}^{(1)},\mathsf{y}^{(n)},\cdots,\mathsf{y}^{(n)})\] 其中 \(\mathsf{y}^{(i)} = (y_{1i},y_{2i},\cdots,y_{ni})\) 表示第 \(i\) 列

梅隆函数(Matern function)是描述空间相关性的常用函数，它带有两参数\(\kappa\) 和 \(\phi\)，具体形式如下： \[\rho(u) = \big\{2^{\kappa-1}\Gamma(\kappa)\big\}^{-1}(u/\phi)^{\kappa}K_{\kappa}(u/\phi)\] 其中，\(K_{\kappa}(\cdot)\) 表示 \(\kappa\) 阶修正的贝塞尔函数

\backmatter
\printindex

  \bibliography{book.bib,packages.bib}

\end{document}
