% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode,linktoc=all,pdfstartview=FitH,bookmarksnumbered=true}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  10pt,
  a4paper,
  UTF8,twoside,openany,table]{book}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \ifXeTeX
    \usepackage{mathspec}
  \else
    \usepackage{unicode-math}
  \fi
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{fancyvrb}
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={R 语言学习笔记},
  pdfauthor={黄湘云},
  colorlinks=true,
  linkcolor={Maroon},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\VerbatimFootnotes % allow verbatim text in footnotes
\usepackage[tmargin=2.5cm,bmargin=2.5cm,lmargin=3.0cm,rmargin=2.0cm]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% \usepackage[cam,a4,center]{crop}

\usepackage[fontset=fandol, heading=true, UTF8]{ctex}
\usepackage[lotdepth=2, lofdepth=2]{subfig}
\usepackage[toc]{multitoc}
\usepackage[rmdefault,semibold]{sourceserifpro}
\usepackage[sfdefault,semibold]{sourcesanspro}
\usepackage[scale=0.85,semibold]{sourcecodepro}

\usepackage{float,animate,awesomebox}

\usepackage[skins]{tcolorbox}

\definecolor{colortip}{RGB}{81,183,73}
\definecolor{colornote}{RGB}{251,188,5}
\definecolor{colorwarn}{RGB}{255,83,59}
\definecolor{colorinfo}{RGB}{204,204,204}

\tcbset{
  colbacktitle=white,
  enhanced,
  attach boxed title to top center={yshift=-2mm},
  colback=white, % 背景色
  coltext=black, % 文本色
  leftrule=1mm,
  rightrule=.25mm,
  bottomrule=.25mm,
  toprule=.25mm,
  boxsep=1pt, % 文字和边框的空隙
  arc=1pt % 圆角
}

\newtcolorbox{rmdtip}[1]{
  title=#1,
  coltitle=colortip,
  colframe=colortip, % 边框色
}

\newtcolorbox{rmdnote}[1]{
  title=#1,
  coltitle=colornote,
  colframe=colornote % 边框色
}

\newtcolorbox{rmdwarn}[1]{
  title=#1,
  coltitle=colorwarn,
  colframe=colorwarn % 边框色
}

\newtcolorbox{rmdinfo}{
  colframe=colorinfo % 边框色
}

\newenvironment{columns}[1][]{}{}

\newenvironment{column}[1]{\begin{minipage}{#1}\ignorespaces}{%
\end{minipage}
\ifhmode\unskip\fi
\aftergroup\useignorespacesandallpars}

\def\useignorespacesandallpars#1\ignorespaces\fi{%
#1\fi\ignorespacesandallpars}

\makeatletter
\def\ignorespacesandallpars{%
  \@ifnextchar\par
    {\expandafter\ignorespacesandallpars\@gobble}%
    {}%
}
\makeatother

% 添加版权水印
% https://github.com/callegar/LaTeX-draftwatermark
% https://github.com/callegar/LaTeX-everypage
% https://ctan.org/pkg/draftwatermark
% draftwatermark 依赖 everypage
\usepackage[angle=90,text=\textcopyright 黄湘云,color=gray,pos={0.5in,1.5in},scale=0.25]{draftwatermark}
% draftwatermark 和 everypage 由同一个人维护，后者将停止维护
% https://github.com/CTeX-org/ctex-kit/issues/331
\RecustomVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\},formatcom=\xeCJKVerbAddon}

\usepackage{bm,mathrsfs} % \mathcal \mathbb \mathscr \boldsymbol \bm

\usepackage{makeidx}
\makeindex

\frontmatter
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{plainnat}

\title{R 语言学习笔记}
\author{黄湘云}
\date{2022-06-10}

\begin{document}
\maketitle

{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}
\listoffigures
\listoftables
\mainmatter

\hypertarget{welcome}{%
\chapter*{欢迎}\label{welcome}}
\addcontentsline{toc}{chapter}{欢迎}

\chaptermark{欢迎}

\begin{rmdwarn}{警告}
Book in early development. Planned release in 202X.

\end{rmdwarn}

\hypertarget{sec-licenses}{%
\section*{授权说明}\label{sec-licenses}}
\addcontentsline{toc}{section}{授权说明}

\begin{rmdwarn}{警告}
本书采用 \href{https://creativecommons.org/licenses/by-nc-nd/4.0/}{知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议} 许可，请君自重，别没事儿拿去传个什么新浪爱问、百度文库以及 XX 经济论坛，项目中代码使用 \href{https://github.com/XiangyunHuang/notesdown/blob/master/LICENSE}{MIT 协议} 开源

\end{rmdwarn}

\begin{flushleft}\includegraphics[width=0.15\linewidth]{images/cc-by-nc-nd} \end{flushleft}

\hypertarget{sec-session-welcome}{%
\section*{运行信息}\label{sec-session-welcome}}
\addcontentsline{toc}{section}{运行信息}

书籍在 R version 4.2.0 (2022-04-22) 下编译，Pandoc 版本 2.16.2，最新一次编译发生在 2022-06-10 09:48:13。

\hypertarget{chap-preface}{%
\chapter{前言}\label{chap-preface}}

\begin{quote}
荃者所以在鱼，得鱼而忘荃；蹄者所以在兔；得兔而忘蹄；言者所以在意，得意而忘言。吾安得夫忘言之人而与之言哉！

\hspace*{\fill} --- 摘自 《庄子·杂篇·物》
\end{quote}

庄子谈学习，余深以为然，故引之。

\begin{quote}
The fish trap exists because of the fish; once you've gotten the fish, you can forget the trap. The rabbit snare exists because of the rabbit; once you've gotten the rabbit, you can forget the snare. Words exist because of meaning; once you've gotten the meaning, you can forget the words. Where can I find a man who has forgotten words so I can have a word with him ? \footnote{译文摘自 \href{http://math.bu.edu/people/kolaczyk/teach.html}{Eric D. Kolaczyk}}

\hspace*{\fill} --- Chuang Tzu
\end{quote}

\hypertarget{sec-r-or-python}{%
\section{语言抉择}\label{sec-r-or-python}}

\index{Octave} \index{Python}

行业内可以做统计分析和建模的软件汗牛充栋，比较顶级的收费产品有 SAS 和 SPSS，在科学计算领域的 Matlab 和 Mathematica 也有相当强的统计功能，而用户基数最大的是微软 Excel，抛开微软公司的商业手段不说，Excel 的市场份额却是既成事实。 Brian D. Ripley 20 多年前的一句话很有意思，放在当下也是适用的。

\begin{quote}
Let's not kid ourselves: the most widely used piece of software for statistics is Excel.

\hspace*{\fill} --- Brian D. Ripley \citep{Ripley_2002_SS}
\end{quote}

有鉴于 Excel 在人文、社会、经济和管理等领域的影响力，熟悉 R 语言的人把它看作超级收费版的 Excel，这实在是一点也不过分。事实上，我司就是一个很好的明证，一个在线教育类的互联网公司，各大业务部门都在使用 Excel 作为主要的数据分析工具。然而，Excel 的不足也十分突出，工作过程无法保存和重复利用，Excel 也不是数据库，数据集稍大，操作起来愈发困难，对于复杂的展示，需要借助内嵌的 VBA，由于缺乏版本控制，随着时间的推移，几乎不可维护。所以，我们还是放弃 Excel 吧，Jenny Bryan 更在 2016 年国际 R 语言大会上的直截了当地喊出了这句话\footnote{\url{https://channel9.msdn.com/Events/useR-international-R-User-conference/useR2016/jailbreakr-Get-out-of-Excel-free}}。Nathan Stephens 对 Excel 的缺陷不足做了全面的总结\footnote{\url{https://resources.rstudio.com/wistia-rstudio-essentials-2/how-to-excel-without-using-excel}}。

\begin{quote}
Some people familiar with R describe it as a supercharged version of Microsoft's Excel spreadsheet software.

\hspace*{\fill} --- Ashlee Vance \footnote{\url{https://www.nytimes.com/2009/01/07/technology/business-computing/07program.html}}
\end{quote}

另一方面，我们谈谈开源领域的佼佼者 --- R (\url{https://cran.r-project.org/})，Python (\url{https://www.python.org/}) 和 Octave (\url{http://www.gnu.org/software/octave/})。Python 号称万能的胶水语言，从系统运维到深度学习都有它的广泛存在，它被各大主流 Linux 系统内置，语言风格上更接近于基数庞大的开发人员，形成了强大的生态平台。 Octave 号称是可以替代 Matlab 的科学计算软件，在兼容 Matlab 的方面确实做的很不错，然而，根据 Julia 官网给出的各大编程语言的测试 \url{https://julialang.org/benchmarks/}，性能上不能相提并论。

\begin{figure}

{\centering \includegraphics[width=0.85\linewidth]{preface_files/figure-latex/r-eco-system-1} 

}

\caption{R 语言扩展包生态系统}\label{fig:r-eco-system}
\end{figure}

R 提供了丰富的图形接口，包括 Tcl/Tk , Gtk, Shiny 等，以及基于它们的衍生品 rattle（\href{http://www.ggobi.org/rgtk2/}{RGtk2}）、\href{https://CRAN.R-project.org/package=Rcmdr}{Rcmdr}（tcl/tk）、\href{https://github.com/radiant-rstats/radiant}{radiant}（shiny）。更多底层介绍，见 John Chamber 的著作《Extending R》。

\href{https://www.eviews.com}{Eviews} 时间序列和计量经济模型，相比于 Eviews， \href{https://www.stata.com/}{Stata} 是综合型的统计软件，提供丰富的统计模型， \href{https://www.ibm.com/cn-zh/products/spss-statistics}{SPSS} 同 Stata 类似，\href{https://www.minitab.com/zh-cn/}{Minitab}， \href{https://jasp-stats.org/}{JASP} 是开源的软件， \href{https://www.gnu.org/software/octave/}{Octave} 是对标 Matlab 的工程计算软件， 有丰富的优化功能，是一门编程语言兼软件，为求解统计模型的参数提供了广泛的基础能力。\href{https://www.tableau.com/zh-cn}{Tableau} 提供强大的分析和打造数据产品的能力。TikZ 在绘制示意图方面有很大优势，特别是示意图里包含数学公式，这更是 LaTeX 所擅长的方面。

JASP \url{https://jasp-stats.org} 是一款免费的统计软件，源代码托管在 Github 上 \url{https://github.com/jasp-stats/jasp-desktop}，主要由阿姆斯特丹大学 E. J. Wagenmakers 教授 \url{https://www.ejwagenmakers.com/} 领导的团队维护开发，实现了很多贝叶斯和频率统计方法，相似的图形用户界面使得 JASP 可以作为 SPSS 的替代，目前实现的功能见 \url{https://jasp-stats.org/current-functionality/}，统计方法见博客 \url{https://www.bayesianspectacles.org/}。

国内可视化分析平台，比如 \href{https://github.com/hiplot}{hiplot} 基于 R 语言实现可视化分析，各类图形的介绍见\href{https://hiplot.com.cn/docs/zh/}{文档}，极大地降低数据分析人员探索分析的门槛，节省了时间，同时非专业内的人也可借助其完成分析探索的过程，只需明白各类图形的含义即可。美团也建设了自己的可视化分析平台帮助运营人员，详见\href{https://tech.meituan.com/2018/08/02/mt-r-practice.html}{文档}

\href{https://www.burns-stat.com/}{Patrick Burns} 收集整理了 R 语言中奇葩的现象，写成 \href{https://www.burns-stat.com/pages/Tutor/R_inferno.pdf}{The R Inferno} 直译过来就是《R 之炼狱》。这些奇葩的怪现象可以看做是 R 风格的一部分，对于编程人员来说就是一些建议和技巧，参考之可以避开某些坑。 Paul E. Johnson 整理了一份真正的 R 语言建议，记录了他自己从 SAS 转换到 R 的过程中遇到的各种问题 \url{http://pj.freefaculty.org/R/Rtips.html}。Michail Tsagris 和 Manos Papadakis 也收集了 70 多条 R 编程的技巧和建议，力求以更加 R 范地将语言特性发挥到极致 \citep{Rfast_2018_Tsagris}，Martin Mächler 提供了一份 \href{https://stat.ethz.ch/Teaching/maechler/R/useR_2014/}{Good Practices in R Programming}。 Python 社区广泛流传着 Tim Peters 的 《Python 之禅》，它已经整合进每一版 Python 软件中，只需在 Python 控制台里执行 \texttt{import\ this} 可以获得。

\begin{quote}
\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Beautiful is better than ugly.
\item
  Explicit is better than implicit.
\item
  Simple is better than complex.
\item
  Complex is better than complicated.
\item
  Flat is better than nested.
\item
  Sparse is better than dense.
\item
  Readability counts.
\item
  Special cases aren't special enough to break the rules.
\item
  Although practicality beats purity.
\item
  Errors should never pass silently.
\item
  Unless explicitly silenced.
\item
  In the face of ambiguity, refuse the temptation to guess.
\item
  There should be one-- and preferably only one --obvious way to do it.
\item
  Although that way may not be obvious at first unless you're Dutch.
\item
  Now is better than never.
\item
  Although never is often better than \emph{right} now.
\item
  If the implementation is hard to explain, it's a bad idea.
\item
  If the implementation is easy to explain, it may be a good idea.
\item
  Namespaces are one honking great idea -- let's do more of those!
\end{enumerate}

\hspace*{\fill} --- The Zen of Python
\end{quote}

总之，编程语言到一定境界都是殊途同归的，对美的认识也是趋同的，道理更是相通的，Python 社区的 Pandas \url{https://github.com/pandas-dev/pandas} 和 Matplotlib \url{https://github.com/matplotlib/matplotlib} 也有数据框和图形语法的影子。Pandas \url{https://github.com/pandas-dev/pandas} 明确说了要提供与 data.frame 类似的数据结构和对应统计函数等，而 Matplotlib 偷了 ggplot2 绘图样式 \url{https://matplotlib.org/3.2.2/gallery/style_sheets/ggplot.html}。

\hypertarget{sec-data-science}{%
\section{数据科学}\label{sec-data-science}}

John M. Chambers 谈了数据科学的源起以及和 S、R 语言的渊源 \citep{RS_2020_John}。

\hypertarget{sec-r-help}{%
\section{获取帮助}\label{sec-r-help}}

R 社区提供了丰富的帮助资源，可以在 R 官网搜集的高频问题 \url{https://cran.r-project.org/faqs.html} 中查找，也可在线搜索 \url{https://cran.r-project.org/search.html} 或 \url{https://rseek.org/} ，更多获取帮助方式见 \url{https://www.r-project.org/help.html}。爆栈网问题以标签分类，比如 \href{https://stackoverflow.com/questions/tagged/r-plotly}{r-plotly}、\href{https://stackoverflow.com/questions/tagged/r-markdown}{r-markdown}、 \href{https://stackoverflow.com/questions/tagged/data.table}{data.table} 和 \href{https://stackoverflow.com/questions/tagged/ggplot2}{ggplot2}，还可以关注一些活跃的社区大佬，比如 \href{https://stackoverflow.com/users/559676/yihui-xie}{谢益辉}。

\hypertarget{sec-writing-details}{%
\section{写作环境}\label{sec-writing-details}}

\index{bookdown} \index{Pandoc}

\begin{figure}

{\centering \includegraphics{preface_files/figure-latex/book-workflow-1} 

}

\caption{书籍项目架构图}\label{fig:book-workflow}
\end{figure}

本书 R Markdown 源文件托管在 Github 仓库里，本地使用 RStudio IDE 编辑，bookdown 组织各个章节的 Rmd 文件和输出格式，使用 Git 进行版本控制。每次提交修改到 Github 上都会触发 Travis 自动编译书籍，将一系列 Rmd 文件经 knitr 调用 R 解释器执行里面的代码块，并将输出结果返回，Pandoc 将 Rmd 文件转化为 md 、 html 或者 tex 文件。若想输出 pdf 文件，还需要准备 TeX 排版环境，最后使用 Netlify 托管书籍网站，和 Travis 一起实现连续部署，使得每次修改都会同步到网站。最近一次编译时间 2022年06月10日01时48分13秒，本书用 R version 4.2.0 (2022-04-22) 编译，完整运行环境如下：

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{(}\AttributeTok{packages =} \FunctionTok{c}\NormalTok{(}
  \StringTok{"knitr"}\NormalTok{, }\StringTok{"rmarkdown"}\NormalTok{, }\StringTok{"bookdown"}
\NormalTok{), }\AttributeTok{dependencies =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   bookdown_0.26  knitr_1.39     rmarkdown_2.14
## 
## Pandoc version: 2.16.2
\end{verbatim}

借助 \textbf{bookdown} \citep{xie2016} 可以将 Rmd 文件组织起来， \textbf{rmarkdown} \citep{rmarkdown}和 \textbf{knitr} \citep{xie2015} 将源文件编译成 Markdown 文件， \href{https://pandoc.org/}{Pandoc} 将 Markdown 文件转化成 HTML 和 TeX 文件， \href{https://yihui.name/tinytex/}{TinyTeX} \citep{xie2019} 可以将 TeX 文件进一步编译成 PDF 文档，书中大量的图形在用 \textbf{ggplot2} 包制作 \citep{Wickham_2016_ggplot2}，而统计理论相关的示意图用 Base R 创作。

\begin{rmdtip}{提示}
得益于 Github Action 提供的测试服务，\href{https://pages.github.com/}{Github Pages}、\href{https://bookdown.org}{Bookdown} 和 \href{https://netlify.com/}{Netlify} 提供的部署服务，鉴于国内的网络环境，本书托管在三个地方，分别是 \url{https://xiangyunhuang.github.io/notesdown/}， \url{https://bookdown.org/xiangyun/notesdown/} ， \url{https://notesdown.netlify.app/}。

\end{rmdtip}

\hypertarget{sec-conventions}{%
\section{记号约定}\label{sec-conventions}}

正文中的代码、函数、参数及参数值以等宽正体表示，如 \VERB|\FunctionTok{data}\NormalTok{(}\AttributeTok{list =} \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}iris\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}BOD\textquotesingle{}}\NormalTok{))}|， 其中函数名称 \texttt{data()}，参数及参数值 \VERB|\NormalTok{list }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}iris\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}BOD\textquotesingle{}}\NormalTok{)}| ，R 程序包用粗体表示，如 \textbf{graphics}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ruler}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
----+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8
12345678901234567890123456789012345678901234567890123456789012345678901234567890
\end{verbatim}

\hypertarget{sec-contribute}{%
\section{复现环境}\label{sec-contribute}}

\begin{quote}
构建容器
\end{quote}

本书借助 Github Action 从 Dockerfile 构建容器镜像，然后将镜像文件推送到 Github Package。完成这些操作首先需要从 \url{https://github.com/settings/tokens} 新建拥有 GitHub Package \footnote{\url{https://docs.github.com/en/packages/using-github-packages-with-your-projects-ecosystem/configuring-docker-for-use-with-github-packages}} 读写删的权限的 TOKEN（俗称访问令牌或密钥），命名为 \texttt{GITHUB\_PKG}，并将此令牌保存到本地 TOKEN.txt 文件中，以备后用。

镜像内默认暴露 8181 端口供外部连接使用，进入容器后，默认工作路径是 \texttt{/home/docker/}。创建好镜像后，要先登陆 GitHub Package 然后才有权限将镜像拉取下来

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 登陆 GitHub Package}
\FunctionTok{cat}\NormalTok{ \textasciitilde{}/TOKEN.txt }\KeywordTok{|} \ExtensionTok{docker}\NormalTok{ login https://docker.pkg.github.com }\AttributeTok{{-}u}\NormalTok{ XiangyunHuang }\AttributeTok{{-}{-}password{-}stdin}
\CommentTok{\# 拉取镜像}
\ExtensionTok{docker}\NormalTok{ pull docker.pkg.github.com/xiangyunhuang/notesdown/notesdown{-}book:devel}
\end{Highlighting}
\end{Shaded}

读者可以先查看下容器内的信息

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}{-}rm} \AttributeTok{{-}u}\NormalTok{ root }\AttributeTok{{-}v} \StringTok{"/}\VariableTok{$\{PWD\}}\StringTok{://home/docker/"} \DataTypeTok{\textbackslash{}}
\NormalTok{  docker.pkg.github.com/xiangyunhuang/notesdown/notesdown{-}book:devel }\DataTypeTok{\textbackslash{}}
\NormalTok{  bash }\AttributeTok{{-}c} \StringTok{"locale; fc{-}list | sort"}
\end{Highlighting}
\end{Shaded}

\begin{quote}
运行容器
\end{quote}

下面从镜像创建一个叫 notesdown-book 的容器，并让它在后台运行，允许以真正的 root 账户权限交互式执行命令，停止容器后，自动销毁容器。 此处，不再介绍 Docker 容器的使用，用容器打包本书所有软件环境仅供读者完整复现本书之用，感兴趣的读者可以去参考书籍\href{https://vuepress.mirror.docker-practice.com/}{Docker 从入门到实践}。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}itd} \AttributeTok{{-}p}\NormalTok{ 8282:8787 }\AttributeTok{{-}{-}rm} \AttributeTok{{-}{-}name}\OperatorTok{=}\NormalTok{notesdown{-}book }\AttributeTok{{-}{-}privileged}\OperatorTok{=}\NormalTok{true }\DataTypeTok{\textbackslash{}}
\NormalTok{  docker.pkg.github.com/xiangyunhuang/notesdown/notesdown{-}book:devel /sbin/init}
\end{Highlighting}
\end{Shaded}

接着登陆进入 notesdown-book 容器，

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ exec }\AttributeTok{{-}it}\NormalTok{ notesdown{-}book bash}
\end{Highlighting}
\end{Shaded}

一番骚操作后，用户退出容器，然后停止容器。

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ stop notesdown{-}book}
\end{Highlighting}
\end{Shaded}

\begin{quote}
使用 RStudio Server
\end{quote}

启动容器后，接着获取容器 notesdown-book 的 IP 地址，然后依据端口号 8282 从网页进入 RStudio Sever，比如 \url{http://192.168.100.23:8282}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ inspect }\AttributeTok{{-}{-}format}\OperatorTok{=}\StringTok{\textquotesingle{}\{\{.NetworkSettings.IPAddress\}\}\textquotesingle{}}\NormalTok{ notesdown{-}book}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-help-me}{%
\section{如何发问}\label{sec-help-me}}

\begin{quote}
The phrase ``does not work'' is not very helpful, it can mean quite a few things including:

\begin{itemize}
\tightlist
\item
  Your computer exploded.
\item
  No explosion, but smoke is pouring out the back and microsoft's ``NoSmoke'' utility is not compatible with your power supply.
\item
  The computer stopped working.
\item
  The computer sits around on the couch all day eating chips and watching talk shows.
\item
  The computer has started picketing your house shouting catchy slogans and demanding better working conditions and an increase in memory.
\item
  Everything went dark and you cannot check the cables on the back of the computer because the lights are off due to the power outage.
\item
  R crashed, but the other programs are still working.
\item
  R gave an error message and stopped processing your code after running for a while.
\item
  R gave an error message without running any of your code (and is waiting for your next command).
\item
  R is still running your code and the time has exceeded your patience so you think it has hung.
\item
  R completed and returned a result, but also gave warnings.
\item
  R completed your command, but gave an incorrect answer.
\item
  R completed your command but the answer is different from what you expect (but is correct according to the documentation).
\end{itemize}

There are probably others. Running your code I think the answer is the last one.

\hspace*{\fill} --- Greg Snow \footnote{来自 R 社区论坛收集的智语 \texttt{fortunes::fortune(324)}。}
\end{quote}

\hypertarget{sec-about-author}{%
\section{作者简介}\label{sec-about-author}}

热心开源事业，统计之都副主编，经常混迹于统计之都论坛、Github 和爆栈网。个人主页 \url{https://xiangyun.rbind.io/}

\hypertarget{part-ux6570ux636eux6574ux7406}{%
\part{数据整理}\label{part-ux6570ux636eux6574ux7406}}

\hypertarget{chap-data-wrangling}{%
\chapter*{介绍}\label{chap-data-wrangling}}
\addcontentsline{toc}{chapter}{介绍}

数据整理

\hypertarget{chap-data-structure}{%
\chapter{数据结构}\label{chap-data-structure}}

网站 \url{https://r-coder.com/} 主要介绍 Base R，特点是全面细致，排版精美

\begin{quote}
可用于绘图的数据对象，向量 vector 等，只涉及基础操作和绘图，关键在入门引导式的介绍，点到即止
\end{quote}

数据类型：字符、数值：字符数据操作：按数据类型介绍各类数据操作，重复之处如前所述，数据处理的分类：按数据类型来，一共是 table matrix data.frame 和 vector

\begin{quote}
The trouble with nonstandard evaluation is that it doesn't follow standard evaluation rules\ldots{}

\hspace*{\fill} --- Peter Dalgaard (about nonstandard evaluation in the \texttt{curve()} function) R-help (June 2011)
\end{quote}

向量，列表，

数据框 data frame 在 R 里面可以用三种不同类型的数据对象来表达

\begin{quote}
从历史脉络来看，为什么会出现三种不同的东西，它们之间的区别和联系是什么，能否用一张表来描述
\end{quote}

data.frame 设计的历史，首次包含在 R 里面是什么时候，R 是否一发布就包含了这个数据类型

The function \texttt{data.frame()} creates data frames, tightly coupled collections of variables which share many of the properties of matrices and of lists, used as the fundamental data structure by most of R's modeling software.

\textbf{data.table} 2006 年 4 月 15 日首次登陆 CRAN 发布 1.0 版本，差不多恰好 10 年后

\textbf{tibble} 在 2016 年 3 月 23 日首次登陆 CRAN 发布 1.0 版本

\texttt{data.frame()}， \texttt{tibble()} 和 \texttt{data.table()} 的区别，去看函数的帮助文档

Provides a `tbl\_df' class (the `tibble') that provides stricter checking and better formatting than the traditional data frame.

\href{https://github.com/r-lib/vctrs}{vctrs} 和 \href{https://github.com/r-lib/rlang}{rlang} 包 R 内置的 \href{https://cran.r-project.org/doc/manuals/r-release/R-lang.html}{R Language Definition}

\hypertarget{subsec:typeof}{%
\section{类型}\label{subsec:typeof}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"abc"} \CommentTok{\# 数据对象}
\FunctionTok{typeof}\NormalTok{(x) }\CommentTok{\# 数据类型}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "character"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mode}\NormalTok{(x) }\CommentTok{\# 存储模式}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "character"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{storage.mode}\NormalTok{(x) }\CommentTok{\# 存储类型}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "character"
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\caption[\label{tab:all-data-type} 函数 \texttt{typeof()} 返回的数据类型 ]{\label{tab:all-data-type} 函数 \texttt{typeof()} 返回的数据类型 \footnote{表格中带 *** 标记的类型，用户不能轻易获得}}\tabularnewline
\toprule
符号 & 含义 \\
\midrule
\endfirsthead
\toprule
符号 & 含义 \\
\midrule
\endhead
\texttt{NULL} & 空值 \\
\texttt{symbol} & 可变的名称/变量 \\
\texttt{pairlist} & pairlist 对象*** \\
\texttt{closure} & 函数闭包 \\
\texttt{environment} & 环境 \\
\texttt{promise} & 实现惰性求值的对象 \\
\texttt{language} & R 语言构造 \\
\texttt{special} & 内部函数，不计算参数 \\
\texttt{builtin} & 内部函数，计算参数 \\
\texttt{char} & scalar 型字符对象*** \\
\texttt{logical} & 逻辑向量 \\
\texttt{integer} & 整数向量 \\
\texttt{double} & 实值向量 \\
\texttt{complex} & 复值向量 \\
\texttt{character} & 字符向量 \\
\texttt{...} & 可变长度的参数*** \\
\texttt{any} & 匹配任意类型 \\
\texttt{expression} & 表达式对象 \\
\texttt{list} & 列表 \\
\texttt{bytecode} & 位代码*** \\
\texttt{externalptr} & 外部指针对象 \\
\texttt{weakref} & 弱引用对象 \\
\texttt{raw} & 位向量 \\
\texttt{S4} & S4 对象 \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.0741}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1019}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.3148}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.3148}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1019}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.0926}}@{}}
\caption{\label{tab:basic-data-type} R/Rcpp 提供的基本数据类型}\tabularnewline
\toprule
\begin{minipage}[b]{\linewidth}\centering
Value
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
R vector
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp vector
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp matrix
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp scalar
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
C++ scalar
\end{minipage} \\
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{\linewidth}\centering
Value
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
R vector
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp vector
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp matrix
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Rcpp scalar
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
C++ scalar
\end{minipage} \\
\midrule
\endhead
Logical & \texttt{logical} & \texttt{LogicalVector} & \texttt{LogicalMatrix} & - & \texttt{bool} \\
Integer & \texttt{integer} & \texttt{IntegerVector} & \texttt{IntegerMatrix} & - & \texttt{int} \\
Real & \texttt{numeric} & \texttt{NumericVector} & \texttt{NumericMatrix} & - & \texttt{double} \\
Complex & \texttt{complex} & \texttt{ComplexVector} & \texttt{ComplexMatrix} & \texttt{Rcomplex} & \texttt{complex} \\
String & \texttt{character} & \texttt{CharacterVector} (\texttt{StringVector}) & \texttt{CharacterMatrix} (\texttt{StringMatrix}) & \texttt{String} & \texttt{string} \\
Date & \texttt{Date} & \texttt{DateVector} & - & \texttt{Date} & - \\
Datetime & \texttt{POSIXct} & \texttt{DatetimeVector} & - & \texttt{Datetime} & \texttt{time\_t} \\
\bottomrule
\end{longtable}

\hypertarget{sec-character}{%
\section{字符}\label{sec-character}}

\hypertarget{sec-vector}{%
\section{向量}\label{sec-vector}}

\hypertarget{sec-matrix}{%
\section{矩阵}\label{sec-matrix}}

\hypertarget{sec-array}{%
\section{数组}\label{sec-array}}

更多数组操作 \href{https://github.com/r-lib/rray}{rray}

\hypertarget{sec-expression}{%
\section{表达式}\label{sec-expression}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# \%||\% 中缀符}
\CommentTok{\# x 是空值或者长度为 0 则保留 y 否则保留 x}
\ControlFlowTok{function}\NormalTok{(x, y) }\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(x) }\SpecialCharTok{||} \FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) y }\ControlFlowTok{else}\NormalTok{ x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function(x, y) if (is.null(x) || length(x) == 0) y else x
\end{verbatim}

\hypertarget{sec-list}{%
\section{列表}\label{sec-list}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{a =} \DecValTok{1}\NormalTok{, }\AttributeTok{b =} \DecValTok{2}\NormalTok{, }\AttributeTok{c =} \FunctionTok{list}\NormalTok{(}\AttributeTok{d =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{e =} \StringTok{"hello"}\NormalTok{))}
\FunctionTok{print}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $a
## [1] 1
## 
## $b
## [1] 2
## 
## $c
## $c$d
## [1] 1 2 3
## 
## $c$e
## [1] "hello"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{base}\SpecialCharTok{::}\FunctionTok{print.simple.list}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      _    
## a    1    
## b    2    
## c.d1 1    
## c.d2 2    
## c.d3 3    
## c.e  hello
\end{verbatim}

\hypertarget{sec-date}{%
\section{日期}\label{sec-date}}

注意观察时间转化

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.Date}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2022-06-10"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.time}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2022-06-10 01:48:14 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{c}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\FunctionTok{Sys.Date}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2022-06-10 01:48:14 UTC" "2022-06-10 00:00:00 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2022
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2022
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\FunctionTok{Sys.Date}\NormalTok{()))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2022 2022
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{Sys.time}\NormalTok{()}
\FunctionTok{class}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "POSIXct" "POSIXt"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2022-06-10"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"2019{-}12{-}21"}\NormalTok{, }\StringTok{"2019/12/21"}\NormalTok{)}
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\StringTok{"2019{-}12{-}21"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2019
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\StringTok{"2019/12/21"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2019
\end{verbatim}

但是，下面这样会报错

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in as.POSIXlt.character(x): character string is not in a standard unambiguous format
\end{verbatim}

正确的姿势是首先将表示日期的字符串格式统一

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"/"}\NormalTok{, }\AttributeTok{replacement =} \StringTok{"{-}"}\NormalTok{, x) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2019 2019
\end{verbatim}

date-times 表示 POSIXct 和 POSIXlt 类型的日期对象

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(x }\OtherTok{\textless{}{-}} \FunctionTok{Sys.time}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2022-06-10 01:48:14 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "POSIXct" "POSIXt"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{second}\NormalTok{(x) }\CommentTok{\# 取秒}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 14
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%S"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "14"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{minute}\NormalTok{(x) }\CommentTok{\# 取分}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 48
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%M"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "48"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{hour}\NormalTok{(x) }\CommentTok{\# 取时}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%H"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "01"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{yday}\NormalTok{(x) }\CommentTok{\# 此刻在一年的第几天}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 161
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{wday}\NormalTok{(x) }\CommentTok{\# 此刻在一周的第几天，星期日是第1天，星期六是第7天}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{mday}\NormalTok{(x) }\CommentTok{\# 此刻在当月第几天}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "10"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{weekdays}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Friday"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{weekdays}\NormalTok{(x, }\AttributeTok{abbreviate =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Fri"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{week}\NormalTok{(x) }\CommentTok{\# 此刻在第几周}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 24
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{isoweek}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 23
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{month}\NormalTok{(x) }\CommentTok{\# 此刻在第几月}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%m"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "06"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{months}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "June"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{months}\NormalTok{(x, }\AttributeTok{abbreviate =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Jun"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{quarter}\NormalTok{(x) }\CommentTok{\# 此刻在第几季度}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{quarters}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Q2"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(x) }\CommentTok{\# 取年}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2022
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(x, }\AttributeTok{format =} \StringTok{"\%Y"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2022"
\end{verbatim}

\begin{rmdtip}{提示}
\texttt{format()} 是一个泛型函数，此刻命名空间有 92 方法。 \texttt{format.Date()}， \texttt{format.difftime()}， \texttt{format.POSIXct()} 和 \texttt{format.POSIXlt()} 四个函数通过格式化不同类型的日期数据对象抽取指定部分。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{difftime}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), x, }\AttributeTok{units =} \StringTok{"secs"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "0.05344844 secs"
\end{verbatim}

日期转化详见 \citep{Brian_2001_date, Gabor_2004_date}

\end{rmdtip}

上个季度最后一天

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://d.cosx.org/d/421162/16}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\StringTok{"quarter"}\NormalTok{)) }\SpecialCharTok{{-}} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2019-12-31" "2020-03-31"
\end{verbatim}

本季度第一天

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\StringTok{"quarter"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2020-01-01" "2020-04-01"
\end{verbatim}

类似地，本月第一天和上月最后一天

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 本月第一天}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\StringTok{"month"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2020-02-01" "2020-05-01"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 上月最后一天}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{{-}} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2020-01-31" "2020-04-30"
\end{verbatim}

\textbf{timeDate} 提供了很多日期计算函数，比如季初、季末、月初、月末等

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(timeDate) }
\CommentTok{\# 季初}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{timeFirstDayInQuarter}\NormalTok{(}\AttributeTok{charvec =} \FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)) }
\CommentTok{\# 季末}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{timeLastDayInQuarter}\NormalTok{(}\AttributeTok{charvec =} \FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{))}
\CommentTok{\# 月初}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{timeFirstDayInMonth}\NormalTok{(}\AttributeTok{charvec =} \FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)) }
\CommentTok{\# 月末}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{format}\NormalTok{(}\FunctionTok{timeLastDayInMonth}\NormalTok{(}\AttributeTok{charvec =} \FunctionTok{c}\NormalTok{(}\StringTok{"2020{-}02{-}01"}\NormalTok{, }\StringTok{"2020{-}05{-}02"}\NormalTok{)), }\AttributeTok{format =} \StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)) }
\end{Highlighting}
\end{Shaded}

\texttt{cut.Date()} 是一个泛型函数，查看它的所有 S3 方法

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{methods}\NormalTok{(cut)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] cut.Date        cut.default     cut.dendrogram* cut.IDate*     
## [5] cut.POSIXt     
## see '?methods' for accessing help and source code
\end{verbatim}

格式化输出日期类型数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{formatC}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e8}\NormalTok{, }\FloatTok{1e9}\NormalTok{)), }\AttributeTok{digits =} \DecValTok{10}\NormalTok{, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "857,083,873"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Sys.setlocale(locale = "C") \# 如果是 Windows 系统，必须先设置，否则转化结果是 NA}
\FunctionTok{as.Date}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"1990{-}January"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{sep =} \StringTok{"{-}"}\NormalTok{), }\AttributeTok{format =} \StringTok{"\%Y{-}\%B{-}\%d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1990-01-01"
\end{verbatim}

获取当日零点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{as.POSIXlt}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{()), }\StringTok{"\%Y{-}\%m{-}\%d \%H:\%M:\%S"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2022-06-10 00:00:00"
\end{verbatim}

从 POSIXt 数据对象中，抽取小时和分钟部分，返回字符串

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strftime}\NormalTok{(}\AttributeTok{x =} \FunctionTok{Sys.time}\NormalTok{(), }\AttributeTok{format =} \StringTok{"\%H:\%M"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "01:48"
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.0488}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3537}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.0488}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.5488}}@{}}
\caption{\label{tab:table-of-date} 日期表格}\tabularnewline
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
代码
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
代码
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} \\
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
代码
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
代码
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
含义
\end{minipage} \\
\midrule
\endhead
\texttt{\%a} & Abbreviated weekday & \texttt{\%A} & Full weekday \\
\texttt{\%b} & Abbreviated month & \texttt{\%B} & Full month \\
\texttt{\%c} & Locale-specific date and time & \texttt{\%d} & Decimal date \\
\texttt{\%H} & Decimal hours (24 hour) & \texttt{\%I} & Decimal hours (12 hour) \\
\texttt{\%j} & Decimal day of the year & \texttt{\%m} & Decimal month \\
\texttt{\%M} & Decimal minute & \texttt{\%p} & Locale-specific AM/PM \\
\texttt{\%S} & Decimal second & \texttt{\%U} & Decimal week of the year (starting on Sunday) \\
\texttt{\%w} & Decimal Weekday (0=Sunday) & \texttt{\%W} & Decimal week of the year (starting on Monday) \\
\texttt{\%x} & Locale-specific Date & \texttt{\%X} & Locale-specific Time \\
\texttt{\%y} & 2-digit year & \texttt{\%Y} & 4-digit year \\
\texttt{\%z} & Offset from GMT & \texttt{\%Z} & Time zone (character) \\
\bottomrule
\end{longtable}

本节介绍了 R 本身提供的基础日期操作，第\ref{chap-time-series-analysis}章着重介绍一般的时间序列类型的数据对象及其操作。

\href{https://blog.revolutionanalytics.com/2011/07/the-r-files-jeff-ryan.html}{Jeffrey A. Ryan} 开发的 \href{https://github.com/joshuaulrich/xts}{xts} 和 \href{https://github.com/joshuaulrich/quantmod}{quantmod} 包，Joshua M. Ulrich 开发的 \href{https://r-forge.r-project.org/projects/zoo/}{zoo} 是处理时间序列数据的主要工具

Jeffrey A. Ryan 在开设了一门免费课程教大家如何在 R 语言中使用 xts 和 zoo 包操作时间序列数据 \footnote{\url{https://www.datacamp.com/courses/manipulating-time-series-data-in-r-with-xts-zoo}}

xts (eXtensible Time Series) 扩展的 zoo 对象

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xts}\NormalTok{(}\AttributeTok{x =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{order.by =} \FunctionTok{index}\NormalTok{(x),}
    \AttributeTok{frequency =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{unique =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{tzone =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"TZ"}\NormalTok{),}
\NormalTok{    ...)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(zoo)}
\FunctionTok{library}\NormalTok{(xts)}
\NormalTok{x }\OtherTok{=} \FunctionTok{matrix}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{,}\AttributeTok{nrow =} \DecValTok{2}\NormalTok{)}
\NormalTok{idx }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"2018{-}01{-}01"}\NormalTok{, }\StringTok{"2019{-}12{-}12"}\NormalTok{))}
\CommentTok{\# xts = matrix + index}
\FunctionTok{xts}\NormalTok{(x, }\AttributeTok{order.by =}\NormalTok{ idx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            [,1] [,2]
## 2018-01-01    1    3
## 2019-12-12    2    4
\end{verbatim}

Date，POSIX times，timeDate，chron 等各种各样处理日期数据的对象

\hypertarget{sec-null}{%
\section{空值}\label{sec-null}}

移除\texttt{list()} 列表里的为 \texttt{NULL} 元素

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rm\_null }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(l) }\FunctionTok{Filter}\NormalTok{(}\FunctionTok{Negate}\NormalTok{(is.null), l)}
\end{Highlighting}
\end{Shaded}

\hypertarget{chap-data-transportation}{%
\chapter{数据搬运}\label{chap-data-transportation}}

导入数据与导出数据，各种数据格式，数据库

处理 Excel 2003 (XLS) 和 Excel 2007 (XLSX) 文件还可以使用 \href{https://github.com/marcschwartz/WriteXLS}{WriteXLS} 包，不过它依赖于 Perl，另一个 R 包 \href{https://github.com/dragua/rexcel}{xlsx} 与之功能类似，依赖 Java 环境。Jennifer Bryan 和 Hadley Wickham 开发的 \href{https://github.com/tidyverse/readxl}{readxl} 包和 Jeroen Ooms 开发的 \href{https://github.com/ropensci/writexl}{writexl} 包专门处理 xlsx 格式并且无任何系统依赖。

\hypertarget{import-data}{%
\section{导入数据}\label{import-data}}

Base R 针对不同的数据格式文件，提供了大量的数据导入和导出函数，不愧是专注数据分析20余年的优秀统计软件。 除了函数 \texttt{write.ftable} 和 \texttt{read.ftable} 来自 stats 包，都来自 base 和 utils 包

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 当前环境的搜索路径}
\FunctionTok{searchpaths}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] ".GlobalEnv"                          
## [2] "/opt/R/4.2.0/lib/R/library/stats"    
## [3] "/opt/R/4.2.0/lib/R/library/graphics" 
## [4] "/opt/R/4.2.0/lib/R/library/grDevices"
## [5] "/opt/R/4.2.0/lib/R/library/utils"    
## [6] "/opt/R/4.2.0/lib/R/library/datasets" 
## [7] "/opt/R/4.2.0/lib/R/library/methods"  
## [8] "Autoloads"                           
## [9] "/opt/R/4.2.0/lib/R/library/base"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 返回匹配结果及其所在路径的编号}
\FunctionTok{apropos}\NormalTok{(}\StringTok{"\^{}(read|write)"}\NormalTok{, }\AttributeTok{where =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{mode =} \StringTok{"function"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  5                  5                  9                  5 
##         "read.csv"        "read.csv2"         "read.dcf"       "read.delim" 
##                  5                  5                  5                  2 
##      "read.delim2"         "read.DIF"     "read.fortran"      "read.ftable" 
##                  5                  5                  5                  9 
##         "read.fwf"      "read.socket"       "read.table"          "readBin" 
##                  9                  5                  9                  9 
##         "readChar" "readCitationFile"         "readline"        "readLines" 
##                  9                  9                  9                  5 
##          "readRDS"     "readRenviron"            "write"        "write.csv" 
##                  5                  9                  2                  5 
##       "write.csv2"        "write.dcf"     "write.ftable"     "write.socket" 
##                  5                  9                  9                  9 
##      "write.table"         "writeBin"        "writeChar"       "writeLines"
\end{verbatim}

\hypertarget{scan-file}{%
\subsection{\texorpdfstring{\texttt{scan}}{scan}}\label{scan-file}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\AttributeTok{file =} \StringTok{""}\NormalTok{, }\AttributeTok{what =} \FunctionTok{double}\NormalTok{(), }\AttributeTok{nmax =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{n =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{,}
     \AttributeTok{quote =} \ControlFlowTok{if}\NormalTok{(}\FunctionTok{identical}\NormalTok{(sep, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)) }\StringTok{""} \ControlFlowTok{else} \StringTok{"\textquotesingle{}}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\AttributeTok{dec =} \StringTok{"."}\NormalTok{,}
     \AttributeTok{skip =} \DecValTok{0}\NormalTok{, }\AttributeTok{nlines =} \DecValTok{0}\NormalTok{, }\AttributeTok{na.strings =} \StringTok{"NA"}\NormalTok{,}
     \AttributeTok{flush =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{strip.white =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{quiet =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{blank.lines.skip =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{multi.line =} \ConstantTok{TRUE}\NormalTok{,}
     \AttributeTok{comment.char =} \StringTok{""}\NormalTok{, }\AttributeTok{allowEscapes =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{fileEncoding =} \StringTok{""}\NormalTok{, }\AttributeTok{encoding =} \StringTok{"unknown"}\NormalTok{, text, }\AttributeTok{skipNul =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

首先让我们用 \texttt{cat} 函数创建一个练习数据集 \texttt{ex.data}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"TITLE extra line"}\NormalTok{, }\StringTok{"2 3 5 7"}\NormalTok{, }\StringTok{"11 13 17"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## TITLE extra line 2 3 5 7 11 13 17
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"TITLE extra line"}\NormalTok{, }\StringTok{"2 3 5 7"}\NormalTok{, }\StringTok{"11 13 17"}\NormalTok{, }\AttributeTok{file =} \StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

以此练习数据集，介绍 \texttt{scan} 函数最常用的参数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in scan("data/ex.data"): scan() expected 'a real', got 'TITLE'
\end{verbatim}

从上面的报错信息，我们发现 \texttt{scan} 函数只能读取同一类型的数据，如布尔型 logical， 整型 integer，数值型 numeric(double)， 复数型 complex，字符型 character，raw 和列表 list。所以我们设置参数 \texttt{skip\ =\ 1} 把第一行跳过，就成功读取了数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{skip =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  2  3  5  7 11 13 17
\end{verbatim}

如果设置参数 \texttt{quiet\ =\ TRUE} 就不会报告读取的数据量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{skip =} \DecValTok{1}\NormalTok{, }\AttributeTok{quiet =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  2  3  5  7 11 13 17
\end{verbatim}

参数 \texttt{nlines\ =\ 1} 表示只读取一行数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{skip =} \DecValTok{1}\NormalTok{, }\AttributeTok{nlines =} \DecValTok{1}\NormalTok{) }\CommentTok{\# only 1 line after the skipped one}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2 3 5 7
\end{verbatim}

默认参数 \texttt{flush\ =\ TRUE} 表示读取最后一个请求的字段后，刷新到行尾，下面对比一下读取的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{what =} \FunctionTok{list}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{)) }\CommentTok{\# flush is F {-}\textgreater{} read "7"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in scan("data/ex.data", what = list("", "", "")): number of items read
## is not a multiple of the number of columns
\end{verbatim}

\begin{verbatim}
## [[1]]
## [1] "TITLE" "2"     "7"     "17"   
## 
## [[2]]
## [1] "extra" "3"     "11"    ""     
## 
## [[3]]
## [1] "line" "5"    "13"   ""
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scan}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{, }\AttributeTok{what =} \FunctionTok{list}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{), }\AttributeTok{flush =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "TITLE" "2"     "11"   
## 
## [[2]]
## [1] "extra" "3"     "13"   
## 
## [[3]]
## [1] "line" "5"    "17"
\end{verbatim}

临时文件 ex.data 用完了，我们调用 \texttt{unlink} 函数将其删除，以免留下垃圾文件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlink}\NormalTok{(}\StringTok{"data/ex.data"}\NormalTok{) }\CommentTok{\# tidy up}
\end{Highlighting}
\end{Shaded}

\hypertarget{read-write-table}{%
\subsection{\texorpdfstring{\texttt{read.table}}{read.table}}\label{read-write-table}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read.table}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{\textquotesingle{}"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{"."}\NormalTok{, }\AttributeTok{numerals =} \FunctionTok{c}\NormalTok{(}\StringTok{"allow.loss"}\NormalTok{, }\StringTok{"warn.loss"}\NormalTok{, }\StringTok{"no.loss"}\NormalTok{),}
\NormalTok{  row.names, col.names, }\AttributeTok{as.is =} \SpecialCharTok{!}\NormalTok{stringsAsFactors,}
  \AttributeTok{na.strings =} \StringTok{"NA"}\NormalTok{, }\AttributeTok{colClasses =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{nrows =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
  \AttributeTok{skip =} \DecValTok{0}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fill =} \SpecialCharTok{!}\NormalTok{blank.lines.skip,}
  \AttributeTok{strip.white =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{blank.lines.skip =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{comment.char =} \StringTok{"\#"}\NormalTok{,}
  \AttributeTok{allowEscapes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{flush =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{stringsAsFactors =} \FunctionTok{default.stringsAsFactors}\NormalTok{(),}
  \AttributeTok{fileEncoding =} \StringTok{""}\NormalTok{, }\AttributeTok{encoding =} \StringTok{"unknown"}\NormalTok{, text, }\AttributeTok{skipNul =} \ConstantTok{FALSE}
\NormalTok{)}

\FunctionTok{read.csv}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sep =} \StringTok{","}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{"."}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, ...}
\NormalTok{)}

\FunctionTok{read.csv2}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sep =} \StringTok{";"}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{","}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, ...}
\NormalTok{)}

\FunctionTok{read.delim}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{"."}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, ...}
\NormalTok{)}

\FunctionTok{read.delim2}\NormalTok{(file,}
  \AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
  \AttributeTok{dec =} \StringTok{","}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{comment.char =} \StringTok{""}\NormalTok{, ...}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

变量名是不允许以下划线开头的，同样在数据框里，列名也不推荐使用下划线开头。默认情况下，\texttt{read.table} 都会通过参数 \texttt{check.names} 检查列名的有效性，该参数实际调用了函数 \texttt{make.names} 去检查。如果想尽量保持数据集原来的样子可以设置参数 \texttt{check.names\ =\ FALSE,\ stringsAsFactors\ =\ FALSE}。 默认情形下，\texttt{read.table} 还会将字符串转化为因子变量，这是 R 的历史原因，作为一门统计学家的必备语言，在统计模型中，字符常用来描述类别，而类别变量在 R 环境中常用因子类型来表示，而且大量内置的统计模型也是将它们视为因子变量，如 \texttt{lm} 、\texttt{glm} 等

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat1 }\OtherTok{=} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{text =} \StringTok{"}
\StringTok{\_a \_b \_c}
\StringTok{1 2 a1}
\StringTok{3 4 a2}
\StringTok{"}\NormalTok{)}
\NormalTok{dat1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   X_a X_b X_c
## 1   1   2  a1
## 2   3   4  a2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat2 }\OtherTok{=} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{text =} \StringTok{"}
\StringTok{\_a \_b \_c}
\StringTok{1 2 a1}
\StringTok{3 4 a2}
\StringTok{"}\NormalTok{)}
\NormalTok{dat2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   _a _b _c
## 1  1  2 a1
## 2  3  4 a2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat3 }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{text =} \StringTok{"}
\StringTok{\_a \_b \_c}
\StringTok{1 2 a1}
\StringTok{3 4 a2}
\StringTok{"}
\NormalTok{)}
\NormalTok{dat3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   _a _b _c
## 1  1  2 a1
## 2  3  4 a2
\end{verbatim}

\hypertarget{read-write-lines}{%
\subsection{\texorpdfstring{\texttt{readLines}}{readLines}}\label{read-write-lines}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{readLines}\NormalTok{(}\AttributeTok{con =} \FunctionTok{stdin}\NormalTok{(), }\AttributeTok{n =} \SpecialCharTok{{-}}\NormalTok{1L, }\AttributeTok{ok =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{warn =} \ConstantTok{TRUE}\NormalTok{,}
          \AttributeTok{encoding =} \StringTok{"unknown"}\NormalTok{, }\AttributeTok{skipNul =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

让我们折腾一波，读进来又写出去，只有 R 3.5.3 以上才能保持原样的正确输入输出，因为这里有一个之前版本包含的 BUG

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"DESCRIPTION"}\NormalTok{, }\AttributeTok{package =} \StringTok{"splines"}\NormalTok{)), }\StringTok{"data/DESCRIPTION"}\NormalTok{)}
\CommentTok{\# 比较一下}
\FunctionTok{identical}\NormalTok{(}
  \FunctionTok{readLines}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"DESCRIPTION"}\NormalTok{, }\AttributeTok{package =} \StringTok{"splines"}\NormalTok{)),}
  \FunctionTok{readLines}\NormalTok{(}\StringTok{"data/DESCRIPTION"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

这次我们创建一个真的临时文件，因为重新启动 R 这个文件和文件夹就没有了，回收掉了

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fil }\OtherTok{\textless{}{-}} \FunctionTok{tempfile}\NormalTok{(}\AttributeTok{fileext =} \StringTok{".data"}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"TITLE extra line"}\NormalTok{, }\StringTok{"2 3 5 7"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"11 13 17"}\NormalTok{, }\AttributeTok{file =}\NormalTok{ fil,}
    \AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{fil}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/tmp/RtmpkelfYI/file58ad6c674afd.data"
\end{verbatim}

设置参数 \texttt{n\ =\ -1} 表示将文件 fil 的内容从头读到尾

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{readLines}\NormalTok{(fil, }\AttributeTok{n =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "TITLE extra line" "2 3 5 7"          ""                 "11 13 17"
\end{verbatim}

作为拥有良好习惯的 R 用户，这种垃圾文件最好用后即焚

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlink}\NormalTok{(fil) }\CommentTok{\# tidy up}
\end{Highlighting}
\end{Shaded}

再举个例子，我们创建一个新的临时文件 \texttt{fil}，文件内容只有

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"123}\SpecialCharTok{\textbackslash{}n}\StringTok{abc"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 123
## abc
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fil }\OtherTok{\textless{}{-}} \FunctionTok{tempfile}\NormalTok{(}\StringTok{"test"}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"123}\SpecialCharTok{\textbackslash{}n}\StringTok{abc}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{file =}\NormalTok{ fil, }\AttributeTok{append =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{fil}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "/tmp/RtmpkelfYI/test58ad3ea7fd2c"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{readLines}\NormalTok{(fil)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "123" "abc"
\end{verbatim}

这次读取文件的过程给出了警告，原因是 fil 没有以空行结尾，\texttt{warn\ =\ TRUE} 表示这种情况要给出警告，如果设置参数 \texttt{warn\ =\ FALSE} 就没有警告。我们还是建议大家尽量遵循规范。

再举一个例子，从一个连接读取数据，建立连接的方式有很多，参见 \texttt{?file}，下面设置参数 \texttt{blocking}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{con }\OtherTok{\textless{}{-}} \FunctionTok{file}\NormalTok{(fil, }\StringTok{"r"}\NormalTok{, }\AttributeTok{blocking =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{readLines}\NormalTok{(con)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "123" "abc"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{" def}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{file =}\NormalTok{ fil, }\AttributeTok{append =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{readLines}\NormalTok{(con)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] " def"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 关闭连接}
\FunctionTok{close}\NormalTok{(con)}
\CommentTok{\# 清理垃圾文件}
\FunctionTok{unlink}\NormalTok{(fil)}
\end{Highlighting}
\end{Shaded}

\hypertarget{read-save-rds}{%
\subsection{\texorpdfstring{\texttt{readRDS}}{readRDS}}\label{read-save-rds}}

序列化数据操作，Mark Klik 开发的 \href{https://github.com/fstpackage/fst}{fst} 和 \href{https://travers.im/}{Travers Ching} 开发的 \href{https://github.com/traversc/qs}{qs}， Hadley Wickham 开发的 \href{https://github.com/wesm/feather/tree/master/R}{feather} 包实现跨语言环境快速的读写数据

\begin{longtable}[]{@{}llllll@{}}
\caption[\label{tab:fst-vs-others} fst 序列化数据框对象性能比较 BaseR、 data.table 和 feather ]{\label{tab:fst-vs-others} fst 序列化数据框对象性能比较 BaseR、 data.table 和 feather \footnote{\url{https://www.fstpackage.org/}}}\tabularnewline
\toprule
Method & Format & Time (ms) & Size (MB) & Speed (MB/s) & N \\
\midrule
\endfirsthead
\toprule
Method & Format & Time (ms) & Size (MB) & Speed (MB/s) & N \\
\midrule
\endhead
readRDS & bin & 1577 & 1000 & 633 & 112 \\
saveRDS & bin & 2042 & 1000 & 489 & 112 \\
fread & csv & 2925 & 1038 & 410 & 232 \\
fwrite & csv & 2790 & 1038 & 358 & 241 \\
read\_feather & bin & 3950 & 813 & 253 & 112 \\
write\_feather & bin & 1820 & 813 & 549 & 112 \\
\textbf{read\_fst} & \textbf{bin} & \textbf{457} & \textbf{303} & \textbf{2184} & \textbf{282} \\
\textbf{write\_fst} & \textbf{bin} & \textbf{314} & \textbf{303} & \textbf{3180} & \textbf{291} \\
\bottomrule
\end{longtable}

目前比较好的是 qs 和 fst 包

\hypertarget{other-data-source}{%
\section{其它数据格式}\label{other-data-source}}

来自其它格式的数据形式，如 JSON、XML、YAML 需要转化清理成 R 中数据框的形式 data.frame

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \href{https://www.carlboettiger.info/2017/12/11/data-rectangling-with-jq/}{Data Rectangling with jq}
\item
  \href{https://jeroen.github.io/mongolite/}{Mongolite User Manual} introduction to using MongoDB with the mongolite client in R
\end{enumerate}

\href{https://github.com/jeroen/jsonlite}{jsonlite} 读取 \texttt{*.json} 格式的文件，\texttt{jsonlite::write\_json} 函数将 R对象保存为 JSON 文件，\texttt{jsonlite::fromJSON} 将 json 字符串或文件转化为 R 对象，\texttt{jsonlite::toJSON} 函数正好与之相反

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(jsonlite)}
\CommentTok{\# 从 json 格式的文件导入}
\CommentTok{\# jsonlite::read\_json(path = "path/to/filename.json")}
\CommentTok{\# A JSON array of primitives}
\NormalTok{json }\OtherTok{\textless{}{-}} \StringTok{\textquotesingle{}["Mario", "Peach", null, "Bowser"]\textquotesingle{}}

\CommentTok{\# 简化为原子向量atomic vector}
\FunctionTok{fromJSON}\NormalTok{(json)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Mario"  "Peach"  NA       "Bowser"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 默认返回一个列表}
\FunctionTok{fromJSON}\NormalTok{(json, }\AttributeTok{simplifyVector =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "Mario"
## 
## [[2]]
## [1] "Peach"
## 
## [[3]]
## NULL
## 
## [[4]]
## [1] "Bowser"
\end{verbatim}

yaml 包读取 \texttt{*.yml} 格式文件，返回一个列表，\texttt{yaml::write\_yaml} 函数将 R 对象写入 yaml 格式

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(yaml)}
\NormalTok{yaml}\SpecialCharTok{::}\FunctionTok{read\_yaml}\NormalTok{(}\AttributeTok{file =} \StringTok{\textquotesingle{}\_bookdown.yml\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $book_filename
## [1] "notesdown"
## 
## $delete_merged_file
## [1] TRUE
## 
## $language
## $language$label
## $language$label$fig
## [1] "图 "
## 
## $language$label$tab
## [1] "表 "
## 
## 
## $language$ui
## $language$ui$edit
## [1] "编辑"
## 
## $language$ui$chapter_name
## [1] "第 " " 章"
## 
## $language$ui$appendix_name
## [1] "附录 "
## 
## 
## 
## $new_session
## [1] TRUE
## 
## $before_chapter_script
## [1] "_common.R"
## 
## $rmd_files
##  [1] "index.Rmd"                    "preface.Rmd"                 
##  [3] "data-wrangling.Rmd"           "data-structure.Rmd"          
##  [5] "data-transportation.Rmd"      "string-operations.Rmd"       
##  [7] "regular-expressions.Rmd"      "data-manipulation.Rmd"       
##  [9] "advanced-manipulation.Rmd"    "parallel-manipulation.Rmd"   
## [11] "other-manipulation.Rmd"       "statistical-graphics.Rmd"    
## [13] "graphics-foundations.Rmd"     "data-visualization.Rmd"      
## [15] "interactive-web-graphics.Rmd" "statistical-computation.Rmd" 
## [17] "numerical-optimization.Rmd"   "appendix.Rmd"                
## [19] "references.Rmd"
\end{verbatim}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:other-softwares} 导入来自其它数据分析软件产生的数据集}\tabularnewline
\toprule
统计软件 & R函数 & R包 \\
\midrule
\endfirsthead
\toprule
统计软件 & R函数 & R包 \\
\midrule
\endhead
ERSI ArcGIS & \texttt{read.shapefile} & shapefiles \\
Matlab & \texttt{readMat} & R.matlab \\
minitab & \texttt{read.mtp} & foreign \\
SAS (permanent data) & \texttt{read.ssd} & foreign \\
SAS (XPORT format) & \texttt{read.xport} & foreign \\
SPSS & \texttt{read.spss} & foreign \\
Stata & \texttt{read.dta} & foreign \\
Systat & \texttt{read.systat} & foreign \\
Octave & \texttt{read.octave} & foreign \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:other-read-functions} 导入来自其它格式的数据集}\tabularnewline
\toprule
文件格式 & R函数 & R包 \\
\midrule
\endfirsthead
\toprule
文件格式 & R函数 & R包 \\
\midrule
\endhead
列联表数据 & \texttt{read.ftable} & stats \\
二进制数据 & \texttt{readBin} & base \\
字符串数据 & \texttt{readChar} & base \\
剪贴板数据 & \texttt{readClipboard} & utils \\
\bottomrule
\end{longtable}

\texttt{read.dcf} 函数读取 Debian 控制格式文件，这种类型的文件以人眼可读的形式在存储数据，如 R 包的 DESCRIPTION 文件或者包含所有 CRAN 上 R 包描述的文件 \url{https://cran.r-project.org/src/contrib/PACKAGES}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.dcf}\NormalTok{(}\AttributeTok{file =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"DESCRIPTION"}\NormalTok{, }\AttributeTok{package =} \StringTok{"splines"}\NormalTok{),}
              \AttributeTok{fields =} \FunctionTok{c}\NormalTok{(}\StringTok{"Package"}\NormalTok{, }\StringTok{"Version"}\NormalTok{, }\StringTok{"Title"}\NormalTok{))}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Package   Version Title                                    
## [1,] "splines" "4.2.0" "Regression Spline Functions and Classes"
\end{verbatim}

最后要提及拥有瑞士军刀之称的 \href{https://github.com/leeper/rio}{rio} 包，它集合了当前 R 可以读取的所有统计分析软件导出的数据。

\hypertarget{import-large-dataset}{%
\section{导入大数据集}\label{import-large-dataset}}

在不使用数据库的情况下，从命令行导入大数据集，如几百 M 或几个 G 的 csv 文件。利用 data.table 包的 \texttt{fread} 去读取

\url{https://stackoverflow.com/questions/1727772/}

\hypertarget{import-data-from-database}{%
\section{从数据库导入}\label{import-data-from-database}}

\href{https://rstudio-education.github.io/hopr}{Hands-On Programming with R} 数据读写章节\footnote{\url{https://rstudio-education.github.io/hopr/dataio.html}} 以及 \href{https://smithjd.github.io/sql-pet/}{R, Databases and Docker}

将大量的 txt 文本存进 MySQL 数据库中，通过操作数据库来聚合文本，极大降低内存消耗 \footnote{\url{https://brucezhaor.github.io/blog/2016/08/04/batch-process-txt-to-mysql}}，而 ODBC 与 DBI 包是其它数据库接口的基础，knitr 提供了一个支持 SQL 代码的引擎，它便是基于 DBI，因此可以在 R Markdown 文档中直接使用 SQL 代码块 \footnote{\url{https://bookdown.org/yihui/rmarkdown/language-engines.html\#sql} {[}rstudio-spark{]}: \url{https://spark.rstudio.com/} {[}rmarkdown-teaching-demo{]}: \url{https://stackoverflow.com/questions/35459166}}。这里制作一个归纳表格，左边数据库右边对应其 R 接口，两边都包含链接，如表 \ref{tab:dbi} 所示

\begin{table}

\caption{\label{tab:dbi}数据库接口}
\centering
\begin{tabular}[t]{l|l|l|l}
\hline
数据库 & 官网 & R接口 & 开发仓\\
\hline
MySQL & https://www.mysql.com/ & RMySQL & https://github.com/r-dbi/RMySQL\\
\hline
SQLite & https://www.sqlite.org & RSQLite & https://github.com/r-dbi/RSQLite\\
\hline
PostgreSQL & https://www.postgresql.org/ & RPostgres & https://github.com/r-dbi/RPostgres\\
\hline
MariaDB & https://mariadb.org/ & RMariaDB & https://github.com/r-dbi/RMariaDB\\
\hline
\end{tabular}
\end{table}

\hypertarget{postgresql}{%
\subsection{PostgreSQL}\label{postgresql}}

\href{https://github.com/r-dbi/odbc}{odbc} 可以支持很多数据库，下面以连接 \href{https://www.postgresql.org/}{PostgreSQL} 数据库为例介绍其过程

首先在某台机器上，拉取 PostgreSQL 的 Docker 镜像

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ pull postgres}
\end{Highlighting}
\end{Shaded}

在 Docker 上运行 PostgreSQL，主机端口号 8181 映射给数据库 PostgreSQL 的默认端口号 5432（或其它你的 DBA 分配给你的端口）

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{docker}\NormalTok{ run }\AttributeTok{{-}{-}name}\NormalTok{ psql }\AttributeTok{{-}d} \AttributeTok{{-}p}\NormalTok{ 8181:5432 }\AttributeTok{{-}e}\NormalTok{ ROOT=TRUE }\DataTypeTok{\textbackslash{}}
   \AttributeTok{{-}e}\NormalTok{ USER=xiangyun }\AttributeTok{{-}e}\NormalTok{ PASSWORD=cloud postgres}
\end{Highlighting}
\end{Shaded}

在主机 Ubuntu 上配置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install unixodbc unixodbc{-}dev odbc{-}postgresql}
\end{Highlighting}
\end{Shaded}

端口 5432 是分配给 PostgreSQL 的默认端口，\texttt{host} 可以是云端的地址，如 你的亚马逊账户下的 PostgreSQL 数据库地址 \texttt{\textless{}ec2-54-83-201-96.compute-1.amazonaws.com\textgreater{}}，也可以是本地局域网IP地址，如\texttt{\textless{}192.168.1.200\textgreater{}}。通过参数 \texttt{dbname} 连接到指定的 PostgreSQL 数据库，如 Heroku，这里作为演示就以默认的数据库 \texttt{postgres} 为例

查看配置系统文件路径

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{odbcinst} \AttributeTok{{-}j} 
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
unixODBC 2.3.6
DRIVERS............: /etc/odbcinst.ini
SYSTEM DATA SOURCES: /etc/odbc.ini
FILE DATA SOURCES..: /etc/ODBCDataSources
USER DATA SOURCES..: /root/.odbc.ini
SQLULEN Size.......: 8
SQLLEN Size........: 8
SQLSETPOSIROW Size.: 8
\end{verbatim}

不推荐修改全局配置文件，可设置 \texttt{ODBCSYSINI} 环境变量指定配置文件路径，如 \texttt{ODBCSYSINI=\textasciitilde{}/ODBC} \url{http://www.unixodbc.org/odbcinst.html}

安装完驱动程序，\texttt{/etc/odbcinst.ini} 文件内容自动更新，我们可以不必修改，如果你想自定义不妨手动修改，我们查看在 R 环境中注册的数据库，可以看到 PostgreSQL 的驱动已经配置好

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{odbc}\SpecialCharTok{::}\FunctionTok{odbcListDrivers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                 name   attribute                                    value
1     PostgreSQL ANSI Description    PostgreSQL ODBC driver (ANSI version)
2     PostgreSQL ANSI      Driver                             psqlodbca.so
3     PostgreSQL ANSI       Setup                          libodbcpsqlS.so
4     PostgreSQL ANSI       Debug                                        0
5     PostgreSQL ANSI     CommLog                                        1
6     PostgreSQL ANSI  UsageCount                                        1
7  PostgreSQL Unicode Description PostgreSQL ODBC driver (Unicode version)
8  PostgreSQL Unicode      Driver                             psqlodbcw.so
9  PostgreSQL Unicode       Setup                          libodbcpsqlS.so
10 PostgreSQL Unicode       Debug                                        0
11 PostgreSQL Unicode     CommLog                                        1
12 PostgreSQL Unicode  UsageCount                                        1
\end{verbatim}

系统配置文件 \texttt{/etc/odbcinst.ini} 已经包含有 PostgreSQL 的驱动配置，无需再重复配置

\begin{verbatim}
[PostgreSQL ANSI]
Description=PostgreSQL ODBC driver (ANSI version)
Driver=psqlodbca.so
Setup=libodbcpsqlS.so
Debug=0
CommLog=1
UsageCount=1

[PostgreSQL Unicode]
Description=PostgreSQL ODBC driver (Unicode version)
Driver=psqlodbcw.so
Setup=libodbcpsqlS.so
Debug=0
CommLog=1
UsageCount=1
\end{verbatim}

只需将如下内容存放在 \texttt{\textasciitilde{}/.odbc.ini} 文件中，

\begin{verbatim}
[PostgreSQL]
Driver              = PostgreSQL Unicode
Database            = postgres
Servername          = 172.17.0.1
UserName            = postgres
Password            = default
Port                = 8080
\end{verbatim}

最后，一行命令 DNS 配置连接 \url{https://github.com/r-dbi/odbc} 这样就实现了代码中无任何敏感信息，这里为了展示这个配置过程故而把相关信息公开。

\begin{quote}
注意下面的内容需要在容器中运行， Windows 环境下的配置 PostgreSQL 的驱动有点麻烦就不搞了，意义也不大，现在数据库基本都是跑在 Linux 系统上
\end{quote}

\texttt{docker-machine.exe\ ip\ default} 可以获得本地 Docker 的 IP，比如 192.168.99.101。 Travis 上 \texttt{ip\ addr} 可以查看 Docker 的 IP，如 172.17.0.1

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\NormalTok{con }\OtherTok{\textless{}{-}} \FunctionTok{dbConnect}\NormalTok{(RPostgres}\SpecialCharTok{::}\FunctionTok{Postgres}\NormalTok{(),}
  \AttributeTok{dbname =} \StringTok{"postgres"}\NormalTok{,}
  \AttributeTok{host =} \FunctionTok{ifelse}\NormalTok{(is\_on\_travis, }\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"DOCKER\_HOST\_IP"}\NormalTok{), }\StringTok{"192.168.99.101"}\NormalTok{),}
  \AttributeTok{port =} \DecValTok{8080}\NormalTok{,}
  \AttributeTok{user =} \StringTok{"postgres"}\NormalTok{,}
  \AttributeTok{password =} \StringTok{"default"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\NormalTok{con }\OtherTok{\textless{}{-}} \FunctionTok{dbConnect}\NormalTok{(odbc}\SpecialCharTok{::}\FunctionTok{odbc}\NormalTok{(), }\StringTok{"PostgreSQL"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

列出数据库中的所有表

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbListTables}\NormalTok{(con)}
\end{Highlighting}
\end{Shaded}

第一次启动从 Docker Hub 上下载的镜像，默认的数据库是 postgres 里面没有任何表，所以将 R 环境中的 mtcars 数据集写入 postgres 数据库

将数据集 mtcars 写入 PostgreSQL 数据库中，基本操作，写入表的操作也不能缓存，即不能缓存数据库中的表 mtcars

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbWriteTable}\NormalTok{(con, }\StringTok{"mtcars"}\NormalTok{, mtcars, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

现在可以看到数据表 mtcars 的各个字段

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbListFields}\NormalTok{(con, }\StringTok{"mtcars"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

最后执行一条 SQL 语句

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{dbSendQuery}\NormalTok{(con, }\StringTok{"SELECT * FROM mtcars WHERE cyl = 4"}\NormalTok{) }\CommentTok{\# 发送 SQL 语句}
\FunctionTok{dbFetch}\NormalTok{(res) }\CommentTok{\# 获取查询结果}
\FunctionTok{dbClearResult}\NormalTok{(res) }\CommentTok{\# 清理查询通道}
\end{Highlighting}
\end{Shaded}

或者一条命令搞定

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbGetQuery}\NormalTok{(con, }\StringTok{"SELECT * FROM mtcars WHERE cyl = 4"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

再复杂一点的 SQL 查询操作

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbGetQuery}\NormalTok{(con, }\StringTok{"SELECT cyl, AVG(mpg) AS mpg FROM mtcars GROUP BY cyl ORDER BY cyl"}\NormalTok{)}
\FunctionTok{aggregate}\NormalTok{(mpg }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl, }\AttributeTok{data =}\NormalTok{ mtcars, mean)}
\end{Highlighting}
\end{Shaded}

得益于 knitr \citep{xie2015} 开发的钩子，这里直接写 SQL 语句块，值得注意的是 SQL 代码块不能启用缓存，数据库连接通道也不能缓存，如果数据库中还没有写入表，那么写入表的操作也不能缓存， \texttt{tab.cap\ =\ "表格标题"} 输出的内容是一个表格

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{SELECT}\NormalTok{ cyl, }\FunctionTok{AVG}\NormalTok{(mpg) }\KeywordTok{AS}\NormalTok{ mpg }\KeywordTok{FROM}\NormalTok{ mtcars }\KeywordTok{GROUP} \KeywordTok{BY}\NormalTok{ cyl }\KeywordTok{ORDER} \KeywordTok{BY}\NormalTok{ cyl}
\end{Highlighting}
\end{Shaded}

如果将查询结果导出到变量，在 Chunk 设置 \texttt{output.var\ =\ "agg\_cyl"} 可以使用缓存，下面将 mpg 按 cyl 分组聚合的结果打印出来，\texttt{ref.label\ =\ "mtcars"} 引用上一个 SQL 代码块的内容

这种基于 odbc 的方式的好处就不需要再安装 R 包 RPostgres 和相关系统依赖，最后关闭连接通道

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbDisconnect}\NormalTok{(con)}
\end{Highlighting}
\end{Shaded}

\hypertarget{mysql}{%
\subsection{MySQL}\label{mysql}}

MySQL 是一个很常见，应用也很广泛的数据库，数据分析的常见环境是在一个R Notebook 里，我们可以在正文之前先设定数据库连接信息

\begin{verbatim}
```{r setup}
library(DBI)
# 指定数据库连接信息
db <- dbConnect(RMySQL::MySQL(),
  dbname = 'dbtest',
  username = 'user_test',
  password = 'password',
  host = '10.10.101.10',
  port = 3306
)
# 创建默认连接
knitr::opts_chunk$set(connection = 'db')
# 设置字符编码，以免中文查询乱码
DBI::dbSendQuery(db, 'SET NAMES utf8')
# 设置日期变量，以运用在SQL中
idate <- '2019-05-03'
```
\end{verbatim}

SQL 代码块中使用 R 环境中的变量，并将查询结果输出为R环境中的数据框

\begin{verbatim}
```{sql, output.var='data_output'}
SELECT * FROM user_table where date_format(created_date,'%Y-%m-%d')>=?idate
```
\end{verbatim}

以上代码会将 SQL 的运行结果存在 \texttt{data\_output} 这是数据库中，idate 取之前设置的日期\texttt{2019-05-03}，\texttt{user\_table} 是 MySQL 数据库中的表名，\texttt{created\_date} 是创建\texttt{user\_table}时，指定的日期名。

如果 SQL 比较长，为了代码美观，把带有变量的 SQL 保存为\texttt{demo.sql}脚本，只需要在 SQL 的 chunk 中直接读取 SQL 文件\footnote{\url{https://d.cosx.org/d/419974}}。

\begin{verbatim}
```{sql, code=readLines('demo.sql'), output.var='data_output'}
```
\end{verbatim}

如果我们需要每天或者按照指定的日期重复地运行这个 R Markdown 文件，可以在 YAML 部分引入参数\footnote{\url{https://bookdown.org/yihui/rmarkdown/params-knit.html}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{{-}{-}{-}}
\AnnotationTok{params:}
\CommentTok{  date: "2019{-}05{-}03"  \# 参数化日期}
\CommentTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
```{r setup, include=FALSE}
idate = params$date # 将参数化日期传递给 idate 变量
```
\end{verbatim}

我们将这个 Rmd 文件命名为 \texttt{MyDocument.Rmd}，运行这个文件可以从 R 控制台执行或在 RStudio 点击 knit。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rmarkdown}\SpecialCharTok{::}\FunctionTok{render}\NormalTok{(}\StringTok{"MyDocument.Rmd"}\NormalTok{, }\AttributeTok{params =} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{date =} \StringTok{"2019{-}05{-}03"}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

如果在文档的 YAML 位置已经指定日期，这里可以不指定。注意在这里设置日期会覆盖 YAML 处指定的参数值，这样做的好处是可以批量化操作。

\hypertarget{spark}{%
\subsection{Spark}\label{spark}}

当数据分析报告遇上 Spark 时，就需要 \href{https://github.com/apache/spark/tree/master/R}{SparkR}、 \href{https://github.com/rstudio/sparklyr}{sparklyr}、 \href{https://github.com/apache/arrow/tree/master/r}{arrow} 或 \href{https://github.com/h2oai/sparkling-water/tree/master/r}{rsparking} 接口了， Javier Luraschi 写了一本书 \href{https://therinspark.com/}{The R in Spark: Learning Apache Spark with R} 详细介绍了相关扩展和应用

首先安装 sparklyr 包，RStudio 公司 Javier Lurasch 开发了 sparklyr 包，作为 Spark 与 R 语言之间的接口，安装完 sparklyr 包，还是需要 Spark 和 Hadoop 环境

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}sparklyr\textquotesingle{}}\NormalTok{)}
\FunctionTok{library}\NormalTok{(sparklyr)}
\FunctionTok{spark\_install}\NormalTok{()}
\CommentTok{\# Installing Spark 2.4.0 for Hadoop 2.7 or later.}
\CommentTok{\# Downloading from:}
\CommentTok{\# {-} \textquotesingle{}https://archive.apache.org/dist/spark/spark{-}2.4.0/spark{-}2.4.0{-}bin{-}hadoop2.7.tgz\textquotesingle{}}
\CommentTok{\# Installing to:}
\CommentTok{\# {-} \textquotesingle{}\textasciitilde{}/spark/spark{-}2.4.0{-}bin{-}hadoop2.7\textquotesingle{}}
\CommentTok{\# trying URL \textquotesingle{}https://archive.apache.org/dist/spark/spark{-}2.4.0/spark{-}2.4.0{-}bin{-}hadoop2.7.tgz\textquotesingle{}}
\CommentTok{\# Content type \textquotesingle{}application/x{-}gzip\textquotesingle{} length 227893062 bytes (217.3 MB)}
\CommentTok{\# ==================================================}
\CommentTok{\# downloaded 217.3 MB}
\CommentTok{\# }
\CommentTok{\# Installation complete.}
\end{Highlighting}
\end{Shaded}

既然 sparklyr 已经安装了 Spark 和 Hadoop 环境，安装 SparkR 后，只需配置好路径，就可以加载 SparkR 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}SparkR\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nchar}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{)) }\SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{) \{}
  \FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{SPARK\_HOME =} \StringTok{"\textasciitilde{}/spark/spark{-}2.4.0{-}bin{-}hadoop2.7"}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{library}\NormalTok{(SparkR, }\AttributeTok{lib.loc =} \FunctionTok{c}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{), }\StringTok{"R"}\NormalTok{, }\StringTok{"lib"}\NormalTok{)))}
\FunctionTok{sparkR.session}\NormalTok{(}\AttributeTok{master =} \StringTok{"local[*]"}\NormalTok{, }\AttributeTok{sparkConfig =} \FunctionTok{list}\NormalTok{(}\AttributeTok{spark.driver.memory =} \StringTok{"2g"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/dbdahl/rscala}{rscala} 架起了 R 和 Scala 两门语言之间交流的桥梁，使得彼此之间可以互相调用

\begin{quote}
是否存在这样的可能， Spark 提供了大量的 MLib 库的调用接口，R 的功能支持是最少的，Java/Scala 是原生的，那么要么自己开发新的功能整合到 SparkR 中，要么借助 rscala 将 scala 接口代码封装进来
\end{quote}

在本地，Windows 主机上，可以在 \texttt{.Rprofile} 中给 Spark 添加环境变量 \texttt{SPARK\_HOME} 指定其安装路径，

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Windows 平台默认安装路径}
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{SPARK\_HOME =} \StringTok{"C:/Users/XiangYun/AppData/Local/spark/spark{-}2.4.3{-}bin{-}hadoop2.7"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(sparklyr)}
\NormalTok{sc }\OtherTok{\textless{}{-}} \FunctionTok{spark\_connect}\NormalTok{(}\AttributeTok{master =} \StringTok{"local"}\NormalTok{, }\AttributeTok{version =} \StringTok{"2.4"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

将 R 环境中的数据集 mtcars 传递到 Spark 上

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cars }\OtherTok{\textless{}{-}} \FunctionTok{copy\_to}\NormalTok{(sc, mtcars)}
\NormalTok{cars}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# Source: spark<mtcars> [?? x 11]
    mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
1  21       6   160   110  3.9   2.62  16.5     0     1     4     4
2  21       6   160   110  3.9   2.88  17.0     0     1     4     4
3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1
4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1
5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1
# ... with more rows
\end{verbatim}

监控和分析命令执行的情况，可以在浏览器中，见图 \ref{fig:spark-web}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{spark\_web}\NormalTok{(sc)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=6.4in]{screenshots/spark-start} 

}

\caption{Spark Web 接口}\label{fig:spark-web}
\end{figure}

传递 SQL 查询语句，比如数据集 mtcars 有多少行

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT count(*) FROM mtcars"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  count(1)
1       32
\end{verbatim}

进一步地，我们可以调用 dplyr 包来写数据操作，避免写复杂逻辑的 SQL 语句，

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# library(dplyr) \# 数据操作}
\FunctionTok{library}\NormalTok{(tidyverse) }\CommentTok{\# 提供更多功能，包括数据可视化}
\FunctionTok{count}\NormalTok{(cars)}
\end{Highlighting}
\end{Shaded}

再举一个稍复杂的操作，先从数据集 cars 中选择两个字段 hp 和 mpg

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{select}\NormalTok{(cars, hp, mpg) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{100}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 随机选择 100 行}
  \FunctionTok{collect}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 执行 SQL 查询，将结果返回到本地}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(hp, mpg)) }\SpecialCharTok{+} \CommentTok{\# 绘图}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

数据查询和结果可视化，见图 \ref{fig:spark-mtcars}

\begin{figure}

{\centering \includegraphics[width=1.6in]{screenshots/spark-mtcars} 

}

\caption{数据聚合和可视化}\label{fig:spark-mtcars}
\end{figure}

用完要记得关闭连接

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{spark\_disconnect}\NormalTok{(sc)}
\end{Highlighting}
\end{Shaded}

不要使用 SparkR 接口，要使用 sparklyr， 后者的功能已经全面覆盖前者，生态方面更是更是已经远远超越，它有大厂 RStudio 支持，是公司支持的旗舰项目。但是 sparklyr 的版本稍微比最新的 Spark 低一两个版本，这是开发周期和出于稳定性的考虑，无伤大雅！

Spark 提供了官方 R 语言接口 SparkR。Spark JVM 和 SparkR 包版本要匹配，比如从 CRAN 上安装了最新版的 SparkR，比如版本 2.4.4 就要去 Spark 官网下载最新版的预编译文件 spark-2.4.4-bin-hadoop2.7，解压到本地磁盘，比如 \texttt{D:/spark-2.4.4-bin-hadoop2.7}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{SPARK\_HOME =} \StringTok{"D:/spark{-}2.4.4{-}bin{-}hadoop2.7"}\NormalTok{)}
\CommentTok{\# Sys.setenv(R\_HOME = "C:/Program Files/R/R{-}3.6.1/")}
\FunctionTok{library}\NormalTok{(SparkR, }\AttributeTok{lib.loc =} \FunctionTok{c}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{), }\StringTok{"R"}\NormalTok{, }\StringTok{"lib"}\NormalTok{)))}
\FunctionTok{sparkR.session}\NormalTok{(}\AttributeTok{master =} \StringTok{"local[*]"}\NormalTok{, }
               \AttributeTok{sparkConfig =} \FunctionTok{list}\NormalTok{(}\AttributeTok{spark.driver.memory =} \StringTok{"4g"}\NormalTok{), }
               \AttributeTok{enableHiveSupport =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

从数据集 mtcars（数据类型是 R 的 data.frame） 创建 Spark 的 DataFrame 类型数据

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cars }\OtherTok{\textless{}{-}} \FunctionTok{as.DataFrame}\NormalTok{(mtcars)}
\CommentTok{\# 显示 SparkDataFrame 的前几行}
\FunctionTok{head}\NormalTok{(cars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 mpg cyl disp  hp drat    wt  qsec vs am gear carb
1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1
\end{verbatim}

打印数据集 cars 的 schema 各个字段的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{printSchema}\NormalTok{(cars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
root
 |-- mpg: double (nullable = true)
 |-- cyl: double (nullable = true)
 |-- disp: double (nullable = true)
 |-- hp: double (nullable = true)
 |-- drat: double (nullable = true)
 |-- wt: double (nullable = true)
 |-- qsec: double (nullable = true)
 |-- vs: double (nullable = true)
 |-- am: double (nullable = true)
 |-- gear: double (nullable = true)
 |-- carb: double (nullable = true)
\end{verbatim}

从本地 JSON 文件创建 DataFrame

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path }\OtherTok{\textless{}{-}} \FunctionTok{file.path}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{), }\StringTok{"examples/src/main/resources/people.json"}\NormalTok{)}
\NormalTok{peopleDF }\OtherTok{\textless{}{-}} \FunctionTok{read.json}\NormalTok{(path)}
\FunctionTok{printSchema}\NormalTok{(peopleDF)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
root
 |-- age: long (nullable = true)
 |-- name: string (nullable = true)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{peopleDF}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
SparkDataFrame[age:bigint, name:string]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{showDF}\NormalTok{(peopleDF)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
+----+-------+
| age|   name|
+----+-------+
|null|Michael|
|  30|   Andy|
|  19| Justin|
+----+-------+
\end{verbatim}

peopleDF 转成 Hive 中的表 people

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{createOrReplaceTempView}\NormalTok{(peopleDF, }\StringTok{"people"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调用 \texttt{sql} 传递 SQL 语句查询数据，启动 \texttt{sparkR.session} 时，设置 \texttt{enableHiveSupport\ =\ TRUE}，就是执行不出来，报错，不知道哪里配置存在问题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{teenagers }\OtherTok{\textless{}{-}}\NormalTok{ SparkR}\SpecialCharTok{::}\FunctionTok{sql}\NormalTok{(}\StringTok{"SELECT name FROM people WHERE age \textgreater{}= 13 AND age \textless{}= 19"}\NormalTok{)}
\FunctionTok{show}\NormalTok{(people)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Error in handleErrors(returnStatus, conn) : 
  org.apache.spark.sql.AnalysisException: java.lang.RuntimeException: java.io.IOException: (null) entry in command string: null chmod 0733 F:\tmp\hive;
    at org.apache.spark.sql.hive.HiveExternalCatalog.withClient(HiveExternalCatalog.scala:106)
    at org.apache.spark.sql.hive.HiveExternalCatalog.databaseExists(HiveExternalCatalog.scala:214)
    at org.apache.spark.sql.internal.SharedState.externalCatalog$lzycompute(SharedState.scala:114)
    at org.apache.spark.sql.internal.SharedState.externalCatalog(SharedState.scala:102)
    at org.apache.spark.sql.internal.SharedState.globalTempViewManager$lzycompute(SharedState.scala:141)
    at org.apache.spark.sql.internal.SharedState.globalTempViewManager(SharedState.scala:136)
    at org.apache.spark.sql.hive.HiveSessionStateBuilder$$anonfun$2.apply(HiveSessionStateBuilder.scala:55)
    at org.apache.spark.sql.hive.HiveSessionStateBuilder$$anonfun$2.apply(HiveSessionStateBuilder.scala:55)
    at org.apache.spark.sql.catalyst.catalog.SessionCatalog.gl
\end{verbatim}

调用 \texttt{collect} 函数执行查询，并将结果返回到本地 \texttt{data.frame} 类型

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{teenagersLocalDF }\OtherTok{\textless{}{-}} \FunctionTok{collect}\NormalTok{(teenagers)}
\end{Highlighting}
\end{Shaded}

查看数据集 teenagersLocalDF 的属性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(teenagersLocalDF)}
\end{Highlighting}
\end{Shaded}

最后，关闭 SparkSession 会话

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sparkR.session.stop}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{batch-import-data}{%
\section{批量导入数据}\label{batch-import-data}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{read\_list }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(list\_of\_datasets, read\_func) \{}
\NormalTok{  read\_and\_assign }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dataset, read\_func) \{}
\NormalTok{    dataset\_name }\OtherTok{\textless{}{-}} \FunctionTok{as.name}\NormalTok{(dataset)}
\NormalTok{    dataset\_name }\OtherTok{\textless{}{-}} \FunctionTok{read\_func}\NormalTok{(dataset)}
\NormalTok{  \}}

  \CommentTok{\# invisible is used to suppress the unneeded output}
\NormalTok{  output }\OtherTok{\textless{}{-}} \FunctionTok{invisible}\NormalTok{(}
    \FunctionTok{sapply}\NormalTok{(list\_of\_datasets,}
\NormalTok{      read\_and\_assign,}
      \AttributeTok{read\_func =}\NormalTok{ read\_func, }\AttributeTok{simplify =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{USE.NAMES =} \ConstantTok{TRUE}
\NormalTok{    )}
\NormalTok{  )}

  \CommentTok{\# Remove the extension at the end of the data set names}
\NormalTok{  names\_of\_datasets }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(list\_of\_datasets, }\StringTok{"[.]"}\NormalTok{))[}\FunctionTok{c}\NormalTok{(T, F)])}
  \FunctionTok{names}\NormalTok{(output) }\OtherTok{\textless{}{-}}\NormalTok{ names\_of\_datasets}
  \FunctionTok{return}\NormalTok{(output)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

批量导入文件扩展名为 \texttt{.csv} 的数据文件，即逗号分割的文件

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data\_files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"path/to/csv/dir"}\NormalTok{,}
                         \AttributeTok{pattern =} \StringTok{".csv"}\NormalTok{, }\AttributeTok{full.names =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{print}\NormalTok{(data\_files)}
\end{Highlighting}
\end{Shaded}

相比于 Base R 提供的 \texttt{read.csv} 函数，使用 readr 包的 \texttt{read\_csv} 函数可以更快地读取csv格式文件，特别是在读取GB级数据文件时，效果特别明显。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{list\_of\_data\_sets }\OtherTok{\textless{}{-}} \FunctionTok{read\_list}\NormalTok{(data\_files, readr}\SpecialCharTok{::}\NormalTok{read\_csv)}
\end{Highlighting}
\end{Shaded}

使用 tibble 包的\texttt{glimpse}函数可以十分方便地对整个数据集有一个大致的了解，展示方式和信息量相当于 \texttt{str} 加 \texttt{head} 函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tibble}\SpecialCharTok{::}\FunctionTok{glimpse}\NormalTok{(list\_of\_data\_sets)}
\end{Highlighting}
\end{Shaded}

\hypertarget{batch-export-data}{%
\section{批量导出数据}\label{batch-export-data}}

假定我们有一个列表，其每个元素都是一个数据框，现在要把每个数据框分别存入 xlsx 表的工作薄中，以 mtcars 数据集为例，将其按分类变量 cyl 分组拆分，获得一个列表 list

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(mtcars, mtcars}\SpecialCharTok{$}\NormalTok{cyl)}
\NormalTok{dat}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $`4`
##                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Datsun 710     22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## Merc 240D      24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## Merc 230       22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## Fiat 128       32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## Honda Civic    30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## Toyota Corolla 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## Toyota Corona  21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## Fiat X1-9      27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## Porsche 914-2  26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## Lotus Europa   30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## Volvo 142E     21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
## 
## $`6`
##                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4      21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag  21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## Hornet 4 Drive 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## Valiant        18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## Merc 280       19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## Merc 280C      17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## Ferrari Dino   19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
## 
## $`8`
##                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
## Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
\end{verbatim}

将 xlsx 表格初始化，创建空白的工作薄， \href{https://github.com/awalker89/openxlsx}{openxlsx} 包不依赖 Java 环境，读写效率也高

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 加载 openxlsx 包}
\FunctionTok{library}\NormalTok{(openxlsx)}
\DocumentationTok{\#\# 创建空白的工作薄}
\NormalTok{wb }\OtherTok{\textless{}{-}} \FunctionTok{createWorkbook}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

将列表里的每张表分别存入 xlsx 表格的每个 worksheet，worksheet 的名字就是分组变量的名字

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Map}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(data, name)\{}
    \FunctionTok{addWorksheet}\NormalTok{(wb, name)}
    \FunctionTok{writeData}\NormalTok{(wb, name, data)}
 
\NormalTok{\}, dat, }\FunctionTok{names}\NormalTok{(dat))}
\end{Highlighting}
\end{Shaded}

最后保存数据到磁盘，见图 \ref{fig:batch-export-xlsx}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{saveWorkbook}\NormalTok{(wb, }\AttributeTok{file =} \StringTok{"data/matcars.xlsx"}\NormalTok{, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=4.1in]{screenshots/dm-batch-export-xlsx} 

}

\caption{批量导出数据}\label{fig:batch-export-xlsx}
\end{figure}

\hypertarget{export-data}{%
\section{导出数据}\label{export-data}}

\hypertarget{export-output}{%
\subsection{导出运行结果}\label{export-output}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{capture.output}\NormalTok{(..., }\AttributeTok{file =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{,}
               \AttributeTok{type =} \FunctionTok{c}\NormalTok{(}\StringTok{"output"}\NormalTok{, }\StringTok{"message"}\NormalTok{), }\AttributeTok{split =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{capture.output} 将一段R代码执行结果，保存到文件，参数为表达式。\texttt{capture.output} 和 \texttt{sink} 的关系相当于 \texttt{with} 和 \texttt{attach} 的关系。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{glmout }\OtherTok{\textless{}{-}} \FunctionTok{capture.output}\NormalTok{(}\FunctionTok{summary}\NormalTok{(}\FunctionTok{glm}\NormalTok{(case }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spontaneous }\SpecialCharTok{+}\NormalTok{ induced,}
  \AttributeTok{data =}\NormalTok{ infert, }\AttributeTok{family =} \FunctionTok{binomial}\NormalTok{()}
\NormalTok{)), }\AttributeTok{file =} \StringTok{"data/capture.txt"}\NormalTok{)}
\FunctionTok{capture.output}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+} \DecValTok{1}\NormalTok{, }\DecValTok{2} \SpecialCharTok{+} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "[1] 2" "[1] 4"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{capture.output}\NormalTok{(\{}
  \DecValTok{1} \SpecialCharTok{+} \DecValTok{1}
  \DecValTok{2} \SpecialCharTok{+} \DecValTok{2}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "[1] 4"
\end{verbatim}

\texttt{sink} 函数将控制台输出结果保存到文件，只将 \texttt{outer} 函数运行的结果保存到 \texttt{ex-sink.txt} 文件，outer 函数计算的是直积，在这里相当于 \texttt{seq(10)\ \%*\%\ t(seq(10))}，而在 R 语言中，更加有效的计算方式是 \texttt{tcrossprod(seq(10),seq(10))}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sink}\NormalTok{(}\StringTok{"data/ex{-}sink.txt"}\NormalTok{)}
\NormalTok{i }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}
\FunctionTok{outer}\NormalTok{(i, i, }\StringTok{"*"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
##  [1,]    1    2    3    4    5    6    7    8    9    10
##  [2,]    2    4    6    8   10   12   14   16   18    20
##  [3,]    3    6    9   12   15   18   21   24   27    30
##  [4,]    4    8   12   16   20   24   28   32   36    40
##  [5,]    5   10   15   20   25   30   35   40   45    50
##  [6,]    6   12   18   24   30   36   42   48   54    60
##  [7,]    7   14   21   28   35   42   49   56   63    70
##  [8,]    8   16   24   32   40   48   56   64   72    80
##  [9,]    9   18   27   36   45   54   63   72   81    90
## [10,]   10   20   30   40   50   60   70   80   90   100
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sink}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{export-data-object}{%
\subsection{导出数据对象}\label{export-data-object}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(file, }\AttributeTok{envir =} \FunctionTok{parent.frame}\NormalTok{(), }\AttributeTok{verbose =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{save}\NormalTok{(..., }\AttributeTok{list =} \FunctionTok{character}\NormalTok{(),}
     \AttributeTok{file =} \FunctionTok{stop}\NormalTok{(}\StringTok{"\textquotesingle{}file\textquotesingle{} must be specified"}\NormalTok{),}
     \AttributeTok{ascii =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{version =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{parent.frame}\NormalTok{(),}
     \AttributeTok{compress =} \FunctionTok{isTRUE}\NormalTok{(}\SpecialCharTok{!}\NormalTok{ascii), compression\_level,}
     \AttributeTok{eval.promises =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{precheck =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{save.image}\NormalTok{(}\AttributeTok{file =} \StringTok{".RData"}\NormalTok{, }\AttributeTok{version =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{ascii =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{compress =} \SpecialCharTok{!}\NormalTok{ascii, }\AttributeTok{safe =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{load} 和\texttt{save} 函数加载或保存包含工作环境信息的数据对象，\texttt{save.image} 保存当前工作环境到磁盘，即保存工作空间中所有数据对象，数据格式为 \texttt{.RData}，即相当于

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(}\AttributeTok{list =} \FunctionTok{ls}\NormalTok{(}\AttributeTok{all.names =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{file =} \StringTok{".RData"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
\end{Highlighting}
\end{Shaded}

\texttt{dump} 保存数据对象 AirPassengers 到文件 \texttt{AirPassengers.txt}，文件内容是 R 命令，可把\texttt{AirPassengers.txt}看作代码文档执行，dput 保存数据对象内容到文件\texttt{AirPassengers.dat}，文件中不包含变量名 AirPassengers。注意到 \texttt{dump} 输入是一个字符串，而 \texttt{dput} 要求输入数据对象的名称，\texttt{source} 函数与 \texttt{dump} 对应，而 \texttt{dget} 与 \texttt{dput}对应。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载数据}
\FunctionTok{data}\NormalTok{(AirPassengers, }\AttributeTok{package =} \StringTok{"datasets"}\NormalTok{)}
\CommentTok{\# 将数据以R代码块的形式保存到文件}
\FunctionTok{dump}\NormalTok{(}\StringTok{\textquotesingle{}AirPassengers\textquotesingle{}}\NormalTok{, }\AttributeTok{file =} \StringTok{\textquotesingle{}data/AirPassengers.txt\textquotesingle{}}\NormalTok{) }
\CommentTok{\# source(file = \textquotesingle{}data/AirPassengers.txt\textquotesingle{})}
\end{Highlighting}
\end{Shaded}

接下来，我们读取 \texttt{AirPassengers.txt} 的文件内容，可见它是一段完整的 R 代码，可以直接复制到 R 的控制台中运行，并且得到一个与原始 AirPassengers 变量一样的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(}\StringTok{\textquotesingle{}data/AirPassengers.txt\textquotesingle{}}\NormalTok{), }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## AirPassengers <-
## structure(c(112, 118, 132, 129, 121, 135, 148, 148, 136, 119, 
## 104, 118, 115, 126, 141, 135, 125, 149, 170, 170, 158, 133, 114, 
## 140, 145, 150, 178, 163, 172, 178, 199, 199, 184, 162, 146, 166, 
## 171, 180, 193, 181, 183, 218, 230, 242, 209, 191, 172, 194, 196, 
## 196, 236, 235, 229, 243, 264, 272, 237, 211, 180, 201, 204, 188, 
## 235, 227, 234, 264, 302, 293, 259, 229, 203, 229, 242, 233, 267, 
## 269, 270, 315, 364, 347, 312, 274, 237, 278, 284, 277, 317, 313, 
## 318, 374, 413, 405, 355, 306, 271, 306, 315, 301, 356, 348, 355, 
## 422, 465, 467, 404, 347, 305, 336, 340, 318, 362, 348, 363, 435, 
## 491, 505, 404, 359, 310, 337, 360, 342, 406, 396, 420, 472, 548, 
## 559, 463, 407, 362, 405, 417, 391, 419, 461, 472, 535, 622, 606, 
## 508, 461, 390, 432), tsp = c(1949, 1960.9166666666699, 12), class = "ts")
\end{verbatim}

\texttt{dput} 函数类似 \texttt{dump} 函数，保存数据对象到磁盘文件

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 将 R 对象保存/导出到磁盘}
\FunctionTok{dput}\NormalTok{(AirPassengers, }\AttributeTok{file =} \StringTok{\textquotesingle{}data/AirPassengers.dat\textquotesingle{}}\NormalTok{)}
\NormalTok{AirPassengers}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
1949 112 118 132 129 121 135 148 148 136 119 104 118
1950 115 126 141 135 125 149 170 170 158 133 114 140
1951 145 150 178 163 172 178 199 199 184 162 146 166
1952 171 180 193 181 183 218 230 242 209 191 172 194
1953 196 196 236 235 229 243 264 272 237 211 180 201
1954 204 188 235 227 234 264 302 293 259 229 203 229
1955 242 233 267 269 270 315 364 347 312 274 237 278
1956 284 277 317 313 318 374 413 405 355 306 271 306
1957 315 301 356 348 355 422 465 467 404 347 305 336
1958 340 318 362 348 363 435 491 505 404 359 310 337
1959 360 342 406 396 420 472 548 559 463 407 362 405
1960 417 391 419 461 472 535 622 606 508 461 390 432
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dget 作用与 dput 相反}
\NormalTok{AirPassengers2 }\OtherTok{\textless{}{-}} \FunctionTok{dget}\NormalTok{(}\AttributeTok{file =} \StringTok{\textquotesingle{}data/AirPassengers.dat\textquotesingle{}}\NormalTok{)}
\NormalTok{AirPassengers2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
1949 112 118 132 129 121 135 148 148 136 119 104 118
1950 115 126 141 135 125 149 170 170 158 133 114 140
1951 145 150 178 163 172 178 199 199 184 162 146 166
1952 171 180 193 181 183 218 230 242 209 191 172 194
1953 196 196 236 235 229 243 264 272 237 211 180 201
1954 204 188 235 227 234 264 302 293 259 229 203 229
1955 242 233 267 269 270 315 364 347 312 274 237 278
1956 284 277 317 313 318 374 413 405 355 306 271 306
1957 315 301 356 348 355 422 465 467 404 347 305 336
1958 340 318 362 348 363 435 491 505 404 359 310 337
1959 360 342 406 396 420 472 548 559 463 407 362 405
1960 417 391 419 461 472 535 622 606 508 461 390 432
\end{verbatim}

同样地，现在我们观察 \texttt{dput} 函数保存的文件 \texttt{AirPassengers.dat} 内容，和\texttt{dump} 函数保存的文件 \texttt{AirPassengers.txt}相比，就缺一个赋值变量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(}\StringTok{\textquotesingle{}data/AirPassengers.dat\textquotesingle{}}\NormalTok{), }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
structure(c(112, 118, 132, 129, 121, 135, 148, 148, 136, 119, 
104, 118, 115, 126, 141, 135, 125, 149, 170, 170, 158, 133, 114, 
140, 145, 150, 178, 163, 172, 178, 199, 199, 184, 162, 146, 166, 
171, 180, 193, 181, 183, 218, 230, 242, 209, 191, 172, 194, 196, 
196, 236, 235, 229, 243, 264, 272, 237, 211, 180, 201, 204, 188, 
235, 227, 234, 264, 302, 293, 259, 229, 203, 229, 242, 233, 267, 
269, 270, 315, 364, 347, 312, 274, 237, 278, 284, 277, 317, 313, 
318, 374, 413, 405, 355, 306, 271, 306, 315, 301, 356, 348, 355, 
422, 465, 467, 404, 347, 305, 336, 340, 318, 362, 348, 363, 435, 
491, 505, 404, 359, 310, 337, 360, 342, 406, 396, 420, 472, 548, 
559, 463, 407, 362, 405, 417, 391, 419, 461, 472, 535, 622, 606, 
508, 461, 390, 432), tsp = c(1949, 1960.91666666667, 12), class = "ts")
\end{verbatim}

\href{https://github.com/ycphs/openxlsx}{openxlsx} 可以读写 XLSX 文档

美团使用的大数据工具有很多，最常用的 Hive、Spark、Kylin、Impala、Presto 等，详见 \url{https://tech.meituan.com/2018/08/02/mt-r-practice.html}。下面主要介绍如何在 R 中连接 MySQL、Presto 和 Spark。

\href{https://github.com/r-spark/sparklyr.flint}{sparklyr.flint} 支持 Spark 的时间序列库 \href{https://github.com/twosigma/flint}{flint}，\href{https://github.com/rstudio/sparkxgb}{sparkxgb} 为 Spark 上的 XGBoost 提供 R 接口，\href{https://github.com/r-spark/sparkwarc}{sparkwarc} 支持加载 Web ARChive 文件到 Spark 里 \href{https://github.com/chezou/sparkavro}{sparkavro} 支持从 Apache Avro (\url{https://avro.apache.org/}) 读取文件到 Spark 里，\href{https://github.com/miraisolutions/sparkbq}{sparkbq} 是一个 sparkly 扩展包，集成 Google BigQuery 服务，\href{https://github.com/harryprince/geospark}{geospark} 提供 GeoSpark 库的 R 接口，并且以 sf 的数据操作方式，\href{https://github.com/h2oai/sparkling-water/tree/master/r}{rsparkling} H2O Sparkling Water 机器学习库的 R 接口。

Spark 性能优化，参考三篇博文

\begin{itemize}
\tightlist
\item
  \href{https://tech.meituan.com/2016/03/31/spark-in-meituan.html}{Spark在美团的实践}
\item
  \href{https://tech.meituan.com/2016/04/29/spark-tuning-basic.html}{Spark性能优化指南------基础篇}
\item
  \href{https://tech.meituan.com/2016/05/12/spark-tuning-pro.html}{Spark性能优化指南------高级篇}
\end{itemize}

其他材料

\begin{itemize}
\tightlist
\item
  朱俊晖收集的 Spark 资源列表 \url{https://github.com/harryprince/awesome-sparklyr}，推荐使用 sparklyr \url{https://github.com/sparklyr/sparklyr} 连接 Spark
\item
  Spark 与 R 语言 \url{https://docs.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/}
\item
  Mastering Spark with R \url{https://therinspark.com/}
\end{itemize}

\hypertarget{sec-spark-with-r}{%
\section{Spark 与 R 语言}\label{sec-spark-with-r}}

\hypertarget{subsec-sparklyr}{%
\subsection{sparklyr}\label{subsec-sparklyr}}

\begin{rmdwarn}{警告}
Spark 依赖特定版本的 Java、Hadoop，三者之间的版本应该要相融。

\end{rmdwarn}

在 MacOS 上配置 Java 环境，注意 Spark 仅支持 Java 8 至 11，所以安装指定版本的 Java 开发环境

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 安装 openjdk 11}
\ExtensionTok{brew}\NormalTok{ install openjdk@11}
\CommentTok{\# 全局设置 JDK 11}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}sfn}\NormalTok{ /usr/local/opt/openjdk@11/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk{-}11.jdk}
\CommentTok{\# Java 11 JDK 添加到 .zshrc }
\BuiltInTok{export} \VariableTok{CPPFLAGS}\OperatorTok{=}\StringTok{"{-}I/usr/local/opt/openjdk@11/include"}
\BuiltInTok{export} \VariableTok{PATH}\OperatorTok{=}\StringTok{"/usr/local/opt/openjdk@11/bin:}\VariableTok{$PATH}\StringTok{"}
\end{Highlighting}
\end{Shaded}

配置 R 环境，让 R 能够识别 Java 环境，再安装 \textbf{rJava} 包

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 配置}
\FunctionTok{sudo}\NormalTok{ R CMD javareconf}
\CommentTok{\# 系统软件依赖}
\ExtensionTok{brew}\NormalTok{ install pcre2}
\CommentTok{\# 安装 rJava}
\ExtensionTok{Rscript} \AttributeTok{{-}e} \StringTok{\textquotesingle{}install.packages("rJava", type="source")\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

最后安装 \textbf{sparklyr} 包，以及 Spark 环境，可以借助 \texttt{spark\_install()} 安装 Spark，比如下面 Spark 3.0 连同 hadoop 2.7 一起安装。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}sparklyr\textquotesingle{}}\NormalTok{)}
\NormalTok{sparklyr}\SpecialCharTok{::}\FunctionTok{spark\_install}\NormalTok{(}\AttributeTok{version =} \StringTok{\textquotesingle{}3.0\textquotesingle{}}\NormalTok{, }\AttributeTok{hadoop\_version =} \StringTok{\textquotesingle{}2.7\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

也可以先手动下载 Spark 软件环境，建议选择就近镜像站点下载，比如在北京选择清华站点 \url{https://mirrors.tuna.tsinghua.edu.cn/apache/spark/spark-3.0.1/spark-3.0.1-bin-hadoop2.7.tgz}，此环境自带 R 和 Python 接口。为了供 sparklyr 调用，先设置 \texttt{SPARK\_HOME} 环境变量指向 Spark 安装位置，再连接单机版 Spark。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 排错 https://github.com/sparklyr/sparklyr/issues/2827}
\FunctionTok{options}\NormalTok{(}\AttributeTok{sparklyr.log.console =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# 连接 Spark }
\FunctionTok{library}\NormalTok{(sparklyr)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{sc }\OtherTok{\textless{}{-}} \FunctionTok{spark\_connect}\NormalTok{(}
  \AttributeTok{master =} \StringTok{"local"}\NormalTok{,}
  \CommentTok{\# config = list(sparklyr.gateway.address = "127.0.0.1"),}
  \AttributeTok{spark\_home =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# diamonds 数据集导入 Spark}
\NormalTok{diamonds\_tbl }\OtherTok{\textless{}{-}} \FunctionTok{copy\_to}\NormalTok{(sc, ggplot2}\SpecialCharTok{::}\NormalTok{diamonds, }\StringTok{"diamonds"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

做数据的聚合统计，有两种方式。一种是使用用 R 包 dplyr 提供的数据操作语法，下面以按 cut 分组统计钻石的数量为例，说明 dplyr 提供的数据操作方式。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\CommentTok{\# 列出数据源下所有的表 tbls}
\FunctionTok{src\_tbls}\NormalTok{(sc)}

\NormalTok{diamonds\_tbl }\OtherTok{\textless{}{-}}\NormalTok{ diamonds\_tbl }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(cut) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{cnt =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  collect}
\end{Highlighting}
\end{Shaded}

另一种是使用结构化查询语言 SQL，这自不必说，大多数情况下，使用和一般的 SQL 没什么两样。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DBI)}
\NormalTok{diamonds\_preview }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT count(*) as cnt, cut FROM diamonds GROUP BY cut"}\NormalTok{)}
\NormalTok{diamonds\_preview}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cnt       cut
## 1 21551     Ideal
## 2 13791   Premium
## 3  4906      Good
## 4  1610      Fair
## 5 12082 Very Good
\end{verbatim}

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# SQL 中的 AVG 和 R 中的 mean 函数是类似的}
\NormalTok{diamonds\_price }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT AVG(price) as mean\_price, cut FROM diamonds GROUP BY cut"}\NormalTok{)}
\NormalTok{diamonds\_price}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   mean_price       cut
## 1   3457.542     Ideal
## 2   4584.258   Premium
## 3   3928.864      Good
## 4   4358.758      Fair
## 5   3981.760 Very Good
\end{verbatim}

\end{column}

\begin{column}{0.05\textwidth}
~

\end{column}

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{diamonds }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(diamonds)}
\NormalTok{diamonds[,.(}\AttributeTok{mean\_price =} \FunctionTok{mean}\NormalTok{(price)), by }\OtherTok{=}\NormalTok{ .(cut)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          cut mean_price
## 1:     Ideal   3457.542
## 2:   Premium   4584.258
## 3:      Good   3928.864
## 4: Very Good   3981.760
## 5:      Fair   4358.758
\end{verbatim}

\end{column}

将结果数据用 ggplot2 呈现出来

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds\_preview, }\FunctionTok{aes}\NormalTok{(cut, cnt)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-transportation_files/figure-latex/unnamed-chunk-75-1} \end{center}

diamonds 数据集总共 53940 条数据，下面用 BUCKET 分桶抽样，将原数据随机分成 1000 个桶，取其中的一个桶，由于是随机分桶，所以每次的结果都不一样，解释详见\url{https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-sampling.html}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds\_sample }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT * FROM diamonds TABLESAMPLE (BUCKET 1 OUT OF 1000) LIMIT 6"}\NormalTok{)}
\NormalTok{diamonds\_sample}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   carat       cut color clarity depth table price    x    y    z
## 1  0.70     Ideal     H     SI1  61.5    55  2815 5.73 5.79 3.54
## 2  0.82   Premium     E     SI2  60.8    60  2824 6.05 6.03 3.67
## 3  0.32   Premium     H     VS1  62.3    58   561 4.34 4.39 2.72
## 4  0.78 Very Good     G     VS2  62.6    58  3113 5.81 5.89 3.66
## 5  1.02     Ideal     H     SI2  62.0    56  3713 6.40 6.34 3.95
## 6  1.02     Ideal     I     SI2  60.7    57  3856 6.57 6.54 3.98
\end{verbatim}

将抽样的结果用窗口函数 \texttt{RANK()} 排序，详见 \url{https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html}

窗口函数 \url{https://www.cnblogs.com/ZackSun/p/9713435.html}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds\_rank }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"}
\StringTok{  SELECT cut, price, RANK() OVER (PARTITION BY cut ORDER BY price) AS rank }
\StringTok{  FROM diamonds TABLESAMPLE (BUCKET 1 OUT OF 1000)}
\StringTok{  LIMIT 6}
\StringTok{"}\NormalTok{)}
\NormalTok{diamonds\_rank}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cut price rank
## 1  Fair  1915    1
## 2  Good  4260    1
## 3  Good  4427    2
## 4  Good  5951    3
## 5  Good 16582    4
## 6 Ideal   491    1
\end{verbatim}

LATERAL VIEW 把一列拆成多行

\url{https://liam.page/2020/03/09/LATERAL-VIEW-in-Hive-SQL/} \url{https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-lateral-view.html}

创建数据集

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 先删除存在的表 person}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"DROP TABLE IF EXISTS person"}\NormalTok{)}
\CommentTok{\# 创建表 person}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"CREATE TABLE IF NOT EXISTS person (id INT, name STRING, age INT, class INT, address STRING)"}\NormalTok{)}
\CommentTok{\# 插入数据到表 person}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"}
\StringTok{INSERT INTO person VALUES}
\StringTok{    (100, \textquotesingle{}John\textquotesingle{}, 30, 1, \textquotesingle{}Street 1\textquotesingle{}),}
\StringTok{    (200, \textquotesingle{}Mary\textquotesingle{}, NULL, 1, \textquotesingle{}Street 2\textquotesingle{}),}
\StringTok{    (300, \textquotesingle{}Mike\textquotesingle{}, 80, 3, \textquotesingle{}Street 3\textquotesingle{}),}
\StringTok{    (400, \textquotesingle{}Dan\textquotesingle{}, 50, 4, \textquotesingle{}Street 4\textquotesingle{})}
\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

查看数据集

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"SELECT * FROM person"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    id name age class  address
## 1 100 John  30     1 Street 1
## 2 200 Mary  NA     1 Street 2
## 3 300 Mike  80     3 Street 3
## 4 400  Dan  50     4 Street 4
\end{verbatim}

行列转换 \url{https://www.cnblogs.com/kimbo/p/6208973.html}，LATERAL VIEW 展开

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dbGetQuery}\NormalTok{(sc,}\StringTok{"}
\StringTok{SELECT * FROM person}
\StringTok{    LATERAL VIEW EXPLODE(ARRAY(30, 60)) tabelName AS c\_age}
\StringTok{    LATERAL VIEW EXPLODE(ARRAY(40, 80)) AS d\_age}
\StringTok{LIMIT 6}
\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    id name age class  address c_age d_age
## 1 100 John  30     1 Street 1    30    40
## 2 100 John  30     1 Street 1    30    80
## 3 100 John  30     1 Street 1    60    40
## 4 100 John  30     1 Street 1    60    80
## 5 200 Mary  NA     1 Street 2    30    40
## 6 200 Mary  NA     1 Street 2    30    80
\end{verbatim}

日期相关的函数 \url{https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html\#date-and-timestamp-functions}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 今天}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"select current\_date"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   current_date()
## 1     2022-06-10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 昨天}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"select date\_sub(current\_date, 1)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   date_sub(current_date(), 1)
## 1                  2022-06-09
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 本月最后一天 current\_date 所属月份的最后一天}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"select last\_day(current\_date)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   last_day(current_date())
## 1               2022-06-30
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 星期几}
\FunctionTok{dbGetQuery}\NormalTok{(sc, }\StringTok{"select dayofweek(current\_date)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   dayofweek(current_date())
## 1                         6
\end{verbatim}

最后，使用完记得关闭 Spark 连接

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{spark\_disconnect}\NormalTok{(sc)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-sparkr}{%
\subsection{SparkR}\label{subsec-sparkr}}

\begin{rmdnote}{注意}
考虑到和第\ref{subsec-sparklyr}节的重合性，以及 sparklyr 的优势，本节代码都不会执行，仅作为补充信息予以描述。完整的介绍见 \href{https://spark.apache.org/docs/latest/sparkr.html\#running-sql-queries-from-sparkr}{SparkR 包}

\end{rmdnote}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nchar}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{)) }\SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{) \{}
  \FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{SPARK\_HOME =} \StringTok{"/opt/spark/spark{-}3.0.1{-}bin{-}hadoop2.7"}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{library}\NormalTok{(SparkR, }\AttributeTok{lib.loc =} \FunctionTok{c}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"SPARK\_HOME"}\NormalTok{), }\StringTok{"R"}\NormalTok{, }\StringTok{"lib"}\NormalTok{)))}
\FunctionTok{sparkR.session}\NormalTok{(}\AttributeTok{master =} \StringTok{"local[*]"}\NormalTok{, }\AttributeTok{sparkConfig =} \FunctionTok{list}\NormalTok{(}\AttributeTok{spark.driver.memory =} \StringTok{"2g"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{rmdwarn}{警告}

\textbf{SparkR} 要求 Java 版本满足：大于等于8，而小于12，本地 MacOS 安装高版本，比如 oracle-jdk 16.0.1 会报不兼容的错误。

\begin{verbatim}
Spark package found in SPARK_HOME: /opt/spark/spark-3.1.1-bin-hadoop3.2
Error in checkJavaVersion() : 
  Java version, greater than or equal to 8 and less than 12, is required for this package; found version: 16.0.1
\end{verbatim}

\end{rmdwarn}

\texttt{sparkConfig} 有哪些参数可以传递

\begin{longtable}[]{@{}lll@{}}
\toprule
Property Name & Property group & \texttt{spark-submit} equivalent \\
\midrule
\endhead
\texttt{spark.master} & Application Properties & \texttt{-\/-master} \\
\texttt{spark.kerberos.keytab} & Application Properties & \texttt{-\/-keytab} \\
\texttt{spark.kerberos.principal} & Application Properties & \texttt{-\/-principal} \\
\texttt{spark.driver.memory} & Application Properties & \texttt{-\/-driver-memory} \\
\texttt{spark.driver.extraClassPath} & Runtime Environment & \texttt{-\/-driver-class-path} \\
\texttt{spark.driver.extraJavaOptions} & Runtime Environment & \texttt{-\/-driver-java-options} \\
\texttt{spark.driver.extraLibraryPath} & Runtime Environment & \texttt{-\/-driver-library-path} \\
\bottomrule
\end{longtable}

将 data.frame 转化为 SparkDataFrame

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{faithful\_sdf }\OtherTok{\textless{}{-}} \FunctionTok{as.DataFrame}\NormalTok{(faithful)}
\end{Highlighting}
\end{Shaded}

SparkDataFrame

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(faithful\_sdf)}
\end{Highlighting}
\end{Shaded}

查看结构

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(faithful\_sdf)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-database-with-r}{%
\section{数据库与 R 语言}\label{sec-database-with-r}}

\href{https://github.com/prestodb/presto}{Presto} 的 R 接口 \url{https://github.com/prestodb/RPresto} 和文档 \url{https://prestodb.io/docs/current/index.html}，Presto 数据库

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}RPresto\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

MySQL 为例介绍 odbc 的连接和使用，详见 \href{https://cosx.org/2020/06/connect-mysql-from-r/}{从 R 连接 MySQL}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{{-}{-} !preview conn=DBI::dbConnect(odbc::odbc(),  driver = "MariaDB", database = "demo", }
\CommentTok{{-}{-}                              uid = "root", pwd = "cloud", host = "localhost", port = 3306)}

\KeywordTok{SELECT} \OperatorTok{*} \KeywordTok{FROM}\NormalTok{ mtcars}
\KeywordTok{LIMIT} \DecValTok{10}
\end{Highlighting}
\end{Shaded}

我的系统已经安装了多款数据库的 ODBC 驱动

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{dnf}\NormalTok{ install }\AttributeTok{{-}y}\NormalTok{ unixODBC unixODBC{-}devel mariadb mariadb{-}server mariadb{-}devel mariadb{-}connector{-}odbc}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{odbc}\SpecialCharTok{::}\FunctionTok{odbcListDrivers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# Driver from the mariadb-connector-odbc package
# Setup from the unixODBC package
[MariaDB]
Description     = ODBC for MariaDB
Driver          = /usr/lib/libmaodbc.so
Driver64        = /usr/lib64/libmaodbc.so
FileUsage       = 1
\end{verbatim}

\hypertarget{sec-batch-import-csv}{%
\section{批量读取 csv 文件}\label{sec-batch-import-csv}}

iris 数据转化为 data.table 类型，按照 Species 分组拆成单独的 csv 文件，各个文件的文件名用鸢尾花的类别名表示

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 批量分组导出}
\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{as.data.table}\NormalTok{(iris)[, }\FunctionTok{fwrite}\NormalTok{(.SD, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"data/user\_"}\NormalTok{, }\FunctionTok{unique}\NormalTok{(Species), }\StringTok{".csv"}\NormalTok{)), by }\OtherTok{=}\NormalTok{ Species, .SDcols }\OtherTok{=} \FunctionTok{colnames}\NormalTok{(iris)]}
\end{Highlighting}
\end{Shaded}

读取文件夹 \texttt{data/} 所有 csv 数据文件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{merged\_df }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\StringTok{\textquotesingle{}rbind\textquotesingle{}}\NormalTok{, }\FunctionTok{lapply}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"*.csv"}\NormalTok{, }\AttributeTok{path =} \StringTok{"data/"}\NormalTok{), fread ) )}
\CommentTok{\# 或者}
\NormalTok{merged\_df }\OtherTok{\textless{}{-}} \FunctionTok{rbindlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"*.csv"}\NormalTok{, }\AttributeTok{path =} \StringTok{"data/"}\NormalTok{), fread ))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xdf}\SpecialCharTok{$}\NormalTok{date }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(xdf}\SpecialCharTok{$}\NormalTok{date)}
\NormalTok{xdf}\SpecialCharTok{$}\NormalTok{ts }\OtherTok{\textless{}{-}} \FunctionTok{as.POSIXct}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(xdf}\SpecialCharTok{$}\NormalTok{ts), }\AttributeTok{origin =} \StringTok{"1978{-}01{-}01"}\NormalTok{)}
\FunctionTok{split}\NormalTok{(xdf[}\FunctionTok{order}\NormalTok{(xdf}\SpecialCharTok{$}\NormalTok{ts), ], }\FunctionTok{interaction}\NormalTok{(xdf}\SpecialCharTok{$}\NormalTok{study, xdf}\SpecialCharTok{$}\NormalTok{port)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(.x) \{}
\NormalTok{    .x[}\FunctionTok{nrow}\NormalTok{(.x), ]}
\NormalTok{  \}) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{unname}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{Filter}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(.x) \{}
    \FunctionTok{nrow}\NormalTok{(.x) }\SpecialCharTok{\textgreater{}} \DecValTok{0}
\NormalTok{  \}, .) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{do.call}\NormalTok{(rbind.data.frame, .)}

\FunctionTok{library}\NormalTok{(dplyr)}
\NormalTok{xdf }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{date =} \FunctionTok{as.Date}\NormalTok{(date),}
    \AttributeTok{ts =}\NormalTok{ anytime}\SpecialCharTok{::}\FunctionTok{anytime}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(ts))}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{arrange}\NormalTok{(ts) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(study, port) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{slice}\NormalTok{(}\FunctionTok{n}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tibble)}
\FunctionTok{library}\NormalTok{(magrittr)}

\NormalTok{mtcars }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(mtcars)}

\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{print}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\AttributeTok{width =} \DecValTok{69}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 32 x 11
##      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##    <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
##  1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
##  2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
##  3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
##  4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
##  5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
##  6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
##  7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
##  8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
##  9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
## 10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
## 11  17.8     6  168.   123  3.92  3.44  18.9     1     0     4     4
## 12  16.4     8  276.   180  3.07  4.07  17.4     0     0     3     3
## 13  17.3     8  276.   180  3.07  3.73  17.6     0     0     3     3
## 14  15.2     8  276.   180  3.07  3.78  18       0     0     3     3
## 15  10.4     8  472    205  2.93  5.25  18.0     0     0     3     4
## 16  10.4     8  460    215  3     5.42  17.8     0     0     3     4
## # ... with 16 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{print}\NormalTok{(., }\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(.)}\SpecialCharTok{/}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 32 x 11
##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
## 2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
## 3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
## 4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
## 5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
## 6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
## 7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
## 8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
## # ... with 24 more rows
\end{verbatim}

\hypertarget{sec-batch-export-xlsx}{%
\section{批量导出 xlsx 文件}\label{sec-batch-export-xlsx}}

将 R 环境中的数据集导出为 xlsx 表格

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 加载 openxlsx 包}
\FunctionTok{library}\NormalTok{(openxlsx)}
\DocumentationTok{\#\# 创建空白的工作薄，标题为鸢尾花数据集}
\NormalTok{wb }\OtherTok{\textless{}{-}} \FunctionTok{createWorkbook}\NormalTok{(}\AttributeTok{title =} \StringTok{"鸢尾花数据集"}\NormalTok{)}
\DocumentationTok{\#\# 添加 sheet 页}
\FunctionTok{addWorksheet}\NormalTok{(wb, }\AttributeTok{sheetName =} \StringTok{"iris"}\NormalTok{)}
\CommentTok{\# 将数据写进 sheet 页}
\FunctionTok{writeData}\NormalTok{(wb, }\AttributeTok{sheet =} \StringTok{"iris"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ iris, }\AttributeTok{colNames =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 导出数据到本地}
\FunctionTok{saveWorkbook}\NormalTok{(wb, }\AttributeTok{file =} \StringTok{"iris.xlsx"}\NormalTok{, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(openxlsx)}
\NormalTok{xlsxFile }\OtherTok{\textless{}{-}} \FunctionTok{system.file}\NormalTok{(}\StringTok{"extdata"}\NormalTok{, }\StringTok{"readTest.xlsx"}\NormalTok{, }\AttributeTok{package =} \StringTok{"openxlsx"}\NormalTok{)}
\CommentTok{\# 导入}
\NormalTok{dat }\OtherTok{=} \FunctionTok{read.xlsx}\NormalTok{(}\AttributeTok{xlsxFile =}\NormalTok{ xlsxFile)}
\CommentTok{\# 导出}
\FunctionTok{write.xlsx}\NormalTok{(dat, xlsxfile)}
\end{Highlighting}
\end{Shaded}

\hypertarget{dm-session-info}{%
\section{运行环境}\label{dm-session-info}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   askpass_1.1        assertthat_0.2.1   base64enc_0.1-3    blob_1.2.3        
##   bookdown_0.26      bslib_0.3.1        cli_3.3.0          codetools_0.2.18  
##   colorspace_2.0-3   compiler_4.2.0     config_0.3.1       cpp11_0.4.2       
##   crayon_1.5.1       curl_4.3.2         data.table_1.14.2  DBI_1.1.2         
##   dbplyr_2.1.1       digest_0.6.29      dplyr_1.0.9        ellipsis_0.3.2    
##   evaluate_0.15      fansi_1.0.3        farver_2.1.0       fastmap_1.1.0     
##   forge_0.2.0        fs_1.5.2           generics_0.1.2     ggplot2_3.3.6     
##   globals_0.15.0     glue_1.6.2         graphics_4.2.0     grDevices_4.2.0   
##   grid_4.2.0         gtable_0.3.0       highr_0.9          htmltools_0.5.2   
##   htmlwidgets_1.5.4  httr_1.4.3         isoband_0.2.5      jquerylib_0.1.4   
##   jsonlite_1.8.0     knitr_1.39         labeling_0.4.2     lattice_0.20.45   
##   lifecycle_1.0.1    magrittr_2.0.3     MASS_7.3.57        Matrix_1.4.1      
##   methods_4.2.0      mgcv_1.8.40        mime_0.12          munsell_0.5.0     
##   nlme_3.1.157       openssl_2.0.1      parallel_4.2.0     pillar_1.7.0      
##   pkgconfig_2.0.3    png_0.1-7          purrr_0.3.4        r2d3_0.2.6        
##   R6_2.5.1           rappdirs_0.3.3     RColorBrewer_1.1.3 rlang_1.0.2       
##   rmarkdown_2.14     rprojroot_2.0.3    rstudioapi_0.13    sass_0.4.1        
##   scales_1.2.0       sparklyr_1.7.5     splines_4.2.0      stats_4.2.0       
##   stringi_1.7.6      stringr_1.4.0      sys_3.4            sysfonts_0.8.8    
##   tibble_3.1.7       tidyr_1.2.0        tidyselect_1.1.2   tinytex_0.39      
##   tools_4.2.0        utf8_1.2.2         utils_4.2.0        uuid_1.1.0        
##   vctrs_0.4.1        viridisLite_0.4.0  withr_2.5.0        xfun_0.31         
##   xml2_1.3.3         yaml_2.3.5
\end{verbatim}

\hypertarget{chap-string-operations}{%
\chapter{字符串操作}\label{chap-string-operations}}

\href{https://www.gastonsanchez.com/r4strings/}{Handling Strings with R} 和 \href{https://r4ds.had.co.nz/strings.html}{R for Data Science} 提供字符串入门介绍 ，Sara Stoudt 整理了 stringr 包与 Base R 正则表达式函数的对应表 \url{https://stringr.tidyverse.org/articles/from-base.html}

\href{https://stringr.tidyverse.org/}{stringr} 基于 \href{https://github.com/gagolews/stringi}{stringi} 包字符串处理包， \href{https://github.com/qinwf/re2r/}{re2r} 包基于 Google 开发的 C++ 库 \href{https://github.com/google/re2}{re2}，Google 编程之夏项目提供了一份 \href{https://github.com/rstats-gsoc/gsoc2016/wiki/re2-regular-expressions}{正则表达式性能综述}， \href{https://github.com/markvanderloo/stringdist}{stringdist} Approximate String Matching and String Distance Functions 近似字符串匹配和字符串距离计算函数 \citep{stringdist2014}

\begin{itemize}
\tightlist
\item
  \href{https://github.com/sfirke/janitor}{janitor}
\item
  \href{https://www.brodrigues.co/blog/2019-02-10-stringr_package/}{Manipulating strings with the stringr package}
\item
  \href{https://github.com/rorynolan/filesstrings}{filesstrings} 基于 stringr 操作字符串
\item
  \href{https://github.com/rorynolan/strex}{strex} 一些没有包含在 stringr 或者 stringi 中的字符串操作函数
\item
  \href{https://github.com/juliasilge/tidytext}{tidytext} Text mining using dplyr, ggplot2, and other tidy tools
\end{itemize}

\href{https://github.com/markvanderloo/stringdist}{stringdist} \href{https://github.com/traversc/stringfish}{stringfish} \href{https://github.com/hadley/stringb}{stringb} \href{https://github.com/gagolews/stringi}{stringi} \href{https://github.com/tidyverse/stringr}{stringr}

字符和字符串类型的数据值得单独拿出来讲，不仅因为内容多，而且比较难，应用范围最广，特别是面对文本类型的数据时，几乎是避不开的！R 的前身是 S，S 的前身是一些 Fortran 和 C 子程序，最早在贝尔实验室是用于文本分析领域，因此在 R 基础包中提供了丰富的字符串处理函数，你可以在R控制台中执行如下一行命令查看

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{help.search}\NormalTok{(}\AttributeTok{keyword =} \StringTok{"character"}\NormalTok{, }\AttributeTok{package =} \StringTok{"base"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

本章主要介绍 R 内置的字符串操作函数

\hypertarget{base-count}{%
\section{字符数统计}\label{base-count}}

\texttt{nchar} 函数统计字符串向量中每个元素的字符个数，注意与函数\texttt{length} 的差别，它统计向量中元素的个数，即向量的长度。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Hello"}\NormalTok{, }\StringTok{"world"}\NormalTok{, }\StringTok{"!"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 5 5 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R.version.string}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "R version 4.2.0 (2022-04-22)"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(R.version.string)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 28
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{deparse}\NormalTok{(base}\SpecialCharTok{::}\NormalTok{mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "function (x, ...) "  "UseMethod(\"mean\")"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\FunctionTok{deparse}\NormalTok{(base}\SpecialCharTok{::}\NormalTok{mean))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 18 17
\end{verbatim}

一些特殊的情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\ConstantTok{NULL}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## integer(0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pi}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.141593
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(pi)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{exp}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.718282
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\FunctionTok{exp}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nchar}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

\hypertarget{base-translations}{%
\section{字符串翻译}\label{base-translations}}

\texttt{tolower} 将字符串或字符串向量中含有的大写字母全都转化为小写， \texttt{toupper} 函数正好与之相反.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tolower}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"HELLO"}\NormalTok{, }\StringTok{"Hello, R"}\NormalTok{, }\StringTok{"hello"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "hello"    "hello, r" "hello"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{toupper}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"HELLO"}\NormalTok{, }\StringTok{"Hello, R"}\NormalTok{, }\StringTok{"hello"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "HELLO"    "HELLO, R" "HELLO"
\end{verbatim}

\hypertarget{base-concatenate}{%
\section{字符串连接}\label{base-concatenate}}

\texttt{paste} 函数设置参数 sep 作为连接符，设置参数 collapse 可以将字符串拼接后连成一个字符串

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "AB"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{sep =} \StringTok{"{-}"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A-1" "B-2" "C-3"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{sep =} \StringTok{"{-}"}\NormalTok{, }\AttributeTok{collapse =} \StringTok{";"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A-1;B-2;C-3"
\end{verbatim}

\texttt{paste0} 相当于 sep 设为空，没有连接符

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste0}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "AB"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste0}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A1" "B2" "C3"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paste0}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{collapse =} \StringTok{";"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A1;B2;C3"
\end{verbatim}

\hypertarget{base-strsplit}{%
\section{字符串拆分}\label{base-strsplit}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strsplit}\NormalTok{(x, split, }\AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{strsplit} 函数用于字符串拆分，参数 x 是被拆分的字符串向量，其每个元素都会被拆分，而参数 split 表示拆分的位置，可以用正则表达式来描述位置，拆分的结果是一个列表。

参数 fixed 默认设置 \texttt{fixed\ =\ FALSE} 表示正则表达式匹配，而 \texttt{fixed\ =\ TRUE} 表示正则表达式的精确匹配或者按文本字符的字面意思匹配，即按普通文本匹配。我们知道按普通文本匹配速度快。

当启用 \texttt{perl\ =\ TRUE} 时，由 \texttt{PCRE\_use\_JIT} 控制细节。\texttt{perl} 参数的设置与 Perl 软件版本有关，如果正则表达式很长，除了正确设置正则表达式，使用 \texttt{perl\ =\ TRUE} 可以提高运算速度

参数 useBytes 设置是否按照逐个字节地进行匹配，默认设置为 FALSE，即按照字符而不是字节进行匹配

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{as =} \StringTok{"asfef"}\NormalTok{, }\AttributeTok{qu =} \StringTok{"qwerty"}\NormalTok{, }\StringTok{"yuiop["}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"stuff.blah.yech"}\NormalTok{)}
\CommentTok{\# 按字母 e 拆分字符串向量 x}
\FunctionTok{strsplit}\NormalTok{(x, }\StringTok{"e"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $as
## [1] "asf" "f"  
## 
## $qu
## [1] "qw"  "rty"
## 
## [[3]]
## [1] "yuiop["
## 
## [[4]]
## [1] "b"
## 
## [[5]]
## [1] "stuff.blah.y" "ch"
\end{verbatim}

参数 split 支持通过正则表达式的方式指明拆分位置

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 默认将点号 . 看作一个正则表达式，它是一个元字符，匹配任意字符}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{"a.b.c"}\NormalTok{, }\StringTok{"."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "" "" "" "" ""
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 这才是按点号拆分}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{"a.b.c"}\NormalTok{, }\StringTok{"."}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "a" "b" "c"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{"a.b.c"}\NormalTok{, }\StringTok{"[.]"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "a" "b" "c"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者转义点号，去掉元字符的特殊意义}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{"a.b.c"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "a" "b" "c"
\end{verbatim}

这里介绍一个将字符串逆序的函数 \texttt{str\_rev}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{str\_rev }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)}
        \FunctionTok{sapply}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(x, }\ConstantTok{NULL}\NormalTok{), rev), paste, }\AttributeTok{collapse =} \StringTok{""}\NormalTok{)}
\FunctionTok{str\_rev}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"abc"}\NormalTok{, }\StringTok{"Statistics"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "cba"        "scitsitatS"
\end{verbatim}

为了加深理解，再举几个例子

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 最后一个空字符没有产生}
\FunctionTok{strsplit}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{""}\NormalTok{), }\AttributeTok{collapse=}\StringTok{"\#"}\NormalTok{), }\AttributeTok{split=}\StringTok{"\#"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] ""  "a"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 空字符只有有定义的时候才会产生}
\FunctionTok{strsplit}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{" "}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## character(0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strsplit}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{" "}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] ""
\end{verbatim}

\hypertarget{base-match}{%
\section{字符串匹配}\label{base-match}}

\texttt{agrep} 和 \texttt{agrepl} 函数做近似（模糊）匹配 (Approximate Matching or Fuzzy Matching) ，对于匹配，考虑到参数 pattern 在参数 x 中匹配时，允许参数值x存在最小可能的插入、删除和替换，这种修改叫做Levenshtein 编辑距离，\texttt{max.distance} 控制其细节

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(pattern, x, }\AttributeTok{max.distance =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{costs =} \ConstantTok{NULL}\NormalTok{,}
      \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{value =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{agrepl}\NormalTok{(pattern, x, }\AttributeTok{max.distance =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{costs =} \ConstantTok{NULL}\NormalTok{,}
       \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{agrep} 函数返回 pattern 在 x 中匹配到的一个位置向量，\texttt{agrepl} 返回一个逻辑向量，这一点类似 \texttt{grep} 和 \texttt{grepl} 这对函数，下面举例子说明

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\StringTok{"1 lazy 2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# sub = 0 表示匹配时不考虑替换}
\FunctionTok{agrep}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{" 1 lazy 2"}\NormalTok{, }\StringTok{"1 lasy 2"}\NormalTok{), }\AttributeTok{max =} \FunctionTok{list}\NormalTok{(}\AttributeTok{sub =} \DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 默认设置下，匹配时区分大小写}
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 返回匹配到值，而不是位置下标，类似 grep(..., value = TRUE) 的返回值}
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1 lazy"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 不区分大小写}
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{, }\AttributeTok{ignore.case =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{startsWith}\NormalTok{(x, prefix)}
  \FunctionTok{endsWith}\NormalTok{(x, suffix)}
\end{Highlighting}
\end{Shaded}

\texttt{startsWith} 和 \texttt{endsWith} 函数用来匹配字符串的前缀和后缀，返回值是一个逻辑向量，参数 prefix 和 suffix 不要包含特殊的正则表达式字符，如点号\texttt{.}，举例子

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 字符串向量}
\FunctionTok{search}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] ".GlobalEnv"        "package:stats"     "package:graphics" 
## [4] "package:grDevices" "package:utils"     "package:datasets" 
## [7] "package:methods"   "Autoloads"         "package:base"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 匹配以 package: 开头的字符串}
\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{search}\NormalTok{(), }\StringTok{"package:"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者}
\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}package:"}\NormalTok{, }\FunctionTok{search}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE
\end{verbatim}

当前目录下，列出扩展名为 \texttt{.Rmd} 的文件

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# list.files(path = ".", pattern = "\textbackslash{}\textbackslash{}.Rmd$")}
\CommentTok{\# 而不是 endsWith(list.files(), "\textbackslash{}\textbackslash{}.Rmd")}
\FunctionTok{endsWith}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(), }\StringTok{".Rmd"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE
## [13] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE
## [25] FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
## [37] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE
## [49]  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE FALSE
## [61]  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE
## [73] FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者}
\FunctionTok{grepl}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.Rmd$"}\NormalTok{, }\FunctionTok{list.files}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE
## [13] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE
## [25] FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
## [37] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE
## [49]  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE FALSE
## [61]  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE
## [73] FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE
\end{verbatim}

部分匹配(Partial String Matching)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{match}\NormalTok{(x, table, }\AttributeTok{nomatch =} \ConstantTok{NA\_integer\_}\NormalTok{, }\AttributeTok{incomparables =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{x }\SpecialCharTok{\%in\%}\NormalTok{ table}
\FunctionTok{charmatch}\NormalTok{(x, table, }\AttributeTok{nomatch =} \ConstantTok{NA\_integer\_}\NormalTok{)}
\FunctionTok{pmatch}\NormalTok{(x, table, }\AttributeTok{nomatch =} \ConstantTok{NA\_integer\_}\NormalTok{, }\AttributeTok{duplicates.ok =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

这几个 \texttt{match} 函数的返回值都是一个向量，每个元素是参数x在参数table中第一次匹配到的位置，\texttt{charmatch} 与 \texttt{pmatch(x,\ table,\ nomatch\ =\ NA\_integer\_,\ duplicates.ok\ =\ TRUE)} 类似，所以 \texttt{pmatch} 在默认 \texttt{duplicates.ok\ =\ FALSE} 的情况下，若x在第二个参数table中有多次匹配就会返回 NA，因此，实际上 \texttt{pmatch} 只允许在第二个参数中匹配一次

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{match}\NormalTok{(}\StringTok{"xx"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"abc"}\NormalTok{, }\StringTok{"xx"}\NormalTok{, }\StringTok{"xxx"}\NormalTok{, }\StringTok{"xx"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\SpecialCharTok{:}\DecValTok{10} \SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# charmatch 就比较奇怪，规则太多}
\FunctionTok{charmatch}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{)                             }\CommentTok{\# returns 1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 多个精确匹配到，或者多个部分匹配到，则返回 0}
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"m"}\NormalTok{,   }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"median"}\NormalTok{, }\StringTok{"mode"}\NormalTok{, }\StringTok{"quantile"}\NormalTok{)) }\CommentTok{\# returns 0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# med 只在table参数值的第二个位置部分匹配到，所以返回2}
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"med"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"median"}\NormalTok{, }\StringTok{"mode"}\NormalTok{, }\StringTok{"quantile"}\NormalTok{)) }\CommentTok{\# returns 2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"xx"}\NormalTok{, }\StringTok{"xx"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"xx"}\NormalTok{, }\StringTok{"xxa"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{charmatch}\NormalTok{(}\StringTok{"xx"}\NormalTok{, }\StringTok{"axx"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 注意比较与 charmatch 的不同}
\FunctionTok{pmatch}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{)                             }\CommentTok{\# returns NA}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pmatch}\NormalTok{(}\StringTok{"m"}\NormalTok{,   }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"median"}\NormalTok{, }\StringTok{"mode"}\NormalTok{)) }\CommentTok{\# returns NA}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pmatch}\NormalTok{(}\StringTok{"med"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"median"}\NormalTok{, }\StringTok{"mode"}\NormalTok{)) }\CommentTok{\# returns 2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\hypertarget{base-search}{%
\section{字符串查询}\label{base-search}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(pattern, x,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{value =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{invert =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{grepl}\NormalTok{(pattern, x,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{grep} 和 \texttt{grepl} 是一对字符串查询函数，查看字符串向量 x 中是否包含正则表达式 pattern 描述的内容

\begin{itemize}
\tightlist
\item
  \texttt{ignore.case}: \texttt{TRUE} 表示忽略大小写，\texttt{FALSE} 表示匹配的时候区分大小写
\item
  \texttt{fixed\ =\ TRUE} 表示启用 literal regular expression 字面正则表达式，默认情况下\texttt{fixed\ =\ FALSE}
\item
  \texttt{grep} 函数返回匹配到的字符串向量x的元素的下标，如果 \texttt{value=TRUE} 则返回下标对应的值
\item
  \texttt{grepl} 函数返回一个逻辑向量，检查字符串向量x中的每个元素是否匹配到，匹配到返回 \texttt{TRUE}，没有匹配到返回 \texttt{FALSE}
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 返回下标位置}
\FunctionTok{grep}\NormalTok{(}\StringTok{"[a{-}z]"}\NormalTok{, letters)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
## [26] 26
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 返回查询到的值}
\FunctionTok{grep}\NormalTok{(}\StringTok{"[a{-}z]"}\NormalTok{, letters, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
## [20] "t" "u" "v" "w" "x" "y" "z"
\end{verbatim}

继续举例子

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"a"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"b"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"a"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "apple"  "banana"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"b"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "banana"
\end{verbatim}

关于 \texttt{grepl} 函数的使用例子

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"a"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"apple"}\NormalTok{, }\StringTok{"banana"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"b"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE  TRUE
\end{verbatim}

R 语言是用字符串来表示正则表达式的，但是正则表达式不是字符串，字符串的构造类似算术表达式

在 R 里面分别表示 \texttt{a\textbackslash{}\textbackslash{}b} 和 \texttt{a\textbackslash{}b}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a\\b
## a\b
\end{verbatim}

下面在 R 里面分别匹配字符串 \texttt{a\textbackslash{}\textbackslash{}b} 和 \texttt{a\textbackslash{}b} 中的 \texttt{\textbackslash{}\textbackslash{}} 和 \texttt{\textbackslash{}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 匹配字符串中的一个反斜杠}
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a\\\\b" "a\\b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a\\\\b" "a\\b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 匹配字符串中的两个反斜杠}
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a\\\\b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a\\\\b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 匹配字符串中的两个反斜杠 \textbackslash{}\textbackslash{}}
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =} \StringTok{"a}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regexpr}\NormalTok{(pattern, text,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{gregexpr}\NormalTok{(pattern, text,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{regexec}\NormalTok{(pattern, text,}
  \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}
\NormalTok{)       }
\end{Highlighting}
\end{Shaded}

当启用 \texttt{perl=TRUE} 时， 函数 \texttt{regexpr} 和 \texttt{gregexpr} 支持 Python 环境下的命名捕获(named captures)，但是不支持长向量的输入。如果一个分组被命名了，如 \texttt{(?\textless{}first\textgreater{}{[}A-Z{]}{[}a-z{]}+)} 那么匹配到的位置按命名返回。函数 \texttt{sub} 不支持命名反向引用 (Named backreferences)

函数 \texttt{regmatches} 用来提取函数\texttt{regexpr}, \texttt{gregexpr} 和 \texttt{regexec} 匹配到的子字符串

\texttt{useBytes\ =\ FALSE} 匹配位置和长度默认是按照字符级别来的，如果 \texttt{useBytes\ =\ TRUE} 则是按照逐个字节的匹配结果

如果使用到了 \textbf{命名捕获} 则会返回更多的属性 ``capture.start''，``capture.length'' 和 ``capture.names''，分别表示捕获的起始位置、捕获的长度和捕获的命名。

\begin{itemize}
\tightlist
\item
  \texttt{regexpr} 函数返回一个整型向量，第一次匹配的初始位置，-1 表示没有匹配到，返回的属性 \texttt{match.length} 表示匹配的字符数量，是一个整型向量，向量长度是匹配的文本的长度，-1 表示没有匹配到
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{text }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Hellow, Adam!"}\NormalTok{, }\StringTok{"Hi, Adam!"}\NormalTok{, }\StringTok{"How are you, Adam."}\NormalTok{)}
\FunctionTok{regexpr}\NormalTok{(}\StringTok{"Adam"}\NormalTok{, text)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  9  5 14
## attr(,"match.length")
## [1] 4 4 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{txt }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"The"}\NormalTok{, }\StringTok{"licenses"}\NormalTok{, }\StringTok{"for"}\NormalTok{, }\StringTok{"most"}\NormalTok{, }\StringTok{"software"}\NormalTok{, }\StringTok{"are"}\NormalTok{,}
  \StringTok{"designed"}\NormalTok{, }\StringTok{"to"}\NormalTok{, }\StringTok{"take"}\NormalTok{, }\StringTok{"away"}\NormalTok{, }\StringTok{"your"}\NormalTok{, }\StringTok{"freedom"}\NormalTok{,}
  \StringTok{"to"}\NormalTok{, }\StringTok{"share"}\NormalTok{, }\StringTok{"and"}\NormalTok{, }\StringTok{"change"}\NormalTok{, }\StringTok{"it."}\NormalTok{,}
  \StringTok{""}\NormalTok{, }\StringTok{"By"}\NormalTok{, }\StringTok{"contrast,"}\NormalTok{, }\StringTok{"the"}\NormalTok{, }\StringTok{"GNU"}\NormalTok{, }\StringTok{"General"}\NormalTok{, }\StringTok{"Public"}\NormalTok{, }\StringTok{"License"}\NormalTok{,}
  \StringTok{"is"}\NormalTok{, }\StringTok{"intended"}\NormalTok{, }\StringTok{"to"}\NormalTok{, }\StringTok{"guarantee"}\NormalTok{, }\StringTok{"your"}\NormalTok{, }\StringTok{"freedom"}\NormalTok{, }\StringTok{"to"}\NormalTok{,}
  \StringTok{"share"}\NormalTok{, }\StringTok{"and"}\NormalTok{, }\StringTok{"change"}\NormalTok{, }\StringTok{"free"}\NormalTok{, }\StringTok{"software"}\NormalTok{, }\StringTok{"{-}{-}"}\NormalTok{,}
  \StringTok{"to"}\NormalTok{, }\StringTok{"make"}\NormalTok{, }\StringTok{"sure"}\NormalTok{, }\StringTok{"the"}\NormalTok{, }\StringTok{"software"}\NormalTok{, }\StringTok{"is"}\NormalTok{,}
  \StringTok{"free"}\NormalTok{, }\StringTok{"for"}\NormalTok{, }\StringTok{"all"}\NormalTok{, }\StringTok{"its"}\NormalTok{, }\StringTok{"users"}
\NormalTok{)}
\CommentTok{\# gregexpr("en", txt)}
\FunctionTok{regexpr}\NormalTok{(}\StringTok{"en"}\NormalTok{, txt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] -1  4 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1  2 -1  4
## [26] -1  4 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
## attr(,"match.length")
##  [1] -1  2 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1  2 -1  2
## [26] -1  2 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{gregexpr} 函数返回一个列表，返回列表的长度与字符串向量的长度一样，列表中每个元素的形式与 \texttt{regexpr} 的返回值一样, except that the starting positions of every (disjoint) match are given.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gregexpr}\NormalTok{(}\StringTok{"Adam"}\NormalTok{, text)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 9
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## 
## [[2]]
## [1] 5
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## 
## [[3]]
## [1] 14
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{regexec} 函数返回一个列表，类似函数\texttt{gregexpr}的返回结果，长度与字符串向量的长度一样，如果没有匹配到就返回 -1，匹配到了就返回一个匹配的初值位置的整型序列，所有子字符串与括号分组的正则表达式的子表达式对应，属性 ``match.length'' 是一个表示匹配的长度的向量，如果是 -1 表示没有匹配到。位置、长度和属性的解释与 \texttt{regexpr} 一致
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regexec}\NormalTok{(}\StringTok{"Adam"}\NormalTok{, text)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 9
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## 
## [[2]]
## [1] 5
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## 
## [[3]]
## [1] 14
## attr(,"match.length")
## [1] 4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

由于资源限制（特别是 PCRE）导致的匹配失败，会视为没有匹配，通常伴随一个警告

下面这个将链接分解的例子由 Luke Tierney 提供\footnote{\url{https://homepage.divms.uiowa.edu/~luke/R/regexp.html}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"http://stat.umn.edu:80/xyz"}
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{regexec}\NormalTok{(}\StringTok{"\^{}(([\^{}:]+)://)?([\^{}:/]+)(:([0{-}9]+))?(/.*)"}\NormalTok{, x)}
\NormalTok{m}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1]  1  1  1  8 20 21 23
## attr(,"match.length")
## [1] 26  7  4 12  3  2  4
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

这里 x 是一个字符串，所以函数 \texttt{regexec} 返回的列表长度为1，正则表达式 \texttt{\^{}(({[}\^{}:{]}+)://)?({[}\^{}:/{]}+)(:({[}0-9{]}+))?(/.*)} 括号分组匹配到了7次，第一次匹配整个字符串，所以起始位置是1，而匹配长度是26，即整个字符串的长度，读者可以调用函数 \texttt{nchar(x)} 算一下，如果你愿意手动数一下也可以哈！余下不一一介绍，可以根据返回结果和图\ref{fig:regex101}一起看，最后还可以调用\texttt{regmatches}函数抽取匹配到的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regmatches}\NormalTok{(x, m)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "http://stat.umn.edu:80/xyz" "http://"                   
## [3] "http"                       "stat.umn.edu"              
## [5] ":80"                        "80"                        
## [7] "/xyz"
\end{verbatim}

我们可以在 \url{https://regex101.com/} 上测试表达式，如图\ref{fig:regex101}所示，表达式 \texttt{\^{}(({[}\^{}:{]}+)://)?({[}\^{}:/{]}+)(:({[}0-9{]}+))?(/.*)} 包含7个组，每个组的匹配结果见图的右下角，这样我们不难理解，函数 \texttt{regmatches} 返回的第列表中，第3个位置是传输协议 protocol \texttt{http} ，第4个位置是主机 host \texttt{stat.umn.edu}， 第6个位置是端口 port \texttt{80} ，第7个位置是路径 path \texttt{/xyz}，所以函数 \texttt{regmatches} 的作用就是根据函数 \texttt{regexec} 匹配的结果抽取子字符串。

\begin{figure}

{\centering \href{https://regex101.com/}{\includegraphics[width=0.75\linewidth]{screenshots/regexp-name-group} }

}

\caption{正则表达式匹配结果}\label{fig:regex101}
\end{figure}

进一步，我们可以用 \texttt{regmatches} 函数抽取 URL 的部分内容，如前面提到的传输协议，主机等

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{URL\_parts }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  m }\OtherTok{\textless{}{-}} \FunctionTok{regexec}\NormalTok{(}\StringTok{"\^{}(([\^{}:]+)://)?([\^{}:/]+)(:([0{-}9]+))?(/.*)"}\NormalTok{, x)}
\NormalTok{  parts }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}
\NormalTok{    rbind,}
    \FunctionTok{lapply}\NormalTok{(}\FunctionTok{regmatches}\NormalTok{(x, m), }\StringTok{\textasciigrave{}}\AttributeTok{[}\StringTok{\textasciigrave{}}\NormalTok{, }\FunctionTok{c}\NormalTok{(3L, 4L, 6L, 7L))}
    \CommentTok{\# 3,4,6,7是索引位置}
\NormalTok{  )}
  \FunctionTok{colnames}\NormalTok{(parts) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"protocol"}\NormalTok{, }\StringTok{"host"}\NormalTok{, }\StringTok{"port"}\NormalTok{, }\StringTok{"path"}\NormalTok{)}
\NormalTok{  parts}
\NormalTok{\}}
\FunctionTok{URL\_parts}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      protocol host           port path  
## [1,] "http"   "stat.umn.edu" "80" "/xyz"
\end{verbatim}

目前还没有 \texttt{gregexec} 函数，但是可以模拟一个，首先用 \texttt{gregexpr} 函数返回匹配的位置，\texttt{regmatches} 抽取相应的值，然后用 \texttt{regexec} 作用到每一个提取的值，做再一次匹配和值的抽取，实现了全部的匹配。另一个例子

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# There is no gregexec() yet, but one can emulate it by running}
\DocumentationTok{\#\# regexec() on the regmatches obtained via gregexpr().  E.g.:}
\NormalTok{pattern }\OtherTok{\textless{}{-}} \StringTok{"([[:alpha:]]+)([[:digit:]]+)"}
\NormalTok{s }\OtherTok{\textless{}{-}} \StringTok{"Test: A1 BC23 DEF456"}
\FunctionTok{gregexpr}\NormalTok{(pattern, s)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1]  7 10 15
## attr(,"match.length")
## [1] 2 4 6
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regmatches}\NormalTok{(s, }\FunctionTok{gregexpr}\NormalTok{(pattern, s))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "A1"     "BC23"   "DEF456"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lapply}\NormalTok{(}
  \FunctionTok{regmatches}\NormalTok{(s, }\FunctionTok{gregexpr}\NormalTok{(pattern, s)),}
  \ControlFlowTok{function}\NormalTok{(e) }\FunctionTok{regmatches}\NormalTok{(e, }\FunctionTok{regexec}\NormalTok{(pattern, e))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [[1]][[1]]
## [1] "A1" "A"  "1" 
## 
## [[1]][[2]]
## [1] "BC23" "BC"   "23"  
## 
## [[1]][[3]]
## [1] "DEF456" "DEF"    "456"
\end{verbatim}

\hypertarget{base-replacement}{%
\section{字符串替换}\label{base-replacement}}

\texttt{chartr} 支持正则表达式的替换，\texttt{chartr} 是对应字符的替换操作

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"MiXeD cAsE 123"}
\CommentTok{\# 将字符 iXs 替换为 why}
\FunctionTok{chartr}\NormalTok{(}\StringTok{"iXs"}\NormalTok{, }\StringTok{"why"}\NormalTok{, x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "MwheD cAyE 123"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 将字符串 a{-}cX 中的字符挨个对应地替换为 D{-}Fw}
\FunctionTok{chartr}\NormalTok{(}\StringTok{"a{-}cX"}\NormalTok{, }\StringTok{"D{-}Fw"}\NormalTok{, x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "MiweD FAsE 123"
\end{verbatim}

两个 \texttt{*sub} 函数的区别：\texttt{sub} 替换第一次匹配到的结果，\texttt{gsub} 替换所有匹配的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sub}\NormalTok{(}\StringTok{" .*"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{extSoftVersion}\NormalTok{()[}\StringTok{"PCRE"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    PCRE 
## "10.39"
\end{verbatim}

参数 replacement 的值是正则表达式，其包含反向引用的用法， \texttt{\textbackslash{}\textbackslash{}1} 即引用表达式 \texttt{({[}ab{]})}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern =}  \StringTok{"([ab])"}\NormalTok{, }\AttributeTok{replacement =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1\_}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1\_"}\NormalTok{, }\AttributeTok{x =} \StringTok{"abc and ABC"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a_a_b_b_c a_a_nd ABC"
\end{verbatim}

\hypertarget{base-extract}{%
\section{字符串提取}\label{base-extract}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substr}\NormalTok{(x, start, stop)}
\FunctionTok{substring}\NormalTok{(text, first, }\AttributeTok{last =}\NormalTok{ 1000000L)}
\end{Highlighting}
\end{Shaded}

\texttt{substr} 和 \texttt{substring} 函数通过位置进行字符串的拆分和提取，它们本身不使用正则表达式，结合其他正则表达式函数\texttt{regexpr}, \texttt{gregexpr} 和 \texttt{regexec}，可以很方便地从大量文本中提取所需的信息。作用类似之前提到的 \texttt{regmatches} 函数

参数设置基本相同

\begin{itemize}
\tightlist
\item
  x/text 是要拆分的字符串向量
\item
  start/first 截取的起始位置向量
\item
  stop/last 截取的终止位置向量
\end{itemize}

返回值有差别

\begin{itemize}
\tightlist
\item
  \texttt{substr} 返回的字串个数等于第一个参数 x 的长度
\item
  \texttt{substring} 返回字串个数等于三个参数中最长向量长度，短向量循环使用。
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"123456789"}
\FunctionTok{substr}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "234"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substring}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "234"     "45"      "2345678"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substr}\NormalTok{(}\StringTok{"abcdef"}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "bcd"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substring}\NormalTok{(}\StringTok{"abcdef"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a" "b" "c" "d" "e" "f"
\end{verbatim}

因为 x 的向量长度为1，所以 \texttt{substr} 获得的结果只有1个字串，即第2和第3个参数向量只用了第一个组合：起始位置2，终止位置4。而 \texttt{substring} 的语句三个参数中最长的向量为 \texttt{c(4,5,8)}，执行时按短向量循环使用的规则第一个参数事实上就是\texttt{c(x,x,x)}，第二个参数就成了\texttt{c(2,4,2)}，最终截取的字串起始位置组合为：2-4, 4-5和2-8。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"123456789"}\NormalTok{, }\StringTok{"abcdefghijklmnopq"}\NormalTok{)}
\FunctionTok{substr}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "234" "de"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{substring}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "234"     "de"      "2345678"
\end{verbatim}

更加高级的字符串抽取

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 从字符串中抽取固定模式的文本，替代 stringr::str\_extract}
\CommentTok{\# 只抽取一个匹配的}
\NormalTok{extract\_str }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, pattern) }\FunctionTok{regmatches}\NormalTok{(text, }\FunctionTok{regexpr}\NormalTok{(pattern, text))}
\CommentTok{\# 符合模式的全部抽取}
\NormalTok{gextract\_str }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, pattern) }\FunctionTok{regmatches}\NormalTok{(text, }\FunctionTok{gregexpr}\NormalTok{(pattern, text))}
\end{Highlighting}
\end{Shaded}

举例子，抽取连续的数字

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个例子}
\FunctionTok{extract\_str}\NormalTok{(}\AttributeTok{text =} \StringTok{"abd123da345das"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)\{3\}"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "123"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gextract\_str}\NormalTok{(}\AttributeTok{text =} \StringTok{"abd123da345das"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)\{3\}"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "123" "345"
\end{verbatim}

例子来自于 \url{https://recology.info/2018/10/limiting-dependencies/}

\hypertarget{string-named-capture}{%
\section{命名捕捉}\label{string-named-capture}}

函数 \texttt{regexpr(...,\ perl\ =\ TRUE)} 和 \texttt{gregexpr(...,\ perl\ =\ TRUE)} 支持命名捕捉

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# named capture}
\NormalTok{notables }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"  Ben Franklin and Jefferson Davis"}\NormalTok{,}
              \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{Millard Fillmore"}\NormalTok{)}
\CommentTok{\# name groups \textquotesingle{}first\textquotesingle{} and \textquotesingle{}last\textquotesingle{}}
\NormalTok{name.rex }\OtherTok{\textless{}{-}} \StringTok{"(?\textless{}first\textgreater{}[[:upper:]][[:lower:]]+) (?\textless{}last\textgreater{}[[:upper:]][[:lower:]]+)"}

\NormalTok{(parsed }\OtherTok{\textless{}{-}} \FunctionTok{regexpr}\NormalTok{(name.rex, notables, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3 2
## attr(,"match.length")
## [1] 12 16
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## attr(,"capture.start")
##      first last
## [1,]     3    7
## [2,]     2   10
## attr(,"capture.length")
##      first last
## [1,]     3    8
## [2,]     7    8
## attr(,"capture.names")
## [1] "first" "last"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attr}\NormalTok{(parsed, }\StringTok{\textquotesingle{}capture.names\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "first" "last"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regmatches}\NormalTok{(notables, parsed)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Ben Franklin"     "Millard Fillmore"
\end{verbatim}

希望返回一个 data.frame，列名是指定的 named group 名字

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 有多个结果}
\NormalTok{(idx }\OtherTok{\textless{}{-}} \FunctionTok{gregexpr}\NormalTok{(name.rex, notables, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1]  3 20
## attr(,"match.length")
## [1] 12 15
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## attr(,"capture.start")
##      first last
## [1,]     3    7
## [2,]    20   30
## attr(,"capture.length")
##      first last
## [1,]     3    8
## [2,]     9    5
## attr(,"capture.names")
## [1] "first" "last" 
## 
## [[2]]
## [1] 2
## attr(,"match.length")
## [1] 16
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## attr(,"capture.start")
##      first last
## [1,]     2   10
## attr(,"capture.length")
##      first last
## [1,]     7    8
## attr(,"capture.names")
## [1] "first" "last"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{regmatches}\NormalTok{(notables, idx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "Ben Franklin"    "Jefferson Davis"
## 
## [[2]]
## [1] "Millard Fillmore"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attr}\NormalTok{(idx[[}\DecValTok{1}\NormalTok{]], }\StringTok{\textquotesingle{}capture.names\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "first" "last"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{notable =}\NormalTok{ notables) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{tidyr}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(}
\NormalTok{    notable, }\FunctionTok{c}\NormalTok{(}\StringTok{"first"}\NormalTok{, }\StringTok{"last"}\NormalTok{), name.rex, }
    \AttributeTok{remove =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                              notable   first     last
## 1   Ben Franklin and Jefferson Davis     Ben Franklin
## 2                 \tMillard Fillmore Millard Fillmore
\end{verbatim}

\hypertarget{exact-match}{%
\section{精确匹配}\label{exact-match}}

\texttt{fixed\ =\ TRUE}

\hypertarget{fuzzy-match}{%
\section{模糊匹配}\label{fuzzy-match}}

近似字符串匹配 (Approximate String Matching) 也叫模糊匹配 (Fuzzy Matching)

\texttt{agrep()} \texttt{agrepl()} \texttt{aregexec()} \texttt{adist()}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"lasy"}\NormalTok{, }\AttributeTok{x =} \StringTok{"1 lazy 2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{" 1 lazy 2"}\NormalTok{, }\StringTok{"1 lasy 2"}\NormalTok{), }\AttributeTok{max =} \FunctionTok{list}\NormalTok{(}\AttributeTok{sub =} \DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1 lazy"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrep}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{), }\AttributeTok{max =} \DecValTok{2}\NormalTok{, }\AttributeTok{ignore.case =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{agrepl}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"lasy"}\NormalTok{, }\AttributeTok{x =} \StringTok{"1 lazy 2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Cf. the examples for agrep.}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"1 lazy"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"1 LAZY"}\NormalTok{)}

\FunctionTok{aregexec}\NormalTok{(}\StringTok{"laysy"}\NormalTok{, x, }\AttributeTok{max.distance =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 3
## attr(,"match.length")
## [1] 4
## 
## [[2]]
## [1] -1
## attr(,"match.length")
## [1] -1
## 
## [[3]]
## [1] -1
## attr(,"match.length")
## [1] -1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aregexec}\NormalTok{(}\StringTok{"(lay)(sy)"}\NormalTok{, x, }\AttributeTok{max.distance =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 3 3 5
## attr(,"match.length")
## [1] 4 2 2
## 
## [[2]]
## [1] -1
## attr(,"match.length")
## [1] -1
## 
## [[3]]
## [1] -1
## attr(,"match.length")
## [1] -1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aregexec}\NormalTok{(}\StringTok{"(lay)(sy)"}\NormalTok{, x, }\AttributeTok{max.distance =} \DecValTok{2}\NormalTok{, }\AttributeTok{ignore.case =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] 3 3 6
## attr(,"match.length")
## [1] 4 3 1
## 
## [[2]]
## [1] -1
## attr(,"match.length")
## [1] -1
## 
## [[3]]
## [1] 3 3 6
## attr(,"match.length")
## [1] 4 3 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{aregexec}\NormalTok{(}\StringTok{"(lay)(sy)"}\NormalTok{, x, }\AttributeTok{max.distance =} \DecValTok{2}\NormalTok{)}
\FunctionTok{regmatches}\NormalTok{(x, m)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "lazy" "la"   "zy"  
## 
## [[2]]
## character(0)
## 
## [[3]]
## character(0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Cf. https://en.wikipedia.org/wiki/Levenshtein\_distance}
\FunctionTok{adist}\NormalTok{(}\StringTok{"kitten"}\NormalTok{, }\StringTok{"sitting"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]
## [1,]    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# To see the transformation counts for the Levenshtein distance:}
\FunctionTok{drop}\NormalTok{(}\FunctionTok{attr}\NormalTok{(}\FunctionTok{adist}\NormalTok{(}\StringTok{"kitten"}\NormalTok{, }\StringTok{"sitting"}\NormalTok{, }\AttributeTok{counts =} \ConstantTok{TRUE}\NormalTok{), }\StringTok{"counts"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ins del sub 
##   1   0   2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# To see the transformation sequences:}
\FunctionTok{attr}\NormalTok{(}\FunctionTok{adist}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"kitten"}\NormalTok{, }\StringTok{"sitting"}\NormalTok{), }\AttributeTok{counts =} \ConstantTok{TRUE}\NormalTok{), }\StringTok{"trafos"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]      [,2]     
## [1,] "MMMMMM"  "SMMMSMI"
## [2,] "SMMMSMD" "MMMMMMM"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Cf. the examples for agrep:}
\FunctionTok{adist}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\StringTok{"1 lazy 2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]
## [1,]    5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# For a "partial approximate match" (as used for agrep):}
\FunctionTok{adist}\NormalTok{(}\StringTok{"lasy"}\NormalTok{, }\StringTok{"1 lazy 2"}\NormalTok{, }\AttributeTok{partial =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1]
## [1,]    1
\end{verbatim}

案例

\texttt{help.search()}

\hypertarget{replace}{%
\section{高级的替换}\label{replace}}

相比于 \texttt{sprintf()} 格式化输出字符串的方式替换，它的优势在于提示性，或者说代码的可读性

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{glue\_data }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(param, text) \{}
\NormalTok{  idx }\OtherTok{\textless{}{-}} \FunctionTok{gregexpr}\NormalTok{(}\StringTok{\textquotesingle{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{[\^{}\}]*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}\textquotesingle{}}\NormalTok{, text)[[1L]]}
\NormalTok{  keys }\OtherTok{\textless{}{-}} \FunctionTok{substring}\NormalTok{(text, idx, idx }\SpecialCharTok{+} \FunctionTok{attr}\NormalTok{(idx, }\StringTok{\textquotesingle{}match.length\textquotesingle{}}\NormalTok{) }\SpecialCharTok{{-}}\NormalTok{ 1L)}
  \ControlFlowTok{for}\NormalTok{ (key }\ControlFlowTok{in}\NormalTok{ keys) \{}
\NormalTok{    text }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(key, param[[}\FunctionTok{gsub}\NormalTok{(}\StringTok{\textquotesingle{}[\{\}]\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{, key)]], text, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  text}
\NormalTok{\}}
\FunctionTok{cat}\NormalTok{(}\FunctionTok{glue\_data}\NormalTok{(}
  \AttributeTok{param =} \FunctionTok{list}\NormalTok{(}\AttributeTok{table =} \StringTok{\textquotesingle{}flights\textquotesingle{}}\NormalTok{, }\AttributeTok{origin =} \StringTok{\textquotesingle{}JFK\textquotesingle{}}\NormalTok{),}
  \AttributeTok{text =} \StringTok{"}
\StringTok{  select count(*) as n}
\StringTok{  from \{table\}}
\StringTok{  where origin = \textquotesingle{}\{origin\}\textquotesingle{}}
\StringTok{  "}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##   select count(*) as n
##   from flights
##   where origin = 'JFK'
## 
\end{verbatim}

\hypertarget{extract}{%
\section{高级的提取}\label{extract}}

从 text 中抽取给定模式 pattern 的字符串

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{str\_extract }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, pattern, ...) }\FunctionTok{regmatches}\NormalTok{(text, }\FunctionTok{regexpr}\NormalTok{(pattern, text, ...))}
\end{Highlighting}
\end{Shaded}

举个栗子，比如提取数字

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{shopping\_list }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"apples x4"}\NormalTok{, }\StringTok{"bag of flour"}\NormalTok{, }\StringTok{"bag of sugar"}\NormalTok{, }\StringTok{"milk x2"}\NormalTok{)}
\NormalTok{stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(shopping\_list, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "4" NA  NA  "2"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 注意二者的差别}
\FunctionTok{str\_extract}\NormalTok{(shopping\_list, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "4" "2"
\end{verbatim}

提取所有符合匹配模式的字符串

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{str\_extract\_all }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, pattern, ...) }\FunctionTok{regmatches}\NormalTok{(text, }\FunctionTok{gregexpr}\NormalTok{(pattern, text, ...))}
\end{Highlighting}
\end{Shaded}

举个栗子，提取其中的英文字母

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str\_extract\_all}\NormalTok{(shopping\_list, }\StringTok{"[a{-}z]+"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "apples" "x"     
## 
## [[2]]
## [1] "bag"   "of"    "flour"
## 
## [[3]]
## [1] "bag"   "of"    "sugar"
## 
## [[4]]
## [1] "milk" "x"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(shopping\_list, }\StringTok{"[a{-}z]+"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1] "apples" "x"     
## 
## [[2]]
## [1] "bag"   "of"    "flour"
## 
## [[3]]
## [1] "bag"   "of"    "sugar"
## 
## [[4]]
## [1] "milk" "x"
\end{verbatim}

\hypertarget{other-string-op}{%
\section{其它操作}\label{other-string-op}}

\hypertarget{strwrap}{%
\subsection{strwrap}\label{strwrap}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{width =} \FloatTok{0.9} \SpecialCharTok{*} \FunctionTok{getOption}\NormalTok{(}\StringTok{"width"}\NormalTok{), }\AttributeTok{indent =} \DecValTok{0}\NormalTok{,}
        \AttributeTok{exdent =} \DecValTok{0}\NormalTok{, }\AttributeTok{prefix =} \StringTok{""}\NormalTok{, }\AttributeTok{simplify =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{initial =}\NormalTok{ prefix)}
\end{Highlighting}
\end{Shaded}

该函数把一个字符串当成一个段落的文字（不管字符串中是否有换行符），按照段落的格式（缩进和长度）和断字方式进行分行，每一行是结果中的一个字符串。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 读取一段文本}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(}\StringTok{"doc"}\NormalTok{), }\StringTok{"THANKS"}\NormalTok{)), }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\DocumentationTok{\#\# 将文本拆分为段落，且移除前三段}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(x, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{[ }\SpecialCharTok{\textbackslash{}t\textbackslash{}n}\StringTok{]*}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)]}
\CommentTok{\# 每一段换两行}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(x, }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
\CommentTok{\# 每一行的宽度设定为60个字符}
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{width =} \DecValTok{60}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## J. D. Beasley, David J. Best, Richard Brent, Kevin Buhr,
## Michael A. Covington, Bill Cleveland, Robert Cleveland,, G.
## W. Cran, C. G. Ding, Ulrich Drepper, Paul Eggert, J. O.
## Evans, David M. Gay, H. Frick, G. W. Hill, Richard H.
## Jones, Eric Grosse, Shelby Haberman, Bruno Haible, John
## Hartigan, Andrew Harvey, Trevor Hastie, Min Long Lam,
## George Marsaglia, K. J. Martin, Gordon Matzigkeit, C. R.
## Mckenzie, Jean McRae, Cyrus Mehta, Fionn Murtagh, John C.
## Nash, Finbarr O'Sullivan, R. E. Odeh, William Patefield,
## Nitin Patel, Alan Richardson, D. E. Roberts, Patrick
## Royston, Russell Lenth, Ming-Jen Shyu, Richard C.
## Singleton, S. G. Springer, Supoj Sutanthavibul, Irma
## Terpenning, G. E. Thomas, Rob Tibshirani, Wai Wan Tsang,
## Berwin Turlach, Gary V. Vaughan, Michael Wichura, Jingbo
## Wang, M. A. Wong, and the Free Software Foundation (for
## autoconf code and utilities). See also files under
## src/extras.
## 
## Many more, too numerous to mention here, have contributed
## by sending bug reports and suggesting various improvements.
## 
## Simon Davies whilst at the University of Auckland wrote the
## original version of glm().
## 
## Julian Harris and Wing Kwong (Tiki) Wan whilst at the
## University of Auckland assisted Ross Ihaka with the
## original Macintosh port.
## 
## R was inspired by the S environment which has been
## principally developed by John Chambers, with substantial
## input from Douglas Bates, Rick Becker, Bill Cleveland,
## Trevor Hastie, Daryl Pregibon and Allan Wilks.
## 
## A special debt is owed to John Chambers who has graciously
## contributed advice and encouragement in the early days of R
## and later became a member of the core team.
## 
## Stefano Iacus (up to 2014, a former member of R Core) and
## Simon Urbanek developed the macOS port, including the R.app
## GUI, toolchains and packaging.
## 
## The Windows port was originally developed by Guido
## Masarotto (for a while a member of R Core) and Brian
## Ripley, then further by Duncan Murdoch (a former member of
## R Core) and then Jeroen Ooms (base) and Uwe Ligges
## (packages).  Tomas Kalibera is the current main developer
## of the Windows port and provides assistance with package
## porting.
## 
## Tomas Kalibera's work has been sponsored by Jan Vitek and
## funded by his European Research Council grant "Evolving
## Language Ecosystems (ELE)".
## 
## Computing support (including hardware, hosting and
## infrastructure) has been provided/funded by the R
## Foundation, employers of R-Core members (notably WU Wien,
## ETH Zurich, U Oxford and U Iowa) and by Northeastern
## University and the University of Kent.
## 
## Distributions of R contain the recommended packages, whose
## authors/contributors are listed in their DESCRIPTION files.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 每一段的段首缩进5个字符}
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{width =} \DecValTok{60}\NormalTok{, }\AttributeTok{indent =} \DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      J. D. Beasley, David J. Best, Richard Brent, Kevin
## Buhr, Michael A. Covington, Bill Cleveland, Robert
## Cleveland,, G. W. Cran, C. G. Ding, Ulrich Drepper, Paul
## Eggert, J. O. Evans, David M. Gay, H. Frick, G. W. Hill,
## Richard H. Jones, Eric Grosse, Shelby Haberman, Bruno
## Haible, John Hartigan, Andrew Harvey, Trevor Hastie, Min
## Long Lam, George Marsaglia, K. J. Martin, Gordon
## Matzigkeit, C. R. Mckenzie, Jean McRae, Cyrus Mehta, Fionn
## Murtagh, John C. Nash, Finbarr O'Sullivan, R. E. Odeh,
## William Patefield, Nitin Patel, Alan Richardson, D. E.
## Roberts, Patrick Royston, Russell Lenth, Ming-Jen Shyu,
## Richard C. Singleton, S. G. Springer, Supoj Sutanthavibul,
## Irma Terpenning, G. E. Thomas, Rob Tibshirani, Wai Wan
## Tsang, Berwin Turlach, Gary V. Vaughan, Michael Wichura,
## Jingbo Wang, M. A. Wong, and the Free Software Foundation
## (for autoconf code and utilities). See also files under
## src/extras.
## 
##      Many more, too numerous to mention here, have
## contributed by sending bug reports and suggesting various
## improvements.
## 
##      Simon Davies whilst at the University of Auckland
## wrote the original version of glm().
## 
##      Julian Harris and Wing Kwong (Tiki) Wan whilst at the
## University of Auckland assisted Ross Ihaka with the
## original Macintosh port.
## 
##      R was inspired by the S environment which has been
## principally developed by John Chambers, with substantial
## input from Douglas Bates, Rick Becker, Bill Cleveland,
## Trevor Hastie, Daryl Pregibon and Allan Wilks.
## 
##      A special debt is owed to John Chambers who has
## graciously contributed advice and encouragement in the
## early days of R and later became a member of the core team.
## 
##      Stefano Iacus (up to 2014, a former member of R Core)
## and Simon Urbanek developed the macOS port, including the
## R.app GUI, toolchains and packaging.
## 
##      The Windows port was originally developed by Guido
## Masarotto (for a while a member of R Core) and Brian
## Ripley, then further by Duncan Murdoch (a former member of
## R Core) and then Jeroen Ooms (base) and Uwe Ligges
## (packages).  Tomas Kalibera is the current main developer
## of the Windows port and provides assistance with package
## porting.
## 
##      Tomas Kalibera's work has been sponsored by Jan Vitek
## and funded by his European Research Council grant "Evolving
## Language Ecosystems (ELE)".
## 
##      Computing support (including hardware, hosting and
## infrastructure) has been provided/funded by the R
## Foundation, employers of R-Core members (notably WU Wien,
## ETH Zurich, U Oxford and U Iowa) and by Northeastern
## University and the University of Kent.
## 
##      Distributions of R contain the recommended packages,
## whose authors/contributors are listed in their DESCRIPTION
## files.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 除了段首，每一段的余下诸行都缩进5个字符}
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{width =} \DecValTok{60}\NormalTok{, }\AttributeTok{exdent =} \DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## J. D. Beasley, David J. Best, Richard Brent, Kevin Buhr,
##      Michael A. Covington, Bill Cleveland, Robert
##      Cleveland,, G. W. Cran, C. G. Ding, Ulrich Drepper,
##      Paul Eggert, J. O. Evans, David M. Gay, H. Frick, G.
##      W. Hill, Richard H. Jones, Eric Grosse, Shelby
##      Haberman, Bruno Haible, John Hartigan, Andrew Harvey,
##      Trevor Hastie, Min Long Lam, George Marsaglia, K. J.
##      Martin, Gordon Matzigkeit, C. R. Mckenzie, Jean McRae,
##      Cyrus Mehta, Fionn Murtagh, John C. Nash, Finbarr
##      O'Sullivan, R. E. Odeh, William Patefield, Nitin
##      Patel, Alan Richardson, D. E. Roberts, Patrick
##      Royston, Russell Lenth, Ming-Jen Shyu, Richard C.
##      Singleton, S. G. Springer, Supoj Sutanthavibul, Irma
##      Terpenning, G. E. Thomas, Rob Tibshirani, Wai Wan
##      Tsang, Berwin Turlach, Gary V. Vaughan, Michael
##      Wichura, Jingbo Wang, M. A. Wong, and the Free
##      Software Foundation (for autoconf code and utilities).
##      See also files under src/extras.
## 
## Many more, too numerous to mention here, have contributed
##      by sending bug reports and suggesting various
##      improvements.
## 
## Simon Davies whilst at the University of Auckland wrote the
##      original version of glm().
## 
## Julian Harris and Wing Kwong (Tiki) Wan whilst at the
##      University of Auckland assisted Ross Ihaka with the
##      original Macintosh port.
## 
## R was inspired by the S environment which has been
##      principally developed by John Chambers, with
##      substantial input from Douglas Bates, Rick Becker,
##      Bill Cleveland, Trevor Hastie, Daryl Pregibon and
##      Allan Wilks.
## 
## A special debt is owed to John Chambers who has graciously
##      contributed advice and encouragement in the early days
##      of R and later became a member of the core team.
## 
## Stefano Iacus (up to 2014, a former member of R Core) and
##      Simon Urbanek developed the macOS port, including the
##      R.app GUI, toolchains and packaging.
## 
## The Windows port was originally developed by Guido
##      Masarotto (for a while a member of R Core) and Brian
##      Ripley, then further by Duncan Murdoch (a former
##      member of R Core) and then Jeroen Ooms (base) and Uwe
##      Ligges (packages).  Tomas Kalibera is the current main
##      developer of the Windows port and provides assistance
##      with package porting.
## 
## Tomas Kalibera's work has been sponsored by Jan Vitek and
##      funded by his European Research Council grant
##      "Evolving Language Ecosystems (ELE)".
## 
## Computing support (including hardware, hosting and
##      infrastructure) has been provided/funded by the R
##      Foundation, employers of R-Core members (notably WU
##      Wien, ETH Zurich, U Oxford and U Iowa) and by
##      Northeastern University and the University of Kent.
## 
## Distributions of R contain the recommended packages, whose
##      authors/contributors are listed in their DESCRIPTION
##      files.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 在输出的每一行前面添加前缀}
\FunctionTok{writeLines}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, }\AttributeTok{prefix =} \StringTok{"THANKS\textgreater{} "}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## THANKS> J. D. Beasley, David J. Best, Richard Brent, Kevin Buhr,
## THANKS> Michael A. Covington, Bill Cleveland, Robert Cleveland,, G. W.
## THANKS> Cran, C. G. Ding, Ulrich Drepper, Paul Eggert, J. O. Evans,
## THANKS> David M. Gay, H. Frick, G. W. Hill, Richard H. Jones, Eric
## THANKS> Grosse, Shelby Haberman, Bruno Haible, John Hartigan, Andrew
## THANKS> Harvey, Trevor Hastie, Min Long Lam, George Marsaglia, K. J.
## THANKS> Martin, Gordon Matzigkeit, C. R. Mckenzie, Jean McRae, Cyrus
## THANKS> Mehta, Fionn Murtagh, John C. Nash, Finbarr O'Sullivan, R. E.
## THANKS> Odeh, William Patefield, Nitin Patel, Alan Richardson, D. E.
## THANKS> Roberts, Patrick Royston, Russell Lenth, Ming-Jen Shyu, Richard
## THANKS> C. Singleton, S. G. Springer, Supoj Sutanthavibul, Irma
## THANKS> Terpenning, G. E. Thomas, Rob Tibshirani, Wai Wan Tsang, Berwin
## THANKS> Turlach, Gary V. Vaughan, Michael Wichura, Jingbo Wang, M. A.
## THANKS> Wong, and the Free Software Foundation (for autoconf code and
## THANKS> utilities). See also files under src/extras.
## THANKS> 
## THANKS> Many more, too numerous to mention here, have contributed by
## THANKS> sending bug reports and suggesting various improvements.
## THANKS> 
## THANKS> Simon Davies whilst at the University of Auckland wrote the
## THANKS> original version of glm().
## THANKS> 
## THANKS> Julian Harris and Wing Kwong (Tiki) Wan whilst at the
## THANKS> University of Auckland assisted Ross Ihaka with the original
## THANKS> Macintosh port.
## THANKS> 
## THANKS> R was inspired by the S environment which has been principally
## THANKS> developed by John Chambers, with substantial input from Douglas
## THANKS> Bates, Rick Becker, Bill Cleveland, Trevor Hastie, Daryl
## THANKS> Pregibon and Allan Wilks.
## THANKS> 
## THANKS> A special debt is owed to John Chambers who has graciously
## THANKS> contributed advice and encouragement in the early days of R and
## THANKS> later became a member of the core team.
## THANKS> 
## THANKS> Stefano Iacus (up to 2014, a former member of R Core) and Simon
## THANKS> Urbanek developed the macOS port, including the R.app GUI,
## THANKS> toolchains and packaging.
## THANKS> 
## THANKS> The Windows port was originally developed by Guido Masarotto
## THANKS> (for a while a member of R Core) and Brian Ripley, then further
## THANKS> by Duncan Murdoch (a former member of R Core) and then Jeroen
## THANKS> Ooms (base) and Uwe Ligges (packages).  Tomas Kalibera is the
## THANKS> current main developer of the Windows port and provides
## THANKS> assistance with package porting.
## THANKS> 
## THANKS> Tomas Kalibera's work has been sponsored by Jan Vitek and
## THANKS> funded by his European Research Council grant "Evolving
## THANKS> Language Ecosystems (ELE)".
## THANKS> 
## THANKS> Computing support (including hardware, hosting and
## THANKS> infrastructure) has been provided/funded by the R Foundation,
## THANKS> employers of R-Core members (notably WU Wien, ETH Zurich, U
## THANKS> Oxford and U Iowa) and by Northeastern University and the
## THANKS> University of Kent.
## THANKS> 
## THANKS> Distributions of R contain the recommended packages, whose
## THANKS> authors/contributors are listed in their DESCRIPTION files.
\end{verbatim}

再举一个烧脑的例子

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(}
  \FunctionTok{sample}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{), }\CommentTok{\# 从1{-}10个数字中有放回的随机抽取100个数}
  \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{substring}\NormalTok{(}\StringTok{"aaaaaaaaaa"}\NormalTok{, }\DecValTok{1}\NormalTok{, x)}
\NormalTok{), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{)}
\FunctionTok{sapply}\NormalTok{(}
  \DecValTok{10}\SpecialCharTok{:}\DecValTok{40}\NormalTok{,}
  \ControlFlowTok{function}\NormalTok{(m)}
    \FunctionTok{c}\NormalTok{(}\AttributeTok{target =}\NormalTok{ m, }\AttributeTok{actual =} \FunctionTok{max}\NormalTok{(}\FunctionTok{nchar}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(x, m))))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]
## target   10   11   12   13   14   15   16   17   18    19    20    21    22
## actual   10   10   11   12   13   14   15   16   17    18    19    20    21
##        [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24] [,25]
## target    23    24    25    26    27    28    29    30    31    32    33    34
## actual    22    23    24    25    26    27    28    29    30    31    32    33
##        [,26] [,27] [,28] [,29] [,30] [,31]
## target    35    36    37    38    39    40
## actual    34    35    36    37    38    39
\end{verbatim}

\hypertarget{strtrim}{%
\subsection{strtrim}\label{strtrim}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strtrim}\NormalTok{(x, width)}
\end{Highlighting}
\end{Shaded}

\texttt{strtrim} 函数将字符串x修剪到特定的显示宽度，返回的字符串向量的长度等于字符串向量 x 的长度，如果 width 的参数值（它是一个整型向量）的长度小于 x 的，就循环补齐。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strtrim}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"abcdef"}\NormalTok{, }\StringTok{"abcdef"}\NormalTok{, }\StringTok{"abcdef"}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a"      "abcde"  "abcdef"
\end{verbatim}

\hypertarget{strrep}{%
\subsection{strrep}\label{strrep}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strrep}\NormalTok{(x, times)}
\end{Highlighting}
\end{Shaded}

以给定的次数重复字符串向量中每个元素的个数，并连接字符串的各个副本

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strrep}\NormalTok{(}\StringTok{"ABC"}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ABCABC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{strrep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{1} \SpecialCharTok{:} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A"   "BB"  "CCC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 创建一个字符串向量，指定每个元素中空格的数量}
\FunctionTok{strrep}\NormalTok{(}\StringTok{" "}\NormalTok{, }\DecValTok{1} \SpecialCharTok{:} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] " "     "  "    "   "   "    "  "     "
\end{verbatim}

\hypertarget{trimws}{%
\subsection{trimws}\label{trimws}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trimws}\NormalTok{(x, }\AttributeTok{which =} \FunctionTok{c}\NormalTok{(}\StringTok{"both"}\NormalTok{, }\StringTok{"left"}\NormalTok{, }\StringTok{"right"}\NormalTok{), }\AttributeTok{whitespace =} \StringTok{"[ }\SpecialCharTok{\textbackslash{}t\textbackslash{}r\textbackslash{}n}\StringTok{]"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{trimws} 函数用于移除字符串中的空格，这种空格可以来自制表符、回车符和换行符，位置可以位于字符串的开头或者结尾，\texttt{which} 参数指定空格的大致位置。举例如下

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"  Some text. "}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "  Some text. "
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trimws}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Some text."
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trimws}\NormalTok{(x, }\StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Some text. "
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{trimws}\NormalTok{(x, }\StringTok{"r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "  Some text."
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{shopping\_list }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"apples x4"}\NormalTok{, }\StringTok{"bag of flour"}\NormalTok{, }\StringTok{"bag of sugar"}\NormalTok{, }\StringTok{"milk x2"}\NormalTok{)}

\NormalTok{stringr}\SpecialCharTok{::}\FunctionTok{str\_replace}\NormalTok{(}\AttributeTok{string =}\NormalTok{ shopping\_list, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{, }\AttributeTok{replacement =} \StringTok{"aa"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "apples xaa"   "bag of flour" "bag of sugar" "milk xaa"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://github.com/hadley/stringb/issues/5}
\CommentTok{\# x is vector}
\NormalTok{str\_replace }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, pattern, fun, ...) \{}
\NormalTok{  loc }\OtherTok{\textless{}{-}} \FunctionTok{gregexpr}\NormalTok{(pattern, }\AttributeTok{text =}\NormalTok{ x, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  matches }\OtherTok{\textless{}{-}} \FunctionTok{regmatches}\NormalTok{(x, loc)}
\NormalTok{  out }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(matches, fun, ...)}

  \FunctionTok{regmatches}\NormalTok{(x, loc) }\OtherTok{\textless{}{-}}\NormalTok{ out}
\NormalTok{  x}
\NormalTok{\}}


\NormalTok{loc }\OtherTok{\textless{}{-}} \FunctionTok{gregexpr}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{, }\AttributeTok{text =}\NormalTok{ shopping\_list, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{)}

\NormalTok{matches }\OtherTok{=} \FunctionTok{regmatches}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shopping\_list, loc)}

\NormalTok{matches}

\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(matches, transform, }\StringTok{"aa"}\NormalTok{)}

\FunctionTok{regmatches}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shopping\_list, loc) }\OtherTok{\textless{}{-}}\NormalTok{ out}


\NormalTok{shopping\_list}


\FunctionTok{str\_replace}\NormalTok{(shopping\_list, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{d"}\NormalTok{, }\AttributeTok{replace =} \StringTok{"aa"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{tolower}{%
\subsection{tolower}\label{tolower}}

tolower 和 toupper 是一对，将大写转小写，小写转大写

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{simpleCap }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{tolower}\NormalTok{(x)}
\NormalTok{  s }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(x, }\StringTok{" "}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
  \FunctionTok{paste}\NormalTok{(}\FunctionTok{toupper}\NormalTok{(}\FunctionTok{substring}\NormalTok{(s, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)), }\FunctionTok{substring}\NormalTok{(s, }\DecValTok{2}\NormalTok{),}
    \AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{collapse =} \StringTok{" "}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 参考文献条目里需要将每个英文单词的首字母大写}
\FunctionTok{simpleCap}\NormalTok{(}\AttributeTok{x =} \StringTok{"THE USE OF MULTIPLE MEASUREMENTS IN TAXONOMIC PROBLEMS"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "The Use Of Multiple Measurements In Taxonomic Problems"
\end{verbatim}

\hypertarget{encode-string}{%
\section{字符串加密}\label{encode-string}}

字符串编码加密， \textbf{openssl} 包提供了 sha1 函数 \footnote{参考刘思喆的两篇博文： \href{http://bjt.name/2019/09/28/secure-hash.html}{利用 R 函数生成差异化密码} 和 \href{http://bjt.name/2019/10/21/url-handle.html}{在 R 中各种码的转换}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(openssl)}
\NormalTok{encode\_mobile }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(phone\_number) }\FunctionTok{paste}\NormalTok{(}\StringTok{"*"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(}\FunctionTok{toupper}\NormalTok{(}\FunctionTok{sha1}\NormalTok{(}\FunctionTok{sha1}\NormalTok{(}\FunctionTok{charToRaw}\NormalTok{(}\FunctionTok{paste}\NormalTok{(phone\_number, }\StringTok{"$1$mobile$"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{))))), }\AttributeTok{collapse =} \StringTok{""}\NormalTok{), }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\CommentTok{\# 随意模拟两个手机号}
\NormalTok{mobile\_vec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"18601013453"}\NormalTok{, }\StringTok{"13811674545"}\NormalTok{)}
\FunctionTok{sapply}\NormalTok{(mobile\_vec, encode\_mobile)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                 18601013453 
## "*B1D46D1D62C7280137F0E14249EE500865247B7B" 
##                                 13811674545 
## "*0554DA6E403491F58F1567DF2EDEB19186B77173"
\end{verbatim}

\hypertarget{performance}{%
\section{处理性能}\label{performance}}

当你对一个很长的字符串进行大量的正则表达式匹配的时候，你需要考虑性能问题了，这时候该考虑启用合适的选项，一般来讲， PCRE 比默认的正则表达式引擎快，\texttt{fixed=TRUE} 可以继续加快匹配速度，特别是当每个模式只匹配少量次数时。

连接字符串，\texttt{paste/c/bfile/bracket} 函数性能比较 \url{https://wch.github.io/string_builder/index.html}

R 内置的默认正则表达式匹配方式是基于 PCRE 的匹配，\texttt{options} 控制 PCRE 默认的三个选项 \texttt{PCRE\_limit\_recursion=NA} 、\texttt{PCRE\_study=10} 和 \texttt{PCRE\_use\_JIT=TRUE}，当前系统环境下 PCRE 的支持情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pcre\_config}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              UTF-8 Unicode properties                JIT              stack 
##               TRUE               TRUE               TRUE              FALSE
\end{verbatim}

查看R环境的 PCRE 配置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sapply}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"PCRE\_limit\_recursion"}\NormalTok{, }\StringTok{"PCRE\_study"}\NormalTok{, }\StringTok{"PCRE\_use\_JIT"}\NormalTok{), getOption)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## PCRE_limit_recursion           PCRE_study         PCRE_use_JIT 
##                   NA                FALSE                 TRUE
\end{verbatim}

\hypertarget{web-crawler}{%
\section{网络爬虫}\label{web-crawler}}

用 R 语言写爬虫 \href{https://github.com/jeroen/curl}{curl}、\href{https://github.com/r-lib/httr}{httr}、 \href{https://github.com/r-lib/xml2}{xml2}、\href{https://CRAN.R-project.org/package=XML}{XML} 和 \href{https://github.com/tidyverse/rvest}{rvest} 解析网页\footnote{Jeroen Ooms 已经确认 RCurl 早已经不再维护，取代它的是 curl/httr，不要使用不再维护的 R 包 \url{https://frie.codes/curl-vs-rcurl/}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看 libcurl 库的版本}
\FunctionTok{libcurlVersion}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "7.68.0"
## attr(,"ssl_version")
## [1] "OpenSSL/1.1.1f"
## attr(,"libssh_version")
## [1] "libssh/0.9.3/openssl/zlib"
## attr(,"protocols")
##  [1] "dict"   "file"   "ftp"    "ftps"   "gopher" "http"   "https"  "imap"  
##  [9] "imaps"  "ldap"   "ldaps"  "pop3"   "pop3s"  "rtmp"   "rtsp"   "scp"   
## [17] "sftp"   "smb"    "smbs"   "smtp"   "smtps"  "telnet" "tftp"
\end{verbatim}

于主编利用 \href{https://github.com/RobertMyles/tidyRSS}{tidyRSS} 包 抓取解析博客站点的订阅信息，并将此设置为定时任务，创建自动更新内容的博客聚合网站 \href{https://dailyr.netlify.com/}{Daily R}

抓取地震台信息

\href{https://d.cosx.org/d/420739}{一个爬网页的练习：看看 R 邮件列表中最热门的讨论是什么}

\hypertarget{text-mining}{%
\section{文本挖掘}\label{text-mining}}

\href{https://masalmon.eu/2019/02/11/trump-schedule/}{How did Axios rectangle Trump's PDF schedule? A try with R} 使用 pdftools 和 magick 处理表格，这两个 R 包分别依赖 Poppler C++ 和 ImageMagick++，在 Ubuntu 上安装 pdftools 和 magick 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install libpoppler{-}cpp{-}dev libmagick++{-}dev}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"pdftools"}\NormalTok{, }\StringTok{"magick"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

除了 pdftools 包外，PDF 文档中表格抽取工具还有 \href{https://github.com/ropensci/tabulizer}{tabulizer}。扫描版 PDF 文档需要OCR识别技术支持的 tesseract 包

\hypertarget{string-session-info}{%
\section{运行环境}\label{string-session-info}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   askpass_1.1      assertthat_0.2.1 base64enc_0.1.3  bookdown_0.26   
##   bslib_0.3.1      cli_3.3.0        compiler_4.2.0   cpp11_0.4.2     
##   crayon_1.5.1     curl_4.3.2       DBI_1.1.2        digest_0.6.29   
##   dplyr_1.0.9      ellipsis_0.3.2   evaluate_0.15    fansi_1.0.3     
##   fastmap_1.1.0    fs_1.5.2         generics_0.1.2   glue_1.6.2      
##   graphics_4.2.0   grDevices_4.2.0  highr_0.9        htmltools_0.5.2 
##   jquerylib_0.1.4  jsonlite_1.8.0   knitr_1.39       lifecycle_1.0.1 
##   magrittr_2.0.3   methods_4.2.0    openssl_2.0.1    pillar_1.7.0    
##   pkgconfig_2.0.3  purrr_0.3.4      R6_2.5.1         rappdirs_0.3.3  
##   rlang_1.0.2      rmarkdown_2.14   sass_0.4.1       stats_4.2.0     
##   stringi_1.7.6    stringr_1.4.0    sys_3.4          sysfonts_0.8.8  
##   tibble_3.1.7     tidyr_1.2.0      tidyselect_1.1.2 tinytex_0.39    
##   tools_4.2.0      utf8_1.2.2       utils_4.2.0      vctrs_0.4.1     
##   xfun_0.31        yaml_2.3.5
\end{verbatim}

\hypertarget{chap-regular-expressions}{%
\chapter{正则表达式}\label{chap-regular-expressions}}

\begin{quote}
Douglas Bates: If you really want to be cautious you could use an octal representation like \texttt{sep="\textbackslash{}\textbackslash{}007"} to get a character that is very unlikely to occur in a factor level.

Ed L. Cashin: I definitely want to be cautious. Instead of the bell character I think I'll use the field separator character, \texttt{"\textbackslash{}\textbackslash{}034"}, just because this is the first time I've been able to use it for it's intended purpose! ;)

Douglas Bates: Yes, but with \texttt{"\textbackslash{}\textbackslash{}034"} you don't get to make obscure James Bond references :-)

\hspace*{\fill} --- Douglas Bates and Ed L. Cashin R-help (April 2004)
\end{quote}

维基百科关于 \href{https://www.wikiwand.com/en/Regular_expression}{正则表达式的描述}， \href{https://github.com/ziishaned/learn-regex/blob/master/translations/README-cn.md}{学习正则表达式}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 毒鸡汤用来做文本分析}
\CommentTok{\# https://github.com/egotong/nows/blob/master/soul.sql}
\end{Highlighting}
\end{Shaded}

R 内置的三种匹配模式

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{fixed\ =\ TRUE}: 字面意思匹配 exact matching.
\item
  \texttt{perl\ =\ TRUE}: 使用 Perl 正则表达式.
\item
  \texttt{fixed\ =\ FALSE,\ perl\ =\ FALSE}: 使用 POSIX 1003.2 extended 正则表达式 (默认设置).
\end{enumerate}

不要拘泥于一种解决方案，比如清理数据中正则表达式有 Base R 提供的一套，stringr 又一套，提高效率的工具 RStudio 插件 \href{https://github.com/gadenbuie/regexplain}{regexplain} 和辅助创建正则表达式 \href{https://github.com/VerbalExpressions/RVerbalExpressions}{RVerbalExpressions} 包。

有几个名词需要单独拎出来解释的

\begin{itemize}
\tightlist
\item
  literal character strings 字面字符串
\item
  metacharacters 元字符
\item
  extended regular expressions 在下文中约定翻译为默认正则表达式
\item
  character class 字符集 \texttt{{[}abc{]}}
\item
  Perl-like regular expressions Perl 风格的正则表达式
\end{itemize}

以下所述，都不考虑函数中参数 \texttt{perl=TRUE} 的情况，R 语言中提供了扩展的（默认的）和 Perl 风格 的两套正则表达式。作为入门，我们这里只关注前者，启用 Perl 正则表达式只需在函数如 \texttt{grep} 中将选项 \texttt{perl\ =\ TRUE} 即可，并将后者统一命名为 Perl 正则表达式\footnote{推荐的学习正则表达式的路径可以见统计之都论坛 \url{https://d.cosx.org/d/420410}}。

正则表达式 (\textbf{reg}ular \textbf{exp}ression，简称 regexp)， 函数 \texttt{regexpr} 和 \texttt{gregexpr} 的名称就好理解了，在控制台输入 \texttt{?regex} 查看 R 支持的正则表达式，这个文档看上百八十回也不过分。R 内支持正则表达式的函数有 \texttt{grep}、\texttt{grepl}、\texttt{sub}、\texttt{gsub}、\texttt{regexpr}、\texttt{gregexpr} 、 \texttt{regexec} 和 \texttt{strsplit}。函数 \texttt{apropos}，\texttt{browseEnv}，\texttt{help.search}，\texttt{list.files} 和 \texttt{ls} 是通过函数 \texttt{grep} 来使用正则表达式的，它们全都使用 extended regular expressions

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(pattern, x, }\AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{perl =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{value =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{fixed =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{useBytes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{invert =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

匹配模式 pattern 的内容 可以用函数 \texttt{cat} 打印出来，注意反斜杠进入 R 字符串中时，需要用两个，反斜杠 \texttt{\textbackslash{}} 本身是转义符，否则会报错。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{) }\CommentTok{\# \textbackslash{} 反斜杠是转义字符}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## \
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## \.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}n}\StringTok{"}\NormalTok{) }\CommentTok{\# 注意 \textbackslash{}n 表示换行}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## \
\end{verbatim}

\hypertarget{character-constants}{%
\section{字符常量}\label{character-constants}}

单引号 \texttt{\textquotesingle{}} 双引号 \texttt{"} 和反引号 ` 三种类型的引用 (quotes) 是 R 语法的一部分\footnote{\url{https://stat.ethz.ch/R-manual/R-devel/library/base/html/Quotes.html}}，此外反斜杠 \texttt{\textbackslash{}} 用来转义下面的字符

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:character-constants} 字符常量表}\tabularnewline
\toprule
字符常量 & 含义 \\
\midrule
\endfirsthead
\toprule
字符常量 & 含义 \\
\midrule
\endhead
\texttt{\textbackslash{}n} & 换行 newline \\
\texttt{\textbackslash{}r} & 回车 carriage return \\
\texttt{\textbackslash{}t} & 制表符 tab \\
\texttt{\textbackslash{}b} & 退格 backspace \\
\texttt{\textbackslash{}a} & 警报（铃）alert (bell) \\
\texttt{\textbackslash{}f} & 换页 form feed \\
\texttt{\textbackslash{}v} & 垂直制表符 vertical tab \\
\texttt{\textbackslash{}\textbackslash{}} & 反斜杠 backslash \texttt{\textbackslash{}} \\
\texttt{\textbackslash{}\textquotesingle{}} & 单引号 ASCII apostrophe \texttt{\textquotesingle{}} \\
\texttt{\textbackslash{}"} & 双引号 ASCII quotation mark \texttt{"} \\
\texttt{\textbackslash{}\textasciigrave{}} & 反引号或沉音符 ASCII grave accent (backtick) ` \\
\texttt{\textbackslash{}nnn} & 八进制 character with given octal code (1, 2 or 3 digits) \\
\texttt{\textbackslash{}xnn} & 十六进制 character with given hex code (1 or 2 hex digits) \\
\texttt{\textbackslash{}unnnn} & Unicode character with given code (1--4 hex digits) \\
\texttt{\textbackslash{}Unnnnnnnn} & Unicode character with given code (1--8 hex digits) \\
\bottomrule
\end{longtable}

\hypertarget{environments}{%
\section{软件环境}\label{environments}}

R 内置的正则表达式实现是基于 PCRE ICU TRE iconv 等第三方库，搞清楚自己使用的版本信息是重要的，一些字符集的解释与区域环境有关，如 \texttt{{[}:alnum:{]}} 和 \texttt{{[}:alpha:{]}}等，所以获取当前的区域设置也很重要

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# find a suitable coding for the current locale}
\FunctionTok{localeToCharset}\NormalTok{(}\AttributeTok{locale =} \FunctionTok{Sys.getlocale}\NormalTok{(}\StringTok{"LC\_CTYPE"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "UTF-8"     "ISO8859-1"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 软件版本信息}
\FunctionTok{extSoftVersion}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                              zlib 
##                                          "1.2.11" 
##                                             bzlib 
##                              "1.0.8, 13-Jul-2019" 
##                                                xz 
##                                           "5.2.4" 
##                                              PCRE 
##                                "10.39 2021-10-29" 
##                                               ICU 
##                                            "66.1" 
##                                               TRE 
##                         "TRE 0.8.0 R_fixes (BSD)" 
##                                             iconv 
##                                      "glibc 2.31" 
##                                          readline 
##                                             "8.0" 
##                                              BLAS 
## "/usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 区域及其编码信息}
\FunctionTok{l10n\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $MBCS
## [1] TRUE
## 
## $`UTF-8`
## [1] TRUE
## 
## $`Latin-1`
## [1] FALSE
## 
## $codeset
## [1] "UTF-8"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 表示数字、货币的细节}
\FunctionTok{Sys.localeconv}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     decimal_point     thousands_sep          grouping   int_curr_symbol 
##               "."                ""                ""            "USD " 
##   currency_symbol mon_decimal_point mon_thousands_sep      mon_grouping 
##               "$"               "."               ","        "\003\003" 
##     positive_sign     negative_sign   int_frac_digits       frac_digits 
##                ""               "-"               "2"               "2" 
##     p_cs_precedes    p_sep_by_space     n_cs_precedes    n_sep_by_space 
##               "1"               "0"               "1"               "0" 
##       p_sign_posn       n_sign_posn 
##               "1"               "1"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# PCRE 启用的配置选项}
\FunctionTok{pcre\_config}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              UTF-8 Unicode properties                JIT              stack 
##               TRUE               TRUE               TRUE              FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 比较全的字符信息}
\NormalTok{stringi}\SpecialCharTok{::}\FunctionTok{stri\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $Unicode.version
## [1] "13.0"
## 
## $ICU.version
## [1] "66.1"
## 
## $Locale
## $Locale$Language
## [1] "en"
## 
## $Locale$Country
## [1] "US"
## 
## $Locale$Variant
## [1] ""
## 
## $Locale$Name
## [1] "en_US"
## 
## 
## $Charset.internal
## [1] "UTF-8"  "UTF-16"
## 
## $Charset.native
## $Charset.native$Name.friendly
## [1] "UTF-8"
## 
## $Charset.native$Name.ICU
## [1] "UTF-8"
## 
## $Charset.native$Name.UTR22
## [1] NA
## 
## $Charset.native$Name.IBM
## [1] "ibm-1208"
## 
## $Charset.native$Name.WINDOWS
## [1] "windows-65001"
## 
## $Charset.native$Name.JAVA
## [1] "UTF-8"
## 
## $Charset.native$Name.IANA
## [1] "UTF-8"
## 
## $Charset.native$Name.MIME
## [1] "UTF-8"
## 
## $Charset.native$ASCII.subset
## [1] TRUE
## 
## $Charset.native$Unicode.1to1
## [1] NA
## 
## $Charset.native$CharSize.8bit
## [1] FALSE
## 
## $Charset.native$CharSize.min
## [1] 1
## 
## $Charset.native$CharSize.max
## [1] 3
## 
## 
## $ICU.system
## [1] TRUE
## 
## $ICU.UTF8
## [1] TRUE
\end{verbatim}

需要临时改变区域环境设置，配合特殊的画图和文本输出要求。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 获取当前默认的区域设置}
\FunctionTok{Sys.getlocale}\NormalTok{()}
\NormalTok{foo }\OtherTok{\textless{}{-}} \FunctionTok{Sys.getlocale}\NormalTok{()}
\CommentTok{\# 恢复默认的区域设置}
\FunctionTok{Sys.setlocale}\NormalTok{(}\StringTok{"LC\_ALL"}\NormalTok{, }\AttributeTok{locale =}\NormalTok{ foo)}
\end{Highlighting}
\end{Shaded}

\hypertarget{foundations}{%
\section{基本概念}\label{foundations}}

正则表达式的构造方式类似算术表达式，通过各种操作组合子（更小的）表达式，整个表达式匹配一个或多个字符\footnote{\texttt{useBytes\ =\ TRUE} 表示把字符看作字节。字符、字节和比特的关系是，一个字节 byte 八个比特 bit，一个英文字符 character 用一个字节表示，而一个中、日、韩文字符需要两个字节表示}。大多数字符，包括所有的字母和数字，是匹配自身的正则表达式。元字符 \texttt{.\ \textbackslash{}\ \textbar{}\ (\ )\ {[}\ \{\ \^{}\ \$\ *\ +\ ?} 需要转义才能表达其自身的含义，转义的方式是在元字符前面添加反斜杠，如要表达点号 \texttt{.} 需要使用 \texttt{\textbackslash{}.}。要注意，它们是否有特殊意义取决于所在的内容。

一个字符集 (character class) 是用一对中括号\texttt{{[}{]}}括起来的字符列表，用来匹配列表中的任意单个字符，除非列表中的第一个字符是 \texttt{\^{}}，它用来匹配不在这个列表中的字符。 \texttt{{[}0123456789{]}} 用来匹配任意单个数字，\texttt{{[}\^{}abc{]}} 用来匹配除字符 \texttt{a,b,c} 以外的任意字符。字符范围 (character ranges) 可以通过第一个和最后一个字符指定， 中间用连字符 (hyphen) 连接， 由于这种解释依赖于区域和具体实现，所以指定字符范围的使用方式最好避免。唯一可移植（便携，通用）的方式是作为字符集，在列表中列出所有的 ASCII 字母， \texttt{{[}ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz{]}}.

预定义的一些字符类，它们的解释依赖于当前的语言区域，下面是 POSIX locale 环境下的解释

\begin{itemize}
\item
  \texttt{{[}:alnum:{]}} 表示 \texttt{{[}:alpha:{]}} 和 \texttt{{[}:digit:{]}}，含义是 \texttt{{[}0-9A-Za-z{]}}，但是前者与区域和字符集无关，后者依赖于当前的区域设置和字符编码。要注意在这些字符集名 class names 中，中括号 \texttt{{[}{]}} 是符号名的一部分，是必须要包含的。在字符集中，大多数元字符失去它们特殊的意义。
\item
  \texttt{{[}:alpha:{]}} 表示 \texttt{{[}:lower:{]}} 和 \texttt{{[}:upper:{]}}
\item
  \texttt{{[}:blank:{]}} 表示 空格 space 制表符 tab
\item
  \texttt{{[}:cntrl:{]}} 表示控制符，在 ASCII 字符集里里，这些字符有八进制代码，从 000 到 037，和 177(DEL)。
\item
  \texttt{{[}:digit:{]}} 表示数字 0,1,2,3,4,5,6,7,8,9
\item
  \texttt{{[}:graph:{]}} 表示 \texttt{{[}:alnum:{]}} 和 \texttt{{[}:punct:{]}}.
\item
  \texttt{{[}:lower:{]}} 表示当前区域下的小写字母
\item
  \texttt{{[}:print:{]}} 表示可打印的字符 \texttt{{[}:alnum:{]}}, \texttt{{[}:punct:{]}} 和空格.
\item
  \texttt{{[}:punct:{]}} 表示标点字符

\begin{verbatim}
! " # $ % & ' ( ) * + , - . / : ; < = > ? @ [ \ ] ^ _ ` { | } ~`
\end{verbatim}
\item
  \texttt{{[}:space:{]}} 表示空格字符： 水平制表符 tab， 换行符 newline，垂直制表符 vertical tab，换页符 form feed，回车符 carriage return，空格符 space
\item
  \texttt{{[}:xdigit:{]}} 表示 16 进制数字 0 1 2 3 4 5 6 7 8 9 A B C D E F a b c d e f.
\end{itemize}

要包含字面的 \texttt{{]}} 就把它放在列表的开头，类似地，要包含字面 \texttt{\^{}}，除了开头可以放在任意位置。要包含字面 \texttt{-} 把它放在开头或者结尾。只有 \texttt{\^{}\ -\ \textbackslash{}\ {]}} 在字符集内是有特殊的含义

点号 \texttt{.} 匹配任意单个字符，\texttt{\textbackslash{}w} 匹配一个词 word 字符(是\texttt{{[}{[}:alnum:{]}\_{]}}的同义词，一个扩展) ，而 \texttt{\textbackslash{}W} 是 \texttt{\textbackslash{}w} 取反，意味着 \texttt{{[}\^{}{[}:alnum:{]}\_{]}}。 \texttt{\textbackslash{}d}, \texttt{\textbackslash{}s}, \texttt{\textbackslash{}D} 和 \texttt{\textbackslash{}S} 表示数字和空格类和它们的取反

脱字符 caret \texttt{\^{}} 和美元符号 \texttt{\$} 是元字符，分别匹配一行的开头和结尾。符号 \texttt{\textbackslash{}\textless{}} 和 \texttt{\textbackslash{}\textgreater{}} 分别匹配一个词的开头和结尾的空字符串。\texttt{\textbackslash{}b} 匹配词边缘的空字符串，\texttt{\textbackslash{}B} 匹配不在词边缘的空字符串。 词 word 的解释依赖于区域和实现。

\hypertarget{match}{%
\section{字符串匹配}\label{match}}

默认的匹配方式是贪婪的，会使用尽可能多的匹配次数，这个可以变为最小的匹配次数，通过在其之后添加 \texttt{?}，一个正则表达式可能跟着重复量词，下面的限定符都是限定在它前面的正则表达式

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:repetition-quantifiers} 贪婪匹配限定符}\tabularnewline
\toprule
符号 & 描述 \\
\midrule
\endfirsthead
\toprule
符号 & 描述 \\
\midrule
\endhead
\texttt{?} & 匹配至多 1 次 \\
\texttt{*} & 匹配 0 次或多次 \\
\texttt{+} & 匹配至少 1 次 \\
\texttt{\{n\}} & 匹配 n 次 \\
\texttt{\{n,\}} & 匹配至少 n 次 \\
\texttt{\{n,m\}} & 匹配至少 n 次，至多 m 次 \\
\bottomrule
\end{longtable}

\hypertarget{concatenation}{%
\section{级联表达式}\label{concatenation}}

\begin{quote}
Regular expressions may be concatenated; the resulting regular expression matches any string formed by concatenating the substrings that match the concatenated subexpressions.
\end{quote}

正则表达式可以是级联 concatenation 的，是不是在讲一个正则表达式里面嵌套一个正则表达式？

两个正则表达式可以通过中缀符号 \texttt{\textbar{}} 联合，用两个子表达式的任意一个去匹配字符串，例如 \texttt{abba\ \textbar{}\ cde} 要么匹配字符串 \texttt{abba} 要么匹配字符串 \texttt{cde}，要注意在字符集内，即 \texttt{abba\textbar{}cde}，二选一的匹配不凑效，因为中缀符 \texttt{\textbar{}} 有它的字面意思。

重复匹配 Repetition 的优先级高于级联，级联高于 \texttt{\textbar{}} 。 整个子表达式可以括号括起来覆盖这些优先级规则。

\hypertarget{backreference}{%
\section{反向引用}\label{backreference}}

反向引用 \texttt{\textbackslash{}N} 这里 N 可取 1,2,\ldots,9 匹配被之前第 N 个括起来的子表达式匹配的子字符串，例子见 COS 论坛 \url{https://d.cosx.org/d/420570/5}

\hypertarget{regexp-named-capture}{%
\section{命名捕捉}\label{regexp-named-capture}}

模式 \texttt{(?:...)} 包住的字符就是括号分组，但是不做反向查找。模式 \texttt{(?\textless{}=...)} 和 \texttt{(?\textless{}!...)} 都是反向查找，它们不允许跟限制符，在 \texttt{...} 也不允许出现 \texttt{\textbackslash{}C}。表 \ref{tab:group-lookaround} 展示四个反向引用

\begin{longtable}[]{@{}cc@{}}
\caption{\label{tab:group-lookaround} 环顾四周查找}\tabularnewline
\toprule
符号 & 描述 \\
\midrule
\endfirsthead
\toprule
符号 & 描述 \\
\midrule
\endhead
\texttt{?=} & 正向肯定查找 \\
\texttt{?!} & 正向否定查找 \\
\texttt{?\textless{}=} & 反向肯定查找 \\
\texttt{?\textless{}!} & 反向否定查找 \\
\bottomrule
\end{longtable}

函数 \texttt{regexpr} 和 \texttt{gregexpr} 支持命名捕捉 (named capture). 如果一个组被命名了，如 \texttt{(?\textless{}first\textgreater{}{[}A-Z{]}{[}a-z{]}+)} 那么，匹配的位置是按名字返回。

下面举个例子说明，从字符串向量 \texttt{notables} 中获得了三组匹配 \texttt{name.rex} 是一段正则表达式，描述的模式是人名

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# named capture}
\NormalTok{notables }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"  Ben Franklin and Jefferson Davis"}\NormalTok{,}
              \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{Millard Fillmore"}\NormalTok{)}
\CommentTok{\# name groups \textquotesingle{}first\textquotesingle{} and \textquotesingle{}last\textquotesingle{}}
\NormalTok{name.rex }\OtherTok{\textless{}{-}} \StringTok{"(?\textless{}first\textgreater{}[[:upper:]][[:lower:]]+) (?\textless{}last\textgreater{}[[:upper:]][[:lower:]]+)"}
\NormalTok{parsed }\OtherTok{\textless{}{-}} \FunctionTok{regexpr}\NormalTok{(name.rex, notables, }\AttributeTok{perl =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{parsed}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3 2
## attr(,"match.length")
## [1] 12 16
## attr(,"index.type")
## [1] "chars"
## attr(,"useBytes")
## [1] TRUE
## attr(,"capture.start")
##      first last
## [1,]     3    7
## [2,]     2   10
## attr(,"capture.length")
##      first last
## [1,]     3    8
## [2,]     7    8
## attr(,"capture.names")
## [1] "first" "last"
\end{verbatim}

\texttt{notables} 是一个长度为2的字符串向量，所以获得两组匹配，捕捉到匹配开始的位置 \texttt{capture.start} 和匹配的长度 \texttt{capture.length} 都是两组，按列来看，字符 B 出现在字符串 \texttt{Ben\ Franklin\ and\ Jefferson\ Davis} 的第三个位置，匹配的长度 Ben 是三个字符，长度是 3，如图 \ref{fig:name-capture} 所示，需要注意的是一定要设置 \texttt{perl\ =\ TRUE} 才能使用命名捕捉功能，函数 \texttt{sub} 不支持命名反向引用 Named backreferences

\begin{figure}

{\centering \includegraphics[width=4.51in]{screenshots/regexp-name-capture} 

}

\caption{命名捕捉}\label{fig:name-capture}
\end{figure}

Atomic grouping 原子分组, possessive qualifiers 占有限定 and conditional 条件 and recursive 递归等模式超出介绍的范围，不在此处详述，感兴趣的读者可参考，此外，插播一条漫画 \ref{fig:regex-xkcd}

\begin{figure}

{\centering \href{https://imgs.xkcd.com/comics/regular_expressions.png}{\includegraphics[width=2in]{screenshots/regexp-comics} }

}

\caption{正则表达式漫画}\label{fig:regex-xkcd}
\end{figure}

正则表达式的直观解释 \url{https://github.com/gadenbuie/regexplain}

\hypertarget{comment}{%
\section{表达式注释}\label{comment}}

The sequence \texttt{(?\#} marks the start of a comment which continues up to the next closing parenthesis. Nested parentheses are not permitted. The characters that make up a comment play no part at all in the pattern matching.

If the extended option is set, an unescaped \texttt{\#} character outside a character class introduces a comment that continues up to the next newline character in the pattern.

批量转换驼峰式命名

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{old\_name }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}[A{-}Z].*.Rmd$"}\NormalTok{)}
\NormalTok{new\_name }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"rmd"}\NormalTok{, }\StringTok{"Rmd"}\NormalTok{, }\FunctionTok{tolower}\NormalTok{(old\_name))}
\FunctionTok{file.rename}\NormalTok{(}\AttributeTok{from =}\NormalTok{ old\_name, }\AttributeTok{to =}\NormalTok{ new\_name)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{html\_lines }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(}\StringTok{"https://movie.douban.com/top250"}\NormalTok{)}
\NormalTok{doc }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(html\_lines, }\AttributeTok{collapse =} \StringTok{""}\NormalTok{)}

\NormalTok{title\_lines }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{\textquotesingle{}class="title"\textquotesingle{}}\NormalTok{, html\_lines, }\AttributeTok{value =}\NormalTok{ T)}
\NormalTok{titles }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{".*\textgreater{}(.*?)\textless{}.*"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, title\_lines, }\AttributeTok{perl =}\NormalTok{ T)}

\FunctionTok{gsub}\NormalTok{(}\StringTok{".*\textgreater{}(.*?)\textless{}.*"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, }\StringTok{\textquotesingle{}\textless{}span class="title"\textgreater{}肖生克的救赎\textless{}/span\textgreater{}\textquotesingle{}}\NormalTok{, }\AttributeTok{perl =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

解析术之 XPath

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(xml2)}
\NormalTok{dom }\OtherTok{=} \FunctionTok{read\_html}\NormalTok{(doc)}
\NormalTok{title\_nodes }\OtherTok{=} \FunctionTok{xml\_find\_all}\NormalTok{(dom, }\StringTok{\textquotesingle{}.//span[@class="title"]\textquotesingle{}}\NormalTok{)}
\FunctionTok{xml\_text}\NormalTok{(title\_nodes)}
\end{Highlighting}
\end{Shaded}

解析术之 CSS Selector

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rvest)}
\FunctionTok{read\_html}\NormalTok{(doc) }\SpecialCharTok{\%\textgreater{}\%}
\FunctionTok{html\_nodes}\NormalTok{(}\StringTok{\textquotesingle{}.title\textquotesingle{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# class="title"的标签}
\FunctionTok{html\_text}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{chap-data-manipulation}{%
\chapter{数据操作}\label{chap-data-manipulation}}

data.table 诞生于2006年4月15日（以在 CRAN 上发布的第一个版本时间为准），是基于 \texttt{data.frame} 的扩展和 Base R 的数据操作连贯一些，dplyr 诞生于2014年1月29日，号称数据操作的语法，其实二者套路一致，都是借用 SQL 语言的设计，实现方式不同罢了，前者主要依靠 C 语言完成底层数据操作，总代码量1.29M，C 占65.6\%，后者主要依靠 C++ 语言完成底层数据操作，总代码量1.2M，C++ 占34.4\%，上层的高级操作接口都是 R 语言。像这样的大神在写代码，码力应该差不多，编程语言会对数据操作的性能有比较大的影响，我想这也是为什么在很多场合下 data.table 霸榜！

关于 data.table 和 dplyr 的对比，参看爆栈网的帖子 \url{https://stackoverflow.com/questions/21435339}

\begin{rmdtip}{提示}
学习 data.table 包最快的方式就是在 R 控制台运行 \texttt{example(data.table)} 并研究其输出。

\end{rmdtip}

\href{https://github.com/Rdatatable/data.table}{data.table} 大大加强了 \href{https://github.com/wch/r-source}{Base R} 提供的数据操作，\href{https://github.com/nathaneastwood/poorman}{poorman} 提供最常用的数据操作，但是不依赖 dplyr，\href{https://github.com/fstpackage/fst}{fst}，\href{https://github.com/apache/arrow/tree/master/r}{arrow} 和 \href{https://github.com/wesm/feather/tree/master/R}{feather} 提供更加高效的数据读写性能。

\href{https://github.com/SebKrantz/collapse}{collapse} 提供一系列高级和快速的数据操作，支持 Base R、dplyr、tibble、data.table、plm 和 sf 数据框结构类型。关键的特点有：1. 高级的统计编程，提供一系列统计函数支持在向量、矩阵和数据框上做分组和带权计算。\href{https://github.com/SebKrantz/fastverse}{fastverse} 提供丰富的数据操作和统计计算功能，意图打造一个 tidyverse 替代品。

更多参考材料见\href{https://atrebas.github.io/post/2019-03-03-datatable-dplyr/}{A data.table and dplyr tour}， \href{https://raw.githack.com/uo-ec510-2020-spring/lectures/master/05-datatable/05-datatable.html}{Big Data in Economics: Data cleaning and wrangling} 和 \href{https://s3.amazonaws.com/assets.datacamp.com/img/blog/data+table+cheat+sheet.pdf}{DataCamp's data.table cheatsheet}，关于采用 Base R 还是 tidyverse 做数据操作的 \href{https://d.cosx.org/d/420697}{讨论}，数据操作的动画展示参考 \url{https://github.com/gadenbuie/tidyexplain}。

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{diagrams/tidyverse-vs-base-r} 

}

\caption{Tidyverse 和 Base R 的关系}\label{fig:tidyverse-vs-base-r}
\end{figure}

什么是 Base R? Base R 指的是 R 语言/软件的核心组件，由 R Core Team 维护

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Pkgs }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(}\FunctionTok{R.home}\NormalTok{(}\StringTok{"library"}\NormalTok{)), }\ControlFlowTok{function}\NormalTok{(x)}
  \FunctionTok{packageDescription}\NormalTok{(}\AttributeTok{pkg =}\NormalTok{ x, }\AttributeTok{fields =} \StringTok{"Priority"}\NormalTok{))}
\FunctionTok{names}\NormalTok{(Pkgs[Pkgs }\SpecialCharTok{==} \StringTok{"base"} \SpecialCharTok{\&} \SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(Pkgs)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "base"      "compiler"  "datasets"  "graphics"  "grDevices" "grid"     
##  [7] "methods"   "parallel"  "splines"   "stats"     "stats4"    "tcltk"    
## [13] "tools"     "utils"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(Pkgs[Pkgs }\SpecialCharTok{==} \StringTok{"recommended"} \SpecialCharTok{\&} \SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(Pkgs)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "boot"       "class"      "cluster"    "codetools"  "foreign"   
##  [6] "KernSmooth" "lattice"    "MASS"       "Matrix"     "mgcv"      
## [11] "nlme"       "nnet"       "rpart"      "spatial"    "survival"
\end{verbatim}

数据变形，分组统计聚合等，用以作为模型的输入，绘图的对象，操作的数据对象是数据框(data.frame)类型的，而且如果没有特别说明，文中出现的数据集都是 Base R 内置的，第三方 R 包或者来源于网上的数据集都会加以说明。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 给定一个/些 R 包名，返回该 R 包存放的位置}
\FunctionTok{sapply}\NormalTok{(}\FunctionTok{.libPaths}\NormalTok{(), }\ControlFlowTok{function}\NormalTok{(pkg\_path) \{}
  \FunctionTok{c}\NormalTok{(}\StringTok{"survival"}\NormalTok{, }\StringTok{"ggplot2"}\NormalTok{) }\SpecialCharTok{\%in\%} \FunctionTok{.packages}\NormalTok{(T, }\AttributeTok{lib.loc =}\NormalTok{ pkg\_path)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      /home/runner/work/_temp/Library /opt/R/4.2.0/lib/R/library
## [1,]                           FALSE                       TRUE
## [2,]                            TRUE                      FALSE
\end{verbatim}

\hypertarget{dm-view}{%
\section{查看数据}\label{dm-view}}

查看属性

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    150 obs. of  5 variables:
##  $ Sepal.Length: num  5.1 4.9 4.7 4.6 5 5.4 4.6 5 4.4 4.9 ...
##  $ Sepal.Width : num  3.5 3 3.2 3.1 3.6 3.9 3.4 3.4 2.9 3.1 ...
##  $ Petal.Length: num  1.4 1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.4 1.5 ...
##  $ Petal.Width : num  0.2 0.2 0.2 0.2 0.2 0.4 0.3 0.2 0.2 0.1 ...
##  $ Species     : Factor w/ 3 levels "setosa","versicolor",..: 1 1 1 1 1 1 1 1 1 1 ...
\end{verbatim}

查看部分数据集

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(iris, }\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tail}\NormalTok{(iris, }\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 146          6.7         3.0          5.2         2.3 virginica
## 147          6.3         2.5          5.0         1.9 virginica
## 148          6.5         3.0          5.2         2.0 virginica
## 149          6.2         3.4          5.4         2.3 virginica
## 150          5.9         3.0          5.1         1.8 virginica
\end{verbatim}

查看文件前（后）5行

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head} \AttributeTok{{-}n}\NormalTok{ 5 test.csv}
\FunctionTok{tail} \AttributeTok{{-}n}\NormalTok{ 5 test.csv}
\end{Highlighting}
\end{Shaded}

对象的类型，存储方式

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mode}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "list"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{typeof}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "list"
\end{verbatim}

查看对象在R环境中所占空间的大小

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{object.size}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 7256 bytes
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{object.size}\NormalTok{(letters)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 1712 bytes
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{object.size}\NormalTok{(ls)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 89880 bytes
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format}\NormalTok{(}\FunctionTok{object.size}\NormalTok{(library), }\AttributeTok{units =} \StringTok{"auto"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1.8 Mb"
\end{verbatim}

\hypertarget{dm-subset}{%
\section{提取子集}\label{dm-subset}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(x, subset, select, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{, ...)}
\end{Highlighting}
\end{Shaded}

参数 \texttt{subset}代表行操作，\texttt{select} 代表列操作，函数 \texttt{subset} 从数据框中提取部分数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(iris, }\AttributeTok{subset =}\NormalTok{ Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{7.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 106          7.6         3.0          6.6         2.1 virginica
## 118          7.7         3.8          6.7         2.2 virginica
## 119          7.7         2.6          6.9         2.3 virginica
## 123          7.7         2.8          6.7         2.0 virginica
## 132          7.9         3.8          6.4         2.0 virginica
## 136          7.7         3.0          6.1         2.3 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# summary(iris$Sepal.Length)  mean(iris$Sepal.Length)}
\CommentTok{\# 且的逻辑}
\CommentTok{\# subset(iris, Species == "virginica" \& Sepal.Length \textgreater{} 5.8)}
\FunctionTok{subset}\NormalTok{(iris, Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}
\NormalTok{  Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(Sepal.Length))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 102          5.8         2.7          5.1         1.9 virginica
## 115          5.8         2.8          5.1         2.4 virginica
## 143          5.8         2.7          5.1         1.9 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 在行的子集范围内}
\FunctionTok{subset}\NormalTok{(iris, Species }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"virginica"}\NormalTok{, }\StringTok{"versicolor"}\NormalTok{) }\SpecialCharTok{\&}
\NormalTok{  Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(Sepal.Length))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 68           5.8         2.7          4.1         1.0 versicolor
## 83           5.8         2.7          3.9         1.2 versicolor
## 93           5.8         2.6          4.0         1.2 versicolor
## 102          5.8         2.7          5.1         1.9  virginica
## 115          5.8         2.8          5.1         2.4  virginica
## 143          5.8         2.7          5.1         1.9  virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 在列的子集内 先选中列}
\FunctionTok{subset}\NormalTok{(iris, Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(Sepal.Length),}
  \AttributeTok{select =} \FunctionTok{c}\NormalTok{(}\StringTok{"Sepal.Length"}\NormalTok{, }\StringTok{"Species"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length    Species
## 15           5.8     setosa
## 68           5.8 versicolor
## 83           5.8 versicolor
## 93           5.8 versicolor
## 102          5.8  virginica
## 115          5.8  virginica
## 143          5.8  virginica
\end{verbatim}

高级操作：加入正则表达式筛选

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# sometimes requiring a logical \textquotesingle{}subset\textquotesingle{} argument is a nuisance}
\NormalTok{nm }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(state.x77)}
\NormalTok{start\_with\_M }\OtherTok{\textless{}{-}}\NormalTok{ nm }\SpecialCharTok{\%in\%} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}M"}\NormalTok{, nm, }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{subset}\NormalTok{(state.x77, start\_with\_M, Illiteracy}\SpecialCharTok{:}\NormalTok{Murder)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 简化}
\FunctionTok{subset}\NormalTok{(state.x77, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}M"}\NormalTok{, }\FunctionTok{rownames}\NormalTok{(state.x77)), }\AttributeTok{select =}\NormalTok{ Illiteracy}\SpecialCharTok{:}\NormalTok{Murder)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 继续简化}
\FunctionTok{subset}\NormalTok{(state.x77, }\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}M"}\NormalTok{, }\FunctionTok{rownames}\NormalTok{(state.x77)), Illiteracy}\SpecialCharTok{:}\NormalTok{Murder)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0
\end{verbatim}

\begin{rmdnote}{注意}
警告：这是一个为了交互使用打造的便捷函数。对于编程，最好使用标准的子集函数，如 \texttt{{[}}，特别地，参数 \texttt{subset} 的非标准计算(non-standard evaluation)\footnote{Thomas Lumley (2003) Standard nonstandard evaluation rules. \url{https://developer.r-project.org/nonstandard-eval.pdf}} 可能带来意想不到的后果。

\end{rmdnote}

使用索引 \texttt{{[}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}\NormalTok{ iris}\SpecialCharTok{$}\NormalTok{Sepal.Length }\SpecialCharTok{==} \FloatTok{5.8}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 102          5.8         2.7          5.1         1.9 virginica
## 115          5.8         2.8          5.1         2.4 virginica
## 143          5.8         2.7          5.1         1.9 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}
\NormalTok{  iris}\SpecialCharTok{$}\NormalTok{Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 102          5.8         2.7          5.1         1.9 virginica
## 115          5.8         2.8          5.1         2.4 virginica
## 143          5.8         2.7          5.1         1.9 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[}
\NormalTok{  iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"virginica"} \SpecialCharTok{\&}
\NormalTok{    iris}\SpecialCharTok{$}\NormalTok{Sepal.Length }\SpecialCharTok{==} \FunctionTok{median}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length),}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sepal.Length"}\NormalTok{, }\StringTok{"Species"}\NormalTok{)}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length   Species
## 102          5.8 virginica
## 115          5.8 virginica
## 143          5.8 virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ iris}\SpecialCharTok{$}\NormalTok{Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{, }\FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris))]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 15          5.8         4.0
## 16          5.7         4.4
## 19          5.7         3.8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(iris,}
  \AttributeTok{subset =}\NormalTok{ Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{,}
  \AttributeTok{select =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 15          5.8         4.0
## 16          5.7         4.4
## 19          5.7         3.8
\end{verbatim}

选择操作是针对数据框的列（变量/特征/字段）

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{mtcars}\SpecialCharTok{$}\NormalTok{cars }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(mtcars)}
\NormalTok{mtcars\_df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, .(mpg, disp)] }\SpecialCharTok{|}\ErrorTok{\textgreater{}} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg disp
## 1: 21.0  160
## 2: 21.0  160
## 3: 22.8  108
## 4: 21.4  258
## 5: 18.7  360
## 6: 18.1  225
\end{verbatim}

\begin{rmdtip}{dplyr 版}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, disp) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg disp
## Mazda RX4         21.0  160
## Mazda RX4 Wag     21.0  160
## Datsun 710        22.8  108
## Hornet 4 Drive    21.4  258
## Hornet Sportabout 18.7  360
## Valiant           18.1  225
\end{verbatim}

\end{rmdtip}

\hypertarget{dm-reshape}{%
\section{数据重塑}\label{dm-reshape}}

重复测量数据的变形 Reshape Grouped Data，将宽格式 wide 的数据框变长格式 long的，反之也行。reshape 还支持正则表达式

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(Indometh)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   66 obs. of  3 variables:
##  $ Subject: Ord.factor w/ 6 levels "1"<"4"<"2"<"5"<..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ time   : num  0.25 0.5 0.75 1 1.25 2 3 4 5 6 ...
##  $ conc   : num  1.5 0.94 0.78 0.48 0.37 0.19 0.12 0.11 0.08 0.07 ...
##  - attr(*, "formula")=Class 'formula'  language conc ~ time | Subject
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Time since drug administration"
##   ..$ y: chr "Indomethacin concentration"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(hr)"
##   ..$ y: chr "(mcg/ml)"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(Indometh)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  Subject      time            conc       
##  1:11    Min.   :0.250   Min.   :0.0500  
##  4:11    1st Qu.:0.750   1st Qu.:0.1100  
##  2:11    Median :2.000   Median :0.3400  
##  5:11    Mean   :2.886   Mean   :0.5918  
##  6:11    3rd Qu.:5.000   3rd Qu.:0.8325  
##  3:11    Max.   :8.000   Max.   :2.7200
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 长的变宽}
\NormalTok{wide }\OtherTok{\textless{}{-}} \FunctionTok{reshape}\NormalTok{(Indometh,}
  \AttributeTok{v.names =} \StringTok{"conc"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"Subject"}\NormalTok{,}
  \AttributeTok{timevar =} \StringTok{"time"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}
\NormalTok{)}
\NormalTok{wide[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Subject conc.0.25 conc.0.5 conc.0.75 conc.1 conc.1.25
## 1        1      1.50     0.94      0.78   0.48      0.37
## 12       2      2.03     1.63      0.71   0.70      0.64
## 23       3      2.72     1.49      1.16   0.80      0.80
## 34       4      1.85     1.39      1.02   0.89      0.59
## 45       5      2.05     1.04      0.81   0.39      0.30
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 宽的变长}
\FunctionTok{reshape}\NormalTok{(wide, }\AttributeTok{direction =} \StringTok{"long"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Subject time conc
## 1.0.25       1 0.25 1.50
## 2.0.25       2 0.25 2.03
## 3.0.25       3 0.25 2.72
## 4.0.25       4 0.25 1.85
## 5.0.25       5 0.25 2.05
....
\end{verbatim}

宽的格式变成长的格式 \url{https://stackoverflow.com/questions/2185252} 或者长的格式变成宽的格式 \url{https://stackoverflow.com/questions/5890584/}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{45}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{name =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Orange"}\NormalTok{, }\StringTok{"Apple"}\NormalTok{), }\AttributeTok{each=}\DecValTok{4}\NormalTok{),}
    \AttributeTok{numbers =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{),}
    \AttributeTok{value =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{8}\NormalTok{))}
\NormalTok{dat}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     name numbers      value
## 1 Orange       1  0.3407997
## 2 Orange       2 -0.7033403
## 3 Orange       3 -0.3795377
## 4 Orange       4 -0.7460474
## 5  Apple       1 -0.8981073
## 6  Apple       2 -0.3347941
## 7  Apple       3 -0.5013782
## 8  Apple       4 -0.1745357
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(dat, }\AttributeTok{idvar =} \StringTok{"name"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"numbers"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     name    value.1    value.2    value.3    value.4
## 1 Orange  0.3407997 -0.7033403 -0.3795377 -0.7460474
## 5  Apple -0.8981073 -0.3347941 -0.5013782 -0.1745357
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# times need not be numeric}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{id =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)),}
                 \AttributeTok{visit =} \FunctionTok{I}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Before"}\NormalTok{,}\StringTok{"After"}\NormalTok{), }\DecValTok{4}\NormalTok{)),}
                 \AttributeTok{x =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{y =} \FunctionTok{runif}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   id  visit          x          y
## 1  1 Before  1.8090374 0.89106978
## 2  1  After -0.2301050 0.06920426
## 3  2 Before -1.1304182 0.94623103
## 4  2  After  0.2159889 0.74850150
## 5  3 Before  1.8090374 0.89106978
## 6  3  After -0.2301050 0.06920426
## 7  4 Before -1.1304182 0.94623103
## 8  4  After  0.2159889 0.74850150
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(df, }\AttributeTok{timevar =} \StringTok{"visit"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"id"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   id  x.Before  y.Before    x.After    y.After
## 1  1  1.809037 0.8910698 -0.2301050 0.06920426
## 3  2 -1.130418 0.9462310  0.2159889 0.74850150
## 5  3  1.809037 0.8910698 -0.2301050 0.06920426
## 7  4 -1.130418 0.9462310  0.2159889 0.74850150
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# warns that y is really varying}
\FunctionTok{reshape}\NormalTok{(df, }\AttributeTok{timevar =} \StringTok{"visit"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"id"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{v.names =} \StringTok{"x"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in reshapeWide(data, idvar = idvar, timevar = timevar, varying =
## varying, : some constant variables (y) are really varying
\end{verbatim}

\begin{verbatim}
##   id         y  x.Before    x.After
## 1  1 0.8910698  1.809037 -0.2301050
## 3  2 0.9462310 -1.130418  0.2159889
## 5  3 0.8910698  1.809037 -0.2301050
## 7  4 0.9462310 -1.130418  0.2159889
\end{verbatim}

更加复杂的例子， gambia 数据集，重塑的效果是使得个体水平的长格式变为村庄水平的宽格式

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data(gambia, package = "geoR")}
\CommentTok{\# 在线下载数据集}
\NormalTok{gambia }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}
  \AttributeTok{file =}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"http://www.leg.ufpr.br/lib/exe/fetch.php"}\NormalTok{,}
      \StringTok{"pessoais:paulojus:mbgbook:datasets:gambia.txt"}\NormalTok{,}
      \AttributeTok{sep =} \StringTok{"/"}
\NormalTok{    ), }\AttributeTok{header =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{head}\NormalTok{(gambia)}
\CommentTok{\# Building a "village{-}level" data frame}
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"x"}\NormalTok{, gambia[, }\DecValTok{1}\NormalTok{], }\StringTok{"y"}\NormalTok{, gambia[, }\DecValTok{2}\NormalTok{], }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{village }\OtherTok{\textless{}{-}}\NormalTok{ gambia[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(ind), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\DecValTok{7}\SpecialCharTok{:}\DecValTok{8}\NormalTok{)]}
\NormalTok{village}\SpecialCharTok{$}\NormalTok{prev }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(}\FunctionTok{tapply}\NormalTok{(gambia}\SpecialCharTok{$}\NormalTok{pos, ind, mean))}
\FunctionTok{head}\NormalTok{(village)}
\end{Highlighting}
\end{Shaded}

\hypertarget{dm-transform}{%
\section{数据转换}\label{dm-transform}}

transform 对数据框中的某些列做计算，取对数，将计算的结果单存一列加到数据框中

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{transform}\NormalTok{(iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, ], }\AttributeTok{scale.sl =}\NormalTok{ (}\FunctionTok{max}\NormalTok{(Sepal.Length) }\SpecialCharTok{{-}}\NormalTok{ Sepal.Length) }\SpecialCharTok{/}\NormalTok{ (}\FunctionTok{max}\NormalTok{(Sepal.Length) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(Sepal.Length)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species scale.sl
## 1          5.1         3.5          1.4         0.2  setosa    0.375
## 2          4.9         3.0          1.4         0.2  setosa    0.625
## 3          4.7         3.2          1.3         0.2  setosa    0.875
## 4          4.6         3.1          1.5         0.2  setosa    1.000
## 5          5.0         3.6          1.4         0.2  setosa    0.500
## 6          5.4         3.9          1.7         0.4  setosa    0.000
\end{verbatim}

验证一下 \texttt{scale.sl} 变量的第一个值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\FunctionTok{max}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length) }\SpecialCharTok{{-}} \FloatTok{5.1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\FunctionTok{max}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.7777778
\end{verbatim}

\begin{rmdnote}{注意}
Warning: This is a convenience function intended for use interactively. For programming it is better to use the standard subsetting arithmetic functions, and in particular the non-standard evaluation of argument \texttt{transform} can have unanticipated consequences.

\end{rmdnote}

\hypertarget{dm-order}{%
\section{按列排序}\label{dm-order}}

在数据框内，根据(order)某一列或几列对行进行排序(sort)，根据鸢尾花(iris)的类别(Species)对萼片(sepal)的长度进行排序，其余的列随之变化

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 先对花瓣的宽度排序，再对花瓣的长度排序}
\FunctionTok{head}\NormalTok{(iris[}\FunctionTok{order}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species, iris}\SpecialCharTok{$}\NormalTok{Petal.Width, iris}\SpecialCharTok{$}\NormalTok{Petal.Length), ]) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 14          4.3         3.0          1.1         0.1  setosa
## 13          4.8         3.0          1.4         0.1  setosa
## 38          4.9         3.6          1.4         0.1  setosa
## 10          4.9         3.1          1.5         0.1  setosa
## 33          5.2         4.1          1.5         0.1  setosa
## 23          4.6         3.6          1.0         0.2  setosa
\end{verbatim}

sort/ordered 排序， 默认是升序

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dd }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{b =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Hi"}\NormalTok{, }\StringTok{"Med"}\NormalTok{, }\StringTok{"Hi"}\NormalTok{, }\StringTok{"Low"}\NormalTok{),}
    \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Low"}\NormalTok{, }\StringTok{"Med"}\NormalTok{, }\StringTok{"Hi"}\NormalTok{), }\AttributeTok{ordered =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"D"}\NormalTok{, }\StringTok{"A"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{8}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{9}\NormalTok{),}
  \AttributeTok{z =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{)}
\FunctionTok{str}\NormalTok{(dd)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    4 obs. of  4 variables:
##  $ b: Ord.factor w/ 3 levels "Low"<"Med"<"Hi": 3 2 3 1
##  $ x: chr  "A" "D" "A" "C"
##  $ y: num  8 3 9 9
##  $ z: num  1 1 1 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dd[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{dd[,}\DecValTok{4}\NormalTok{], dd[,}\DecValTok{1}\NormalTok{]), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     b x y z
## 4 Low C 9 2
## 2 Med D 3 1
## 1  Hi A 8 1
## 3  Hi A 9 1
\end{verbatim}

根据变量 z

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dd[}\FunctionTok{order}\NormalTok{(dd}\SpecialCharTok{$}\NormalTok{z, dd}\SpecialCharTok{$}\NormalTok{b), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     b x y z
## 2 Med D 3 1
## 1  Hi A 8 1
## 3  Hi A 9 1
## 4 Low C 9 2
\end{verbatim}

\hypertarget{dm-split}{%
\section{数据拆分}\label{dm-split}}

数据拆分通常是按找某一个分类变量分组，分完组就是计算，计算完就把结果按照原来的分组方式合并

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Notice that assignment form is not used since a variable is being added}
\NormalTok{g }\OtherTok{\textless{}{-}}\NormalTok{ airquality}\SpecialCharTok{$}\NormalTok{Month}
\NormalTok{l }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(airquality, g) }\CommentTok{\# 分组}
\NormalTok{l }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(l, transform, }\AttributeTok{Oz.Z =} \FunctionTok{scale}\NormalTok{(Ozone)) }\CommentTok{\# 计算：按月对 Ozone 标准化}
\NormalTok{aq2 }\OtherTok{\textless{}{-}} \FunctionTok{unsplit}\NormalTok{(l, g) }\CommentTok{\# 合并}
\FunctionTok{head}\NormalTok{(aq2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day       Oz.Z
## 1    41     190  7.4   67     5   1  0.7822293
## 2    36     118  8.0   72     5   2  0.5572518
## 3    12     149 12.6   74     5   3 -0.5226399
## 4    18     313 11.5   62     5   4 -0.2526670
## 5    NA      NA 14.3   56     5   5         NA
## 6    28      NA 14.9   66     5   6  0.1972879
\end{verbatim}

tapply 自带分组的功能，按月份 Month 对 Ozone 中心标准化，其返回一个列表

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(airquality, }\FunctionTok{tapply}\NormalTok{(Ozone, Month, scale))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $`5`
##              [,1]
##  [1,]  0.78222929
##  [2,]  0.55725184
##  [3,] -0.52263993
##  [4,] -0.25266698
##  [5,]          NA
##  [6,]  0.19728792
##  [7,] -0.02768953
##  [8,] -0.20767149
....
\end{verbatim}

上面的过程等价于

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{do.call}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, }\FunctionTok{lapply}\NormalTok{(}\FunctionTok{split}\NormalTok{(airquality, airquality}\SpecialCharTok{$}\NormalTok{Month), transform, }\AttributeTok{Oz.Z =} \FunctionTok{scale}\NormalTok{(Ozone)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Ozone Solar.R Wind Temp Month Day         Oz.Z
## 5.1      41     190  7.4   67     5   1  0.782229293
## 5.2      36     118  8.0   72     5   2  0.557251841
## 5.3      12     149 12.6   74     5   3 -0.522639926
## 5.4      18     313 11.5   62     5   4 -0.252666984
## 5.5      NA      NA 14.3   56     5   5           NA
## 5.6      28      NA 14.9   66     5   6  0.197287919
## 5.7      23     299  8.6   65     5   7 -0.027689532
## 5.8      19      99 13.8   59     5   8 -0.207671494
## 5.9       8      19 20.1   61     5   9 -0.702621887
....
\end{verbatim}

由于上面对 Ozone 正态标准化，所以标准化后的 \texttt{Oz.z} 再按月分组计算方差自然每个月都是 1，而均值都是 0。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(aq2, }\FunctionTok{tapply}\NormalTok{(Oz.Z, Month, sd, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 5 6 7 8 9 
## 1 1 1 1 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(aq2, }\FunctionTok{tapply}\NormalTok{(Oz.Z, Month, mean, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             5             6             7             8             9 
## -4.240273e-17  1.052760e-16  5.841432e-17  5.898060e-17  2.571709e-17
\end{verbatim}

\begin{quote}
循着这个思路，我们可以用 tapply 实现分组计算，上面函数 \texttt{sd} 和 \texttt{mean} 完全可以用自定义的更加复杂的函数替代
\end{quote}

\texttt{cut} 函数可以将连续型变量划分为分类变量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{Z }\OtherTok{\textless{}{-}}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\FunctionTok{cut}\NormalTok{(Z, }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{6}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] (0,1]   (-1,0]  (-2,-1] (0,1]   (-2,-1] (0,1]   (-1,0]  (0,1]   (-2,-1]
## [10] (-1,0] 
## 12 Levels: (-6,-5] (-5,-4] (-4,-3] (-3,-2] (-2,-1] (-1,0] (0,1] (1,2] ... (5,6]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# labels = FALSE 返回每个数所落的区间位置}
\FunctionTok{cut}\NormalTok{(Z, }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{6}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\AttributeTok{labels =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 7 6 5 7 5 7 6 7 5 6
\end{verbatim}

我们还可以指定参数 \texttt{dig.lab} 设置分组的精度，\texttt{ordered} 将分组变量看作是有序的，\texttt{breaks} 传递单个数时，表示分组数，而不是断点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cut}\NormalTok{(Z, }\AttributeTok{breaks =} \DecValTok{3}\NormalTok{, }\AttributeTok{dig.lab =} \DecValTok{4}\NormalTok{, }\AttributeTok{ordered =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] (0.06396,0.9186]  (-0.7881,0.06396] (-1.643,-0.7881]  (0.06396,0.9186] 
##  [5] (-1.643,-0.7881]  (0.06396,0.9186]  (-0.7881,0.06396] (0.06396,0.9186] 
##  [9] (-1.643,-0.7881]  (-0.7881,0.06396]
## Levels: (-1.643,-0.7881] < (-0.7881,0.06396] < (0.06396,0.9186]
\end{verbatim}

此时，统计每组的频数，如图 \ref{fig:cut}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 条形图}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{cut}\NormalTok{(Z, }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{6}\SpecialCharTok{:}\DecValTok{6}\NormalTok{))}
\CommentTok{\# 直方图}
\FunctionTok{hist}\NormalTok{(Z, }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{6}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[条形图\label{fig:cut-1}]{\includegraphics[width=0.45\linewidth]{data-manipulation_files/figure-latex/cut-1} }\subfloat[直方图\label{fig:cut-2}]{\includegraphics[width=0.45\linewidth]{data-manipulation_files/figure-latex/cut-2} }

}

\caption{连续型变量分组统计}\label{fig:cut}
\end{figure}

在指定分组数的情况下，我们还想获取分组的断点

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{labs }\OtherTok{\textless{}{-}} \FunctionTok{levels}\NormalTok{(}\FunctionTok{cut}\NormalTok{(Z, }\DecValTok{3}\NormalTok{))}
\NormalTok{labs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "(-1.64,-0.788]" "(-0.788,0.064]" "(0.064,0.919]"
\end{verbatim}

用正则表达式抽取断点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cbind}\NormalTok{(}
  \AttributeTok{lower =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{((.+),.*"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, labs)),}
  \AttributeTok{upper =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{sub}\NormalTok{(}\StringTok{"[\^{},]*,([\^{}]]*)}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, labs))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       lower  upper
## [1,] -1.640 -0.788
## [2,] -0.788  0.064
## [3,]  0.064  0.919
\end{verbatim}

更多相关函数可以参考 \texttt{findInterval} 和 \texttt{embed}

tabulate 和 table 有所不同，它表示排列，由 0 和 1 组成的一个长度为 5 数组，其中 1 有 3 个，则排列组合为

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{combn}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{, tabulate, }\AttributeTok{nbins =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,]    1    1    1    1    1    1    0    0    0     0
## [2,]    1    1    1    0    0    0    1    1    1     0
## [3,]    1    0    0    1    1    0    1    1    0     1
## [4,]    0    1    0    1    0    1    1    0    1     1
## [5,]    0    0    1    0    1    1    0    1    1     1
\end{verbatim}

\hypertarget{dm-merge}{%
\section{数据合并}\label{dm-merge}}

merge 合并两个数据框

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{authors }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \DocumentationTok{\#\# I(*) : use character columns of names to get sensible sort order}
  \AttributeTok{surname =} \FunctionTok{I}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Tukey"}\NormalTok{, }\StringTok{"Venables"}\NormalTok{, }\StringTok{"Tierney"}\NormalTok{, }\StringTok{"Ripley"}\NormalTok{, }\StringTok{"McNeil"}\NormalTok{)),}
  \AttributeTok{nationality =} \FunctionTok{c}\NormalTok{(}\StringTok{"US"}\NormalTok{, }\StringTok{"Australia"}\NormalTok{, }\StringTok{"US"}\NormalTok{, }\StringTok{"UK"}\NormalTok{, }\StringTok{"Australia"}\NormalTok{),}
  \AttributeTok{deceased =} \FunctionTok{c}\NormalTok{(}\StringTok{"yes"}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\StringTok{"no"}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\NormalTok{)}
\NormalTok{authorN }\OtherTok{\textless{}{-}} \FunctionTok{within}\NormalTok{(authors, \{}
\NormalTok{  name }\OtherTok{\textless{}{-}}\NormalTok{ surname}
  \FunctionTok{rm}\NormalTok{(surname)}
\NormalTok{\})}
\NormalTok{books }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{name =} \FunctionTok{I}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \StringTok{"Tukey"}\NormalTok{, }\StringTok{"Venables"}\NormalTok{, }\StringTok{"Tierney"}\NormalTok{,}
    \StringTok{"Ripley"}\NormalTok{, }\StringTok{"Ripley"}\NormalTok{, }\StringTok{"McNeil"}\NormalTok{, }\StringTok{"R Core"}
\NormalTok{  )),}
  \AttributeTok{title =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Exploratory Data Analysis"}\NormalTok{,}
    \StringTok{"Modern Applied Statistics ..."}\NormalTok{,}
    \StringTok{"LISP{-}STAT"}\NormalTok{,}
    \StringTok{"Spatial Statistics"}\NormalTok{, }\StringTok{"Stochastic Simulation"}\NormalTok{,}
    \StringTok{"Interactive Data Analysis"}\NormalTok{,}
    \StringTok{"An Introduction to R"}
\NormalTok{  ),}
  \AttributeTok{other.author =} \FunctionTok{c}\NormalTok{(}
    \ConstantTok{NA}\NormalTok{, }\StringTok{"Ripley"}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{,}
    \StringTok{"Venables \& Smith"}
\NormalTok{  )}
\NormalTok{)}

\NormalTok{authors}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    surname nationality deceased
## 1    Tukey          US      yes
## 2 Venables   Australia       no
## 3  Tierney          US       no
## 4   Ripley          UK       no
## 5   McNeil   Australia       no
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{authorN}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   nationality deceased     name
## 1          US      yes    Tukey
## 2   Australia       no Venables
## 3          US       no  Tierney
## 4          UK       no   Ripley
## 5   Australia       no   McNeil
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{books}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       name                         title     other.author
## 1    Tukey     Exploratory Data Analysis             <NA>
## 2 Venables Modern Applied Statistics ...           Ripley
## 3  Tierney                     LISP-STAT             <NA>
## 4   Ripley            Spatial Statistics             <NA>
## 5   Ripley         Stochastic Simulation             <NA>
## 6   McNeil     Interactive Data Analysis             <NA>
## 7   R Core          An Introduction to R Venables & Smith
\end{verbatim}

默认找到同名的列，然后是同名的行合并，多余的没有匹配到的就丢掉

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(authorN, books)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       name nationality deceased                         title other.author
## 1   McNeil   Australia       no     Interactive Data Analysis         <NA>
## 2   Ripley          UK       no            Spatial Statistics         <NA>
## 3   Ripley          UK       no         Stochastic Simulation         <NA>
## 4  Tierney          US       no                     LISP-STAT         <NA>
## 5    Tukey          US      yes     Exploratory Data Analysis         <NA>
## 6 Venables   Australia       no Modern Applied Statistics ...       Ripley
\end{verbatim}

还可以指定合并的列，先按照 surname 合并，留下 surname

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(authors, books, }\AttributeTok{by.x =} \StringTok{"surname"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"name"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    surname nationality deceased                         title other.author
## 1   McNeil   Australia       no     Interactive Data Analysis         <NA>
## 2   Ripley          UK       no            Spatial Statistics         <NA>
## 3   Ripley          UK       no         Stochastic Simulation         <NA>
## 4  Tierney          US       no                     LISP-STAT         <NA>
## 5    Tukey          US      yes     Exploratory Data Analysis         <NA>
## 6 Venables   Australia       no Modern Applied Statistics ...       Ripley
\end{verbatim}

留下的是 name

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(books, authors, }\AttributeTok{by.x =} \StringTok{"name"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"surname"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       name                         title other.author nationality deceased
## 1   McNeil     Interactive Data Analysis         <NA>   Australia       no
## 2   Ripley            Spatial Statistics         <NA>          UK       no
## 3   Ripley         Stochastic Simulation         <NA>          UK       no
## 4  Tierney                     LISP-STAT         <NA>          US       no
## 5    Tukey     Exploratory Data Analysis         <NA>          US      yes
## 6 Venables Modern Applied Statistics ...       Ripley   Australia       no
\end{verbatim}

为了比较清楚地观察几种合并的区别，这里提供对应的动画展示 \url{https://github.com/gadenbuie/tidyexplain}

(inner, outer, left, right, cross) join 共5种合并方式详情请看 \url{https://stackoverflow.com/questions/1299871}

cbind 和 rbind 分别是按列和行合并数据框

\hypertarget{dm-duplicated}{%
\section{数据去重}\label{dm-duplicated}}

单个数值型向量去重，此时和 unique 函数作用一样

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{9}\SpecialCharTok{:}\DecValTok{20}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{3}\SpecialCharTok{:}\DecValTok{7}\NormalTok{, }\DecValTok{0}\SpecialCharTok{:}\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  3  4  5  6  7  0  1  2
## [26]  3  4  5  6  7  8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# extract unique elements}
\NormalTok{x[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(x)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  6  7  0  8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unique}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  6  7  0  8
\end{verbatim}

数据框类型数据中，去除重复的行，这个重复可以是多个变量对应的向量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{y =} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{z =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}
\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y  z
## 1  0 0  1
## 2  0 1  2
## 3  1 0  3
## 4  0 0  4
## 5  0 1  5
## 6  0 1  6
## 7  1 0  7
## 8  0 1  8
## 9  0 0  9
## 10 1 0 10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(df[, }\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{)]), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   x y z
## 1 0 0 1
## 2 0 1 2
## 3 1 0 3
\end{verbatim}

\begin{rmdtip}{提示}

去掉字段 cyl 和 gear 有重复的记录，data.table 方式

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(mtcars\_df, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{))][,.(mpg, cyl, gear)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl gear
## 1: 21.0   6    4
## 2: 22.8   4    4
## 3: 21.4   6    3
## 4: 18.7   8    3
## 5: 21.5   4    3
## 6: 26.0   4    5
## 7: 15.8   8    5
## 8: 19.7   6    5
\end{verbatim}

dplyr 方式

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(cyl, gear, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, cyl, gear)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg cyl gear
## Mazda RX4         21.0   6    4
## Datsun 710        22.8   4    4
## Hornet 4 Drive    21.4   6    3
## Hornet Sportabout 18.7   8    3
## Toyota Corona     21.5   4    3
## Porsche 914-2     26.0   4    5
## Ford Pantera L    15.8   8    5
## Ferrari Dino      19.7   6    5
\end{verbatim}

dplyr 的去重操作不需要拷贝一个新的数据对象 mtcars\_df，并且可以以管道的方式将后续的选择操作连接起来，代码更加具有可读性。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(mtcars\_df[, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)]), }\FunctionTok{c}\NormalTok{(}\StringTok{"mpg"}\NormalTok{,}\StringTok{"cyl"}\NormalTok{,}\StringTok{"gear"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl gear
## 1: 21.0   6    4
## 2: 22.8   4    4
## 3: 21.4   6    3
## 4: 18.7   8    3
## 5: 21.5   4    3
## 6: 26.0   4    5
## 7: 15.8   8    5
## 8: 19.7   6    5
\end{verbatim}

Base R 和 data.table 提供的 \texttt{duplicated()} 函数和 \texttt{{[}} 函数一起实现去重的操作，选择操作放在 \texttt{{[}} 实现，\texttt{{[}} 其实是一个函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{2}\SpecialCharTok{:}\DecValTok{4}
\NormalTok{x[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\StringTok{\textasciigrave{}}\AttributeTok{[}\StringTok{\textasciigrave{}}\NormalTok{(x, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2
\end{verbatim}

\end{rmdtip}

\hypertarget{dm-missing}{%
\section{数据缺失}\label{dm-missing}}

缺失数据操作

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"airquality"}\NormalTok{)}
\FunctionTok{head}\NormalTok{(airquality)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 5    NA      NA 14.3   56     5   5
## 6    28      NA 14.9   66     5   6
\end{verbatim}

对缺失值的处理默认是 \texttt{na.action\ =\ na.omit}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Ozone 最高的那天}
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ airquality, Ozone }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Month, max)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Month Ozone
## 1     5   115
## 2     6    71
## 3     7   135
## 4     8   168
## 5     9    96
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 每月 Ozone, Solar.R, Wind, Temp 平均值}
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ airquality, Ozone }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Month, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Month    Ozone
## 1     5 23.61538
## 2     6 29.44444
## 3     7 59.11538
## 4     8 59.96154
## 5     9 31.44828
\end{verbatim}

缺失值处理

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DataExplorer)}
\FunctionTok{plot\_missing}\NormalTok{(airquality)}
\end{Highlighting}
\end{Shaded}

查看包含缺失的记录，不完整的记录

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality[}\SpecialCharTok{!}\FunctionTok{complete.cases}\NormalTok{(airquality), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Ozone Solar.R Wind Temp Month Day
## 5      NA      NA 14.3   56     5   5
## 6      28      NA 14.9   66     5   6
## 10     NA     194  8.6   69     5  10
## 11      7      NA  6.9   74     5  11
## 25     NA      66 16.6   57     5  25
## 26     NA     266 14.9   58     5  26
## 27     NA      NA  8.0   57     5  27
## 32     NA     286  8.6   78     6   1
## 33     NA     287  9.7   74     6   2
## 34     NA     242 16.1   67     6   3
## 35     NA     186  9.2   84     6   4
## 36     NA     220  8.6   85     6   5
## 37     NA     264 14.3   79     6   6
## 39     NA     273  6.9   87     6   8
## 42     NA     259 10.9   93     6  11
## 43     NA     250  9.2   92     6  12
## 45     NA     332 13.8   80     6  14
## 46     NA     322 11.5   79     6  15
## 52     NA     150  6.3   77     6  21
## 53     NA      59  1.7   76     6  22
## 54     NA      91  4.6   76     6  23
## 55     NA     250  6.3   76     6  24
## 56     NA     135  8.0   75     6  25
## 57     NA     127  8.0   78     6  26
## 58     NA      47 10.3   73     6  27
## 59     NA      98 11.5   80     6  28
## 60     NA      31 14.9   77     6  29
## 61     NA     138  8.0   83     6  30
## 65     NA     101 10.9   84     7   4
## 72     NA     139  8.6   82     7  11
## 75     NA     291 14.9   91     7  14
## 83     NA     258  9.7   81     7  22
## 84     NA     295 11.5   82     7  23
## 96     78      NA  6.9   86     8   4
## 97     35      NA  7.4   85     8   5
## 98     66      NA  4.6   87     8   6
## 102    NA     222  8.6   92     8  10
## 103    NA     137 11.5   86     8  11
## 107    NA      64 11.5   79     8  15
## 115    NA     255 12.6   75     8  23
## 119    NA     153  5.7   88     8  27
## 150    NA     145 13.2   77     9  27
\end{verbatim}

Ozone 和 Solar.R 同时包含缺失值的行

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality[}\FunctionTok{is.na}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Ozone) }\SpecialCharTok{\&} \FunctionTok{is.na}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Solar.R), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Ozone Solar.R Wind Temp Month Day
## 5     NA      NA 14.3   56     5   5
## 27    NA      NA  8.0   57     5  27
\end{verbatim}

\hypertarget{dm-aggregate}{%
\section{数据聚合}\label{dm-aggregate}}

分组求和 \url{https://stackoverflow.com/questions/1660124}

主要是分组统计

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{apropos}\NormalTok{(}\StringTok{"apply"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "apply"      "dendrapply" "eapply"     "frollapply" "kernapply" 
##  [6] "lapply"     "mapply"     "rapply"     "sapply"     "tapply"    
## [11] "vapply"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和 colSums colMeans max}
\FunctionTok{unique}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] setosa     versicolor virginica 
## Levels: setosa versicolor virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分类求和}
\CommentTok{\# colSums(iris[iris$Species == "setosa", {-}5])}
\CommentTok{\# colSums(iris[iris$Species == "virginica", {-}5])}
\FunctionTok{colSums}\NormalTok{(iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"versicolor"}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
##        296.8        138.5        213.0         66.3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# apply(iris[iris$Species == "setosa", {-}5], 2, sum)}
\CommentTok{\# apply(iris[iris$Species == "setosa", {-}5], 2, mean)}
\CommentTok{\# apply(iris[iris$Species == "setosa", {-}5], 2, min)}
\CommentTok{\# apply(iris[iris$Species == "setosa", {-}5], 2, max)}
\FunctionTok{apply}\NormalTok{(iris[iris}\SpecialCharTok{$}\NormalTok{Species }\SpecialCharTok{==} \StringTok{"setosa"}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{], }\DecValTok{2}\NormalTok{, quantile)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Sepal.Length Sepal.Width Petal.Length Petal.Width
## 0%            4.3       2.300        1.000         0.1
## 25%           4.8       3.200        1.400         0.2
## 50%           5.0       3.400        1.500         0.2
## 75%           5.2       3.675        1.575         0.3
## 100%          5.8       4.400        1.900         0.6
\end{verbatim}

aggregate: Compute Summary Statistics of Data Subsets

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 按分类变量 Species 分组求和}
\CommentTok{\# aggregate(subset(iris, select = {-}Species), by = list(iris[, "Species"]), FUN = sum)}
\FunctionTok{aggregate}\NormalTok{(iris[, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{], }\FunctionTok{list}\NormalTok{(iris[, }\DecValTok{5}\NormalTok{]), sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Group.1 Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        250.3       171.4         73.1        12.3
## 2 versicolor        296.8       138.5        213.0        66.3
## 3  virginica        329.4       148.7        277.6       101.3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 先确定位置，假设有很多分类变量}
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(}\StringTok{"Species"} \SpecialCharTok{==} \FunctionTok{colnames}\NormalTok{(iris))}
\CommentTok{\# 分组统计}
\FunctionTok{aggregate}\NormalTok{(iris[, }\SpecialCharTok{{-}}\NormalTok{ind], }\FunctionTok{list}\NormalTok{(iris[, ind]), sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Group.1 Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        250.3       171.4         73.1        12.3
## 2 versicolor        296.8       138.5        213.0        66.3
## 3  virginica        329.4       148.7        277.6       101.3
\end{verbatim}

按照 Species 划分的类别，分组计算，使用公式表示形式，右边一定是分类变量，否则会报错误或者警告，输出奇怪的结果，请读者尝试运行\texttt{aggregate(Species\ \textasciitilde{}\ Sepal.Length,\ data\ =\ iris,\ mean)}。公式法表示分组计算，\texttt{\textasciitilde{}} 左手边可以做加 \texttt{+} 减 \texttt{-} 乘 \texttt{*} 除 \texttt{/} 取余 \texttt{\%\%} 等数学运算。下面以数据集 iris 为例，只对 Sepal.Length 按 Species 分组计算

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{data =}\NormalTok{ iris, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length
## 1     setosa        5.006
## 2 versicolor        5.936
## 3  virginica        6.588
\end{verbatim}

与上述分组统计结果一样的命令，在大数据集上， 与 aggregate 相比，tapply 要快很多，by 是 tapply 的包裹，处理速度差不多。读者可以构造伪随机数据集验证。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# tapply(iris$Sepal.Length, list(iris$Species), mean)}
\FunctionTok{with}\NormalTok{(iris, }\FunctionTok{tapply}\NormalTok{(Sepal.Length, Species, mean))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     setosa versicolor  virginica 
##      5.006      5.936      6.588
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length, iris}\SpecialCharTok{$}\NormalTok{Species, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## iris$Species: setosa
## [1] 5.006
## ------------------------------------------------------------ 
## iris$Species: versicolor
## [1] 5.936
## ------------------------------------------------------------ 
## iris$Species: virginica
## [1] 6.588
\end{verbatim}

对所有变量按 Species 分组计算

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(. }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{data =}\NormalTok{ iris, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        5.006       3.428        1.462       0.246
## 2 versicolor        5.936       2.770        4.260       1.326
## 3  virginica        6.588       2.974        5.552       2.026
\end{verbatim}

对变量 Sepal.Length 和 Sepal.Width 求和后，按 Species 分组计算

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(Sepal.Length }\SpecialCharTok{+}\NormalTok{ Sepal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{data =}\NormalTok{ iris, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length + Sepal.Width
## 1     setosa                      8.434
## 2 versicolor                      8.706
## 3  virginica                      9.562
\end{verbatim}

对多个分类变量做分组计算，在数据集 ChickWeight 中 Chick和Diet都是数字编码的分类变量，其中 Chick 是有序的因子变量，Diet 是无序的因子变量，而 Time 是数值型的变量，表示小鸡出生的天数。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看数据}
\FunctionTok{str}\NormalTok{(ChickWeight)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   578 obs. of  4 variables:
##  $ weight: num  42 51 59 64 76 93 106 125 149 171 ...
##  $ Time  : num  0 2 4 6 8 10 12 14 16 18 ...
##  $ Chick : Ord.factor w/ 50 levels "18"<"16"<"15"<..: 15 15 15 15 15 15 15 15 15 15 ...
##  $ Diet  : Factor w/ 4 levels "1","2","3","4": 1 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "formula")=Class 'formula'  language weight ~ Time | Chick
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "outer")=Class 'formula'  language ~Diet
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Time"
##   ..$ y: chr "Body weight"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(days)"
##   ..$ y: chr "(gm)"
\end{verbatim}

查看数据集ChickWeight的前几行

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(ChickWeight)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   weight Time Chick Diet
## 1     42    0     1    1
## 2     51    2     1    1
## 3     59    4     1    1
## 4     64    6     1    1
## 5     76    8     1    1
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(ChickWeight)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   578 obs. of  4 variables:
##  $ weight: num  42 51 59 64 76 93 106 125 149 171 ...
##  $ Time  : num  0 2 4 6 8 10 12 14 16 18 ...
##  $ Chick : Ord.factor w/ 50 levels "18"<"16"<"15"<..: 15 15 15 15 15 15 15 15 15 15 ...
##  $ Diet  : Factor w/ 4 levels "1","2","3","4": 1 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "formula")=Class 'formula'  language weight ~ Time | Chick
....
\end{verbatim}

对于数据集ChickWeight中的有序变量Chick，aggregate 会按照既定顺序返回分组计算的结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Chick, }\AttributeTok{data =}\NormalTok{ ChickWeight, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Chick    weight
## 1     18  37.00000
## 2     16  49.71429
## 3     15  60.12500
## 4     13  67.83333
## 5      9  81.16667
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Diet, }\AttributeTok{data =}\NormalTok{ ChickWeight, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Diet   weight
## 1    1 102.6455
## 2    2 122.6167
## 3    3 142.9500
## 4    4 135.2627
\end{verbatim}

分类变量没有用数字编码，以 CO2 数据集为例，该数据集描述草植对二氧化碳的吸收情况，Plant 是具有12个水平的有序的因子变量，Type表示植物的源头分别是魁北克(Quebec)和密西西比(Mississippi)，Treatment表示冷却(chilled)和不冷却(nonchilled)两种处理方式，conc表示周围环境中二氧化碳的浓度，uptake表示植物吸收二氧化碳的速率。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看数据集}
\FunctionTok{head}\NormalTok{(CO2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Plant   Type  Treatment conc uptake
## 1   Qn1 Quebec nonchilled   95   16.0
## 2   Qn1 Quebec nonchilled  175   30.4
## 3   Qn1 Quebec nonchilled  250   34.8
## 4   Qn1 Quebec nonchilled  350   37.2
## 5   Qn1 Quebec nonchilled  500   35.3
## 6   Qn1 Quebec nonchilled  675   39.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(CO2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   84 obs. of  5 variables:
##  $ Plant    : Ord.factor w/ 12 levels "Qn1"<"Qn2"<"Qn3"<..: 1 1 1 1 1 1 1 2 2 2 ...
##  $ Type     : Factor w/ 2 levels "Quebec","Mississippi": 1 1 1 1 1 1 1 1 1 1 ...
##  $ Treatment: Factor w/ 2 levels "nonchilled","chilled": 1 1 1 1 1 1 1 1 1 1 ...
##  $ conc     : num  95 175 250 350 500 675 1000 95 175 250 ...
##  $ uptake   : num  16 30.4 34.8 37.2 35.3 39.2 39.7 13.6 27.3 37.1 ...
##  - attr(*, "formula")=Class 'formula'  language uptake ~ conc | Plant
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "outer")=Class 'formula'  language ~Treatment * Type
##   .. ..- attr(*, ".Environment")=<environment: R_EmptyEnv> 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Ambient carbon dioxide concentration"
##   ..$ y: chr "CO2 uptake rate"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(uL/L)"
##   ..$ y: chr "(umol/m^2 s)"
\end{verbatim}

对单个变量分组统计

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(uptake }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Plant, }\AttributeTok{data =}\NormalTok{ CO2, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Plant   uptake
## 1    Qn1 33.22857
## 2    Qn2 35.15714
## 3    Qn3 37.61429
## 4    Qc1 29.97143
## 5    Qc3 32.58571
## 6    Qc2 32.70000
## 7    Mn3 24.11429
## 8    Mn2 27.34286
## 9    Mn1 26.40000
## 10   Mc2 12.14286
## 11   Mc3 17.30000
## 12   Mc1 18.00000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(uptake }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Type, }\AttributeTok{data =}\NormalTok{ CO2, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          Type   uptake
## 1      Quebec 33.54286
## 2 Mississippi 20.88333
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(uptake }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Treatment, }\AttributeTok{data =}\NormalTok{ CO2, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Treatment   uptake
## 1 nonchilled 30.64286
## 2    chilled 23.78333
\end{verbatim}

对多个变量分组统计，查看二氧化碳吸收速率uptake随类型Type和处理方式Treatment

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(uptake }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Type }\SpecialCharTok{+}\NormalTok{ Treatment, }\AttributeTok{data =}\NormalTok{ CO2, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          Type  Treatment   uptake
## 1      Quebec nonchilled 35.33333
## 2 Mississippi nonchilled 25.95238
## 3      Quebec    chilled 31.75238
## 4 Mississippi    chilled 15.81429
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tapply}\NormalTok{(CO2}\SpecialCharTok{$}\NormalTok{uptake, }\FunctionTok{list}\NormalTok{(CO2}\SpecialCharTok{$}\NormalTok{Type, CO2}\SpecialCharTok{$}\NormalTok{Treatment), mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             nonchilled  chilled
## Quebec        35.33333 31.75238
## Mississippi   25.95238 15.81429
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(CO2}\SpecialCharTok{$}\NormalTok{uptake, }\FunctionTok{list}\NormalTok{(CO2}\SpecialCharTok{$}\NormalTok{Type, CO2}\SpecialCharTok{$}\NormalTok{Treatment), mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : Quebec
## : nonchilled
## [1] 35.33333
## ------------------------------------------------------------ 
## : Mississippi
## : nonchilled
## [1] 25.95238
## ------------------------------------------------------------ 
## : Quebec
## : chilled
## [1] 31.75238
## ------------------------------------------------------------ 
## : Mississippi
## : chilled
## [1] 15.81429
\end{verbatim}

在这个例子中 tapply 和 by 的输出结果的表示形式不一样，aggregate 返回一个 data.frame 数据框，tapply 返回一个表格 table，by 返回特殊的数据类型 by。

Function \texttt{by} is an object-oriented wrapper for \texttt{tapply} applied to data frames.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和}
\CommentTok{\# by(iris[, 1], INDICES = list(iris$Species), FUN = sum)}
\CommentTok{\# by(iris[, 2], INDICES = list(iris$Species), FUN = sum)}
\FunctionTok{by}\NormalTok{(iris[, }\DecValTok{3}\NormalTok{], }\AttributeTok{INDICES =} \FunctionTok{list}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{FUN =}\NormalTok{ sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : setosa
## [1] 73.1
## ------------------------------------------------------------ 
## : versicolor
## [1] 213
## ------------------------------------------------------------ 
## : virginica
## [1] 277.6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\AttributeTok{INDICES =} \FunctionTok{list}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{FUN =}\NormalTok{ sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : setosa
## [1] 494.8
## ------------------------------------------------------------ 
## : versicolor
## [1] 648.3
## ------------------------------------------------------------ 
## : virginica
## [1] 755.7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\AttributeTok{INDICES =} \FunctionTok{list}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{FUN =}\NormalTok{ summary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : setosa
##   Sepal.Length    Sepal.Width     Petal.Length  
##  Min.   :4.300   Min.   :2.300   Min.   :1.000  
##  1st Qu.:4.800   1st Qu.:3.200   1st Qu.:1.400  
##  Median :5.000   Median :3.400   Median :1.500  
##  Mean   :5.006   Mean   :3.428   Mean   :1.462  
##  3rd Qu.:5.200   3rd Qu.:3.675   3rd Qu.:1.575  
##  Max.   :5.800   Max.   :4.400   Max.   :1.900  
## ------------------------------------------------------------ 
## : versicolor
##   Sepal.Length    Sepal.Width     Petal.Length 
##  Min.   :4.900   Min.   :2.000   Min.   :3.00  
##  1st Qu.:5.600   1st Qu.:2.525   1st Qu.:4.00  
##  Median :5.900   Median :2.800   Median :4.35  
##  Mean   :5.936   Mean   :2.770   Mean   :4.26  
##  3rd Qu.:6.300   3rd Qu.:3.000   3rd Qu.:4.60  
##  Max.   :7.000   Max.   :3.400   Max.   :5.10  
## ------------------------------------------------------------ 
## : virginica
##   Sepal.Length    Sepal.Width     Petal.Length  
##  Min.   :4.900   Min.   :2.200   Min.   :4.500  
##  1st Qu.:6.225   1st Qu.:2.800   1st Qu.:5.100  
##  Median :6.500   Median :3.000   Median :5.550  
##  Mean   :6.588   Mean   :2.974   Mean   :5.552  
##  3rd Qu.:6.900   3rd Qu.:3.175   3rd Qu.:5.875  
##  Max.   :7.900   Max.   :3.800   Max.   :6.900
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(iris, }\AttributeTok{INDICES =} \FunctionTok{list}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{FUN =}\NormalTok{ summary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## : setosa
##   Sepal.Length    Sepal.Width     Petal.Length    Petal.Width   
##  Min.   :4.300   Min.   :2.300   Min.   :1.000   Min.   :0.100  
##  1st Qu.:4.800   1st Qu.:3.200   1st Qu.:1.400   1st Qu.:0.200  
##  Median :5.000   Median :3.400   Median :1.500   Median :0.200  
##  Mean   :5.006   Mean   :3.428   Mean   :1.462   Mean   :0.246  
##  3rd Qu.:5.200   3rd Qu.:3.675   3rd Qu.:1.575   3rd Qu.:0.300  
##  Max.   :5.800   Max.   :4.400   Max.   :1.900   Max.   :0.600  
##        Species  
##  setosa    :50  
##  versicolor: 0  
##  virginica : 0  
##                 
##                 
##                 
## ------------------------------------------------------------ 
## : versicolor
##   Sepal.Length    Sepal.Width     Petal.Length   Petal.Width          Species  
##  Min.   :4.900   Min.   :2.000   Min.   :3.00   Min.   :1.000   setosa    : 0  
##  1st Qu.:5.600   1st Qu.:2.525   1st Qu.:4.00   1st Qu.:1.200   versicolor:50  
##  Median :5.900   Median :2.800   Median :4.35   Median :1.300   virginica : 0  
##  Mean   :5.936   Mean   :2.770   Mean   :4.26   Mean   :1.326                  
##  3rd Qu.:6.300   3rd Qu.:3.000   3rd Qu.:4.60   3rd Qu.:1.500                  
##  Max.   :7.000   Max.   :3.400   Max.   :5.10   Max.   :1.800                  
## ------------------------------------------------------------ 
## : virginica
##   Sepal.Length    Sepal.Width     Petal.Length    Petal.Width   
##  Min.   :4.900   Min.   :2.200   Min.   :4.500   Min.   :1.400  
##  1st Qu.:6.225   1st Qu.:2.800   1st Qu.:5.100   1st Qu.:1.800  
##  Median :6.500   Median :3.000   Median :5.550   Median :2.000  
##  Mean   :6.588   Mean   :2.974   Mean   :5.552   Mean   :2.026  
##  3rd Qu.:6.900   3rd Qu.:3.175   3rd Qu.:5.875   3rd Qu.:2.300  
##  Max.   :7.900   Max.   :3.800   Max.   :6.900   Max.   :2.500  
##        Species  
##  setosa    : 0  
##  versicolor: 0  
##  virginica :50  
##                 
##                 
## 
\end{verbatim}

Group Averages Over Level Combinations of Factors 分组平均

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(warpbreaks)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    54 obs. of  3 variables:
##  $ breaks : num  26 30 54 25 70 52 51 26 67 18 ...
##  $ wool   : Factor w/ 2 levels "A","B": 1 1 1 1 1 1 1 1 1 1 ...
##  $ tension: Factor w/ 3 levels "L","M","H": 1 1 1 1 1 1 1 1 1 2 ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(warpbreaks)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   breaks wool tension
## 1     26    A       L
## 2     30    A       L
## 3     54    A       L
## 4     25    A       L
## 5     70    A       L
## 6     52    A       L
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ave}\NormalTok{(warpbreaks}\SpecialCharTok{$}\NormalTok{breaks, warpbreaks}\SpecialCharTok{$}\NormalTok{wool)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
##  [9] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
## [17] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
## [25] 31.03704 31.03704 31.03704 25.25926 25.25926 25.25926 25.25926 25.25926
## [33] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926
## [41] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926
## [49] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(warpbreaks, }\FunctionTok{ave}\NormalTok{(breaks, tension, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{mean}\NormalTok{(x, }\AttributeTok{trim =} \FloatTok{0.1}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875
## [10] 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125
## [19] 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625
## [28] 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875
## [37] 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125
## [46] 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和}
\FunctionTok{with}\NormalTok{(warpbreaks, }\FunctionTok{ave}\NormalTok{(breaks, tension, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{sum}\NormalTok{(x)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 655 655 655 655 655 655 655 655 655 475 475 475 475 475 475 475 475 475 390
## [20] 390 390 390 390 390 390 390 390 655 655 655 655 655 655 655 655 655 475 475
## [39] 475 475 475 475 475 475 475 390 390 390 390 390 390 390 390 390
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和}
\FunctionTok{with}\NormalTok{(iris, }\FunctionTok{ave}\NormalTok{(Sepal.Length, Species, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{sum}\NormalTok{(x)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [13] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [25] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [37] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [49] 250.3 250.3 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [61] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [73] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [85] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [97] 296.8 296.8 296.8 296.8 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [109] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [121] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [133] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [145] 329.4 329.4 329.4 329.4 329.4 329.4
\end{verbatim}

\hypertarget{dm-table}{%
\section{表格统计}\label{dm-table}}

\begin{quote}
介绍操作表格的 table, addmargins, prop.table, xtabs, margin.table, ftabe 等函数
\end{quote}

table 多个分类变量分组计数统计

\begin{itemize}
\tightlist
\item
  介绍 warpbreaks 和 airquality 纽约空气质量监测数据集 二维的数据框
\item
  UCBAdmissions 1973 年加州大学伯克利分校的院系录取数据集 3维的列联表
\item
  Titanic 4维的列联表数据 泰坦尼克号幸存者数据集
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(warpbreaks, }\FunctionTok{table}\NormalTok{(wool, tension))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     tension
## wool L M H
##    A 9 9 9
##    B 9 9 9
\end{verbatim}

以 iris 数据集为例，table 的第一个参数是自己制造的第二个分类变量，原始分类变量是 Species

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(iris, }\FunctionTok{table}\NormalTok{(}\AttributeTok{Sepal.check =}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{7}\NormalTok{, Species))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Species
## Sepal.check setosa versicolor virginica
##       FALSE     50         50        38
##       TRUE       0          0        12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(iris, }\FunctionTok{table}\NormalTok{(}\AttributeTok{Sepal.check =}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FunctionTok{mean}\NormalTok{(Sepal.Length), Species))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Species
## Sepal.check setosa versicolor virginica
##       FALSE     50         24         6
##       TRUE       0         26        44
\end{verbatim}

以 airquality 数据集为例，看看月份中臭氧含量比较高的几天

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aiq.tab }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(airquality, }\FunctionTok{table}\NormalTok{(}\AttributeTok{Oz.high =}\NormalTok{ Ozone }\SpecialCharTok{\textgreater{}} \DecValTok{80}\NormalTok{, Month))}
\NormalTok{aiq.tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high  5  6  7  8  9
##   FALSE 25  9 20 19 27
##   TRUE   1  0  6  7  2
\end{verbatim}

对表格按行和列求和，即求表格的边际，查看总体情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{addmargins}\NormalTok{(aiq.tab, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high   5   6   7   8   9 Sum
##   FALSE  25   9  20  19  27 100
##   TRUE    1   0   6   7   2  16
##   Sum    26   9  26  26  29 116
\end{verbatim}

臭氧含量超 80 的天数在每个月的占比，\texttt{addmargins} 的第二个参数 1 表示对列求和

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aiq.prop }\OtherTok{\textless{}{-}} \FunctionTok{prop.table}\NormalTok{(aiq.tab, }\DecValTok{2}\NormalTok{)}
\NormalTok{aiq.prop}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high          5          6          7          8          9
##   FALSE 0.96153846 1.00000000 0.76923077 0.73076923 0.93103448
##   TRUE  0.03846154 0.00000000 0.23076923 0.26923077 0.06896552
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aiq.marprop }\OtherTok{\textless{}{-}} \FunctionTok{addmargins}\NormalTok{(aiq.prop, }\DecValTok{1}\NormalTok{)}
\NormalTok{aiq.marprop}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high          5          6          7          8          9
##   FALSE 0.96153846 1.00000000 0.76923077 0.73076923 0.93103448
##   TRUE  0.03846154 0.00000000 0.23076923 0.26923077 0.06896552
##   Sum   1.00000000 1.00000000 1.00000000 1.00000000 1.00000000
\end{verbatim}

转换成百分比，将小数四舍五入转化为百分数，保留两位小数点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{round}\NormalTok{(}\DecValTok{100} \SpecialCharTok{*}\NormalTok{ aiq.marprop, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Month
## Oz.high      5      6      7      8      9
##   FALSE  96.15 100.00  76.92  73.08  93.10
##   TRUE    3.85   0.00  23.08  26.92   6.90
##   Sum   100.00 100.00 100.00 100.00 100.00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pairs}\NormalTok{(airquality, }\AttributeTok{panel =}\NormalTok{ panel.smooth, }\AttributeTok{main =} \StringTok{"airquality data"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

以 UCBAdmissions 数据集为例，使用 \texttt{xtabs} 函数把数据组织成列联表，先查看数据的内容

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{UCBAdmissions}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , Dept = A
## 
##           Gender
## Admit      Male Female
##   Admitted  512     89
##   Rejected  313     19
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{UCBA2DF }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(UCBAdmissions)}
\NormalTok{UCBA2DF}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Admit Gender Dept Freq
## 1  Admitted   Male    A  512
## 2  Rejected   Male    A  313
## 3  Admitted Female    A   89
## 4  Rejected Female    A   19
## 5  Admitted   Male    B  353
....
\end{verbatim}

接着将 \texttt{UCBA2DF} 数据集转化为表格的形式

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{UCBA2DF.tab }\OtherTok{\textless{}{-}} \FunctionTok{xtabs}\NormalTok{(Freq }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Gender }\SpecialCharTok{+}\NormalTok{ Admit }\SpecialCharTok{+}\NormalTok{ Dept, }\AttributeTok{data =}\NormalTok{ UCBA2DF)}
\FunctionTok{ftable}\NormalTok{(UCBA2DF.tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                 Dept   A   B   C   D   E   F
## Gender Admit                                
## Male   Admitted      512 353 120 138  53  22
##        Rejected      313 207 205 279 138 351
## Female Admitted       89  17 202 131  94  24
##        Rejected       19   8 391 244 299 317
\end{verbatim}

将录取性别和院系进行对比

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prop.table}\NormalTok{(}\FunctionTok{margin.table}\NormalTok{(UCBA2DF.tab, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{)), }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         Dept
## Gender            A          B          C          D          E          F
##   Male   0.30657748 0.20810108 0.12077295 0.15496098 0.07097733 0.13861018
##   Female 0.05885559 0.01362398 0.32316076 0.20435967 0.21416894 0.18583106
\end{verbatim}

男生倾向于申请院系 A 和 B，女生倾向于申请院系 C 到 F，院系 A 和 B 是最容易录取的。

\hypertarget{dm-index}{%
\section{索引访问}\label{dm-index}}

which 与引用 \texttt{{[}} 性能比较，在区间 \([0,1]\) 上生成 10 万个服从均匀分布的随机数，随机抽取其中\(\frac{1}{4}\)。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{100000}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(n)}
\NormalTok{i }\OtherTok{\textless{}{-}} \FunctionTok{logical}\NormalTok{(n)}
\NormalTok{i[}\FunctionTok{sample}\NormalTok{(n, n }\SpecialCharTok{/} \DecValTok{4}\NormalTok{)] }\OtherTok{\textless{}{-}} \ConstantTok{TRUE}
\NormalTok{microbenchmark}\SpecialCharTok{::}\FunctionTok{microbenchmark}\NormalTok{(x[i], x[}\FunctionTok{which}\NormalTok{(i)], }\AttributeTok{times =} \DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textcolor{red}{\textbf{TODO: }{使用 \texttt{subset} 函数与 \texttt{{[}} 比较}}

\hypertarget{dm-array}{%
\section{多维数组}\label{dm-array}}

多维数组的行列是怎么定义的 \texttt{?array} 轴的概念，画个图表示数组

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{array}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{27}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , 1
## 
##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9
## 
## , , 2
## 
##      [,1] [,2] [,3]
## [1,]   10   13   16
## [2,]   11   14   17
## [3,]   12   15   18
## 
## , , 3
## 
##      [,1] [,2] [,3]
## [1,]   19   22   25
## [2,]   20   23   26
## [3,]   21   24   27
\end{verbatim}

垂直于Z轴的平面去截三维立方体，3 代表 z 轴，得到三个截面（二维矩阵）

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{asplit}\NormalTok{(}\FunctionTok{array}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{27}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)), }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9
## 
## [[2]]
##      [,1] [,2] [,3]
## [1,]   10   13   16
## [2,]   11   14   17
## [3,]   12   15   18
## 
## [[3]]
##      [,1] [,2] [,3]
## [1,]   19   22   25
## [2,]   20   23   26
## [3,]   21   24   27
\end{verbatim}

对每个二维矩阵按列求和

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lapply}\NormalTok{(}\FunctionTok{asplit}\NormalTok{(}\FunctionTok{array}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{27}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)), }\DecValTok{3}\NormalTok{), apply, }\DecValTok{2}\NormalTok{, sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## [1]  6 15 24
## 
## [[2]]
## [1] 33 42 51
## 
## [[3]]
## [1] 60 69 78
\end{verbatim}

\texttt{asplit} 和 \texttt{lapply} 组合处理多维数组的\href{https://www.brodieg.com/2018/11/23/is-your-matrix-running-slow-try-lists}{计算问题}

\href{https://d.cosx.org/d/107493}{三维数组的矩阵运算} \href{https://CRAN.R-project.org/package=abind}{abind} 包提供更多的数组操作，如合并，替换

数组操作 aperm 数组转置 Array Transposition

asplit 数组拆分 其后接 lapply 或者 vapply

apply 数组计算

rray 包 \url{https://github.com/r-lib/rray}

\hypertarget{dm-others}{%
\section{其它操作}\label{dm-others}}

成对的数据操作有 \texttt{list} 与 \texttt{unlist}、\texttt{stack} 与 \texttt{unstack}、\texttt{class} 与 \texttt{unclass}、\texttt{attach} 与 \texttt{detach} 以及 \texttt{with} 和 \texttt{within}，它们在数据操作过程中有时会起到一定的补充作用。

\hypertarget{relist-or-unlist}{%
\subsection{列表属性}\label{relist-or-unlist}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 创建列表}
\FunctionTok{list}\NormalTok{(...)}
\FunctionTok{pairlist}\NormalTok{(...)}
\CommentTok{\# 转化列表}
\FunctionTok{as.list}\NormalTok{(x, ...)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}environment\textquotesingle{}}
\FunctionTok{as.list}\NormalTok{(x, }\AttributeTok{all.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sorted =} \ConstantTok{FALSE}\NormalTok{, ...)}
\FunctionTok{as.pairlist}\NormalTok{(x)}
\CommentTok{\# 检查列表}
\FunctionTok{is.list}\NormalTok{(x)}
\FunctionTok{is.pairlist}\NormalTok{(x)}

\FunctionTok{alist}\NormalTok{(...)}
\end{Highlighting}
\end{Shaded}

\texttt{list} 函数用来构造、转化和检查 R 列表对象。下面创建一个临时列表对象 tmp ，它包含两个元素 A 和 B，两个元素都是向量，前者是数值型，后者是字符型

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(tmp }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{A =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{B =} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $A
## [1] 1 2 3
## 
## $B
## [1] "a" "b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlist}\NormalTok{(x, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{use.names =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{unlist} 函数将给定的列表对象 \texttt{x} 简化为原子向量 (atomic vector)，我们发现简化之后变成一个字符型向量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlist}\NormalTok{(tmp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  A1  A2  A3  B1  B2 
## "1" "2" "3" "a" "b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlist}\NormalTok{(tmp, }\AttributeTok{use.names =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "1" "2" "3" "a" "b"
\end{verbatim}

unlist 的逆操作是 relist

\hypertarget{stack-or-unstack}{%
\subsection{堆叠向量}\label{stack-or-unstack}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stack}\NormalTok{(x, ...)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{stack}\NormalTok{(x, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{, ...)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}data.frame\textquotesingle{}}
\FunctionTok{stack}\NormalTok{(x, select, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{, ...)}

\FunctionTok{unstack}\NormalTok{(x, ...)}
\DocumentationTok{\#\# Default S3 method:}
\FunctionTok{unstack}\NormalTok{(x, form, ...)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}data.frame\textquotesingle{}}
\FunctionTok{unstack}\NormalTok{(x, form, ...)}
\end{Highlighting}
\end{Shaded}

\texttt{stack} 与 \texttt{unstack} 将多个向量堆在一起组成一个向量

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 查看数据集 PlantGrowth}
\FunctionTok{class}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   weight group
## 1   4.17  ctrl
## 2   5.58  ctrl
## 3   5.18  ctrl
## 4   6.11  ctrl
## 5   4.50  ctrl
## 6   4.61  ctrl
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 检查默认的公式}
\FunctionTok{formula}\NormalTok{(PlantGrowth) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## weight ~ group
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 根据公式解除堆叠}
\CommentTok{\# 下面等价于 unstack(PlantGrowth, form = weight \textasciitilde{} group)}
\NormalTok{(pg }\OtherTok{\textless{}{-}} \FunctionTok{unstack}\NormalTok{(PlantGrowth)) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    ctrl trt1 trt2
## 1  4.17 4.81 6.31
## 2  5.58 4.17 5.12
## 3  5.18 4.41 5.54
## 4  6.11 3.59 5.50
## 5  4.50 5.87 5.37
## 6  4.61 3.83 5.29
## 7  5.17 6.03 4.92
## 8  4.53 4.89 6.15
## 9  5.33 4.32 5.80
## 10 5.14 4.69 5.26
\end{verbatim}

现在再将变量 pg 堆叠起来，还可以指定要堆叠的列

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stack}\NormalTok{(pg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    values  ind
## 1    4.17 ctrl
## 2    5.58 ctrl
## 3    5.18 ctrl
## 4    6.11 ctrl
## 5    4.50 ctrl
....
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stack}\NormalTok{(pg, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{ctrl)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    values  ind
## 1    4.81 trt1
## 2    4.17 trt1
## 3    4.41 trt1
## 4    3.59 trt1
## 5    5.87 trt1
....
\end{verbatim}

形式上和 reshape 有一些相似之处，数据框可以由长变宽或由宽变长

\hypertarget{class-or-unclass}{%
\subsection{属性转化}\label{class-or-unclass}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(x)}
\FunctionTok{class}\NormalTok{(x) }\OtherTok{\textless{}{-}}\NormalTok{ value}
\FunctionTok{unclass}\NormalTok{(x)}
\FunctionTok{inherits}\NormalTok{(x, what, }\AttributeTok{which =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{oldClass}\NormalTok{(x)}
\FunctionTok{oldClass}\NormalTok{(x) }\OtherTok{\textless{}{-}}\NormalTok{ value}
\end{Highlighting}
\end{Shaded}

\texttt{class} 和 \texttt{unclass} 函数用来查看、设置类属性和取消类属性，常用于面向对象的编程设计中

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "factor"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unclass}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
##  [38] 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [75] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3
## [112] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3
## [149] 3 3
## attr(,"levels")
....
\end{verbatim}

\hypertarget{attach-or-detach}{%
\subsection{绑定环境}\label{attach-or-detach}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attach}\NormalTok{(what,}
  \AttributeTok{pos =}\NormalTok{ 2L, }\AttributeTok{name =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(what), }\AttributeTok{backtick =} \ConstantTok{FALSE}\NormalTok{),}
  \AttributeTok{warn.conflicts =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{detach}\NormalTok{(name,}
  \AttributeTok{pos =}\NormalTok{ 2L, }\AttributeTok{unload =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{character.only =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{force =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{attach} 和 \texttt{detach} 是否绑定数据框的列名，不推荐操作，推荐使用 \texttt{with}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attach}\NormalTok{(iris)}
\FunctionTok{head}\NormalTok{(Species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] setosa setosa setosa setosa setosa setosa
## Levels: setosa versicolor virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{detach}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\hypertarget{with-or-within}{%
\subsection{数据环境}\label{with-or-within}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(data, expr, ...)}
\FunctionTok{within}\NormalTok{(data, expr, ...)}
\DocumentationTok{\#\# S3 method for class \textquotesingle{}list\textquotesingle{}}
\FunctionTok{within}\NormalTok{(data, expr, }\AttributeTok{keepAttrs =} \ConstantTok{TRUE}\NormalTok{, ...)}
\end{Highlighting}
\end{Shaded}

\begin{description}
\item[\texttt{data}]
参数 \texttt{data} 用来构造表达式计算的环境。其默认值可以是一个环境，列表，数据框。在 \texttt{within} 函数中 \texttt{data} 参数只能是列表或数据框。
\item[\texttt{expr}]
参数 \texttt{expr} 包含要计算的表达式。在 \texttt{within} 中通常包含一个复合表达式，比如

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\{}
\NormalTok{  a }\OtherTok{\textless{}{-}} \FunctionTok{somefun}\NormalTok{()}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{otherfun}\NormalTok{()}
\NormalTok{  ...}
  \FunctionTok{rm}\NormalTok{(unused1, temp)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}
\end{description}

\texttt{with} 和 \texttt{within} 计算一组表达式，计算的环境是由数据构造的，后者可以修改原始的数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(mtcars, mpg[cyl }\SpecialCharTok{==} \DecValTok{8} \SpecialCharTok{\&}\NormalTok{ disp }\SpecialCharTok{\textgreater{}} \DecValTok{350}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 18.7 14.3 10.4 10.4 14.7 19.2 15.8
\end{verbatim}

和下面计算的结果一样，但是更加简洁漂亮

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars}\SpecialCharTok{$}\NormalTok{mpg[mtcars}\SpecialCharTok{$}\NormalTok{cyl }\SpecialCharTok{==} \DecValTok{8} \SpecialCharTok{\&}\NormalTok{ mtcars}\SpecialCharTok{$}\NormalTok{disp }\SpecialCharTok{\textgreater{}} \DecValTok{350}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 18.7 14.3 10.4 10.4 14.7 19.2 15.8
\end{verbatim}

\texttt{within} 函数可以修改原数据环境中的多个变量，比如删除、修改和添加等

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 原数据集 airquality}
\FunctionTok{head}\NormalTok{(airquality)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 5    NA      NA 14.3   56     5   5
## 6    28      NA 14.9   66     5   6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aq }\OtherTok{\textless{}{-}} \FunctionTok{within}\NormalTok{(airquality, \{}
\NormalTok{  lOzone }\OtherTok{\textless{}{-}} \FunctionTok{log}\NormalTok{(Ozone) }\CommentTok{\# 取对数}
\NormalTok{  Month }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(month.abb[Month]) }\CommentTok{\# 字符串型转因子型}
\NormalTok{  cTemp }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{((Temp }\SpecialCharTok{{-}} \DecValTok{32}\NormalTok{) }\SpecialCharTok{*} \DecValTok{5} \SpecialCharTok{/} \DecValTok{9}\NormalTok{, }\DecValTok{1}\NormalTok{) }\CommentTok{\# 从华氏温度到摄氏温度转化}
\NormalTok{  S.cT }\OtherTok{\textless{}{-}}\NormalTok{ Solar.R }\SpecialCharTok{/}\NormalTok{ cTemp }\CommentTok{\# 使用新创建的变量}
  \FunctionTok{rm}\NormalTok{(Day, Temp)}
\NormalTok{\})}
\CommentTok{\# 修改后的数据集}
\FunctionTok{head}\NormalTok{(aq)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Month      S.cT cTemp   lOzone
## 1    41     190  7.4   May  9.793814  19.4 3.713572
## 2    36     118  8.0   May  5.315315  22.2 3.583519
## 3    12     149 12.6   May  6.394850  23.3 2.484907
## 4    18     313 11.5   May 18.742515  16.7 2.890372
## 5    NA      NA 14.3   May        NA  13.3       NA
## 6    28      NA 14.9   May        NA  18.9 3.332205
\end{verbatim}

下面再举一个复杂的绘图例子，这个例子来自 \texttt{boxplot} 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(ToothGrowth, \{}
  \FunctionTok{boxplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose,}
    \AttributeTok{boxwex =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{{-}} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{subset =}\NormalTok{ (supp }\SpecialCharTok{==} \StringTok{"VC"}\NormalTok{), }\AttributeTok{col =} \StringTok{"\#4285f4"}\NormalTok{,}
    \AttributeTok{main =} \StringTok{"Guinea Pigs\textquotesingle{} Tooth Growth"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"Vitamin C dose mg"}\NormalTok{,}
    \AttributeTok{ylab =} \StringTok{"tooth length"}\NormalTok{, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{35}\NormalTok{)}
\NormalTok{  )}
  \FunctionTok{boxplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose,}
    \AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{boxwex =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{+} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{subset =}\NormalTok{ supp }\SpecialCharTok{==} \StringTok{"OJ"}\NormalTok{, }\AttributeTok{col =} \StringTok{"\#EA4335"}
\NormalTok{  )}
  \FunctionTok{legend}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{9}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"Ascorbic acid"}\NormalTok{, }\StringTok{"Orange juice"}\NormalTok{),}
    \AttributeTok{fill =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4285f4"}\NormalTok{, }\StringTok{"\#EA4335"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/subset-in-boxplot-1} \end{center}

将 \texttt{boxplot} 函数的 \texttt{subset} 参数单独提出来，调用数据子集选择函数 \texttt{subset} ，这里 \texttt{with} 中只包含一个表达式，所以也可以不用大括号

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{subset}\NormalTok{(ToothGrowth, supp }\SpecialCharTok{==} \StringTok{"VC"}\NormalTok{),}
  \FunctionTok{boxplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose,}
    \AttributeTok{boxwex =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{{-}} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{col =} \StringTok{"\#4285f4"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Guinea Pigs\textquotesingle{} Tooth Growth"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"Vitamin C dose mg"}\NormalTok{,}
    \AttributeTok{ylab =} \StringTok{"tooth length"}\NormalTok{, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{35}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{subset}\NormalTok{(ToothGrowth, supp }\SpecialCharTok{==} \StringTok{"OJ"}\NormalTok{),}
  \FunctionTok{boxplot}\NormalTok{(len }\SpecialCharTok{\textasciitilde{}}\NormalTok{ dose,}
    \AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{boxwex =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{+} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{col =} \StringTok{"\#EA4335"}
\NormalTok{  )}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{9}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"Ascorbic acid"}\NormalTok{, }\StringTok{"Orange juice"}\NormalTok{),}
  \AttributeTok{fill =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4285f4"}\NormalTok{, }\StringTok{"\#EA4335"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/subset-out-boxplot-1} \end{center}

可以作为数据变换 \texttt{transform} 的一种替代，它也比较像 \textbf{dplyr} 包的 \texttt{mutate} 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{within}\NormalTok{(mtcars[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{],\{}
\NormalTok{  disp.cc }\OtherTok{\textless{}{-}}\NormalTok{ disp }\SpecialCharTok{*} \FloatTok{2.54}\SpecialCharTok{\^{}}\DecValTok{3}
\NormalTok{  disp.l }\OtherTok{\textless{}{-}}\NormalTok{ disp.cc }\SpecialCharTok{/} \FloatTok{1e3}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg cyl disp   disp.l  disp.cc
## Mazda RX4         21.0   6  160 2.621930 2621.930
## Mazda RX4 Wag     21.0   6  160 2.621930 2621.930
## Datsun 710        22.8   4  108 1.769803 1769.803
## Hornet 4 Drive    21.4   6  258 4.227863 4227.863
## Hornet Sportabout 18.7   8  360 5.899343 5899.343
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 只能使用已有的列，刚生成的列不能用}
\CommentTok{\# transform(}
\CommentTok{\#   mtcars[1:5, 1:3],}
\CommentTok{\#   disp.cc = disp * 2.54\^{}3,}
\CommentTok{\#   disp.l = disp.cc / 1e3}
\CommentTok{\# )}
\FunctionTok{transform}\NormalTok{(}
\NormalTok{  mtcars[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{],}
  \AttributeTok{disp.cc =}\NormalTok{ disp }\SpecialCharTok{*} \FloatTok{2.54}\SpecialCharTok{\^{}}\DecValTok{3}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg cyl disp  disp.cc
## Mazda RX4         21.0   6  160 2621.930
## Mazda RX4 Wag     21.0   6  160 2621.930
## Datsun 710        22.8   4  108 1769.803
## Hornet 4 Drive    21.4   6  258 4227.863
## Hornet Sportabout 18.7   8  360 5899.343
\end{verbatim}

\texttt{transform} 只能使用已有的列，变换中间生成的列不能用，所以相比于 \texttt{transform} 函数， \texttt{within} 显得更为灵活

\hypertarget{dm-apply-family}{%
\section{apply 族}\label{dm-apply-family}}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:apply-functions} apply 函数}\tabularnewline
\toprule
函数 & 输入 & 输出 \\
\midrule
\endfirsthead
\toprule
函数 & 输入 & 输出 \\
\midrule
\endhead
\texttt{apply()} & 矩阵、数据框 & 向量 \\
\texttt{lapply()} & 向量、列表 & 列表 \\
\texttt{sapply()} & 向量、列表 & 向量、矩阵 \\
\texttt{mapply()} & 多个向量 & 列表 \\
\texttt{tapply()} & 数据框、数组 & 向量 \\
\texttt{vapply()} & 列表 & 矩阵 \\
\texttt{eapply()} & 列表 & 列表 \\
\texttt{rapply()} & 嵌套列表 & 嵌套列表 \\
\bottomrule
\end{longtable}

除此之外，还有 \texttt{dendrapply()} 专门处理层次聚类或分类回归树型结构， 而函数 \texttt{kernapply()} 用于时间序列的平滑处理

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Reproduce example 10.4.3 from Brockwell and Davis (1991) [@Brockwell\_1991\_Time]}
\FunctionTok{spectrum}\NormalTok{(sunspot.year, }\AttributeTok{kernel =} \FunctionTok{kernel}\NormalTok{(}\StringTok{"daniell"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{11}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{3}\NormalTok{)), }\AttributeTok{log =} \StringTok{"no"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/spectrum-sunspot-year-1} 

}

\caption{太阳黑子的频谱}\label{fig:spectrum-sunspot-year}
\end{figure}

将函数应用到多个向量，返回一个列表，生成四组服从正态分布 \(\mathcal{N}(\mu_i,\sigma_i)\) 的随机数，它们的均值和方差依次是 \(\mu_i = \sigma_i = 1 \ldots 4\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{means }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\NormalTok{sds }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{samples }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(rnorm,}
  \AttributeTok{mean =}\NormalTok{ means, }\AttributeTok{sd =}\NormalTok{ sds,}
  \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{n =} \DecValTok{10}\NormalTok{), }\AttributeTok{SIMPLIFY =} \ConstantTok{FALSE}
\NormalTok{)}
\NormalTok{samples}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
##  [1]  1.37697212  1.30154837 -0.09802317 -0.13040590 -1.79653432  1.72057350
##  [7]  1.93912102  0.77062225  2.75913135  1.11736679
## 
## [[2]]
##  [1]  0.2937544  3.8185184  4.3927459  1.2568322  1.7534795  5.6000862
##  [7]  5.4079918 -4.0775292 -2.5779499  2.1166070
## 
## [[3]]
##  [1] 9.523096 6.294548 3.954661 2.780557 5.502806 3.596252 6.893524 5.810155
##  [9] 2.557700 3.331296
## 
## [[4]]
##  [1]  0.7499813  1.0251913  8.3813803 13.7414948  5.5524739  5.1625107
##  [7]  2.8576069  4.3040589  1.7588056  5.7887535
\end{verbatim}

我们借用图\ref{fig:mapply-lapply}来看一下 mapply 的效果，多组随机数生成非常有助于快速模拟。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{invisible}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(samples, }\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{plot}\NormalTok{(x, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \StringTok{"grey"}\NormalTok{)}
  \FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"darkorange"}\NormalTok{)}
\NormalTok{\}))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/mapply-lapply-1} 

}

\caption{ lapply 函数}\label{fig:mapply-lapply}
\end{figure}

分别计算每个样本的平均值

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sapply}\NormalTok{(samples, mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.8960372 1.7984536 5.0244596 4.9322257
\end{verbatim}

分别计算每个样本的1，2，3 分位点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lapply}\NormalTok{(samples, quantile, }\AttributeTok{probs =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{/} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
##       25%       50%       75% 
## 0.1191382 1.2094576 1.6346732 
## 
## [[2]]
##       25%       50%       75% 
## 0.5345238 1.9350433 4.2491890 
## 
## [[3]]
##      25%      50%      75% 
## 3.397535 4.728734 6.173450 
## 
## [[4]]
##      25%      50%      75% 
## 2.033506 4.733285 5.729684
\end{verbatim}

仅用 \texttt{sapply()} 函数替换上面的 \texttt{lapply()}，我们可以得到一个矩阵，值得注意的是函数 \texttt{quantile()} 和 \texttt{fivenum()} 算出来的结果有一些差异

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sapply}\NormalTok{(samples, quantile, }\AttributeTok{probs =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3} \SpecialCharTok{/} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          [,1]      [,2]     [,3]     [,4]
## 25% 0.1191382 0.5345238 3.397535 2.033506
## 50% 1.2094576 1.9350433 4.728734 4.733285
## 75% 1.6346732 4.2491890 6.173450 5.729684
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{vapply}\NormalTok{(samples, fivenum, }\FunctionTok{c}\NormalTok{(}\AttributeTok{Min. =} \DecValTok{0}\NormalTok{, }\StringTok{"1st Qu."} \OtherTok{=} \DecValTok{0}\NormalTok{, }\AttributeTok{Median =} \DecValTok{0}\NormalTok{, }\StringTok{"3rd Qu."} \OtherTok{=} \DecValTok{0}\NormalTok{, }\AttributeTok{Max. =} \DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                [,1]       [,2]     [,3]       [,4]
## Min.    -1.79653432 -4.0775292 2.557700  0.7499813
## 1st Qu. -0.09802317  0.2937544 3.331296  1.7588056
## Median   1.20945758  1.9350433 4.728734  4.7332848
## 3rd Qu.  1.72057350  4.3927459 6.294548  5.7887535
## Max.     2.75913135  5.6000862 9.523096 13.7414948
\end{verbatim}

vapply 和 sapply 类似，但是预先指定返回值类型，这样可以更加安全，有时也更快。

以数据集 presidents 为例，它是一个 ts 对象类型的时间序列数据，记录了 1945 年至 1974 年每个季度美国总统的支持率，这组数据中存在缺失值，以 NA 表示。支持率的变化趋势见图 \ref{fig:usa-presidents}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(presidents)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/usa-presidents-1} 

}

\caption{1945-1974美国总统的支持率}\label{fig:usa-presidents}
\end{figure}

计算这 30 年每个季度的平均支持率

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tapply}\NormalTok{(presidents, }\FunctionTok{cycle}\NormalTok{(presidents), mean, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        1        2        3        4 
## 58.44828 56.43333 57.22222 53.07143
\end{verbatim}

\texttt{cycle()} 函数计算序列中每个观察值在周期中的位置，presidents 的周期为 4，根据位置划分组，然后分组求平均，也可以化作如下计算步骤，虽然看起来复杂，但是数据操作的过程很清晰，不再看起来像是一个黑箱。

tapply 函数来做分组求和

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 一个变量分组求和}
\FunctionTok{tapply}\NormalTok{(warpbreaks}\SpecialCharTok{$}\NormalTok{breaks, warpbreaks[, }\DecValTok{3}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{], sum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## tension
##   L   M   H 
## 655 475 390
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个变量分组计数}
\FunctionTok{with}\NormalTok{(warpbreaks, }\FunctionTok{table}\NormalTok{(wool, tension))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     tension
## wool L M H
##    A 9 9 9
##    B 9 9 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个变量分组求和}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(breaks }\SpecialCharTok{\textasciitilde{}}\NormalTok{ wool }\SpecialCharTok{+}\NormalTok{ tension, }\AttributeTok{data =}\NormalTok{ warpbreaks, sum) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{reshape}\NormalTok{(}\AttributeTok{v.names =} \StringTok{"breaks"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"wool"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"tension"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}

\StringTok{\textasciigrave{}}\AttributeTok{colnames\textless{}{-}}\StringTok{\textasciigrave{}}\NormalTok{(dat, }\FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"(breaks)"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{colnames}\NormalTok{(dat), }\AttributeTok{replacement =} \StringTok{""}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   wool   L   M   H
## 1    A 401 216 221
## 2    B 254 259 169
\end{verbatim}

\hypertarget{sec-option-with}{%
\section{with 选项}\label{sec-option-with}}

注意 data.table 与 Base R 不同的地方

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://github.com/Rdatatable/data.table/issues/4513}
\CommentTok{\# https://d.cosx.org/d/421532{-}datatable{-}base{-}r}
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{iris }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{, }\FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris))]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  TRUE  TRUE FALSE FALSE FALSE
\end{verbatim}

需要使用 \texttt{with\ =\ FALSE} 选项

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{,}
  \FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris)),}
\NormalTok{  with }\OtherTok{=} \ConstantTok{FALSE}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8
\end{verbatim}

不使用 with 选项，用函数 \texttt{mget()} 将字符串转变量

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[}
\NormalTok{  Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{,}
  \FunctionTok{mget}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris), }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{))}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8
\end{verbatim}

更加 data.table 风格的方式见

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{, .SD, .SDcols }\OtherTok{=} \FunctionTok{patterns}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8
\end{verbatim}

with 还可以这样用，直接修改、添加一列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(df, x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df, z }\SpecialCharTok{\textless{}} \DecValTok{100}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{sample}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df)), ]}
\FunctionTok{head}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y  z
## 7  7 1 50
## 8  8 1 65
## 65 5 7 74
## 14 4 2 20
## 37 7 4 65
## 5  5 1 26
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(x, y, }\AttributeTok{z =}\NormalTok{ z)) }\SpecialCharTok{+}
  \FunctionTok{geom\_contour}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/with-op-1} 

}

\caption{with 操作}\label{fig:with-op}
\end{figure}

\hypertarget{sec-aggregate}{%
\section{分组聚合}\label{sec-aggregate}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{methods}\NormalTok{(}\StringTok{"aggregate"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] aggregate.data.frame aggregate.default*   aggregate.formula*  
## [4] aggregate.ts        
## see '?methods' for accessing help and source code
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{args}\NormalTok{(}\StringTok{"aggregate.data.frame"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (x, by, FUN, ..., simplify = TRUE, drop = TRUE) 
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{args}\NormalTok{(}\StringTok{"aggregate.ts"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (x, nfrequency = 1, FUN = sum, ndeltat = 1, ts.eps = getOption("ts.eps"), 
##     ...) 
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# getAnywhere(aggregate.formula)}
\end{Highlighting}
\end{Shaded}

按 Species 分组，对 Sepal.Length 中大于平均值的数取平均

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, iris, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{mean}\NormalTok{(x[x }\SpecialCharTok{\textgreater{}} \FunctionTok{mean}\NormalTok{(x)]))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length
## 1     setosa     5.313636
## 2 versicolor     6.375000
## 3  virginica     7.159091
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}

\NormalTok{dt }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{each =} \DecValTok{3}\NormalTok{), }\AttributeTok{y =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{),}
  \AttributeTok{z =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{3}\NormalTok{), }\AttributeTok{w =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"a"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{)}
\NormalTok{)}

\NormalTok{dt[, .(}\AttributeTok{x\_sum =} \FunctionTok{sum}\NormalTok{(x), }\AttributeTok{y\_sum =} \FunctionTok{sum}\NormalTok{(y)), by }\OtherTok{=}\NormalTok{ .(z, w)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    z w x_sum y_sum
## 1: A a     4     2
## 2: B a     4     4
## 3: C a     4     6
## 4: A b     2     1
## 5: B b     2     2
## 6: C b     2     3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dt[, .(}\AttributeTok{x\_sum =} \FunctionTok{sum}\NormalTok{(x), }\AttributeTok{y\_sum =} \FunctionTok{sum}\NormalTok{(y)), by }\OtherTok{=} \FunctionTok{mget}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"z"}\NormalTok{, }\StringTok{"w"}\NormalTok{))]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    z w x_sum y_sum
## 1: A a     4     2
## 2: B a     4     4
## 3: C a     4     6
## 4: A b     2     1
## 5: B b     2     2
## 6: C b     2     3
\end{verbatim}

shiny 前端传递字符串向量，借助 \texttt{mget()} 函数根据选择的变量分组统计计算，只有一个变量可以使用 \texttt{get()} 传递变量给 data.table

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shiny)}

\NormalTok{ui }\OtherTok{\textless{}{-}} \FunctionTok{fluidPage}\NormalTok{(}
  \FunctionTok{fluidRow}\NormalTok{(}
    \FunctionTok{column}\NormalTok{(}
      \DecValTok{6}\NormalTok{,}
      \FunctionTok{selectInput}\NormalTok{(}\StringTok{"input\_vars"}\NormalTok{,}
        \AttributeTok{label =} \StringTok{"变量"}\NormalTok{, }\CommentTok{\# 给筛选框取名}
        \AttributeTok{choices =} \FunctionTok{c}\NormalTok{(}\AttributeTok{z =} \StringTok{"z"}\NormalTok{, }\AttributeTok{w =} \StringTok{"w"}\NormalTok{), }\CommentTok{\# 待选的值}
        \AttributeTok{selected =} \StringTok{"z"}\NormalTok{, }\CommentTok{\# 指定默认值}
        \AttributeTok{multiple =} \ConstantTok{TRUE} \CommentTok{\# 允许多选}
\NormalTok{      ),}
\NormalTok{      DT}\SpecialCharTok{::}\FunctionTok{dataTableOutput}\NormalTok{(}\StringTok{"output\_table"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{)}

\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{library}\NormalTok{(magrittr)}

\NormalTok{dt }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{each =} \DecValTok{3}\NormalTok{), }\AttributeTok{y =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{),}
  \AttributeTok{z =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{), }\DecValTok{3}\NormalTok{), }\AttributeTok{w =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"a"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{)}
\NormalTok{)}

\NormalTok{server }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(input, output, session) \{}
\NormalTok{  output}\SpecialCharTok{$}\NormalTok{output\_table }\OtherTok{\textless{}{-}}\NormalTok{ DT}\SpecialCharTok{::}\FunctionTok{renderDataTable}\NormalTok{(}
\NormalTok{    \{}
\NormalTok{      dt[, .(}\AttributeTok{x\_sum =} \FunctionTok{sum}\NormalTok{(x), }\AttributeTok{y\_sum =} \FunctionTok{sum}\NormalTok{(y)), by }\OtherTok{=} \FunctionTok{mget}\NormalTok{(input}\SpecialCharTok{$}\NormalTok{input\_vars)] }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
\NormalTok{        DT}\SpecialCharTok{::}\FunctionTok{datatable}\NormalTok{()}
\NormalTok{    \},}
    \AttributeTok{server =} \ConstantTok{FALSE}
\NormalTok{  )}
\NormalTok{\}}

\CommentTok{\# 执行}
\FunctionTok{shinyApp}\NormalTok{(}\AttributeTok{ui =}\NormalTok{ ui, }\AttributeTok{server =}\NormalTok{ server)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-merge-two-tables}{%
\section{合并操作}\label{sec-merge-two-tables}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat1 }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\NormalTok{dat2 }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{z =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{))}

\FunctionTok{data.frame}\NormalTok{(dat1, }\AttributeTok{z =}\NormalTok{ dat2}\SpecialCharTok{$}\NormalTok{z[}\FunctionTok{match}\NormalTok{(dat1}\SpecialCharTok{$}\NormalTok{x, dat2}\SpecialCharTok{$}\NormalTok{x)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y z
## 1  0 1 3
## 2  0 1 3
## 3 10 2 4
## 4 10 2 4
## 5 20 3 5
## 6 20 3 5
## 7 30 4 6
## 8 30 4 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(dat1, dat2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y z
## 1  0 1 3
## 2  0 1 3
## 3 10 2 4
## 4 10 2 4
## 5 20 3 5
## 6 20 3 5
## 7 30 4 6
## 8 30 4 6
\end{verbatim}

保留两个数据集中的所有行

\hypertarget{sec-reshape}{%
\section{长宽转换}\label{sec-reshape}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{args}\NormalTok{(}\StringTok{"reshape"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (data, varying = NULL, v.names = NULL, timevar = "time", 
##     idvar = "id", ids = 1L:NROW(data), times = seq_along(varying[[1L]]), 
##     drop = NULL, direction, new.row.names = NULL, sep = ".", 
##     split = if (sep == "") {
##         list(regexp = "[A-Za-z][0-9]", include = TRUE)
##     } else {
##         list(regexp = sep, include = FALSE, fixed = TRUE)
##     }) 
## NULL
\end{verbatim}

PlantGrowth 数据集的重塑操作也可以使用内置的函数 \texttt{reshape()} 实现

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{PlantGrowth}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{reshape}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{idvar =} \StringTok{"group"}\NormalTok{, }\AttributeTok{v.names =} \StringTok{"weight"}\NormalTok{,}
  \AttributeTok{timevar =} \StringTok{"id"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{,}
  \AttributeTok{sep =} \StringTok{""}
\NormalTok{)}
\NormalTok{knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(dat,}
  \AttributeTok{caption =} \StringTok{"不同生长环境下植物的干重"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{col.names =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(weight)"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{names}\NormalTok{(dat)),}
  \AttributeTok{align =} \StringTok{"c"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:data-frame-PlantGrowth}不同生长环境下植物的干重}
\centering
\begin{tabular}[t]{c|c|c|c|c|c|c|c|c|c|c}
\hline
group & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10\\
\hline
ctrl & 4.17 & 5.58 & 5.18 & 6.11 & 4.50 & 4.61 & 5.17 & 4.53 & 5.33 & 5.14\\
\hline
trt1 & 4.81 & 4.17 & 4.41 & 3.59 & 5.87 & 3.83 & 6.03 & 4.89 & 4.32 & 4.69\\
\hline
trt2 & 6.31 & 5.12 & 5.54 & 5.50 & 5.37 & 5.29 & 4.92 & 6.15 & 5.80 & 5.26\\
\hline
\end{tabular}
\end{table}

或者，我们也可以使用 \textbf{tidyr} 包提供的 \texttt{pivot\_wider()} 函数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{id\_cols =}\NormalTok{ id,}
  \AttributeTok{names\_from =}\NormalTok{ group, }\AttributeTok{values\_from =}\NormalTok{ weight}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 10 x 4
##       id  ctrl  trt1  trt2
##    <int> <dbl> <dbl> <dbl>
##  1     1  4.17  4.81  6.31
##  2     2  5.58  4.17  5.12
##  3     3  5.18  4.41  5.54
##  4     4  6.11  3.59  5.5 
##  5     5  4.5   5.87  5.37
##  6     6  4.61  3.83  5.29
##  7     7  5.17  6.03  4.92
##  8     8  4.53  4.89  6.15
##  9     9  5.33  4.32  5.8 
## 10    10  5.14  4.69  5.26
\end{verbatim}

或者，我们还可以使用 \textbf{data.table} 包提供的 \texttt{dcast()} 函数，用于将长格式的数据框重塑为宽格式的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{PlantGrowth\_DT }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(PlantGrowth)}
\CommentTok{\# 纵}
\FunctionTok{dcast}\NormalTok{(PlantGrowth\_DT, id }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{value.var =} \StringTok{"weight"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     id ctrl trt1 trt2
##  1:  1 4.17 4.81 6.31
##  2:  2 5.58 4.17 5.12
##  3:  3 5.18 4.41 5.54
##  4:  4 6.11 3.59 5.50
##  5:  5 4.50 5.87 5.37
##  6:  6 4.61 3.83 5.29
##  7:  7 5.17 6.03 4.92
##  8:  8 4.53 4.89 6.15
##  9:  9 5.33 4.32 5.80
## 10: 10 5.14 4.69 5.26
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 横}
\FunctionTok{dcast}\NormalTok{(PlantGrowth\_DT, group }\SpecialCharTok{\textasciitilde{}}\NormalTok{ id, }\AttributeTok{value.var =} \StringTok{"weight"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group    1    2    3    4    5    6    7    8    9   10
## 1:  ctrl 4.17 5.58 5.18 6.11 4.50 4.61 5.17 4.53 5.33 5.14
## 2:  trt1 4.81 4.17 4.41 3.59 5.87 3.83 6.03 4.89 4.32 4.69
## 3:  trt2 6.31 5.12 5.54 5.50 5.37 5.29 4.92 6.15 5.80 5.26
\end{verbatim}

\hypertarget{sec-filter-columns}{%
\section{对符合条件的列操作}\label{sec-filter-columns}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数值型变量的列的位置}
\FunctionTok{which}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(iris, is.numeric))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
##            1            2            3            4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[, }\FunctionTok{sapply}\NormalTok{(iris, is.numeric), with }\OtherTok{=}\NormalTok{ F][Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{7.5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:          7.6         3.0          6.6         2.1
## 2:          7.7         3.8          6.7         2.2
## 3:          7.7         2.6          6.9         2.3
## 4:          7.7         2.8          6.7         2.0
## 5:          7.9         3.8          6.4         2.0
## 6:          7.7         3.0          6.1         2.3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.table" "data.frame"
\end{verbatim}

用 Base R 提供的管道符号 \textbar\textgreater{} 将 data.table 数据操作与 ggplot2 数据可视化连接起来

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{iris }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{subset}\NormalTok{(Species }\SpecialCharTok{==} \StringTok{"setosa"} \SpecialCharTok{\&}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{5.5}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \CommentTok{\# 行过滤}
  \CommentTok{\# subset(select = grep("Sepal", colnames(iris), value = TRUE)) |\textgreater{} \# 列过滤}
  \FunctionTok{subset}\NormalTok{(}\AttributeTok{select =} \FunctionTok{grepl}\NormalTok{(}\StringTok{"Sepal"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(iris))) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width)) }\SpecialCharTok{+} \CommentTok{\# 绘图}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-manipulation_files/figure-latex/pipe-dataframe-ggplot2-1} 

}

\caption{管道连接数据操作和可视化}\label{fig:pipe-dataframe-ggplot2}
\end{figure}

\hypertarget{sec-case-when}{%
\section{\texorpdfstring{\texttt{CASE\ WHEN} 和 \texttt{fcase}}{CASE WHEN 和 fcase}}\label{sec-case-when}}

\texttt{CASE\ WHEN} 是 SQL 中的条件判断语句，\textbf{data.table} 中的函数 \texttt{fcase()} 可与之等价。值得注意的是，\texttt{fcase()} 需要 \textbf{data.table} 版本 1.13.0 及以上。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{weights =} \FunctionTok{c}\NormalTok{(}\FloatTok{56.8}\NormalTok{, }\FloatTok{57.2}\NormalTok{, }\FloatTok{46.3}\NormalTok{, }\FloatTok{38.5}\NormalTok{),}
  \AttributeTok{gender =} \FunctionTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"0"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"0"}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# 1 表示男，0表示女，空表示未知}
\FunctionTok{transform}\NormalTok{(dat, }\AttributeTok{gender\_cn =} \FunctionTok{fcase}\NormalTok{(}
\NormalTok{  gender }\SpecialCharTok{==} \StringTok{"1"}\NormalTok{, }\StringTok{"男"}\NormalTok{,}
\NormalTok{  gender }\SpecialCharTok{==} \StringTok{"0"}\NormalTok{, }\StringTok{"女"}\NormalTok{,}
\NormalTok{  gender }\SpecialCharTok{==} \StringTok{""}\NormalTok{, }\StringTok{"未知"}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    weights gender gender_cn
## 1:    56.8      1        男
## 2:    57.2      0        女
## 3:    46.3             未知
## 4:    38.5      0        女
\end{verbatim}

\hypertarget{sec-datatable-in-action}{%
\section{数据操作实战}\label{sec-datatable-in-action}}

\href{https://tdhock.github.io/}{Toby Dylan Hocking} 在 useR! 2020 大会上分享的幻灯片 \url{https://github.com/tdhock/r-devel-emails}

\hypertarget{sec-faq-operations}{%
\section{高频数据操作}\label{sec-faq-operations}}

以数据集 dat 为例介绍常用的数据操作

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{num\_a =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{each =} \DecValTok{4}\NormalTok{), }\AttributeTok{num\_b =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{times =} \DecValTok{4}\NormalTok{),}
  \AttributeTok{group\_a =} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\AttributeTok{size =} \DecValTok{16}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{group\_b =} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ LETTERS[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\AttributeTok{size =} \DecValTok{16}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T)}
\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(dat)}
\NormalTok{dat}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     num_a num_b group_a group_b
##  1:     1     1       c       B
##  2:     1     2       b       B
##  3:     1     3       a       B
##  4:     1     4       a       C
##  5:     2     1       b       B
##  6:     2     2       b       C
##  7:     2     3       a       B
##  8:     2     4       a       A
##  9:     3     1       b       C
## 10:     3     2       b       B
## 11:     3     3       b       B
## 12:     3     4       a       B
## 13:     4     1       b       C
## 14:     4     2       c       B
## 15:     4     3       b       C
## 16:     4     4       a       C
\end{verbatim}

\hypertarget{subsec-reduce-merge}{%
\subsection{循环合并}\label{subsec-reduce-merge}}

\begin{itemize}
\tightlist
\item
  问题来源 \href{https://github.com/Rdatatable/data.table/issues/599}{Faster version of Reduce(merge, list(DT1,DT2,DT3,\ldots)) called mergelist (a la rbindlist)}
\end{itemize}

\hypertarget{subsec-count-by-group}{%
\subsection{分组计数}\label{subsec-count-by-group}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(num\_a)), by }\OtherTok{=}\NormalTok{ .(group\_a)] }\CommentTok{\# dat[, .N , by = .(group\_a)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_a V1
## 1:       c  2
## 2:       b  8
## 3:       a  6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(num\_a)), by }\OtherTok{=}\NormalTok{ .(group\_b)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_b V1
## 1:       B  9
## 2:       C  6
## 3:       A  1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(num\_a)), by }\OtherTok{=}\NormalTok{ .(group\_a, group\_b)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_a group_b V1
## 1:       c       B  2
## 2:       b       B  4
## 3:       a       B  3
## 4:       a       C  2
## 5:       b       C  4
## 6:       a       A  1
\end{verbatim}

\hypertarget{subsec-sample-by-group}{%
\subsection{分组抽样}\label{subsec-sample-by-group}}

以 \texttt{group\_a} 为组别， a、 b、 c 分别有 6、 8、 2 条记录

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 无放回的抽样}
\NormalTok{dt\_sample\_1 }\OtherTok{\textless{}{-}}\NormalTok{ dat[, .SD[}\FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .N, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{)], by }\OtherTok{=}\NormalTok{ group\_a]}
\CommentTok{\# 有放回的随机抽样}
\NormalTok{dt\_sample\_2 }\OtherTok{\textless{}{-}}\NormalTok{ dat[, .SD[}\FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .N, }\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{)], by }\OtherTok{=}\NormalTok{ group\_a]}
\end{Highlighting}
\end{Shaded}

可能存在该组样本不平衡，有的组的样本量不足你想要的样本量。每个组无放回地抽取 4 个样本，如果该组样本量不足 4，则全部抽取全部样本量。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .SD[}\FunctionTok{sample}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .N, }\AttributeTok{size =} \FunctionTok{min}\NormalTok{(}\DecValTok{4}\NormalTok{, .N))], by }\OtherTok{=}\NormalTok{ group\_a]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     group_a num_a num_b group_b
##  1:       c     1     1       B
##  2:       c     4     2       B
##  3:       b     3     2       B
##  4:       b     2     2       C
##  5:       b     2     1       B
##  6:       b     3     3       B
##  7:       a     1     3       B
##  8:       a     2     3       B
##  9:       a     2     4       A
## 10:       a     1     4       C
\end{verbatim}

还可以按照指定的比例抽取样本量 \footnote{\url{https://stackoverflow.com/questions/18258690/take-randomly-sample-based-on-groups}}

\hypertarget{subsec-order-by-group}{%
\subsection{分组排序}\label{subsec-order-by-group}}

data.table 包的分组排序问题 \url{https://d.cosx.org/d/421650-datatable/3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[}\FunctionTok{with}\NormalTok{(dat, }\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{ave}\NormalTok{(num\_a, group\_a, }\AttributeTok{FUN =}\NormalTok{ max), }\SpecialCharTok{{-}}\NormalTok{num\_a)), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     num_a num_b group_a group_b
##  1:     4     1       b       C
##  2:     4     2       c       B
##  3:     4     3       b       C
##  4:     4     4       a       C
##  5:     3     1       b       C
##  6:     3     2       b       B
##  7:     3     3       b       B
##  8:     3     4       a       B
##  9:     2     1       b       B
## 10:     2     2       b       C
## 11:     2     3       a       B
## 12:     2     4       a       A
## 13:     1     1       c       B
## 14:     1     2       b       B
## 15:     1     3       a       B
## 16:     1     4       a       C
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# num\_a 降序排列，然后对 group\_a 升序排列}
\NormalTok{dat[}\FunctionTok{with}\NormalTok{(dat, }\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{num\_a, group\_a)), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     num_a num_b group_a group_b
##  1:     4     4       a       C
##  2:     4     1       b       C
##  3:     4     3       b       C
##  4:     4     2       c       B
##  5:     3     4       a       B
##  6:     3     1       b       C
##  7:     3     2       b       B
##  8:     3     3       b       B
##  9:     2     3       a       B
## 10:     2     4       a       A
## 11:     2     1       b       B
## 12:     2     2       b       C
## 13:     1     3       a       B
## 14:     1     4       a       C
## 15:     1     2       b       B
## 16:     1     1       c       B
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 简写}
\NormalTok{dat[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{num\_a, group\_a)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     num_a num_b group_a group_b
##  1:     4     4       a       C
##  2:     4     1       b       C
##  3:     4     3       b       C
##  4:     4     2       c       B
##  5:     3     4       a       B
##  6:     3     1       b       C
##  7:     3     2       b       B
##  8:     3     3       b       B
##  9:     2     3       a       B
## 10:     2     4       a       A
## 11:     2     1       b       B
## 12:     2     2       b       C
## 13:     1     3       a       B
## 14:     1     4       a       C
## 15:     1     2       b       B
## 16:     1     1       c       B
\end{verbatim}

\texttt{setorder()} 函数直接修改原始数据记录的排序

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{setorder}\NormalTok{(dat, }\SpecialCharTok{{-}}\NormalTok{num\_a, group\_a)}
\end{Highlighting}
\end{Shaded}

参考多个列分组排序 \footnote{\url{https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns}}

\begin{rmdtip}{提示}

如果数据集 dat 包含缺失值，考虑去掉缺失值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(num\_a))), by }\OtherTok{=}\NormalTok{ .(group\_a)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_a V1
## 1:       c  2
## 2:       b  8
## 3:       a  6
\end{verbatim}

如果数据集 dat 包含重复值，考虑去掉重复值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat[, .(}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(num\_a))), by }\OtherTok{=}\NormalTok{ .(group\_a)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group_a V1
## 1:       c  2
## 2:       b  4
## 3:       a  4
\end{verbatim}

\end{rmdtip}

按 Species 分组，对 Sepal.Length 降序排列，取 Top 3

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(iris)}
\NormalTok{iris[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Sepal.Length), .SD[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], by }\OtherTok{=} \StringTok{"Species"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:  virginica          7.9         3.8          6.4         2.0
## 2:  virginica          7.7         3.8          6.7         2.2
## 3:  virginica          7.7         2.6          6.9         2.3
## 4: versicolor          7.0         3.2          4.7         1.4
## 5: versicolor          6.9         3.1          4.9         1.5
## 6: versicolor          6.8         2.8          4.8         1.4
## 7:     setosa          5.8         4.0          1.2         0.2
## 8:     setosa          5.7         4.4          1.5         0.4
## 9:     setosa          5.7         3.8          1.7         0.3
\end{verbatim}

对 iris 各个列排序

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(iris)}
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\AttributeTok{what =} \StringTok{"order"}\NormalTok{, }\AttributeTok{args =}\NormalTok{ dat[, }\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)])}
\NormalTok{dat[ind, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1:          4.6         3.1          1.5         0.2  setosa
## 2:          4.7         3.2          1.3         0.2  setosa
## 3:          4.9         3.0          1.4         0.2  setosa
## 4:          5.0         3.6          1.4         0.2  setosa
## 5:          5.1         3.5          1.4         0.2  setosa
## 6:          5.4         3.9          1.7         0.4  setosa
\end{verbatim}

按 Species 分组，对 Sepal.Length 降序排列，取 Top 3

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\OtherTok{=} \FunctionTok{as.data.table}\NormalTok{(iris)}
\NormalTok{iris[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Sepal.Length), .SD[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], by}\OtherTok{=}\StringTok{"Species"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:  virginica          7.9         3.8          6.4         2.0
## 2:  virginica          7.7         3.8          6.7         2.2
## 3:  virginica          7.7         2.6          6.9         2.3
## 4: versicolor          7.0         3.2          4.7         1.4
## 5: versicolor          6.9         3.1          4.9         1.5
## 6: versicolor          6.8         2.8          4.8         1.4
## 7:     setosa          5.8         4.0          1.2         0.2
## 8:     setosa          5.7         4.4          1.5         0.4
## 9:     setosa          5.7         3.8          1.7         0.3
\end{verbatim}

对 iris 各个列排序，依次对第 5、1、2、3 列升序排列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\AttributeTok{what =} \StringTok{"order"}\NormalTok{, }\AttributeTok{args =}\NormalTok{ iris[,}\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{)])}
\FunctionTok{head}\NormalTok{(iris[ind, ])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1:          4.3         3.0          1.1         0.1  setosa
## 2:          4.4         2.9          1.4         0.2  setosa
## 3:          4.4         3.0          1.3         0.2  setosa
## 4:          4.4         3.2          1.3         0.2  setosa
## 5:          4.5         2.3          1.3         0.3  setosa
## 6:          4.6         3.1          1.5         0.2  setosa
\end{verbatim}

\begin{table}
\caption{\label{tab:column-order}iris 数据集原顺序（左）和新顺序（右）}

\centering
\begin{tabular}[t]{rrrrl}
\toprule
Sepal.Length & Sepal.Width & Petal.Length & Petal.Width & Species\\
\midrule
5.1 & 3.5 & 1.4 & 0.2 & setosa\\
4.9 & 3.0 & 1.4 & 0.2 & setosa\\
4.7 & 3.2 & 1.3 & 0.2 & setosa\\
4.6 & 3.1 & 1.5 & 0.2 & setosa\\
5.0 & 3.6 & 1.4 & 0.2 & setosa\\
\addlinespace
5.4 & 3.9 & 1.7 & 0.4 & setosa\\
\bottomrule
\end{tabular}
\centering
\begin{tabular}[t]{rrrrl}
\toprule
Sepal.Length & Sepal.Width & Petal.Length & Petal.Width & Species\\
\midrule
4.3 & 3.0 & 1.1 & 0.1 & setosa\\
4.4 & 2.9 & 1.4 & 0.2 & setosa\\
4.4 & 3.0 & 1.3 & 0.2 & setosa\\
4.4 & 3.2 & 1.3 & 0.2 & setosa\\
4.5 & 2.3 & 1.3 & 0.3 & setosa\\
\addlinespace
4.6 & 3.1 & 1.5 & 0.2 & setosa\\
\bottomrule
\end{tabular}
\end{table}

\hypertarget{chap-advanced-manipulation}{%
\chapter{高级数据操作}\label{chap-advanced-manipulation}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\end{Highlighting}
\end{Shaded}

介绍 data.table 处理数据的方式，对标 dplyr 的基本操作

\hypertarget{intro}{%
\section{基础介绍}\label{intro}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 用一个真实的数据集替换，让每一个操作都有实际含义和价值 mtcars}
\NormalTok{DT }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"b"}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{"c"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{),}
  \AttributeTok{v =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{6}\NormalTok{), }\AttributeTok{a =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{, }\AttributeTok{b =} \DecValTok{9}\SpecialCharTok{:}\DecValTok{1}
\NormalTok{)}
\NormalTok{DT}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v y a b
## 1: b 1 1 1 9
## 2: b 1 3 2 8
## 3: b 1 6 3 7
## 4: a 2 1 4 6
## 5: a 2 3 5 5
## 6: a 1 6 6 4
## 7: c 1 1 7 3
## 8: c 2 3 8 2
## 9: c 2 6 9 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组求和}
\NormalTok{DT[, }\FunctionTok{sum}\NormalTok{(v), by }\OtherTok{=}\NormalTok{ .(y }\SpecialCharTok{\%\%} \DecValTok{2}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    y V1
## 1: 1  9
## 2: 0  4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{sum}\NormalTok{(v), by }\OtherTok{=}\NormalTok{ .(}\AttributeTok{bool =}\NormalTok{ y }\SpecialCharTok{\%\%} \DecValTok{2}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    bool V1
## 1:    1  9
## 2:    0  4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, .SD[}\DecValTok{2}\NormalTok{], by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 每组第二行}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v y a b
## 1: b 1 3 2 8
## 2: a 2 3 5 5
## 3: c 2 3 8 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{tail}\NormalTok{(.SD, }\DecValTok{2}\NormalTok{), by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 每组最后两行}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v y a b
## 1: b 1 3 2 8
## 2: b 1 6 3 7
## 3: a 2 3 5 5
## 4: a 1 6 6 4
## 5: c 2 3 8 2
## 6: c 2 6 9 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 除了 x 列外，所有列都按 x 分组求和}
\NormalTok{DT[, }\FunctionTok{lapply}\NormalTok{(.SD, sum), by }\OtherTok{=}\NormalTok{ x]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v  y  a  b
## 1: b 3 10  6 24
## 2: a 5 10 15 15
## 3: c 5 10 24  6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 各个列都按 x 分组取最小}
\NormalTok{DT[, .SD[}\FunctionTok{which.min}\NormalTok{(v)], by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 分组嵌套查询}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x v y a b
## 1: b 1 1 1 9
## 2: a 1 6 6 4
## 3: c 1 1 7 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{list}\NormalTok{(}\AttributeTok{MySum =} \FunctionTok{sum}\NormalTok{(v), }\AttributeTok{MyMin =} \FunctionTok{min}\NormalTok{(v), }\AttributeTok{MyMax =} \FunctionTok{max}\NormalTok{(v)), by }\OtherTok{=}\NormalTok{ .(x, y }\SpecialCharTok{\%\%} \DecValTok{2}\NormalTok{)] }\CommentTok{\# 表达式嵌套}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y MySum MyMin MyMax
## 1: b 1     2     1     1
## 2: b 0     1     1     1
## 3: a 1     4     2     2
## 4: a 0     1     1     1
## 5: c 1     3     1     2
## 6: c 0     2     2     2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, .(}\AttributeTok{a =}\NormalTok{ .(a), }\AttributeTok{b =}\NormalTok{ .(b)), by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 按 x 分组，将 a,b 两列的值列出来}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x     a     b
## 1: b 1,2,3 9,8,7
## 2: a 4,5,6 6,5,4
## 3: c 7,8,9 3,2,1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, .(}\AttributeTok{seq =} \FunctionTok{min}\NormalTok{(a)}\SpecialCharTok{:}\FunctionTok{max}\NormalTok{(b)), by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 列操作不仅仅是聚合}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     x seq
##  1: b   1
##  2: b   2
##  3: b   3
##  4: b   4
##  5: b   5
##  6: b   6
##  7: b   7
##  8: b   8
##  9: b   9
## 10: a   4
## 11: a   5
## 12: a   6
## 13: c   7
## 14: c   6
## 15: c   5
## 16: c   4
## 17: c   3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 按 x 分组对 v 求和，然后过滤出和小于 20 的行}
\NormalTok{DT[, }\FunctionTok{sum}\NormalTok{(v), by }\OtherTok{=}\NormalTok{ x][V1 }\SpecialCharTok{\textless{}} \DecValTok{20}\NormalTok{] }\CommentTok{\# 组合查询}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x V1
## 1: b  3
## 2: a  5
## 3: c  5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{sum}\NormalTok{(v), by }\OtherTok{=}\NormalTok{ x][}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{V1)] }\CommentTok{\# 对结果排序}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x V1
## 1: a  5
## 2: c  5
## 3: b  3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, }\FunctionTok{c}\NormalTok{(.N, }\FunctionTok{lapply}\NormalTok{(.SD, sum)), by }\OtherTok{=}\NormalTok{ x] }\CommentTok{\# 计算每一组的和，每一组的观测数}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x N v  y  a  b
## 1: b 3 3 10  6 24
## 2: a 3 5 10 15 15
## 3: c 3 5 10 24  6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 两个复杂的操作，还没弄清楚这个技术存在的意义}
\NormalTok{DT[,}
\NormalTok{  \{}
\NormalTok{    tmp }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(y)}
\NormalTok{    .(}\AttributeTok{a =}\NormalTok{ a }\SpecialCharTok{{-}}\NormalTok{ tmp, }\AttributeTok{b =}\NormalTok{ b }\SpecialCharTok{{-}}\NormalTok{ tmp)}
\NormalTok{  \},}
\NormalTok{  by }\OtherTok{=}\NormalTok{ x}
\NormalTok{] }\CommentTok{\# anonymous lambda in \textquotesingle{}j\textquotesingle{}, j accepts any valid}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x          a          b
## 1: b -2.3333333  5.6666667
## 2: b -1.3333333  4.6666667
## 3: b -0.3333333  3.6666667
## 4: a  0.6666667  2.6666667
## 5: a  1.6666667  1.6666667
## 6: a  2.6666667  0.6666667
## 7: c  3.6666667 -0.3333333
## 8: c  4.6666667 -1.3333333
## 9: c  5.6666667 -2.3333333
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# using rleid, get max(y) and min of all cols in .SDcols for each consecutive run of \textquotesingle{}v\textquotesingle{}}
\NormalTok{DT[, }\FunctionTok{c}\NormalTok{(.(}\AttributeTok{y =} \FunctionTok{max}\NormalTok{(y)), }\FunctionTok{lapply}\NormalTok{(.SD, min)), by }\OtherTok{=} \FunctionTok{rleid}\NormalTok{(v), .SDcols }\OtherTok{=}\NormalTok{ v}\SpecialCharTok{:}\NormalTok{b]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    rleid y v y a b
## 1:     1 6 1 1 1 7
## 2:     2 3 2 1 4 5
## 3:     3 6 1 1 6 3
## 4:     4 6 2 3 8 1
\end{verbatim}

\hypertarget{subsec-filter-i}{%
\subsection{过滤}\label{subsec-filter-i}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

过滤 cyl = 6 并且 gear = 4 的记录

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

过滤操作是针对数据框的行（记录）

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{, .(mpg, disp)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg  disp
## 1: 21.0 160.0
## 2: 21.0 160.0
## 3: 19.2 167.6
## 4: 17.8 167.6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mtcars\_df, }\AttributeTok{subset =}\NormalTok{ cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(mpg, disp))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg  disp
## 1: 21.0 160.0
## 2: 21.0 160.0
## 3: 19.2 167.6
## 4: 17.8 167.6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, disp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                mpg  disp
## Mazda RX4     21.0 160.0
## Mazda RX4 Wag 21.0 160.0
## Merc 280      19.2 167.6
## Merc 280C     17.8 167.6
\end{verbatim}

\hypertarget{subsec-mutate-j}{%
\subsection{变换}\label{subsec-mutate-j}}

根据已有的列生成新的列，或者修改已有的列，一次只能修改一列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, mean\_mpg }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{mean}\NormalTok{(mpg)][, mean\_disp }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{mean}\NormalTok{(disp)]}
\NormalTok{mtcars\_df[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl disp  hp drat    wt  qsec vs am gear carb mean_mpg mean_disp
## 1: 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 20.09062  230.7219
## 2: 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 20.09062  230.7219
## 3: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 20.09062  230.7219
## 4: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 20.09062  230.7219
## 5: 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 20.09062  230.7219
## 6: 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 20.09062  230.7219
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, .(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_disp =} \FunctionTok{mean}\NormalTok{(disp))]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    mean_mpg mean_disp
## 1: 20.09062  230.7219
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# mtcars\_df[, .(mean\_mpg := mean(mpg), mean\_disp := mean(disp))] \# 报错}
\CommentTok{\# 正确的姿势}
\NormalTok{mtcars\_df[, }\StringTok{\textasciigrave{}}\AttributeTok{:=}\StringTok{\textasciigrave{}}\NormalTok{(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_disp =} \FunctionTok{mean}\NormalTok{(disp))][, .(mpg, disp, mean\_mpg, mean\_disp)] }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg disp mean_mpg mean_disp
## 1: 21.0  160 20.09062  230.7219
## 2: 21.0  160 20.09062  230.7219
## 3: 22.8  108 20.09062  230.7219
## 4: 21.4  258 20.09062  230.7219
## 5: 18.7  360 20.09062  230.7219
## 6: 18.1  225 20.09062  230.7219
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_disp =} \FunctionTok{mean}\NormalTok{(disp))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   mean_mpg mean_disp
## 1 20.09062  230.7219
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_disp =} \FunctionTok{mean}\NormalTok{(disp)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, disp, mean\_mpg, mean\_disp) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    mpg disp mean_mpg mean_disp
## Mazda RX4         21.0  160 20.09062  230.7219
## Mazda RX4 Wag     21.0  160 20.09062  230.7219
## Datsun 710        22.8  108 20.09062  230.7219
## Hornet 4 Drive    21.4  258 20.09062  230.7219
## Hornet Sportabout 18.7  360 20.09062  230.7219
## Valiant           18.1  225 20.09062  230.7219
\end{verbatim}

\hypertarget{subsec-summarise-j}{%
\subsection{聚合}\label{subsec-summarise-j}}

分组统计 多个分组变量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dcast}\NormalTok{(mtcars\_df, cyl }\SpecialCharTok{\textasciitilde{}}\NormalTok{ gear, }\AttributeTok{value.var =} \StringTok{"mpg"}\NormalTok{, }\AttributeTok{fun =}\NormalTok{ mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl     3      4    5
## 1:   4 21.50 26.925 28.2
## 2:   6 19.75 19.750 19.7
## 3:   8 15.05    NaN 15.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tapply}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{mpg, }\FunctionTok{list}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{cyl, mtcars}\SpecialCharTok{$}\NormalTok{gear), mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       3      4    5
## 4 21.50 26.925 28.2
## 6 19.75 19.750 19.7
## 8 15.05     NA 15.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, .(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg)), by }\OtherTok{=}\NormalTok{ .(cyl, gear)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear mean_mpg
## 1:   6    4   19.750
## 2:   4    4   26.925
## 3:   6    3   19.750
## 4:   8    3   15.050
## 5:   4    3   21.500
## 6:   4    5   28.200
## 7:   8    5   15.400
## 8:   6    5   19.700
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ mtcars\_df, mpg }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl }\SpecialCharTok{+}\NormalTok{ gear, }\AttributeTok{FUN =}\NormalTok{ mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   cyl gear    mpg
## 1   4    3 21.500
## 2   6    3 19.750
## 3   8    3 15.050
## 4   4    4 26.925
## 5   6    4 19.750
## 6   4    5 28.200
## 7   6    5 19.700
## 8   8    5 15.400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(cyl, gear) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 8 x 3
## # Groups:   cyl [3]
##     cyl  gear mean_mpg
##   <dbl> <dbl>    <dbl>
## 1     4     3     21.5
## 2     4     4     26.9
## 3     4     5     28.2
## 4     6     3     19.8
## 5     6     4     19.8
## 6     6     5     19.7
## 7     8     3     15.0
## 8     8     5     15.4
\end{verbatim}

\hypertarget{subsec-setname}{%
\subsection{命名}\label{subsec-setname}}

修改列名，另存一份生效

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sub\_mtcars\_df }\OtherTok{\textless{}{-}}\NormalTok{ mtcars\_df[, .(}\AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg)), by }\OtherTok{=}\NormalTok{ .(cyl, gear)]}
\FunctionTok{setNames}\NormalTok{(sub\_mtcars\_df, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{, }\StringTok{"ave\_mpg"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear ave_mpg
## 1:   6    4  19.750
## 2:   4    4  26.925
## 3:   6    3  19.750
## 4:   8    3  15.050
## 5:   4    3  21.500
## 6:   4    5  28.200
## 7:   8    5  15.400
## 8:   6    5  19.700
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 注意 sub\_mtcars\_df 并没有修改列名}
\NormalTok{sub\_mtcars\_df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear mean_mpg
## 1:   6    4   19.750
## 2:   4    4   26.925
## 3:   6    3   19.750
## 4:   8    3   15.050
## 5:   4    3   21.500
## 6:   4    5   28.200
## 7:   8    5   15.400
## 8:   6    5   19.700
\end{verbatim}

修改列名并直接起作用，在原来的数据集上生效

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{setnames}\NormalTok{(sub\_mtcars\_df, }\AttributeTok{old =} \FunctionTok{c}\NormalTok{(}\StringTok{"mean\_mpg"}\NormalTok{), }\AttributeTok{new =} \FunctionTok{c}\NormalTok{(}\StringTok{"ave\_mpg"}\NormalTok{))}
\CommentTok{\# sub\_mtcars\_df 已经修改了列名}
\NormalTok{sub\_mtcars\_df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear ave_mpg
## 1:   6    4  19.750
## 2:   4    4  26.925
## 3:   6    3  19.750
## 4:   8    3  15.050
## 5:   4    3  21.500
## 6:   4    5  28.200
## 7:   8    5  15.400
## 8:   6    5  19.700
\end{verbatim}

修改列名最好使用 \textbf{data.table} 包的函数 \texttt{setnames()} 明确指出了要修改的列名，

\hypertarget{subsec-order-by-j}{%
\subsection{排序}\label{subsec-order-by-j}}

按照某（些）列从大到小或从小到大的顺序排列， 先按 cyl 升序，然后按 gear 降序

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars\_df[, .(mpg, cyl, gear)][cyl }\SpecialCharTok{==} \DecValTok{4}\NormalTok{][}\FunctionTok{order}\NormalTok{(cyl, }\SpecialCharTok{{-}}\NormalTok{gear)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      mpg cyl gear
##  1: 26.0   4    5
##  2: 30.4   4    5
##  3: 22.8   4    4
##  4: 24.4   4    4
##  5: 22.8   4    4
##  6: 32.4   4    4
##  7: 30.4   4    4
##  8: 33.9   4    4
##  9: 27.3   4    4
## 10: 21.4   4    4
## 11: 21.5   4    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mpg, cyl, gear) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(cyl }\SpecialCharTok{==} \DecValTok{4}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(cyl, }\FunctionTok{desc}\NormalTok{(gear))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                 mpg cyl gear
## Porsche 914-2  26.0   4    5
## Lotus Europa   30.4   4    5
## Datsun 710     22.8   4    4
## Merc 240D      24.4   4    4
## Merc 230       22.8   4    4
## Fiat 128       32.4   4    4
## Honda Civic    30.4   4    4
## Toyota Corolla 33.9   4    4
## Fiat X1-9      27.3   4    4
## Volvo 142E     21.4   4    4
## Toyota Corona  21.5   4    3
\end{verbatim}

\hypertarget{subsec-reshape}{%
\subsection{变形}\label{subsec-reshape}}

melt 宽的变长的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}
  \AttributeTok{i\_1 =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\ConstantTok{NA}\NormalTok{),}
  \AttributeTok{i\_2 =} \FunctionTok{c}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{10}\NormalTok{),}
  \AttributeTok{f\_1 =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{sample}\NormalTok{(}\FunctionTok{c}\NormalTok{(letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\ConstantTok{NA}\NormalTok{), }\DecValTok{6}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{)),}
  \AttributeTok{f\_2 =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"z"}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"x"}\NormalTok{), }\AttributeTok{ordered =} \ConstantTok{TRUE}\NormalTok{),}
  \AttributeTok{c\_1 =} \FunctionTok{sample}\NormalTok{(}\FunctionTok{c}\NormalTok{(letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{], }\ConstantTok{NA}\NormalTok{), }\DecValTok{6}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{),}
  \AttributeTok{d\_1 =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\DecValTok{4}\SpecialCharTok{:}\DecValTok{5}\NormalTok{), }\AttributeTok{origin =} \StringTok{"2013{-}09{-}01"}\NormalTok{),}
  \AttributeTok{d\_2 =} \FunctionTok{as.Date}\NormalTok{(}\DecValTok{6}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\AttributeTok{origin =} \StringTok{"2012{-}01{-}01"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{DT[, .(i\_1, i\_2, f\_1, f\_2)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    i_1 i_2  f_1 f_2
## 1:   1  NA    c   z
## 2:   2   6 <NA>   a
## 3:   3   7    b   x
## 4:   4   8    b   c
## 5:   5   9 <NA>   x
## 6:  NA  10    b   x
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{melt}\NormalTok{(DT, }\AttributeTok{id =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\AttributeTok{measure =} \FunctionTok{c}\NormalTok{(}\StringTok{"f\_1"}\NormalTok{, }\StringTok{"f\_2"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     i_1 i_2 variable value
##  1:   1  NA      f_1     c
##  2:   2   6      f_1  <NA>
##  3:   3   7      f_1     b
##  4:   4   8      f_1     b
##  5:   5   9      f_1  <NA>
##  6:  NA  10      f_1     b
##  7:   1  NA      f_2     z
##  8:   2   6      f_2     a
##  9:   3   7      f_2     x
## 10:   4   8      f_2     c
## 11:   5   9      f_2     x
## 12:  NA  10      f_2     x
\end{verbatim}

dcast 长的变宽的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sleep }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(sleep)}
\FunctionTok{dcast}\NormalTok{(sleep, group }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ID, }\AttributeTok{value.var =} \StringTok{"extra"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group   1    2    3    4    5   6   7   8   9  10
## 1:     1 0.7 -1.6 -0.2 -1.2 -0.1 3.4 3.7 0.8 0.0 2.0
## 2:     2 1.9  0.8  1.1  0.1 -0.1 4.4 5.5 1.6 4.6 3.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 如果有多个值}
\FunctionTok{dcast}\NormalTok{(mtcars\_df, cyl }\SpecialCharTok{\textasciitilde{}}\NormalTok{ gear, }\AttributeTok{value.var =} \StringTok{"mpg"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl  3 4 5
## 1:   4  1 8 2
## 2:   6  2 4 1
## 3:   8 12 0 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dcast}\NormalTok{(mtcars\_df, cyl }\SpecialCharTok{\textasciitilde{}}\NormalTok{ gear, }\AttributeTok{value.var =} \StringTok{"mpg"}\NormalTok{, }\AttributeTok{fun =}\NormalTok{ mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl     3      4    5
## 1:   4 21.50 26.925 28.2
## 2:   6 19.75 19.750 19.7
## 3:   8 15.05    NaN 15.4
\end{verbatim}

tidyr 包提供数据变形的函数 \texttt{tidyr::pivot\_longer()} 和 \texttt{tidyr::pivot\_wider()} 相比于 Base R 提供的 \texttt{reshape()} 和 data.table 提供的 \texttt{melt()} 和 \texttt{dcast()} 更加形象的命名

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sleep, }\AttributeTok{names\_from =} \StringTok{"ID"}\NormalTok{, }\AttributeTok{values\_from =} \StringTok{"extra"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 11
##   group   `1`   `2`   `3`   `4`   `5`   `6`   `7`   `8`   `9`  `10`
##   <fct> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1 1       0.7  -1.6  -0.2  -1.2  -0.1   3.4   3.7   0.8   0     2  
## 2 2       1.9   0.8   1.1   0.1  -0.1   4.4   5.5   1.6   4.6   3.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sleep, }\AttributeTok{v.names =} \StringTok{"extra"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"group"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"ID"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    group extra.1 extra.2 extra.3 extra.4 extra.5 extra.6 extra.7 extra.8
## 1:     1     0.7    -1.6    -0.2    -1.2    -0.1     3.4     3.7     0.8
## 2:     2     1.9     0.8     1.1     0.1    -0.1     4.4     5.5     1.6
##    extra.9 extra.10
## 1:     0.0      2.0
## 2:     4.6      3.4
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{idvar} 分组变量
\item
  \texttt{timevar} 组内编号
\item
  \texttt{v.names} 个体观察值
\item
  \texttt{sep} 新的列名是由参数 \texttt{v.names} (extra) 和参数值 \texttt{timevar} (ID) 拼接起来的，默认 \texttt{sep\ =\ "."} 推荐使用下划线来做分割 \texttt{sep\ =\ "\_"}
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(ToothGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    len supp dose
## 1  4.2   VC  0.5
## 2 11.5   VC  0.5
## 3  7.3   VC  0.5
## 4  5.8   VC  0.5
## 5  6.4   VC  0.5
## 6 10.0   VC  0.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ToothGrowth}\SpecialCharTok{$}\NormalTok{time }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\FunctionTok{reshape}\NormalTok{(ToothGrowth,}
  \AttributeTok{v.names =} \StringTok{"len"}\NormalTok{, }\AttributeTok{idvar =} \FunctionTok{c}\NormalTok{(}\StringTok{"supp"}\NormalTok{, }\StringTok{"dose"}\NormalTok{),}
  \AttributeTok{timevar =} \StringTok{"time"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    supp dose len.1 len.2 len.3 len.4 len.5 len.6 len.7 len.8 len.9 len.10
## 1    VC  0.5   4.2  11.5   7.3   5.8   6.4  10.0  11.2  11.2   5.2    7.0
## 11   VC  1.0  16.5  16.5  15.2  17.3  22.5  17.3  13.6  14.5  18.8   15.5
## 21   VC  2.0  23.6  18.5  33.9  25.5  26.4  32.5  26.7  21.5  23.3   29.5
## 31   OJ  0.5  15.2  21.5  17.6   9.7  14.5  10.0   8.2   9.4  16.5    9.7
## 41   OJ  1.0  19.7  23.3  23.6  26.4  20.0  25.2  25.8  21.2  14.5   27.3
## 51   OJ  2.0  25.5  26.4  22.4  24.5  24.8  30.9  26.4  27.3  29.4   23.0
\end{verbatim}

以数据集 ToothGrowth 为例，变量 supp（大组），dose（小组） 和 time（组内个体编号） 一起决定唯一的一个数据 len，特别适合纵向数据的变形操作

\hypertarget{subsec-group-by}{%
\subsection{分组}\label{subsec-group-by}}

分组切片，取每组第一个和最后一个值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Loblolly }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(Seed) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(height, age, Seed) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(}\DecValTok{1}\NormalTok{, dplyr}\SpecialCharTok{::}\FunctionTok{n}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 28 x 3
## # Groups:   Seed [14]
##    height   age Seed 
##     <dbl> <dbl> <ord>
##  1   3.93     3 329  
##  2  56.4     25 329  
##  3   4.12     3 327  
##  4  56.8     25 327  
##  5   4.38     3 325  
##  6  58.5     25 325  
##  7   3.91     3 307  
##  8  59.1     25 307  
##  9   3.46     3 331  
## 10  59.5     25 331  
## # ... with 18 more rows
\end{verbatim}

\texttt{dplyr::slice()} 和函数 \texttt{slice.index()} 有关系吗？

\hypertarget{subsec-merge}{%
\subsection{合并}\label{subsec-merge}}

合并操作对应于数据库中的连接操作， dplyr 包的哲学就来源于对数据库操作的进一步抽象， data.table 包的 merge 函数就对应为 dplyr 包的 join 函数

\texttt{data.table::merge} 和 \texttt{dplyr::join}

给出一个表格，数据操作， data.table 实现， dplyr 实现

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dt1 }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}\AttributeTok{A =}\NormalTok{ letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{], }\AttributeTok{X =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{key =} \StringTok{"A"}\NormalTok{)}
\NormalTok{dt2 }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}\AttributeTok{A =}\NormalTok{ letters[}\DecValTok{5}\SpecialCharTok{:}\DecValTok{14}\NormalTok{], }\AttributeTok{Y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{key =} \StringTok{"A"}\NormalTok{)}
\FunctionTok{merge}\NormalTok{(dt1, dt2) }\CommentTok{\# 内连接}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    A  X Y
## 1: e  5 1
## 2: f  6 2
## 3: g  7 3
## 4: h  8 4
## 5: i  9 5
## 6: j 10 6
\end{verbatim}

参数 key 的作用相当于建立一个索引，通过它实现更快的数据操作速度

\texttt{key\ =\ c("x","y","z")} 或者 \texttt{key\ =\ "x,y,z"} 其中 x,y,z 是列名

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(band\_members, band\_instruments, }\AttributeTok{package =} \StringTok{"dplyr"}\NormalTok{)}
\NormalTok{band\_members}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 2
##   name  band   
##   <chr> <chr>  
## 1 Mick  Stones 
## 2 John  Beatles
## 3 Paul  Beatles
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{band\_instruments}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 2
##   name  plays 
##   <chr> <chr> 
## 1 John  guitar
## 2 Paul  bass  
## 3 Keith guitar
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{inner\_join}\NormalTok{(band\_members, band\_instruments)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 3
##   name  band    plays 
##   <chr> <chr>   <chr> 
## 1 John  Beatles guitar
## 2 Paul  Beatles bass
\end{verbatim}

list 列表里每个元素都是 data.frame 时，最适合用 \texttt{data.table::rbindlist} 合并

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 合并列表 https://recology.info/2018/10/limiting{-}dependencies/}
\ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  tibble}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{((x }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{setDF}\NormalTok{(}
\NormalTok{    data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(x, }\AttributeTok{use.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{idcol =} \StringTok{"id"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  ))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function(x) {
##   tibble::as_tibble((x <- data.table::setDF(
##     data.table::rbindlist(x, use.names = TRUE, fill = TRUE, idcol = "id")
##   )
##   ))
## }
\end{verbatim}

\hypertarget{chap:data-manipulation}{%
\section{高频操作}\label{chap:data-manipulation}}

以面向问题的方式介绍 Base R 提供的数据操作，然后过渡到 data.table，它是加强版的 Base R。

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:single-table-verbs} 单表的操作}\tabularnewline
\toprule
base & dplyr \\
\midrule
\endfirsthead
\toprule
base & dplyr \\
\midrule
\endhead
\texttt{df{[}order(x),\ ,\ drop\ =\ FALSE{]}} & \texttt{arrange(df,\ x)} \\
\texttt{df{[}!duplicated(x),\ ,\ drop\ =\ FALSE{]}}, \texttt{unique()} & \texttt{distinct(df,\ x)} \\
\texttt{df{[}x\ \&\ !is.na(x),\ ,\ drop\ =\ FALSE{]}}, \texttt{subset()} & \texttt{filter(df,\ x)} \\
\texttt{df\$z\ \textless{}-\ df\$x\ +\ df\$y}, \texttt{transform()} & \texttt{mutate(df,\ z\ =\ x\ +\ y)} \\
\texttt{df\$x} & \texttt{pull(df,\ x)} \\
N/A & \texttt{rename(df,\ y\ =\ x)} \\
\texttt{df{[}c("x",\ "y"){]}}, \texttt{subset()} & \texttt{select(df,\ x,\ y)} \\
\texttt{df{[}grepl(names(df),\ "\^{}x"){]}} & \texttt{select(df,\ starts\_with("x")} \\
\texttt{mean(df\$x)} & \texttt{summarise(df,\ mean(x))} \\
\texttt{df{[}c(1,\ 2,\ 5),\ ,\ drop\ =\ FALSE{]}} & \texttt{slice(df,\ c(1,\ 2,\ 5))} \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:two-table-verbs} 两表的操作}\tabularnewline
\toprule
base & dplyr \\
\midrule
\endfirsthead
\toprule
base & dplyr \\
\midrule
\endhead
\texttt{merge(df1,\ df2)} & \texttt{inner\_join(df1,\ df2)} \\
\texttt{merge(df1,\ df2,\ all.x\ =\ TRUE)} & \texttt{left\_join(df1,\ df2)} \\
\texttt{merge(df1,\ df2,\ all.y\ =\ TRUE)} & \texttt{right\_join(df1,\ df2)} \\
\texttt{merge(df1,\ df2,\ all\ =\ TRUE)} & \texttt{full\_join(df1,\ df2)} \\
\texttt{df1{[}df1\$x\ \%in\%\ df2\$x,\ ,\ drop\ =\ FALSE{]}} & \texttt{semi\_join(df1,\ df2)} \\
\texttt{df1{[}!df1\$x\ \%in\%\ df2\$x,\ ,\ drop\ =\ FALSE{]}} & \texttt{anti\_join(df1,\ df2)} \\
\bottomrule
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{mtcars }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(mtcars)}
\FunctionTok{class}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.table" "data.frame"
\end{verbatim}

\hypertarget{sec-select}{%
\subsection{选择多列}\label{sec-select}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\NormalTok{mtcars[, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)] }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\NormalTok{mtcars[, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)] }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(mtcars, cyl, gear) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl gear
## 1:   6    4
## 2:   6    4
## 3:   4    4
\end{verbatim}

反选多列，选择除了 cyl 和 gear 的列

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 或者 mtcars[, setdiff(names(mtcars), c("cyl", "gear"))]}
\NormalTok{mtcars[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{names}\NormalTok{(mtcars) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{))] }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  TRUE FALSE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(mtcars, }\AttributeTok{select =} \SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(cyl, gear)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{head}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg disp  hp drat    wt  qsec vs am carb
## 1: 21.0  160 110 3.90 2.620 16.46  0  1    4
## 2: 21.0  160 110 3.90 2.875 17.02  0  1    4
## 3: 22.8  108  93 3.85 2.320 18.61  1  1    1
\end{verbatim}

\hypertarget{sec-filter}{%
\subsection{过滤多行}\label{sec-filter}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\NormalTok{mtcars[mtcars}\SpecialCharTok{$}\NormalTok{cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ mtcars}\SpecialCharTok{$}\NormalTok{gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{subset}\NormalTok{(mtcars, }\AttributeTok{subset =}\NormalTok{ cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\NormalTok{mtcars[cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(mtcars, cyl }\SpecialCharTok{==} \DecValTok{6} \SpecialCharTok{\&}\NormalTok{ gear }\SpecialCharTok{==} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
\end{verbatim}

\hypertarget{sec-duplicated}{%
\subsection{去重多行}\label{sec-duplicated}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\NormalTok{mtcars[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(mtcars[, }\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)])]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\NormalTok{mtcars[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(mtcars, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{)), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unique}\NormalTok{(mtcars, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"gear"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(mtcars, cyl, gear, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 3: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 5: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 6: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 7: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 8: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
\end{verbatim}

\hypertarget{sec-merge}{%
\subsection{合并操作}\label{sec-merge}}

在数据库的操作中，合并又称为连接

\hypertarget{subsec-left-join}{%
\subsubsection{左合并}\label{subsec-left-join}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr::inner\_join()}
\CommentTok{\# dplyr::left\_join()}
\CommentTok{\# dplyr::right\_join()}
\CommentTok{\# dplyr::full\_join()}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-right-join}{%
\subsubsection{右合并}\label{subsec-right-join}}

\hypertarget{sec-add-columns}{%
\subsection{新添多列}\label{sec-add-columns}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[cyl }\SpecialCharTok{==} \DecValTok{6}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{:=}\StringTok{\textasciigrave{}}\NormalTok{(}\AttributeTok{disp\_mean =} \FunctionTok{mean}\NormalTok{(disp), }\AttributeTok{hp\_mean =} \FunctionTok{mean}\NormalTok{(hp))][cyl }\SpecialCharTok{==} \DecValTok{6}\NormalTok{, .(cyl, disp, hp, disp\_mean, hp\_mean)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl  disp  hp disp_mean  hp_mean
## 1:   6 160.0 110  183.3143 122.2857
## 2:   6 160.0 110  183.3143 122.2857
## 3:   6 258.0 110  183.3143 122.2857
## 4:   6 225.0 105  183.3143 122.2857
## 5:   6 167.6 123  183.3143 122.2857
## 6:   6 167.6 123  183.3143 122.2857
## 7:   6 145.0 175  183.3143 122.2857
\end{verbatim}

\hypertarget{sec-delete-columns}{%
\subsection{删除多列}\label{sec-delete-columns}}

删除列就是将该列的值清空，置为 NULL，下面将新添的两个列删除，根据列名的特点用正则表达式匹配

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[, }\FunctionTok{colnames}\NormalTok{(mtcars)[}\FunctionTok{grep}\NormalTok{(}\StringTok{"\_mean$"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(mtcars))] }\SpecialCharTok{:}\ErrorTok{=} \ConstantTok{NULL}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-select-columns}{%
\subsection{筛选多列}\label{sec-select-columns}}

按照某一规则筛选多列

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{iris }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(iris)}
\NormalTok{iris[, }\FunctionTok{head}\NormalTok{(.SD, }\DecValTok{6}\NormalTok{), .SDcols }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{is.numeric}\NormalTok{(x)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:          5.1         3.5          1.4         0.2
## 2:          4.9         3.0          1.4         0.2
## 3:          4.7         3.2          1.3         0.2
## 4:          4.6         3.1          1.5         0.2
## 5:          5.0         3.6          1.4         0.2
## 6:          5.4         3.9          1.7         0.4
\end{verbatim}

\hypertarget{sec-modify-columns-type}{%
\subsection{修改多列类型}\label{sec-modify-columns-type}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[, (}\FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"disp"}\NormalTok{)) }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{lapply}\NormalTok{(.SD, as.integer), .SDcols }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{"cyl"}\NormalTok{, }\StringTok{"disp"}\NormalTok{)]}
\FunctionTok{str}\NormalTok{(mtcars)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Classes 'data.table' and 'data.frame':   32 obs. of  11 variables:
##  $ mpg : num  21 21 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 ...
##  $ cyl : int  6 6 4 6 8 6 8 4 4 6 ...
##  $ disp: int  160 160 108 258 360 225 360 146 140 167 ...
##  $ hp  : num  110 110 93 110 175 105 245 62 95 123 ...
##  $ drat: num  3.9 3.9 3.85 3.08 3.15 2.76 3.21 3.69 3.92 3.92 ...
##  $ wt  : num  2.62 2.88 2.32 3.21 3.44 ...
##  $ qsec: num  16.5 17 18.6 19.4 17 ...
##  $ vs  : num  0 0 1 1 0 1 0 1 1 1 ...
##  $ am  : num  1 1 1 0 0 0 0 0 0 0 ...
##  $ gear: num  4 4 4 3 3 3 3 4 4 4 ...
##  $ carb: num  4 4 1 1 2 1 4 2 2 4 ...
##  - attr(*, ".internal.selfref")=<externalptr> 
##  - attr(*, "index")= int(0)
\end{verbatim}

\hypertarget{sec-select-first-row}{%
\subsection{取每组第一行}\label{sec-select-first-row}}

先将 mtcars 按 cyl 升序，gear 降序排列，然后按 cyl, gear 和 am 分组取第一行

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[}\FunctionTok{order}\NormalTok{(cyl, }\SpecialCharTok{{-}}\NormalTok{gear)][, }\FunctionTok{head}\NormalTok{(.SD, }\DecValTok{1}\NormalTok{), by }\OtherTok{=} \FunctionTok{list}\NormalTok{(cyl, gear, am)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cyl gear am  mpg disp  hp drat    wt  qsec vs carb
##  1:   4    5  1 26.0  120  91 4.43 2.140 16.70  0    2
##  2:   4    4  1 22.8  108  93 3.85 2.320 18.61  1    1
##  3:   4    4  0 24.4  146  62 3.69 3.190 20.00  1    2
##  4:   4    3  0 21.5  120  97 3.70 2.465 20.01  1    1
##  5:   6    5  1 19.7  145 175 3.62 2.770 15.50  0    6
##  6:   6    4  1 21.0  160 110 3.90 2.620 16.46  0    4
##  7:   6    4  0 19.2  167 123 3.92 3.440 18.30  1    4
##  8:   6    3  0 21.4  258 110 3.08 3.215 19.44  1    1
##  9:   8    5  1 15.8  351 264 4.22 3.170 14.50  0    4
## 10:   8    3  0 18.7  360 175 3.15 3.440 17.02  0    2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或者}
\NormalTok{mtcars[}\FunctionTok{order}\NormalTok{(cyl, }\SpecialCharTok{{-}}\NormalTok{gear)][, .SD[}\DecValTok{1}\NormalTok{], by }\OtherTok{=} \FunctionTok{list}\NormalTok{(cyl, gear, am)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cyl gear am  mpg disp  hp drat    wt  qsec vs carb
##  1:   4    5  1 26.0  120  91 4.43 2.140 16.70  0    2
##  2:   4    4  1 22.8  108  93 3.85 2.320 18.61  1    1
##  3:   4    4  0 24.4  146  62 3.69 3.190 20.00  1    2
##  4:   4    3  0 21.5  120  97 3.70 2.465 20.01  1    1
##  5:   6    5  1 19.7  145 175 3.62 2.770 15.50  0    6
##  6:   6    4  1 21.0  160 110 3.90 2.620 16.46  0    4
##  7:   6    4  0 19.2  167 123 3.92 3.440 18.30  1    4
##  8:   6    3  0 21.4  258 110 3.08 3.215 19.44  1    1
##  9:   8    5  1 15.8  351 264 4.22 3.170 14.50  0    4
## 10:   8    3  0 18.7  360 175 3.15 3.440 17.02  0    2
\end{verbatim}

\hypertarget{subsec-mom-vs-yoy}{%
\subsection{计算环比同比}\label{subsec-mom-vs-yoy}}

以数据集 AirPassengers 为例，重新整理后见表 \ref{tab:air-passengers}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{year =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}\NormalTok{, }\AttributeTok{each =} \DecValTok{12}\NormalTok{),}
  \AttributeTok{month =}\NormalTok{ month.abb, }\AttributeTok{num =}\NormalTok{ AirPassengers}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{reshape}\NormalTok{(.,}
    \AttributeTok{v.names =} \StringTok{"num"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"year"}\NormalTok{, }\AttributeTok{timevar =} \StringTok{"month"}\NormalTok{,}
    \AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{setNames}\NormalTok{(., }\FunctionTok{gsub}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"(num)"}\NormalTok{, }\AttributeTok{replacement =} \StringTok{""}\NormalTok{, }\AttributeTok{x =} \FunctionTok{colnames}\NormalTok{(.)))}

\FunctionTok{rownames}\NormalTok{(dat) }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(dat, }\AttributeTok{select =}\NormalTok{ year, }\AttributeTok{drop =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{air\_passengers }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(dat, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{year)}

\NormalTok{knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(air\_passengers,}
  \AttributeTok{caption =} \StringTok{"1949{-}1960年国际航班乘客数量变化"}\NormalTok{,}
  \AttributeTok{align =} \StringTok{"c"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:air-passengers}1949-1960年国际航班乘客数量变化}
\centering
\begin{tabular}[t]{l|c|c|c|c|c|c|c|c|c|c|c|c}
\hline
  & Jan & Feb & Mar & Apr & May & Jun & Jul & Aug & Sep & Oct & Nov & Dec\\
\hline
1949 & 112 & 118 & 132 & 129 & 121 & 135 & 148 & 148 & 136 & 119 & 104 & 118\\
\hline
1950 & 115 & 126 & 141 & 135 & 125 & 149 & 170 & 170 & 158 & 133 & 114 & 140\\
\hline
1951 & 145 & 150 & 178 & 163 & 172 & 178 & 199 & 199 & 184 & 162 & 146 & 166\\
\hline
1952 & 171 & 180 & 193 & 181 & 183 & 218 & 230 & 242 & 209 & 191 & 172 & 194\\
\hline
1953 & 196 & 196 & 236 & 235 & 229 & 243 & 264 & 272 & 237 & 211 & 180 & 201\\
\hline
1954 & 204 & 188 & 235 & 227 & 234 & 264 & 302 & 293 & 259 & 229 & 203 & 229\\
\hline
1955 & 242 & 233 & 267 & 269 & 270 & 315 & 364 & 347 & 312 & 274 & 237 & 278\\
\hline
1956 & 284 & 277 & 317 & 313 & 318 & 374 & 413 & 405 & 355 & 306 & 271 & 306\\
\hline
1957 & 315 & 301 & 356 & 348 & 355 & 422 & 465 & 467 & 404 & 347 & 305 & 336\\
\hline
1958 & 340 & 318 & 362 & 348 & 363 & 435 & 491 & 505 & 404 & 359 & 310 & 337\\
\hline
1959 & 360 & 342 & 406 & 396 & 420 & 472 & 548 & 559 & 463 & 407 & 362 & 405\\
\hline
1960 & 417 & 391 & 419 & 461 & 472 & 535 & 622 & 606 & 508 & 461 & 390 & 432\\
\hline
\end{tabular}
\end{table}

横向计算环比，如1949年2月相比1月增长多少、3月相比2月增长多少，以此类推，就是计算环比？纵向计算同比，如1950年1月相比1949年1月增长多少、1951年相比1950年1月增长多少？

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 环比横向/同比纵向}
\NormalTok{mom }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{diff}\NormalTok{(x, }\AttributeTok{lag =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ x[}\SpecialCharTok{{-}}\FunctionTok{length}\NormalTok{(x)] }\CommentTok{\# month to month}
\CommentTok{\# 格式化输出}
\NormalTok{format\_mom }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{formatC}\NormalTok{(}\FunctionTok{mom}\NormalTok{(x), }\AttributeTok{format =} \StringTok{"f"}\NormalTok{, }\AttributeTok{digits =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(formattable)}
\CommentTok{\# 同比变化}
\NormalTok{air\_passengers }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{apply}\NormalTok{(., }\DecValTok{2}\NormalTok{, format\_mom) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as.data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{formattable}\NormalTok{(., }\FunctionTok{list}\NormalTok{(}
    \AttributeTok{Jan =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"pink"}\NormalTok{),}
    \AttributeTok{Feb =} \FunctionTok{color\_tile}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"springgreen4"}\NormalTok{),}
    \AttributeTok{Mar =}\NormalTok{ percent}
\NormalTok{  ))}

\FunctionTok{library}\NormalTok{(DT)}
\FunctionTok{datatable}\NormalTok{(air\_passengers)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-merge-multi-dfs}{%
\subsection{合并多个数据框}\label{sec-merge-multi-dfs}}

将所有列都保留，以 \texttt{full\_join()} 方式合并

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OtherTok{\textless{}{-}}\NormalTok{ iris[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{)]}
\NormalTok{df2 }\OtherTok{\textless{}{-}}\NormalTok{ iris[}\DecValTok{11}\SpecialCharTok{:}\DecValTok{15}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{)]}
\NormalTok{df3 }\OtherTok{\textless{}{-}}\NormalTok{ iris[}\DecValTok{16}\SpecialCharTok{:}\DecValTok{30}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{5}\NormalTok{)]}
\NormalTok{all\_dfs }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(df1, df2, df3)}
\CommentTok{\# base}
\FunctionTok{Reduce}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x, y, ...) }\FunctionTok{merge}\NormalTok{(x, y, ..., }\AttributeTok{all =} \ConstantTok{TRUE}\NormalTok{), all\_dfs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          4.3  setosa         3.0           NA
##  2:          4.4  setosa          NA           NA
##  3:          4.6  setosa          NA          1.0
##  4:          4.6  setosa          NA          1.0
##  5:          4.7  setosa          NA          1.6
##  6:          4.8  setosa         3.4          1.9
##  7:          4.8  setosa         3.0          1.9
##  8:          4.9  setosa          NA           NA
##  9:          4.9  setosa          NA           NA
## 10:          5.0  setosa          NA          1.6
## 11:          5.0  setosa          NA          1.6
## 12:          5.0  setosa          NA          1.6
## 13:          5.0  setosa          NA          1.6
## 14:          5.1  setosa          NA          1.4
## 15:          5.1  setosa          NA          1.5
## 16:          5.1  setosa          NA          1.5
## 17:          5.1  setosa          NA          1.7
## 18:          5.2  setosa          NA          1.5
## 19:          5.2  setosa          NA          1.4
## 20:          5.4  setosa         3.7          1.3
## 21:          5.4  setosa         3.7          1.7
## 22:          5.7  setosa          NA          1.5
## 23:          5.7  setosa          NA          1.7
## 24:          5.8  setosa         4.0           NA
##     Sepal.Length Species Sepal.Width Petal.Length
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\FunctionTok{Reduce}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x, y, ...) dplyr}\SpecialCharTok{::}\FunctionTok{full\_join}\NormalTok{(x, y, ...), all\_dfs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          5.1  setosa          NA          1.4
##  2:          5.1  setosa          NA          1.5
##  3:          5.1  setosa          NA          1.5
##  4:          5.1  setosa          NA          1.7
##  5:          4.9  setosa          NA           NA
##  6:          4.7  setosa          NA          1.6
##  7:          4.6  setosa          NA          1.0
##  8:          5.0  setosa          NA          1.6
##  9:          5.0  setosa          NA          1.6
## 10:          5.4  setosa         3.7          1.3
## 11:          5.4  setosa         3.7          1.7
## 12:          4.6  setosa          NA          1.0
## 13:          5.0  setosa          NA          1.6
## 14:          5.0  setosa          NA          1.6
## 15:          4.4  setosa          NA           NA
## 16:          4.9  setosa          NA           NA
## 17:          4.8  setosa         3.4          1.9
## 18:          4.8  setosa         3.0          1.9
## 19:          4.3  setosa         3.0           NA
## 20:          5.8  setosa         4.0           NA
## 21:          5.7  setosa          NA          1.5
## 22:          5.7  setosa          NA          1.7
## 23:          5.2  setosa          NA          1.5
## 24:          5.2  setosa          NA          1.4
##     Sepal.Length Species Sepal.Width Petal.Length
\end{verbatim}

合并完应该有30行，为啥只有24行？这是因为 \texttt{merge()} 函数对主键 key 相同的记录会合并，要想不合并，需要调用 \texttt{rbindlist()} 函数 \url{https://d.cosx.org/d/421235}

\texttt{rbind()} 列数相同的两个 data.frame 按行合并，\texttt{cbind()} 行数相同的两个 data.frame 按列合并，\texttt{merge()} 对行、列数没有要求

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rbindlist}\NormalTok{(all\_dfs, }\AttributeTok{fill =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          5.1  setosa          NA           NA
##  2:          4.9  setosa          NA           NA
##  3:          4.7  setosa          NA           NA
##  4:          4.6  setosa          NA           NA
##  5:          5.0  setosa          NA           NA
##  6:          5.4  setosa          NA           NA
##  7:          4.6  setosa          NA           NA
##  8:          5.0  setosa          NA           NA
##  9:          4.4  setosa          NA           NA
## 10:          4.9  setosa          NA           NA
## 11:          5.4  setosa         3.7           NA
## 12:          4.8  setosa         3.4           NA
## 13:          4.8  setosa         3.0           NA
## 14:          4.3  setosa         3.0           NA
## 15:          5.8  setosa         4.0           NA
## 16:          5.7  setosa          NA          1.5
## 17:          5.4  setosa          NA          1.3
## 18:          5.1  setosa          NA          1.4
## 19:          5.7  setosa          NA          1.7
## 20:          5.1  setosa          NA          1.5
## 21:          5.4  setosa          NA          1.7
## 22:          5.1  setosa          NA          1.5
## 23:          4.6  setosa          NA          1.0
## 24:          5.1  setosa          NA          1.7
## 25:          4.8  setosa          NA          1.9
## 26:          5.0  setosa          NA          1.6
## 27:          5.0  setosa          NA          1.6
## 28:          5.2  setosa          NA          1.5
## 29:          5.2  setosa          NA          1.4
## 30:          4.7  setosa          NA          1.6
##     Sepal.Length Species Sepal.Width Petal.Length
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(all\_dfs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Species Sepal.Width Petal.Length
##  1:          5.1  setosa          NA           NA
##  2:          4.9  setosa          NA           NA
##  3:          4.7  setosa          NA           NA
##  4:          4.6  setosa          NA           NA
##  5:          5.0  setosa          NA           NA
##  6:          5.4  setosa          NA           NA
##  7:          4.6  setosa          NA           NA
##  8:          5.0  setosa          NA           NA
##  9:          4.4  setosa          NA           NA
## 10:          4.9  setosa          NA           NA
## 11:          5.4  setosa         3.7           NA
## 12:          4.8  setosa         3.4           NA
## 13:          4.8  setosa         3.0           NA
## 14:          4.3  setosa         3.0           NA
## 15:          5.8  setosa         4.0           NA
## 16:          5.7  setosa          NA          1.5
## 17:          5.4  setosa          NA          1.3
## 18:          5.1  setosa          NA          1.4
## 19:          5.7  setosa          NA          1.7
## 20:          5.1  setosa          NA          1.5
## 21:          5.4  setosa          NA          1.7
## 22:          5.1  setosa          NA          1.5
## 23:          4.6  setosa          NA          1.0
## 24:          5.1  setosa          NA          1.7
## 25:          4.8  setosa          NA          1.9
## 26:          5.0  setosa          NA          1.6
## 27:          5.0  setosa          NA          1.6
## 28:          5.2  setosa          NA          1.5
## 29:          5.2  setosa          NA          1.4
## 30:          4.7  setosa          NA          1.6
##     Sepal.Length Species Sepal.Width Petal.Length
\end{verbatim}

\hypertarget{sec-multiple-aggregations}{%
\subsection{分组聚合多个指标}\label{sec-multiple-aggregations}}

\url{https://stackoverflow.com/questions/24151602/calculate-multiple-aggregations-with-lapply-sd}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\FunctionTok{aggregate}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ mtcars, }\FunctionTok{cbind}\NormalTok{(mpg, hp) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl,}
  \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{c}\NormalTok{(}\AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{median =} \FunctionTok{median}\NormalTok{(x))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   cyl mpg.mean mpg.median   hp.mean hp.median
## 1   4 26.66364   26.00000  82.63636  91.00000
## 2   6 19.74286   19.70000 122.28571 110.00000
## 3   8 15.10000   15.20000 209.21429 192.50000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据一致性 https://d.cosx.org/d/420763{-}base{-}r}
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{aggregate}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(mpg, hp) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl, mtcars,}
    \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{c}\NormalTok{(}\AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{median =} \FunctionTok{median}\NormalTok{(x))}
\NormalTok{  ),}
  \FunctionTok{cbind.data.frame}\NormalTok{(cyl, mpg, hp)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   cyl     mean median      mean median
## 1   4 26.66364   26.0  82.63636   91.0
## 2   6 19.74286   19.7 122.28571  110.0
## 3   8 15.10000   15.2 209.21429  192.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\NormalTok{mtcars[, }\FunctionTok{as.list}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(.SD, }\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(x),}
    \AttributeTok{median =} \FunctionTok{median}\NormalTok{(x)}
\NormalTok{  )}
\NormalTok{\}))),}
\NormalTok{by }\OtherTok{=} \StringTok{"cyl"}\NormalTok{, .SDcols }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{"mpg"}\NormalTok{, }\StringTok{"hp"}\NormalTok{)}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl mpg.mean mpg.median   hp.mean hp.median
## 1:   6 19.74286       19.7 122.28571     110.0
## 2:   4 26.66364       26.0  82.63636      91.0
## 3:   8 15.10000       15.2 209.21429     192.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(cyl) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{mean\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{mean\_hp =} \FunctionTok{mean}\NormalTok{(hp),}
    \AttributeTok{median\_mpg =} \FunctionTok{mean}\NormalTok{(mpg), }\AttributeTok{median\_hp =} \FunctionTok{mean}\NormalTok{(hp)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 5
##     cyl mean_mpg mean_hp median_mpg median_hp
##   <int>    <dbl>   <dbl>      <dbl>     <dbl>
## 1     4     26.7    82.6       26.7      82.6
## 2     6     19.7   122.        19.7     122. 
## 3     8     15.1   209.        15.1     209.
\end{verbatim}

\hypertarget{sec-rename-multi-cols}{%
\subsection{重命名多个列}\label{sec-rename-multi-cols}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tmp }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ mtcars, }\FunctionTok{cbind}\NormalTok{(mpg, hp) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cyl,}
  \AttributeTok{FUN =}\NormalTok{ median}
\NormalTok{)}
\NormalTok{tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(tmp)}
\FunctionTok{setnames}\NormalTok{(tmp, }\AttributeTok{old =} \FunctionTok{c}\NormalTok{(}\StringTok{"mpg"}\NormalTok{, }\StringTok{"hp"}\NormalTok{), }\AttributeTok{new =} \FunctionTok{c}\NormalTok{(}\StringTok{"median\_mpg"}\NormalTok{, }\StringTok{"median\_hp"}\NormalTok{))}
\NormalTok{tmp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl median_mpg median_hp
## 1:   4       26.0      91.0
## 2:   6       19.7     110.0
## 3:   8       15.2     192.5
\end{verbatim}

\hypertarget{sec-sort-multi-cols}{%
\subsection{对多个列依次排序}\label{sec-sort-multi-cols}}

\url{https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# base}
\NormalTok{tmp[}\FunctionTok{order}\NormalTok{(median\_mpg, }\SpecialCharTok{{-}}\NormalTok{median\_hp), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl median_mpg median_hp
## 1:   8       15.2     192.5
## 2:   6       19.7     110.0
## 3:   4       26.0      91.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# data.table}
\FunctionTok{setorder}\NormalTok{(tmp, median\_mpg, }\SpecialCharTok{{-}}\NormalTok{median\_hp)}
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(tmp, median\_mpg, }\FunctionTok{desc}\NormalTok{(median\_hp))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    cyl median_mpg median_hp
## 1:   8       15.2     192.5
## 2:   6       19.7     110.0
## 3:   4       26.0      91.0
\end{verbatim}

\hypertarget{sec-rearrange-position-multi-cols}{%
\subsection{重排多个列的位置}\label{sec-rearrange-position-multi-cols}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://stackoverflow.com/questions/19619666/change{-}column{-}position{-}of{-}data{-}table}
\FunctionTok{setcolorder}\NormalTok{(tmp, }\FunctionTok{c}\NormalTok{(}\StringTok{"median\_mpg"}\NormalTok{, }\FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), }\StringTok{"median\_mpg"}\NormalTok{)))}
\NormalTok{tmp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    median_mpg cyl median_hp
## 1:       15.2   8     192.5
## 2:       19.7   6     110.0
## 3:       26.0   4      91.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(tmp, }\StringTok{"median\_mpg"}\NormalTok{, }\FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), }\StringTok{"median\_mpg"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    median_mpg cyl median_hp
## 1:       15.2   8     192.5
## 2:       19.7   6     110.0
## 3:       26.0   4      91.0
\end{verbatim}

\hypertarget{sec-tidy-output}{%
\subsection{整理回归结果}\label{sec-tidy-output}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(iris, iris}\SpecialCharTok{$}\NormalTok{Species)}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(dat, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{lm}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length, x))}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(mod, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(x)))}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{Map}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(x)}
\NormalTok{  x}\SpecialCharTok{$}\NormalTok{Species }\OtherTok{\textless{}{-}}\NormalTok{ y}
\NormalTok{  x}
\NormalTok{\}, mod, }\FunctionTok{names}\NormalTok{(dat))}
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, mod)}
\NormalTok{mod}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                          Estimate Std. Error    t value     Pr(>|t|)    Species
## setosa.(Intercept)      0.8030518 0.34387807  2.3352806 2.375647e-02     setosa
## setosa.Sepal.Length     0.1316317 0.06852690  1.9208760 6.069778e-02     setosa
## versicolor.(Intercept)  0.1851155 0.51421351  0.3599974 7.204283e-01 versicolor
## versicolor.Sepal.Length 0.6864698 0.08630708  7.9538056 2.586190e-10 versicolor
## virginica.(Intercept)   0.6104680 0.41710685  1.4635770 1.498279e-01  virginica
## virginica.Sepal.Length  0.7500808 0.06302606 11.9011203 6.297786e-16  virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 管道操作}
\FunctionTok{split}\NormalTok{(iris, iris}\SpecialCharTok{$}\NormalTok{Species) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{lapply}\NormalTok{(., }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(}\FunctionTok{lm}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length, x)))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{Map}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{    x }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(x)}
\NormalTok{    x}\SpecialCharTok{$}\NormalTok{Species }\OtherTok{\textless{}{-}}\NormalTok{ y}
\NormalTok{    x}
\NormalTok{  \}, ., }\FunctionTok{levels}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{do.call}\NormalTok{(rbind, .)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                          Estimate Std. Error    t value     Pr(>|t|)    Species
## setosa.(Intercept)      0.8030518 0.34387807  2.3352806 2.375647e-02     setosa
## setosa.Sepal.Length     0.1316317 0.06852690  1.9208760 6.069778e-02     setosa
## versicolor.(Intercept)  0.1851155 0.51421351  0.3599974 7.204283e-01 versicolor
## versicolor.Sepal.Length 0.6864698 0.08630708  7.9538056 2.586190e-10 versicolor
## virginica.(Intercept)   0.6104680 0.41710685  1.4635770 1.498279e-01  virginica
## virginica.Sepal.Length  0.7500808 0.06302606 11.9011203 6.297786e-16  virginica
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# dplyr 操作，需要 dplyr \textgreater{}= 1.0.0 }
\NormalTok{iris }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(Species) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(broom}\SpecialCharTok{::}\FunctionTok{tidy}\NormalTok{(}\FunctionTok{lm}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 6
## # Groups:   Species [3]
##   Species    term         estimate std.error statistic  p.value
##   <fct>      <chr>           <dbl>     <dbl>     <dbl>    <dbl>
## 1 setosa     (Intercept)     0.803    0.344      2.34  2.38e- 2
## 2 setosa     Sepal.Length    0.132    0.0685     1.92  6.07e- 2
## 3 versicolor (Intercept)     0.185    0.514      0.360 7.20e- 1
## 4 versicolor Sepal.Length    0.686    0.0863     7.95  2.59e-10
## 5 virginica  (Intercept)     0.610    0.417      1.46  1.50e- 1
## 6 virginica  Sepal.Length    0.750    0.0630    11.9   6.30e-16
\end{verbatim}

\hypertarget{sec-assignment-by-reference}{%
\subsection{\texorpdfstring{\texttt{:=} 和 \texttt{.()}}{:= 和 .()}}\label{sec-assignment-by-reference}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[, mpg\_rate }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{round}\NormalTok{(mpg }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(mpg) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{), by }\OtherTok{=}\NormalTok{ .(cyl, vs, am)]}
\NormalTok{mtcars[, .(mpg\_rate, mpg, cyl, vs, am)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     mpg_rate  mpg cyl vs am
##  1:    34.04 21.0   6  0  1
##  2:    34.04 21.0   6  0  1
##  3:    11.48 22.8   4  1  1
##  4:    27.97 21.4   6  1  0
##  5:    10.35 18.7   8  0  0
##  6:    23.66 18.1   6  1  0
##  7:     7.92 14.3   8  0  0
##  8:    35.52 24.4   4  1  0
##  9:    33.19 22.8   4  1  0
## 10:    25.10 19.2   6  1  0
## 11:    23.27 17.8   6  1  0
## 12:     9.08 16.4   8  0  0
## 13:     9.58 17.3   8  0  0
## 14:     8.42 15.2   8  0  0
## 15:     5.76 10.4   8  0  0
## 16:     5.76 10.4   8  0  0
## 17:     8.14 14.7   8  0  0
## 18:    16.31 32.4   4  1  1
## 19:    15.31 30.4   4  1  1
## 20:    17.07 33.9   4  1  1
## 21:    31.30 21.5   4  1  0
## 22:     8.58 15.5   8  0  0
## 23:     8.42 15.2   8  0  0
## 24:     7.36 13.3   8  0  0
## 25:    10.63 19.2   8  0  0
## 26:    13.75 27.3   4  1  1
## 27:   100.00 26.0   4  0  1
## 28:    15.31 30.4   4  1  1
## 29:    51.30 15.8   8  0  1
## 30:    31.93 19.7   6  0  1
## 31:    48.70 15.0   8  0  1
## 32:    10.78 21.4   4  1  1
##     mpg_rate  mpg cyl vs am
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars[, .(}\AttributeTok{mpg\_rate =} \FunctionTok{round}\NormalTok{(mpg }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(mpg) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{)), by }\OtherTok{=}\NormalTok{ .(cyl, vs, am)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cyl vs am mpg_rate
##  1:   6  0  1    34.04
##  2:   6  0  1    34.04
##  3:   6  0  1    31.93
##  4:   4  1  1    11.48
##  5:   4  1  1    16.31
##  6:   4  1  1    15.31
##  7:   4  1  1    17.07
##  8:   4  1  1    13.75
##  9:   4  1  1    15.31
## 10:   4  1  1    10.78
## 11:   6  1  0    27.97
## 12:   6  1  0    23.66
## 13:   6  1  0    25.10
## 14:   6  1  0    23.27
## 15:   8  0  0    10.35
## 16:   8  0  0     7.92
## 17:   8  0  0     9.08
## 18:   8  0  0     9.58
## 19:   8  0  0     8.42
## 20:   8  0  0     5.76
## 21:   8  0  0     5.76
## 22:   8  0  0     8.14
## 23:   8  0  0     8.58
## 24:   8  0  0     8.42
## 25:   8  0  0     7.36
## 26:   8  0  0    10.63
## 27:   4  1  0    35.52
## 28:   4  1  0    33.19
## 29:   4  1  0    31.30
## 30:   4  0  1   100.00
## 31:   8  0  1    51.30
## 32:   8  0  1    48.70
##     cyl vs am mpg_rate
\end{verbatim}

\hypertarget{sec-remove-na}{%
\subsection{去掉含有缺失值的记录}\label{sec-remove-na}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality[}\FunctionTok{complete.cases}\NormalTok{(airquality), ] }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 7    23     299  8.6   65     5   7
## 8    19      99 13.8   59     5   8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 或着}
\NormalTok{airquality[}\SpecialCharTok{!}\FunctionTok{apply}\NormalTok{(airquality, }\DecValTok{1}\NormalTok{, anyNA), ] }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 7    23     299  8.6   65     5   7
## 8    19      99 13.8   59     5   8
\end{verbatim}

\hypertarget{sec-match-set}{%
\subsection{集合操作}\label{sec-match-set}}

match 和 \texttt{\%in\%} \url{https://d.cosx.org/d/421314}

\begin{Shaded}
\begin{Highlighting}[]
\StringTok{\textasciigrave{}}\AttributeTok{\%nin\%}\StringTok{\textasciigrave{}} \OtherTok{\textless{}{-}} \FunctionTok{Negate}\NormalTok{(}\StringTok{"\%in\%"}\NormalTok{)}
\CommentTok{\# \textasciigrave{}\%in\%\textasciigrave{} \textless{}{-} function(x, table) match(x, table, nomatch = 0) \textgreater{} 0 \# \%in\% 函数的定义}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ letters[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{]}
\NormalTok{y }\OtherTok{\textless{}{-}}\NormalTok{ letters[}\DecValTok{3}\SpecialCharTok{:}\DecValTok{8}\NormalTok{]}

\NormalTok{x }\SpecialCharTok{\%in\%}\NormalTok{ y}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE FALSE  TRUE  TRUE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{\%nin\%}\NormalTok{ y}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  TRUE  TRUE FALSE FALSE FALSE
\end{verbatim}

返回一个逻辑向量，x 中的元素匹配到了就返回 TRUE，否则 FALSE， \texttt{\%nin\%} 是 \texttt{\%in\%} 的取反效果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{match}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA NA  1  2  3
\end{verbatim}

x 在 y 中的匹配情况，匹配到了，就返回在 y 中匹配的位置，没有匹配到就返回 NA

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{setdiff}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a" "b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{intersect}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "c" "d" "e"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{union}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "a" "b" "c" "d" "e" "f" "g" "h"
\end{verbatim}

\hypertarget{transform-cut-aggregate}{%
\subsection{对数值向量按既定分组计数}\label{transform-cut-aggregate}}

此数据处理过程陆续使用了 \texttt{transform()}、\texttt{cut()} 和 \texttt{aggregate()} 三个函数

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 对数值向量按既定分组计数}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(dat, }\AttributeTok{x =} \FunctionTok{cut}\NormalTok{(y, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{15}\NormalTok{)))}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{FUN =}\NormalTok{ length)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{()}

\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{x =} \FunctionTok{cut}\NormalTok{(y, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{15}\NormalTok{))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ., y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{FUN =}\NormalTok{ length) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ., }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

对数值向量按分位数分组计数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(dat, }\AttributeTok{x =} \FunctionTok{cut}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ y,}
  \AttributeTok{breaks =} \FunctionTok{quantile}\NormalTok{(y, }\AttributeTok{prob =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.25}\NormalTok{), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{))}

\CommentTok{\# dat \textless{}{-} transform(dat, x = cut(}
\CommentTok{\#   x = y,}
\CommentTok{\#   breaks = quantile(y, prob = seq(0, 1, 0.25)),}
\CommentTok{\#   include.lowest = T}
\CommentTok{\# ))}

\NormalTok{dat1 }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{FUN =}\NormalTok{ length)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{aggregate-order}{%
\subsection{分组排序}\label{aggregate-order}}

按变量 a 分组计算，之后按变量 b 降序排列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, }\FunctionTok{cbind}\NormalTok{(Sepal.Width, Sepal.Length) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{FUN =}\NormalTok{ mean)}
\CommentTok{\# 按 Species 降序排列}
\NormalTok{dat[}\FunctionTok{order}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{Species, }\AttributeTok{decreasing =}\NormalTok{ T), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Width Sepal.Length
## 3  virginica       2.974        6.588
## 2 versicolor       2.770        5.936
## 1     setosa       3.428        5.006
\end{verbatim}

\hypertarget{lapply-split-order}{%
\subsection{分组获取 Top 值}\label{lapply-split-order}}

分组按既定规律取数，比如按 Species 分组取 Top 6

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组取前6个}
\FunctionTok{do.call}\NormalTok{(}\StringTok{"rbind.data.frame"}\NormalTok{, }\FunctionTok{lapply}\NormalTok{(base}\SpecialCharTok{::}\FunctionTok{split}\NormalTok{(}\AttributeTok{x =}\NormalTok{ iris, }\SpecialCharTok{\textasciitilde{}}\NormalTok{Species), head))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组取 Top 6}
\FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(}\FunctionTok{split}\NormalTok{(iris, iris}\SpecialCharTok{$}\NormalTok{Species),}
  \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{head}\NormalTok{(x[}\FunctionTok{order}\NormalTok{(x}\SpecialCharTok{$}\NormalTok{Sepal.Length, }\AttributeTok{decreasing =}\NormalTok{ T), ], }\DecValTok{6}\NormalTok{)}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
##  1:          5.8         4.0          1.2         0.2     setosa
##  2:          5.7         4.4          1.5         0.4     setosa
##  3:          5.7         3.8          1.7         0.3     setosa
##  4:          5.5         4.2          1.4         0.2     setosa
##  5:          5.5         3.5          1.3         0.2     setosa
##  6:          5.4         3.9          1.7         0.4     setosa
##  7:          7.0         3.2          4.7         1.4 versicolor
##  8:          6.9         3.1          4.9         1.5 versicolor
##  9:          6.8         2.8          4.8         1.4 versicolor
## 10:          6.7         3.1          4.4         1.4 versicolor
## 11:          6.7         3.0          5.0         1.7 versicolor
## 12:          6.7         3.1          4.7         1.5 versicolor
## 13:          7.9         3.8          6.4         2.0  virginica
## 14:          7.7         3.8          6.7         2.2  virginica
## 15:          7.7         2.6          6.9         2.3  virginica
## 16:          7.7         2.8          6.7         2.0  virginica
## 17:          7.7         3.0          6.1         2.3  virginica
## 18:          7.6         3.0          6.6         2.1  virginica
\end{verbatim}

\hypertarget{lapply-split-sample}{%
\subsection{分组抽样}\label{lapply-split-sample}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组抽样}
\FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(}\FunctionTok{split}\NormalTok{(iris, iris}\SpecialCharTok{$}\NormalTok{Species),}
  \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) x[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(x), }\AttributeTok{size =} \DecValTok{6}\NormalTok{), ]}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
##  1:          5.0         3.3          1.4         0.2     setosa
##  2:          5.0         3.0          1.6         0.2     setosa
##  3:          5.2         3.5          1.5         0.2     setosa
##  4:          5.1         3.8          1.9         0.4     setosa
##  5:          4.7         3.2          1.6         0.2     setosa
##  6:          4.8         3.0          1.4         0.3     setosa
##  7:          6.7         3.0          5.0         1.7 versicolor
##  8:          6.1         2.9          4.7         1.4 versicolor
##  9:          6.2         2.2          4.5         1.5 versicolor
## 10:          6.3         2.5          4.9         1.5 versicolor
## 11:          6.6         3.0          4.4         1.4 versicolor
## 12:          5.0         2.3          3.3         1.0 versicolor
## 13:          5.7         2.5          5.0         2.0  virginica
## 14:          5.8         2.8          5.1         2.4  virginica
## 15:          6.7         2.5          5.8         1.8  virginica
## 16:          6.9         3.1          5.1         2.3  virginica
## 17:          6.8         3.0          5.5         2.1  virginica
## 18:          6.0         3.0          4.8         1.8  virginica
\end{verbatim}

\hypertarget{lapply-split-quantile}{%
\subsection{分组计算分位数}\label{lapply-split-quantile}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组计算分位数，如何分组呢}
\FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(iris[, }\FunctionTok{sapply}\NormalTok{(iris, class) }\SpecialCharTok{==} \StringTok{"numeric"}\NormalTok{], quantile))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              0% 25% 50% 75% 100%
## Sepal.Length  1   1   1   1    1
## Sepal.Width   1   1   1   1    1
## Petal.Length  1   1   1   1    1
## Petal.Width   1   1   1   1    1
## Species       0   0   0   0    0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, }\FunctionTok{cbind}\NormalTok{(Sepal.Length, Sepal.Width) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{FUN =}\NormalTok{ quantile)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length.0% Sepal.Length.25% Sepal.Length.50% Sepal.Length.75%
## 1     setosa           4.300            4.800            5.000            5.200
## 2 versicolor           4.900            5.600            5.900            6.300
## 3  virginica           4.900            6.225            6.500            6.900
##   Sepal.Length.100% Sepal.Width.0% Sepal.Width.25% Sepal.Width.50%
## 1             5.800          2.300           3.200           3.400
## 2             7.000          2.000           2.525           2.800
## 3             7.900          2.200           2.800           3.000
##   Sepal.Width.75% Sepal.Width.100%
## 1           3.675            4.400
## 2           3.000            3.400
## 3           3.175            3.800
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 对 Sepal.Length 按 Species 分组计算分位数}
\FunctionTok{do.call}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, }\FunctionTok{tapply}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Sepal.Length, iris}\SpecialCharTok{$}\NormalTok{Species, quantile))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             0%   25% 50% 75% 100%
## setosa     4.3 4.800 5.0 5.2  5.8
## versicolor 4.9 5.600 5.9 6.3  7.0
## virginica  4.9 6.225 6.5 6.9  7.9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 分组取平均 mean /中位数 median}
\FunctionTok{aggregate}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, . }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{FUN =}\NormalTok{ mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        5.006       3.428        1.462       0.246
## 2 versicolor        5.936       2.770        4.260       1.326
## 3  virginica        6.588       2.974        5.552       2.026
\end{verbatim}

\hypertarget{shift-lag}{%
\subsection{计算日粒度的 DoD/WoW/MoM/YoY}\label{shift-lag}}

截止写作时间，data.table 提供的滑动窗口聚合统计函数 \texttt{frollmean()}、\texttt{frollsum()} 和 \texttt{frollapply()} 还处于实验阶段。 shift 提供漂移功能，向前前置 lead 或向后延迟 lag。

\href{https://r-norberg.blogspot.com/2016/06/understanding-datatable-rolling-joins.html}{移动平均、求和和计算}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{dt =} \FunctionTok{seq}\NormalTok{(}
  \AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2021{-}01{-}01"}\NormalTok{),}
  \AttributeTok{to =} \FunctionTok{Sys.Date}\NormalTok{(), }\AttributeTok{by =} \StringTok{"1 day"}
\NormalTok{))}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{within}\NormalTok{(dat, \{}
\NormalTok{  uv }\OtherTok{=} \FunctionTok{round}\NormalTok{(}\DecValTok{1000} \SpecialCharTok{*} \FunctionTok{runif}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(dat)))}
\NormalTok{  uv\_dod\_d }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(dat) }\SpecialCharTok{\textless{}=} \DecValTok{1}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{diff}\NormalTok{(uv, }\AttributeTok{lag =} \DecValTok{1}\NormalTok{)))}
\NormalTok{  uv\_wow\_d }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(dat) }\SpecialCharTok{\textless{}=} \DecValTok{7}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{7}\NormalTok{), }\FunctionTok{diff}\NormalTok{(uv, }\AttributeTok{lag =} \DecValTok{7}\NormalTok{)))}
\NormalTok{  uv\_mom\_d }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(dat) }\SpecialCharTok{\textless{}=} \DecValTok{30}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{30}\NormalTok{), }\FunctionTok{diff}\NormalTok{(uv, }\AttributeTok{lag =} \DecValTok{30}\NormalTok{)))}
\NormalTok{  uv\_yoy\_d }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(dat) }\SpecialCharTok{\textless{}=} \DecValTok{365}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{365}\NormalTok{), }\FunctionTok{diff}\NormalTok{(uv, }\AttributeTok{lag =} \DecValTok{365}\NormalTok{)))}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-adm-sessioninfo}{%
\section{运行环境}\label{sec-adm-sessioninfo}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] magrittr_2.0.3    data.table_1.14.2
## 
## loaded via a namespace (and not attached):
##  [1] knitr_1.39       sysfonts_0.8.8   tidyselect_1.1.2 R6_2.5.1        
##  [5] rlang_1.0.2      fastmap_1.1.0    fansi_1.0.3      stringr_1.4.0   
##  [9] dplyr_1.0.9      tools_4.2.0      broom_0.8.0      xfun_0.31       
## [13] utf8_1.2.2       DBI_1.1.2        cli_3.3.0        htmltools_0.5.2 
## [17] ellipsis_0.3.2   assertthat_0.2.1 yaml_2.3.5       digest_0.6.29   
## [21] tibble_3.1.7     lifecycle_1.0.1  crayon_1.5.1     bookdown_0.26   
## [25] tidyr_1.2.0      purrr_0.3.4      vctrs_0.4.1      curl_4.3.2      
## [29] glue_1.6.2       evaluate_0.15    rmarkdown_2.14   stringi_1.7.6   
## [33] compiler_4.2.0   pillar_1.7.0     backports_1.4.1  generics_0.1.2  
## [37] pkgconfig_2.0.3
\end{verbatim}

\hypertarget{chap-parallel-manipulation}{%
\chapter{并行化操作}\label{chap-parallel-manipulation}}

向量化运算、并行运算和分布式运算

\begin{itemize}
\tightlist
\item
  \href{https://github.com/HenrikBengtsson/future}{future} 在 R 语言中提供统一的并行和分布式处理框架
\item
  \href{https://github.com/HenrikBengtsson/future.apply}{future.apply} 可以替代 base R 提供的 apply 族函数
\item
  \href{https://github.com/HenrikBengtsson/future.batchtools}{future.batchtools} 使用 batchtools 实现并行和分布式处理
\item
  \href{https://github.com/mllg/batchtools}{batchtools} Map 函数的并行实现，用于高性能计算系统和分布式处理，可以单机多核并行也可以多机并行，还提供了一种抽象的机制去定义大规模计算机实验。
\item
  \href{https://github.com/hadley/multidplyr}{multidplyr} 是 dplyr 的后端，多核环境下实现数据分块，提高并行处理性能
\item
  \href{https://github.com/xiaodaigh/disk.frame}{disk.frame} 是基于磁盘的超出内存容量的快速并行数据操作框架
\item
  \href{https://github.com/berndbischl/parallelMap}{parallelMap} R package to interface some popular parallelization back-ends with a unified interface
\item
  \href{https://github.com/jangorecki/big.data.table}{big.data.table} 基于 data.table 的分布式并行计算
\end{itemize}

\hypertarget{apply}{%
\section{apply}\label{apply}}

apply 家族和 \texttt{do.call}

\hypertarget{map-reduce}{%
\section{MapReduce}\label{map-reduce}}

高阶函数，简单来说，就是参数为函数，返回值也是函数。Base R 提供了 \texttt{Reduce} 、\texttt{Filter} 、\texttt{Find} 、\texttt{Map} 、\texttt{Negate} 和 \texttt{Position} 等常用函数，此外还有 \texttt{*apply} 族。

与 \texttt{purrr::map} 比较

在 R 语言里玩转\texttt{apply}， \texttt{Map()} 和 \texttt{Reduce()}\footnote{\url{https://stackoverflow.com/questions/3505701/grouping-functions-tapply-by-aggregate-and-the-apply-family}}，下面分别以提取合并多张 XLSX 表格\footnote{\url{https://trinkerrstuff.wordpress.com/2018/02/14/easily-make-multi-tabbed-xlsx-files-with-openxlsx/}}，分组计算\footnote{\url{https://statcompute.wordpress.com/2018/09/03/playing-map-and-reduce-in-r-by-group-calculation/}} 和子集操作 \footnote{\url{https://statcompute.wordpress.com/2018/09/08/playing-map-and-reduce-in-r-subsetting/}} 为例，从函数式编程到 MapReduce \footnote{\url{https://cartesianfaith.com/2015/09/17/from-functional-programming-to-mapreduce-in-r/}}，制作数据透视表\footnote{\url{https://digitheadslabnotebook.blogspot.com/2010/01/pivot-tables-in-r.html}}，用于数据处理的函数式编程和单元测试 Functional programming and unit testing for data munging with R 特别是第三章 \url{https://b-rodrigues.github.io/fput/}，然后是函数式编程与数据建模 Modeling data with functional programming in R\footnote{\url{https://cartesianfaith.files.wordpress.com/2015/12/rowe-modeling-data-with-functional-programming-in-r.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{add }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{Reduce}\NormalTok{(}\StringTok{"+"}\NormalTok{, x)}
\FunctionTok{add}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{add\_accuml }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{Reduce}\NormalTok{(}\StringTok{"+"}\NormalTok{, x, }\AttributeTok{accumulate =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{add\_accuml}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 3 6
\end{verbatim}

\hypertarget{parallel}{%
\section{parallel}\label{parallel}}

\href{https://github.com/ardeeshany/Parallel_Computing}{并行计算小抄} 将共享内存的 R 包整理在一起

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(parallel)}
\end{Highlighting}
\end{Shaded}

\hypertarget{rmpi}{%
\section{Rmpi}\label{rmpi}}

\href{http://fisher.stats.uwo.ca/faculty/yu/Rmpi/}{Rmpi} 由卡尔顿大学的 \href{https://www.uwo.ca/stats/people/bios/hao-yu.html}{Hao Yu} 开发和维护

首先安装 openmpi-devel 开发环境（以 Fedora 30 为例）

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{yum}\NormalTok{ install }\AttributeTok{{-}y}\NormalTok{ openmpi{-}devel}
\BuiltInTok{echo} \StringTok{"export ORTED=/usr/lib64/openmpi/bin"} \OperatorTok{\textgreater{}\textgreater{}}\NormalTok{ \textasciitilde{}/.bashrc}
\CommentTok{\# 或者}
\BuiltInTok{echo} \StringTok{"PATH=/usr/lib64/openmpi/bin:}\VariableTok{$PATH}\StringTok{; export PATH"} \KeywordTok{|} \FunctionTok{tee} \AttributeTok{{-}a}\NormalTok{ \textasciitilde{}/.bashrc}
\BuiltInTok{source}\NormalTok{ \textasciitilde{}/.bashrc}
\end{Highlighting}
\end{Shaded}

然后进入 R 安装 R 包 Rmpi

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}Rmpi\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

使用 Rmpi 包生成两组服从均匀分布的随机数

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载 R 包}
\FunctionTok{library}\NormalTok{(Rmpi)}
\CommentTok{\# 检测可用的逻辑 CPU 核心数}
\NormalTok{parallel}\SpecialCharTok{::}\FunctionTok{detectCores}\NormalTok{()}
\CommentTok{\# 虚拟机分配四个逻辑CPU核 }
\CommentTok{\# 1个 master 2个 worker 主机 cloud}
\FunctionTok{mpi.spawn.Rslaves}\NormalTok{(}\AttributeTok{nslaves=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
#         2 slaves are spawned successfully. 0 failed.
# master (rank 0, comm 1) of size 3 is running on: cloud
# slave1 (rank 1, comm 1) of size 3 is running on: cloud
# slave2 (rank 2, comm 1) of size 3 is running on: cloud
\end{verbatim}

调用 \texttt{mpi.apply} 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\FunctionTok{mpi.apply}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{), runif)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[[1]]
 [1] 0.33684269 0.84638494 0.82776590 0.23707947 0.07593769 0.27981368
 [7] 0.45307675 0.02878214 0.32807421 0.92854275

[[2]]
 [1] 0.63474442 0.04025071 0.01996498 0.01922093 0.41258827 0.84150414
 [7] 0.74705002 0.07635368 0.32807392 0.94570363 0.89187667 0.67069020
[13] 0.92996997 0.22486589 0.22118236 0.15807970 0.65619450 0.16473730
[19] 0.85833484 0.11416449
\end{verbatim}

用完要关闭

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mpi.close.Rslaves}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

pbdMPI 包处于活跃维护状态，是 \href{https://github.com/RBigData}{pbdR 项目} 的核心组件，能够以分布式计算的方式轻松处理 TB 级数据\footnote{2016年国际 R 语言大会上的介绍\url{https://github.com/snoweye/user2016.demo} 和2018年 JSM 会 上的介绍 \url{https://github.com/RBigData/R_JSM2018}}

\href{https://prs.ism.ac.jp/~nakama/Rhpc/}{Rhpc} 包同样基于 MPI 方式，但是集 Rmpi 和 snow 两个包的优点于一身，在保持 apply 编程风格的同时，能够提供更好的高性能计算环境，支持长向量，能够处理一些大数据。

\hypertarget{gpur}{%
\section{gpuR}\label{gpur}}

Charles Determan 开发的 \href{https://github.com/cdeterman/gpuR}{gpuR} 基于 OpenCL 加速，目前处于活跃维护状态。而 Charles Determan 开发的另一个 \href{https://github.com/gpuRcore/gpuRcuda}{gpuRcuda} 包是基于 CUDA 加速

\href{https://github.com/PatricZhao}{赵鹏} 的博客 \href{http://www.parallelr.com/}{ParallelR} 关注基于 \href{https://devblogs.nvidia.com/accelerate-r-applications-cuda/}{CUDA 的 GPU 加速}

此外还有 \href{https://github.com/nullsatz/gputools}{gputools}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gpuR)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{gpuA }\OtherTok{\textless{}{-}} \FunctionTok{gpuMatrix}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{4}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{4}\NormalTok{)}
\NormalTok{gpuA}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
An object of class "fgpuMatrix"
Slot "address":
<pointer: 0x000000000fbe9760>

Slot ".context_index":
[1] 1

Slot ".platform_index":
[1] 1

Slot ".platform":
[1] "Intel(R) OpenCL"

Slot ".device_index":
[1] 1

Slot ".device":
[1] "Intel(R) HD Graphics 4600"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gpuB }\OtherTok{\textless{}{-}}\NormalTok{ gpuA }\SpecialCharTok{\%*\%}\NormalTok{ gpuA}
\FunctionTok{print}\NormalTok{(gpuB)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Source: gpuR Matrix [4 x 4]

            [,1]      [,2]      [,3]       [,4]
[1,]  2.61787200 -1.274909 -2.150301 -2.0073860
[2,] -0.02231596  1.566433  0.986027  0.7339008
[3,] -0.12862393  1.848340  3.261899  1.6919358
[4,] -1.90084898 -1.863014 -1.312350 -0.2553876
\end{verbatim}

\hypertarget{parallel-sessioninfo}{%
\section{运行环境}\label{parallel-sessioninfo}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   base64enc_0.1.3 bookdown_0.26   bslib_0.3.1     cli_3.3.0      
##   compiler_4.2.0  curl_4.3.2      digest_0.6.29   evaluate_0.15  
##   fastmap_1.1.0   fs_1.5.2        glue_1.6.2      graphics_4.2.0 
##   grDevices_4.2.0 highr_0.9       htmltools_0.5.2 jquerylib_0.1.4
##   jsonlite_1.8.0  knitr_1.39      magrittr_2.0.3  methods_4.2.0  
##   R6_2.5.1        rappdirs_0.3.3  rlang_1.0.2     rmarkdown_2.14 
##   sass_0.4.1      stats_4.2.0     stringi_1.7.6   stringr_1.4.0  
##   sysfonts_0.8.8  tinytex_0.39    tools_4.2.0     utils_4.2.0    
##   xfun_0.31       yaml_2.3.5
\end{verbatim}

\href{https://stackoverflow.com/questions/10689055}{create-an-empty-data-frame} \href{https://www.datacamp.com/community/tutorials/pipe-r-tutorial}{pipe-r}

\hypertarget{chap-dplyr-manipulation}{%
\chapter{净土化操作}\label{chap-dplyr-manipulation}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\end{Highlighting}
\end{Shaded}

\hypertarget{common-operations}{%
\section{常用操作}\label{common-operations}}

dplyr 由 Hadley Wickham 主要由开发和维护，是Rstudio公司开源的用于数据处理的一大利器，该包号称「数据操作的语法」，与 ggplot2 的「图形语法」 对应，也就是说数据处理那一套已经建立完整的和SQL一样的功能。它们都遵循同样的处理逻辑，只不过一个用SQL写，一个用R语言写，处理效率差不多，R语言写的 SQL 会被翻译为 SQL 语句，再传至数据库查询，当然它也支持内存内的数据操作。目前 dplyr 以 dbplyr 为后端支持的数据库有：MySQL、PostgreSQL，SQLite等，完整的支持列表请看 \href{https://dplyr.tidyverse.org}{这里}，连接特定数据库，都是基于 DBI，DBI 即 Database Interface， 是使用C/C++开发的底层数据库接口，是一个统一的关系型数据库连接框架，需要根据不同的具体的数据库进行实例化，才可使用。

dplyr 常用的函数是 7 个： \texttt{arrange} 排序 \texttt{filter} 过滤行 \texttt{select} 选择列 \texttt{mutate} 变换 \texttt{summarise} 汇总 \texttt{group\_by} 分组 \texttt{distinct} 去重

以 ggplot2 包自带的钻石数据集 diamonds 为例介绍

\hypertarget{tibble-show}{%
\subsection{查看}\label{tibble-show}}

除了直接打印数据集的前几行，tibble 包还提供 glimpse 函数查看数据集，而 Base R 默认查看方式是调用 str 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"diamonds"}\NormalTok{, }\AttributeTok{package =} \StringTok{"ggplot2"}\NormalTok{)}
\FunctionTok{glimpse}\NormalTok{(diamonds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Rows: 53,940
## Columns: 10
## $ carat   <dbl> 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.~
## $ cut     <ord> Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver~
## $ color   <ord> E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,~
## $ clarity <ord> SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, ~
## $ depth   <dbl> 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64~
## $ table   <dbl> 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58~
## $ price   <int> 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34~
## $ x       <dbl> 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.~
## $ y       <dbl> 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.~
## $ z       <dbl> 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.~
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:dplyr-object-type} dplyr 定义的数据对象类型}\tabularnewline
\toprule
类型 & 含义 \\
\midrule
\endfirsthead
\toprule
类型 & 含义 \\
\midrule
\endhead
int & 整型 integer \\
dbl & （单）双精度浮点类型 \\
chr & 字符（串）类型 \\
dttm & data-time 类型 \\
lgl & 布尔类型 \\
fctr & 因子类型 factor \\
date & 日期类型 \\
\bottomrule
\end{longtable}

表 \ref{tab:dplyr-object-type} 中 dttm 和 date 类型代指 lubridate 包指定的日期对象 POSIXct、 POSIXlt、 Date、 chron、 yearmon、 yearqtr、 zoo、 zooreg、 timeDate、 xts、 its、 ti、 jul、 timeSeries 和 fts。

\hypertarget{dplyr-filter}{%
\subsection{筛选}\label{dplyr-filter}}

按条件筛选数据的子集，按行筛选

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  \FunctionTok{filter}\NormalTok{(cut }\SpecialCharTok{==} \StringTok{"Ideal"}\NormalTok{ , carat }\SpecialCharTok{\textgreater{}=} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 10
##   carat cut   color clarity depth table price     x     y     z
##   <dbl> <ord> <ord> <ord>   <dbl> <dbl> <int> <dbl> <dbl> <dbl>
## 1  3.22 Ideal I     I1       62.6    55 12545  9.49  9.42  5.92
## 2  3.5  Ideal H     I1       62.8    57 12587  9.65  9.59  6.03
## 3  3.01 Ideal J     SI2      61.7    58 16037  9.25  9.2   5.69
## 4  3.01 Ideal J     I1       65.4    60 16538  8.99  8.93  5.86
\end{verbatim}

先按行，再按列筛选

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{filter}\NormalTok{(carat }\SpecialCharTok{\textgreater{}=} \DecValTok{3}\NormalTok{, color }\SpecialCharTok{==} \StringTok{"I"}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{select}\NormalTok{(cut, carat)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 16 x 2
##    cut       carat
##    <ord>     <dbl>
##  1 Premium    3.01
##  2 Fair       3.02
##  3 Good       3   
##  4 Ideal      3.22
##  5 Premium    4.01
##  6 Very Good  3.04
##  7 Very Good  4   
##  8 Premium    3.67
##  9 Premium    3   
## 10 Fair       3   
## 11 Premium    3.01
## 12 Fair       3.01
## 13 Fair       3.01
## 14 Good       3.01
## 15 Good       3.01
## 16 Premium    3.04
\end{verbatim}

\hypertarget{dplyr-arrange}{%
\subsection{排序}\label{dplyr-arrange}}

arrange 默认升序排列，按钻石重量升序，按价格降序

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{filter}\NormalTok{(cut }\SpecialCharTok{==} \StringTok{"Ideal"}\NormalTok{ , carat }\SpecialCharTok{\textgreater{}=} \DecValTok{3}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{arrange}\NormalTok{(carat, }\FunctionTok{desc}\NormalTok{(price))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 10
##   carat cut   color clarity depth table price     x     y     z
##   <dbl> <ord> <ord> <ord>   <dbl> <dbl> <int> <dbl> <dbl> <dbl>
## 1  3.01 Ideal J     I1       65.4    60 16538  8.99  8.93  5.86
## 2  3.01 Ideal J     SI2      61.7    58 16037  9.25  9.2   5.69
## 3  3.22 Ideal I     I1       62.6    55 12545  9.49  9.42  5.92
## 4  3.5  Ideal H     I1       62.8    57 12587  9.65  9.59  6.03
\end{verbatim}

\hypertarget{dplyr-summarise}{%
\subsection{聚合}\label{dplyr-summarise}}

分组求和，求平均，计数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{filter}\NormalTok{(carat }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{, color }\SpecialCharTok{==} \StringTok{"I"}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{group\_by}\NormalTok{(cut, clarity) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{sum\_carat =} \FunctionTok{sum}\NormalTok{(carat), }\AttributeTok{mean\_carat =} \FunctionTok{mean}\NormalTok{(carat), }\AttributeTok{n\_count =} \FunctionTok{n}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 8 x 5
## # Groups:   cut [5]
##   cut       clarity sum_carat mean_carat n_count
##   <ord>     <ord>       <dbl>      <dbl>   <int>
## 1 Fair      I1           3.02       3.02       1
## 2 Fair      SI2          6.02       3.01       2
## 3 Good      SI2          6.02       3.01       2
## 4 Very Good I1           4          4          1
## 5 Very Good SI2          3.04       3.04       1
## 6 Premium   I1          10.7        3.56       3
## 7 Premium   SI2          6.05       3.02       2
## 8 Ideal     I1           3.22       3.22       1
\end{verbatim}

\hypertarget{dplyr-merge}{%
\subsection{合并}\label{dplyr-merge}}

按行合并

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2018}\NormalTok{)}
\NormalTok{one }\OtherTok{\textless{}{-}}\NormalTok{ diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{filter}\NormalTok{(color }\SpecialCharTok{==} \StringTok{"I"}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\NormalTok{two }\OtherTok{\textless{}{-}}\NormalTok{ diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{filter}\NormalTok{(color }\SpecialCharTok{==} \StringTok{"J"}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\CommentTok{\# 按行合并数据框 one 和 two}
\FunctionTok{bind\_rows}\NormalTok{(one, two)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 10 x 10
##    carat cut       color clarity depth table price     x     y     z
##    <dbl> <ord>     <ord> <ord>   <dbl> <dbl> <int> <dbl> <dbl> <dbl>
##  1  0.42 Ideal     I     VVS1     62.5  57     884  4.77  4.8   2.99
##  2  0.3  Ideal     I     VVS2     62.5  53.6   532  4.29  4.33  2.69
##  3  2.02 Good      I     VS1      57.9  63   17533  8.13  8.21  4.73
##  4  0.9  Premium   I     VS2      61.9  58    3398  6.18  6.23  3.84
##  5  1.98 Very Good I     VS2      62.7  60   15083  7.9   7.96  4.98
##  6  1.51 Very Good J     VVS2     62.6  63    8706  7.29  7.24  4.55
##  7  0.7  Very Good J     SI1      61.7  57    1979  5.65  5.69  3.5 
##  8  1.16 Premium   J     VS2      62.2  59    4702  6.74  6.69  4.18
##  9  1.5  Premium   J     VVS2     61.8  60    8760  7.36  7.33  4.54
## 10  1.51 Premium   J     SI1      60.4  62    6680  7.42  7.32  4.45
\end{verbatim}

按列合并

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2018}\NormalTok{)}
\NormalTok{three }\OtherTok{\textless{}{-}}\NormalTok{ diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{select}\NormalTok{(carat, color) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\NormalTok{four }\OtherTok{\textless{}{-}}\NormalTok{ diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{select}\NormalTok{(carat, color) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{sample\_n}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\FunctionTok{bind\_cols}\NormalTok{(three, four)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 4
##   carat...1 color...2 carat...3 color...4
##       <dbl> <ord>         <dbl> <ord>    
## 1      0.33 H              0.52 F        
## 2      1.09 F              0.51 F        
## 3      1.52 I              0.5  G        
## 4      0.95 G              0.38 E        
## 5      0.35 E              0.51 J
\end{verbatim}

\hypertarget{dplyr-mutate}{%
\subsection{变换}\label{dplyr-mutate}}

添加一列，新的列或者改变原来的列

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{filter}\NormalTok{(carat }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{, color }\SpecialCharTok{==} \StringTok{"I"}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{select}\NormalTok{(cut, carat) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{vol =} \FunctionTok{if\_else}\NormalTok{(carat }\SpecialCharTok{\textgreater{}} \FloatTok{3.5}\NormalTok{, }\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 13 x 3
##    cut       carat vol  
##    <ord>     <dbl> <chr>
##  1 Premium    3.01 B    
##  2 Fair       3.02 B    
##  3 Ideal      3.22 B    
##  4 Premium    4.01 A    
##  5 Very Good  3.04 B    
##  6 Very Good  4    A    
##  7 Premium    3.67 A    
##  8 Premium    3.01 B    
##  9 Fair       3.01 B    
## 10 Fair       3.01 B    
## 11 Good       3.01 B    
## 12 Good       3.01 B    
## 13 Premium    3.04 B
\end{verbatim}

\hypertarget{dplyr-duplicated}{%
\subsection{去重}\label{dplyr-duplicated}}

数据去重在 dplyr 中的实现\footnote{\url{https://stackoverflow.com/questions/22959635/}}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{y =} \FunctionTok{sample}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T),}
  \AttributeTok{z =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}
\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x y  z
## 1  0 1  1
## 2  0 1  2
## 3  0 1  3
## 4  1 0  4
## 5  0 1  5
## 6  1 0  6
## 7  1 1  7
## 8  1 0  8
## 9  0 0  9
## 10 0 0 10
\end{verbatim}

去掉列重复的数据点 (x, y)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|}\ErrorTok{\textgreater{}}  
  \FunctionTok{group\_by}\NormalTok{(x, y) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{row\_number}\NormalTok{(z) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 3
## # Groups:   x, y [4]
##       x     y     z
##   <int> <int> <int>
## 1     0     1     1
## 2     1     0     4
## 3     1     1     7
## 4     0     0     9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 此处不对，没有了 z }
\NormalTok{df }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{distinct}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   x y
## 1 0 1
## 2 1 0
## 3 1 1
## 4 0 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 应该为}
\NormalTok{df }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{distinct}\NormalTok{(x, y, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   x y z
## 1 0 1 1
## 2 1 0 4
## 3 1 1 7
## 4 0 0 9
\end{verbatim}

\hypertarget{common-dataframe-operations}{%
\section{高频问题}\label{common-dataframe-operations}}

常用的数据操作包含

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  创建空的数据框或者说初始化一个数据框，
\item
  按指定的列对数据框排序，
\item
  选择特定的一些列，复杂情况是可能需要正则表达式从列名或者值中筛选
\item
  合并两个数据框，分为 (inner outer left right) 四种情况
\item
  宽格式和长格式互相转换，即重塑操作 reshape，单独的 tidyr 包操作，是 reshape2 包的进化版，提供 \texttt{spread} 和 \texttt{gather} 两个主要函数
\end{enumerate}

\hypertarget{create-empty-dataframe}{%
\subsection{初始化数据框}\label{create-empty-dataframe}}

创建空的数据框，就是不包含任何行、记录

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{empty\_df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Doubles =} \FunctionTok{double}\NormalTok{(),}
  \AttributeTok{Ints =} \FunctionTok{integer}\NormalTok{(),}
  \AttributeTok{Factors =} \FunctionTok{factor}\NormalTok{(),}
  \AttributeTok{Logicals =} \FunctionTok{logical}\NormalTok{(),}
  \AttributeTok{Characters =} \FunctionTok{character}\NormalTok{(),}
  \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{str}\NormalTok{(empty\_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    0 obs. of  5 variables:
##  $ Doubles   : num 
##  $ Ints      : int 
##  $ Factors   : Factor w/ 0 levels: 
##  $ Logicals  : logi 
##  $ Characters: chr
\end{verbatim}

如果数据框 df 包含数据，现在要依据它创建一个空的数据框

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{empty\_df }\OtherTok{=}\NormalTok{ df[}\ConstantTok{FALSE}\NormalTok{,]}
\end{Highlighting}
\end{Shaded}

还可以使用 structure 构造一个数据框，并且我们发现它的效率更高

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() }\FunctionTok{structure}\NormalTok{(}\FunctionTok{list}\NormalTok{(}
    \AttributeTok{Date =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{character}\NormalTok{()),}
    \AttributeTok{File =} \FunctionTok{character}\NormalTok{(),}
    \AttributeTok{User =} \FunctionTok{character}\NormalTok{()}
\NormalTok{  ),}
  \AttributeTok{class =} \StringTok{"data.frame"}
\NormalTok{  )}
\NormalTok{d }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() }\FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{Date =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{character}\NormalTok{()),}
    \AttributeTok{File =} \FunctionTok{character}\NormalTok{(),}
    \AttributeTok{User =} \FunctionTok{character}\NormalTok{(),}
    \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{  )}
\NormalTok{microbenchmark}\SpecialCharTok{::}\FunctionTok{microbenchmark}\NormalTok{(}\FunctionTok{s}\NormalTok{(), }\FunctionTok{d}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Unit: microseconds
##  expr   min     lq    mean median     uq    max neval
##   s()  19.8  22.55  57.247  26.85  31.55 2726.5   100
##   d() 208.4 213.40 244.358 217.50 222.55 2435.6   100
\end{verbatim}

\hypertarget{remove-missing-values}{%
\subsection{移除缺失记录}\label{remove-missing-values}}

只要行中包含缺失值，我们就把这样的行移除出去

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality[}\FunctionTok{complete.cases}\NormalTok{(airquality), ] }\SpecialCharTok{|}\ErrorTok{\textgreater{}} \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 7    23     299  8.6   65     5   7
## 8    19      99 13.8   59     5   8
\end{verbatim}

\hypertarget{coerce-data-type}{%
\subsection{数据类型转化}\label{coerce-data-type}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    30 obs. of  2 variables:
##  $ weight: num  4.17 5.58 5.18 6.11 4.5 4.61 5.17 4.53 5.33 5.14 ...
##  $ group : Factor w/ 3 levels "ctrl","trt1",..: 1 1 1 1 1 1 1 1 1 1 ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bob }\OtherTok{\textless{}{-}}\NormalTok{ PlantGrowth}
\NormalTok{i }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(bob, is.factor)}
\NormalTok{bob[i] }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(bob[i], as.character)}
\FunctionTok{str}\NormalTok{(bob)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    30 obs. of  2 variables:
##  $ weight: num  4.17 5.58 5.18 6.11 4.5 4.61 5.17 4.53 5.33 5.14 ...
##  $ group : chr  "ctrl" "ctrl" "ctrl" "ctrl" ...
\end{verbatim}

\hypertarget{cross-group-by}{%
\subsection{跨列分组求和}\label{cross-group-by}}

输入是一个数据框 data.frame，按照其中某一变量分组，然后计算任意数量的变量的行和和列和。

空气质量数据集 airquality 按月份 Month 分组，然后求取满足条件的列的和

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Reduce}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(}\FunctionTok{unique}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Month), }\ControlFlowTok{function}\NormalTok{(gv) \{}
\NormalTok{  subdta }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(airquality, }\AttributeTok{subset =}\NormalTok{ Month }\SpecialCharTok{==}\NormalTok{ gv)}
  \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{Colsum =} \FunctionTok{as.numeric}\NormalTok{(}
      \FunctionTok{colSums}\NormalTok{(subdta[, }\FunctionTok{grepl}\NormalTok{(}\StringTok{"[mM]"}\NormalTok{, }\FunctionTok{names}\NormalTok{(airquality))], }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{Month =}\NormalTok{ gv}
\NormalTok{  )}
\NormalTok{\}))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Colsum Month
## 1    2032     5
## 2     155     5
## 3    2373     6
## 4     180     6
## 5    2601     7
## 6     217     7
## 7    2603     8
## 8     248     8
## 9    2307     9
## 10    270     9
\end{verbatim}

什么是函数式编程，R 语言环境下的函数式编程是如何操作的

\hypertarget{pipe-manipulation}{%
\section{管道操作}\label{pipe-manipulation}}

\href{http://stefanbache.dk/}{Stefan Milton Bache} 开发了 \href{https://github.com/tidyverse/magrittr}{magrittr} 包实现管道操作，增加代码的可读性和维护性，但是这个 R 包的名字取的太奇葩，因为 \href{https://d.cosx.org/d/420697/21}{记不住}，它其实是一个复杂的\href{https://magrittr.tidyverse.org/articles/magrittr.html}{法语发音}，中式英语就叫它马格里特吧！这下应该好记多了吧！

我要查看是否需要新添加一个 R 包依赖，假设该 R 包是 reticulate 没有出现在 DESCRIPTION 文件中，但是可能已经被其中某（个）些 R 包依赖了

\begin{Shaded}
\begin{Highlighting}[]
\StringTok{"reticulate"} \SpecialCharTok{\%in\%} \FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(desc}\SpecialCharTok{::}\FunctionTok{desc\_get\_deps}\NormalTok{()}\SpecialCharTok{$}\NormalTok{package, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{))))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

安装 pkg 的依赖

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pkg }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"bookdown"}\NormalTok{,}
  \StringTok{"e1071"}\NormalTok{,}
  \StringTok{"formatR"}\NormalTok{,}
  \StringTok{"lme4"}\NormalTok{,}
  \StringTok{"mvtnorm"}\NormalTok{,}
  \StringTok{"prettydoc"}\NormalTok{, }\StringTok{"psych"}\NormalTok{,}
  \StringTok{"reticulate"}\NormalTok{, }\StringTok{"rstan"}\NormalTok{, }\StringTok{"rstanarm"}\NormalTok{, }\StringTok{"rticles"}\NormalTok{,}
  \StringTok{"svglite"}\NormalTok{,}
  \StringTok{"TMB"}\NormalTok{, }\StringTok{"glmmTMB"}
\NormalTok{)}
\CommentTok{\# 获取 pkg 的所有依赖}
\NormalTok{dep\_pkg }\OtherTok{\textless{}{-}}\NormalTok{ tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(pkg, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 将列表 list 合并为向量 vector}
\NormalTok{merge\_pkg }\OtherTok{\textless{}{-}} \FunctionTok{Reduce}\NormalTok{(}\StringTok{"c"}\NormalTok{, dep\_pkg, }\AttributeTok{accumulate =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# 所有未安装的 R 包}
\NormalTok{miss\_pkg }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{unique}\NormalTok{(merge\_pkg), }\FunctionTok{unique}\NormalTok{(}\FunctionTok{.packages}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)))}
\CommentTok{\# 除了 pkg 外，未安装的 R 包，安装 pkg 的依赖}
\FunctionTok{sort}\NormalTok{(}\FunctionTok{setdiff}\NormalTok{(miss\_pkg, pkg))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "mnormt"
\end{verbatim}

转化为管道操作，增加可读性

\begin{quote}
再举一个关于数据模拟的例子
\end{quote}

模拟 0-1 序列，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2019}\NormalTok{)}
\NormalTok{binom\_sample }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n) \{}
  \FunctionTok{sum}\NormalTok{(}\FunctionTok{sample}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\AttributeTok{size =}\NormalTok{ n, }\AttributeTok{prob =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\FloatTok{0.2}\NormalTok{), }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{))}\SpecialCharTok{/}\NormalTok{n}
\NormalTok{\}}
\CommentTok{\# 频率估计概率}
\NormalTok{one\_prob }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{8}\NormalTok{)), binom\_sample)}
\CommentTok{\# 估计的误差}
\NormalTok{one\_abs }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(one\_prob }\SpecialCharTok{{-}} \FloatTok{0.2}\NormalTok{)}
\NormalTok{one\_abs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.000e-01 1.000e-02 1.100e-02 4.400e-03 1.460e-03 3.980e-04 4.700e-06
## [8] 9.552e-05
\end{verbatim}

似然估计

\hypertarget{part-ux7edfux8ba1ux56feux5f62}{%
\part{统计图形}\label{part-ux7edfux8ba1ux56feux5f62}}

\hypertarget{chap-statistical-graphics}{%
\chapter*{介绍}\label{chap-statistical-graphics}}
\addcontentsline{toc}{chapter}{介绍}

统计图形

\hypertarget{chap-graphics-foundations}{%
\chapter{图形基础}\label{chap-graphics-foundations}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(survival)}
\FunctionTok{library}\NormalTok{(lattice)}
\FunctionTok{library}\NormalTok{(nlme)}
\FunctionTok{library}\NormalTok{(MASS)}
\FunctionTok{library}\NormalTok{(RColorBrewer)}
\FunctionTok{library}\NormalTok{(latticeExtra)}
\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{library}\NormalTok{(splines)}
\FunctionTok{library}\NormalTok{(mgcv)}
\FunctionTok{library}\NormalTok{(maps)}
\FunctionTok{library}\NormalTok{(mapproj)}
\end{Highlighting}
\end{Shaded}

数据可视化是一种重要的数据分析手段， R 提供了两套图形系统，分别是 graphics 包提供的基础绘图系统和 grid 包提供的栅格绘图系统，后者主要以两个 R 包为大家所熟知，一个是 lattice 包，另一个是 ggplot2 包。

Base 图形系统的扩展包 \href{https://github.com/KKPMW/basetheme}{basetheme} 可以设置主题，\href{https://github.com/jumpingrivers/prettyB}{prettyB} 和 \href{https://github.com/pmur002/gridgraphics}{gridGraphics}

为了方便记忆函数 \texttt{par} 的各个参数，Paul Murrell 整理了一份 \href{https://www.stat.auckland.ac.nz/~paul/R/parMemnonics.html}{助记符}，此外，LaTeX 宏包 \href{https://github.com/latexstudio/LaTeXPackages-CN}{geometry} 对版面设置有很多专业的说明

\hypertarget{graphics-elements}{%
\section{绘图基本要素}\label{graphics-elements}}

\hypertarget{base-points}{%
\subsection{点线}\label{base-points}}

点和线是最常见的画图元素，在 \texttt{plot} 函数中，分别用参数 \texttt{pch} 和 \texttt{lty} 来设定类型，点的大小、线的宽度分别用参数 \texttt{cex} 和 \texttt{lwd} 来指定，颜色由参数 \texttt{col} 设置。参数 \texttt{type} 不同的值设置如下，\texttt{p} 显示点，\texttt{l} 绘制线，\texttt{b} 同时绘制空心点，并用线连接，\texttt{c} 只有线，\texttt{o} 在线上绘制点，\texttt{s} 和 \texttt{S} 点线连接绘制阶梯图，\texttt{h} 绘制类似直方图一样的垂线，最后 \texttt{n} 表示什么也不画。

点 points 、线 grid 背景线 abline lines rug 刻度线（线段segments、箭头arrows）、

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-} Showing all the extra \& some char graphics symbols {-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{pchShow }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{extras =} \FunctionTok{c}\NormalTok{(}\StringTok{"*"}\NormalTok{, }\StringTok{"."}\NormalTok{, }\StringTok{"o"}\NormalTok{, }\StringTok{"O"}\NormalTok{, }\StringTok{"0"}\NormalTok{, }\StringTok{"+"}\NormalTok{, }\StringTok{"{-}"}\NormalTok{, }\StringTok{"|"}\NormalTok{, }\StringTok{"\%"}\NormalTok{, }\StringTok{"\#"}\NormalTok{),}
             \AttributeTok{cex =} \DecValTok{2}\NormalTok{, }\DocumentationTok{\#\# good for both .Device=="postscript" and "x11"}
             \AttributeTok{col =} \StringTok{"red3"}\NormalTok{, }\AttributeTok{bg =} \StringTok{"gold"}\NormalTok{, }\AttributeTok{coltext =} \StringTok{"brown"}\NormalTok{, }\AttributeTok{cextext =} \FloatTok{1.2}\NormalTok{,}
             \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}
               \StringTok{"plot symbols :  points (...  pch = *, cex ="}\NormalTok{,}
\NormalTok{               cex, }\StringTok{")"}
\NormalTok{             )) \{}
\NormalTok{    nex }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(extras)}
\NormalTok{    np }\OtherTok{\textless{}{-}} \DecValTok{26} \SpecialCharTok{+}\NormalTok{ nex}
\NormalTok{    ipch }\OtherTok{\textless{}{-}} \DecValTok{0}\SpecialCharTok{:}\NormalTok{(np }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{    k }\OtherTok{\textless{}{-}} \FunctionTok{floor}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(np))}
\NormalTok{    dd }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{    rx }\OtherTok{\textless{}{-}}\NormalTok{ dd }\SpecialCharTok{+} \FunctionTok{range}\NormalTok{(ix }\OtherTok{\textless{}{-}}\NormalTok{ ipch }\SpecialCharTok{\%/\%}\NormalTok{ k)}
\NormalTok{    ry }\OtherTok{\textless{}{-}}\NormalTok{ dd }\SpecialCharTok{+} \FunctionTok{range}\NormalTok{(iy }\OtherTok{\textless{}{-}} \DecValTok{3} \SpecialCharTok{+}\NormalTok{ (k }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{{-}}\NormalTok{ ipch }\SpecialCharTok{\%\%}\NormalTok{ k)}
\NormalTok{    pch }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(ipch) }\CommentTok{\# list with integers \& strings}
    \ControlFlowTok{if}\NormalTok{ (nex }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) pch[}\DecValTok{26} \SpecialCharTok{+} \DecValTok{1}\SpecialCharTok{:}\NormalTok{nex] }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(extras)}
    \FunctionTok{plot}\NormalTok{(rx, ry, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =}\NormalTok{ main)}
    \FunctionTok{abline}\NormalTok{(}\AttributeTok{v =}\NormalTok{ ix, }\AttributeTok{h =}\NormalTok{ iy, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{, }\AttributeTok{lty =} \StringTok{"dotted"}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{np) \{}
\NormalTok{      pc }\OtherTok{\textless{}{-}}\NormalTok{ pch[[i]]}
      \DocumentationTok{\#\# \textquotesingle{}col\textquotesingle{} symbols with a \textquotesingle{}bg\textquotesingle{}{-}colored interior (where available) :}
      \FunctionTok{points}\NormalTok{(ix[i], iy[i], }\AttributeTok{pch =}\NormalTok{ pc, }\AttributeTok{col =}\NormalTok{ col, }\AttributeTok{bg =}\NormalTok{ bg, }\AttributeTok{cex =}\NormalTok{ cex)}
      \ControlFlowTok{if}\NormalTok{ (cextext }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
        \FunctionTok{text}\NormalTok{(ix[i] }\SpecialCharTok{{-}} \FloatTok{0.3}\NormalTok{, iy[i], pc, }\AttributeTok{col =}\NormalTok{ coltext, }\AttributeTok{cex =}\NormalTok{ cextext)}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}

\FunctionTok{pchShow}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-2-1} 

}

\caption{不同的 pch 参数值}\label{fig:unnamed-chunk-2}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} test code for various pch specifications {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Try this in various font families (including Hershey)}
\CommentTok{\# and locales.  Use sign = {-}1 asserts we want Latin{-}1.}
\CommentTok{\# Standard cases in a MBCS locale will not plot the top half.}
\NormalTok{TestChars }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{sign =} \DecValTok{1}\NormalTok{, }\AttributeTok{font =} \DecValTok{1}\NormalTok{, ...) \{}
\NormalTok{  MB }\OtherTok{\textless{}{-}} \FunctionTok{l10n\_info}\NormalTok{()}\SpecialCharTok{$}\NormalTok{MBCS}
\NormalTok{  r }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (font }\SpecialCharTok{==} \DecValTok{5}\NormalTok{) \{}
\NormalTok{    sign }\OtherTok{\textless{}{-}} \DecValTok{1}
    \FunctionTok{c}\NormalTok{(}\DecValTok{32}\SpecialCharTok{:}\DecValTok{126}\NormalTok{, }\DecValTok{160}\SpecialCharTok{:}\DecValTok{254}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (MB) }\DecValTok{32}\SpecialCharTok{:}\DecValTok{126} \ControlFlowTok{else} \DecValTok{32}\SpecialCharTok{:}\DecValTok{255}
  \ControlFlowTok{if}\NormalTok{ (sign }\SpecialCharTok{==} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) r }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{32}\SpecialCharTok{:}\DecValTok{126}\NormalTok{, }\DecValTok{160}\SpecialCharTok{:}\DecValTok{255}\NormalTok{)}
  \FunctionTok{par}\NormalTok{(}\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{16}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{16}\NormalTok{),}
    \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
    \AttributeTok{xaxs =} \StringTok{"i"}\NormalTok{, }\AttributeTok{yaxs =} \StringTok{"i"}\NormalTok{,}
    \AttributeTok{main =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"sign = \%d, font = \%d"}\NormalTok{, sign, font)}
\NormalTok{  )}
  \FunctionTok{grid}\NormalTok{(}\DecValTok{17}\NormalTok{, }\DecValTok{17}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{)}
  \FunctionTok{mtext}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"MBCS:"}\NormalTok{, MB))}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in}\NormalTok{ r) }\FunctionTok{try}\NormalTok{(}\FunctionTok{points}\NormalTok{(i }\SpecialCharTok{\%\%} \DecValTok{16}\NormalTok{, i }\SpecialCharTok{\%/\%} \DecValTok{16}\NormalTok{, }\AttributeTok{pch =}\NormalTok{ sign }\SpecialCharTok{*}\NormalTok{ i, }\AttributeTok{font =}\NormalTok{ font, ...))}
\NormalTok{\}}
\FunctionTok{TestChars}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-3-1} 

}

\caption{pch 支持的字符}\label{fig:unnamed-chunk-3-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{try}\NormalTok{(}\FunctionTok{TestChars}\NormalTok{(}\AttributeTok{sign =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-3-2} 

}

\caption{pch 支持的字符}\label{fig:unnamed-chunk-3-2}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{TestChars}\NormalTok{(}\AttributeTok{font =} \DecValTok{5}\NormalTok{) }\CommentTok{\# Euro might be at 160 (0+10*16).}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-3-3} 

}

\caption{pch 支持的字符}\label{fig:unnamed-chunk-3-3}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# macOS has apple at 240 (0+15*16).}
\FunctionTok{try}\NormalTok{(}\FunctionTok{TestChars}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{font =} \DecValTok{2}\NormalTok{)) }\CommentTok{\# bold}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-3-4} 

}

\caption{pch 支持的字符}\label{fig:unnamed-chunk-3-4}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{0}\SpecialCharTok{:}\DecValTok{12}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(pi }\SpecialCharTok{/} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ x)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{mar =}\NormalTok{ .}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\ControlFlowTok{for}\NormalTok{ (tp }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\StringTok{"p"}\NormalTok{, }\StringTok{"l"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{"o"}\NormalTok{, }\StringTok{"h"}\NormalTok{, }\StringTok{"s"}\NormalTok{, }\StringTok{"S"}\NormalTok{, }\StringTok{"n"}\NormalTok{)) \{}
  \FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =}\NormalTok{ tp, }\AttributeTok{main =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"plot(*, type = }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, tp, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{)"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (tp }\SpecialCharTok{==} \StringTok{"S"}\NormalTok{) \{}
    \FunctionTok{lines}\NormalTok{(x, y, }\AttributeTok{type =} \StringTok{"s"}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
    \FunctionTok{mtext}\NormalTok{(}\StringTok{"lines(*, type = }\SpecialCharTok{\textbackslash{}"}\StringTok{s}\SpecialCharTok{\textbackslash{}"}\StringTok{, ...)"}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.8}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-4-1} 

}

\caption{不同的 type 参数值}\label{fig:unnamed-chunk-4}
\end{figure}

颜色 col 连续型和离散型

线帽/端和字体的样式

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 合并为一个图 三条粗横线 横线上三种字形}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{20}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{20}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{15}\NormalTok{, }\AttributeTok{lend =} \StringTok{"round"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{, }\StringTok{"Hello, Helvetica"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"sans"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{1}\NormalTok{, }\AttributeTok{offset =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\StringTok{"sans"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"sans"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{2}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{5}\NormalTok{, }\StringTok{"lend = round"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}

\FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{15}\NormalTok{, }\AttributeTok{lend =} \StringTok{"butt"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\StringTok{"Hello, Helvetica"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"mono"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{1}\NormalTok{, }\AttributeTok{offset =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\StringTok{"mono"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"mono"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{2}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{10}\NormalTok{, }\StringTok{"lend = butt"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}

\FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{15}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{15}\NormalTok{, }\AttributeTok{lend =} \StringTok{"square"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\StringTok{"Hello, Helvetica"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"serif"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{1}\NormalTok{, }\AttributeTok{offset =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{, }\StringTok{"serif"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"serif"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{2}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{15}\NormalTok{, }\StringTok{"lend = square"}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{, }\AttributeTok{offset =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-5-1} 

}

\caption{不同的线端样式}\label{fig:unnamed-chunk-5}
\end{figure}

lend：线端的样式，可用一个整数或字符串指定：

\begin{itemize}
\tightlist
\item
  0 或 ``round'' 圆形（默认）
\item
  1 或 ``butt'' 对接形
\item
  2 或 ``square'' 方形
\end{itemize}

\hypertarget{base-rect}{%
\subsection{区域}\label{base-rect}}

矩形，多边形，曲线交汇出来的区域 面（矩形rect，多边形polygon）、路径 polypath 面/多边形 rect 颜色填充

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# From the manual}
\NormalTok{ch.col }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"rainbow(n, start=.7, end=.1)"}\NormalTok{,}
  \StringTok{"heat.colors(n)"}\NormalTok{,}
  \StringTok{"terrain.colors(n)"}\NormalTok{,}
  \StringTok{"topo.colors(n)"}\NormalTok{,}
  \StringTok{"cm.colors(n)"}
\NormalTok{) }\CommentTok{\# 选择颜色}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{16}
\NormalTok{nt }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(ch.col)}
\NormalTok{i }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n}
\NormalTok{j }\OtherTok{\textless{}{-}}\NormalTok{ n }\SpecialCharTok{/}\NormalTok{ nt}
\NormalTok{d }\OtherTok{\textless{}{-}}\NormalTok{ j }\SpecialCharTok{/} \DecValTok{6}
\NormalTok{dy }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ d}
\FunctionTok{plot}\NormalTok{(i, i }\SpecialCharTok{+}\NormalTok{ d,}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"color palettes; n="}\NormalTok{, n)}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{nt) \{}
  \FunctionTok{rect}\NormalTok{(i }\SpecialCharTok{{-}}\NormalTok{ .}\DecValTok{5}\NormalTok{, (k }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ j }\SpecialCharTok{+}\NormalTok{ dy, i }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{4}\NormalTok{, k }\SpecialCharTok{*}\NormalTok{ j,}
    \AttributeTok{col =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ ch.col[k]))}
\NormalTok{  ) }\CommentTok{\# 咬人的函数/字符串解析为/转函数}
  \FunctionTok{text}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ j, k }\SpecialCharTok{*}\NormalTok{ j }\SpecialCharTok{+}\NormalTok{ dy }\SpecialCharTok{/} \DecValTok{4}\NormalTok{, ch.col[k])}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-6-1} 

}

\caption{rect 函数画长方形}\label{fig:unnamed-chunk-6}
\end{figure}

\texttt{clip(x1,\ x2,\ y1,\ y2)} 在用户坐标中设置剪切区域

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{1000}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(x, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\NormalTok{usr }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)}
\FunctionTok{clip}\NormalTok{(usr[}\DecValTok{1}\NormalTok{], }\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, usr[}\DecValTok{3}\NormalTok{], usr[}\DecValTok{4}\NormalTok{])}
\FunctionTok{hist}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{clip}\NormalTok{(}\DecValTok{2}\NormalTok{, usr[}\DecValTok{2}\NormalTok{], usr[}\DecValTok{3}\NormalTok{], usr[}\DecValTok{4}\NormalTok{])}
\FunctionTok{hist}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-7-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{do.call}\NormalTok{(}\StringTok{"clip"}\NormalTok{, }\FunctionTok{as.list}\NormalTok{(usr)) }\CommentTok{\# reset to plot region}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my.col }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(f, g, xmin, xmax, col, }\AttributeTok{N =} \DecValTok{200}\NormalTok{,}
                   \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{) \{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(xmin, xmax, }\AttributeTok{length =}\NormalTok{ N)}
\NormalTok{  fx }\OtherTok{\textless{}{-}} \FunctionTok{f}\NormalTok{(x)}
\NormalTok{  gx }\OtherTok{\textless{}{-}} \FunctionTok{g}\NormalTok{(x)}
  \FunctionTok{plot}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
    \AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(xmin, xmax),}
    \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(fx, gx), }\FunctionTok{max}\NormalTok{(fx, gx)),}
    \AttributeTok{xlab =}\NormalTok{ xlab, }\AttributeTok{ylab =}\NormalTok{ ylab, }\AttributeTok{main =}\NormalTok{ main}
\NormalTok{  )}
  \FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(x, }\FunctionTok{rev}\NormalTok{(x)), }\FunctionTok{c}\NormalTok{(fx, }\FunctionTok{rev}\NormalTok{(gx)),}
    \AttributeTok{col =} \StringTok{"\#EA4335"}\NormalTok{, }\AttributeTok{border =} \DecValTok{0}
\NormalTok{  )}
  \FunctionTok{lines}\NormalTok{(x, fx, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"\#34A853"}\NormalTok{)}
  \FunctionTok{lines}\NormalTok{(x, gx, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"\#4285f4"}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{my.col}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \DecValTok{10} \SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(x),}
  \SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\DecValTok{6}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"The }\SpecialCharTok{\textbackslash{}"}\StringTok{polygon}\SpecialCharTok{\textbackslash{}"}\StringTok{ function"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-8-1} 

}

\caption{区域重叠 polygon 函数}\label{fig:unnamed-chunk-8}
\end{figure}

各种符号 \ref{fig:cex-symbol}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{),}
  \AttributeTok{axes =}\NormalTok{ F,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{0}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{) \{}
\NormalTok{    n }\OtherTok{\textless{}{-}} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ i }\SpecialCharTok{+}\NormalTok{ j}
    \FunctionTok{points}\NormalTok{(j, i,}
      \AttributeTok{pch =}\NormalTok{ n,}
      \AttributeTok{cex =} \DecValTok{3}
\NormalTok{    )}
    \FunctionTok{text}\NormalTok{(j, i }\SpecialCharTok{{-}}\NormalTok{ .}\DecValTok{3}\NormalTok{, }\FunctionTok{as.character}\NormalTok{(n))}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/cex-symbol-1} 

}

\caption{cex 支持的符号}\label{fig:cex-symbol}
\end{figure}

点、线、多边形和圆聚集在图 \ref{fig:symbols} 中

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://jeroen.github.io/uros2018/\#23}
\FunctionTok{plot.new}\NormalTok{()}
\FunctionTok{plot.window}\NormalTok{(}\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{))}
\FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{80}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{col =} \StringTok{"hotpink"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{90}\NormalTok{, }\AttributeTok{labels =} \StringTok{"My drawing"}\NormalTok{, }\AttributeTok{col =} \StringTok{"navyblue"}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3}\NormalTok{)}
\FunctionTok{symbols}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{90}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{80}\NormalTok{),}
  \AttributeTok{circles =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{10}\NormalTok{),}
  \AttributeTok{bg =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4285f4"}\NormalTok{, }\StringTok{"\#EA4335"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{lty =} \StringTok{"dashed"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/symbols-1} 

}

\caption{多边形和符号元素}\label{fig:symbols}
\end{figure}

在介绍各种统计图形之前，先介绍几个绘图函数 \texttt{plot} 和 \texttt{text} 还有 \texttt{par} 参数设置， 作为最简单的开始，尽量依次介绍其中的每个参数的含义并附上图形对比。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y }\OtherTok{\textless{}{-}}\NormalTok{ x }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{ann =}\NormalTok{ F, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{)}
\FunctionTok{text}\NormalTok{(x, y,}
  \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"1st"}\NormalTok{, }\StringTok{"2nd"}\NormalTok{, }\StringTok{"3rd"}\NormalTok{, }\StringTok{"4th"}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pos =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{offset =} \FloatTok{0.6}
\NormalTok{)}
\NormalTok{ahat }\OtherTok{\textless{}{-}} \StringTok{"sigma"}
\CommentTok{\# title(substitute(hat(a) == ahat, list(ahat = ahat)))}
\FunctionTok{title}\NormalTok{(}\FunctionTok{bquote}\NormalTok{(}\FunctionTok{hat}\NormalTok{(a) }\SpecialCharTok{==}\NormalTok{ .(ahat)))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/pos-1} 

}

\caption{pos 位置参数}\label{fig:pos}
\end{figure}

其中 labels， pos 都是向量化的参数

\hypertarget{base-lines}{%
\subsection{参考线}\label{base-lines}}

矩形网格线是用做背景参考线的，常常是淡灰色的细密虚线，\texttt{plot} 函数的 \texttt{panel.first} 参数和 \texttt{grid} 函数常用来画这种参考线

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# modified from https://yihui.name/cn/2018/02/cohen{-}s{-}d/}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{30} \CommentTok{\# 样本量（只是一个例子）}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.1}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(x }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n), }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{pt}\NormalTok{(x, n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)),}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(}\AttributeTok{d =}\NormalTok{ x }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n)),}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{()}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/bg-grid-lines-1} 

}

\caption{添加背景参考线}\label{fig:bg-grid-lines}
\end{figure}

\hypertarget{base-axis}{%
\subsection{坐标轴}\label{base-axis}}

图形控制参数默认设置下 \texttt{par} 通常的一幅图形，改变坐标轴标签是很简单的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{100}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{100}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-9-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlab =} \StringTok{"Index"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Uniform draws"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-9-2} \end{center}

改变坐标轴标签和标题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{no.readonly =} \ConstantTok{TRUE}\NormalTok{) }\CommentTok{\# 保存默认的 par 设置}
\FunctionTok{par}\NormalTok{(}\AttributeTok{cex.lab =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex.axis =} \FloatTok{1.3}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlab =} \StringTok{"Index"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Uniform draws"}\NormalTok{)}

\CommentTok{\# 设置更大的坐标轴标签内容}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{cex.axis =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex.lab =} \DecValTok{2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlab =} \StringTok{"Index"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Uniform draws"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-10-1} \end{center}

使用 axis 函数可以更加精细地控制坐标轴

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op) }\CommentTok{\# 恢复默认的 par 设置}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{) }\CommentTok{\# 去掉 x 轴}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{)) }\CommentTok{\# 添加指定的刻度标签}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-11-1} \end{center}

指定刻度标签的内容

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Small"}\NormalTok{, }\StringTok{"Medium"}\NormalTok{, }\StringTok{"Big"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-12-1} \end{center}

控制刻度线和轴线和刻度标签

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(x, y)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{75}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{4}\NormalTok{, }\AttributeTok{lwd.ticks =} \DecValTok{2}\NormalTok{, }\AttributeTok{col.ticks =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-13-1} \end{center}

还可以把 box 移除，绘图区域的边框去掉，只保留坐标轴

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{bty =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{20}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-14-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 双Y轴}
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length =}\NormalTok{ N)}
\NormalTok{y1 }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x)}
\NormalTok{y2 }\OtherTok{\textless{}{-}} \FunctionTok{cos}\NormalTok{(x)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)) }\CommentTok{\# Add some space in the right margin}
\CommentTok{\# The default is c(5,4,4,2) + .1}
\NormalTok{xlim }\OtherTok{\textless{}{-}} \FunctionTok{range}\NormalTok{(x)}
\NormalTok{ylim }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.1}\NormalTok{, }\FloatTok{1.1}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y1,}
  \AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
  \AttributeTok{xlim =}\NormalTok{ xlim, }\AttributeTok{ylim =}\NormalTok{ ylim,}
  \AttributeTok{axes =}\NormalTok{ F, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{"Title"}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y2,}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
  \AttributeTok{xlim =}\NormalTok{ xlim, }\AttributeTok{ylim =}\NormalTok{ ylim,}
  \AttributeTok{axes =}\NormalTok{ F, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{4}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"First Y axis"}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{line =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.2}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Second Y axis"}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{line =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.65\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-15-1} 

}

\caption{两个 Y 轴}\label{fig:unnamed-chunk-15}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1,2,3,4 分别代表下左上右四个位置}
\end{Highlighting}
\end{Shaded}

调整坐标轴标签的距离

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Changing default gap between labels:}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\FunctionTok{quote}\NormalTok{(}\StringTok{"axis(1, .., gap.axis = f),"} \SpecialCharTok{\textasciitilde{}} \ErrorTok{\textasciitilde{}}\NormalTok{ f }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{))}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{at =} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{0}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{gap.axis =} \DecValTok{1} \SpecialCharTok{/} \DecValTok{4}\NormalTok{)}
\NormalTok{gaps }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1} \SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{1} \SpecialCharTok{/} \DecValTok{4}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{chG }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}
  \FunctionTok{ifelse}\NormalTok{(gaps }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"default:  "}\NormalTok{, }\StringTok{""}\NormalTok{),}
  \StringTok{"gap.axis="}\NormalTok{, }\FunctionTok{formatC}\NormalTok{(gaps)}
\NormalTok{)}
\NormalTok{jj }\OtherTok{\textless{}{-}} \FunctionTok{seq\_along}\NormalTok{(gaps)}
\NormalTok{linG }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FloatTok{2.5} \SpecialCharTok{*}\NormalTok{ (jj }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in}\NormalTok{ jj) \{}
\NormalTok{  isD }\OtherTok{\textless{}{-}}\NormalTok{ gaps[j] }\SpecialCharTok{==} \DecValTok{1} \CommentTok{\# is default}
  \FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
    \AttributeTok{at =} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{0}\SpecialCharTok{:}\DecValTok{20}\NormalTok{), }\AttributeTok{gap.axis =}\NormalTok{ gaps[j], }\AttributeTok{padj =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{line =}\NormalTok{ linG[j],}
    \AttributeTok{col.axis =} \ControlFlowTok{if}\NormalTok{ (isD) }\StringTok{"forest green"} \ControlFlowTok{else} \DecValTok{1}\NormalTok{, }\AttributeTok{font.axis =} \DecValTok{1} \SpecialCharTok{+}\NormalTok{ isD}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{mtext}\NormalTok{(chG,}
  \AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{padj =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{line =}\NormalTok{ linG }\SpecialCharTok{{-}} \DecValTok{1} \SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3} \SpecialCharTok{/} \DecValTok{4}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{ifelse}\NormalTok{(gaps }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"forest green"}\NormalTok{, }\StringTok{"blue3"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/gap-axis-1} 

}

\caption{gap.axis用法}\label{fig:gap-axis}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# now shrink the window (in x{-} and y{-}direction) and observe the axis labels drawn}
\end{Highlighting}
\end{Shaded}

旋转坐标轴标签

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Rotated axis labels in R plots}
\CommentTok{\# https://menugget.blogspot.com/2014/08/rotated{-}axis{-}labels{-}in{-}r{-}plots.html}
\CommentTok{\# Example data}
\NormalTok{tmin }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2000{-}01{-}01"}\NormalTok{)}
\NormalTok{tmax }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2001{-}01{-}01"}\NormalTok{)}
\NormalTok{tlab }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(tmin, tmax, }\AttributeTok{by =} \StringTok{"month"}\NormalTok{)}
\NormalTok{lab }\OtherTok{\textless{}{-}} \FunctionTok{format}\NormalTok{(tlab, }\AttributeTok{format =} \StringTok{"\%Y{-}\%b"}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{111}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(tmin, tmax, }\AttributeTok{length.out =} \DecValTok{100}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{cumsum}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{))}

\CommentTok{\# Plot}
\CommentTok{\# png("plot\_w\_rotated\_axis\_labels.png", height = 3,}
\CommentTok{\#     width = 6, units = "in", res = 300)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{t =} \StringTok{"l"}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{at =}\NormalTok{ tlab, }\AttributeTok{labels =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ tlab, }\AttributeTok{y =} \FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{usr[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \FloatTok{0.1} \SpecialCharTok{*}\NormalTok{ (}\FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{usr[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{usr[}\DecValTok{3}\NormalTok{]),}
  \AttributeTok{labels =}\NormalTok{ lab, }\AttributeTok{srt =} \DecValTok{45}\NormalTok{, }\AttributeTok{adj =} \DecValTok{1}\NormalTok{, }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-16-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\CommentTok{\# dev.off()}
\end{Highlighting}
\end{Shaded}

旋转坐标抽标签的例子来自手册《R FAQ》的第7章第27个问题 \citep{R-FAQ}，在基础图形中，旋转坐标轴标签需要 \texttt{text()} 而不是 \texttt{mtext()}，因为后者不支持\texttt{par("srt")}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Increase bottom margin to make room for rotated labels}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\DecValTok{2}\NormalTok{) }\SpecialCharTok{+} \FloatTok{0.1}\NormalTok{)}
\DocumentationTok{\#\# Create plot with no x axis and no x axis label}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{)}
\DocumentationTok{\#\# Set up x axis with tick marks alone}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \ConstantTok{FALSE}\NormalTok{)}
\DocumentationTok{\#\# Create some text labels}
\NormalTok{labels }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Label"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
\DocumentationTok{\#\# Plot x axis labels at default tick marks}
\FunctionTok{text}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{,}
  \AttributeTok{srt =} \DecValTok{45}\NormalTok{, }\AttributeTok{adj =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{labels =}\NormalTok{ labels, }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\DocumentationTok{\#\# Plot x axis label at line 6 (of 7)}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{text =} \StringTok{"X Axis Label"}\NormalTok{, }\AttributeTok{line =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/rotate-axis-labels-1} 

}

\caption{旋转坐标轴标签}\label{fig:rotate-axis-labels}
\end{figure}

\texttt{srt\ =\ 45} 表示文本旋转角度， \texttt{xpd\ =\ TRUE} 允许文本越出绘图区域，\texttt{adj\ =\ 1} to place the right end of text at the tick marks；You can adjust the value of the 0.5 offset as required to move the axis labels up or down relative to the x axis. 详细地参考 \citep{Paul_2003_Integrating}

\hypertarget{base-tick}{%
\subsection{刻度线}\label{base-tick}}

通过 \texttt{par} 或 \texttt{axis} 函数实现刻度线的精细操作，tcl 控制刻度线的长度，正值让刻度画在绘图区域内，负值正好相反，画在外面，mgp 参数有三个值，第一个值控制绘图区域和坐标轴标题之间的行数，第二个是绘图区域与坐标轴标签的行数，第三个绘图区域与轴线的行数，行数表示间距

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{tcl =} \FloatTok{0.4}\NormalTok{, }\AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-17-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 又一个例子}
\FunctionTok{par}\NormalTok{(op)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{95}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{tcl =} \FloatTok{0.4}\NormalTok{, }\AttributeTok{lwd.ticks =} \DecValTok{3}\NormalTok{, }\AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{text =} \StringTok{"X axis"}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.5}\NormalTok{) }
\CommentTok{\# mtext 设置坐标轴标签}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{tcl =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{lwd.ticks =} \DecValTok{3}\NormalTok{, }\AttributeTok{col.ticks =} \StringTok{"orange"}\NormalTok{, }\AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{text =} \StringTok{"Numbers taken randomly"}\NormalTok{, }\AttributeTok{line =} \FloatTok{2.2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-17-2} \end{center}

\hypertarget{base-title}{%
\subsection{标题}\label{base-title}}

添加多个标题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(N, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x) }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{5} \SpecialCharTok{*} \FunctionTok{rnorm}\NormalTok{(N)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Subtitle"}\NormalTok{, }\DecValTok{3}\NormalTok{, }\AttributeTok{line =}\NormalTok{ .}\DecValTok{8}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Title"}\NormalTok{, }\DecValTok{3}\NormalTok{, }\AttributeTok{line =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"X axis"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{line =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"X axis subtitle"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{line =} \FloatTok{3.7}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-18-1} 

}

\caption{图标题/子标题 x轴标题/子标题}\label{fig:unnamed-chunk-18}
\end{figure}

\hypertarget{base-annotation}{%
\subsection{注释}\label{base-annotation}}

数学符号注释，图\ref{fig:math-annotation} 自定义坐标轴 \citep{Paul_2000_Approach}。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 自定义坐标轴}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e6}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, pi),}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{log =} \StringTok{"x"}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{1e2}\NormalTok{, }\FloatTok{1e4}\NormalTok{, }\FloatTok{1e6}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{expression}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{, }\DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{6}\NormalTok{)}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, }\SpecialCharTok{{-}}\NormalTok{pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, pi),}
  \AttributeTok{labels =} \FunctionTok{expression}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, }\SpecialCharTok{{-}}\NormalTok{pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, pi)}
\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\FloatTok{1e3}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(}\StringTok{"Customized Axes"}\NormalTok{)))}
\FunctionTok{box}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/math-annotation-1} 

}

\caption{创建自定义的坐标轴和刻度标签}\label{fig:math-annotation}
\end{figure}

在标题中添加数学公式

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\AttributeTok{length =} \DecValTok{200}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \FunctionTok{expression}\NormalTok{(}
  \StringTok{"graph of the function f"}\NormalTok{(x) }\SpecialCharTok{==} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-19-1} 

}

\caption{标题含有数学公式}\label{fig:unnamed-chunk-19}
\end{figure}

修改参数使用 \texttt{substitute} 函数批量生成

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\AttributeTok{length =} \DecValTok{200}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{ }\CommentTok{\# 画四个图}
\NormalTok{  y }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(i }\SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
  \FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
    \AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
    \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{6}\NormalTok{),}
    \AttributeTok{ylab =} \FunctionTok{substitute}\NormalTok{(}
      \FunctionTok{expression}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(i }\SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)),}
      \FunctionTok{list}\NormalTok{(}\AttributeTok{i =}\NormalTok{ i)}
\NormalTok{    )}
\NormalTok{  )}
  \FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \FunctionTok{substitute}\NormalTok{(}
    \StringTok{"graph of the function f"}\NormalTok{(x) }\SpecialCharTok{==} \FunctionTok{sqrt}\NormalTok{(i }\SpecialCharTok{+}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{),}
    \FunctionTok{list}\NormalTok{(}\AttributeTok{i =}\NormalTok{ i)}
\NormalTok{  ))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-20-1} 

}

\caption{批量生成函数图形}\label{fig:unnamed-chunk-20-1}
\end{figure}
\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-20-2} 

}

\caption{批量生成函数图形}\label{fig:unnamed-chunk-20-2}
\end{figure}
\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-20-3} 

}

\caption{批量生成函数图形}\label{fig:unnamed-chunk-20-3}
\end{figure}
\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-20-4} 

}

\caption{批量生成函数图形}\label{fig:unnamed-chunk-20-4}
\end{figure}

基础绘图函数，如 plot 标签 \texttt{xlab} 支持 Unicode 代码表示的希腊字母，常用字母表备查，公式环境下，也可以用在绘图中

\begin{longtable}[]{@{}llllll@{}}
\caption{\label{tab:letters} 希腊字母表}\tabularnewline
\toprule
希腊字母 & LaTeX 代码 & Unicode 代码 & 希腊字母 & LaTeX 代码 & Unicode 代码 \\
\midrule
\endfirsthead
\toprule
希腊字母 & LaTeX 代码 & Unicode 代码 & 希腊字母 & LaTeX 代码 & Unicode 代码 \\
\midrule
\endhead
\(\alpha\) & \texttt{\textbackslash{}alpha} & \texttt{\textbackslash{}u03B1} & \(\mu\) & \texttt{\textbackslash{}mu} & \texttt{\textbackslash{}u03BC} \\
\(\beta\) & \texttt{\textbackslash{}beta} & \texttt{\textbackslash{}u03B2} & \(\nu\) & \texttt{\textbackslash{}nu} & \texttt{\textbackslash{}u03BD} \\
\(\gamma\) & \texttt{\textbackslash{}gamma} & \texttt{\textbackslash{}u03B3} & \(\xi\) & \texttt{\textbackslash{}xi} & \texttt{\textbackslash{}u03BE} \\
\(\delta\) & \texttt{\textbackslash{}delta} & \texttt{\textbackslash{}u03B4} & \(\varphi\) & \texttt{\textbackslash{}varphi} & \texttt{\textbackslash{}u03C6} \\
\(\epsilon\) & \texttt{\textbackslash{}epsilon} & \texttt{\textbackslash{}u03B5} & \(\pi\) & \texttt{\textbackslash{}pi} & \texttt{\textbackslash{}u03C0} \\
\(\zeta\) & \texttt{\textbackslash{}zeta} & \texttt{\textbackslash{}u03B6} & \(\rho\) & \texttt{\textbackslash{}rho} & \texttt{\textbackslash{}u03C1} \\
\(\eta\) & \texttt{\textbackslash{}eta} & \texttt{\textbackslash{}u03B7} & \(\upsilon\) & \texttt{\textbackslash{}upsilon} & \texttt{\textbackslash{}u03C5} \\
\(\theta\) & \texttt{\textbackslash{}theta} & \texttt{\textbackslash{}u03B8} & \(\phi\) & \texttt{\textbackslash{}phi} & \texttt{\textbackslash{}u03C6} \\
\(\iota\) & \texttt{\textbackslash{}iota} & \texttt{\textbackslash{}u03B9} & \(\chi\) & \texttt{\textbackslash{}chi} & \texttt{\textbackslash{}u03C7} \\
\(\kappa\) & \texttt{\textbackslash{}kappa} & \texttt{\textbackslash{}u03BA} & \(\psi\) & \texttt{\textbackslash{}psi} & \texttt{\textbackslash{}u03C8} \\
\(\lambda\) & \texttt{\textbackslash{}lambda} & \texttt{\textbackslash{}u03BB} & \(\omega\) & \texttt{\textbackslash{}omega} & \texttt{\textbackslash{}u03C9} \\
\(\sigma\) & \texttt{\textbackslash{}sigma} & \texttt{\textbackslash{}u03C3} & \(\tau\) & \texttt{\textbackslash{}tau} & \texttt{\textbackslash{}u03C4} \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}llllll@{}}
\caption{\label{tab:super-sub-script} 数字上下标}\tabularnewline
\toprule
上标数字 & LaTeX 代码 & Unicode 代码 & 下标数字 & LaTeX 代码 & Unicode 代码 \\
\midrule
\endfirsthead
\toprule
上标数字 & LaTeX 代码 & Unicode 代码 & 下标数字 & LaTeX 代码 & Unicode 代码 \\
\midrule
\endhead
\({}^0\) & \texttt{\{\}\^{}0} & \texttt{\textbackslash{}u2070} & \({}_0\) & \texttt{\{\}\_0} & \texttt{\textbackslash{}u2080} \\
\({}^1\) & \texttt{\{\}\^{}1} & \texttt{\textbackslash{}u00B9} & \({}_1\) & \texttt{\{\}\_1} & \texttt{\textbackslash{}u2081} \\
\({}^2\) & \texttt{\{\}\^{}2} & \texttt{\textbackslash{}u00B2} & \({}_2\) & \texttt{\{\}\_2} & \texttt{\textbackslash{}u2082} \\
\({}^3\) & \texttt{\{\}\^{}3} & \texttt{\textbackslash{}u00B2} & \({}_3\) & \texttt{\{\}\_3} & \texttt{\textbackslash{}u2083} \\
\({}^4\) & \texttt{\{\}\^{}4} & \texttt{\textbackslash{}u2074} & \({}_4\) & \texttt{\{\}\_4} & \texttt{\textbackslash{}u2084} \\
\({}^5\) & \texttt{\{\}\^{}5} & \texttt{\textbackslash{}u2075} & \({}_5\) & \texttt{\{\}\_5} & \texttt{\textbackslash{}u2085} \\
\({}^6\) & \texttt{\{\}\^{}6} & \texttt{\textbackslash{}u2076} & \({}_6\) & \texttt{\{\}\_6} & \texttt{\textbackslash{}u2086} \\
\({}^7\) & \texttt{\{\}\^{}7} & \texttt{\textbackslash{}u2077} & \({}_7\) & \texttt{\{\}\_7} & \texttt{\textbackslash{}u2087} \\
\({}^8\) & \texttt{\{\}\^{}8} & \texttt{\textbackslash{}u2078} & \({}_8\) & \texttt{\{\}\_8} & \texttt{\textbackslash{}u2088} \\
\({}^9\) & \texttt{\{\}\^{}9} & \texttt{\textbackslash{}u2079} & \({}_9\) & \texttt{\{\}\_9} & \texttt{\textbackslash{}u2089} \\
\({}^n\) & \texttt{\{\}\^{}n} & \texttt{\textbackslash{}u207F} & \({}_n\) & \texttt{\{\}\_n} & - \\
\bottomrule
\end{longtable}

其它字母，请查看 \href{https://www.ssec.wisc.edu/~tomw/java/unicode.html}{Unicode 字母表}

\hypertarget{base-legend}{%
\subsection{图例}\label{base-legend}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\DecValTok{6}\NormalTok{, }\AttributeTok{length =} \DecValTok{200}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{cos}\NormalTok{(x)}
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"angle"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Trigonometric functions"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
  \AttributeTok{yjust =} \DecValTok{0}\NormalTok{,}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sine"}\NormalTok{, }\StringTok{"Cosine"}\NormalTok{),}
  \AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"fg"}\NormalTok{), }\StringTok{"red"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-21-1} 

}

\caption{三角函数添加图例}\label{fig:unnamed-chunk-21}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xmin }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{1}\NormalTok{]}
\NormalTok{xmax }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{2}\NormalTok{]}
\NormalTok{ymin }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{]}
\NormalTok{ymax }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{4}\NormalTok{]}

\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"angle"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Trigonometric functions"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{,}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sine"}\NormalTok{, }\StringTok{"Cosine"}\NormalTok{),}
  \AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"fg"}\NormalTok{), }\StringTok{"red"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-22-1} 

}

\caption{设置图例的位置}\label{fig:unnamed-chunk-22}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"angle"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Trigonometric functions"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{,}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sine"}\NormalTok{, }\StringTok{"Cosine"}\NormalTok{),}
  \AttributeTok{inset =} \FunctionTok{c}\NormalTok{(.}\DecValTok{03}\NormalTok{, .}\DecValTok{03}\NormalTok{),}
  \AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"fg"}\NormalTok{), }\StringTok{"red"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-23-1} 

}

\caption{insert 函数微调图例位置}\label{fig:unnamed-chunk-23}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{no.readonly =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"angle"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Trigonometric functions"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \DecValTok{0}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{xpd =} \ConstantTok{TRUE}\NormalTok{) }\CommentTok{\# Do not clip to the drawing area 关键一行/允许出界}
\NormalTok{lambda }\OtherTok{\textless{}{-}}\NormalTok{ .}\DecValTok{025}
\FunctionTok{legend}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{1}\NormalTok{],}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ lambda) }\SpecialCharTok{*} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ lambda }\SpecialCharTok{*} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{],}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sine"}\NormalTok{, }\StringTok{"Cosine"}\NormalTok{),}
  \AttributeTok{xjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{yjust =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{lwd =} \DecValTok{3}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\FunctionTok{par}\NormalTok{(}\StringTok{"fg"}\NormalTok{), }\StringTok{"red"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-24-1} 

}

\caption{将图例放在绘图区域外面}\label{fig:unnamed-chunk-24}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

Hmisc 包的 labcurve 函数可以在曲线上放置名称，而不是遥远的图例上

\hypertarget{base-par}{%
\subsection{边空}\label{base-par}}

边空分为内边空和外边空

\begin{figure}

{\centering \subfloat[内边空\label{fig:par-mai-oma-1}]{\includegraphics[width=0.35\linewidth]{../../../../../opt/R/4.2.0/lib/R/library/graphics/help/figures/mai} }\subfloat[外边空\label{fig:par-mai-oma-2}]{\includegraphics[width=0.35\linewidth]{../../../../../opt/R/4.2.0/lib/R/library/graphics/help/figures/oma} }

}

\caption{边空}\label{fig:par-mai-oma}
\end{figure}

\texttt{line} 第一行

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(N, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x) }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{5} \SpecialCharTok{*} \FunctionTok{rnorm}\NormalTok{(N)}
\FunctionTok{plot}\NormalTok{(x, y,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}
    \StringTok{"The }\SpecialCharTok{\textbackslash{}"}\StringTok{mtext}\SpecialCharTok{\textbackslash{}"}\StringTok{ function"}\NormalTok{,}
    \FunctionTok{paste}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{" "}\NormalTok{, }\DecValTok{60}\NormalTok{), }\AttributeTok{collapse =} \StringTok{""}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{1}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{)) \{}
  \FunctionTok{mtext}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Line"}\NormalTok{, i), }\DecValTok{3}\NormalTok{, }\AttributeTok{line =}\NormalTok{ i)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-25-1} 

}

\caption{外边空在图的边缘添加文字}\label{fig:unnamed-chunk-25}
\end{figure}

\texttt{par}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 多图排列/分屏 page 47}
\CommentTok{\# 最常用的是 par mfrow mfcol分别按行/列放置图形}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}
  \AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{0}\NormalTok{) }\CommentTok{\# Outer margins}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{),}
    \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"random plot ("}\NormalTok{, i, }\StringTok{")"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(op)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Four plots, without enough room for this title"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{font =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}
\NormalTok{) }\CommentTok{\# 总/大标题放不下}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-26-1} 

}

\caption{多图排列共享一个大标题}\label{fig:unnamed-chunk-26}
\end{figure}

\texttt{par} 的 oma 用来设置外边空的大小，默认情形下没有外边空的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{oma}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0 0 0 0
\end{verbatim}

我们可以自己设置外边空

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}
  \AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{) }\CommentTok{\# Outer margins}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{),}
    \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"random plot ("}\NormalTok{, i, }\StringTok{")"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(op)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Four plots, with some room for this title"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{font =} \DecValTok{1}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-28-1} 

}

\caption{设置外边空放置大标题}\label{fig:unnamed-chunk-28}
\end{figure}

除了内边空还有外边空，内外边空用来放注释说明

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{no.readonly =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (side }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
\NormalTok{  inner }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{mar[side], }\DecValTok{0}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{1}
  \ControlFlowTok{for}\NormalTok{ (line }\ControlFlowTok{in} \DecValTok{0}\SpecialCharTok{:}\NormalTok{inner) \{}
    \FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Inner line "}\NormalTok{, line), }\AttributeTok{side =}\NormalTok{ side, }\AttributeTok{line =}\NormalTok{ line)}
\NormalTok{  \}}
\NormalTok{  outer }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{par}\NormalTok{()}\SpecialCharTok{$}\NormalTok{oma[side], }\DecValTok{0}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{1}
  \ControlFlowTok{for}\NormalTok{ (line }\ControlFlowTok{in} \DecValTok{0}\SpecialCharTok{:}\NormalTok{inner) \{}
    \FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer line "}\NormalTok{, line), }\AttributeTok{side =}\NormalTok{ side, }\AttributeTok{line =}\NormalTok{ line, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-29-1} \end{center}

外边空可以用来放图例

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\NormalTok{cols }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{5}\NormalTok{), }\AttributeTok{each =} \DecValTok{2}\NormalTok{)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{pch =} \DecValTok{16}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{col =}\NormalTok{ cols, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \StringTok{"A common x{-}axis label"}\NormalTok{, }\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{line =} \DecValTok{0}\NormalTok{, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \StringTok{"A common y{-}axis label"}\NormalTok{, }\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{line =} \DecValTok{0}\NormalTok{, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}
  \AttributeTok{x =} \DecValTok{1}\NormalTok{, }\AttributeTok{y =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{legend =}\NormalTok{ LETTERS[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{],}
  \AttributeTok{col =} \FunctionTok{unique}\NormalTok{(cols), }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{bty =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xpd =} \ConstantTok{NA}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-30-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

坐标轴标签 \texttt{xlab} 和 \texttt{ylab} 的内容很长的时候需要内边空

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{cex.lab =} \FloatTok{1.7}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"A very very long axis title}\SpecialCharTok{\textbackslash{}n}\StringTok{that need special care"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}
\NormalTok{)}

\CommentTok{\# 增加内边空的大小}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"A very very long axis title}\SpecialCharTok{\textbackslash{}n}\StringTok{that need special care"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-31-1} \end{center}

有时候，仅仅增加内边空还不够，坐标轴标签内容甚至可以出现在绘图区域外面，设置 \texttt{outer\ =\ TRUE}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}
  \AttributeTok{text =} \StringTok{"A very very long axis title}\SpecialCharTok{\textbackslash{}n}\StringTok{that need special care"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{line =} \DecValTok{0}\NormalTok{, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.7}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-32-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}
  \AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{),}
  \AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{1} \CommentTok{\# Margins}
\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) \{}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{20}\NormalTok{),}
    \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
    \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"random plot ("}\NormalTok{, i, }\StringTok{")"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(op)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Title"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{font =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-33-1} 

}

\caption{设置每个子图的边空 mar}\label{fig:unnamed-chunk-33}
\end{figure}

\hypertarget{base-layer}{%
\subsection{图层}\label{base-layer}}

覆盖图形 \texttt{add\ =\ T} or \texttt{par(new=TRUE)}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"\#EA4335"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3}
\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{segments}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{), }\FunctionTok{runif}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"blue"}
\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Overlaying points, segments, lines..."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-34-1} 

}

\caption{添加图层}\label{fig:unnamed-chunk-34}
\end{figure}

\hypertarget{base-layout}{%
\subsection{布局}\label{base-layout}}

\texttt{layout} 函数布局， 绘制复杂组合图形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{oma =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{layout}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
  \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{,}
  \DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{,}
  \DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}
\NormalTok{), }\AttributeTok{nr =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{))}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n), }\AttributeTok{col =} \StringTok{"light blue"}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n), }\AttributeTok{col =} \StringTok{"light blue"}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n), }\AttributeTok{col =} \StringTok{"light blue"}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n), }\AttributeTok{col =} \StringTok{"light blue"}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"The }\SpecialCharTok{\textbackslash{}"}\StringTok{layout}\SpecialCharTok{\textbackslash{}"}\StringTok{ function"}\NormalTok{,}
  \AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{outer =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{font =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \FloatTok{1.2}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-35-1} 

}

\caption{更加复杂的组合图形}\label{fig:unnamed-chunk-35}
\end{figure}

\hypertarget{base-combine}{%
\subsection{组合}\label{base-combine}}

\texttt{par} 之 \texttt{fig} 参数很神奇，使得多个图可以叠加在一起，它接受一个数值向量\texttt{c(x1,\ x2,\ y1,\ y2)} ，是图形设备显示区域中的绘图区域的(NDC, normalized device coordinates)坐标。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"b"}\NormalTok{, }\AttributeTok{main =} \StringTok{"\textquotesingle{}fg\textquotesingle{} : axes, ticks and box in gray"}\NormalTok{,}
  \AttributeTok{fg =} \FunctionTok{gray}\NormalTok{(}\FloatTok{0.7}\NormalTok{), }\AttributeTok{bty =} \StringTok{"7"}\NormalTok{, }\AttributeTok{sub =}\NormalTok{ R.version.string}
\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{fig =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{, }\AttributeTok{new =}\NormalTok{ T)}
\FunctionTok{plot}\NormalTok{(}\DecValTok{6}\SpecialCharTok{:}\DecValTok{10}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"b"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{fg =} \FunctionTok{gray}\NormalTok{(}\FloatTok{0.7}\NormalTok{), }\AttributeTok{bty =} \StringTok{"7"}\NormalTok{, }\AttributeTok{xlab =}\NormalTok{ R.version.string}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-36-1} 

}

\caption{多图叠加}\label{fig:unnamed-chunk-36}
\end{figure}

\texttt{fig} 参数控制图形的位置，用来绘制组合图形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{1000}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rt}\NormalTok{(n, }\AttributeTok{df =} \DecValTok{10}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(x,}
  \AttributeTok{col =} \StringTok{"light blue"}\NormalTok{,}
  \AttributeTok{probability =} \StringTok{"TRUE"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{1.2} \SpecialCharTok{*} \FunctionTok{max}\NormalTok{(}\FunctionTok{density}\NormalTok{(x)}\SpecialCharTok{$}\NormalTok{y))}
\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(x),}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{,}
  \AttributeTok{lwd =} \DecValTok{3}
\NormalTok{)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}
  \AttributeTok{fig =} \FunctionTok{c}\NormalTok{(.}\DecValTok{02}\NormalTok{, .}\DecValTok{4}\NormalTok{, .}\DecValTok{5}\NormalTok{, .}\DecValTok{98}\NormalTok{),}
  \AttributeTok{new =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{qqnorm}\NormalTok{(x,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{axes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{qqline}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-37-1} 

}

\caption{组合图形}\label{fig:unnamed-chunk-37}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

\hypertarget{base-screen}{%
\subsection{分屏}\label{base-screen}}

\texttt{split.screen} 分屏组合

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{random.plot }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
\NormalTok{  N }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{  f }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}
    \FunctionTok{list}\NormalTok{(}
\NormalTok{      rnorm,}
      \ControlFlowTok{function}\NormalTok{(x) \{}
        \FunctionTok{rt}\NormalTok{(x, }\AttributeTok{df =} \DecValTok{2}\NormalTok{)}
\NormalTok{      \},}
\NormalTok{      rlnorm,}
\NormalTok{      runif}
\NormalTok{    ),}
    \DecValTok{1}
\NormalTok{  ) [[}\DecValTok{1}\NormalTok{]]}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{f}\NormalTok{(N)}
  \FunctionTok{hist}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{axes =}\NormalTok{ F)}
  \FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{\}}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{bg =} \StringTok{"white"}\NormalTok{, }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{2.5}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{split.screen}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{split.screen}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{screen =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3 4 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{screen}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\FunctionTok{random.plot}\NormalTok{()}
\CommentTok{\# screen(2); random.plot() \# Screen 2 was split into three screens: 3, 4, 5}
\FunctionTok{screen}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\FunctionTok{random.plot}\NormalTok{()}
\FunctionTok{screen}\NormalTok{(}\DecValTok{4}\NormalTok{)}
\FunctionTok{random.plot}\NormalTok{()}
\FunctionTok{screen}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\FunctionTok{random.plot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-38-1} 

}

\caption{分屏}\label{fig:unnamed-chunk-38}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{close.screen}\NormalTok{(}\AttributeTok{all =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{par}\NormalTok{(op)}
\end{Highlighting}
\end{Shaded}

\hypertarget{identify-locator}{%
\subsection{交互}\label{identify-locator}}

辅助绘图 identify locator

\hypertarget{base-graphics}{%
\section{基础统计图形}\label{base-graphics}}

按图的类型划分，最后在小结部分给出各图适用的数据类型

根据数据类型划分： 对于一元数据，可用什么图来描述；多元数据呢，连续数据和离散数据（分类数据）

先找一个不重不漏的划分，指导原则是根据数据类型选择图，根据探索到的数据中的规律，选择图

其它 assocplot fourfoldplot sunflowerplot

\hypertarget{plot-bar}{%
\subsection{条形图}\label{plot-bar}}

\href{https://rpubs.com/chidungkt/392980}{条形图}

简单条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(diamonds, }\AttributeTok{package =} \StringTok{"ggplot2"}\NormalTok{) }\CommentTok{\# 加载数据}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{barCenters }\OtherTok{\textless{}{-}} \FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(diamonds}\SpecialCharTok{$}\NormalTok{cut),}
  \AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{axisnames =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}
\NormalTok{)}
\FunctionTok{text}\NormalTok{(}
  \AttributeTok{y =}\NormalTok{ barCenters, }\AttributeTok{x =} \FunctionTok{par}\NormalTok{(}\StringTok{"usr"}\NormalTok{)[}\DecValTok{3}\NormalTok{],}
  \AttributeTok{adj =} \DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{names}\NormalTok{(}\FunctionTok{table}\NormalTok{(diamonds}\SpecialCharTok{$}\NormalTok{cut)), }\AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{25000}\NormalTok{, }\AttributeTok{by =} \DecValTok{5000}\NormalTok{), }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{25000}\NormalTok{, }\AttributeTok{by =} \DecValTok{5000}\NormalTok{),}
  \AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \StringTok{"gray"}
\NormalTok{)}
\FunctionTok{grid}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/diamonds-base-barplot-1} 

}

\caption{条形图}\label{fig:diamonds-base-barplot}
\end{figure}

简单柱形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123456}\NormalTok{)}
\NormalTok{barPois }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(stats}\SpecialCharTok{::}\FunctionTok{rpois}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\AttributeTok{lambda =} \DecValTok{5}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(barPois, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{type =} \StringTok{"h"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{10}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-39-1} 

}

\caption{柱形图}\label{fig:unnamed-chunk-39}
\end{figure}

复合条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.1}\NormalTok{, }\FloatTok{2.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{4.5}\NormalTok{))}
\FunctionTok{barplot}\NormalTok{(VADeaths,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{legend.text =} \FunctionTok{rownames}\NormalTok{(VADeaths), }\AttributeTok{xpd =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{cex.names =} \FloatTok{0.9}\NormalTok{,}
  \AttributeTok{args.legend =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"right"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Age"}\NormalTok{,}
    \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{inset =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(}\AttributeTok{nx =} \DecValTok{0}\NormalTok{, }\AttributeTok{ny =} \DecValTok{7}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/barplot-VADeaths-1-1} 

}

\caption{复合条形图}\label{fig:barplot-VADeaths-1}
\end{figure}

堆积条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.1}\NormalTok{, }\FloatTok{2.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{4.5}\NormalTok{))}
\FunctionTok{barplot}\NormalTok{(VADeaths,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{5}\NormalTok{),}
  \AttributeTok{legend.text =} \FunctionTok{rownames}\NormalTok{(VADeaths), }\AttributeTok{xpd =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{beside =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{cex.names =} \FloatTok{0.9}\NormalTok{,}
  \AttributeTok{args.legend =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"right"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Age"}\NormalTok{,}
    \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{inset =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(}\AttributeTok{nx =} \DecValTok{0}\NormalTok{, }\AttributeTok{ny =} \DecValTok{4}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/barplot-VADeaths-2-1} 

}

\caption{堆积条形图}\label{fig:barplot-VADeaths-2}
\end{figure}

\begin{itemize}
\tightlist
\item
  堆积条形图 spineplot
\end{itemize}

简单条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ BOD, demand }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Time, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{20}\NormalTok{),}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/barplot-BOD-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pg\_mean }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{data =}\NormalTok{ PlantGrowth, mean)}
\FunctionTok{barplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ pg\_mean, weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/barplot-PlantGrowth-1} \end{center}

Titanic 数据集是 table 数据类型

简单条形图

复合条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(Freq }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Class }\SpecialCharTok{+}\NormalTok{ Survived,}
  \AttributeTok{data =}\NormalTok{ Titanic,}
  \AttributeTok{subset =}\NormalTok{ Age }\SpecialCharTok{==} \StringTok{"Adult"} \SpecialCharTok{\&}\NormalTok{ Sex }\SpecialCharTok{==} \StringTok{"Male"}\NormalTok{,}
  \AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{),}
  \AttributeTok{args.legend =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Class"}\NormalTok{,}
    \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{ylab =} \StringTok{"\# \{passengers\}"}\NormalTok{, }\AttributeTok{legend =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-40-1} \end{center}

堆积条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(Freq }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Class }\SpecialCharTok{+}\NormalTok{ Survived,}
  \AttributeTok{data =}\NormalTok{ Titanic,}
  \AttributeTok{subset =}\NormalTok{ Age }\SpecialCharTok{==} \StringTok{"Adult"} \SpecialCharTok{\&}\NormalTok{ Sex }\SpecialCharTok{==} \StringTok{"Male"}\NormalTok{,}
  \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{),}
  \AttributeTok{args.legend =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Class"}\NormalTok{,}
    \AttributeTok{box.col =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{xpd =} \ConstantTok{TRUE}
\NormalTok{  ),}
  \AttributeTok{ylab =} \StringTok{"\# \{passengers\}"}\NormalTok{, }\AttributeTok{legend =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-41-1} \end{center}

\hypertarget{plot-hist}{%
\subsection{直方图}\label{plot-hist}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{24}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(n, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{delta }\OtherTok{\textless{}{-}} \FloatTok{0.01}
\NormalTok{len }\OtherTok{\textless{}{-}} \FunctionTok{diff}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{which}\NormalTok{(x }\SpecialCharTok{\textless{}}\NormalTok{ delta), n }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{{-}} \DecValTok{1}
\NormalTok{ylim }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1800}\NormalTok{, }\AttributeTok{by =} \DecValTok{300}\NormalTok{)}
\NormalTok{xlim }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{20}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{hist}\NormalTok{(len[len }\SpecialCharTok{\textless{}} \DecValTok{101}\NormalTok{], }\AttributeTok{breaks =} \SpecialCharTok{{-}}\DecValTok{1}\SpecialCharTok{:}\DecValTok{100} \SpecialCharTok{+} \FloatTok{0.5}\NormalTok{, }\AttributeTok{plot =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(p, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{labels =}\NormalTok{ xlim, }\AttributeTok{at =}\NormalTok{ xlim, }\AttributeTok{las =} \DecValTok{1}\NormalTok{) }\CommentTok{\# x 轴}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{labels =}\NormalTok{ ylim, }\AttributeTok{at =}\NormalTok{ ylim, }\AttributeTok{las =} \DecValTok{0}\NormalTok{) }\CommentTok{\# y 轴}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-42-1} 

}

\caption{直方图}\label{fig:unnamed-chunk-42}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(faithful, }\FunctionTok{plot}\NormalTok{(eruptions }\SpecialCharTok{\textasciitilde{}}\NormalTok{ waiting, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-43-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(faithful, }\FunctionTok{hist}\NormalTok{(waiting,}
  \AttributeTok{main =} \StringTok{"Time between Old Faithful eruptions"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Minutes"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{cex.main =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex.lab =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex.axis =} \FloatTok{1.4}
\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-44-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}\AttributeTok{data =}\NormalTok{ faithful, \{}
  \FunctionTok{hist}\NormalTok{(eruptions, }\FunctionTok{seq}\NormalTok{(}\FloatTok{1.6}\NormalTok{, }\FloatTok{5.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
    \AttributeTok{prob =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{main =} \StringTok{""}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}
\NormalTok{  )}
  \FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(eruptions, }\AttributeTok{bw =} \FloatTok{0.1}\NormalTok{), }\AttributeTok{col =} \StringTok{"\#EA4335"}\NormalTok{)}
  \FunctionTok{rug}\NormalTok{(eruptions, }\AttributeTok{col =} \StringTok{"\#EA4335"}\NormalTok{) }\CommentTok{\# 添加数据点}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/eruptions-1} 

}

\caption{老忠实泉间歇性喷水的时间间隔分布}\label{fig:eruptions}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed,}
  \AttributeTok{probability =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{col =} \StringTok{"light blue"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}
\NormalTok{)}
\CommentTok{\# 添加密度估计}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed),}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{,}
  \AttributeTok{lwd =} \DecValTok{3}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-45-1} 

}

\caption{概率密度分布}\label{fig:unnamed-chunk-45}
\end{figure}

直方图有很多花样的，添加阴影线，angle 控制倾斜的角度

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# hist(longley$Unemployed, density = 1, angle = 45)}
\CommentTok{\# hist(longley$Unemployed, density = 3, angle = 15)}
\CommentTok{\# hist(longley$Unemployed, density = 1, angle = 15)}
\FunctionTok{hist}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed, }\AttributeTok{density =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{45}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-46-1} 

}

\caption{density 数值越大阴影线越密}\label{fig:unnamed-chunk-46}
\end{figure}

\hypertarget{plot-density}{%
\subsection{密度图}\label{plot-density}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(galaxies, }\AttributeTok{package =} \StringTok{"MASS"}\NormalTok{)}
\NormalTok{galaxies }\OtherTok{\textless{}{-}}\NormalTok{ galaxies }\SpecialCharTok{/} \DecValTok{1000}
\CommentTok{\# Bandwidth Selection by Pilot Estimation of Derivatives}
\FunctionTok{c}\NormalTok{(MASS}\SpecialCharTok{::}\FunctionTok{width.SJ}\NormalTok{(galaxies, }\AttributeTok{method =} \StringTok{"dpi"}\NormalTok{), MASS}\SpecialCharTok{::}\FunctionTok{width.SJ}\NormalTok{(galaxies))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.256151 2.566423
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.2}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{bty =} \StringTok{"l"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"velocity of galaxy (km/s)"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"density"}
\NormalTok{)}
\FunctionTok{rug}\NormalTok{(galaxies)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(galaxies, }\AttributeTok{width =} \FloatTok{3.25}\NormalTok{, }\AttributeTok{n =} \DecValTok{200}\NormalTok{), }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(galaxies, }\AttributeTok{width =} \FloatTok{2.56}\NormalTok{, }\AttributeTok{n =} \DecValTok{200}\NormalTok{), }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-48-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{100}\NormalTok{, }\AttributeTok{to =} \DecValTok{174}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.5}\NormalTok{)}
\NormalTok{y1 }\OtherTok{\textless{}{-}} \FunctionTok{dnorm}\NormalTok{(x, }\AttributeTok{mean =} \DecValTok{145}\NormalTok{, }\AttributeTok{sd =} \DecValTok{9}\NormalTok{)}
\NormalTok{y2 }\OtherTok{\textless{}{-}} \FunctionTok{dnorm}\NormalTok{(x, }\AttributeTok{mean =} \DecValTok{128}\NormalTok{, }\AttributeTok{sd =} \DecValTok{8}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y1,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"firebrick3"}\NormalTok{,}
 \AttributeTok{main =} \StringTok{"Systolic Blood Pressure Before and After Treatment"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Systolic Blood Pressure (mmHg)"}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"Frequency"}\NormalTok{, }\AttributeTok{yaxt =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{175}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{)}
\NormalTok{)}

\FunctionTok{lines}\NormalTok{(x, y2, }\AttributeTok{col =} \StringTok{"dodgerblue4"}\NormalTok{)}
\FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{117}\NormalTok{, x, }\DecValTok{175}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, y2, }\DecValTok{0}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"dodgerblue4"}\NormalTok{,}
  \AttributeTok{border =} \StringTok{"white"}
\NormalTok{)}

\FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{100}\NormalTok{, x, }\DecValTok{175}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, y1, }\DecValTok{0}\NormalTok{),}
  \AttributeTok{col =} \StringTok{"firebrick3"}\NormalTok{,}
  \AttributeTok{border =} \StringTok{"white"}
\NormalTok{)}

\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{8}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{175}\NormalTok{, }\AttributeTok{by =} \DecValTok{25}\NormalTok{), }\AttributeTok{las =} \DecValTok{1}
\NormalTok{)}

\FunctionTok{text}\NormalTok{(}\AttributeTok{x =} \DecValTok{100}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.0445}\NormalTok{, }\StringTok{"Pre{-}Treatment BP"}\NormalTok{, }\AttributeTok{col =} \StringTok{"dodgerblue4"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.9}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\AttributeTok{x =} \DecValTok{100}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.0395}\NormalTok{, }\StringTok{"Post{-}Treatment BP"}\NormalTok{, }\AttributeTok{col =} \StringTok{"firebrick3"}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.9}\NormalTok{, }\AttributeTok{pos =} \DecValTok{4}\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\DecValTok{100}\NormalTok{, }\FloatTok{0.0445}\NormalTok{, }\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{col =} \StringTok{"dodgerblue4"}\NormalTok{)}
\FunctionTok{points}\NormalTok{(}\DecValTok{100}\NormalTok{, }\FloatTok{0.0395}\NormalTok{, }\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{col =} \StringTok{"firebrick3"}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \FunctionTok{c}\NormalTok{(}\DecValTok{145}\NormalTok{, }\DecValTok{128}\NormalTok{), }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{\textquotesingle{}gray\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.65\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-49-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{days }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{125}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{density}\NormalTok{(days, }\AttributeTok{from =} \DecValTok{0}\NormalTok{),}
  \AttributeTok{main =} \StringTok{"Density plot"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Number of days since trial started"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-50-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{density}\NormalTok{(days, }\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{180}\NormalTok{, }\AttributeTok{adjust =} \FloatTok{0.2}\NormalTok{),}
  \AttributeTok{main =} \StringTok{"Density plot {-} Up to 180 days (86\% of data)"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Number of days since trial started"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.55\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-50-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(survival)}
\NormalTok{surv.days }\OtherTok{\textless{}{-}} \FunctionTok{Surv}\NormalTok{(days)}
\NormalTok{surv.fit }\OtherTok{\textless{}{-}} \FunctionTok{survfit}\NormalTok{(surv.days }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(surv.fit,}
  \AttributeTok{main =} \StringTok{"Kaplan{-}Meier estimate with 95\% confidence bounds (86\% of data)"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Days since trial started"}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{180}\NormalTok{),}
  \AttributeTok{ylab =} \StringTok{"Survival function"}
\NormalTok{)}
\FunctionTok{grid}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-51-1} \end{center}

\hypertarget{plot-ecdf}{%
\subsection{经验图}\label{plot-ecdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}\AttributeTok{data =}\NormalTok{ faithful, \{}
\NormalTok{  long }\OtherTok{\textless{}{-}}\NormalTok{ eruptions[eruptions }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{]}
  \FunctionTok{plot}\NormalTok{(}\FunctionTok{ecdf}\NormalTok{(long), }\AttributeTok{do.points =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{verticals =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{3}\NormalTok{, }\FloatTok{5.4}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
  \FunctionTok{lines}\NormalTok{(x, }\FunctionTok{pnorm}\NormalTok{(x, }\AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(long), }\AttributeTok{sd =} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(long))), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/faithful-ecdf-1} 

}

\caption{累积经验分布图}\label{fig:faithful-ecdf}
\end{figure}

\hypertarget{plot-qqnorm}{%
\subsection{QQ 图}\label{plot-qqnorm}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}\AttributeTok{data =}\NormalTok{ faithful, \{}
\NormalTok{  long }\OtherTok{\textless{}{-}}\NormalTok{ eruptions[eruptions }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{]}
  \FunctionTok{par}\NormalTok{(}\AttributeTok{pty =} \StringTok{"s"}\NormalTok{) }\CommentTok{\# arrange for a square figure region}
  \FunctionTok{qqnorm}\NormalTok{(long, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
  \FunctionTok{qqline}\NormalTok{(long)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/faithful-eruptions-1} \end{center}

\hypertarget{plot-ts}{%
\subsection{时序图}\label{plot-ts}}

时序图最适合用来描述股价走势

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{matplot}\NormalTok{(}\FunctionTok{time}\NormalTok{(EuStockMarkets), EuStockMarkets,}
  \AttributeTok{main =} \StringTok{""}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Date"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"closing prices"}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{col =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topleft"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(EuStockMarkets), }\AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-52-1} 

}

\caption{1991–1998年间主要欧洲股票市场日闭市价格指数图 
 德国 DAX (Ibis), Switzerland SMI, 法国 CAC 和 英国 FTSE}\label{fig:unnamed-chunk-52}
\end{figure}

\hypertarget{plot-pie}{%
\subsection{饼图}\label{plot-pie}}

clockwise 参数

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pie.sales }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.12}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.26}\NormalTok{, }\FloatTok{0.16}\NormalTok{, }\FloatTok{0.04}\NormalTok{, }\FloatTok{0.12}\NormalTok{)}
\FunctionTok{names}\NormalTok{(pie.sales) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"Blueberry"}\NormalTok{, }\StringTok{"Cherry"}\NormalTok{,}
  \StringTok{"Apple"}\NormalTok{, }\StringTok{"Boston Cream"}\NormalTok{, }\StringTok{"Other"}\NormalTok{, }\StringTok{"Vanilla Cream"}
\NormalTok{)}
\FunctionTok{pie}\NormalTok{(pie.sales, }\AttributeTok{clockwise =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\FunctionTok{segments}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\StringTok{"init.angle = 90"}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-53-1} \end{center}

\hypertarget{plot-stem-leaf}{%
\subsection{茎叶图}\label{plot-stem-leaf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stem}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##   The decimal point is 2 digit(s) to the right of the |
## 
##   1 | 99
##   2 | 134899
##   3 | 46789
##   4 | 078
\end{verbatim}

\hypertarget{plot-scatter}{%
\subsection{散点图}\label{plot-scatter}}

在一维空间上，绘制散点图，其实是在看散点的疏密程度随坐标轴的变化

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{stripchart}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed,}
  \AttributeTok{method =} \StringTok{"jitter"}\NormalTok{,}
  \AttributeTok{jitter =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}
\NormalTok{)}
\FunctionTok{stripchart}\NormalTok{(longley}\SpecialCharTok{$}\NormalTok{Unemployed,}
  \AttributeTok{method =} \StringTok{"overplot"}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightblue"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[抖动图\label{fig:unnamed-chunk-55-1}]{\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-55-1} }\subfloat[疏密图\label{fig:unnamed-chunk-55-2}]{\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-55-2} }

}

\caption{一维散点图}\label{fig:unnamed-chunk-55}
\end{figure}

气泡图是二维散点图的一种变体，气泡的大小可以用来描述第三个变量，下面以数据集 topo 为例展示气泡图

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载数据集}
\FunctionTok{data}\NormalTok{(topo, }\AttributeTok{package =} \StringTok{"MASS"}\NormalTok{)}
\CommentTok{\# 查看数据集}
\FunctionTok{str}\NormalTok{(topo)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    52 obs. of  3 variables:
##  $ x: num  0.3 1.4 2.4 3.6 5.7 1.6 2.9 3.4 3.4 4.8 ...
##  $ y: num  6.1 6.2 6.1 6.2 6.2 5.2 5.1 5.3 5.7 5.6 ...
##  $ z: int  870 793 755 690 800 800 730 728 710 780 ...
\end{verbatim}

topo 是空间地形数据集，包含有52行3列，数据点是310平方英尺范围内的海拔高度数据，x 坐标每单位50英尺，y 坐标单位同 x 坐标，海拔高度 z 单位是英尺

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
  \AttributeTok{cex =}\NormalTok{ (}\DecValTok{960} \SpecialCharTok{{-}}\NormalTok{ z) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{960} \SpecialCharTok{{-}} \DecValTok{690}\NormalTok{) }\SpecialCharTok{*} \DecValTok{3}\NormalTok{, }\AttributeTok{data =}\NormalTok{ topo,}
  \AttributeTok{xlab =} \StringTok{"X Coordinates"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Y coordinates"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-57-1} 

}

\caption{地形图之海拔高度}\label{fig:unnamed-chunk-57}
\end{figure}

散点图也适合分类数据的展示，在图中用不同颜色或符号标记数据点所属类别，即在普通散点图的基础上添加一分类变量的描述

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(mpg }\SpecialCharTok{\textasciitilde{}}\NormalTok{ hp,}
  \AttributeTok{data =} \FunctionTok{subset}\NormalTok{(mtcars, am }\SpecialCharTok{==} \DecValTok{1}\NormalTok{), }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{35}\NormalTok{)}
\NormalTok{)}
\FunctionTok{points}\NormalTok{(mpg }\SpecialCharTok{\textasciitilde{}}\NormalTok{ hp,}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{,}
  \AttributeTok{data =} \FunctionTok{subset}\NormalTok{(mtcars, am }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\DecValTok{300}\NormalTok{, }\DecValTok{35}\NormalTok{,}
  \FunctionTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"0"}\NormalTok{),}
  \AttributeTok{title =} \StringTok{"am"}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{),}
  \AttributeTok{pch =} \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{16}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/category-base-1} 

}

\caption{分类散点图}\label{fig:category-base}
\end{figure}

iris 数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Width, }\AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{col =}\NormalTok{ Species, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topright"}\NormalTok{,}
  \AttributeTok{legend =} \FunctionTok{unique}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species), }\AttributeTok{box.col =} \StringTok{"gray"}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{col =} \FunctionTok{unique}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species)}
\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/iris-scatter-1} 

}

\caption{分类散点图}\label{fig:iris-scatter}
\end{figure}

分组散点图和平滑

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(carData)}
\FunctionTok{library}\NormalTok{(car)}
\FunctionTok{scatterplot}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Width,}
  \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"black"}\NormalTok{, }\StringTok{"red"}\NormalTok{, }\StringTok{"blue"}\NormalTok{), }\AttributeTok{pch =} \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{16}\NormalTok{, }\DecValTok{16}\NormalTok{),}
  \AttributeTok{smooth =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{boxplots =} \StringTok{"xy"}\NormalTok{, }\AttributeTok{groups =}\NormalTok{ iris}\SpecialCharTok{$}\NormalTok{Species,}
  \AttributeTok{xlab =} \StringTok{"Sepal.Width"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Sepal.Length"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ iris}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

有时为了实现特定的目的，需要高亮其中某些点，按类别或者因子变量分组绘制散点图，这里继续采用 \texttt{stripchart} 函数绘制二维散点图\ref{fig:scatter-iris}，由左图可知，函数 \texttt{stripchart} 提供的参数 \texttt{pch} 不接受向量，实际只是取了前三个值 16 16 17 对应于 Species 的三类，关键是高亮的分界点是有区分意义的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"iris"}\NormalTok{)}
\NormalTok{pch }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{16}\NormalTok{, }\FunctionTok{length}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Petal.Length))}
\NormalTok{pch[}\FunctionTok{which}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Petal.Length }\SpecialCharTok{\textless{}} \FloatTok{1.4}\NormalTok{)] }\OtherTok{\textless{}{-}} \DecValTok{17}
\FunctionTok{stripchart}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris,}
  \AttributeTok{vertical =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{method =} \StringTok{"jitter"}\NormalTok{,}
  \AttributeTok{pch =}\NormalTok{ pch}
\NormalTok{)}
\CommentTok{\# 对比一下}
\FunctionTok{stripchart}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{subset =}\NormalTok{ Petal.Length }\SpecialCharTok{\textgreater{}} \FloatTok{1.4}\NormalTok{,}
  \AttributeTok{vertical =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{method =} \StringTok{"jitter"}\NormalTok{, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{7}\NormalTok{),}
  \AttributeTok{pch =} \DecValTok{16}
\NormalTok{)}
\FunctionTok{stripchart}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{subset =}\NormalTok{ Petal.Length }\SpecialCharTok{\textless{}} \FloatTok{1.4}\NormalTok{,}
  \AttributeTok{vertical =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{method =} \StringTok{"jitter"}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[原图\label{fig:scatter-iris-1}]{\includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/scatter-iris-1} }\subfloat[高亮\label{fig:scatter-iris-2}]{\includegraphics[width=0.45\linewidth]{graphics-foundations_files/figure-latex/scatter-iris-2} }

}

\caption{高亮图中部分散点}\label{fig:scatter-iris}
\end{figure}

如果存在大量散点

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{densCols}\NormalTok{(x,}
  \AttributeTok{y =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{nbin =} \DecValTok{128}\NormalTok{, bandwidth,}
  \AttributeTok{colramp =} \FunctionTok{colorRampPalette}\NormalTok{(blues9[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\texttt{densCols} 函数根据点的局部密度生成颜色，密度估计采用核平滑法，由 \textbf{KernSmooth} 包的 \texttt{bkde2D} 函数实现。参数 \texttt{colramp} 传递一个函数，\texttt{colorRampPalette} 根据给定的几种颜色生成函数，参数 \texttt{bandwidth} 实际上是传给 \texttt{bkde2D} 函数

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(faithful,}
  \AttributeTok{col =} \FunctionTok{densCols}\NormalTok{(faithful),}
  \AttributeTok{pch =} \DecValTok{20}\NormalTok{, }\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/densCols-1} 

}

\caption{根据点的密度生成颜色}\label{fig:densCols}
\end{figure}

气泡图也是散点图的一种

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Volume }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Height,}
  \AttributeTok{data =}\NormalTok{ trees, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{cex =}\NormalTok{ Girth }\SpecialCharTok{/} \DecValTok{8}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{rev}\NormalTok{(}\FunctionTok{terrain.colors}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(trees), }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{5}\NormalTok{))}
\NormalTok{)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-60-1} 

}

\caption{气泡图}\label{fig:unnamed-chunk-60}
\end{figure}

气泡图

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 空白画布}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{),}
     \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# 添加坐标轴}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{), }\AttributeTok{labels =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{), }\AttributeTok{labels =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{) }\CommentTok{\# 在当前图形上添加图形}
\CommentTok{\# axes 坐标轴上的刻度 "xaxt" or "yaxt"  ann 坐标轴和标题的标签}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{), }\FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{cex =} \FunctionTok{runif}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{)[}\FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), }\DecValTok{100}\NormalTok{)],}
  \AttributeTok{bg =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"gray"}\NormalTok{, }\FunctionTok{replicate}\NormalTok{(}\DecValTok{100}\NormalTok{, }\FunctionTok{sample}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{), }\DecValTok{1}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{))),}
  \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ann =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{pch =} \DecValTok{21}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}
\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"top"}\NormalTok{,}
  \AttributeTok{legend =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"class"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{)), }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{4}\NormalTok{),}
  \AttributeTok{pt.lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{pch =} \DecValTok{21}\NormalTok{, }\AttributeTok{box.col =} \StringTok{"gray"}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-61-1} \end{center}

除了\texttt{par(new=TRUE)}设置外，有些函数本身就具有 \texttt{add} 选项

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(dist }\SpecialCharTok{\textasciitilde{}}\NormalTok{ speed, }\AttributeTok{data =}\NormalTok{ cars, }\AttributeTok{pch =} \DecValTok{17}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{)}
\FunctionTok{with}\NormalTok{(cars, }\FunctionTok{symbols}\NormalTok{(dist }\SpecialCharTok{\textasciitilde{}}\NormalTok{ speed,}
  \AttributeTok{circles =} \FunctionTok{runif}\NormalTok{(}\FunctionTok{length}\NormalTok{(speed), }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{inches =}\NormalTok{ .}\DecValTok{5}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}
\NormalTok{))}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(dist }\SpecialCharTok{\textasciitilde{}}\NormalTok{ speed, }\AttributeTok{data =}\NormalTok{ cars)}
\FunctionTok{abline}\NormalTok{(z, }\AttributeTok{col =} \StringTok{"blue"}\NormalTok{)}
\FunctionTok{curve}\NormalTok{(tan, }\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ pi, }\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(stats}\SpecialCharTok{::}\FunctionTok{lowess}\NormalTok{(cars))}
\FunctionTok{points}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3}\NormalTok{, }\AttributeTok{col =} \StringTok{"green"}\NormalTok{)}
\FunctionTok{text}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{80}\NormalTok{, }\StringTok{"text here"}\NormalTok{, }\AttributeTok{cex =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-62-1} \end{center}

\hypertarget{base-jitter}{%
\subsection{抖动图}\label{base-jitter}}

抖动散点图

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mat }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(}\FunctionTok{colors}\NormalTok{()), }\AttributeTok{ncol =} \DecValTok{9}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{col =} \FunctionTok{colors}\NormalTok{(),}
  \AttributeTok{x =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{cut}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(}\FunctionTok{colors}\NormalTok{()), }\DecValTok{9}\NormalTok{)),}
  \AttributeTok{y =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{73}\NormalTok{, }\DecValTok{9}\NormalTok{), }\AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.1}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{jitter}\NormalTok{(x),}
  \AttributeTok{data =}\NormalTok{ df, }\AttributeTok{col =}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{col,}
  \AttributeTok{pch =} \DecValTok{16}\NormalTok{, }\AttributeTok{main =} \StringTok{"Visualizing colors() split in 9 groups"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Group"}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"Element of the group (min = 1, max = 73)"}\NormalTok{,}
  \AttributeTok{sub =} \StringTok{"x = 3, y = 1 means that it\textquotesingle{}s the 2 * 73 + 1 = 147th color"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/jitter-scatter-1} 

}

\caption{抖动散点图}\label{fig:jitter-scatter}
\end{figure}

\hypertarget{plot-box}{%
\subsection{箱线图}\label{plot-box}}

boxplotdbl: Double Box Plot for Two-Axes Correlation. Correlation chart of two set (x and y) of data. Using Quartiles with boxplot style. Visualize the effect of factor.

\href{https://tomizonor.wordpress.com/2013/03/15/double-box-plot/}{复合箱线图}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(}\AttributeTok{data =}\NormalTok{ iris, \{}
\NormalTok{  op }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, .}\DecValTok{5}\NormalTok{))}
  \FunctionTok{plot}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species)}
  \FunctionTok{plot}\NormalTok{(Sepal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species)}
  \FunctionTok{plot}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species)}
  \FunctionTok{plot}\NormalTok{(Petal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species)}
  \FunctionTok{par}\NormalTok{(op)}
  \FunctionTok{mtext}\NormalTok{(}\StringTok{"Edgar Anderson\textquotesingle{}s Iris Data"}\NormalTok{, }\AttributeTok{side =} \DecValTok{3}\NormalTok{, }\AttributeTok{line =} \DecValTok{4}\NormalTok{)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/iris-1} 

}

\caption{安德森的鸢尾花数据}\label{fig:iris}
\end{figure}

箱线图的花样也很多

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(InsectSprays)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, .}\DecValTok{5}\NormalTok{, .}\DecValTok{5}\NormalTok{))}
\FunctionTok{boxplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ InsectSprays, count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray,}
  \AttributeTok{col =} \StringTok{"gray"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Spray"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Count"}
\NormalTok{)}

\FunctionTok{boxplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ InsectSprays, count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray,}
  \AttributeTok{col =} \StringTok{"gray"}\NormalTok{, }\AttributeTok{horizontal =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Count"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Spray"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[垂直放置\label{fig:unnamed-chunk-63-1}]{\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-63-1} }\newline\subfloat[水平放置\label{fig:unnamed-chunk-63-2}]{\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-63-2} }

}

\caption{箱线图}\label{fig:unnamed-chunk-63}
\end{figure}

Notched Boxplots

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{8}
\NormalTok{g }\OtherTok{\textless{}{-}} \FunctionTok{gl}\NormalTok{(n, }\DecValTok{100}\NormalTok{, n }\SpecialCharTok{*} \DecValTok{100}\NormalTok{) }\CommentTok{\# n水平个数 100是重复次数}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(n }\SpecialCharTok{*} \DecValTok{100}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(g))}
\FunctionTok{boxplot}\NormalTok{(}\FunctionTok{split}\NormalTok{(x, g), }\AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(n), }\AttributeTok{notch =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{title}\NormalTok{(}
  \AttributeTok{main =} \StringTok{"Notched Boxplots"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Group"}\NormalTok{,}
  \AttributeTok{font.main =} \DecValTok{4}\NormalTok{, }\AttributeTok{font.lab =} \DecValTok{1}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-64-1} \end{center}

真实的情况是这样的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumcm2011A }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\AttributeTok{file =} \StringTok{"cumcm2011A.RDS"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(As, }\AttributeTok{xlab =} \StringTok{"As"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\FloatTok{3.6}\NormalTok{, }\FloatTok{5.4}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Cd, }\AttributeTok{xlab =} \StringTok{"Cd"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{130}\NormalTok{, }\DecValTok{190}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Cr, }\AttributeTok{xlab =} \StringTok{"Cr"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{13}\NormalTok{, }\DecValTok{31}\NormalTok{, }\DecValTok{49}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Cu, }\AttributeTok{xlab =} \StringTok{"Cu"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\FloatTok{6.0}\NormalTok{, }\FloatTok{13.2}\NormalTok{, }\FloatTok{20.4}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Hg, }\AttributeTok{xlab =} \StringTok{"Hg"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{19}\NormalTok{, }\DecValTok{35}\NormalTok{, }\DecValTok{51}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Ni, }\AttributeTok{xlab =} \StringTok{"Ni"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.7}\NormalTok{, }\FloatTok{12.3}\NormalTok{, }\FloatTok{19.9}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Pb, }\AttributeTok{xlab =} \StringTok{"Pb"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{19}\NormalTok{, }\DecValTok{31}\NormalTok{, }\DecValTok{43}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}

\FunctionTok{with}\NormalTok{(cumcm2011A, }\FunctionTok{boxplot}\NormalTok{(Zn, }\AttributeTok{xlab =} \StringTok{"Zn"}\NormalTok{))}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{41}\NormalTok{, }\DecValTok{69}\NormalTok{, }\DecValTok{97}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{), }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(As }\SpecialCharTok{\textasciitilde{}}\NormalTok{ area,}
  \AttributeTok{data =}\NormalTok{ cumcm2011A,}
  \AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}
  \AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\FloatTok{3.6}\NormalTok{, }\FloatTok{5.4}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{),}
  \AttributeTok{lty =} \DecValTok{2}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{error-bars}{%
\subsection{残差图}\label{error-bars}}

iris 四个测量指标

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vec\_mean }\OtherTok{\textless{}{-}} \FunctionTok{colMeans}\NormalTok{(iris[, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{])}
\NormalTok{vec\_sd }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(iris[, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{], }\DecValTok{2}\NormalTok{, sd)}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), vec\_mean,}
  \AttributeTok{ylim =} \FunctionTok{range}\NormalTok{(}\FunctionTok{c}\NormalTok{(vec\_mean }\SpecialCharTok{{-}}\NormalTok{ vec\_sd, vec\_mean }\SpecialCharTok{+}\NormalTok{ vec\_sd)),}
  \AttributeTok{xlab =} \StringTok{"Species"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Mean +/{-} SD"}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{1}\NormalTok{, }\AttributeTok{pch =} \DecValTok{19}\NormalTok{,}
  \AttributeTok{axes =} \ConstantTok{FALSE}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{colnames}\NormalTok{(iris)[}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{])}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{7}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{7}\NormalTok{))}
\FunctionTok{arrows}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), vec\_mean }\SpecialCharTok{{-}}\NormalTok{ vec\_sd, }\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{), vec\_mean }\SpecialCharTok{+}\NormalTok{ vec\_sd,}
  \AttributeTok{length =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{code =} \DecValTok{3}
\NormalTok{)}
\FunctionTok{box}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-67-1} 

}

\caption{带标准差的均值散点图}\label{fig:unnamed-chunk-67}
\end{figure}

\hypertarget{plot-violin}{%
\subsection{提琴图}\label{plot-violin}}

Tom Kelly 维护的 vioplot 包 \url{https://github.com/TomKellyGenetics/vioplot}

\hypertarget{plot-contour}{%
\subsection{轮廓图}\label{plot-contour}}

topo 是地形数据

等高线图

\hypertarget{plot-line}{%
\subsection{折线图}\label{plot-line}}

函数曲线，样条曲线，核密度曲线，平行坐标图

\begin{itemize}
\tightlist
\item
  折线图
\item
  点线图 \texttt{plot(type="b")} 函数曲线图 \texttt{curve} \texttt{matplot} X 样条曲线 \texttt{xspline}
\item
  时序图
\end{itemize}

太阳黑子活动数据

sunspot.month Monthly Sunspot Data, from 1749 to ``Present'' sunspot.year Yearly Sunspot Data, 1700-1988 sunspots Monthly Sunspot Numbers, 1749-1983

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(AirPassengers)}
\FunctionTok{box}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-68-1} 

}

\caption{折线图}\label{fig:unnamed-chunk-68}
\end{figure}

\hypertarget{function}{%
\subsection{函数图}\label{function}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x0 }\OtherTok{\textless{}{-}} \DecValTok{2}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{20}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{nus }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{501}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(x0, x0}\SpecialCharTok{\^{}{-}}\DecValTok{8}\NormalTok{,}
  \AttributeTok{frame.plot =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 添加绘图框}
  \AttributeTok{log =} \StringTok{"xy"}\NormalTok{, }\CommentTok{\# x 和 y 轴都取对数尺度}
  \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 去掉坐标轴}
  \AttributeTok{xlab =} \StringTok{"$u$"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathcal\{K\}\_\{}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{kappa\}(u)$"}\NormalTok{, }\CommentTok{\# 设置坐标轴标签}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\CommentTok{\# 清除绘图区域的内容}
  \AttributeTok{ann =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# 添加标题 x和y轴标签}
  \AttributeTok{panel.first =} \FunctionTok{grid}\NormalTok{() }\CommentTok{\# 添加背景参考线}
\NormalTok{)}

\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{at =} \DecValTok{10}\SpecialCharTok{\^{}}\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }\AttributeTok{to =} \DecValTok{2}\NormalTok{, }\AttributeTok{by =} \DecValTok{2}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathsf\{10\^{}\{"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }\AttributeTok{to =} \DecValTok{2}\NormalTok{, }\AttributeTok{by =} \DecValTok{2}\NormalTok{), }\StringTok{"\}\}$"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{,}
  \AttributeTok{at =} \DecValTok{10}\SpecialCharTok{\^{}}\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }\AttributeTok{to =} \DecValTok{56}\NormalTok{, }\AttributeTok{by =} \DecValTok{16}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathsf\{10\^{}\{"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }\AttributeTok{to =} \DecValTok{56}\NormalTok{, }\AttributeTok{by =} \DecValTok{16}\NormalTok{), }\StringTok{"\}\}$"}\NormalTok{), }\AttributeTok{las =} \DecValTok{1}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\FunctionTok{length}\NormalTok{(nus))) \{}
  \FunctionTok{lines}\NormalTok{(x0, }\FunctionTok{besselK}\NormalTok{(x0, }\AttributeTok{nu =}\NormalTok{ nus[i]), }\AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{9}\NormalTok{)[i], }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{legend}\NormalTok{(}\StringTok{"topright"}\NormalTok{,}
  \AttributeTok{legend =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{kappa="}\NormalTok{, }\FunctionTok{rev}\NormalTok{(nus), }\StringTok{"$"}\NormalTok{),}
  \AttributeTok{col =} \FunctionTok{hcl.colors}\NormalTok{(}\DecValTok{9}\NormalTok{, }\AttributeTok{rev =}\NormalTok{ T), }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{cex =} \DecValTok{1}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.65\linewidth]{graphics-foundations_files/figure-latex/bessel-function-1} 

}

\caption{贝塞尔函数}\label{fig:bessel-function}
\end{figure}

还有 eta 函数和 gammaz 函数

\hypertarget{plot-mosaic}{%
\subsection{马赛克图}\label{plot-mosaic}}

马赛克图 mosaicplot

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(HairEyeColor, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-69-1} 

}

\caption{马赛克图}\label{fig:unnamed-chunk-69}
\end{figure}

\hypertarget{plot-dotchart}{%
\subsection{点图}\label{plot-dotchart}}

dotchart 克利夫兰点图

条件图 coplot

\hypertarget{plot-matrix}{%
\subsection{矩阵图}\label{plot-matrix}}

在对角线上添加平滑曲线、密度曲线

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pairs}\NormalTok{(longley,}
  \AttributeTok{gap =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{diag.panel =} \ControlFlowTok{function}\NormalTok{(x, ...) \{}
    \FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}
    \FunctionTok{hist}\NormalTok{(x,}
      \AttributeTok{col =} \StringTok{"light blue"}\NormalTok{,}
      \AttributeTok{probability =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
      \AttributeTok{main =} \StringTok{""}
\NormalTok{    )}
    \FunctionTok{lines}\NormalTok{(}\FunctionTok{density}\NormalTok{(x),}
      \AttributeTok{col =} \StringTok{"red"}\NormalTok{,}
      \AttributeTok{lwd =} \DecValTok{3}
\NormalTok{    )}
    \FunctionTok{rug}\NormalTok{(x)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-70-1} 

}

\caption{变量关系}\label{fig:unnamed-chunk-70}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 自带 layout}
\FunctionTok{plot}\NormalTok{(iris[, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{], }\AttributeTok{col =}\NormalTok{ iris}\SpecialCharTok{$}\NormalTok{Species)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-71-1} 

}

\caption{矩阵图}\label{fig:unnamed-chunk-71}
\end{figure}

\hypertarget{plot-radar}{%
\subsection{雷达图}\label{plot-radar}}

星图 stars 多元数据

\hypertarget{plot-rose}{%
\subsection{玫瑰图}\label{plot-rose}}

注意与 image 函数区别

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \DecValTok{10} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(volcano))}
\NormalTok{y }\OtherTok{\textless{}{-}} \DecValTok{10} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(volcano))}
\FunctionTok{image}\NormalTok{(x, y, volcano, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{100}\NormalTok{), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{contour}\NormalTok{(x, y, volcano,}
  \AttributeTok{levels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{200}\NormalTok{, }\AttributeTok{by =} \DecValTok{5}\NormalTok{),}
  \AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{col =} \StringTok{"peru"}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{800}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{))}
\FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{600}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{))}
\FunctionTok{box}\NormalTok{()}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Maunga Whau Volcano"}\NormalTok{, }\AttributeTok{font.main =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-72-1} 

}

\caption{image 图形}\label{fig:unnamed-chunk-72}
\end{figure}

\hypertarget{plot-persp}{%
\subsection{透视图}\label{plot-persp}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(.}\DecValTok{5}\NormalTok{, }\FloatTok{2.1}\NormalTok{, .}\DecValTok{5}\NormalTok{, .}\DecValTok{5}\NormalTok{))}
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length =} \DecValTok{51}\NormalTok{)}
\NormalTok{x2 }\OtherTok{\textless{}{-}}\NormalTok{ x1 }
\NormalTok{f }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x1, x2, }\AttributeTok{mu1 =} \DecValTok{0}\NormalTok{, }\AttributeTok{mu2 =} \DecValTok{0}\NormalTok{, }\AttributeTok{s11 =} \DecValTok{10}\NormalTok{, }\AttributeTok{s12 =} \DecValTok{15}\NormalTok{, }\AttributeTok{s22 =} \DecValTok{10}\NormalTok{, }\AttributeTok{rho =} \FloatTok{0.5}\NormalTok{) \{}
\NormalTok{  term1 }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(s11 }\SpecialCharTok{*}\NormalTok{ s22 }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ rho}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)))}
\NormalTok{  term2 }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ rho}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\NormalTok{  term3 }\OtherTok{\textless{}{-}}\NormalTok{ (x1 }\SpecialCharTok{{-}}\NormalTok{ mu1)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{/}\NormalTok{ s11}
\NormalTok{  term4 }\OtherTok{\textless{}{-}}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ mu2)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{/}\NormalTok{ s22}
\NormalTok{  term5 }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ rho }\SpecialCharTok{*}\NormalTok{ ((x1 }\SpecialCharTok{{-}}\NormalTok{ mu1) }\SpecialCharTok{*}\NormalTok{ (x2 }\SpecialCharTok{{-}}\NormalTok{ mu2)) }\SpecialCharTok{/}\NormalTok{ (}\FunctionTok{sqrt}\NormalTok{(s11) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(s22))}
\NormalTok{  term1 }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(term2 }\SpecialCharTok{*}\NormalTok{ (term3 }\SpecialCharTok{+}\NormalTok{ term4 }\SpecialCharTok{{-}}\NormalTok{ term5))}
\NormalTok{\} }
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{outer}\NormalTok{(x1, x2, f) }
\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{persp}\NormalTok{(x1, x2, z,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{zlab =} \StringTok{""}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{drapecol}\NormalTok{(z, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{20}\NormalTok{)),}
  \AttributeTok{border =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{shade =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{r =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{expand =} \FloatTok{0.5}\NormalTok{,}
  \AttributeTok{theta =} \DecValTok{120}\NormalTok{, }\AttributeTok{phi =} \DecValTok{15}\NormalTok{, }\AttributeTok{ltheta =} \DecValTok{90}\NormalTok{, }\AttributeTok{lphi =} \DecValTok{180}\NormalTok{,}
  \AttributeTok{ticktype =} \StringTok{"detailed"}\NormalTok{, }\AttributeTok{nticks =} \DecValTok{5}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/normal-dist-1} 

}

\caption{统计学的世界}\label{fig:normal-dist}
\end{figure}

\hypertarget{lattice-graphics}{%
\section{栅格统计图形}\label{lattice-graphics}}

\begin{quote}
If you imagine that this pen is Trellis, then Lattice is not this pen.

\hspace*{\fill} --- Paul Murrell \footnote{Paul 在 DSC 2001 大会上的幻灯片 见\url{https://www.stat.auckland.ac.nz/~paul/Talks/dsc2001.pdf}}
\end{quote}

把网站搬出来，汉化 \url{http://latticeextra.r-forge.r-project.org/}

\hypertarget{lattice-boxplot}{%
\subsection{箱线图}\label{lattice-boxplot}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(lattice)}
\CommentTok{\# plot(data = InsectSprays, count \textasciitilde{} spray)}
\FunctionTok{bwplot}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-73-1} \end{center}

\hypertarget{lattice-line}{%
\subsection{折线图}\label{lattice-line}}

latticeExtra 包提供了强大的图层函数 \texttt{layer()}

多元时间序列

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(RColorBrewer)}
\FunctionTok{library}\NormalTok{(latticeExtra)}
\FunctionTok{xyplot}\NormalTok{(EuStockMarkets) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}\FunctionTok{panel.scaleArrow}\NormalTok{(}
    \AttributeTok{x =} \FloatTok{0.99}\NormalTok{, }\AttributeTok{append =} \StringTok{" units"}\NormalTok{, }\AttributeTok{col =} \StringTok{"grey"}\NormalTok{, }\AttributeTok{srt =} \DecValTok{90}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.8}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-74-1} \end{center}

如何解释

时序图

Plot many time series in parallel

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{horizonplot}\NormalTok{(EuStockMarkets,}
  \AttributeTok{colorkey =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{origin =} \DecValTok{4000}\NormalTok{, }\AttributeTok{horizonscale =} \DecValTok{1000}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}\FunctionTok{panel.scaleArrow}\NormalTok{(}
    \AttributeTok{x =} \FloatTok{0.99}\NormalTok{, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \StringTok{"grey"}\NormalTok{,}
    \AttributeTok{srt =} \DecValTok{90}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.7}
\NormalTok{  )) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}
\NormalTok{    lim }\OtherTok{\textless{}{-}} \FunctionTok{current.panel.limits}\NormalTok{(),}
    \FunctionTok{panel.text}\NormalTok{(lim}\SpecialCharTok{$}\NormalTok{x[}\DecValTok{1}\NormalTok{], lim}\SpecialCharTok{$}\NormalTok{y[}\DecValTok{1}\NormalTok{], }\FunctionTok{round}\NormalTok{(lim}\SpecialCharTok{$}\NormalTok{y[}\DecValTok{1}\NormalTok{], }\DecValTok{1}\NormalTok{),}
      \AttributeTok{font =} \DecValTok{2}\NormalTok{,}
      \AttributeTok{cex =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{adj =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{), }\AttributeTok{col =} \StringTok{"\#9FC8DC"}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-75-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# \# https://stackoverflow.com/questions/25109196/r{-}lattice{-}package{-}add{-}legend{-}to{-}a{-}figure}
\FunctionTok{library}\NormalTok{(lattice)}
\FunctionTok{library}\NormalTok{(nlme)}

\FunctionTok{plot}\NormalTok{(Orange,}
  \AttributeTok{outer =} \SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{,}
  \AttributeTok{key =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{space =} \StringTok{"right"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Tree"}\NormalTok{, }\AttributeTok{cex.title =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{lines =} \FunctionTok{list}\NormalTok{(}\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{5}\NormalTok{)),}
    \CommentTok{\# points = list(pch = 1, col = gray.colors(5)),}
    \AttributeTok{text =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"3"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"5"}\NormalTok{, }\StringTok{"2"}\NormalTok{, }\StringTok{"4"}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}
    \CommentTok{\# plot.line = list(col = gray.colors(5), border = "transparent"),}
    \CommentTok{\# plot.symbol = list(col = gray.colors(5), border = "transparent"),}
    \AttributeTok{strip.background =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"white"}\NormalTok{),}
    \AttributeTok{strip.border =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-76-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(MASS)}
\FunctionTok{library}\NormalTok{(lattice)}
\DocumentationTok{\#\# Plot the claims frequency against age group by engine size and district}

\FunctionTok{barchart}\NormalTok{(Claims }\SpecialCharTok{/}\NormalTok{ Holders }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Age }\SpecialCharTok{|}\NormalTok{ Group,}
  \AttributeTok{groups =}\NormalTok{ District,}
  \AttributeTok{data =}\NormalTok{ Insurance, }\AttributeTok{origin =} \DecValTok{0}\NormalTok{, }\AttributeTok{auto.key =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-77-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barchart}\NormalTok{(Claims }\SpecialCharTok{/}\NormalTok{ Holders }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Age }\SpecialCharTok{|}\NormalTok{ Group,}
  \AttributeTok{groups =}\NormalTok{ District, }\AttributeTok{data =}\NormalTok{ Insurance,}
  \AttributeTok{main =} \StringTok{"Claims frequency"}\NormalTok{,}
  \AttributeTok{auto.key =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{space =} \StringTok{"top"}\NormalTok{, }\AttributeTok{columns =} \DecValTok{4}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"District"}\NormalTok{, }\AttributeTok{cex.title =} \DecValTok{1}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-78-1} \end{center}

lattice 图形的参数设置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{show.settings}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{graphics-foundations_files/figure-latex/lattice-settings-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{myColours }\OtherTok{\textless{}{-}} \FunctionTok{brewer.pal}\NormalTok{(}\DecValTok{6}\NormalTok{, }\StringTok{"Blues"}\NormalTok{)}
\NormalTok{my.settings }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{superpose.polygon =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =}\NormalTok{ myColours[}\DecValTok{2}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], }\AttributeTok{border =} \StringTok{"transparent"}\NormalTok{),}
  \AttributeTok{strip.background =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =}\NormalTok{ myColours[}\DecValTok{6}\NormalTok{]),}
  \AttributeTok{strip.border =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# 获取参数设置}
\FunctionTok{trellis.par.get}\NormalTok{()}

\CommentTok{\# 全局参数设置}
\FunctionTok{trellis.par.set}\NormalTok{(my.settings)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(MASS)}
\FunctionTok{library}\NormalTok{(lattice)}

\FunctionTok{barchart}\NormalTok{(Claims }\SpecialCharTok{/}\NormalTok{ Holders }\SpecialCharTok{*} \DecValTok{100} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Age }\SpecialCharTok{|}\NormalTok{ Group,}
  \AttributeTok{groups =}\NormalTok{ District, }\AttributeTok{data =}\NormalTok{ Insurance,}
  \AttributeTok{origin =} \DecValTok{0}\NormalTok{, }\AttributeTok{main =} \StringTok{"Motor insurance claims frequency"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"Age"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Claims frequency \%"}\NormalTok{,}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{alternating =} \DecValTok{1}\NormalTok{),}
  \AttributeTok{auto.key =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{space =} \StringTok{"top"}\NormalTok{, }\AttributeTok{columns =} \DecValTok{4}\NormalTok{, }
    \AttributeTok{points =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{rectangles =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"District"}\NormalTok{, }\AttributeTok{cex.title =} \DecValTok{1}
\NormalTok{  ),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{superpose.polygon =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{4}\NormalTok{), }\AttributeTok{border =} \StringTok{"transparent"}\NormalTok{),}
    \AttributeTok{strip.background =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray80"}\NormalTok{),}
    \AttributeTok{strip.border =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{par.strip.text =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"gray40"}\NormalTok{, }\AttributeTok{font =} \DecValTok{2}\NormalTok{),}
  \AttributeTok{panel =} \ControlFlowTok{function}\NormalTok{(x, y, ...) \{}
    \FunctionTok{panel.grid}\NormalTok{(}\AttributeTok{h =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{v =} \DecValTok{0}\NormalTok{)}
    \FunctionTok{panel.barchart}\NormalTok{(x, y, ...)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-80-1} \end{center}

\hypertarget{lattice-smooth}{%
\subsection{平滑图}\label{lattice-smooth}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{xy }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{runif}\NormalTok{(}\DecValTok{100}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{rt}\NormalTok{(}\DecValTok{100}\NormalTok{, }\AttributeTok{df =} \DecValTok{5}\NormalTok{)}
\NormalTok{)}

\FunctionTok{xyplot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, xy, }\AttributeTok{panel =} \ControlFlowTok{function}\NormalTok{(...) \{}
  \FunctionTok{panel.xyplot}\NormalTok{(...)}
  \FunctionTok{panel.smoother}\NormalTok{(..., }\AttributeTok{span =} \FloatTok{0.9}\NormalTok{)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-81-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(splines)}
\FunctionTok{xyplot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, xy) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}\FunctionTok{panel.smoother}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{ns}\NormalTok{(x, }\DecValTok{5}\NormalTok{), }\AttributeTok{method =} \StringTok{"lm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-81-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(nlme)}
\FunctionTok{library}\NormalTok{(mgcv)}
\FunctionTok{xyplot}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, xy) }\SpecialCharTok{+}
  \FunctionTok{layer}\NormalTok{(}\FunctionTok{panel.smoother}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x), }\AttributeTok{method =} \StringTok{"gam"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-81-3} \end{center}

Trellis Displays of Tukey's Hanging Rootograms

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rpois}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\AttributeTok{lambda =} \DecValTok{50}\NormalTok{)}
\FunctionTok{rootogram}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{x, }\AttributeTok{dfun =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{dpois}\NormalTok{(x, }\AttributeTok{lambda =} \DecValTok{50}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-82-1} \end{center}

\hypertarget{lattice-dotplot}{%
\subsection{点图}\label{lattice-dotplot}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 添加背景网格线作为参考线}
\FunctionTok{segplot}\NormalTok{(}\FunctionTok{reorder}\NormalTok{(}\FunctionTok{factor}\NormalTok{(county), rate.male) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LCL95.male }\SpecialCharTok{+}\NormalTok{ UCL95.male,}
  \AttributeTok{data =} \FunctionTok{subset}\NormalTok{(USCancerRates, state }\SpecialCharTok{==} \StringTok{"Washington"}\NormalTok{),}
  \AttributeTok{draw.bands =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{centers =}\NormalTok{ rate.male}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-83-1} \end{center}

\hypertarget{lattice-step}{%
\subsection{阶梯图}\label{lattice-step}}

经验累积分布图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ecdfplot}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{height }\SpecialCharTok{|}\NormalTok{ voice.part, }\AttributeTok{data =}\NormalTok{ singer)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graphics-foundations_files/figure-latex/unnamed-chunk-84-1} \end{center}

\hypertarget{lattice-facet}{%
\subsection{分面图}\label{lattice-facet}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# a variant of Figure 5.6 from Sarkar (2008)}
\DocumentationTok{\#\# http://lmdvr.r{-}forge.r{-}project.org/figures/figures.html?chapter=05;figure=05\_06}

\NormalTok{depth.ord }\OtherTok{\textless{}{-}} \FunctionTok{rev}\NormalTok{(}\FunctionTok{order}\NormalTok{(quakes}\SpecialCharTok{$}\NormalTok{depth))}
\NormalTok{quakes}\SpecialCharTok{$}\NormalTok{Magnitude }\OtherTok{\textless{}{-}} \FunctionTok{equal.count}\NormalTok{(quakes}\SpecialCharTok{$}\NormalTok{mag, }\DecValTok{4}\NormalTok{)}
\NormalTok{quakes.ordered }\OtherTok{\textless{}{-}}\NormalTok{ quakes[depth.ord, ]}

\FunctionTok{levelplot}\NormalTok{(depth }\SpecialCharTok{\textasciitilde{}}\NormalTok{ long }\SpecialCharTok{+}\NormalTok{ lat }\SpecialCharTok{|}\NormalTok{ Magnitude,}
  \AttributeTok{data =}\NormalTok{ quakes.ordered,}
  \AttributeTok{panel =}\NormalTok{ panel.levelplot.points, }\AttributeTok{type =} \FunctionTok{c}\NormalTok{(}\StringTok{"p"}\NormalTok{, }\StringTok{"g"}\NormalTok{),}
  \AttributeTok{aspect =} \StringTok{"iso"}\NormalTok{, }\AttributeTok{prepanel =}\NormalTok{ prepanel.default.xyplot}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-85-1} \end{center}

\hypertarget{lattice-contour}{%
\subsection{等高线图}\label{lattice-contour}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{xyz }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{), }\AttributeTok{y =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{))}
\NormalTok{xyz}\SpecialCharTok{$}\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(xyz, x }\SpecialCharTok{*}\NormalTok{ y }\SpecialCharTok{+} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\AttributeTok{sd =} \DecValTok{1}\NormalTok{))}

\DocumentationTok{\#\# GAM smoother with smoothness by cross validation}
\FunctionTok{library}\NormalTok{(mgcv)}
\FunctionTok{levelplot}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y, xyz,}
  \AttributeTok{panel =}\NormalTok{ panel}\FloatTok{.2}\NormalTok{dsmoother,}
  \AttributeTok{form =}\NormalTok{ z }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, y), }\AttributeTok{method =} \StringTok{"gam"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/smoothness-1} \end{center}

\hypertarget{lattice-persp}{%
\subsection{透视图}\label{lattice-persp}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{persp}\NormalTok{(volcano, }
  \AttributeTok{theta =} \DecValTok{30}\NormalTok{, }\AttributeTok{phi =} \DecValTok{20}\NormalTok{, }
  \AttributeTok{r =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{expand =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{ltheta =} \DecValTok{90}\NormalTok{, }\AttributeTok{lphi =} \DecValTok{180}\NormalTok{,}
  \AttributeTok{shade =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{ticktype =} \StringTok{"detailed"}\NormalTok{, }\AttributeTok{nticks =} \DecValTok{5}\NormalTok{, }\AttributeTok{box =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{drapecol}\NormalTok{(volcano, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{100}\NormalTok{)),}
  \AttributeTok{xlab =} \StringTok{"X"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Y"}\NormalTok{, }\AttributeTok{zlab =} \StringTok{"Z"}\NormalTok{, }\AttributeTok{border =} \StringTok{"transparent"}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"Topographic Information }\SpecialCharTok{\textbackslash{}n}\StringTok{ on Auckland\textquotesingle{}s Maunga Whau Volcano"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{graphics-foundations_files/figure-latex/volcano-topo-1} 

}

\caption{(ref:volcano-topo)}\label{fig:volcano-topo}
\end{figure}

\hypertarget{lattice-cluster}{%
\subsection{聚类图}\label{lattice-cluster}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xyplot}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Petal.Length,}
  \AttributeTok{groups =}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{scales =} \StringTok{"free"}\NormalTok{,}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{superpose.symbol =} \FunctionTok{list}\NormalTok{(}\AttributeTok{pch =} \FunctionTok{c}\NormalTok{(}\DecValTok{15}\SpecialCharTok{:}\DecValTok{17}\NormalTok{)),}
    \AttributeTok{superpose.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{panel =} \ControlFlowTok{function}\NormalTok{(x, y, ...) \{}
    \FunctionTok{panel.xyplot}\NormalTok{(x, y, ...)}
    \FunctionTok{panel.ellipse}\NormalTok{(x, y, ...)}
\NormalTok{  \},}
  \AttributeTok{auto.key =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .}\DecValTok{1}\NormalTok{, }\AttributeTok{y =}\NormalTok{ .}\DecValTok{8}\NormalTok{, }\AttributeTok{corner =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.75\linewidth]{graphics-foundations_files/figure-latex/unnamed-chunk-86-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# lattice 书 6.3.1 节 参数曲面}

\NormalTok{kx }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(u, v) }\FunctionTok{cos}\NormalTok{(u) }\SpecialCharTok{*}\NormalTok{ (r }\SpecialCharTok{+} \FunctionTok{cos}\NormalTok{(u }\SpecialCharTok{/} \DecValTok{2}\NormalTok{))}
\NormalTok{ky }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(u, v) \{}
  \FunctionTok{sin}\NormalTok{(u) }\SpecialCharTok{*}\NormalTok{ (r }\SpecialCharTok{+} \FunctionTok{cos}\NormalTok{(u }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(t }\SpecialCharTok{*}\NormalTok{ v) }\SpecialCharTok{{-}}
    \FunctionTok{sin}\NormalTok{(u }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ t }\SpecialCharTok{*}\NormalTok{ v)) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(t }\SpecialCharTok{*}\NormalTok{ v) }\SpecialCharTok{{-}}
    \FunctionTok{sin}\NormalTok{(u }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ t }\SpecialCharTok{*}\NormalTok{ v)}
\NormalTok{\}}


\NormalTok{kz }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(u, v) }\FunctionTok{sin}\NormalTok{(u }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(t }\SpecialCharTok{*}\NormalTok{ v) }\SpecialCharTok{+} \FunctionTok{cos}\NormalTok{(u }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(t }\SpecialCharTok{*}\NormalTok{ v)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{50}
\NormalTok{u }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{1.25}\NormalTok{, }\AttributeTok{length =}\NormalTok{ n) }\SpecialCharTok{*} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi}
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length =}\NormalTok{ n) }\SpecialCharTok{*} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi}
\NormalTok{um }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(u, }\FunctionTok{length}\NormalTok{(u), }\FunctionTok{length}\NormalTok{(u))}
\NormalTok{vm }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(v, }\FunctionTok{length}\NormalTok{(v), }\FunctionTok{length}\NormalTok{(v), }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{r }\OtherTok{\textless{}{-}} \DecValTok{2}
\NormalTok{t }\OtherTok{\textless{}{-}} \DecValTok{1}

\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{kz}\NormalTok{(um, vm) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{kx}\NormalTok{(um, vm) }\SpecialCharTok{+} \FunctionTok{ky}\NormalTok{(um, vm),}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]),}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]),}
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{170}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{60}\NormalTok{),}
  \AttributeTok{alpha =} \FloatTok{0.75}\NormalTok{, }\AttributeTok{panel.aspect =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{aspect =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{0.4}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{lattice.options =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{layout.widths =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{left.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\NormalTok{.}\DecValTok{6}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{),}
      \AttributeTok{right.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\FloatTok{1.0}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{layout.heights =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{bottom.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\NormalTok{.}\DecValTok{8}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{),}
      \AttributeTok{top.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\FloatTok{1.0}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  ),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{graphics-sessioninfo}{%
\section{运行环境}\label{graphics-sessioninfo}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\SpecialCharTok{::}\FunctionTok{session\_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   base64enc_0.1.3     bookdown_0.26       bslib_0.3.1        
##   cli_3.3.0           compiler_4.2.0      curl_4.3.2         
##   digest_0.6.29       evaluate_0.15       fastmap_1.1.0      
##   fs_1.5.2            glue_1.6.2          graphics_4.2.0     
##   grDevices_4.2.0     grid_4.2.0          highr_0.9          
##   htmltools_0.5.2     jpeg_0.1-9          jquerylib_0.1.4    
##   jsonlite_1.8.0      KernSmooth_2.23-20  knitr_1.39         
##   lattice_0.20-45     latticeExtra_0.6-29 magrittr_2.0.3     
##   mapproj_1.2.8       maps_3.4.0          MASS_7.3-57        
##   Matrix_1.4-1        methods_4.2.0       mgcv_1.8-40        
##   nlme_3.1-157        png_0.1-7           R6_2.5.1           
##   rappdirs_0.3.3      RColorBrewer_1.1-3  rlang_1.0.2        
##   rmarkdown_2.14      sass_0.4.1          shape_1.4.6        
##   splines_4.2.0       stats_4.2.0         stringi_1.7.6      
##   stringr_1.4.0       survival_3.3-1      sysfonts_0.8.8     
##   tinytex_0.39        tools_4.2.0         utils_4.2.0        
##   xfun_0.31           yaml_2.3.5
\end{verbatim}

\hypertarget{chap-data-visualization}{%
\chapter{数据可视化}\label{chap-data-visualization}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)           }\CommentTok{\# ggplot2 图形}
\FunctionTok{library}\NormalTok{(patchwork)         }\CommentTok{\# 图形布局}
\FunctionTok{library}\NormalTok{(magrittr)          }\CommentTok{\# 管道操作}
\FunctionTok{library}\NormalTok{(ggrepel)           }\CommentTok{\# 文本注释}
\FunctionTok{library}\NormalTok{(extrafont)         }\CommentTok{\# 加载外部字体 TTF}
\FunctionTok{library}\NormalTok{(hrbrthemes)        }\CommentTok{\# 主题}
\FunctionTok{library}\NormalTok{(maps)              }\CommentTok{\# 地图数据}
\FunctionTok{library}\NormalTok{(mapdata)           }\CommentTok{\# 地图数据}
\FunctionTok{library}\NormalTok{(xkcd)              }\CommentTok{\# 漫画字体}
\FunctionTok{library}\NormalTok{(RgoogleMaps)       }\CommentTok{\# 静态地图}
\FunctionTok{library}\NormalTok{(data.table)        }\CommentTok{\# 数据操作}
\FunctionTok{library}\NormalTok{(KernSmooth)        }\CommentTok{\# 核平滑}
\FunctionTok{library}\NormalTok{(ggnormalviolin)    }\CommentTok{\# 提琴图}
\FunctionTok{library}\NormalTok{(ggbeeswarm)        }\CommentTok{\# 蜂群图}
\FunctionTok{library}\NormalTok{(gert)              }\CommentTok{\# Git 数据操作}
\FunctionTok{library}\NormalTok{(ggridges)          }\CommentTok{\# 岭线图}
\FunctionTok{library}\NormalTok{(ggpubr)            }\CommentTok{\# 组合图}
\FunctionTok{library}\NormalTok{(treemap)           }\CommentTok{\# 树状图}
\FunctionTok{library}\NormalTok{(treemapify)        }\CommentTok{\# 树状图}
\FunctionTok{library}\NormalTok{(ggalluvial)        }\CommentTok{\# 桑基图}
\FunctionTok{library}\NormalTok{(ggquiver)          }\CommentTok{\# 向量场图}
\FunctionTok{library}\NormalTok{(ggmosaic)          }\CommentTok{\# 马赛克图}
\FunctionTok{library}\NormalTok{(ggbump)            }\CommentTok{\# 凹凸图}
\FunctionTok{library}\NormalTok{(ggstream)          }\CommentTok{\# 水流图}
\FunctionTok{library}\NormalTok{(timelineS)         }\CommentTok{\# 时间线}
\FunctionTok{library}\NormalTok{(ggdendro)          }\CommentTok{\# 聚类图}
\FunctionTok{library}\NormalTok{(ggfortify)         }\CommentTok{\# 统计分析结果可视化：主成分图}
\FunctionTok{library}\NormalTok{(gganimate)         }\CommentTok{\# 动态图}
\end{Highlighting}
\end{Shaded}

David Robinson 给出为何使用 ggplot2 \footnote{\url{http://varianceexplained.org/r/why-I-use-ggplot2/}} 当然也有 Jeff Leek 指出在某些重要场合不适合 ggplot2 \footnote{\url{https://simplystatistics.org/2016/02/11/why-i-dont-use-ggplot2/}} 并且给出强有力的 \href{http://motioninsocial.com/tufte/}{证据}，其实不管怎么样，适合自己的才是好的。也不枉费 Garrick Aden-Buie 花费 160 页幻灯片逐步分解介绍 \href{https://pkg.garrickadenbuie.com/gentle-ggplot2}{优雅的ggplot2}，\href{https://malco.io/}{Malcolm Barrett} 也介绍了 \href{https://malco.io/slides/hs_ggplot2}{ggplot2 基础用法}，还有 Selva Prabhakaran 精心总结给出了 50 个 ggplot2 数据可视化的 \href{https://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html}{例子} 以及 Victor Perrier 为小白用 ggplot2 操碎了心地开发 RStudio 插件 \href{https://github.com/dreamRs/esquisse}{esquisse} 包，Claus O. Wilke 教你一步步创建出版级的图形 \url{https://github.com/clauswilke/practical_ggplot2}。

ggplot2 是十分方便的统计作图工具，相比 Base R，为了一张出版级的图形，不需要去调整每个参数，实现快速出图。集成了很多其它统计计算的 R 包，支持丰富的统计分析和计算功能，如回归、平滑等，实现了作图和模型的无缝连接。比如图\ref{fig:awesome-ggplot2}，使用 loess 局部多项式平滑得到数据的趋势，不仅仅是散点图，代码量也非常少。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(displ, hwy)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ class)) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{se =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{method =} \StringTok{"loess"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Fuel efficiency generally decreases with engine size"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"Two seaters (sports cars) are an exception because of their light weight"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"Data from fueleconomy.gov"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/awesome-ggplot2-1} 

}

\caption{简洁美观}\label{fig:awesome-ggplot2}
\end{figure}

故事源于一幅图片，我不记得第一次见到这幅图是什么时候了，只因多次在多个场合中见过，所以留下了深刻的印象，后来才知道它出自于一篇博文 --- \href{https://medium.com/airbnb-engineering/using-r-packages-and-education-to-scale-data-science-at-airbnb}{Using R packages and education to scale Data Science at Airbnb}，作者 Ricardo Bion 还在其 Github 上传了相关代码\footnote{\url{https://github.com/ricardo-bion/medium_visualization}}。除此之外还有几篇重要的参考资料：

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Pablo Barberá 的 \href{https://github.com/pablobarbera/Rdataviz}{Data Visualization with R and ggplot2}
\item
  Matt Leonawicz 的新作 \href{https://github.com/leonawicz/mapmate}{mapmate}, 可以去其主页欣赏系列作品\footnote{\url{https://leonawicz.github.io/}}
\item
  \href{https://github.com/rfordatascience/tidytuesday}{tidytuesday 可视化挑战官方项目} 还有 \href{https://github.com/abichat/tidytuesday}{tidytuesday}
\item
  \href{https://github.com/IndrajeetPatil/ggstatsplot}{ggstatsplot} 可视化统计检验、模型的结果
\item
  \href{https://github.com/kassambara/ggpubr}{ggpubr} 制作出版级统计图形
\item
  Thomas Lin Pedersen \href{https://github.com/thomasp85/ggplot2_workshop}{Drawing Anything with ggplot2}
\item
  \href{https://designing-ggplots.netlify.app/}{Designing ggplots: making clear figures that communicate}
\item
  \href{https://github.com/teunbrand/ggh4x}{ggh4x} 提供 ggplot2 的额外定制功能
\item
  \href{https://github.com/mjskay/ggdist}{ggdist} Visualizations of distributions and uncertainty
\item
  \href{https://github.com/yutannihilation/gghighlight}{gghighlight}
\item
  \href{https://github.com/briatte/ggnetwork}{ggnetwork}
\item
  \href{https://github.com/ggPMXdevelopment/ggPMX}{ggPMX} `ggplot2' Based Tool to Facilitate Diagnostic Plots for NLME Models
\item
  \href{https://github.com/aphalo/ggpp}{ggpp} ggpp: Grammar Extensions to `ggplot2'
\end{enumerate}

如 Berton Gunter 所说，数据可视化只是一种手段，根据数据实际情况作展示才是重要的，并不是要追求酷炫。

\begin{quote}
3-D bar plots are an abomination. Just because Excel can do them doesn't mean you should. (Dismount pulpit).

\hspace*{\fill} --- Berton Gunter \footnote{\url{https://stat.ethz.ch/pipermail/r-help/2007-October/142420.html}}
\end{quote}

\textbf{grid} 是 \textbf{lattice} 和 \textbf{ggplot2} 的基础，\textbf{gganimate} 是 ggplot2 一个扩展，它将静态图形视为帧，调用第三方工具合成 GIF 动图或 MP4 视频等，要想深入了解 ggplot2，可以去看 \href{http://hadley.nz}{Hadley Wickham}, \href{https://djnavarro.net}{Danielle Navarro}, and \href{https://www.data-imaginist.com}{Thomas Lin Pedersen} 合著的《ggplot2: elegant graphics for data analysis》第三版 \url{https://ggplot2-book.org/}。

\hypertarget{sec-elements}{%
\section{元素}\label{sec-elements}}

以数据集 airquality 为例介绍 GGplot2 图层、主题、配色、坐标、尺度、注释和组合等

\hypertarget{ggplot2-layer}{%
\subsection{图层}\label{ggplot2-layer}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}geom\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "geom_abline"            "geom_area"              "geom_bar"              
##  [4] "geom_bin_2d"            "geom_bin2d"             "geom_blank"            
##  [7] "geom_boxplot"           "geom_col"               "geom_contour"          
## [10] "geom_contour_filled"    "geom_count"             "geom_crossbar"         
## [13] "geom_curve"             "geom_density"           "geom_density_2d"       
## [16] "geom_density_2d_filled" "geom_density2d"         "geom_density2d_filled" 
## [19] "geom_dotplot"           "geom_errorbar"          "geom_errorbarh"        
## [22] "geom_freqpoly"          "geom_function"          "geom_hex"              
## [25] "geom_histogram"         "geom_hline"             "geom_jitter"           
## [28] "geom_label"             "geom_line"              "geom_linerange"        
## [31] "geom_map"               "geom_path"              "geom_point"            
## [34] "geom_pointrange"        "geom_polygon"           "geom_qq"               
## [37] "geom_qq_line"           "geom_quantile"          "geom_raster"           
## [40] "geom_rect"              "geom_ribbon"            "geom_rug"              
## [43] "geom_segment"           "geom_sf"                "geom_sf_label"         
## [46] "geom_sf_text"           "geom_smooth"            "geom_spoke"            
## [49] "geom_step"              "geom_text"              "geom_tile"             
## [52] "geom_violin"            "geom_vline"
\end{verbatim}

生成一个散点图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-4-1} \end{center}

\hypertarget{subsec-axis-label}{%
\subsection{标签}\label{subsec-axis-label}}

图形的标签分为横纵轴标签、刻度标签、主标题、副标题等

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{dates =} \FunctionTok{seq.Date}\NormalTok{(}
    \AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"1945{-}01{-}01"}\NormalTok{),}
    \AttributeTok{to =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"1974{-}12{-}31"}\NormalTok{), }
    \AttributeTok{by =} \StringTok{"quarter"}
\NormalTok{  ),}
  \AttributeTok{presidents =} \FunctionTok{as.vector}\NormalTok{(presidents)}
\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dates, }\AttributeTok{y =}\NormalTok{ presidents)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"slategray"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{color =} \StringTok{"darkslategray"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_date}\NormalTok{(}\AttributeTok{date\_breaks =} \StringTok{"4 year"}\NormalTok{, }\AttributeTok{date\_labels =} \StringTok{"\%Y"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"1945年至1974年美国总统每季度支持率"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"年份"}\NormalTok{, }\AttributeTok{y =} \StringTok{"支持率 (\%)"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"数据源: R 包 datasets"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \FloatTok{10.54}\NormalTok{, }\AttributeTok{base\_family =} \StringTok{"Noto Serif CJK SC"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/approval-ratings-1} 

}

\caption{自1945年第一季度至1974年第四季度美国总统的支持}\label{fig:approval-ratings}
\end{figure}

\hypertarget{subsec-annotation}{%
\subsection{注释}\label{subsec-annotation}}

图中注释的作用在于高亮指出关键点，提请读者注意。文本注释可由 \href{https://github.com/slowkow/ggrepel}{\textbf{ggrepel}} 包提供的标签图层 \texttt{geom\_label\_repel()} 添加，标签数据可独立于之前的数据层，标签所在的位置可以通过参数 \texttt{direction} 和 \texttt{nudge\_y} 精调，图 \ref{fig:text-annotation} 模拟了一组数据。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\FunctionTok{library}\NormalTok{(ggrepel)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{cumsum}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{))}
\NormalTok{)}
\NormalTok{anno\_data }\OtherTok{\textless{}{-}}\NormalTok{ dat }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{subset}\NormalTok{(x }\SpecialCharTok{\%\%} \DecValTok{25} \SpecialCharTok{==} \DecValTok{10}\NormalTok{)  }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{text =} \StringTok{"text"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(x, y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_label\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ text),}
    \AttributeTok{data =}\NormalTok{ anno\_data,}
    \AttributeTok{direction =} \StringTok{"y"}\NormalTok{,}
    \AttributeTok{nudge\_y =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/text-annotation-1} 

}

\caption{文本注释}\label{fig:text-annotation}
\end{figure}

\textbf{ggrepel} 包的图层 \texttt{geom\_text\_repel()} 支持所有数据点的注释，并且自动调整文本的位置，防止重叠，增加辨识度，如图 \ref{fig:mtcars-annotation}。当然，数据点如果过于密集也不适合全部注释，高亮其中的关键点即可。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mtcars }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{cyl =} \FunctionTok{as.factor}\NormalTok{(cyl)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(wt, mpg, }\AttributeTok{label =} \FunctionTok{rownames}\NormalTok{(mtcars), }\AttributeTok{color =}\NormalTok{ cyl)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_text\_repel}\NormalTok{(}\AttributeTok{max.overlaps =} \DecValTok{12}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/mtcars-annotation-1} 

}

\caption{少量点的情况下可以全部注释，且可以解决注释重叠的问题}\label{fig:mtcars-annotation}
\end{figure}

Claus Wilke 开发的 \href{https://github.com/wilkelab/ggtext}{ggtext} 包支持更加丰富的注释样式，详见网站 \url{https://wilkelab.org/ggtext/}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}annotation\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "annotation_custom"   "annotation_logticks" "annotation_map"     
## [4] "annotation_raster"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-6-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \FunctionTok{substitute}\NormalTok{(}\FunctionTok{paste}\NormalTok{(d }\SpecialCharTok{*}
    \FunctionTok{bolditalic}\NormalTok{(x)[}\FunctionTok{italic}\NormalTok{(t)] }\SpecialCharTok{==}\NormalTok{ alpha }\SpecialCharTok{*}\NormalTok{ (theta }\SpecialCharTok{{-}} \FunctionTok{bolditalic}\NormalTok{(x)[}\FunctionTok{italic}\NormalTok{(t)]) }\SpecialCharTok{*}
\NormalTok{    d }\SpecialCharTok{*} \FunctionTok{italic}\NormalTok{(t) }\SpecialCharTok{+}\NormalTok{ lambda }\SpecialCharTok{*}\NormalTok{ d }\SpecialCharTok{*} \FunctionTok{italic}\NormalTok{(B)[}\FunctionTok{italic}\NormalTok{(t)]), }\FunctionTok{list}\NormalTok{(}\AttributeTok{lambda =} \DecValTok{4}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/math-expr-r-1} \end{center}

\href{https://github.com/AllanCameron/geomtextpath}{geomtextpath} 曲线上的文字随曲线弯曲变化

\href{https://github.com/coolbutuseless/ggsvg}{ggsvg} 曲线上散点以图片、彩色图标表示

\hypertarget{ggplot2-scale}{%
\subsection{刻度}\label{ggplot2-scale}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}scale\_(x|y)\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "scale_x_binned"     "scale_x_continuous" "scale_x_date"      
##  [4] "scale_x_datetime"   "scale_x_discrete"   "scale_x_log10"     
##  [7] "scale_x_reverse"    "scale_x_sqrt"       "scale_x_time"      
## [10] "scale_y_binned"     "scale_y_continuous" "scale_y_date"      
## [13] "scale_y_datetime"   "scale_y_discrete"   "scale_y_log10"     
## [16] "scale_y_reverse"    "scale_y_sqrt"       "scale_y_time"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Temp, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 56 97
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(airquality}\SpecialCharTok{$}\NormalTok{Ozone, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]   1 168
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{5}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{20}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-8-1} \end{center}

\hypertarget{ggplot2-legend}{%
\subsection{图例}\label{ggplot2-legend}}

二维的图例 \href{https://github.com/slu-openGIS/biscale}{biscale} 和 \href{https://github.com/clauswilke/multiscales}{multiscales} 和 \href{https://github.com/eliocamp/ggnewscale}{ggnewscale}

\hypertarget{ggplot2-coord}{%
\subsection{坐标系}\label{ggplot2-coord}}

极坐标，直角坐标

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}coord\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "coord_cartesian" "coord_equal"     "coord_fixed"     "coord_flip"     
##  [5] "coord_map"       "coord_munch"     "coord_polar"     "coord_quickmap" 
##  [9] "coord_sf"        "coord_trans"
\end{verbatim}

\hypertarget{ggplot2-axes}{%
\subsection{坐标轴}\label{ggplot2-axes}}

坐标轴标签位置、大小、字体

\hypertarget{ggplot2-color}{%
\subsection{配色}\label{ggplot2-color}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}scale\_(color|fill)\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "scale_color_binned"     "scale_color_brewer"     "scale_color_continuous"
##  [4] "scale_color_date"       "scale_color_datetime"   "scale_color_discrete"  
##  [7] "scale_color_distiller"  "scale_color_fermenter"  "scale_color_gradient"  
## [10] "scale_color_gradient2"  "scale_color_gradientn"  "scale_color_grey"      
## [13] "scale_color_hue"        "scale_color_identity"   "scale_color_manual"    
## [16] "scale_color_ordinal"    "scale_color_steps"      "scale_color_steps2"    
## [19] "scale_color_stepsn"     "scale_color_viridis_b"  "scale_color_viridis_c" 
## [22] "scale_color_viridis_d"  "scale_fill_binned"      "scale_fill_brewer"     
## [25] "scale_fill_continuous"  "scale_fill_date"        "scale_fill_datetime"   
## [28] "scale_fill_discrete"    "scale_fill_distiller"   "scale_fill_fermenter"  
## [31] "scale_fill_gradient"    "scale_fill_gradient2"   "scale_fill_gradientn"  
## [34] "scale_fill_grey"        "scale_fill_hue"         "scale_fill_identity"   
## [37] "scale_fill_manual"      "scale_fill_ordinal"     "scale_fill_steps"      
## [40] "scale_fill_steps2"      "scale_fill_stepsn"      "scale_fill_viridis_b"  
## [43] "scale_fill_viridis_c"   "scale_fill_viridis_d"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone, }\AttributeTok{color =} \FunctionTok{as.factor}\NormalTok{(Month))) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-11-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone, }\AttributeTok{color =} \FunctionTok{as.ordered}\NormalTok{(Month))) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-11-2} \end{center}

\hypertarget{subsec-theme}{%
\subsection{主题}\label{subsec-theme}}

\href{https://github.com/thomas-neitmann/ggcharts}{ggcharts} 和 \href{https://github.com/bbc/bbplot}{bbplot} \href{https://github.com/jumpingrivers/prettyB}{prettyB} 美化 Base R 图形 \href{https://github.com/csdaw/ggprism}{ggprism}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}theme\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "theme_bw"       "theme_classic"  "theme_dark"     "theme_get"     
##  [5] "theme_gray"     "theme_grey"     "theme_light"    "theme_linedraw"
##  [9] "theme_minimal"  "theme_replace"  "theme_set"      "theme_test"    
## [13] "theme_update"   "theme_void"
\end{verbatim}

这里只展示 \texttt{theme\_bw()} \texttt{theme\_void()} \texttt{theme\_minimal()} 和 \texttt{theme\_void()} 等四个常见主题，更多主题参考 \href{https://github.com/nanxstats/ggsci}{ggsci}、\href{https://github.com/jrnold/ggthemes}{ggthemes} 、\href{https://github.com/ricardo-bion/ggtech}{ggtech}、\href{https://github.com/hrbrmstr/hrbrthemes}{hrbrthemes}、\href{https://github.com/houseofcommonslibrary/clcharts}{clcharts} 和 \href{https://github.com/cttobin/ggthemr}{ggthemr} 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_void}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_classic}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\begin{figure}

{\centering \subfloat[黑白主题\label{fig:builtin-themes-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/builtin-themes-1} }\subfloat[无主题\label{fig:builtin-themes-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/builtin-themes-2} }\newline\subfloat[极少配置的主题\label{fig:builtin-themes-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/builtin-themes-3} }\subfloat[经典主题\label{fig:builtin-themes-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/builtin-themes-4} }

}

\caption{ggplot2 内置的主题}\label{fig:builtin-themes}
\end{figure}

除主题之外，还有一类提供一整套统一的风格样式来绘制各种统计图形，如 \href{https://github.com/kassambara/ggpubr}{ggpubr} 和 \href{https://github.com/bbc/bbplot}{bbplot}

\hypertarget{ggplot2-grid}{%
\subsection{布局}\label{ggplot2-grid}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{as.ordered}\NormalTok{(Month))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=0.85\linewidth]{data-visualization_files/figure-latex/unnamed-chunk-13-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(airquality) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Temp, }\AttributeTok{y =}\NormalTok{ Ozone), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{as.ordered}\NormalTok{(Month), }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{data-visualization_files/figure-latex/unnamed-chunk-14-1} \end{center}

\href{https://github.com/wilkelab/cowplot}{cowplot} 是以作者 \href{https://wilkelab.org/}{Claus O. Wilke} 命名的，用来组合 ggplot 对象画图，类似的组合图形的功能包还有 \href{https://baptiste.github.io/}{baptiste auguié} 开发的 \href{https://CRAN.R-project.org/package=gridExtra}{gridExtra} 和 \href{https://github.com/baptiste/egg}{egg}， \href{https://www.data-imaginist.com/}{Thomas Lin Pedersen} 开发的 \href{https://github.com/thomasp85/patchwork}{patchwork}

\href{https://deanattali.com/}{Dean Attali} 开发的 \href{https://github.com/daattali/ggExtra}{ggExtra} 可以在图的边界添加密度估计曲线，直方图等

\hypertarget{sec-fonts}{%
\section{字体}\label{sec-fonts}}

\href{https://github.com/vankesteren/firatheme}{firatheme} 包提供基于 fira sans 字体的 ggplot2 主题，类似的字体主题包还有 \href{https://github.com/leonawicz/trekfont}{trekfont} 、 \href{https://github.com/bhaskarvk/fontHind}{fontHind}， \href{https://github.com/lionel-/fontquiver}{fontquiver} 包与 fontBitstreamVera（Bitstream Vera 字体）、 \href{https://cran.r-project.org/package=fontLiberation}{fontLiberation}（Liberation 字体）包和 \href{https://github.com/lionel-/fontDejaVu}{fontDejaVu} （DejaVu 字体）包一道提供了一些可允许使用的字体文件，这样，我们可以不依赖系统制作可重复的图形。Thomas Lin Pedersen 开发的 \href{https://github.com/r-lib/systemfonts}{systemfonts} 可直接使用系统自带的字体。

\hypertarget{subsec-system-fonts}{%
\subsection{系统字体}\label{subsec-system-fonts}}

以 CentOS 系统为例，软件仓库中包含 \href{https://github.com/googlefonts/noto-fonts}{Noto} ， \href{https://github.com/dejavu-fonts}{DejaVu} 、\href{https://github.com/liberationfonts/liberation-fonts}{liberation} 等字体。可以安装自己喜欢的字体类型，比如：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y} \DataTypeTok{\textbackslash{}}
\NormalTok{  google{-}noto{-}mono{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  google{-}noto{-}sans{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  google{-}noto{-}serif{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  dejavu{-}sans{-}mono{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  dejavu{-}sans{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  dejavu{-}serif{-}fonts}
\CommentTok{\# 或者}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ dejavu{-}fonts liberation{-}fonts}
\end{Highlighting}
\end{Shaded}

liberation 系列的四款字体可以用来替换 Windows 系统上对应的四款字体，对应关系见表 \ref{tab:fonts-centos-vs-win}

\begin{longtable}[]{@{}lll@{}}
\caption{\label{tab:fonts-centos-vs-win} Windows 系统上四款字体的替代品}\tabularnewline
\toprule
& CentOS 系统 & Windows 系统 \\
\midrule
\endfirsthead
\toprule
& CentOS 系统 & Windows 系统 \\
\midrule
\endhead
衬线体/宋体 & liberation-serif-fonts & Times New Roman \\
无衬线体/黑体 & liberation-sans-fonts & Arial \\
Arial 的细瘦版 & liberation-narrow-fonts & Arial Narrow \\
等宽体/微软雅黑 & liberation-mono-fonts & Courier New \\
\bottomrule
\end{longtable}

Lionel Henry 将 Liberation 系列字体打包到 R 包 \href{https://github.com/lionel-/fontLiberation}{fontLiberation}，非常便携，不需要操心跨平台的字体安装了。那如何使用呢？

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# install.packages("fontLiberation")}
\FunctionTok{system.file}\NormalTok{(}\AttributeTok{package =} \StringTok{"fontLiberation"}\NormalTok{, }\StringTok{"fonts"}\NormalTok{, }\StringTok{"liberation{-}fonts"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] ""
\end{verbatim}

此外，我们还可以从网上获取各种个样的字体，特别地，Boryslav Larin 收录的 \href{https://github.com/brabadu/awesome-fonts}{awesome-fonts} 列表是一个不错的开始，比如图标字体 \href{https://github.com/FortAwesome/Font-Awesome}{Font-Awesome}，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ fontawesome{-}fonts}
\end{Highlighting}
\end{Shaded}

再安装宏包 \href{https://ctan.org/pkg/fontawesome}{fontawesome} 后，即可在 LaTeX 文档中使用，下面这个示例推荐用 XeLaTeX 引擎编译。

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{\textbackslash{}documentclass}\NormalTok{[border=10pt]\{}\ExtensionTok{standalone}\NormalTok{\}}
\BuiltInTok{\textbackslash{}usepackage}\NormalTok{\{}\ExtensionTok{fontawesome}\NormalTok{\}}
\KeywordTok{\textbackslash{}begin}\NormalTok{\{}\ExtensionTok{document}\NormalTok{\}}
\NormalTok{Hello, }\FunctionTok{\textbackslash{}faGithub}
\KeywordTok{\textbackslash{}end}\NormalTok{\{}\ExtensionTok{document}\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

而在 R 绘制的图形中，通过指定 \texttt{par()}、 \texttt{plot()}、 \texttt{title()} 等函数的 \texttt{family} 参数值，比如 \texttt{family\ =\ "Liberation\ Sans"} 来调用系统无衬线 Liberation 字体，效果见图 \ref{fig:system-fonts-liberation}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(extrafont)}
\FunctionTok{plot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ pressure, pressure }\SpecialCharTok{\textasciitilde{}}\NormalTok{ temperature, }
     \AttributeTok{xlab =} \StringTok{"Temperature (deg C)"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Pressure (mm of Hg)"}\NormalTok{,}
     \AttributeTok{col.lab =} \StringTok{"red"}\NormalTok{, }\AttributeTok{col.axis =} \StringTok{"blue"}\NormalTok{,}
     \AttributeTok{font.lab =} \DecValTok{3}\NormalTok{, }\AttributeTok{font.axis =} \DecValTok{2}\NormalTok{, }\AttributeTok{family =} \StringTok{"Liberation Sans"}\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Vapor Pressure of Mercury as a Function of Temperature"}\NormalTok{, }
      \AttributeTok{family =} \StringTok{"Liberation Serif"}\NormalTok{, }\AttributeTok{font.main =} \DecValTok{3}\NormalTok{)}
\FunctionTok{title}\NormalTok{(}\AttributeTok{sub =} \StringTok{"Data Source: Weast, R. C"}\NormalTok{, }
      \AttributeTok{family =} \StringTok{"Liberation Mono"}\NormalTok{, }\AttributeTok{font.sub =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/system-fonts-liberation-1} 

}

\caption{调用系统字体绘图}\label{fig:system-fonts-liberation}
\end{figure}

为了符合出版的要求，需要在 \ref{fig:system-fonts-liberation} 中嵌入字体，

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# embed fonts to pdf}
\NormalTok{embed\_fonts }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(fig\_path) \{}
  \ControlFlowTok{if}\NormalTok{(knitr}\SpecialCharTok{::}\FunctionTok{is\_latex\_output}\NormalTok{())\{}
    \FunctionTok{embedFonts}\NormalTok{(}
      \AttributeTok{file =}\NormalTok{ fig\_path, }\AttributeTok{outfile =}\NormalTok{ fig\_path,}
      \AttributeTok{fontpaths =} \StringTok{"\textasciitilde{}/Library/Fonts"}
\NormalTok{    )}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(fig\_path)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

设置代码块选项 \texttt{fig.process=embed\_fonts}，这样生成 PDF 格式图形的时候，会调用此函数处理 PDF 图形。在 ggplot2 绘图中的调用方式是类似的，便不再赘述了。值得注意的是，extrafont 和 showtext 有些不一样，前者只能处理系统字体，后者还能获取网络字体和使用 OTF 字体，下面从 Google 开源的字体库获取 Noto 系列的四款字体，如图 \ref{fig:font-in-ggplot}。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Noto Sans"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{)}
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Noto Serif"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Noto Serif"}\NormalTok{)}
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Noto Serif SC"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{)}
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Noto Sans SC"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Noto Sans SC"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{rmdwarn}{警告}
在本书中，不要全局加载 showtext 包或调用 \texttt{showtext::showtext\_auto()}，会和 extrafont 冲突，使得绘图时默认就只能使用 showtext 提供的字体。extrafont 包提供的函数 \texttt{font\_import()} 仅支持系统安装的 TrueType/Type1 字体

\end{rmdwarn}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(pressure, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ temperature, }\AttributeTok{y =}\NormalTok{ pressure)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\AttributeTok{label =} \StringTok{"默认字体设置"}\NormalTok{)}

\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ p1 }\SpecialCharTok{+} \FunctionTok{theme}\NormalTok{(}
  \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{),}
  \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\AttributeTok{label =} \StringTok{"英文字体设置"}\NormalTok{)}

\NormalTok{p3 }\OtherTok{\textless{}{-}}\NormalTok{ p1 }\SpecialCharTok{+} \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"温度"}\NormalTok{, }\AttributeTok{y =} \StringTok{"压力"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\AttributeTok{label =} \StringTok{"中文字体设置"}\NormalTok{)}

\NormalTok{p4 }\OtherTok{\textless{}{-}}\NormalTok{ p1 }\SpecialCharTok{+} \FunctionTok{labs}\NormalTok{(}
  \AttributeTok{x =} \StringTok{"温度"}\NormalTok{, }\AttributeTok{y =} \StringTok{"压力"}\NormalTok{, }\AttributeTok{title =} \StringTok{"散点图"}\NormalTok{,}
  \AttributeTok{subtitle =} \StringTok{"Vapor Pressure of Mercury as a Function of Temperature"}\NormalTok{,}
  \AttributeTok{caption =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Data on the relation }
\StringTok{                  between temperature in degrees Celsius and"}\NormalTok{,}
    \StringTok{"vapor pressure of mercury in millimeters (of mercury)."}\NormalTok{,}
    \AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif"}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{),}
    \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{),}
    \AttributeTok{plot.subtitle =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{, }\AttributeTok{size =} \FunctionTok{rel}\NormalTok{(}\FloatTok{0.7}\NormalTok{)),}
    \AttributeTok{plot.caption =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans"}\NormalTok{, }\AttributeTok{size =} \FunctionTok{rel}\NormalTok{(}\FloatTok{0.6}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\AttributeTok{label =} \StringTok{"任意字体设置"}\NormalTok{)}

\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2) }\SpecialCharTok{/}\NormalTok{ (p3 }\SpecialCharTok{+}\NormalTok{ p4)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=1\linewidth]{data-visualization_files/figure-latex/font-in-ggplot-1} 

}

\caption{在 ggplot2 绘图系统中设置中英文字体}\label{fig:font-in-ggplot}
\end{figure}

另外值得一提的是 \href{https://github.com/hrbrmstr/hrbrthemes}{hrbrthemes} 包，除了定制了很多 ggplot2 主题，它还打包了很多的字体主题。比如默认主题 \texttt{theme\_ipsum()} 使用 Arial Narrow 字体，如果没有该字体就自动寻找系统中的替代品，如图 \ref{fig:hrbrthemes} 实际使用的是 Nimbus Sans Narrow 字体，因为在 GitHub Action 中，我实际使用的测试环境是 Ubuntu 20.04，该系统自带 Nimbus Sans Narrow 字体，Arial Narrow 毕竟是 Windows 上的闭源字体。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# brew install font{-}roboto}
\CommentTok{\# 导入字体}
\CommentTok{\# hrbrthemes::import\_roboto\_condensed()}
\NormalTok{sysfonts}\SpecialCharTok{::}\FunctionTok{font\_add\_google}\NormalTok{(}\AttributeTok{name =} \StringTok{"Roboto Condensed"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Roboto Condensed"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(hrbrthemes)}
\FunctionTok{ggplot}\NormalTok{(mtcars, }\FunctionTok{aes}\NormalTok{(mpg, wt)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Fuel efficiency (mpg)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Weight (tons)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Seminal ggplot2 scatterplot example"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"A plot that is only useful for demonstration purposes"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"Brought to you by the letter \textquotesingle{}g\textquotesingle{}"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_ipsum}\NormalTok{(}\AttributeTok{base\_family =} \StringTok{"Roboto Condensed"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/hrbrthemes-1} 

}

\caption{调用 hrbrthemes 包设置字体主题}\label{fig:hrbrthemes}
\end{figure}

如果系统没有安装 Arial Narrow 字体，可以导入 hrbrthemes 包自带的一些字体，比如 \texttt{hrbrthemes::import\_roboto\_condensed()}，然后调用字体主题 \texttt{theme\_ipsum\_rc()} 。如果不想使用这个包自带的字体，可以用系统中安装的字体去修改主题 \texttt{theme\_ipsum()} 和 \texttt{theme\_ipsum\_rc()} 中的字体设置。如图 \ref{fig:arial-narrow} 使用了 \texttt{theme\_ipsum()} 中的 Arial Narrow 字体。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mtcars, }\FunctionTok{aes}\NormalTok{(mpg, wt)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Fuel efficiency (mpg)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Weight (tons)"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Seminal ggplot2 scatterplot example"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"A plot that is only useful for demonstration purposes"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"Brought to you by the letter \textquotesingle{}g\textquotesingle{}"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_ipsum}\NormalTok{(}\AttributeTok{base\_family =} \StringTok{"Noto Sans"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/arial-narrow-1} 

}

\caption{默认字体 Arial Narrow}\label{fig:arial-narrow}
\end{figure}

\begin{rmdtip}{提示}
\textbf{hrbrthemes} 包提供了一个全局字体加载选项 \texttt{hrbrthemes.loadfonts} ，如果设置为 TRUE，即 \texttt{options(hrbrthemes.loadfonts\ =\ TRUE)} 会先调用函数 \texttt{extrafont::loadfonts()} 预加载系统字体，就不用一次次手动加载字体了。后续在第 \ref{subsec-fontcm} 节还会提及 extrafont 包的其它功能。

\end{rmdtip}

\hypertarget{subsec-showtext}{%
\subsection{思源字体}\label{subsec-showtext}}

邱怡轩开发的 \href{https://github.com/yixuan/showtext}{showtext} 包支持丰富的外部字体，支持 Base R 和 ggplot2 图形，图 \ref{fig:showtext} 嵌入了 5 号思源宋体，图例和坐标轴文本使用 serif 字体，更多详细的使用文档见 \citep{Qiu2015}。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 安装 showtext 包}
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}showtext\textquotesingle{}}\NormalTok{)}
\CommentTok{\# 思源宋体}
\NormalTok{showtextdb}\SpecialCharTok{::}\FunctionTok{font\_install}\NormalTok{(showtextdb}\SpecialCharTok{::}\FunctionTok{source\_han\_serif}\NormalTok{())}
\CommentTok{\# 思源黑体}
\NormalTok{showtextdb}\SpecialCharTok{::}\FunctionTok{font\_install}\NormalTok{(showtextdb}\SpecialCharTok{::}\FunctionTok{source\_han\_sans}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ggplot(iris, aes(Sepal.Length, Sepal.Width)) +}
\CommentTok{\#   geom\_point(aes(colour = Species)) +}
\CommentTok{\#   scale\_colour\_brewer(palette = "Set1") +}
\CommentTok{\#   labs(}
\CommentTok{\#     title = "鸢尾花数据的散点图",}
\CommentTok{\#     x = "萼片长度", y = "萼片宽度", colour = "鸢尾花类别",}
\CommentTok{\#     caption = "鸢尾花数据集最早见于 Edgar Anderson (1935) "}
\CommentTok{\#   ) +}
\CommentTok{\#   theme(}
\CommentTok{\#     title = element\_text(family = "source{-}han{-}sans{-}cn"),}
\CommentTok{\#     axis.title = element\_text(family = "source{-}han{-}serif{-}cn"),}
\CommentTok{\#     legend.title = element\_text(family = "source{-}han{-}serif{-}cn")}
\CommentTok{\#   )}
\FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(Sepal.Length, Sepal.Width)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{colour =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{scale\_colour\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Set1"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"鸢尾花数据的散点图"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"萼片长度"}\NormalTok{, }\AttributeTok{y =} \StringTok{"萼片宽度"}\NormalTok{, }\AttributeTok{colour =} \StringTok{"鸢尾花类别"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"鸢尾花数据集最早见于 Edgar Anderson (1935) "}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Sans SC"}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Noto Serif SC"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/showtext-1} 

}

\caption{showtext 包处理图里的中文}\label{fig:showtext}
\end{figure}

\hypertarget{subsec-fontcm}{%
\subsection{数学字体}\label{subsec-fontcm}}

Winston Chang 将 Paul Murrell 的 Computer Modern 字体文件打包成 \href{https://github.com/wch/fontcm}{fontcm} 包 \citep{fontcm}，\textbf{fontcm} 包可以在 Base R 图形中嵌入数学字体 \footnote{\url{https://www.stat.auckland.ac.nz/~paul/R/CM/CMR.html}}，图形中嵌入重音字符 \footnote{\url{https://www.stat.auckland.ac.nz/~paul/Reports/maori/maori.html}}。 下面先下载、安装、加载字体，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(extrafont)}
\ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\StringTok{"fontcm"} \SpecialCharTok{\%in\%} \FunctionTok{.packages}\NormalTok{(T)) \{}
  \FunctionTok{install.packages}\NormalTok{(}\StringTok{"fontcm"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

查看可被 \texttt{pdf()} 图形设备使用的字体列表

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 可用的字体}
\FunctionTok{fonts}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

fontcm 包提供数学字体，\texttt{grDevices::embedFonts()} 函数调用 Ghostscript 软件将数学字体嵌入 ggplot2 图形中，达到正确显示数学公式的目的，此方法适用于 pdf 设备保存的图形，对 \texttt{cairo\_pdf()} 保存的 PDF 格式图形无效。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(fontcm)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(extrafont)}
\FunctionTok{library}\NormalTok{(patchwork)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{)),}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Made with CM fonts"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Made with CM fonts"}\NormalTok{,}
    \AttributeTok{title =} \StringTok{"Made with CM fonts"}
\NormalTok{  )}
\CommentTok{\# 公式}
\NormalTok{eq }\OtherTok{\textless{}{-}} \StringTok{"italic(sum(frac(1, n*\textquotesingle{}!\textquotesingle{}), n==0, infinity) ==}
\StringTok{       lim(bgroup(\textquotesingle{}(\textquotesingle{}, 1 + frac(1, n), \textquotesingle{})\textquotesingle{})\^{}n, n \%{-}\textgreater{}\% infinity))"}
\CommentTok{\# 默认字体}
\NormalTok{p1 }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{,}
  \AttributeTok{x =} \DecValTok{3}\NormalTok{, }\AttributeTok{y =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{parse =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{label =}\NormalTok{ eq }\CommentTok{\# , family = "CM Roman"}
\NormalTok{)}
\CommentTok{\# 使用 CM Roman 字体}
\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{,}
  \AttributeTok{x =} \DecValTok{3}\NormalTok{, }\AttributeTok{y =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{parse =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{label =}\NormalTok{ eq, }\AttributeTok{family =} \StringTok{"CM Roman"}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{family =} \StringTok{"CM Roman"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face =} \StringTok{"italic"}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face =} \StringTok{"bold"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

为实现图 \ref{fig:fontcm} 的最终效果，需要启用一个有超级牛力的 \href{https://yihui.org/knitr/options/\#plots}{fig.process} 选项，主要是传递一个函数给它，对用 R 语言生成的图形再操作。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# embed math fonts to pdf}
\NormalTok{embed\_math\_fonts }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(fig\_path) \{}
  \ControlFlowTok{if}\NormalTok{(knitr}\SpecialCharTok{::}\FunctionTok{is\_latex\_output}\NormalTok{())\{}
    \FunctionTok{embedFonts}\NormalTok{(}
      \AttributeTok{file =}\NormalTok{ fig\_path, }\AttributeTok{outfile =}\NormalTok{ fig\_path,}
      \AttributeTok{fontpaths =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"fonts"}\NormalTok{, }\AttributeTok{package =} \StringTok{"fontcm"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(fig\_path)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

代码块选项中设置 \texttt{fig.process=embed\_math\_fonts} 可在绘图后，立即插入字体，此操作仅限于以 pdf 格式保存的图形设备，也适用于 Base R 绘制的图形，见图 \ref{fig:embed-math-fonts}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.1}\NormalTok{, }\FloatTok{4.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\AttributeTok{family =} \StringTok{"CM Roman"}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{len =} \DecValTok{101}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{sin}\NormalTok{(x), }\FunctionTok{cos}\NormalTok{(x))}
\FunctionTok{matplot}\NormalTok{(x, y,}
  \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{xaxt =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{main =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}
    \FunctionTok{plain}\NormalTok{(sin) }\SpecialCharTok{*}\NormalTok{ phi, }\StringTok{"  and  "}\NormalTok{,}
    \FunctionTok{plain}\NormalTok{(cos) }\SpecialCharTok{*}\NormalTok{ phi}
\NormalTok{  )),}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(}\StringTok{"sin"} \SpecialCharTok{*}\NormalTok{ phi, }\StringTok{"cos"} \SpecialCharTok{*}\NormalTok{ phi),}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Phase Angle "}\NormalTok{, phi)),}
  \AttributeTok{col.main =} \StringTok{"blue"}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{,}
  \AttributeTok{at =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, }\SpecialCharTok{{-}}\NormalTok{pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, pi),}
  \AttributeTok{labels =} \FunctionTok{expression}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pi, }\SpecialCharTok{{-}}\NormalTok{pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, pi }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, pi)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-tikz-device}{%
\subsection{TikZ 设备}\label{subsec-tikz-device}}

与 \ref{subsec-fontcm} 小节不同，Ralf Stubner 维护的 \href{https://github.com/daqana/tikzDevice}{\textbf{tikzDevice}} 包提供了另一种嵌入数学字体的方式，其提供的 \texttt{tikzDevice::tikz()} 绘图设备将图形对象转化为 TikZ 代码，调用 LaTeX 引擎编译成 PDF 文档。安装后，先测试一下 LaTeX 编译环境是否正常。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tikzDevice}\SpecialCharTok{::}\FunctionTok{tikzTest}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Active compiler:
##  /home/runner/.TinyTeX/bin/x86_64-linux/xelatex
##  XeTeX 3.141592653-2.6-0.999994 (TeX Live 2022)
##  kpathsea version 6.3.4
\end{verbatim}

\begin{verbatim}
## [1] 7.90259
\end{verbatim}

确认没有问题后，下面图 \ref{fig:tikz-regression} 的坐标轴标签，标题，图例等位置都支持数学公式，使用 \textbf{tikzDevice} 打造出版级的效果图。更多功能的介绍见 \url{https://www.daqana.org/tikzDevice/}。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}}\NormalTok{ x }\SpecialCharTok{+} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{5}\NormalTok{, }\AttributeTok{sd =} \FloatTok{0.25}\NormalTok{)}
\NormalTok{model }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x)}
\NormalTok{rsq }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(model)}\SpecialCharTok{$}\NormalTok{r.squared}
\NormalTok{rsq }\OtherTok{\textless{}{-}} \FunctionTok{signif}\NormalTok{(rsq, }\DecValTok{4}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y,}
  \AttributeTok{main =} \StringTok{"Hello }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{LaTeX!"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"$x$"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"$y$"}\NormalTok{,}
  \AttributeTok{sub =} \StringTok{"$}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mathcal\{N\}(x;}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mu,}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{Sigma)$"}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(model, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Linear model: $R\^{}\{2\}="}\NormalTok{, rsq, }\StringTok{"$"}\NormalTok{), }\AttributeTok{line =} \FloatTok{0.5}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomright"}\NormalTok{,}
  \AttributeTok{legend =} \FunctionTok{paste0}\NormalTok{(}
    \StringTok{"$y = "}\NormalTok{,}
    \FunctionTok{round}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model)[}\DecValTok{2}\NormalTok{], }\DecValTok{3}\NormalTok{),}
    \StringTok{"x +"}\NormalTok{,}
    \FunctionTok{round}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model)[}\DecValTok{1}\NormalTok{], }\DecValTok{3}\NormalTok{),}
    \StringTok{"$"}
\NormalTok{  ),}
  \AttributeTok{bty =} \StringTok{"n"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/tikz-regression-1} 

}

\caption{线性回归模型}\label{fig:tikz-regression}
\end{figure}

推荐的全局 LaTeX 环境配置如下：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{options}\NormalTok{(}
  \AttributeTok{tinytex.engine =} \StringTok{"xelatex"}\NormalTok{,}
  \AttributeTok{tikzDefaultEngine =} \StringTok{"xetex"}\NormalTok{,}
  \AttributeTok{tikzDocumentDeclaration =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{documentclass[tikz]\{standalone\}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
  \AttributeTok{tikzXelatexPackages =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{usepackage[fontset=adobe]\{ctex\}"}\NormalTok{,}
    \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{usepackage[default,semibold]\{sourcesanspro\}"}\NormalTok{,}
    \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{usepackage\{amsfonts,mathrsfs,amssymb\}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

设置默认的 LaTeX 编译引擎为 XeLaTeX，相比于 PDFLaTeX，它对中文的兼容性更好，支持多平台下的中文环境，中文字体这里采用了 Adobe 的字体，默认加载了 mathrsfs 宏包支持 \texttt{\textbackslash{}mathcal}、\texttt{\textbackslash{}mathscr} 等命令，此外， LaTeX 发行版采用谢益辉自定义的 \href{https://yihui.org/tinytex/}{TinyTeX}。绘制独立的 PDF 图形的过程如下：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tikzDevice)}
\NormalTok{tf }\OtherTok{\textless{}{-}} \FunctionTok{file.path}\NormalTok{(}\FunctionTok{getwd}\NormalTok{(), }\StringTok{"tikz{-}regression.tex"}\NormalTok{)}
\FunctionTok{tikz}\NormalTok{(tf, }\AttributeTok{width =} \DecValTok{6}\NormalTok{, }\AttributeTok{height =} \FloatTok{5.5}\NormalTok{, }\AttributeTok{pointsize =} \DecValTok{30}\NormalTok{, }\AttributeTok{standAlone =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 绘图代码}
\FunctionTok{dev.off}\NormalTok{()}
\CommentTok{\# 编译成 PDF 图形}
\NormalTok{tinytex}\SpecialCharTok{::}\FunctionTok{latexmk}\NormalTok{(}\AttributeTok{file =} \StringTok{"tikz{-}regression.tex"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-xkcd-comic}{%
\subsection{漫画字体}\label{subsec-xkcd-comic}}

下载 XKCD 字体，并刷新系统字体缓存

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mkdir} \AttributeTok{{-}p}\NormalTok{ \textasciitilde{}/.fonts}
\ExtensionTok{curl} \AttributeTok{{-}fLo}\NormalTok{ \textasciitilde{}/.fonts/xkcd.ttf http://simonsoftware.se/other/xkcd.ttf}
\ExtensionTok{fc{-}cache} \AttributeTok{{-}fsv}
\end{Highlighting}
\end{Shaded}

将 XKCD 字体导入到 R 环境，以便后续被 ggplot2 图形设备调用。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R }\SpecialCharTok{{-}}\NormalTok{e }\StringTok{\textquotesingle{}library(extrafont);font\_import(pattern="[X/x]kcd.ttf", prompt = FALSE)\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

下图是一个使用 xkcd 字体的简单例子，更多高级特性请看 \textbf{xkcd} 包文档 \citep{xkcd}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(xkcd)}
\FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(mpg, wt), }\AttributeTok{data =}\NormalTok{ mtcars) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_xkcd}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-emoji-fonts}{%
\subsection{表情字体}\label{subsec-emoji-fonts}}

余光创开发的 \href{https://github.com/GuangchuangYu/emojifont}{emojifont} 包和 Hadley 开发的 \href{https://github.com/hadley/emo}{emo} 包，下面使用 Noto Emoji 字体，支持的表情图见 \url{https://www.google.com/get/noto/help/emoji/food-drink/}，下面给出一个示例。先从 GitHub 安装 \textbf{emo} 包，目前它还未正式发布到 CRAN 上。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{remotes}\SpecialCharTok{::}\FunctionTok{install\_github}\NormalTok{(}\StringTok{"hadley/emo"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

除了安装 emo 包，系统需要先安装好 emoji 字体，图形才会正确地渲染出来，想调用更多 emoji 图标请参考 \href{https://github.com/ikatyang/emoji-cheat-sheet}{Emoji 速查手册}，给出 emoji 对应的名字。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# CentOS}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ google{-}noto{-}emoji{-}color{-}fonts }\DataTypeTok{\textbackslash{}}
\NormalTok{  google{-}noto{-}emoji{-}fonts}
\CommentTok{\# MacOS}
\ExtensionTok{brew}\NormalTok{ cask install font{-}noto{-}color{-}emoji font{-}noto{-}emoji}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{category =} \FunctionTok{c}\NormalTok{(}\StringTok{"pineapple"}\NormalTok{, }\StringTok{"apple"}\NormalTok{, }\StringTok{"watermelon"}\NormalTok{, }\StringTok{"mango"}\NormalTok{, }\StringTok{"pear"}\NormalTok{),}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{category =} \FunctionTok{sapply}\NormalTok{(category, emo}\SpecialCharTok{::}\NormalTok{ji)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ category, }\AttributeTok{y =}\NormalTok{ value)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{7}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ category), }\AttributeTok{size =} \DecValTok{12}\NormalTok{, }\AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/emoji-fonts-online-1} 

}

\caption{表情字体}\label{fig:emoji-fonts-online}
\end{figure}

Noto Color Emoji 字体在 MacOS 上有问题，为了跨平台的便携性，提供 emojifont 包的例子，要引入更多的依赖。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(emojifont)}

\NormalTok{names }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"smile"}\NormalTok{, }\StringTok{"school"}\NormalTok{, }\StringTok{"office"}\NormalTok{, }\StringTok{"blush"}\NormalTok{, }\StringTok{"smirk"}\NormalTok{, }\StringTok{"heart\_eyes"}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(names)}\SpecialCharTok{:}\DecValTok{1}
\NormalTok{e }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(names, emojifont}\SpecialCharTok{::}\NormalTok{emoji)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{emoji\_name =}\NormalTok{ names, }\AttributeTok{n =}\NormalTok{ n, }\AttributeTok{emoji =}\NormalTok{ e, }\AttributeTok{stringsAsFactors =}\NormalTok{ F)}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(emoji\_name, n)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_discrete}\NormalTok{(}\AttributeTok{breaks =}\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{emoji\_name, }\AttributeTok{labels =}\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{emoji) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{family =} \StringTok{"EmojiOne"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-colors}{%
\section{配色}\label{sec-colors}}

配色真的是一门学问，有的人功力非常深厚，仅用黑白灰就可以创造出一个世界，如中国的水墨画，科波拉执导的《教父》，沃卓斯基姐妹执导的《黑客帝国》等。黑西装、白衬衫和黑领带是《黑客帝国》的经典元素，《教父》开场的黑西装、黑领结和白衬衫，尤其胸前的红玫瑰更是点睛之笔。导演将黑白灰和光影混合形成了层次丰富立体的画面，打造了一场视觉盛宴，无论是呈现在纸上还是银幕上都可以给人留下深刻的印象。正所谓食色性也，花花世界，岂能都是法印眼中的白骨！再说《红楼梦》里，芍药丛中，桃花树下，滴翠亭边，栊翠庵里，处处都是湘云、黛玉、宝钗、妙玉留下的四季诗歌。

为什么需要这么多颜色模式呢？主要取决于颜色输出的通道，比如印刷机，照相机，自然界，网页，人眼等，显示器因屏幕和分辨率的不同呈现的色彩数量是不一样的。读者大概都听说过 RGB、CMYK、AdobeRGB、sRGB、P3 广色域等名词，我想这主要归功于各大电子设备厂商的宣传。普清、高清、超高清、全高清、2K、4K、5K、视网膜屏，而 HSV、HCL 估计听说的人就少很多了。本节的目的是简单阐述背后的色彩原理，颜色模式及其之间的转化，在应对天花乱坠的销售时少交一些智商税，同时，告诉读者如何在 R 环境中使用色彩。早些时候我在统计之都论坛上发帖 -- R语言绘图用调色板大全 \url{https://d.cosx.org/d/419378}，如果读者希望拿来即用，不妨去看看。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{filled.contour}\NormalTok{(volcano, }\AttributeTok{nlevels =} \DecValTok{10}\NormalTok{, }\AttributeTok{color.palette =}\NormalTok{ terrain.colors)}
\FunctionTok{filled.contour}\NormalTok{(volcano, }\AttributeTok{nlevels =} \DecValTok{10}\NormalTok{, }\AttributeTok{color.palette =}\NormalTok{ heat.colors)}
\FunctionTok{filled.contour}\NormalTok{(volcano, }\AttributeTok{nlevels =} \DecValTok{10}\NormalTok{, }\AttributeTok{color.palette =}\NormalTok{ topo.colors)}
\FunctionTok{filled.contour}\NormalTok{(volcano, }\AttributeTok{nlevels =} \DecValTok{10}\NormalTok{, }\AttributeTok{color.palette =}\NormalTok{ cm.colors)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[terrain.colors 调色板\label{fig:old-color-palette-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/old-color-palette-1} }\subfloat[heat.colors 调色板\label{fig:old-color-palette-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/old-color-palette-2} }\newline\subfloat[topo.colors 调色板\label{fig:old-color-palette-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/old-color-palette-3} }\subfloat[cm.colors 调色板\label{fig:old-color-palette-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/old-color-palette-4} }

}

\caption{R 3.6.0 以前的调色板}\label{fig:old-color-palette}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{nlevels =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{color.palette =} \ControlFlowTok{function}\NormalTok{(n, ...) }\FunctionTok{hcl.colors}\NormalTok{(n, }\StringTok{"Grays"}\NormalTok{, }\AttributeTok{rev =} \ConstantTok{TRUE}\NormalTok{, ...)}
\NormalTok{)}
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{nlevels =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{color.palette =} \ControlFlowTok{function}\NormalTok{(n, ...) }\FunctionTok{hcl.colors}\NormalTok{(n, }\StringTok{"YlOrRd"}\NormalTok{, }\AttributeTok{rev =} \ConstantTok{TRUE}\NormalTok{, ...)}
\NormalTok{)}
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{nlevels =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{color.palette =} \ControlFlowTok{function}\NormalTok{(n, ...) }\FunctionTok{hcl.colors}\NormalTok{(n, }\StringTok{"purples"}\NormalTok{, }\AttributeTok{rev =} \ConstantTok{TRUE}\NormalTok{, ...)}
\NormalTok{)}
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{nlevels =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{color.palette =} \ControlFlowTok{function}\NormalTok{(n, ...) }\FunctionTok{hcl.colors}\NormalTok{(n, }\StringTok{"viridis"}\NormalTok{, }\AttributeTok{rev =} \ConstantTok{FALSE}\NormalTok{, ...)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[Grays 调色板\label{fig:new-color-palette-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/new-color-palette-1} }\subfloat[YlOrRd 调色板\label{fig:new-color-palette-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/new-color-palette-2} }\newline\subfloat[Purples 3 调色板\label{fig:new-color-palette-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/new-color-palette-3} }\subfloat[Viridis 调色板\label{fig:new-color-palette-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/new-color-palette-4} }

}

\caption{R 3.6.0 以后的调色板}\label{fig:new-color-palette}
\end{figure}

\begin{rmdnote}{注意}
\texttt{hcl.colors()} 函数是在 R 3.6.0 引入的，之前的 R 软件版本中没有，同时内置了 110 个调色板，详见 \texttt{hcl.pals()}。

\end{rmdnote}

\hypertarget{subsec-color-palettes}{%
\subsection{调色板}\label{subsec-color-palettes}}

R 预置的灰色有224种，挑出其中的调色板

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}gr(a|e)y"}\NormalTok{, }\FunctionTok{grep}\NormalTok{(}\StringTok{"gr(a|e)y"}\NormalTok{, }\FunctionTok{colors}\NormalTok{(), }\AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{), }
     \AttributeTok{value =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{invert =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "darkgray"       "darkgrey"       "darkslategray"  "darkslategray1"
##  [5] "darkslategray2" "darkslategray3" "darkslategray4" "darkslategrey" 
##  [9] "dimgray"        "dimgrey"        "lightgray"      "lightgrey"     
## [13] "lightslategray" "lightslategrey" "slategray"      "slategray1"    
## [17] "slategray2"     "slategray3"     "slategray4"     "slategrey"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gray\_colors }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"slategray"}\NormalTok{, }\StringTok{"darkslategray"}\NormalTok{), }\AttributeTok{each =} \DecValTok{4}\NormalTok{), }\FunctionTok{seq}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\FunctionTok{barplot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\AttributeTok{col =}\NormalTok{ gray\_colors, }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/gray-palettes-1} 

}

\caption{灰度调色板}\label{fig:gray-palettes}
\end{figure}

gray 与 grey 是一样的，类似 color 和 colour 的关系，可能是美式和英式英语的差别，且看

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{all.equal}\NormalTok{(}
  \FunctionTok{col2rgb}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"gray"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{))),}
  \FunctionTok{col2rgb}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grey"}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{)))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

\texttt{gray100} 代表白色，\texttt{gray0} 代表黑色，提取灰色调色板，去掉首尾部分是必要的

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{8}\NormalTok{, }\AttributeTok{start =}\NormalTok{ .}\DecValTok{3}\NormalTok{, }\AttributeTok{end =}\NormalTok{ .}\DecValTok{9}\NormalTok{),}
  \AttributeTok{main =} \StringTok{"gray.colors function"}\NormalTok{, }\AttributeTok{border =} \ConstantTok{NA}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/gray-colors-1} 

}

\caption{提取 10 种灰色做调色板}\label{fig:gray-colors}
\end{figure}

首先选择一组合适的颜色，比如从桃色到梨色，选择6种颜色，以此为基础，可以借助 \texttt{grDevices::colorRampPalette()} 函数扩充至想要的数目，用 \texttt{graphics::rect()} 函数预览这组颜色配制的调色板

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Colors from https://github.com/johannesbjork/LaCroixColoR}
\NormalTok{colors\_vec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\#FF3200"}\NormalTok{, }\StringTok{"\#E9A17C"}\NormalTok{, }\StringTok{"\#E9E4A6"}\NormalTok{, }
                \StringTok{"\#1BB6AF"}\NormalTok{, }\StringTok{"\#0076BB"}\NormalTok{, }\StringTok{"\#172869"}\NormalTok{)}
\CommentTok{\# 代码来自 ?colorspace::rainbow\_hcl}
\NormalTok{pal }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \DecValTok{20}\NormalTok{, }\AttributeTok{colors =}\NormalTok{ colors, }\AttributeTok{border =} \StringTok{"light gray"}\NormalTok{, ...) \{}
\NormalTok{  colorname }\OtherTok{\textless{}{-}}\NormalTok{ (grDevices}\SpecialCharTok{::}\FunctionTok{colorRampPalette}\NormalTok{(colors))(n)}
  \FunctionTok{plot}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
    \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{),}
    \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, ...}
\NormalTok{  )}
  \FunctionTok{rect}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\NormalTok{(n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ n, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n }\SpecialCharTok{/}\NormalTok{ n, }\DecValTok{1}\NormalTok{, }\AttributeTok{col =}\NormalTok{ colorname, }\AttributeTok{border =}\NormalTok{ border)}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{20}\NormalTok{, }\AttributeTok{colors =}\NormalTok{ colors\_vec, }\AttributeTok{xlab =} \StringTok{"Colors from Peach to Pear"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/peach-pear-palette-1} 

}

\caption{桃色至梨色的渐变}\label{fig:peach-pear-palette}
\end{figure}

\texttt{colorRampPalette()} 自制调色板

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{create\_palette }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"orangeRed"}\NormalTok{)) \{}
\NormalTok{  color\_palette }\OtherTok{\textless{}{-}} \FunctionTok{colorRampPalette}\NormalTok{(colors)(n)}
  \FunctionTok{barplot}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{times =}\NormalTok{ n), }\AttributeTok{col =}\NormalTok{ color\_palette, }
          \AttributeTok{border =}\NormalTok{ color\_palette, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\AttributeTok{xaxs =} \StringTok{"i"}\NormalTok{, }\AttributeTok{yaxs =} \StringTok{"i"}\NormalTok{)}
\FunctionTok{create\_palette}\NormalTok{(}\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"orangeRed"}\NormalTok{))}
\FunctionTok{create\_palette}\NormalTok{(}\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"darkgreen"}\NormalTok{, }\StringTok{"yellow"}\NormalTok{, }\StringTok{"orangered"}\NormalTok{))}
\FunctionTok{create\_palette}\NormalTok{(}\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"white"}\NormalTok{, }\StringTok{"orangered"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/custom-palettes-1} 

}

\caption{colorRampPalette 自制调色板}\label{fig:custom-palettes}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{RColorBrewer}\SpecialCharTok{::}\FunctionTok{display.brewer.all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/rcolorbrewer-palette-1} 

}

\caption{RColorBrewer 调色板}\label{fig:rcolorbrewer-palette}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 代码来自 ?palettes}
\NormalTok{demo.pal }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, }\AttributeTok{border =} \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{\textless{}} \DecValTok{32}\NormalTok{) }\StringTok{"light gray"} \ControlFlowTok{else} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"color palettes: alpha = 1,  n="}\NormalTok{, n),}
           \AttributeTok{ch.col =} \FunctionTok{c}\NormalTok{(}
             \StringTok{"rainbow(n, start=.7, end=.1)"}\NormalTok{, }\StringTok{"heat.colors(n)"}\NormalTok{,}
             \StringTok{"terrain.colors(n)"}\NormalTok{, }\StringTok{"topo.colors(n)"}\NormalTok{,}
             \StringTok{"cm.colors(n)"}\NormalTok{, }\StringTok{"gray.colors(n, start = 0.3, end = 0.9)"}
\NormalTok{           )) \{}
\NormalTok{    nt }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(ch.col)}
\NormalTok{    i }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n}
\NormalTok{    j }\OtherTok{\textless{}{-}}\NormalTok{ n }\SpecialCharTok{/}\NormalTok{ nt}
\NormalTok{    d }\OtherTok{\textless{}{-}}\NormalTok{ j }\SpecialCharTok{/} \DecValTok{6}
\NormalTok{    dy }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ d}
    \FunctionTok{plot}\NormalTok{(i, i }\SpecialCharTok{+}\NormalTok{ d, }\AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =}\NormalTok{ main)}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{nt) \{}
      \FunctionTok{rect}\NormalTok{(i }\SpecialCharTok{{-}}\NormalTok{ .}\DecValTok{5}\NormalTok{, (k }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ j }\SpecialCharTok{+}\NormalTok{ dy, i }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{4}\NormalTok{, k }\SpecialCharTok{*}\NormalTok{ j,}
        \AttributeTok{col =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ ch.col[k])), }\AttributeTok{border =}\NormalTok{ border}
\NormalTok{      )}
      \FunctionTok{text}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ j, k }\SpecialCharTok{*}\NormalTok{ j }\SpecialCharTok{+}\NormalTok{ dy }\SpecialCharTok{/} \DecValTok{4}\NormalTok{, ch.col[k])}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{n }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (.Device }\SpecialCharTok{==} \StringTok{"postscript"}\NormalTok{) }\DecValTok{64} \ControlFlowTok{else} \DecValTok{16}
\CommentTok{\# Since for screen, larger n may give color allocation problem}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\FunctionTok{demo.pal}\NormalTok{(n)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/builtin-palettes-1} 

}

\caption{grDevices 调色板 }\label{fig:builtin-palettes}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{33}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, .}\DecValTok{8}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\DecValTok{32}\NormalTok{)) \{}
  \FunctionTok{pal}\NormalTok{(}
    \AttributeTok{n =} \FunctionTok{length}\NormalTok{((}\DecValTok{1} \SpecialCharTok{+} \DecValTok{20} \SpecialCharTok{*}\NormalTok{ (i }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{))}\SpecialCharTok{:}\NormalTok{(}\DecValTok{20} \SpecialCharTok{*}\NormalTok{ i)),}
    \FunctionTok{colors}\NormalTok{()[(}\DecValTok{1} \SpecialCharTok{+} \DecValTok{20} \SpecialCharTok{*}\NormalTok{ (i }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{))}\SpecialCharTok{:}\NormalTok{(}\DecValTok{20} \SpecialCharTok{*}\NormalTok{ i)],}
    \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+} \DecValTok{20} \SpecialCharTok{*}\NormalTok{ (i }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{), }\StringTok{"to"}\NormalTok{, }\DecValTok{20} \SpecialCharTok{*}\NormalTok{ i)}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{17}\NormalTok{, }\FunctionTok{colors}\NormalTok{()[}\DecValTok{641}\SpecialCharTok{:}\DecValTok{657}\NormalTok{], }\AttributeTok{main =} \StringTok{"641 to 657"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=1\linewidth]{data-visualization_files/figure-latex/demo-colors-1} 

}

\caption{grDevices 调色板}\label{fig:demo-colors}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(colorspace)}
\DocumentationTok{\#\# a few useful diverging HCL palettes}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{2}\NormalTok{))}

\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"diverging HCL palettes"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{246}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{c =} \DecValTok{96}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{65}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{130}\NormalTok{, }\DecValTok{43}\NormalTok{), }\AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{180}\NormalTok{, }\DecValTok{70}\NormalTok{), }\AttributeTok{c =} \DecValTok{70}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{95}\NormalTok{)))}

\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{180}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{c =} \DecValTok{59}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{95}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{128}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{c =} \DecValTok{98}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{65}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{255}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{90}\NormalTok{), }\AttributeTok{power =} \DecValTok{1}\NormalTok{))}

\DocumentationTok{\#\# sequential palettes}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{sequential\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main=} \StringTok{"sequential palettes"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{heat\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{), }
                     \AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{c =} \FunctionTok{c}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{80}\NormalTok{), }\AttributeTok{power =} \DecValTok{1}\NormalTok{))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{terrain\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \FunctionTok{c}\NormalTok{(}\DecValTok{65}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{45}\NormalTok{, }\DecValTok{95}\NormalTok{), }\AttributeTok{power =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{3}\NormalTok{, }\FloatTok{1.5}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{heat\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \FunctionTok{c}\NormalTok{(}\DecValTok{80}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{), }\AttributeTok{power =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, }\FloatTok{1.5}\NormalTok{)))}

\DocumentationTok{\#\# compare base and colorspace palettes}
\DocumentationTok{\#\# (in color and desaturated)}
\DocumentationTok{\#\# diverging red{-}blue colors}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hsv}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"diverging red{-}blue colors"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{90}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{diverge\_hsv}\NormalTok{(}\DecValTok{16}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{90}\NormalTok{))))}

\DocumentationTok{\#\# diverging cyan{-}magenta colors}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{cm.colors}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"diverging cyan{-}magenta colors"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{180}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{c =} \DecValTok{59}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{95}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{cm.colors}\NormalTok{(}\DecValTok{16}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{180}\NormalTok{, }\DecValTok{330}\NormalTok{), }\AttributeTok{c =} \DecValTok{59}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{95}\NormalTok{))))}

\DocumentationTok{\#\# heat colors}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{heat.colors}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"heat colors"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{heat\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{heat.colors}\NormalTok{(}\DecValTok{16}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{heat\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{)))}

\DocumentationTok{\#\# terrain colors}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{16}\NormalTok{), }\AttributeTok{main =} \StringTok{"terrain colors"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{terrain\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{16}\NormalTok{)))}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{desaturate}\NormalTok{(}\FunctionTok{terrain\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{)))}

\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{rainbow\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{start =} \DecValTok{30}\NormalTok{, }\AttributeTok{end =} \DecValTok{300}\NormalTok{), }\AttributeTok{main =} \StringTok{"dynamic"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{rainbow\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{start =} \DecValTok{60}\NormalTok{, }\AttributeTok{end =} \DecValTok{240}\NormalTok{), }\AttributeTok{main =} \StringTok{"harmonic"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{rainbow\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{start =} \DecValTok{270}\NormalTok{, }\AttributeTok{end =} \DecValTok{150}\NormalTok{), }\AttributeTok{main =} \StringTok{"cold"}\NormalTok{)}
\FunctionTok{pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{16}\NormalTok{, }\FunctionTok{rainbow\_hcl}\NormalTok{(}\DecValTok{16}\NormalTok{, }\AttributeTok{start =} \DecValTok{90}\NormalTok{, }\AttributeTok{end =} \SpecialCharTok{{-}}\DecValTok{30}\NormalTok{), }\AttributeTok{main =} \StringTok{"warm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/colorspace-palette-1} 

}

\caption{colorspace 调色板}\label{fig:colorspace-palette}
\end{figure}

除之前提到的 \textbf{grDevices} 包， \href{https://colorspace.r-forge.r-project.org/}{\textbf{colorspace}} (\url{https://hclwizard.org/}) 包 \citep{colorspace_2009_rainbow, colorspace_2009_rgb, colorspace_2019}，\href{https://CRAN.R-project.org/package=RColorBrewer}{RColorBrewer} 包 \citep{RColorBrewer} \url{https://colorbrewer2.org/}，\href{https://github.com/sjmgarnier/viridis}{viridis} 包、\href{https://github.com/SymbolixAU/colourvalues}{colourvalues}、\href{https://github.com/karthik/wesanderson}{wesanderson}、\href{https://CRAN.R-project.org/package=dichromat}{dichromat} 包、\href{https://github.com/kwstat/pals}{pals} 包，\href{https://github.com/AustralianAntarcticDivision/palr}{palr} 包，\href{https://cran.r-project.org/package=colorRamps}{colorRamps} 包、\href{https://cran.r-project.org/package=ColorPalette}{ColorPalette} 包、\href{https://cran.r-project.org/package=colortools}{colortools} 包就不一一详细介绍了。

\href{https://github.com/bhaskarvk/colormap}{colormap} 包基于 node.js 的 colormap 模块提供 44 个预定义的调色板 \href{https://github.com/EmilHvitfeldt/paletteer}{paletteer} 包收集了很多 R 包提供的调色板，同时也引入了很多依赖。根据电影 Harry Potter 制作的调色板 \href{https://github.com/aljrico/harrypotter}{harrypotter}，根据网站 \href{https://carto.com/}{CARTO} 设计的 \href{https://github.com/Nowosad/rcartocolor}{rcartocolor} 包，\href{https://github.com/clauswilke/colorblindr}{colorblindr} 模拟色盲环境下的配色方案。

\href{https://github.com/ndphillips/yarrr}{yarrr} 包主要是为书籍 \href{https://bookdown.org/ndphillips/YaRrr/}{《YaRrr! The Pirate's Guide to R》} \url{https://github.com/ndphillips/ThePiratesGuideToR} 提供配套资源，兼顾收集了一组\href{https://bookdown.org/ndphillips/YaRrr/more-colors.html}{调色板}。

\begin{rmdnote}{注意}

RColorBrewer 调色板数量必须至少 3 个，这是上游 colorbrewer 的 \href{https://github.com/axismaps/colorbrewer/issues/23}{问题}，具体体现在调用 \texttt{RColorBrewer::brewer.pal(n\ =\ 2,\ name\ =\ "Set2")} 时会有警告。 plotly 调用

\begin{verbatim}
[1] "#66C2A5" "#FC8D62" "#8DA0CB"
Warning message:
In RColorBrewer::brewer.pal(n = 2, name = "Set2") :
  minimal value for n is 3, returning requested palette with 3 different levels
\end{verbatim}

\end{rmdnote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{8}\NormalTok{), }\DecValTok{8}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =} \FunctionTok{palette}\NormalTok{(), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =} \FunctionTok{heat.colors}\NormalTok{(}\DecValTok{8}\NormalTok{), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{8}\NormalTok{), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =}\NormalTok{ colorspace}\SpecialCharTok{::}\FunctionTok{sequential\_hcl}\NormalTok{(}\DecValTok{8}\NormalTok{), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(x, }\AttributeTok{col =}\NormalTok{ colorspace}\SpecialCharTok{::}\FunctionTok{diverge\_hcl}\NormalTok{(}\DecValTok{8}\NormalTok{,}
  \AttributeTok{h =} \FunctionTok{c}\NormalTok{(}\DecValTok{130}\NormalTok{, }\DecValTok{43}\NormalTok{),}
  \AttributeTok{c =} \DecValTok{100}\NormalTok{, }\AttributeTok{l =} \FunctionTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{90}\NormalTok{)}
\NormalTok{), }\AttributeTok{border =} \StringTok{"white"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/select-color-1} 

}

\caption{源起}\label{fig:select-color}
\end{figure}

与图 \ref{fig:geom-tile} 对比，图\ref{fig:palette-spectral} 的层次更加丰富，识别性更高

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{months =}\NormalTok{ month.abb, }\AttributeTok{years =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{num =} \FunctionTok{as.vector}\NormalTok{(AirPassengers)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ years, }\AttributeTok{y =}\NormalTok{ months, }\AttributeTok{fill =}\NormalTok{ num)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_distiller}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1949}\NormalTok{, }\DecValTok{1960}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{),}
    \AttributeTok{labels =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}
    \AttributeTok{base\_size =} \FloatTok{10.54}\NormalTok{,}
    \AttributeTok{base\_family =} \StringTok{"Noto Serif SC"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"年"}\NormalTok{, }\AttributeTok{y =} \StringTok{"月"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"人数"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/palette-spectral-1} 

}

\caption{Spectral 调色板}\label{fig:palette-spectral}
\end{figure}

再举例子，图 \ref{fig:faithfuld} 是正负例对比，其中好在哪里呢？这张图要表达美国黄石国家公园的老忠实泉间歇喷发的时间规律，那么好的标准就是层次分明，以突出不同颜色之间的时间差异。这个差异，还要看起来不那么费眼睛，一目了然最好。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{erupt }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(faithfuld, }\FunctionTok{aes}\NormalTok{(waiting, eruptions, }\AttributeTok{fill =}\NormalTok{ density)) }\SpecialCharTok{+}
  \FunctionTok{geom\_raster}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\ConstantTok{NULL}\NormalTok{, }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\ConstantTok{NULL}\NormalTok{, }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\NormalTok{p1 }\OtherTok{\textless{}{-}}\NormalTok{ erupt }\SpecialCharTok{+} \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{gray.colors}\NormalTok{(}\DecValTok{7}\NormalTok{))}
\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ erupt }\SpecialCharTok{+} \FunctionTok{scale\_fill\_distiller}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{)}
\NormalTok{p3 }\OtherTok{\textless{}{-}}\NormalTok{ erupt }\SpecialCharTok{+} \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{7}\NormalTok{))}
\NormalTok{p4 }\OtherTok{\textless{}{-}}\NormalTok{ erupt }\SpecialCharTok{+} \FunctionTok{scale\_fill\_continuous}\NormalTok{(}\AttributeTok{type =} \StringTok{\textquotesingle{}viridis\textquotesingle{}}\NormalTok{)}
\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2) }\SpecialCharTok{/}\NormalTok{ (p3 }\SpecialCharTok{+}\NormalTok{ p4)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/faithfuld-1} 

}

\caption{美国黄石国家公园的老忠实泉}\label{fig:faithfuld}
\end{figure}

RColorBrewer 包 提供了有序 (Sequential) 、定性 (Qualitative) 和发散 (Diverging) 三类调色板，一般来讲，分别适用于连续或有序分类变量、无序分类变量、两类分层对比变量的绘图。再加上强大的 ggplot2 包内置的对颜色处理的函数，如 \texttt{scale\_alpha\_*} 、 \texttt{scale\_colour\_*} 和 \texttt{scale\_fill\_*} 等，详见：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"scale\_col(ou|o)r\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "scale_color_binned"      "scale_color_brewer"     
##  [3] "scale_color_continuous"  "scale_color_date"       
##  [5] "scale_color_datetime"    "scale_color_discrete"   
##  [7] "scale_color_distiller"   "scale_color_fermenter"  
##  [9] "scale_color_gradient"    "scale_color_gradient2"  
## [11] "scale_color_gradientn"   "scale_color_grey"       
## [13] "scale_color_hue"         "scale_color_identity"   
## [15] "scale_color_manual"      "scale_color_ordinal"    
## [17] "scale_color_steps"       "scale_color_steps2"     
## [19] "scale_color_stepsn"      "scale_color_viridis_b"  
## [21] "scale_color_viridis_c"   "scale_color_viridis_d"  
## [23] "scale_colour_binned"     "scale_colour_brewer"    
## [25] "scale_colour_continuous" "scale_colour_date"      
## [27] "scale_colour_datetime"   "scale_colour_discrete"  
## [29] "scale_colour_distiller"  "scale_colour_fermenter" 
## [31] "scale_colour_gradient"   "scale_colour_gradient2" 
## [33] "scale_colour_gradientn"  "scale_colour_grey"      
## [35] "scale_colour_hue"        "scale_colour_identity"  
## [37] "scale_colour_manual"     "scale_colour_ordinal"   
## [39] "scale_colour_steps"      "scale_colour_steps2"    
## [41] "scale_colour_stepsn"     "scale_colour_viridis_b" 
## [43] "scale_colour_viridis_c"  "scale_colour_viridis_d"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{(}\StringTok{"package:ggplot2"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"scale\_fill\_"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "scale_fill_binned"     "scale_fill_brewer"     "scale_fill_continuous"
##  [4] "scale_fill_date"       "scale_fill_datetime"   "scale_fill_discrete"  
##  [7] "scale_fill_distiller"  "scale_fill_fermenter"  "scale_fill_gradient"  
## [10] "scale_fill_gradient2"  "scale_fill_gradientn"  "scale_fill_grey"      
## [13] "scale_fill_hue"        "scale_fill_identity"   "scale_fill_manual"    
## [16] "scale_fill_ordinal"    "scale_fill_steps"      "scale_fill_steps2"    
## [19] "scale_fill_stepsn"     "scale_fill_viridis_b"  "scale_fill_viridis_c" 
## [22] "scale_fill_viridis_d"
\end{verbatim}

colourlovers 包借助 XML, jsonlite 和 httr 包可以在线获取网站 \href{https://www.colourlovers.com/}{COLOURlovers} 的调色板

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(colourlovers)}
\NormalTok{palette1 }\OtherTok{\textless{}{-}} \FunctionTok{clpalette}\NormalTok{(}\StringTok{\textquotesingle{}113451\textquotesingle{}}\NormalTok{)}
\NormalTok{palette2 }\OtherTok{\textless{}{-}} \FunctionTok{clpalette}\NormalTok{(}\StringTok{\textquotesingle{}92095\textquotesingle{}}\NormalTok{)}
\NormalTok{palette3 }\OtherTok{\textless{}{-}} \FunctionTok{clpalette}\NormalTok{(}\StringTok{\textquotesingle{}629637\textquotesingle{}}\NormalTok{)}
\NormalTok{palette4 }\OtherTok{\textless{}{-}} \FunctionTok{clpalette}\NormalTok{(}\StringTok{\textquotesingle{}694737\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

使用调色板

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{layout}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{))}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}

\FunctionTok{barplot}\NormalTok{(VADeaths, }\AttributeTok{col =} \FunctionTok{swatch}\NormalTok{(palette1)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(VADeaths, }\AttributeTok{col =} \FunctionTok{swatch}\NormalTok{(palette2)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(VADeaths, }\AttributeTok{col =} \FunctionTok{swatch}\NormalTok{(palette3)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\FunctionTok{barplot}\NormalTok{(VADeaths, }\AttributeTok{col =} \FunctionTok{swatch}\NormalTok{(palette4)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调色板的描述信息

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{palette1}
\end{Highlighting}
\end{Shaded}

获取调色板中的颜色向量

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{swatch}\NormalTok{(palette1)[[}\DecValTok{1}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-color-schames}{%
\subsection{颜色模式}\label{subsec-color-schames}}

不同的颜色模式，从 RGB 到 HCL 的基本操作 \url{https://stat545.com/block018_colors.html}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://github.com/hadley/ggplot2{-}book}
\NormalTok{hcl }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length =} \DecValTok{100}\NormalTok{), }\AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length =} \DecValTok{100}\NormalTok{)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{subset}\NormalTok{(}\AttributeTok{subset =}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{r =} \FunctionTok{sqrt}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{h =} \DecValTok{180} \SpecialCharTok{/}\NormalTok{ pi }\SpecialCharTok{*} \FunctionTok{atan2}\NormalTok{(y, x),}
    \AttributeTok{c =} \DecValTok{100} \SpecialCharTok{*}\NormalTok{ r,}
    \AttributeTok{l =} \DecValTok{65}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{colour =} \FunctionTok{hcl}\NormalTok{(h, c, l)}
\NormalTok{  )}

\CommentTok{\# sin(h) = y / (c / 100)}
\CommentTok{\# y = sin(h) * c / 100}

\NormalTok{cols }\OtherTok{\textless{}{-}}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{hue\_pal}\NormalTok{()(}\DecValTok{5}\NormalTok{)}
\NormalTok{selected }\OtherTok{\textless{}{-}}\NormalTok{ colorspace}\SpecialCharTok{::}\FunctionTok{RGB}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{col2rgb}\NormalTok{(cols)) }\SpecialCharTok{/} \DecValTok{255}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as}\NormalTok{(}\StringTok{"polarLUV"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  colorspace}\SpecialCharTok{::}\FunctionTok{coords}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as.data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{x =} \FunctionTok{cos}\NormalTok{(H }\SpecialCharTok{/} \DecValTok{180} \SpecialCharTok{*}\NormalTok{ pi) }\SpecialCharTok{*}\NormalTok{ C }\SpecialCharTok{/} \DecValTok{100}\NormalTok{,}
    \AttributeTok{y =} \FunctionTok{sin}\NormalTok{(H }\SpecialCharTok{/} \DecValTok{180} \SpecialCharTok{*}\NormalTok{ pi) }\SpecialCharTok{*}\NormalTok{ C }\SpecialCharTok{/} \DecValTok{100}\NormalTok{,}
    \AttributeTok{colour =}\NormalTok{ cols}
\NormalTok{  )}

\FunctionTok{ggplot}\NormalTok{(hcl, }\FunctionTok{aes}\NormalTok{(x, y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_raster}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ colour)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_identity}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_colour\_identity}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_equal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{breaks =} \ConstantTok{NULL}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{breaks =} \ConstantTok{NULL}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data =}\NormalTok{ selected, }\AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data =}\NormalTok{ selected, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{colour =}\NormalTok{ colour))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-27-1} 

}

\caption{HCL调色}\label{fig:unnamed-chunk-27}
\end{figure}

R 内置了 502 种不同颜色的名称，下面随机地选取 20 种颜色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sample}\NormalTok{(}\FunctionTok{colors}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{), }\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "royalblue4"      "plum1"           "papayawhip"      "darkslategray"  
##  [5] "darkturquoise"   "gray79"          "darkred"         "maroon4"        
##  [9] "darkolivegreen4" "springgreen2"    "orchid4"         "lemonchiffon2"  
## [13] "paleturquoise4"  "gray49"          "cyan"            "antiquewhite1"  
## [17] "yellow2"         "gray13"          "cadetblue2"      "gray77"
\end{verbatim}

R 包 grDevices 提供 hcl 调色板\footnote{\url{https://developer.r-project.org/Blog/public/2019/04/01/hcl-based-color-palettes-in-grdevices/index.html}} 调制两个色板

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Colors from https://github.com/johannesbjork/LaCroixColoR}
\NormalTok{color\_pal }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\#FF3200"}\NormalTok{, }\StringTok{"\#E9A17C"}\NormalTok{, }\StringTok{"\#E9E4A6"}\NormalTok{, }\StringTok{"\#1BB6AF"}\NormalTok{, }\StringTok{"\#0076BB"}\NormalTok{, }\StringTok{"\#172869"}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{16}
\NormalTok{more\_colors }\OtherTok{\textless{}{-}}\NormalTok{ (grDevices}\SpecialCharTok{::}\FunctionTok{colorRampPalette}\NormalTok{(color\_pal))(n)}
\NormalTok{scales}\SpecialCharTok{::}\FunctionTok{show\_col}\NormalTok{(}\AttributeTok{colours =}\NormalTok{ more\_colors)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/color-pal-1} 

}

\caption{桃色至梨色的渐变}\label{fig:color-pal}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# colors in colortools from http://www.gastonsanchez.com/}
\NormalTok{fish\_pal }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"\#69D2E7"}\NormalTok{, }\StringTok{"\#6993E7"}\NormalTok{, }\StringTok{"\#7E69E7"}\NormalTok{, }\StringTok{"\#BD69E7"}\NormalTok{,}
  \StringTok{"\#E769D2"}\NormalTok{, }\StringTok{"\#E76993"}\NormalTok{, }\StringTok{"\#E77E69"}\NormalTok{, }\StringTok{"\#E7BD69"}\NormalTok{,}
  \StringTok{"\#D2E769"}\NormalTok{, }\StringTok{"\#93E769"}\NormalTok{, }\StringTok{"\#69E77E"}\NormalTok{, }\StringTok{"\#69E7BD"}
\NormalTok{)}
\NormalTok{more\_colors }\OtherTok{\textless{}{-}}\NormalTok{ (grDevices}\SpecialCharTok{::}\FunctionTok{colorRampPalette}\NormalTok{(fish\_pal))(n)}
\NormalTok{scales}\SpecialCharTok{::}\FunctionTok{show\_col}\NormalTok{(}\AttributeTok{colours =}\NormalTok{ more\_colors)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/fish-hsv-pal-1} 

}

\caption{Hue-Saturation-Value (HSV) 颜色模型}\label{fig:fish-hsv-pal}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\AttributeTok{red =} \DecValTok{86}\NormalTok{, }\AttributeTok{green =} \DecValTok{180}\NormalTok{, }\AttributeTok{blue =} \DecValTok{233}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# "\#56B4E9"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#56B4E9"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\AttributeTok{red =} \DecValTok{0}\NormalTok{, }\AttributeTok{green =} \DecValTok{158}\NormalTok{, }\AttributeTok{blue =} \DecValTok{115}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# "\#009E73"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#009E73"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\AttributeTok{red =} \DecValTok{240}\NormalTok{, }\AttributeTok{green =} \DecValTok{228}\NormalTok{, }\AttributeTok{blue =} \DecValTok{66}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# "\#F0E442"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#F0E442"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\AttributeTok{red =} \DecValTok{0}\NormalTok{, }\AttributeTok{green =} \DecValTok{114}\NormalTok{, }\AttributeTok{blue =} \DecValTok{178}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# "\#0072B2"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#0072B2"
\end{verbatim}

举例子，直方图配色与不配色

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# library(pander)}
\CommentTok{\# evalsOptions(\textquotesingle{}graph.unify\textquotesingle{}, TRUE)}
\CommentTok{\# panderOptions(\textquotesingle{}graph.colors\textquotesingle{}) 获取调色板}
\CommentTok{\# https://www.fontke.com/tool/rgbschemes/ 在线配色}
\NormalTok{cols }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"\#56B4E9"}\NormalTok{, }\StringTok{"\#009E73"}\NormalTok{, }\StringTok{"\#F0E442"}\NormalTok{, }\StringTok{"\#0072B2"}\NormalTok{,}
  \StringTok{"\#D55E00"}\NormalTok{, }\StringTok{"\#CC79A7"}\NormalTok{, }\StringTok{"\#999999"}\NormalTok{, }\StringTok{"\#E69F00"}
\NormalTok{)}
\FunctionTok{hist}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{hp, }\AttributeTok{col =} \StringTok{"\#56B4E9"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{, }\AttributeTok{grid =} \FunctionTok{grid}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-30-1} 

}

\caption{直方图}\label{fig:unnamed-chunk-30}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mtcars) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ hp, }\AttributeTok{fill =} \FunctionTok{as.factor}\NormalTok{(..count..)),}
    \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{bins =} \DecValTok{6}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{rep}\NormalTok{(}\StringTok{"\#56B4E9"}\NormalTok{, }\DecValTok{10}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Histogram with ggplot2"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-31-1} 

}

\caption{直方图}\label{fig:unnamed-chunk-31}
\end{figure}

\hypertarget{rgb}{%
\subsubsection{RGB}\label{rgb}}

红(red)、绿(green)、蓝(blue)是三原色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(red, green, blue, alpha, }\AttributeTok{names =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

函数参数说明：

\begin{itemize}
\tightlist
\item
  \texttt{red,\ blue,\ green,\ alpha} 取值范围\([0,M]\)，\(M\) 是 \emph{maxColorValue}
\item
  \texttt{names} 字符向量，给这组颜色值取名
\item
  \texttt{maxColorValue} 红，绿，蓝三色范围的最大值
\end{itemize}

The colour specification refers to the standard sRGB colorspace (IEC standard 61966).

rgb 产生一种颜色，如 \texttt{rgb(255,\ 0,\ 0,\ maxColorValue\ =\ 255)} 的颜色是 \texttt{"\#FF0000"} ，这是一串16进制数，每两个一组，那么一组有 \(16^2 = 256\) 种组合，整个一串有 \(256^3 = 16777216\) 种组合，这就是RGB表达的所有颜色。

\hypertarget{hsl}{%
\subsubsection{HSL}\label{hsl}}

色相饱和度亮度 hue--saturation--luminance (HSL)

\hypertarget{hsv}{%
\subsubsection{HSV}\label{hsv}}

Create a vector of colors from vectors specifying hue, saturation and value. 色相饱和度值

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hsv}\NormalTok{(}\AttributeTok{h =} \DecValTok{1}\NormalTok{, }\AttributeTok{s =} \DecValTok{1}\NormalTok{, }\AttributeTok{v =} \DecValTok{1}\NormalTok{, alpha)}
\end{Highlighting}
\end{Shaded}

This function creates a vector of colors corresponding to the given values in HSV space. rgb and rgb2hsv for RGB to HSV conversion;

hsv函数通过设置色调、饱和度和亮度获得颜色，三个值都是0-1的相对量

RGB HSV HSL 都是不连续的颜色空间，缺点

\hypertarget{hcl}{%
\subsubsection{HCL}\label{hcl}}

基于感知的颜色空间替代RGB颜色空间

通过指定色相(hue)，色度(chroma)和亮度(luminance/lightness)，创建一组（种）颜色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hcl}\NormalTok{(}\AttributeTok{h =} \DecValTok{0}\NormalTok{, }\AttributeTok{c =} \DecValTok{35}\NormalTok{, }\AttributeTok{l =} \DecValTok{85}\NormalTok{, alpha, }\AttributeTok{fixup =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

函数参数说明：

\begin{itemize}
\item
  \textbf{h} 颜色的色调，取值范围为{[}0,360{]}，0、120、240分别对应红色、绿色、蓝色
\item
  \textbf{c} 颜色的色度，其上界取决于色调和亮度
\item
  \textbf{l} 颜色的亮度，取值范围{[}0,100{]}，给定色调和色度，只有一部分子集可用
\item
  \textbf{alpha} 透明度，取值范围{[}0,1{]}，0 和1分别表示透明和不透明
\end{itemize}

This function corresponds to polar coordinates in the CIE-LUV color space

选色为什么这么难

色相与阴影相比是无关紧要的，色相对于标记和分类很有用，但表示（精细的）空间数据或形状的效果较差。颜色是改善图形的好工具，但糟糕的配色方案 (color schemes) 可能会导致比灰度调色板更差的效果。\citep{colorspace_2009_rainbow}

黑、白、灰，看似有三种颜色，其实只有一种颜色，黑和白只是灰色的两极，那么如何设置灰色梯度，使得人眼比较好区分它们呢？这样获得的调色板适用于什么样的绘图环境呢？

\hypertarget{cmyk}{%
\subsubsection{CMYK}\label{cmyk}}

印刷三原色：青 (cyan)、品红 (magenta)、黄 (yellow)

\begin{itemize}
\tightlist
\item
  颜色模式转化
\end{itemize}

\texttt{col2rgb()} 、\texttt{rgb2hsv()} 和 \texttt{rgb()} 函数 \texttt{hex2RGB()} 函数 colorspace \texttt{col2hcl()} 函数 scales \texttt{col2HSV()} colortools \texttt{col2hex()}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{col2rgb}\NormalTok{(}\StringTok{"lightblue"}\NormalTok{) }\CommentTok{\# color to  RGB}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       [,1]
## red    173
## green  216
## blue   230
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{scales}\SpecialCharTok{::}\FunctionTok{col2hcl}\NormalTok{(}\StringTok{"lightblue"}\NormalTok{) }\CommentTok{\# color to HCL}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#ADD8E6"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# palr::col2hex("lightblue") \# color to HEX}
\CommentTok{\# colortools::col2HSV("lightblue") \# color to HSV}

\FunctionTok{rgb}\NormalTok{(}\DecValTok{173}\NormalTok{, }\DecValTok{216}\NormalTok{, }\DecValTok{230}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# RGB to HEX}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#ADD8E6"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{colorspace}\SpecialCharTok{::}\FunctionTok{hex2RGB}\NormalTok{(}\StringTok{"\#ADD8E6"}\NormalTok{) }\CommentTok{\# HEX to RGB}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              R         G         B
## [1,] 0.6784314 0.8470588 0.9019608
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(.}\DecValTok{678}\NormalTok{, .}\DecValTok{847}\NormalTok{, .}\DecValTok{902}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{1}\NormalTok{) }\CommentTok{\# RGB to HEX}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#ADD8E6"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb2hsv}\NormalTok{(}\DecValTok{173}\NormalTok{, }\DecValTok{216}\NormalTok{, }\DecValTok{230}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{) }\CommentTok{\# RGB to HSV}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        [,1]
## h 0.5409357
## s 0.2478261
## v 0.9019608
\end{verbatim}

\hypertarget{subsec-latex-colors}{%
\subsection{LaTeX 配色}\label{subsec-latex-colors}}

LaTeX 宏包 \href{https://www.ctan.org/pkg/xcolor}{xcolor} 中定义颜色的常用方式有两种，其一，\texttt{\textbackslash{}textcolor\{green!40!yellow\}} 表示 40\% 的绿色和 60\% 的黄色混合色彩，其二，\texttt{\textbackslash{}textcolor{[}HTML{]}\{34A853\}} HEX 表示的色彩直接在 LaTeX 文档中使用的方式，类似地 \texttt{\textbackslash{}textcolor{[}RGB{]}\{52,168,83\}} 也表示 Google 图标中的绿色。

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{\textbackslash{}documentclass}\NormalTok{[tikz,border=10pt]\{}\ExtensionTok{standalone}\NormalTok{\}}
\KeywordTok{\textbackslash{}begin}\NormalTok{\{}\ExtensionTok{document}\NormalTok{\}}
\KeywordTok{\textbackslash{}begin}\NormalTok{\{}\ExtensionTok{tikzpicture}\NormalTok{\}}
\FunctionTok{\textbackslash{}draw}\NormalTok{ (0,0) rectangle (2,1) node [midway] \{}\FunctionTok{\textbackslash{}textcolor}\NormalTok{[RGB]\{52,168,83\}\{Hello\} }\FunctionTok{\textbackslash{}textcolor}\NormalTok{[HTML]\{34A853\}\{}\FunctionTok{\textbackslash{}TeX}\NormalTok{\}\};}
\KeywordTok{\textbackslash{}end}\NormalTok{\{}\ExtensionTok{tikzpicture}\NormalTok{\}}
\KeywordTok{\textbackslash{}end}\NormalTok{\{}\ExtensionTok{document}\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

对应于 R 中的调用方式为：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\DecValTok{52}\NormalTok{, }\DecValTok{168}\NormalTok{, }\DecValTok{83}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "#34A853"
\end{verbatim}

\hypertarget{subsec-ggplot2-colors}{%
\subsection{ggplot2 配色}\label{subsec-ggplot2-colors}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group,}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{,}
  \AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}
\NormalTok{)}
\CommentTok{\# 类似 boxplot}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{fill =} \StringTok{"lightgray"}\NormalTok{)}

\CommentTok{\# 默认调色板}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}\NormalTok{)}

\CommentTok{\# Google 调色板}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4285f4"}\NormalTok{, }\StringTok{"\#34A853"}\NormalTok{, }\StringTok{"\#FBBC05"}\NormalTok{, }\StringTok{"\#EA4335"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[简单箱线图\label{fig:colorize-boxplot-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/colorize-boxplot-1} }\subfloat[ggplot2 绘制的箱线图\label{fig:colorize-boxplot-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/colorize-boxplot-2} }\newline\subfloat[ggplot2 调用默认调色板\label{fig:colorize-boxplot-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/colorize-boxplot-3} }\subfloat[ggplot2 调用 Google 调色板\label{fig:colorize-boxplot-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/colorize-boxplot-4} }

}

\caption{几种不同的箱线图}\label{fig:colorize-boxplot}
\end{figure}

\hypertarget{sec-gallery}{%
\section{图库}\label{sec-gallery}}

\hypertarget{sec-ggplot2-pie}{%
\subsection{饼图}\label{sec-ggplot2-pie}}

我对饼图是又爱又恨，爱的是它表示百分比的时候，往往让读者联想到蛋糕，份额这类根深蒂固的情景，从而让数字通俗易懂、深入人心，是一种很好的表达方式，恨的也是这一点，我用柱状图表达不香吗？人眼对角度的区分度远不如柱状图呢，特别是当两个类所占的份额比较接近的时候，所以很多时候，除了用饼图表达份额，还会在旁边标上百分比，从数据可视化的角度来说，如图 \ref{fig:bod-pie} 所示，这是信息冗余！

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{BOD }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{transform}\NormalTok{(., }\AttributeTok{ratio =}\NormalTok{ demand }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(demand)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(., }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =}\NormalTok{ demand, }\AttributeTok{fill =} \FunctionTok{reorder}\NormalTok{(Time, demand))) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{(}\AttributeTok{theta =} \StringTok{"y"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FloatTok{1.6}\NormalTok{, }\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(ratio, }\AttributeTok{digits =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%"}\NormalTok{)),}
    \AttributeTok{position =} \FunctionTok{position\_stack}\NormalTok{(}\AttributeTok{vjust =} \FloatTok{0.5}\NormalTok{), }\AttributeTok{color =} \StringTok{"black"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{label =}\NormalTok{ Time),}
    \AttributeTok{position =} \FunctionTok{position\_stack}\NormalTok{(}\AttributeTok{vjust =} \FloatTok{0.5}\NormalTok{), }\AttributeTok{color =} \StringTok{"black"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_void}\NormalTok{(}\AttributeTok{base\_size =} \DecValTok{14}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/bod-pie-1} 

}

\caption{饼图}\label{fig:bod-pie}
\end{figure}

\texttt{plot\_ly(type\ =\ "pie",\ ...\ )} 和添加图层 \texttt{add\_pie()} 的效果是一样的

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{=} \FunctionTok{aggregate}\NormalTok{(carat }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut, }\AttributeTok{data =}\NormalTok{ diamonds, }\AttributeTok{FUN =}\NormalTok{ length)}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_pie}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{labels =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{carat,}
    \AttributeTok{name =} \StringTok{"简单饼图1"}\NormalTok{, }\AttributeTok{domain =} \FunctionTok{list}\NormalTok{(}\AttributeTok{row =} \DecValTok{0}\NormalTok{, }\AttributeTok{column =} \DecValTok{0}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_pie}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{labels =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{carat, }\AttributeTok{hole =} \FloatTok{0.6}\NormalTok{,}
    \AttributeTok{textposition =} \StringTok{"inside"}\NormalTok{, }\AttributeTok{textinfo =} \StringTok{"label+percent"}\NormalTok{,}
    \AttributeTok{name =} \StringTok{"简单饼图2"}\NormalTok{, }\AttributeTok{domain =} \FunctionTok{list}\NormalTok{(}\AttributeTok{row =} \DecValTok{0}\NormalTok{, }\AttributeTok{column =} \DecValTok{1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"多图布局"}\NormalTok{, }\AttributeTok{showlegend =}\NormalTok{ F,}
    \AttributeTok{grid =} \FunctionTok{list}\NormalTok{(}\AttributeTok{rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{columns =} \DecValTok{2}\NormalTok{),}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{zeroline =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{showticklabels =} \ConstantTok{FALSE}\NormalTok{),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{zeroline =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{showticklabels =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

设置参数 hole 可以绘制环形饼图，比如 hole = 0.6

\hypertarget{sec-ggplot2-map}{%
\subsection{地图}\label{sec-ggplot2-map}}

USArrests 数据集描述了1973年美国50个州每10万居民中因袭击、抢劫和强奸而逮捕的人，以及城市人口占比。这里的地图是指按照行政区划为边界的示意图，比如图 \ref{fig:state-crimes}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(maps)}
\NormalTok{crimes }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{state =} \FunctionTok{tolower}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(USArrests)), USArrests)}
\CommentTok{\# 等价于 crimes \%\textgreater{}\% tidyr::pivot\_longer(Murder:Rape)}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(crimes)[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{], }\ControlFlowTok{function}\NormalTok{(j) \{}
  \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{state =}\NormalTok{ crimes}\SpecialCharTok{$}\NormalTok{state, }\AttributeTok{variable =}\NormalTok{ j, }\AttributeTok{value =}\NormalTok{ crimes[[j]])}
\NormalTok{\})}
\NormalTok{crimes\_long }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, vars)}
\NormalTok{states\_map }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"state"}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(crimes, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{map\_id =}\NormalTok{ state)) }\SpecialCharTok{+}
  \FunctionTok{geom\_map}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ Murder), }\AttributeTok{map =}\NormalTok{ states\_map) }\SpecialCharTok{+}
  \FunctionTok{expand\_limits}\NormalTok{(}\AttributeTok{x =}\NormalTok{ states\_map}\SpecialCharTok{$}\NormalTok{long, }\AttributeTok{y =}\NormalTok{ states\_map}\SpecialCharTok{$}\NormalTok{lat) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_binned}\NormalTok{(}\AttributeTok{type =} \StringTok{"viridis"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/state-crimes-1} 

}

\caption{1975年美国各州犯罪事件}\label{fig:state-crimes}
\end{figure}

先来看看中国及其周边，见图\ref{fig:incorrect-map}，这个地图的缺陷就是中国南海及九段线没有标记，台湾和中国大陆不是一种颜色标记，这里的地图数据来自 R 包 \textbf{maps} 和 \textbf{mapdata}，像这样的地图就不宜在国内正式刊物上出现。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(maps)}
\FunctionTok{library}\NormalTok{(mapdata)}
\NormalTok{east\_asia }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"worldHires"}\NormalTok{,}
  \AttributeTok{region =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Japan"}\NormalTok{, }\StringTok{"Taiwan"}\NormalTok{, }\StringTok{"China"}\NormalTok{,}
    \StringTok{"North Korea"}\NormalTok{, }\StringTok{"South Korea"}
\NormalTok{  )}
\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(east\_asia, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ long, }\AttributeTok{y =}\NormalTok{ lat, }\AttributeTok{group =}\NormalTok{ group, }\AttributeTok{fill =}\NormalTok{ region)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Set2"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/incorrect-map-1} 

}

\caption{中国及其周边}\label{fig:incorrect-map}
\end{figure}

绘制真正的地图需要考虑投影坐标系，观察角度、分辨率、政策法规等一系列因素，它是一种复杂的图形，如图 \ref{fig:draw-map} 所示。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{worldmap }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"world"}\NormalTok{)}

\CommentTok{\# 默认 mercator 投影下的默认视角 c(90, 0, mean(range(x)))}
\FunctionTok{ggplot}\NormalTok{(worldmap, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ region), }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{120}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{)}
\NormalTok{  )}

\CommentTok{\# 换观察角度}
\FunctionTok{ggplot}\NormalTok{(worldmap, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ region), }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{120}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{),}
    \AttributeTok{orientation =} \FunctionTok{c}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  )}

\CommentTok{\# 换投影坐标系}
\FunctionTok{ggplot}\NormalTok{(worldmap, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ region), }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}\StringTok{"ortho"}\NormalTok{,}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{120}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{)}
\NormalTok{  )}

\CommentTok{\# 二者皆换}
\FunctionTok{ggplot}\NormalTok{(worldmap, }\FunctionTok{aes}\NormalTok{(long, lat, }\AttributeTok{group =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_polygon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ region), }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_map}\NormalTok{(}\StringTok{"ortho"}\NormalTok{,}
    \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{120}\NormalTok{, }\DecValTok{40}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{90}\NormalTok{),}
    \AttributeTok{orientation =} \FunctionTok{c}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[墨卡托投影\label{fig:draw-map-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/draw-map-1} }\subfloat[北极观察\label{fig:draw-map-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/draw-map-2} }\newline\subfloat[正交投影\label{fig:draw-map-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/draw-map-3} }\subfloat[正交投影北极观察\label{fig:draw-map-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/draw-map-4} }

}

\caption{画地图的正确姿势}\label{fig:draw-map}
\end{figure}

Google 地图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(RgoogleMaps)}
\CommentTok{\# 一组坐标的中心位置}
\NormalTok{lat }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{40.702147}\NormalTok{, }\FloatTok{40.718217}\NormalTok{, }\FloatTok{40.711614}\NormalTok{)}
\NormalTok{lon }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{74.012318}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{74.015794}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{73.998284}\NormalTok{)}
\NormalTok{center }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{mean}\NormalTok{(lat), }\FunctionTok{mean}\NormalTok{(lon))}
\NormalTok{zoom }\OtherTok{\textless{}{-}} \FunctionTok{min}\NormalTok{(}\FunctionTok{MaxZoom}\NormalTok{(}\FunctionTok{range}\NormalTok{(lat), }\FunctionTok{range}\NormalTok{(lon)))}
\CommentTok{\# 矩形对角线的两个顶点}
\NormalTok{bb }\OtherTok{\textless{}{-}} \FunctionTok{qbbox}\NormalTok{(lat, lon)}
\CommentTok{\# 获取地图数据}
\NormalTok{myMap }\OtherTok{\textless{}{-}} \FunctionTok{GetMap}\NormalTok{(center, }\AttributeTok{size =} \FunctionTok{c}\NormalTok{(}\DecValTok{640}\NormalTok{, }\DecValTok{640}\NormalTok{), }\AttributeTok{zoom =}\NormalTok{ zoom, }\AttributeTok{type =} \StringTok{"osm"}\NormalTok{)}
\CommentTok{\# 在地图上添加红、蓝、绿三个点}
\FunctionTok{PlotOnStaticMap}\NormalTok{(myMap,}
  \AttributeTok{lat =}\NormalTok{ lat, }\AttributeTok{lon =}\NormalTok{ lon, }\AttributeTok{pch =} \DecValTok{20}\NormalTok{, }\AttributeTok{cex =} \DecValTok{10}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"red"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"green"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/google-map-1} 

}

\caption{Google 地图示例}\label{fig:google-map}
\end{figure}

\hypertarget{sec-ggplot2-heatmap}{%
\subsection{热图}\label{sec-ggplot2-heatmap}}

Zuguang Gu 开发的 \href{https://github.com/jokergoo/ComplexHeatmap}{ComplexHeatmap} 包实现复杂数据的可视化，用以发现关联数据集之间的模式。特别地，比如基因数据、生存数据等，更多应用见开发者的书籍 \href{https://jokergoo.github.io/ComplexHeatmap-reference/book/}{ComplexHeatmap 完全手册} 。 R 包发布在 Bioconductor 上 \url{https://www.bioconductor.org/packages/ComplexHeatmap}。使用之前我要确保已经安装 \textbf{BiocManager} 包，这个包负责管理 Bioconductor 上所有的包，需要先安装它，然后安装 \textbf{ComplexHeatmap} 包 \citep{Gu_2016_heatmap}。

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"BiocManager"}\NormalTok{, }\AttributeTok{quietly =} \ConstantTok{TRUE}\NormalTok{))}
    \FunctionTok{install.packages}\NormalTok{(}\StringTok{"BiocManager"}\NormalTok{)}
\NormalTok{BiocManager}\SpecialCharTok{::}\FunctionTok{install}\NormalTok{(}\StringTok{"ComplexHeatmap"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{ggplot2-scatter}{%
\subsection{散点图}\label{ggplot2-scatter}}

下面以 diamonds 数据集为例展示 ggplot2 的绘图过程，首先加载 diamonds 数据集，查看数据集的内容

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(diamonds)}
\FunctionTok{str}\NormalTok{(diamonds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## tibble [53,940 x 10] (S3: tbl_df/tbl/data.frame)
##  $ carat  : num [1:53940] 0.23 0.21 0.23 0.29 0.31 0.24 0.24 0.26 0.22 0.23 ...
##  $ cut    : Ord.factor w/ 5 levels "Fair"<"Good"<..: 5 4 2 4 2 3 3 3 1 3 ...
##  $ color  : Ord.factor w/ 7 levels "D"<"E"<"F"<"G"<..: 2 2 2 6 7 7 6 5 2 5 ...
##  $ clarity: Ord.factor w/ 8 levels "I1"<"SI2"<"SI1"<..: 2 3 5 4 2 6 7 3 4 5 ...
##  $ depth  : num [1:53940] 61.5 59.8 56.9 62.4 63.3 62.8 62.3 61.9 65.1 59.4 ...
##  $ table  : num [1:53940] 55 61 65 58 58 57 57 55 61 61 ...
##  $ price  : int [1:53940] 326 326 327 334 335 336 336 337 337 338 ...
##  $ x      : num [1:53940] 3.95 3.89 4.05 4.2 4.34 3.94 3.95 4.07 3.87 4 ...
##  $ y      : num [1:53940] 3.98 3.84 4.07 4.23 4.35 3.96 3.98 4.11 3.78 4.05 ...
##  $ z      : num [1:53940] 2.43 2.31 2.31 2.63 2.75 2.48 2.47 2.53 2.49 2.39 ...
\end{verbatim}

数值型变量 carat 作为 x 轴

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat))}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price))}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{color =}\NormalTok{ cut))}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat), }\AttributeTok{color =} \StringTok{"steelblue"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[指定 x 轴\label{fig:diamonds-axis-1}]{\includegraphics[width=0.35\linewidth]{data-visualization_files/figure-latex/diamonds-axis-1} }\subfloat[数值变量 price 作为纵轴\label{fig:diamonds-axis-2}]{\includegraphics[width=0.35\linewidth]{data-visualization_files/figure-latex/diamonds-axis-2} }\newline\subfloat[有序分类变量 cut 指定颜色\label{fig:diamonds-axis-3}]{\includegraphics[width=0.35\linewidth]{data-visualization_files/figure-latex/diamonds-axis-3} }\subfloat[指定统一颜色\label{fig:diamonds-axis-4}]{\includegraphics[width=0.35\linewidth]{data-visualization_files/figure-latex/diamonds-axis-4} }

}

\caption{绘图过程}\label{fig:diamonds-axis}
\end{figure}

图 \ref{fig:diamonds-axis} 的基础上添加数据图层

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sub\_diamonds }\OtherTok{\textless{}{-}}\NormalTok{ diamonds[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(diamonds), }\DecValTok{1000}\NormalTok{), ]}
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-1} 

}

\caption{添加数据图层}\label{fig:scatter}
\end{figure}

给散点图\ref{fig:scatter}上色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"steelblue"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-color-1-1} 

}

\caption{散点图配色}\label{fig:scatter-color-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"steelblue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{unit\_format}\NormalTok{(}\AttributeTok{unit =} \StringTok{"k"}\NormalTok{, }\AttributeTok{scale =} \FloatTok{1e{-}3}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{20000}\NormalTok{, }\DecValTok{4000}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-scale-1-1} 

}

\caption{格式化坐标轴刻度标签}\label{fig:scatter-scale-1}
\end{figure}

让另一变量 cut 作为颜色分类指标

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-color-2-1} 

}

\caption{分类散点图}\label{fig:scatter-color-2}
\end{figure}

当然还有一种类似的表示就是分组，默认情况下，ggplot2将所有观测点视为一组，以分类变量 cut 来分组

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-group-1} 

}

\caption{分组}\label{fig:scatter-group}
\end{figure}

在图\ref{fig:scatter-group} 上没有体现出来分组的意思，下面以 cut 分组线性回归为例

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-lm-1} 

}

\caption{分组线性回归}\label{fig:group-lm-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-lm-2} 

}

\caption{分组线性回归}\label{fig:group-lm-2}
\end{figure}

我们当然可以选择更加合适的拟合方式，如局部多项式平滑 \texttt{loess} 但是该方法不太适用观测值比较多的情况，因为它会占用比较多的内存，建议使用广义可加模型作平滑拟合

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"loess"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-37-1} 

}

\caption{局部多项式平滑}\label{fig:unnamed-chunk-37}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"gam"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, }\AttributeTok{bs =} \StringTok{"cs"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-gam-1} 

}

\caption{数据分组应用广义可加平滑}\label{fig:group-gam}
\end{figure}

\href{https://github.com/sinhrks/ggfortify}{ggfortify} 包支持更多的统计分析结果的可视化。

为了更好地区分开组别，我们在图\ref{fig:group-gam}的基础上分面或者配色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"gam"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, }\AttributeTok{bs =} \StringTok{"cs"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-facet-1} 

}

\caption{分组分面}\label{fig:group-facet-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{group =}\NormalTok{ cut, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"gam"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, }\AttributeTok{bs =} \StringTok{"cs"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/group-facet-2} 

}

\caption{分组配色}\label{fig:group-facet-2}
\end{figure}

在分类散点图的另一种表示方法就是分面图，以 cut 变量作为分面的依据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-facet-1} 

}

\caption{分面散点图}\label{fig:scatter-facet}
\end{figure}

给图 \ref{fig:scatter-facet} 上色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"steelblue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-facet-color-1-1} 

}

\caption{给分面散点图上色}\label{fig:scatter-facet-color-1}
\end{figure}

在图\ref{fig:scatter-facet-color-1}的基础上，给不同的类上不同的颜色

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-facet-color-2-1} 

}

\caption{给不同的类上不同的颜色}\label{fig:scatter-facet-color-2}
\end{figure}

去掉图例，此时图例属于冗余信息了

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/scatter-facet-color-3-1} 

}

\caption{去掉图例}\label{fig:scatter-facet-color-3}
\end{figure}

四块土地，所施肥料不同，肥力大小顺序 4 \textless{} 2 \textless{} 3 \textless{} 1 小麦产量随肥力的变化

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(Wheat2, }\AttributeTok{package =} \StringTok{"nlme"}\NormalTok{) }\CommentTok{\# Wheat Yield Trials}
\FunctionTok{library}\NormalTok{(colorspace)}
\FunctionTok{ggplot}\NormalTok{(Wheat2, }\FunctionTok{aes}\NormalTok{(longitude, latitude)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =}\NormalTok{ yield, }\AttributeTok{colour =}\NormalTok{ Block)) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_discrete\_sequential}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Viridis"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{5}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-38-1} 

}

\caption{多个图例}\label{fig:unnamed-chunk-38}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mtcars, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ hp, }\AttributeTok{y =}\NormalTok{ mpg, }\AttributeTok{color =} \FunctionTok{factor}\NormalTok{(am))) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/category-ggplot-1} 

}

\caption{分类散点图}\label{fig:category-ggplot}
\end{figure}

图层、分组、分面和散点图介绍完了，接下来就是其它统计图形，如箱线图，小提琴图和条形图

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1948} \SpecialCharTok{+} \FunctionTok{seq}\NormalTok{(}\DecValTok{12}\NormalTok{), }\AttributeTok{each =} \DecValTok{12}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{12}\NormalTok{), }\DecValTok{12}\NormalTok{), AirPassengers))}
\FunctionTok{colnames}\NormalTok{(dat) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"year"}\NormalTok{, }\StringTok{"month"}\NormalTok{, }\StringTok{"passengers"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{as.factor}\NormalTok{(year), }\AttributeTok{y =} \FunctionTok{as.factor}\NormalTok{(month))) }\SpecialCharTok{+}
  \FunctionTok{stat\_sum}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =}\NormalTok{ passengers), }\AttributeTok{colour =} \StringTok{"lightblue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_size}\NormalTok{(}\AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{650}\NormalTok{, }\DecValTok{50}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Year"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Month"}\NormalTok{, }\AttributeTok{colour =} \StringTok{"Passengers"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-39-1} 

}

\caption{1948年至1960年航班乘客人数变化}\label{fig:unnamed-chunk-39}
\end{figure}

\hypertarget{sec-ggplot2-barplot}{%
\subsection{条形图}\label{sec-ggplot2-barplot}}

条形图特别适合分类变量的展示，我们这里展示钻石切割质量 cut 不同等级的数量，当然我们可以直接展示各类的数目，在图层 \texttt{geom\_bar} 中指定 \texttt{stat="identity"}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 需要映射数据框的两个变量，相当于自己先计算了每类的数量}
\FunctionTok{with}\NormalTok{(diamonds, }\FunctionTok{table}\NormalTok{(cut))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## cut
##      Fair      Good Very Good   Premium     Ideal 
##      1610      4906     12082     13791     21551
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cut\_df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{table}\NormalTok{(diamonds}\SpecialCharTok{$}\NormalTok{cut))}
\FunctionTok{ggplot}\NormalTok{(cut\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Var1, }\AttributeTok{y =}\NormalTok{ Freq)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-40-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-1-1} 

}

\caption{频数条形图}\label{fig:diamonds-barplot-1}
\end{figure}

还有另外三种表示方法

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"count"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-41-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ ..count..)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-41-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =} \FunctionTok{stat}\NormalTok{(count))) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-41-3} \end{center}

我们还可以在图 \ref{fig:diamonds-barplot-1} 的基础上再添加一个分类变量钻石的纯净度 clarity，形成堆积条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-2-1} 

}

\caption{堆积条形图}\label{fig:diamonds-barplot-2}
\end{figure}

再添加一个分类变量钻石颜色 color 比较好的做法是分面

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-3-1} 

}

\caption{分面堆积条形图}\label{fig:diamonds-barplot-3}
\end{figure}

实际上，绘制图\ref{fig:diamonds-barplot-3}包含了对分类变量的分组计数过程，如下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(diamonds, }\FunctionTok{table}\NormalTok{(cut, color))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            color
## cut            D    E    F    G    H    I    J
##   Fair       163  224  312  314  303  175  119
##   Good       662  933  909  871  702  522  307
##   Very Good 1513 2400 2164 2299 1824 1204  678
##   Premium   1603 2337 2331 2924 2360 1428  808
##   Ideal     2834 3903 3826 4884 3115 2093  896
\end{verbatim}

还有一种堆积的方法是按比例，而不是按数量，如图\ref{fig:diamonds-barplot-4}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-4-1} 

}

\caption{比例堆积条形图}\label{fig:diamonds-barplot-4}
\end{figure}

接下来就是复合条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-5-1} 

}

\caption{复合条形图}\label{fig:diamonds-barplot-5}
\end{figure}

再添加一个分类变量，就是需要分面大法了，图 \ref{fig:diamonds-barplot-5} 展示了三个分类变量，其实我们还可以再添加一个分类变量用作分面的列依据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\AttributeTok{rows =} \FunctionTok{vars}\NormalTok{(cut))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/diamonds-barplot-6-1} 

}

\caption{分面复合条形图}\label{fig:diamonds-barplot-6}
\end{figure}

图 \ref{fig:diamonds-barplot-6} 展示的数据如下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{with}\NormalTok{(diamonds, }\FunctionTok{table}\NormalTok{(color, clarity, cut))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , cut = Fair
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D    4   56   58   25    5    9    3    3
##     E    9   78   65   42   14   13    3    0
##     F   35   89   83   53   33   10    5    4
##     G   53   80   69   45   45   17    3    2
##     H   52   91   75   41   32   11    1    0
##     I   34   45   30   32   25    8    1    0
##     J   23   27   28   23   16    1    1    0
## 
## , , cut = Good
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D    8  223  237  104   43   25   13    9
##     E   23  202  355  160   89   52   43    9
##     F   19  201  273  184  132   50   35   15
##     G   19  163  207  192  152   75   41   22
##     H   14  158  235  138   77   45   31    4
##     I    9   81  165  110  103   26   22    6
##     J    4   53   88   90   52   13    1    6
## 
## , , cut = Very Good
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D    5  314  494  309  175  141   52   23
##     E   22  445  626  503  293  298  170   43
##     F   13  343  559  466  293  249  174   67
##     G   16  327  474  479  432  302  190   79
##     H   12  343  547  376  257  145  115   29
##     I    8  200  358  274  205   71   69   19
##     J    8  128  182  184  120   29   19    8
## 
## , , cut = Premium
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D   12  421  556  339  131   94   40   10
##     E   30  519  614  629  292  121  105   27
##     F   34  523  608  619  290  146   80   31
##     G   46  492  566  721  566  275  171   87
##     H   46  521  655  532  336  118  112   40
##     I   24  312  367  315  221   82   84   23
##     J   13  161  209  202  153   34   24   12
## 
## , , cut = Ideal
## 
##      clarity
## color   I1  SI2  SI1  VS2  VS1 VVS2 VVS1   IF
##     D   13  356  738  920  351  284  144   28
##     E   18  469  766 1136  593  507  335   79
##     F   42  453  608  879  616  520  440  268
##     G   16  486  660  910  953  774  594  491
##     H   38  450  763  556  467  289  326  226
##     I   17  274  504  438  408  178  179   95
##     J    2  110  243  232  201   54   29   25
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 漫谈条形图 https://cosx.org/2017/10/discussion{-}about{-}bar{-}graph}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{age =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{30}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{gender =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"man"}\NormalTok{, }\StringTok{"woman"}\NormalTok{), }\AttributeTok{each =} \DecValTok{30}\NormalTok{),}
  \AttributeTok{num =} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{100}\NormalTok{, }\AttributeTok{size =} \DecValTok{60}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T)}
\NormalTok{)}
\CommentTok{\# 重叠}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ num, }\AttributeTok{fill =}\NormalTok{ gender)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{)}
\CommentTok{\# 堆积}
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ num, }\AttributeTok{fill =}\NormalTok{ gender)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"stack"}\NormalTok{)}
\CommentTok{\# 双柱}
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ num, }\AttributeTok{fill =}\NormalTok{ gender)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{)}
\CommentTok{\# 百分比}
\NormalTok{p4 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ num, }\AttributeTok{fill =}\NormalTok{ gender)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent\_format}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{y =} \StringTok{"\%"}\NormalTok{)}
\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2) }\SpecialCharTok{/}\NormalTok{ (p3 }\SpecialCharTok{+}\NormalTok{ p4)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/barplot-1-1} 

}

\caption{条形图的四种常见形态}\label{fig:barplot-1}
\end{figure}

以数据集 diamonds 为例，按照纯净度 clarity 和切工 cut 分组统计钻石的数量，再按切工分组统计不同纯净度的钻石数量占比，如表 \ref{tab:diamonds-table} 所示

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{diamonds }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(diamonds)}
\NormalTok{dat }\OtherTok{\textless{}{-}}\NormalTok{ diamonds[, .(}\AttributeTok{cnt =}\NormalTok{ .N), by }\OtherTok{=}\NormalTok{ .(cut, clarity)] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[, pct }\SpecialCharTok{:}\ErrorTok{=}\NormalTok{ cnt }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(cnt), by }\OtherTok{=}\NormalTok{ .(cut)] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[, pct\_pp }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{paste0}\NormalTok{(cnt, }\StringTok{" ("}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(pct, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{), }\StringTok{")"}\NormalTok{) ]}
\CommentTok{\# 分组计数 with(diamonds, table(clarity, cut))}
\FunctionTok{dcast}\NormalTok{(dat, }\AttributeTok{formula =}\NormalTok{ clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut, }\AttributeTok{value.var =} \StringTok{"pct\_pp"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(}\AttributeTok{align =} \StringTok{"crrrrr"}\NormalTok{, }\AttributeTok{caption =} \StringTok{"数值和比例组合呈现"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:diamonds-table}数值和比例组合呈现}
\centering
\begin{tabular}[t]{c|r|r|r|r|r}
\hline
clarity & Fair & Good & Very Good & Premium & Ideal\\
\hline
I1 & 210 (13.04\%) & 96 (1.96\%) & 84 (0.70\%) & 205 (1.49\%) & 146 (0.68\%)\\
\hline
SI2 & 466 (28.94\%) & 1081 (22.03\%) & 2100 (17.38\%) & 2949 (21.38\%) & 2598 (12.06\%)\\
\hline
SI1 & 408 (25.34\%) & 1560 (31.80\%) & 3240 (26.82\%) & 3575 (25.92\%) & 4282 (19.87\%)\\
\hline
VS2 & 261 (16.21\%) & 978 (19.93\%) & 2591 (21.45\%) & 3357 (24.34\%) & 5071 (23.53\%)\\
\hline
VS1 & 170 (10.56\%) & 648 (13.21\%) & 1775 (14.69\%) & 1989 (14.42\%) & 3589 (16.65\%)\\
\hline
VVS2 & 69 (4.29\%) & 286 (5.83\%) & 1235 (10.22\%) & 870 (6.31\%) & 2606 (12.09\%)\\
\hline
VVS1 & 17 (1.06\%) & 186 (3.79\%) & 789 (6.53\%) & 616 (4.47\%) & 2047 (9.50\%)\\
\hline
IF & 9 (0.56\%) & 71 (1.45\%) & 268 (2.22\%) & 230 (1.67\%) & 1212 (5.62\%)\\
\hline
\end{tabular}
\end{table}

分别以堆积条形图和百分比堆积条形图展示，添加注释到条形图上，见 \ref{fig:barplot-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{=} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ cnt, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ cnt), }\AttributeTok{position =} \FunctionTok{position\_dodge}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(pct, }\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{)),}
    \AttributeTok{position =} \FunctionTok{position\_dodge}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{vjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{hjust =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{"clarity"}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{x =} \StringTok{"cut"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{)}

\NormalTok{p2 }\OtherTok{=} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ cut, }\AttributeTok{x =}\NormalTok{ cnt, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ cnt), }\AttributeTok{position =} \FunctionTok{position\_fill}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(pct, }\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{)),}
    \AttributeTok{position =} \FunctionTok{position\_fill}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{vjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{hjust =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{percent) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{"clarity"}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{x =} \StringTok{"cut"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{)}

\NormalTok{p1 }\SpecialCharTok{/}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/barplot-2-1} 

}

\caption{添加注释到条形图}\label{fig:barplot-2}
\end{figure}

借助 plotly 制作相应的动态百分比堆积条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge2"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{)}

\CommentTok{\# 百分比堆积条形图}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(dat,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{pct,}
  \AttributeTok{colors =} \StringTok{"Spectral"}\NormalTok{, }\AttributeTok{type =} \StringTok{"bar"}\NormalTok{,}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
\NormalTok{    cnt, }\StringTok{"颗 \textless{}br\textgreater{}"}\NormalTok{,}
    \StringTok{"占比："}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(pct, }\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}
\NormalTok{  ),}
  \AttributeTok{hoverinfo =} \StringTok{"text"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{barmode =} \StringTok{"stack"}\NormalTok{,}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{tickformat =} \StringTok{".0\%"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}

\CommentTok{\# \textasciigrave{}type = "histogram"\textasciigrave{} 以 cut 和 clarity 分组计数}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Spectral"}\NormalTok{, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}

\CommentTok{\# 堆积图}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Spectral"}\NormalTok{, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{barmode =} \StringTok{"stack"}\NormalTok{, }
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"cnt"}\NormalTok{),}
    \AttributeTok{legend =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{"clarity"}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{ggplot2-histogram}{%
\subsection{直方图}\label{ggplot2-histogram}}

直方图用来查看连续变量的分布

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(price)) }\SpecialCharTok{+} \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins =} \DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-44-1} 

}

\caption{钻石价格的分布}\label{fig:unnamed-chunk-44}
\end{figure}

堆积直方图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins =} \DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-45-1} 

}

\caption{钻石价格随切割质量的分布}\label{fig:unnamed-chunk-45}
\end{figure}

基础 R 包与 Ggplot2 包绘制的直方图的对比，Base R 绘图速度快，代码更加稳定，Ggplot2 代码简洁，更美观

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\FloatTok{2.1}\NormalTok{, }\FloatTok{2.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{),}
  \AttributeTok{type =} \StringTok{"n"}\NormalTok{, }\AttributeTok{font.main =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{frame.plot =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
  \CommentTok{\# xlab = "hp", ylab = "Frequency",}
  \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Histogram with Base R"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{" "}\NormalTok{, }\DecValTok{60}\NormalTok{), }\AttributeTok{collapse =} \StringTok{""}\NormalTok{))}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}
  \AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{),}
  \AttributeTok{tick =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{las =} \DecValTok{1}\NormalTok{, }\AttributeTok{padj =} \DecValTok{0}\NormalTok{, }\AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}
  \AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{at =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \CommentTok{\# col = "white", 坐标轴的颜色}
  \CommentTok{\# col.ticks 刻度线的颜色}
  \AttributeTok{tick =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# 取消刻度线}
  \AttributeTok{las =} \DecValTok{1}\NormalTok{, }\CommentTok{\# 水平方向}
  \AttributeTok{hadj =} \DecValTok{1}\NormalTok{, }\CommentTok{\# 右侧对齐}
  \AttributeTok{mgp =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{0}\NormalTok{) }\CommentTok{\# 纵轴边距线设置为 0.1}
\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{v =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{col =} \StringTok{"gray90"}\NormalTok{, }\AttributeTok{lty =} \StringTok{"solid"}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{h =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{v =} \FunctionTok{seq}\NormalTok{(}\DecValTok{75}\NormalTok{, }\DecValTok{325}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{col =} \StringTok{"gray95"}\NormalTok{, }\AttributeTok{lty =} \StringTok{"solid"}\NormalTok{)}
\FunctionTok{hist}\NormalTok{(mtcars}\SpecialCharTok{$}\NormalTok{hp,}
  \AttributeTok{col =} \StringTok{"\#56B4E9"}\NormalTok{, }\AttributeTok{border =} \StringTok{"white"}\NormalTok{,}
  \AttributeTok{freq =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}
  \CommentTok{\# labels = TRUE, axes = TRUE, ylim = c(0, 10.5),}
  \CommentTok{\# xlab = "hp",main = "Histogram with Base R"}
\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"hp"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.0}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\StringTok{"Frequency"}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{line =} \FloatTok{1.0}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(mtcars) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ hp), }\AttributeTok{fill =} \StringTok{"\#56B4E9"}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{350}\NormalTok{, }\DecValTok{50}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"hp"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Frequency"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Histogram with Ggplot2"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[Base R 直方图\label{fig:base-vs-ggplot2-hist-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/base-vs-ggplot2-hist-1} }\subfloat[Ggplot2 直方图\label{fig:base-vs-ggplot2-hist-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/base-vs-ggplot2-hist-2} }

}

\caption{直方图}\label{fig:base-vs-ggplot2-hist}
\end{figure}

\hypertarget{ggplot2-boxplot}{%
\subsection{箱线图}\label{ggplot2-boxplot}}

以 PlantGrowth 数据集为例展示箱线图，在两组不同实验条件下，植物生长的情况，纵坐标是干燥植物的量，横坐标表示不同的实验条件。这是非常典型的适合用箱线图来表达数据的场合，Y 轴对应数值型变量，X 轴对应分类变量，在 R 语言中，分类变量的类型是 factor

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"PlantGrowth"}\NormalTok{)}
\FunctionTok{str}\NormalTok{(PlantGrowth)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    30 obs. of  2 variables:
##  $ weight: num  4.17 5.58 5.18 6.11 4.5 4.61 5.17 4.53 5.33 5.14 ...
##  $ group : Factor w/ 3 levels "ctrl","trt1",..: 1 1 1 1 1 1 1 1 1 1 ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight)) }\SpecialCharTok{+} \FunctionTok{geom\_boxplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/PlantGrowth-boxplot-1} \end{center}

PlantGrowth 数据量比较小，此时比较适合采用抖动散点图，抖动是为了避免点之间相互重叠，为了增加不同类别之间的识别性，我们可以用不同的点的形状或者不同的颜色来表示类别

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{shape =}\NormalTok{ group)) }\SpecialCharTok{+} \FunctionTok{geom\_jitter}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/PlantGrowth-jitter-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ PlantGrowth, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ group, }\AttributeTok{y =}\NormalTok{ weight, }\AttributeTok{color =}\NormalTok{ group)) }\SpecialCharTok{+} \FunctionTok{geom\_jitter}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/PlantGrowth-jitter-2} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(weight }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group,}
  \AttributeTok{data =}\NormalTok{ PlantGrowth,}
  \AttributeTok{ylab =} \StringTok{"Dried weight of plants"}\NormalTok{, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{,}
  \AttributeTok{notch =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{varwidth =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-47-1} \end{center}

以钻石切割质量 cut 为分面依据，以钻石颜色类别 color 为 x 轴，钻石价格为 y 轴，绘制箱线图\ref{fig:boxplot-facet-color}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-facet-color-1} 

}

\caption{箱线图}\label{fig:boxplot-facet-color}
\end{figure}

我们当然还可以添加钻石的纯净度 clarity 作为分面依据，那么箱线图可以为图 \ref{fig:boxplot-facet-color-clarity-1}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-facet-color-clarity-1-1} 

}

\caption{复合分面箱线图}\label{fig:boxplot-facet-color-clarity-1}
\end{figure}

经过观察，我们发现水平分类过多，考虑用切割质量 cut 替换钻石颜色 color 绘图，但是由于分类过细，图信息展示不简练，反而不好，如图 \ref{fig:boxplot-facet-color-clarity-2}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ color)}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ color)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[切割质量cut上色\label{fig:boxplot-facet-color-clarity-2-1}]{\includegraphics{data-visualization_files/figure-latex/boxplot-facet-color-clarity-2-1} }\newline\subfloat[钻石颜色配色\label{fig:boxplot-facet-color-clarity-2-2}]{\includegraphics{data-visualization_files/figure-latex/boxplot-facet-color-clarity-2-2} }

}

\caption{箱线图配色}\label{fig:boxplot-facet-color-clarity-2}
\end{figure}

\hypertarget{sec-ggplot2-function}{%
\subsection{函数图}\label{sec-ggplot2-function}}

蝴蝶图的参数方程如下

\begin{align}
x &= \sin t \big(\mathrm e^{\cos t} - 2 \cos 4t + \sin^5(\frac{t}{12})\big) \\
y &= \cos t \big(\mathrm e^{\cos t} - 2 \cos 4t + \sin^5(\frac{t}{12})\big), t \in [- \pi, \pi]
\end{align}

\hypertarget{sec-ggplot2-density}{%
\subsection{密度图}\label{sec-ggplot2-density}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(cty)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{factor}\NormalTok{(cyl)), }\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Density plot"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"City Mileage Grouped by Number of cylinders"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"Source: mpg"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"City Mileage"}\NormalTok{,}
    \AttributeTok{fill =} \StringTok{"\# Cylinders"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/mpg-cyl-density-1} 

}

\caption{按汽缸数分组的城市里程}\label{fig:mpg-cyl-density}
\end{figure}

添加透明度，解决遮挡

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_density}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/density-1} 

}

\caption{密度图}\label{fig:density-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+} \FunctionTok{geom\_density}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/density-2} 

}

\caption{添加透明度的密度图}\label{fig:density-2}
\end{figure}

堆积密度图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density}\NormalTok{(}\AttributeTok{position =} \StringTok{"stack"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/stack-density-1} 

}

\caption{堆积密度图}\label{fig:stack-density}
\end{figure}

条件密度估计

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# You can use position="fill" to produce a conditional density estimate}
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(carat, }\FunctionTok{stat}\NormalTok{(count), }\AttributeTok{fill =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-48-1} 

}

\caption{条件密度估计图}\label{fig:unnamed-chunk-48}
\end{figure}

岭线图是密度图的一种变体，可以防止密度曲线重叠在一起

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds) }\SpecialCharTok{+}
\NormalTok{  ggridges}\SpecialCharTok{::}\FunctionTok{geom\_density\_ridges}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{y =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ color))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-49-1} \end{center}

二维的密度图又是一种延伸

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density\_2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ cut)) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{cut)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-50-1} \end{center}

\texttt{stat} 函数，特别是 nlevel 参数，在密度曲线之间填充我们又可以得到热力图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+}
  \FunctionTok{stat\_density\_2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{stat}\NormalTok{(nlevel)), }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(. }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-51-1} \end{center}

\texttt{gemo\_hex} 也是二维密度图的一种变体，特别适合数据量比较大的情形

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ carat, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+} \FunctionTok{geom\_hex}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-52-1} \end{center}

\href{https://themockup.blog/posts/2020-08-28-heatmaps-in-ggplot2/}{heatmaps in ggplot2} 二维密度图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ eruptions, }\AttributeTok{y =}\NormalTok{ waiting)) }\SpecialCharTok{+}
  \FunctionTok{stat\_density\_2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ ..level..), }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{100}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ eruptions, }\AttributeTok{y =}\NormalTok{ waiting)) }\SpecialCharTok{+}
  \FunctionTok{stat\_density2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{stat}\NormalTok{(level)), }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{(}\AttributeTok{option =} \StringTok{"viridis"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[默认调色板\label{fig:density-2d-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/density-2d-1} }\subfloat[viridis 调色板\label{fig:density-2d-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/density-2d-2} }

}

\caption{二维密度图}\label{fig:density-2d}
\end{figure}

\begin{rmdtip}{提示}

\texttt{MASS::kde2d()} 实现二维核密度估计，\textbf{ggplot2} 包提供了两种等价的绘图方式

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{stat\_density\_2d()} 和 \texttt{..}
\item
  \texttt{stat\_density2d()} 和 \texttt{stat()}
\end{enumerate}

\end{rmdtip}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ faithful, }\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{eruptions,}
  \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{waiting, }\AttributeTok{type =} \StringTok{"histogram2dcontour"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{)}

\CommentTok{\# plot\_ly(faithful, x = \textasciitilde{}waiting, y = \textasciitilde{}eruptions) \%\textgreater{}\% }
\CommentTok{\#   add\_histogram2d() \%\textgreater{}\% }
\CommentTok{\#   add\_histogram2dcontour()}
\end{Highlighting}
\end{Shaded}

延伸一下，热力图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(KernSmooth)}
\NormalTok{den }\OtherTok{\textless{}{-}} \FunctionTok{bkde2D}\NormalTok{(}\AttributeTok{x =}\NormalTok{ faithful, }\AttributeTok{bandwidth =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\CommentTok{\# 热力图}
\NormalTok{p1 }\OtherTok{\textless{}{-}}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{x1, }\AttributeTok{y =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{x2, }\AttributeTok{z =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{fhat) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_heatmap}\NormalTok{()}

\CommentTok{\# 等高线图}
\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{x1, }\AttributeTok{y =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{x2, }\AttributeTok{z =}\NormalTok{ den}\SpecialCharTok{$}\NormalTok{fhat) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{config}\NormalTok{(}\AttributeTok{displayModeBar =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_contour}\NormalTok{()}

\NormalTok{htmltools}\SpecialCharTok{::}\FunctionTok{tagList}\NormalTok{(p1, p2)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-violin}{%
\subsection{提琴图}\label{sec-ggplot2-violin}}

2004 年 Daniel Adler 开发 \href{https://github.com/TomKellyGenetics/vioplot}{vioplot} 包实现提琴图的绘制，它可能是最早实现此功能的 R 包，随后10余年没有更新却一直坚挺在 CRAN 上，非常难得，好在 Thomas Kelly 已经接手维护。另一款绘制提琴图的 R 包是 Peter Kampstra 开发的 \href{https://cran.r-project.org/package=beanplot}{beanplot} \citep{beanplot_2008_jss}，也存在很多年了，不过随着时间的变迁，比较现代的方式是 \textbf{ggplot2} 带来的 \texttt{geom\_violin()} 扔掉了很多依赖，也是各种图形的汇集地，可以看作是最佳实践。提琴图比起箱线图优势在于呈现更多的分布信息，其次在于更加美观，但是就目前来说箱线图的受众比提琴图要多很多，毕竟前者是包含更多统计信息，如图\ref{fig:boxplot-violin} 所示。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays)}
\NormalTok{vioplot}\SpecialCharTok{::}\FunctionTok{vioplot}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(InsectSprays, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ spray, }\AttributeTok{y =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_violin}\NormalTok{(}\AttributeTok{fill =} \StringTok{"lightgray"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\NormalTok{beanplot}\SpecialCharTok{::}\FunctionTok{beanplot}\NormalTok{(count }\SpecialCharTok{\textasciitilde{}}\NormalTok{ spray, }\AttributeTok{data =}\NormalTok{ InsectSprays, }\AttributeTok{col =} \StringTok{"lightgray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[简单箱线图\label{fig:boxplot-violin-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/boxplot-violin-1} }\subfloat[vioplot 绘制的提琴图\label{fig:boxplot-violin-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/boxplot-violin-2} }\newline\subfloat[ggplot2 绘制的提琴图\label{fig:boxplot-violin-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/boxplot-violin-3} }\subfloat[beanplot 绘制的提琴图\label{fig:boxplot-violin-4}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/boxplot-violin-4} }

}

\caption{几种不同的提琴图}\label{fig:boxplot-violin}
\end{figure}

\href{https://github.com/wjschne/ggnormalviolin}{ggnormalviolin} 包在给定均值和标准差的情况下，绘制正态分布的概率密度曲线，如图 \ref{fig:normal-violin} 所示。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggnormalviolin)}
\FunctionTok{with}\NormalTok{(}
  \FunctionTok{aggregate}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ iris, Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species,}
    \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{c}\NormalTok{(}\AttributeTok{dist\_mean =} \FunctionTok{mean}\NormalTok{(x), }\AttributeTok{dist\_sd =} \FunctionTok{sd}\NormalTok{(x))}
\NormalTok{  ),}
  \FunctionTok{cbind.data.frame}\NormalTok{(Sepal.Length, Species)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Species, }\AttributeTok{mu =}\NormalTok{ dist\_mean, }\AttributeTok{sigma =}\NormalTok{ dist\_sd, }\AttributeTok{fill =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{geom\_normalviolin}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/normal-violin-1} 

}

\caption{正态分布的概率密度曲线}\label{fig:normal-violin}
\end{figure}

\hypertarget{ggplot2-jitter}{%
\subsection{抖动图}\label{ggplot2-jitter}}

抖动图适合数据量比较小的情况

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class, }\AttributeTok{y =}\NormalTok{ hwy, }\AttributeTok{color =}\NormalTok{ class)) }\SpecialCharTok{+} \FunctionTok{geom\_jitter}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-54-1} \end{center}

抖不抖，还是抖一下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Species, }\AttributeTok{y =}\NormalTok{ Sepal.Length)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ Species), }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{colour =} \StringTok{"grey20"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\# geom\_boxplot(outlier.colour = NA, fill = NA, colour = "grey20") +}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Not Jittered"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-55-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Species, }\AttributeTok{y =}\NormalTok{ Sepal.Length)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ Species),}
    \AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{colour =} \StringTok{"grey20"}\NormalTok{,}
    \AttributeTok{position =} \FunctionTok{position\_jitter}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{height =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \CommentTok{\# geom\_boxplot(outlier.colour = NA, fill = NA, colour = "grey20") +}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Jittered"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-55-2} \end{center}

在数据量比较大的时候，可以用箱线图、密度图、提琴图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cut, }\AttributeTok{y =}\NormalTok{ price)) }\SpecialCharTok{+} \FunctionTok{geom\_jitter}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-56-1} 

}

\caption{抖动图的反例}\label{fig:unnamed-chunk-56}
\end{figure}

上色和分面都不好使的抖动图，因为区分度变小

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(sub\_diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(clarity }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cut)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/unnamed-chunk-57-1} 

}

\caption{根据钻石颜色上色}\label{fig:unnamed-chunk-57}
\end{figure}

箱线图此时不宜分的过细

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(cut }\SpecialCharTok{\textasciitilde{}}\NormalTok{ clarity)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-facet-cut-clarity-1} 

}

\caption{箱线图}\label{fig:boxplot-facet-cut-clarity}
\end{figure}

所以这样更好，先按纯净度分面，再对比不同的颜色，钻石价格的差异

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{clarity)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-facet-clarity-1} 

}

\caption{钻石按纯净度分面}\label{fig:boxplot-facet-clarity}
\end{figure}

最好只比较一个维度，不同颜色钻石的价格对比

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{y =}\NormalTok{ price, }\AttributeTok{color =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/boxplot-color-1} 

}

\caption{不同颜色钻石的价格比较}\label{fig:boxplot-color}
\end{figure}

设置随机数种子，抖动图是可重复的。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Species, }\AttributeTok{y =}\NormalTok{ Sepal.Width, }\AttributeTok{color =}\NormalTok{ Species)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.65}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{position =} \FunctionTok{position\_jitter}\NormalTok{(}\AttributeTok{seed =} \DecValTok{37}\NormalTok{, }\AttributeTok{width =} \FloatTok{0.25}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-58-1} \end{center}

\hypertarget{sec-ggplot2-beeswarm}{%
\subsection{蜂群图}\label{sec-ggplot2-beeswarm}}

在样本点有限的情况下，用蜜蜂图代替普通的抖动图，可视化效果会好很多，如图 \ref{fig:beeswarm} 所示。Erik Clarke 开发的 \href{https://github.com/eclarke/ggbeeswarm}{ggbeeswarm} 包可以将随机抖动的散点图朝着比较规律的方向聚合，又不丢失数据本身的准确性。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggbeeswarm)}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(Species, Sepal.Length)) }\SpecialCharTok{+}
  \FunctionTok{geom\_jitter}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(iris, }\FunctionTok{aes}\NormalTok{(Species, Sepal.Length)) }\SpecialCharTok{+}
  \FunctionTok{geom\_quasirandom}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/beeswarm-1} 

}

\caption{蜜蜂图可视化效果比抖动图好}\label{fig:beeswarm}
\end{figure}

\hypertarget{ggplot2-rose}{%
\subsection{玫瑰图}\label{ggplot2-rose}}

南丁格尔风玫瑰图\footnote{\url{https://mbostock.github.io/protovis/ex/crimea-rose-full.html}} 可以作为堆积条形图，分组条形图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/stack-to-rose-1} 

}

\caption{堆积条形图转风玫瑰图}\label{fig:stack-to-rose-1}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ clarity)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/stack-to-rose-2} 

}

\caption{堆积条形图转风玫瑰图}\label{fig:stack-to-rose-2}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 风玫瑰图 http://blog.csdn.net/Bone\_ACE/article/details/47624987}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2018}\NormalTok{)}
\CommentTok{\# 随机生成100次风向，并汇集到16个区间内}
\NormalTok{direction }\OtherTok{\textless{}{-}} \FunctionTok{cut\_interval}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{360}\NormalTok{), }\AttributeTok{n =} \DecValTok{16}\NormalTok{)}
\CommentTok{\# 随机生成100次风速，并划分成4种强度}
\NormalTok{mag }\OtherTok{\textless{}{-}} \FunctionTok{cut\_interval}\NormalTok{(}\FunctionTok{rgamma}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{15}\NormalTok{), }\DecValTok{4}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{direction =}\NormalTok{ direction, }\AttributeTok{mag =}\NormalTok{ mag)}
\CommentTok{\# 将风向映射到X轴，频数映射到Y轴，风速大小映射到填充色，生成条形图后再转为极坐标形式即可}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ direction, }\AttributeTok{y =}\NormalTok{ ..count.., }\AttributeTok{fill =}\NormalTok{ mag))}
\NormalTok{p }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{colour =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }\AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Magnitude"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/wind-rose-1} 

}

\caption{风玫瑰图}\label{fig:wind-rose}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\SpecialCharTok{+} \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }\AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Magnitude"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-59-1} \end{center}

\hypertarget{sec-ggplot2-tile}{%
\subsection{瓦片图}\label{sec-ggplot2-tile}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{months =}\NormalTok{ month.abb, }\AttributeTok{years =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{num =} \FunctionTok{as.vector}\NormalTok{(AirPassengers)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ years, }\AttributeTok{y =}\NormalTok{ months, }\AttributeTok{fill =}\NormalTok{ num)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_continuous}\NormalTok{(}\AttributeTok{type =} \StringTok{"viridis"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1949}\NormalTok{, }\DecValTok{1960}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{), }\AttributeTok{labels =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \FloatTok{10.54}\NormalTok{, }\AttributeTok{base\_family =} \StringTok{"Noto Serif SC"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"年"}\NormalTok{, }\AttributeTok{y =} \StringTok{"月"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"人数"}\NormalTok{)}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{months =}\NormalTok{ month.abb, }\AttributeTok{years =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{num =} \FunctionTok{as.vector}\NormalTok{(AirPassengers)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ years, }\AttributeTok{y =}\NormalTok{ months, }\AttributeTok{color =}\NormalTok{ num)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{size =} \DecValTok{8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_distiller}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1949}\NormalTok{, }\DecValTok{1960}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{), }\AttributeTok{labels =} \DecValTok{1949}\SpecialCharTok{:}\DecValTok{1960}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \FloatTok{10.54}\NormalTok{, }\AttributeTok{base\_family =} \StringTok{"Noto Serif SC"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"年"}\NormalTok{, }\AttributeTok{y =} \StringTok{"月"}\NormalTok{, }\AttributeTok{color =} \StringTok{"人数"}\NormalTok{)}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/geom-tile-1} 

}

\caption{1949-1960年国际航线乘客数量的月度趋势}\label{fig:geom-tile}
\end{figure}

\hypertarget{sec-ggplot2-calendar}{%
\subsection{日历图}\label{sec-ggplot2-calendar}}

airquality 数据集记录了1973年5月至9月纽约的空气质量，包括气温（华氏度）、风速（米/小时）、紫外线强度、臭氧含量四个指标，图 \ref{fig:calendar-airquality} 展示了每日的气温变化。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airquality }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{Date =} \FunctionTok{seq.Date}\NormalTok{(}
    \AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"1973{-}05{-}01"}\NormalTok{),}
    \AttributeTok{to =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"1973{-}09{-}30"}\NormalTok{), }\AttributeTok{by =} \StringTok{"day"}
\NormalTok{  )) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{Week =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{format}\NormalTok{(Date, }\StringTok{"\%W"}\NormalTok{)),}
    \AttributeTok{Year =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{format}\NormalTok{(Date, }\StringTok{"\%Y"}\NormalTok{)),}
    \AttributeTok{Weekdays =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{weekdays}\NormalTok{(Date, }\AttributeTok{abbreviate =}\NormalTok{ T),}
      \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Mon"}\NormalTok{, }\StringTok{"Tue"}\NormalTok{, }\StringTok{"Wed"}\NormalTok{, }\StringTok{"Thu"}\NormalTok{, }\StringTok{"Fri"}\NormalTok{, }\StringTok{"Sat"}\NormalTok{, }\StringTok{"Sun"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Week, }\AttributeTok{y =}\NormalTok{ Weekdays, }\AttributeTok{fill =}\NormalTok{ Temp)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_distiller}\NormalTok{(}\AttributeTok{name =} \StringTok{"Temp (F)"}\NormalTok{, }\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\StringTok{"Year"}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{52}\NormalTok{, }\AttributeTok{length =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ month.abb}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/calendar-airquality-1} 

}

\caption{1973年5月至9月纽约的气温变化}\label{fig:calendar-airquality}
\end{figure}

\begin{rmdnote}{注意}

图 \ref{fig:calendar-airquality} 横轴的刻度标签换成了月份，一个月为四周，一年 52～53 周，每周的第一天约定为星期一，1973年05月01日为星期二。代码中颇为技巧的在于 \texttt{format()} 函数从 Date 日期类型的数据提取第几周， 用 \texttt{weekdays()} 函数提取星期几，而 month.abb 则是一个内置常量，12个月份的英文缩写。在调用其它 R 包处理日期数据时要特别小心，要留意一周的的第一天是星期几，有的是星期一，有的是星期日，这往往和宗教信仰相关，星期日在西方也叫礼拜天。 上面 Base R 提供的日期函数认为一周的第一天是星期一，而调用 \textbf{data.table} 的话，默认一周是从星期日（礼拜天）开始的。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://d.cosx.org/d/421230}
\FunctionTok{weekdays}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{(), }\AttributeTok{abbreviate =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Fri"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.table}\SpecialCharTok{::}\FunctionTok{wday}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6
\end{verbatim}

\end{rmdnote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gert)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{git\_config\_set}\NormalTok{(}\StringTok{"user.name"}\NormalTok{, }\StringTok{"XiangyunHuang"}\NormalTok{)}
\FunctionTok{git\_config\_set}\NormalTok{(}\StringTok{"user.email"}\NormalTok{, }\StringTok{"xiangyunfaith@outlook.com"}\NormalTok{)}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{git\_log}\NormalTok{(}\AttributeTok{max =} \DecValTok{1000}\NormalTok{)}
\CommentTok{\# format(time, "\%a") 本地 MacOS 环境 "六" "四" "五" 表示星期}
\CommentTok{\# Sys.getlocale("LC\_TIME") \# "zh\_CN.UTF{-}8"}
\NormalTok{lvls }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(}\FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"CI"}\NormalTok{, }\ConstantTok{NA}\NormalTok{))) \{}
  \FunctionTok{c}\NormalTok{(}\StringTok{"Sun"}\NormalTok{, }\StringTok{"Mon"}\NormalTok{, }\StringTok{"Tue"}\NormalTok{, }\StringTok{"Wed"}\NormalTok{, }\StringTok{"Thu"}\NormalTok{, }\StringTok{"Fri"}\NormalTok{, }\StringTok{"Sat"}\NormalTok{)}
\NormalTok{\} }\ControlFlowTok{else}\NormalTok{ \{}
  \FunctionTok{c}\NormalTok{(}\StringTok{"日"}\NormalTok{, }\StringTok{"一"}\NormalTok{, }\StringTok{"二"}\NormalTok{, }\StringTok{"三"}\NormalTok{, }\StringTok{"四"}\NormalTok{, }\StringTok{"五"}\NormalTok{, }\StringTok{"六"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(dat,}
  \AttributeTok{date =} \FunctionTok{format}\NormalTok{(time, }\StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{),}
  \AttributeTok{year =} \FunctionTok{format}\NormalTok{(time, }\StringTok{"\%Y"}\NormalTok{) ,}
  \AttributeTok{month =} \FunctionTok{format}\NormalTok{(time, }\StringTok{"\%m"}\NormalTok{),}
  \AttributeTok{weekday =} \FunctionTok{format}\NormalTok{(time, }\StringTok{"\%a"}\NormalTok{), }\CommentTok{\# factor(format(time, "\%a"), levels = lvls),}
  \AttributeTok{week =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{format}\NormalTok{(time, }\StringTok{"\%W"}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

本书的活跃情况

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat1 }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{x =}\NormalTok{ commit }\SpecialCharTok{\textasciitilde{}}\NormalTok{ year }\SpecialCharTok{+}\NormalTok{ month, }\AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{FUN =}\NormalTok{ length)}
\CommentTok{\# 条形图}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ month, }\AttributeTok{y =}\NormalTok{ commit, }\AttributeTok{fill =}\NormalTok{ year)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{position =} \StringTok{"identity"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-62-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 日历图}
\NormalTok{dat2 }\OtherTok{\textless{}{-}} \FunctionTok{aggregate}\NormalTok{(}\AttributeTok{x =}\NormalTok{ commit }\SpecialCharTok{\textasciitilde{}}\NormalTok{ year }\SpecialCharTok{+}\NormalTok{ week }\SpecialCharTok{+}\NormalTok{ weekday, }\AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{FUN =}\NormalTok{ length)}

\NormalTok{dat2 }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(dat2, }\AttributeTok{colorBin =} \FunctionTok{cut}\NormalTok{(commit, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{25}\NormalTok{)))}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ week, }\AttributeTok{y =}\NormalTok{ weekday, }\AttributeTok{fill =}\NormalTok{ colorBin)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{name =} \StringTok{"commit"}\NormalTok{, }\AttributeTok{palette =} \StringTok{"Greens"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\StringTok{"year"}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{52}\NormalTok{, }\AttributeTok{length =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ month.abb}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_family =} \StringTok{"Noto Sans SC"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/calendar-masr-1} 

}

\caption{《R语言学习笔记》的活跃情况}\label{fig:calendar-masr}
\end{figure}

\hypertarget{sec-ggplot2-ridgeline}{%
\subsection{岭线图}\label{sec-ggplot2-ridgeline}}

\textbf{ggridges} 包，\href{https://yufree.cn/}{于淼} 对此图形的来龙去脉做了比较系统的阐述，详见统计之都主站文章\href{https://cosx.org/2018/04/ridgeline-story/}{叠嶂图的前世今生}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggridges)}
\FunctionTok{ggplot}\NormalTok{(lincoln\_weather, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{\textasciigrave{}}\AttributeTok{Mean Temperature [F]}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{y =}\NormalTok{ Month, }\AttributeTok{fill =} \FunctionTok{stat}\NormalTok{(x))) }\SpecialCharTok{+}
  \FunctionTok{geom\_density\_ridges\_gradient}\NormalTok{(}\AttributeTok{scale =} \DecValTok{3}\NormalTok{, }\AttributeTok{rel\_min\_height =} \FloatTok{0.01}\NormalTok{, }\AttributeTok{gradient\_lwd =} \FloatTok{1.}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_discrete}\NormalTok{(}\AttributeTok{expand =} \FunctionTok{expansion}\NormalTok{(}\AttributeTok{mult =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.25}\NormalTok{))) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{(}\AttributeTok{name =} \StringTok{"Temp. [F]"}\NormalTok{, }\AttributeTok{option =} \StringTok{"C"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{\textquotesingle{}Temperatures in Lincoln NE\textquotesingle{}}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{\textquotesingle{}Mean temperatures (Fahrenheit) by month for 2016\textquotesingle{}}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_ridges}\NormalTok{(}\AttributeTok{font\_size =} \DecValTok{13}\NormalTok{, }\AttributeTok{grid =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/lincoln-weather-1} 

}

\caption{2016年在内布拉斯加州林肯市的天气变化}\label{fig:lincoln-weather}
\end{figure}

通过数据可视化的手段帮助肉眼检查两组数据的分布

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(sleep, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ extra, }\AttributeTok{y =}\NormalTok{ group, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density\_ridges}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_ridges}\NormalTok{()}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(diamonds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ price, }\AttributeTok{y =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_density\_ridges}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_ridges}\NormalTok{()}

\NormalTok{p1 }\SpecialCharTok{/}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/sleep-diamonds-1} 

}

\caption{比较数据的分布}\label{fig:sleep-diamonds}
\end{figure}

\href{https://github.com/R-CoderDotCom/ridgeline}{ridgeline} 提供 Base R 绘图方案

\begin{figure}

{\centering \includegraphics[width=0.65\linewidth]{data-visualization_files/figure-latex/ridge-1} 

}

\caption{岭线图}\label{fig:ridge}
\end{figure}

\hypertarget{sec-ggplot2-ellipse}{%
\subsection{椭圆图}\label{sec-ggplot2-ellipse}}

type 指定多元分布的类型，\texttt{type\ =\ "t"} 和 \texttt{type\ =\ "norm"} 分别表示 t 分布和正态分布，\texttt{geom\ =\ "polygon"}，以 \texttt{eruptions\ \textgreater{}\ 3} 分为两组

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ waiting, }\AttributeTok{y =}\NormalTok{ eruptions)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{stat\_ellipse}\NormalTok{()}

\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(waiting, eruptions, }\AttributeTok{color =}\NormalTok{ eruptions }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{stat\_ellipse}\NormalTok{(}\AttributeTok{type =} \StringTok{"norm"}\NormalTok{, }\AttributeTok{linetype =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{stat\_ellipse}\NormalTok{(}\AttributeTok{type =} \StringTok{"t"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(waiting, eruptions, }\AttributeTok{fill =}\NormalTok{ eruptions }\SpecialCharTok{\textgreater{}} \DecValTok{3}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{stat\_ellipse}\NormalTok{(}\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \subfloat[简单椭圆图\label{fig:ellipse-1}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/ellipse-1} }\subfloat[正态和 t 分布\label{fig:ellipse-2}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/ellipse-2} }\newline\subfloat[填充几何图形\label{fig:ellipse-3}]{\includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/ellipse-3} }

}

\caption{几种不同的椭圆图}\label{fig:ellipse}
\end{figure}

\hypertarget{sec-ggplot2-qq}{%
\subsection{Q-Q 图}\label{sec-ggplot2-qq}}

quantile-quantile Q-Q 正态分布图的 ggplot2 实现 \href{https://github.com/aloy/qqplotr}{qqplotr}

\hypertarget{sec-ggplot2-chull}{%
\subsection{包络图}\label{sec-ggplot2-chull}}

ggpubr 包提供了 \texttt{stat\_chull()} 图层

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggpubr)}
\FunctionTok{ggscatter}\NormalTok{(mpg, }\AttributeTok{x =} \StringTok{"displ"}\NormalTok{, }\AttributeTok{y =} \StringTok{"hwy"}\NormalTok{, }\AttributeTok{color =} \StringTok{"drv"}\NormalTok{)}\SpecialCharTok{+}
 \FunctionTok{stat\_chull}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ drv, }\AttributeTok{fill =}\NormalTok{ drv), }\AttributeTok{alpha =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/stat-chull-1} 

}

\caption{包络图}\label{fig:stat-chull}
\end{figure}

其背后的原理如下

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stat\_chull}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## function (mapping = NULL, data = NULL, geom = "path", position = "identity", 
##     na.rm = FALSE, show.legend = NA, inherit.aes = TRUE, ...) 
## {
##     layer(stat = StatChull, data = data, mapping = mapping, geom = geom, 
##         position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
##         params = list(na.rm = na.rm, ...))
## }
## <bytecode: 0x55df9fce0cb8>
## <environment: namespace:ggpubr>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{StatChull }\OtherTok{\textless{}{-}} \FunctionTok{ggproto}\NormalTok{(}\StringTok{"StatChull"}\NormalTok{, Stat,}
  \AttributeTok{compute\_group =} \ControlFlowTok{function}\NormalTok{(data, scales) \{}
\NormalTok{    data[}\FunctionTok{chull}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{x, data}\SpecialCharTok{$}\NormalTok{y), , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{  \},}
  \AttributeTok{required\_aes =} \FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{)}
\NormalTok{)}

\NormalTok{stat\_chull }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{mapping =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{data =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{,}
                       \AttributeTok{position =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{show.legend =} \ConstantTok{NA}\NormalTok{,}
                       \AttributeTok{inherit.aes =} \ConstantTok{TRUE}\NormalTok{, ...) \{}
  \FunctionTok{layer}\NormalTok{(}
    \AttributeTok{stat =}\NormalTok{ StatChull, }\AttributeTok{data =}\NormalTok{ data, }\AttributeTok{mapping =}\NormalTok{ mapping, }\AttributeTok{geom =}\NormalTok{ geom,}
    \AttributeTok{position =}\NormalTok{ position, }\AttributeTok{show.legend =}\NormalTok{ show.legend, }\AttributeTok{inherit.aes =}\NormalTok{ inherit.aes,}
    \AttributeTok{params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{na.rm =}\NormalTok{ na.rm, ...)}
\NormalTok{  )}
\NormalTok{\}}

\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(displ, hwy)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{stat\_chull}\NormalTok{(}\AttributeTok{fill =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(mpg, }\FunctionTok{aes}\NormalTok{(displ, hwy, }\AttributeTok{colour =}\NormalTok{ drv)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{stat\_chull}\NormalTok{(}\AttributeTok{fill =} \ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-fit}{%
\subsection{拟合图}\label{sec-ggplot2-fit}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xx }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{9}\SpecialCharTok{:}\DecValTok{9}
\NormalTok{yy }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{abs}\NormalTok{(xx))}
\FunctionTok{plot}\NormalTok{(xx, yy,}
  \AttributeTok{col =} \StringTok{"red"}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x),}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{abs}\NormalTok{(x)))}
\NormalTok{)}
\FunctionTok{lines}\NormalTok{(}\FunctionTok{spline}\NormalTok{(xx, yy, }\AttributeTok{n =} \DecValTok{101}\NormalTok{, }\AttributeTok{method =} \StringTok{"fmm"}\NormalTok{, }\AttributeTok{ties =}\NormalTok{ mean), }\AttributeTok{col =} \StringTok{"pink"}\NormalTok{)}

\NormalTok{myspline }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(formula, data, ...) \{}
\NormalTok{  dat }\OtherTok{\textless{}{-}} \FunctionTok{model.frame}\NormalTok{(formula, data)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{splinefun}\NormalTok{(dat[[}\DecValTok{2}\NormalTok{]], dat[[}\DecValTok{1}\NormalTok{]])}
  \FunctionTok{class}\NormalTok{(res) }\OtherTok{\textless{}{-}} \StringTok{"myspline"}
\NormalTok{  res}
\NormalTok{\}}

\NormalTok{predict.myspline }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(object, newdata, ...) \{}
  \FunctionTok{object}\NormalTok{(newdata[[}\DecValTok{1}\NormalTok{]])}
\NormalTok{\}}

\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{9}\SpecialCharTok{:}\DecValTok{9}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{y =} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{abs}\NormalTok{(x))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"red"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{stat\_smooth}\NormalTok{(}\AttributeTok{method =}\NormalTok{ myspline, }\AttributeTok{formula =}\NormalTok{ y}\SpecialCharTok{\textasciitilde{}}\NormalTok{x, }\AttributeTok{se =}\NormalTok{ F, }\AttributeTok{color =} \StringTok{"pink"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \FunctionTok{expression}\NormalTok{(x), }\AttributeTok{y =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{abs}\NormalTok{(x)))) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/spline-fun-1} \includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/spline-fun-2} 

}

\caption{自定义样条函数}\label{fig:spline-fun}
\end{figure}

下面以真实数据集 trees 为例，介绍 \texttt{geom\_smooth()} 支持的拟合方法，比如 \texttt{"lm"} 线性回归和 \texttt{"nls"} 非线性回归

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trees, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{log}\NormalTok{(Girth), }\AttributeTok{y =} \FunctionTok{log}\NormalTok{(Volume))) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }\AttributeTok{se =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(trees, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Girth, }\AttributeTok{y =}\NormalTok{ Volume)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}
    \AttributeTok{method =} \StringTok{"nls"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ a }\SpecialCharTok{*}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ b, }\AttributeTok{se =}\NormalTok{ F,}
    \AttributeTok{method.args =} \FunctionTok{list}\NormalTok{(}\AttributeTok{start =} \FunctionTok{list}\NormalTok{(}\AttributeTok{a =} \DecValTok{5}\NormalTok{, }\AttributeTok{b =} \SpecialCharTok{{-}}\DecValTok{36}\NormalTok{))}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/smooth-methods-1} \includegraphics[width=0.45\linewidth]{data-visualization_files/figure-latex/smooth-methods-2} 

}

\caption{平滑方法}\label{fig:smooth-methods}
\end{figure}

\hypertarget{sec-ggplot2-raster}{%
\subsection{地形图}\label{sec-ggplot2-raster}}

区域之间以轮廓分割，轮廓之间以相同的颜色填充，Cleveland 把这个叫做 level plot， \textbf{lattice} 包中 \texttt{levelplot()} 函数正来源于此。

\href{https://en.wikipedia.org/wiki/Maungawhau}{Auckland's Maunga Whau Volcano} 是火山喷发后留下的碴堆，位于新西兰奥克兰伊甸山郊区。\href{https://www.stat.auckland.ac.nz/~ihaka/}{Ross Ihaka} 收集了它的地形数据，命名为 volcano，打包在 R 软件环境中，见图 \ref{fig:elevation-volcano}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{filled.contour}\NormalTok{(volcano,}
  \AttributeTok{color.palette =}\NormalTok{ terrain.colors,}
  \AttributeTok{plot.title =} \FunctionTok{title}\NormalTok{(}
    \AttributeTok{main =} \StringTok{"The Topography of Maunga Whau"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"Meters North"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Meters West"}
\NormalTok{  ),}
  \AttributeTok{plot.axes =}\NormalTok{ \{}
    \FunctionTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{800}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{))}
    \FunctionTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{600}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{))}
\NormalTok{  \},}
  \AttributeTok{key.title =} \FunctionTok{title}\NormalTok{(}\AttributeTok{main =} \StringTok{"Height}\SpecialCharTok{\textbackslash{}n}\StringTok{(meters)"}\NormalTok{),}
  \AttributeTok{key.axes =} \FunctionTok{axis}\NormalTok{(}\DecValTok{4}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{90}\NormalTok{, }\DecValTok{190}\NormalTok{, }\AttributeTok{by =} \DecValTok{10}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/elevation-volcano-1} 

}

\caption{image 图形}\label{fig:elevation-volcano}
\end{figure}

\hypertarget{sec-ggplot2-treemap}{%
\subsection{树状图}\label{sec-ggplot2-treemap}}

数据集 GNI2014 来自 \href{https://github.com/mtennekes/treemap}{\textbf{treemap}} 包，是一个 data.frame 类型的数据对象，记录了 2014 年每个国家的人口总数 population 和国民人均收入 GNI，数据样例见下方：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(treemap)}
\FunctionTok{data}\NormalTok{(GNI2014, }\AttributeTok{package =} \StringTok{"treemap"}\NormalTok{)}
\FunctionTok{subset}\NormalTok{(GNI2014, }\AttributeTok{subset =} \FunctionTok{grepl}\NormalTok{(}\AttributeTok{x =}\NormalTok{ country, }\AttributeTok{pattern =} \StringTok{\textquotesingle{}China\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    iso3              country continent population   GNI
## 7   MAC     Macao SAR, China      Asia     559846 76270
## 33  HKG Hong Kong SAR, China      Asia    7061200 40320
## 87  CHN                China      Asia 1338612970  7400
\end{verbatim}

数据呈现明显的层级结构，从大洲到国家记录人口数量和人均收入，矩阵树图以方块大小表示人口数量，以颜色深浅表示人均收入，见图\ref{fig:treemap-grid}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{treemap}\NormalTok{(GNI2014,}
  \AttributeTok{index =} \FunctionTok{c}\NormalTok{(}\StringTok{"continent"}\NormalTok{, }\StringTok{"iso3"}\NormalTok{),}
  \AttributeTok{vSize =} \StringTok{"population"}\NormalTok{, }
  \AttributeTok{vColor =} \StringTok{"GNI"}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"value"}\NormalTok{,}
  \AttributeTok{format.legend =} \FunctionTok{list}\NormalTok{(}\AttributeTok{scientific =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{big.mark =} \StringTok{" "}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/treemap-grid-1} 

}

\caption{矩阵树图}\label{fig:treemap-grid}
\end{figure}

\href{https://github.com/wilkox/treemapify}{\textbf{treemapify}} 包基于 ggplot2 制作树状图，类似地，该 R 包内置了数据集 G20，记录了世界主要经济体 G20 (\url{https://en.wikipedia.org/wiki/G20}) 的经济和人口信息，国家 GDP （单位：百万美元）\texttt{gdp\_mil\_usd} 和人类发展指数 \texttt{hdi}。相比于 GNI2014，它还包含了两列标签信息：经济发展阶段和所处的半球。图@(fig:treemap-ggplot2)以南北半球 hemisphere 分面，以色彩填充区域 region，以 \texttt{gdp\_mil\_usd} 表示区域大小

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(treemapify)}
\FunctionTok{ggplot}\NormalTok{(G20, }\FunctionTok{aes}\NormalTok{(}
  \AttributeTok{area =}\NormalTok{ gdp\_mil\_usd, }\AttributeTok{fill =}\NormalTok{ region,}
  \AttributeTok{label =}\NormalTok{ country, }\AttributeTok{subgroup =}\NormalTok{ region}
\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_treemap}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_treemap\_text}\NormalTok{(}\AttributeTok{grow =}\NormalTok{ T, }\AttributeTok{reflow =}\NormalTok{ T, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{hemisphere) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Set1"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"The G{-}20 major economies by hemisphere"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"The area of each tile represents the country\textquotesingle{}s GDP as a}
\StringTok{      proportion of all countries in that hemisphere"}\NormalTok{,}
    \AttributeTok{fill =} \StringTok{"Region"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/treemap-ggplot2-1} 

}

\caption{世界主要经济体G20的人口和经济信息}\label{fig:treemap-ggplot2}
\end{figure}

\hypertarget{sec-ggplot2-cohort}{%
\subsection{留存图}\label{sec-ggplot2-cohort}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cohort }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{cohort =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\AttributeTok{times =} \DecValTok{5}\SpecialCharTok{:}\DecValTok{1}\NormalTok{),}
  \AttributeTok{week =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(}
    \DecValTok{75}\NormalTok{, }\DecValTok{73}\NormalTok{, }\DecValTok{54}\NormalTok{, }\DecValTok{23}\NormalTok{, }\DecValTok{3}\NormalTok{,}
    \DecValTok{98}\NormalTok{, }\DecValTok{94}\NormalTok{, }\DecValTok{70}\NormalTok{, }\DecValTok{25}\NormalTok{,}
    \DecValTok{52}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{,}
    \DecValTok{44}\NormalTok{, }\DecValTok{15}\NormalTok{,}
    \DecValTok{88}
\NormalTok{  )}
\NormalTok{)}

\FunctionTok{ggplot}\NormalTok{(cohort, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ week, }\AttributeTok{y =}\NormalTok{ cohort, }\AttributeTok{fill =}\NormalTok{ value)) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ value), }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_reverse}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_binned}\NormalTok{(}\AttributeTok{type =} \StringTok{"viridis"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/cohort-ggplot2-1} \end{center}

留存是 \href{https://en.wikipedia.org/wiki/Cohort_analysis}{Cohort 分析} 中的一种情况，还有转化等，首先 定义你的问题，确定度量问题的指标，确定和问题相关的 Cohort （比如时间、空间和用户属性等关键的影响因素），然后数据处理、可视化获得 Cohort 分析结果，最后在实际决策和行动中检验分析结论。

\hypertarget{sec-ggplot2-waterfall}{%
\subsection{瀑布图}\label{sec-ggplot2-waterfall}}

瀑布图 waterfall 与上月相比，谁增谁减，用瀑布图分别表示占比和绝对数值。\href{https://vita.had.co.nz/papers/ggplot2-wires.pdf}{瀑布图 waterfall}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balance }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{event =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Starting}\SpecialCharTok{\textbackslash{}n}\StringTok{Cash"}\NormalTok{, }\StringTok{"Sales"}\NormalTok{, }\StringTok{"Refunds"}\NormalTok{,}
    \StringTok{"Payouts"}\NormalTok{, }\StringTok{"Court}\SpecialCharTok{\textbackslash{}n}\StringTok{Losses"}\NormalTok{, }\StringTok{"Court}\SpecialCharTok{\textbackslash{}n}\StringTok{Wins"}\NormalTok{, }\StringTok{"Contracts"}\NormalTok{, }\StringTok{"End}\SpecialCharTok{\textbackslash{}n}\StringTok{Cash"}
\NormalTok{  ),}
  \AttributeTok{change =} \FunctionTok{c}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\DecValTok{3400}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1100}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{6600}\NormalTok{, }\DecValTok{3800}\NormalTok{, }\DecValTok{1400}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{2800}\NormalTok{)}
\NormalTok{)}

\NormalTok{balance}\SpecialCharTok{$}\NormalTok{balance }\OtherTok{\textless{}{-}} \FunctionTok{cumsum}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, balance}\SpecialCharTok{$}\NormalTok{change[}\SpecialCharTok{{-}}\FunctionTok{nrow}\NormalTok{(balance)])) }\CommentTok{\# 累计值}
\NormalTok{balance}\SpecialCharTok{$}\NormalTok{time }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(balance)}
\NormalTok{balance}\SpecialCharTok{$}\NormalTok{flow }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}\FunctionTok{sign}\NormalTok{(balance}\SpecialCharTok{$}\NormalTok{change)) }\CommentTok{\# 变化为正还是为负}

\FunctionTok{ggplot}\NormalTok{(balance) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{colour =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_rect}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{xmin =}\NormalTok{ time }\SpecialCharTok{{-}} \FloatTok{0.45}\NormalTok{, }\AttributeTok{xmax =}\NormalTok{ time }\SpecialCharTok{+} \FloatTok{0.45}\NormalTok{,}
    \AttributeTok{ymin =}\NormalTok{ balance, }\AttributeTok{ymax =}\NormalTok{ balance }\SpecialCharTok{+}\NormalTok{ change, }\AttributeTok{fill =}\NormalTok{ flow}
\NormalTok{  )) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ time,}
    \AttributeTok{y =} \FunctionTok{pmin}\NormalTok{(balance, balance }\SpecialCharTok{+}\NormalTok{ change) }\SpecialCharTok{{-}} \DecValTok{50}\NormalTok{,}
    \AttributeTok{label =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{dollar}\NormalTok{(change)}
\NormalTok{  ),}
  \AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{vjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{name =} \StringTok{""}\NormalTok{,}
    \AttributeTok{breaks =}\NormalTok{ balance}\SpecialCharTok{$}\NormalTok{time,}
    \AttributeTok{labels =}\NormalTok{ balance}\SpecialCharTok{$}\NormalTok{event}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{name =} \StringTok{"Balance"}\NormalTok{,}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{dollar}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Spectral"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/waterfall-1} 

}

\caption{瀑布图}\label{fig:waterfall}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\CommentTok{\# AtherEnergy/ggTimeSeries}
\CommentTok{\# 个人收入，国家地区收入}
\FunctionTok{library}\NormalTok{(ggTimeSeries) }\CommentTok{\# https://github.com/AtherEnergy/ggTimeSeries}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{year =} \DecValTok{2000}\SpecialCharTok{:}\DecValTok{2021}\NormalTok{, }\AttributeTok{dpc =} \DecValTok{10}\SpecialCharTok{:}\DecValTok{31}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ year, }\AttributeTok{y =}\NormalTok{ dpc)) }\SpecialCharTok{+}
  \FunctionTok{stat\_waterfall}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-sankey}{%
\subsection{桑基图}\label{sec-ggplot2-sankey}}

\href{https://github.com/corybrunson/ggalluvial}{ggalluvial}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{titanic\_wide }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(Titanic)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(titanic\_wide)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Class    Sex   Age Survived Freq
## 1   1st   Male Child       No    0
## 2   2nd   Male Child       No    0
## 3   3rd   Male Child       No   35
## 4  Crew   Male Child       No    0
## 5   1st Female Child       No    0
## 6   2nd Female Child       No    0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggalluvial)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ titanic\_wide,}
       \FunctionTok{aes}\NormalTok{(}\AttributeTok{axis1 =}\NormalTok{ Class, }\AttributeTok{axis2 =}\NormalTok{ Sex, }\AttributeTok{axis3 =}\NormalTok{ Age,}
           \AttributeTok{y =}\NormalTok{ Freq)) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_discrete}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\StringTok{"Class"}\NormalTok{, }\StringTok{"Sex"}\NormalTok{, }\StringTok{"Age"}\NormalTok{), }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(.}\DecValTok{2}\NormalTok{, .}\DecValTok{05}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Demographic"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_alluvium}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ Survived)) }\SpecialCharTok{+}
  \FunctionTok{geom\_stratum}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{stat =} \StringTok{"stratum"}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{after\_stat}\NormalTok{(stratum))) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"passengers on the maiden voyage of the Titanic"}\NormalTok{,}
          \StringTok{"stratified by demographics and survival"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/ggalluvial-1} 

}

\caption{桑基图}\label{fig:ggalluvial}
\end{figure}

\hypertarget{ggplot2-wordcloud}{%
\subsection{词云图}\label{ggplot2-wordcloud}}

词云 \href{https://github.com/lepennec/ggwordcloud}{ggwordcloud}

\hypertarget{ggplot2-gantt}{%
\subsection{甘特图}\label{ggplot2-gantt}}

描述项目进展的甘特图 \href{https://github.com/giocomai/ganttrify}{ganttrify}

\hypertarget{sec-ggplot2-ggmosaic}{%
\subsection{马赛克图}\label{sec-ggplot2-ggmosaic}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggmosaic)}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{as.data.frame}\NormalTok{(UCBAdmissions)) }\SpecialCharTok{+}
  \FunctionTok{geom\_mosaic}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{weight =}\NormalTok{ Freq, }\AttributeTok{x =} \FunctionTok{product}\NormalTok{(Gender, Admit), }\AttributeTok{fill =}\NormalTok{ Dept)) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Admit"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Gender"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: `unite_()` was deprecated in tidyr 1.2.0.
## Please use `unite()` instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.
\end{verbatim}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/ucb-admissions-1} 

}

\caption{UCBAdmissions 马赛克图}\label{fig:ucb-admissions}
\end{figure}

\hypertarget{sec-ggplot2-bump}{%
\subsection{凹凸图}\label{sec-ggplot2-bump}}

\href{https://github.com/davidsjoberg/ggbump}{ggbump} 排序随位置的变化

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# remotes::install\_github("davidsjoberg/ggbump")}
\FunctionTok{library}\NormalTok{(ggbump)}
\CommentTok{\# 代码修改自 https://github.com/davidsjoberg/ggbump}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{season =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Spring"}\NormalTok{, }\StringTok{"Pre{-}season"}\NormalTok{, }\StringTok{"Summer"}\NormalTok{, }\StringTok{"Season finale"}\NormalTok{, }\StringTok{"Autumn"}\NormalTok{, }\StringTok{"Winter"}\NormalTok{,}
    \StringTok{"Spring"}\NormalTok{, }\StringTok{"Pre{-}season"}\NormalTok{, }\StringTok{"Summer"}\NormalTok{, }\StringTok{"Season finale"}\NormalTok{, }\StringTok{"Autumn"}\NormalTok{, }\StringTok{"Winter"}\NormalTok{,}
    \StringTok{"Spring"}\NormalTok{, }\StringTok{"Pre{-}season"}\NormalTok{, }\StringTok{"Summer"}\NormalTok{, }\StringTok{"Season finale"}\NormalTok{, }\StringTok{"Autumn"}\NormalTok{, }\StringTok{"Winter"}\NormalTok{,}
    \StringTok{"Spring"}\NormalTok{, }\StringTok{"Pre{-}season"}\NormalTok{, }\StringTok{"Summer"}\NormalTok{, }\StringTok{"Season finale"}\NormalTok{, }\StringTok{"Autumn"}\NormalTok{, }\StringTok{"Winter"}
\NormalTok{  ),}
  \AttributeTok{rank =} \FunctionTok{c}\NormalTok{(}
    \DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{,}
    \DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{,}
    \DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{,}
    \DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}
\NormalTok{  ),}
  \AttributeTok{player =} \FunctionTok{c}\NormalTok{(}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"David"}\NormalTok{, }\DecValTok{6}\NormalTok{),}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"Anna"}\NormalTok{, }\DecValTok{6}\NormalTok{),}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"Franz"}\NormalTok{, }\DecValTok{6}\NormalTok{),}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"Ika"}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}

\CommentTok{\# Create factors and order factor}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(df, }\AttributeTok{season =} \FunctionTok{factor}\NormalTok{(season, }\AttributeTok{levels =} \FunctionTok{unique}\NormalTok{(season)))}

\CommentTok{\# Add manual axis labels to plot}
\FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(season, rank, }\AttributeTok{color =}\NormalTok{ player)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bump}\NormalTok{(}\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{smooth =} \DecValTok{20}\NormalTok{, }\AttributeTok{show.legend =}\NormalTok{ F) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{shape =}\NormalTok{ player)) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{(}\AttributeTok{base\_size =} \DecValTok{10}\NormalTok{, }\AttributeTok{base\_line\_size =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ RColorBrewer}\SpecialCharTok{::}\FunctionTok{brewer.pal}\NormalTok{(}\AttributeTok{name =} \StringTok{"Set2"}\NormalTok{, }\AttributeTok{n =} \DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/ggbump-1} 

}

\caption{凹凸图}\label{fig:ggbump}
\end{figure}

\hypertarget{sec-ggplot2-streamgraph}{%
\subsection{水流图}\label{sec-ggplot2-streamgraph}}

常用于时间序列数据展示的堆积区域图，\href{https://github.com/davidsjoberg/ggstream}{ggstream} 和 \href{https://github.com/hrbrmstr/streamgraph}{streamgraph}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggstream)}

\FunctionTok{ggplot}\NormalTok{(blockbusters, }\FunctionTok{aes}\NormalTok{(year, box\_office, }\AttributeTok{fill =}\NormalTok{ genre)) }\SpecialCharTok{+}
  \FunctionTok{geom\_stream}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{data-visualization_files/figure-latex/stream-graph-1} 

}

\caption{堆积区域图}\label{fig:stream-graph}
\end{figure}

\hypertarget{sec-ggplot2-vistime}{%
\subsection{时间线}\label{sec-ggplot2-vistime}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 交互动态图 https://github.com/shosaco/vistime}
\CommentTok{\# 刘思喆 2018 数据科学的时间轴 https://bjt.name/2018/11/18/timeline.html}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}
  \FunctionTok{textConnection}\NormalTok{(}\StringTok{"}
\StringTok{The Future of Data Analysis,1962}
\StringTok{Relational Database,1970}
\StringTok{Data science(Peter Naur),1974}
\StringTok{Two{-}Way Communication,1975}
\StringTok{Exploratory Data Analysis,1977}
\StringTok{Business Intelligence,1989}
\StringTok{The First Database Report,1992}
\StringTok{The World Wide Web Explodes,1995}
\StringTok{Data Mining and Knowledge Discovery,1997}
\StringTok{S(ACM Software System Award),1998}
\StringTok{Statistical Modeling: The Two Cultures,2001}
\StringTok{Hadoop,2006}
\StringTok{Data scientist,2008}
\StringTok{NOSQL,2009}
\StringTok{Deep Learning,2015}
\StringTok{"}\NormalTok{),}
  \AttributeTok{sep =} \StringTok{","}
\NormalTok{)}
\FunctionTok{names}\NormalTok{(x) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Event"}\NormalTok{, }\StringTok{"EventDate"}\NormalTok{)}
\NormalTok{x}\SpecialCharTok{$}\NormalTok{EventDate }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{paste}\NormalTok{(x}\SpecialCharTok{$}\NormalTok{EventDate, }\StringTok{"/01/01"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{))}

\FunctionTok{library}\NormalTok{(timelineS)}
\FunctionTok{timelineS}\NormalTok{(x,}
  \AttributeTok{labels =} \FunctionTok{paste}\NormalTok{(x[[}\DecValTok{1}\NormalTok{]], }\FunctionTok{format}\NormalTok{(x[[}\DecValTok{2}\NormalTok{]], }\StringTok{"\%Y"}\NormalTok{)),}
  \AttributeTok{line.color =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{label.angle =} \DecValTok{15}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/vis-timeline-1} 

}

\caption{数据科学的时间轴}\label{fig:vis-timeline}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(timeline)}
\FunctionTok{data}\NormalTok{(ww2, }\AttributeTok{package =} \StringTok{\textquotesingle{}timeline\textquotesingle{}}\NormalTok{)}
\FunctionTok{timeline}\NormalTok{(ww2, ww2.events, }\AttributeTok{event.spots=}\DecValTok{2}\NormalTok{, }\AttributeTok{event.label=}\StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{, }\AttributeTok{event.above=}\ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 适合放在动态幻灯片}
\CommentTok{\# 美团风格的写轮眼}
\CommentTok{\# 时间线}
\FunctionTok{library}\NormalTok{(vistime)}
\CommentTok{\# presidents and vice presidents}
\NormalTok{pres }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Position =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"President"}\NormalTok{, }\StringTok{"Vice"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{),}
  \AttributeTok{Name =} \FunctionTok{c}\NormalTok{(}\StringTok{"Washington"}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Adams"}\NormalTok{, }\StringTok{"Jefferson"}\NormalTok{), }\DecValTok{2}\NormalTok{), }\StringTok{"Burr"}\NormalTok{),}
  \AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\StringTok{"1789{-}03{-}29"}\NormalTok{, }\StringTok{"1797{-}02{-}03"}\NormalTok{, }\StringTok{"1801{-}02{-}03"}\NormalTok{),}
  \AttributeTok{end =} \FunctionTok{c}\NormalTok{(}\StringTok{"1797{-}02{-}03"}\NormalTok{, }\StringTok{"1801{-}02{-}03"}\NormalTok{, }\StringTok{"1809{-}02{-}03"}\NormalTok{),}
  \AttributeTok{color =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#cbb69d"}\NormalTok{, }\StringTok{"\#603913"}\NormalTok{, }\StringTok{"\#c69c6e"}\NormalTok{)}
\NormalTok{)}

\FunctionTok{hc\_vistime}\NormalTok{(pres, }\AttributeTok{col.event =} \StringTok{"Position"}\NormalTok{, }\AttributeTok{col.group =} \StringTok{"Name"}\NormalTok{, }
           \AttributeTok{title =} \StringTok{"Presidents of the USA"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-ternary}{%
\subsection{三元图}\label{sec-ggplot2-ternary}}

\href{https://github.com/ms609/Ternary/}{Ternary} 使用基础图形库，而 \href{https://bitbucket.org/nicholasehamilton/ggtern}{ggtern} 使用 ggplot2 绘制

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggtern)}
\FunctionTok{library}\NormalTok{(ggalt)}
\FunctionTok{data}\NormalTok{(}\StringTok{"Fragments"}\NormalTok{)}
\FunctionTok{ggtern}\NormalTok{(Fragments, }\FunctionTok{aes}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ Qm, }\AttributeTok{y =}\NormalTok{ Qp, }\AttributeTok{z =}\NormalTok{ Rf }\SpecialCharTok{+}\NormalTok{ M,}
  \AttributeTok{fill =}\NormalTok{ GrainSize, }\AttributeTok{shape =}\NormalTok{ GrainSize}
\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_encircle}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Example Plot"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"using geom\_encircle"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_legend\_position}\NormalTok{(}\StringTok{"tr"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-vector-fields}{%
\subsection{向量场图}\label{sec-vector-fields}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggquiver)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplot2-eisenhower}{%
\subsection{四象限图}\label{sec-ggplot2-eisenhower}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{perc =} \FunctionTok{c}\NormalTok{(}\DecValTok{54}\NormalTok{, }\DecValTok{18}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{),}
  \AttributeTok{wall\_policy =} \FunctionTok{c}\NormalTok{(}\StringTok{"oppose"}\NormalTok{, }\StringTok{"favor"}\NormalTok{, }\StringTok{"oppose"}\NormalTok{, }\StringTok{"favor"}\NormalTok{),}
  \AttributeTok{dreamer\_policy =} \FunctionTok{c}\NormalTok{(}\StringTok{"favor"}\NormalTok{, }\StringTok{"favor"}\NormalTok{, }\StringTok{"oppose"}\NormalTok{, }\StringTok{"oppose"}\NormalTok{),}
  \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}
    \AttributeTok{xmin =} \FunctionTok{ifelse}\NormalTok{(wall\_policy }\SpecialCharTok{==} \StringTok{"oppose"}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{sqrt}\NormalTok{(perc), }\DecValTok{0}\NormalTok{),}
    \AttributeTok{xmax =} \FunctionTok{ifelse}\NormalTok{(wall\_policy }\SpecialCharTok{==} \StringTok{"favor"}\NormalTok{, }\FunctionTok{sqrt}\NormalTok{(perc), }\DecValTok{0}\NormalTok{),}
    \AttributeTok{ymin =} \FunctionTok{ifelse}\NormalTok{(dreamer\_policy }\SpecialCharTok{==} \StringTok{"oppose"}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{sqrt}\NormalTok{(perc), }\DecValTok{0}\NormalTok{),}
    \AttributeTok{ymax =} \FunctionTok{ifelse}\NormalTok{(dreamer\_policy }\SpecialCharTok{==} \StringTok{"favor"}\NormalTok{, }\FunctionTok{sqrt}\NormalTok{(perc), }\DecValTok{0}\NormalTok{)}
\NormalTok{  )}

\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{+}
  \FunctionTok{geom\_rect}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{xmin =}\NormalTok{ xmin, }\AttributeTok{xmax =}\NormalTok{ xmax,}
    \AttributeTok{ymin =}\NormalTok{ ymin, }\AttributeTok{ymax =}\NormalTok{ ymax}
\NormalTok{  ), }\AttributeTok{fill =} \StringTok{"grey"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ xmin }\SpecialCharTok{+} \FloatTok{0.5} \SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(perc),}
    \AttributeTok{y =}\NormalTok{ ymin }\SpecialCharTok{+} \FloatTok{0.5} \SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(perc),}
    \AttributeTok{label =}\NormalTok{ perc}
\NormalTok{  ),}
  \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{coord\_equal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{title =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/eisenhower-1} 

}

\caption{四象限图}\label{fig:eisenhower}
\end{figure}

\hypertarget{sec-ggplot2-venn}{%
\subsection{韦恩图}\label{sec-ggplot2-venn}}

\href{https://github.com/gaospecial/ggVennDiagram}{ggVennDiagram}

\hypertarget{sec-ggplot2-tornado}{%
\subsection{龙卷风图}\label{sec-ggplot2-tornado}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{variable =} \FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{),}
  \AttributeTok{Level =} \FunctionTok{c}\NormalTok{(}\StringTok{"Top{-}2"}\NormalTok{, }\StringTok{"Top{-}2"}\NormalTok{, }\StringTok{"Bottom{-}2"}\NormalTok{, }\StringTok{"Bottom{-}2"}\NormalTok{),}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(.}\DecValTok{8}\NormalTok{, .}\DecValTok{7}\NormalTok{, }\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\NormalTok{.}\DecValTok{3}\NormalTok{)}
\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ variable, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{fill =}\NormalTok{ Level)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ abs) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/tornado-ggplot2-1} 

}

\caption{龙卷风图展示变量重要性}\label{fig:tornado-ggplot2}
\end{figure}

\href{https://en.wikipedia.org/wiki/Tornado_diagram}{Tornado diagram} 主要用于敏感性分析，比较不同变量的重要性程度。条形图 \texttt{geom\_bar()} 图层的变体，模型权重可视化的手段，仅限于广义线性模型。

\hypertarget{sec-ggplot2-hclust}{%
\subsection{聚类图}\label{sec-ggplot2-hclust}}

ggdendro 的 \texttt{dendro\_data()} 函数支持 \texttt{tree} 、\texttt{hclust} 、\texttt{dendrogram} 和 \texttt{rpart} 结果的整理，进而绘图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggdendro)}
\NormalTok{hc }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(USArrests), }\StringTok{"ave"}\NormalTok{)}
\NormalTok{hcdata }\OtherTok{\textless{}{-}} \FunctionTok{dendro\_data}\NormalTok{(hc, }\AttributeTok{type =} \StringTok{"rectangle"}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =} \FunctionTok{segment}\NormalTok{(hcdata), }
               \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{xend =}\NormalTok{ xend, }\AttributeTok{yend =}\NormalTok{ yend)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =} \FunctionTok{label}\NormalTok{(hcdata), }
            \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{label =}\NormalTok{ label, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{), }
            \AttributeTok{size =} \DecValTok{3}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_reverse}\NormalTok{(}\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/unnamed-chunk-73-1} \end{center}

\hypertarget{sec-ggplot2-prcomp}{%
\subsection{主成分图}\label{sec-ggplot2-prcomp}}

借助 \href{https://github.com/terrytangyuan/autoplotly}{\textbf{autoplotly}} 包 \citep{autoplotly} 可将函数 \texttt{stats::prcomp} 生成的结果转化为交互图形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pca }\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(iris[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{)])}
\FunctionTok{plot}\NormalTok{(pca)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{data-visualization_files/figure-latex/pac-plot-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(autoplotly)}
\FunctionTok{autoplotly}\NormalTok{(pca,}
  \AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{colour =} \StringTok{"Species"}\NormalTok{,}
  \AttributeTok{label =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{label.size =} \DecValTok{3}\NormalTok{, }\AttributeTok{frame =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/sinhrks/ggfortify}{\textbf{ggfortify}} \citep{Tang_2016_ggfortify} 包将主成分分析图转化为静态图形

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggfortify)}
\FunctionTok{autoplot}\NormalTok{(pca, }\AttributeTok{data =}\NormalTok{ iris, }\AttributeTok{colour =} \StringTok{\textquotesingle{}Species\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/pca-ggplot2-1} 

}

\caption{主成分分析}\label{fig:pca-ggplot2}
\end{figure}

\hypertarget{sec-ggplot2-composite}{%
\subsection{组合图}\label{sec-ggplot2-composite}}

组合的意思是将不同种类的图形绘制在一个区域中，比如密度曲线和地毯图\footnote{其实是轴须图 rug plot，只因样子看起来像铺在地上的毛毯，故而称之为地毯图，对应于 R 内置的 \texttt{rug()} 函数或 ggplot2 提供的图层 \texttt{geom\_rug()}，更多解释详见 \url{https://en.wikipedia.org/wiki/Rug_plot}。}组合。 \href{https://github.com/ggobi/ggally}{\textbf{GGally}}、 \href{https://github.com/const-ae/ggupset}{\textbf{ggupset}}、 \href{https://github.com/thomas-neitmann/ggcharts}{ggcharts} 和 \href{https://github.com/kassambara/ggpubr}{\textbf{ggpubr}} 高度定制了一些组合统计图形，以 ggpubr 为例，见图 \ref{fig:ggpubr-composite}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggpubr)}
\FunctionTok{ggdensity}\NormalTok{(sleep,}
  \AttributeTok{x =} \StringTok{"extra"}\NormalTok{, }\AttributeTok{add =} \StringTok{"mean"}\NormalTok{, }\AttributeTok{rug =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{color =} \StringTok{"group"}\NormalTok{,}
  \AttributeTok{fill =} \StringTok{"group"}\NormalTok{, }\AttributeTok{palette =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#00AFBB"}\NormalTok{, }\StringTok{"\#E7B800"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/ggpubr-composite-1} 

}

\caption{组合图形}\label{fig:ggpubr-composite}
\end{figure}

上面介绍的都是已经固化的组合方式，一般地，将多个图形组合到一个图中，可以有很多办法，比如 Claus Wilke 开发的 \href{https://github.com/wilkelab/cowplot}{\textbf{cowplot}} ，在他的书里 \href{http://serialmentor.com/dataviz}{Fundamentals of Data Visualization} 大量使用，后起之秀 \href{https://github.com/thomasp85/patchwork}{\textbf{patchwork}} 则提供更加简洁的组合语法，非常受欢迎，更加底层的拼接方法可以去看 \href{https://msg-book.netlify.app/tricks.html\#sec-multipage}{一页多图} 和 R 内置的 grid 系统。

\hypertarget{sec-ggplot2-animation}{%
\subsection{动态图}\label{sec-ggplot2-animation}}

\href{https://github.com/ropensci/av}{\textbf{av}} 包基于 \href{https://github.com/FFmpeg/FFmpeg}{FFmpeg} 将静态图片合成视频，而 \href{https://github.com/r-rust/gifski/}{\textbf{gifski}} 包基于 \href{https://gif.ski/}{gifski} 将静态图片合成 GIF 动画，\href{https://github.com/yihui/animation}{\textbf{animation}} 包 \citep{Xie_2013_animation} 将 Base R 绘制的图形转化为动画或视频，\href{https://github.com/leonawicz/mapmate}{mapmate} 制作地图相关的三维可视化图形，\href{https://github.com/thomasp85/gganimate}{\textbf{gganimate}} 包支持将 ggplot2 生成的图形，\textbf{magick} 可以将一系列静态图形合成动态图形，借助 \textbf{gifski} 包转化为动态图片或视频。推荐读者从 \href{https://github.com/ropenscilabs/learngganimate}{gganimate 案例合集} 开始制作动态图形。 \href{https://r-forge.r-project.org/projects/rgl/}{\textbf{rgl}} 可以制作真三维动态图形，支持缩放、拖拽、旋转等操作， \href{https://github.com/tylermorganwall/rayshader}{\textbf{rayshader}} 还支持转化 ggplot2 对象为 3D 图形。

数据集 Indometh 记录了药物在人体中的代谢情况，给 6 个人分别静脉注射了吲哚美辛，每隔一段时间抽血检查药物在血浆中的浓度，收集的数据见表 \ref{tab:indometh-data}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reshape}\NormalTok{(Indometh, }\AttributeTok{v.names =} \StringTok{"conc"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"Subject"}\NormalTok{, }
        \AttributeTok{timevar =} \StringTok{"time"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(.,}
    \AttributeTok{caption =} \StringTok{"吲哚美辛在人体中的代谢情况"}\NormalTok{,}
    \AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col.names =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(conc)"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{names}\NormalTok{(.)),}
    \AttributeTok{align =} \StringTok{"c"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{table}

\caption{\label{tab:indometh-data}吲哚美辛在人体中的代谢情况}
\centering
\begin{tabular}[t]{c|c|c|c|c|c|c|c|c|c|c|c}
\hline
Subject & 0.25 & 0.5 & 0.75 & 1 & 1.25 & 2 & 3 & 4 & 5 & 6 & 8\\
\hline
1 & 1.50 & 0.94 & 0.78 & 0.48 & 0.37 & 0.19 & 0.12 & 0.11 & 0.08 & 0.07 & 0.05\\
\hline
2 & 2.03 & 1.63 & 0.71 & 0.70 & 0.64 & 0.36 & 0.32 & 0.20 & 0.25 & 0.12 & 0.08\\
\hline
3 & 2.72 & 1.49 & 1.16 & 0.80 & 0.80 & 0.39 & 0.22 & 0.12 & 0.11 & 0.08 & 0.08\\
\hline
4 & 1.85 & 1.39 & 1.02 & 0.89 & 0.59 & 0.40 & 0.16 & 0.11 & 0.10 & 0.07 & 0.07\\
\hline
5 & 2.05 & 1.04 & 0.81 & 0.39 & 0.30 & 0.23 & 0.13 & 0.11 & 0.08 & 0.10 & 0.06\\
\hline
6 & 2.31 & 1.44 & 1.03 & 0.84 & 0.64 & 0.42 & 0.24 & 0.17 & 0.13 & 0.10 & 0.09\\
\hline
\end{tabular}
\end{table}

如图 \ref{fig:indometh-concentration} 所示，药物在人体中浓度变化情况

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ Indometh,}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ time, }\AttributeTok{y =}\NormalTok{ conc, }\AttributeTok{color =}\NormalTok{ Subject)}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"time (hr)"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"plasma concentrations of indometacin (mcg/ml)"}
\NormalTok{  )}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/indometh-concentration-1} 

}

\caption{药物在人体中的代谢情况}\label{fig:indometh-concentration}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gganimate)}
\NormalTok{p }\SpecialCharTok{+} \FunctionTok{transition\_reveal}\NormalTok{(time)}
\end{Highlighting}
\end{Shaded}

\begin{center}\animategraphics[,controls,loop]{10}{data-visualization_files/figure-latex/indometh-animate-}{1}{100}\end{center}

\begin{rmdtip}{提示}
书籍目标输出格式是 PDF，则在代码块选项设置里必须指定参数 \texttt{fig.show=\textquotesingle{}animate\textquotesingle{}} 否则插入的只是图片而不是动画， 目标格式是 HTML 网页， 就不必指定参数，默认会将图片合成 GIF 动态图，嵌入 PDF 里面的动画需要 Acrobat Reader 阅读器才能正确地显示。

\end{rmdtip}

动态图形制作的原理，简单来说，就是将一帧帧静态图形以较快的速度播放，人眼形成视觉残留，以为是连续的画面，相比于 animation， \textbf{gganimate} 借助 \textbf{tweenr} 包添加了过渡效果，动态图形显得非常自然。下面以 cup 函数\footnote{函数来自余光创的博客 --- \href{https://guangchuangyu.github.io/cn/2017/09/3d-breast/}{3D 版邪恶的曲线} ，此处借用 gganimate 将其动态化，前方高能，少儿不宜，R 还能这么不正经的玩。}为例

\[f(x;\theta,\phi) = \theta x\log(x)-\frac{1}{\phi}\mathit{e}^{-\phi^4(x-\frac{1}{\mathit{e}})^4}, \quad \theta \in (2,3), \phi \in (30,50), x \in (0,1)\] 函数图像随着 \(\theta\) 和 \(\phi\) 的变化情况见图 \ref{fig:cup-curve}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tweenr)}
\NormalTok{cup\_curve }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \DecValTok{100}\NormalTok{, }\AttributeTok{theta =} \DecValTok{3}\NormalTok{, }\AttributeTok{phi =} \DecValTok{30}\NormalTok{, }\AttributeTok{cup =} \StringTok{"A"}\NormalTok{) \{}
  \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.00001}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =}\NormalTok{ n), }\AttributeTok{cup =}\NormalTok{ cup) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{transform}\NormalTok{(}\AttributeTok{y =}\NormalTok{ theta }\SpecialCharTok{*}\NormalTok{ x }\SpecialCharTok{*} \FunctionTok{log}\NormalTok{(x, }\AttributeTok{base =} \DecValTok{10}\NormalTok{) }
              \SpecialCharTok{{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ phi }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(phi }\SpecialCharTok{*}\NormalTok{ x }\SpecialCharTok{{-}}\NormalTok{ phi }\SpecialCharTok{/} \FunctionTok{exp}\NormalTok{(}\DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
\NormalTok{\}}
\FunctionTok{mapply}\NormalTok{(}
  \AttributeTok{FUN =}\NormalTok{ cup\_curve, }\AttributeTok{theta =} \FunctionTok{c}\NormalTok{(}\AttributeTok{E =} \DecValTok{3}\NormalTok{, }\AttributeTok{D =} \FloatTok{2.8}\NormalTok{, }\AttributeTok{C =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{B =} \FloatTok{2.2}\NormalTok{, }\AttributeTok{A =} \DecValTok{2}\NormalTok{),}
  \AttributeTok{phi =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{33}\NormalTok{, }\DecValTok{36}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{50}\NormalTok{), }\AttributeTok{cup =} \FunctionTok{c}\NormalTok{(}\StringTok{"E"}\NormalTok{, }\StringTok{"D"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"A"}\NormalTok{),}
  \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{n =} \DecValTok{50}\NormalTok{), }\AttributeTok{SIMPLIFY =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{USE.NAMES =} \ConstantTok{TRUE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tween\_states}\NormalTok{(}
    \AttributeTok{data =}\NormalTok{ .,}
    \AttributeTok{tweenlength =} \DecValTok{2}\NormalTok{, }\AttributeTok{statelength =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{ease =} \FunctionTok{rep}\NormalTok{(}\StringTok{"cubic{-}in{-}out"}\NormalTok{, }\DecValTok{4}\NormalTok{), }\AttributeTok{nframes =} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ., }\FunctionTok{aes}\NormalTok{(x, y, }\AttributeTok{color =}\NormalTok{ cup, }\AttributeTok{frame =}\NormalTok{ .frame)) }\SpecialCharTok{+}
  \FunctionTok{geom\_path}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_void}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{data-visualization_files/figure-latex/cup-curve-1} 

}

\caption{添加过渡效果}\label{fig:cup-curve}
\end{figure}

\hypertarget{chap-interactive-web-graphics}{%
\chapter{交互图形}\label{chap-interactive-web-graphics}}

\href{https://github.com/ropensci/plotly}{plotly} 是一个功能非常强大的绘制交互式图形的 R 包。它支持下载图片、添加水印、自定义背景图片、工具栏和注释\footnote{\url{https://plotly.com/r/reference/\#layout-scene-annotations-items-annotation-font}} 等一系列细节的自定义控制。下面结合 JavaScript 库 \href{https://github.com/plotly/plotly.js}{plotly.js} 一起介绍，帮助文档 \texttt{?config} 没有太详细地介绍，所以我们看看 \texttt{config()} 函数中参数 \texttt{...} 和 JavaScript 库 \href{https://github.com/plotly/plotly.js/blob/master/src/plot_api/plot_config.js}{plot\_config.js} 中的功能函数是怎么对应的。图 中图片下载按钮对应 \texttt{toImageButtonOptions} 参数， 看 \href{https://github.com/plotly/plotly.js/blob/master/src/plot_api/plot_config.js\#L311}{toImageButtonOptions} 源代码，可知，它接受任意数据类型，对应到 R 里面就是列表。 \texttt{watermark} 和 \texttt{displaylogo} 都是传递布尔值（TRUE/FALSE），具体根据 JavaScript 代码中的 valType （参数值类型）决定，其它参数类似。另一个函数 \href{https://plot.ly/r/reference/\#Layout_and_layout_style_objects}{layout} 和函数 \texttt{config()} 是类似的，怎么传递参数值是根据 JavaScript 代码来的。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{toImageButtonOptions}\OperatorTok{:}\NormalTok{ \{}
    \DataTypeTok{valType}\OperatorTok{:} \StringTok{\textquotesingle{}any\textquotesingle{}}\OperatorTok{,}
    \DataTypeTok{dflt}\OperatorTok{:}\NormalTok{ \{\}}\OperatorTok{,}
    \DataTypeTok{description}\OperatorTok{:}\NormalTok{ [}
        \StringTok{\textquotesingle{}Statically override options for toImage modebar button\textquotesingle{}}\OperatorTok{,}
        \StringTok{\textquotesingle{}allowed keys are format, filename, width, height, scale\textquotesingle{}}\OperatorTok{,}
        \StringTok{\textquotesingle{}see ../components/modebar/buttons.js\textquotesingle{}}
\NormalTok{    ]}\OperatorTok{.}\FunctionTok{join}\NormalTok{(}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\NormalTok{\}}\OperatorTok{,}
\NormalTok{displaylogo}\OperatorTok{:}\NormalTok{ \{}
    \DataTypeTok{valType}\OperatorTok{:} \StringTok{\textquotesingle{}boolean\textquotesingle{}}\OperatorTok{,}
    \DataTypeTok{dflt}\OperatorTok{:} \KeywordTok{true}\OperatorTok{,}
    \DataTypeTok{description}\OperatorTok{:}\NormalTok{ [}
        \StringTok{\textquotesingle{}Determines whether or not the plotly logo is displayed\textquotesingle{}}\OperatorTok{,}
        \StringTok{\textquotesingle{}on the end of the mode bar.\textquotesingle{}}
\NormalTok{    ]}\OperatorTok{.}\FunctionTok{join}\NormalTok{(}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\NormalTok{\}}\OperatorTok{,}
\NormalTok{watermark}\OperatorTok{:}\NormalTok{ \{}
    \DataTypeTok{valType}\OperatorTok{:} \StringTok{\textquotesingle{}boolean\textquotesingle{}}\OperatorTok{,}
    \DataTypeTok{dflt}\OperatorTok{:} \KeywordTok{false}\OperatorTok{,}
    \DataTypeTok{description}\OperatorTok{:} \StringTok{\textquotesingle{}watermark the images with the company}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{s logo\textquotesingle{}}
\NormalTok{\}}\OperatorTok{,}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(plotly, }\AttributeTok{warn.conflicts =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{price,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{colors =} \StringTok{"Set1"}\NormalTok{, }\AttributeTok{type =} \StringTok{"box"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{toImageButtonOptions =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{format =} \StringTok{"svg"}\NormalTok{, }\AttributeTok{width =} \DecValTok{450}\NormalTok{, }\AttributeTok{height =} \DecValTok{300}\NormalTok{,}
      \AttributeTok{filename =} \FunctionTok{paste}\NormalTok{(}\StringTok{"plot"}\NormalTok{, }\FunctionTok{Sys.Date}\NormalTok{(), }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{)}
\NormalTok{    ), }
    \AttributeTok{modeBarButtons =} \FunctionTok{list}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\StringTok{"toImage"}\NormalTok{)),}
    \AttributeTok{watermark =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{displaylogo =} \ConstantTok{FALSE}\NormalTok{, }
    \AttributeTok{locale =} \StringTok{"zh{-}CN"}\NormalTok{, }
    \AttributeTok{staticPlot =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{showLink =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{modeBarButtonsToRemove =} \FunctionTok{c}\NormalTok{(}
      \StringTok{"hoverClosestCartesian"}\NormalTok{, }\StringTok{"hoverCompareCartesian"}\NormalTok{, }
      \StringTok{"zoom2d"}\NormalTok{, }\StringTok{"zoomIn2d"}\NormalTok{, }\StringTok{"zoomOut2d"}\NormalTok{, }
      \StringTok{"autoScale2d"}\NormalTok{, }\StringTok{"resetScale2d"}\NormalTok{, }\StringTok{"pan2d"}\NormalTok{,}
      \StringTok{"toggleSpikelines"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{template =} \StringTok{"plotly\_dark"}\NormalTok{,}
    \AttributeTok{images =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{source =} \StringTok{"https://images.plot.ly/language{-}icons/api{-}home/r{-}logo.png"}\NormalTok{,}
      \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{,}
      \AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
      \AttributeTok{x =} \FloatTok{1.00}\NormalTok{,}
      \AttributeTok{y =} \FloatTok{0.25}\NormalTok{,}
      \AttributeTok{sizex =} \FloatTok{0.2}\NormalTok{,}
      \AttributeTok{sizey =} \FloatTok{0.2}\NormalTok{,}
      \AttributeTok{opacity =} \FloatTok{0.5}
\NormalTok{    ),}
    \AttributeTok{annotations =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{text =} \StringTok{"DRAFT"}\NormalTok{,               }\CommentTok{\# 水印文本}
      \AttributeTok{textangle =} \SpecialCharTok{{-}}\DecValTok{30}\NormalTok{,              }\CommentTok{\# 逆时针旋转 30 度}
      \AttributeTok{font =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{size =} \DecValTok{40}\NormalTok{,                  }\CommentTok{\# 字号}
        \AttributeTok{color =} \StringTok{"gray"}\NormalTok{,             }\CommentTok{\# 颜色}
        \AttributeTok{family =} \StringTok{"Times New Roman"}  \CommentTok{\# 字族}
\NormalTok{      ),}
      \AttributeTok{opacity =} \FloatTok{0.2}\NormalTok{,                }\CommentTok{\# 透明度}
      \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{,}
      \AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
      \AttributeTok{x =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{y =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{showarrow =} \ConstantTok{FALSE}             \CommentTok{\# 去掉箭头指示}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:plotly-config} 交互图形的设置函数 \texttt{config()} 各个参数及其作用（部分）}\tabularnewline
\toprule
参数 & 作用 \\
\midrule
\endfirsthead
\toprule
参数 & 作用 \\
\midrule
\endhead
displayModeBar & 是否显示交互图形上的工具条，默认显示 \texttt{TRUE}\footnote{\url{https://plotly-r.com/control-modebar.html}。}。 \\
modeBarButtons & 工具条上保留的工具，如下载 \texttt{"toImage"}，缩放 \texttt{"zoom2d"}\footnote{完整的列表见 \url{https://github.com/plotly/plotly.js/blob/master/src/components/modebar/buttons.js}。}。 \\
modeBarButtonsToRemove & 工具条上要移除的工具，如下载和缩放图片 \texttt{c("toImage",\ "zoom2d")}。 \\
toImageButtonOptions & 工具条上下载图片的选项设置，包括名称、类型、尺寸等。\footnote{设置下载图片的尺寸，还可设置为 PNG 格式，SVG 格式图片，可借助 \textbf{rsvg} 的 \texttt{rsvg\_pdf()} 函数转化为 PDF 格式 \url{https://github.com/ropensci/plotly/issues/1556\#issuecomment-505833092}。} \\
displaylogo & 是否交显示互图形上 Plotly 的图标，默认显示 \texttt{TRUE}\footnote{\url{https://plotly.com/r/logos/}。}。 \\
staticPlot & 是否将交互图形转为静态图形，默认 \texttt{FALSE}。 \\
locale & 本土化语言设置，比如 \texttt{"zh-CN"} 表示中文。 \\
\bottomrule
\end{longtable}

\hypertarget{sec-plotly-scatter}{%
\section{散点图}\label{sec-plotly-scatter}}

\begin{longtable}[]{@{}ll@{}}
\caption{\label{tab:plotly-scatter-functions} 散点图类型}\tabularnewline
\toprule
类型 & 名称 \\
\midrule
\endfirsthead
\toprule
类型 & 名称 \\
\midrule
\endhead
\texttt{scattercarpet} & 地毯图 \\
\texttt{scatterternary} & 三元图 \\
\texttt{scatter3d} & 三维散点图 \\
\texttt{scattergeo} & 地图散点图 \\
\texttt{scattermapbox} & 地图散点图 Mapbox \\
\texttt{scatter} & 散点图 \\
\texttt{scattergl} & 散点图 GL \\
\texttt{scatterpolar} & 极坐标散点图 \\
\texttt{scatterpolargl} & 极坐标散点图 GL \\
\bottomrule
\end{longtable}

plotly.js 提供很多图层用于绘制各类图形 \url{https://github.com/plotly/plotly.js/tree/master/src/traces}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 折线图}
\FunctionTok{plot\_ly}\NormalTok{(Orange,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{age, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{circumference, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Tree,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-barplot}{%
\section{条形图}\label{sec-plotly-barplot}}

日常使用最多的图形无外乎散点图、柱形图（分组、堆积、百分比堆积等）

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 简单条形图}
\FunctionTok{library}\NormalTok{(data.table)}
\NormalTok{diamonds }\OtherTok{\textless{}{-}} \FunctionTok{as.data.table}\NormalTok{(diamonds)}

\NormalTok{p11 }\OtherTok{\textless{}{-}}\NormalTok{ diamonds[, .(}\AttributeTok{cnt =}\NormalTok{ .N), by }\OtherTok{=}\NormalTok{ .(cut)] }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cnt, }\AttributeTok{type =} \StringTok{"bar"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_text}\NormalTok{(}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{comma}\NormalTok{(cnt), }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cnt,}
    \AttributeTok{textposition =} \StringTok{"top middle"}\NormalTok{,}
    \AttributeTok{cliponaxis =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{showlegend =} \ConstantTok{FALSE}
\NormalTok{  )}
\CommentTok{\# 分组条形图}
\NormalTok{p12 }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Accent"}\NormalTok{, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{) }
\CommentTok{\# 堆积条形图}
\NormalTok{p13 }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Accent"}\NormalTok{, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{barmode =} \StringTok{"stack"}\NormalTok{)}
\CommentTok{\# 百分比堆积条形图}
\CommentTok{\# p14 \textless{}{-} plot\_ly(diamonds,}
\CommentTok{\#   x = \textasciitilde{}cut, color = \textasciitilde{}clarity,}
\CommentTok{\#   colors = "Accent", type = "histogram"}
\CommentTok{\# ) \%\textgreater{}\%}
\CommentTok{\#   layout(barmode = "stack", barnorm = "percent") \%\textgreater{}\%}
\CommentTok{\#   config(displayModeBar = F)}

\CommentTok{\# 推荐使用如下方式绘制堆积条形图}
\NormalTok{dat }\OtherTok{=}\NormalTok{ diamonds[, .(}\AttributeTok{cnt =} \FunctionTok{length}\NormalTok{(carat)), by }\OtherTok{=}\NormalTok{ .(clarity, cut)] }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  .[, pct }\SpecialCharTok{:}\ErrorTok{=} \FunctionTok{round}\NormalTok{(}\DecValTok{100} \SpecialCharTok{*}\NormalTok{ cnt }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(cnt), }\DecValTok{2}\NormalTok{), by }\OtherTok{=}\NormalTok{ .(cut)]}

\NormalTok{p14 }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{pct, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity,}
  \AttributeTok{colors =} \StringTok{"Set3"}\NormalTok{, }\AttributeTok{type =} \StringTok{"bar"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{barmode =} \StringTok{"stack"}\NormalTok{)}

\NormalTok{htmltools}\SpecialCharTok{::}\FunctionTok{tagList}\NormalTok{(p11, p12, p13, p14)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-lineplot}{%
\section{折线图}\label{sec-plotly-lineplot}}

其它常见的图形还要折线图、直方图、箱线图和提琴图

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 折线图}
\FunctionTok{plot\_ly}\NormalTok{(Orange,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{age, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{circumference, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Tree,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers+lines"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-multiple-y-axes}{%
\section{双轴图}\label{sec-multiple-y-axes}}

\href{https://plotly.com/r/multiple-axes/}{双轴图}

模拟一组数据

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{dt =} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020{-}01{-}01"}\NormalTok{), }\AttributeTok{to =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020{-}01{-}31"}\NormalTok{), }\AttributeTok{by =} \StringTok{"day"}\NormalTok{),}
  \AttributeTok{search\_qv =} \FunctionTok{sample}\NormalTok{(}\DecValTok{100000}\SpecialCharTok{:}\DecValTok{1000000}\NormalTok{, }\AttributeTok{size =} \DecValTok{31}\NormalTok{, }\AttributeTok{replace =}\NormalTok{ T)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{valid\_click\_qv =} \FunctionTok{sapply}\NormalTok{(search\_qv, rbinom, }\AttributeTok{n =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.5}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{qv\_ctr =}\NormalTok{ valid\_click\_qv }\SpecialCharTok{/}\NormalTok{ search\_qv)}
\end{Highlighting}
\end{Shaded}

\texttt{hoverinfo\ =\ "text"} 表示 tooltips 使用指定的 text 映射，而 \texttt{visible\ =\ "legendonly"} 表示图层默认隐藏不展示，只在图例里显示，有时候很多条线，默认只是展示几条而已。举例如下

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_bars}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{dt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{search\_qv, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray80"}\NormalTok{), }\AttributeTok{name =} \StringTok{"搜索 QV"}\NormalTok{,}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
      \StringTok{"日期："}\NormalTok{, dt, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"点击 QV："}\NormalTok{, }\FunctionTok{format}\NormalTok{(valid\_click\_qv, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"搜索 QV："}\NormalTok{, }\FunctionTok{format}\NormalTok{(search\_qv, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"QV\_CTR："}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(qv\_ctr, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}
\NormalTok{    ),}
    \AttributeTok{hoverinfo =} \StringTok{"text"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_bars}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{dt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{valid\_click\_qv, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray60"}\NormalTok{), }\AttributeTok{name =} \StringTok{"点击 QV"}\NormalTok{,}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
      \StringTok{"日期："}\NormalTok{, dt, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"点击 QV："}\NormalTok{, }\FunctionTok{format}\NormalTok{(valid\_click\_qv, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"搜索 QV："}\NormalTok{, }\FunctionTok{format}\NormalTok{(search\_qv, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"QV\_CTR："}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(qv\_ctr, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}
\NormalTok{    ), }\AttributeTok{visible =} \StringTok{"legendonly"}\NormalTok{,}
    \AttributeTok{hoverinfo =} \StringTok{"text"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_lines}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{dt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{qv\_ctr, }\AttributeTok{name =} \StringTok{"QV\_CTR"}\NormalTok{, }\AttributeTok{yaxis =} \StringTok{"y2"}\NormalTok{, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray40"}\NormalTok{),}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste}\NormalTok{(}\StringTok{"QV\_CTR："}\NormalTok{, scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(qv\_ctr, }\AttributeTok{accuracy =} \FloatTok{0.01}\NormalTok{), }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{), }
    \AttributeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \StringTok{"spline"}\NormalTok{, }\AttributeTok{width =} \DecValTok{3}\NormalTok{, }\AttributeTok{dash =} \StringTok{"line"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{""}\NormalTok{,}
    \AttributeTok{yaxis2 =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{tickfont =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
      \AttributeTok{overlaying =} \StringTok{"y"}\NormalTok{,}
      \AttributeTok{side =} \StringTok{"right"}\NormalTok{,}
      \AttributeTok{title =} \StringTok{"QV\_CTR（\%）"}\NormalTok{,}
      \CommentTok{\# ticksuffix = "\%", \# 设置坐标轴单位}
      \AttributeTok{tickformat =} \StringTok{\textquotesingle{}.1\%\textquotesingle{}}\NormalTok{, }\CommentTok{\# 设置坐标轴刻度}
      \AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{automargin =} \ConstantTok{TRUE}
\NormalTok{    ),}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"日期"}\NormalTok{, }\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{showline =}\NormalTok{ F),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{" "}\NormalTok{, }\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{showline =}\NormalTok{ F),}
    \AttributeTok{margin =} \FunctionTok{list}\NormalTok{(}\AttributeTok{r =} \DecValTok{20}\NormalTok{, }\AttributeTok{autoexpand =}\NormalTok{ T),}
    \AttributeTok{legend =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\NormalTok{, }\AttributeTok{orientation =} \StringTok{"h"}\NormalTok{,}
      \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{" "}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-histogram}{%
\section{直方图}\label{sec-plotly-histogram}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Sepal.Length, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Species, }\AttributeTok{type =} \StringTok{"histogram"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-boxplot}{%
\section{箱线图}\label{sec-plotly-boxplot}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 箱线图}
\FunctionTok{plot\_ly}\NormalTok{(diamonds,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{price, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{clarity, }\AttributeTok{type =} \StringTok{"box"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-violin}{%
\section{提琴图}\label{sec-plotly-violin}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(sleep,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{group, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{extra, }\AttributeTok{split =} \SpecialCharTok{\textasciitilde{}}\NormalTok{group,}
  \AttributeTok{type =} \StringTok{"violin"}\NormalTok{,}
  \AttributeTok{box =} \FunctionTok{list}\NormalTok{(}\AttributeTok{visible =}\NormalTok{ T),}
  \AttributeTok{meanline =} \FunctionTok{list}\NormalTok{(}\AttributeTok{visible =}\NormalTok{ T)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

plotly 包含图层 27 种，见表 \ref{tab:add-layer}

\begin{table}

\caption{\label{tab:add-layer}图层}
\centering
\begin{tabular}[t]{l|l|l}
\hline
A & B & C\\
\hline
add\_annotations & add\_histogram & add\_polygons\\
\hline
add\_area & add\_histogram2d & add\_ribbons\\
\hline
add\_bars & add\_histogram2dcontour & add\_scattergeo\\
\hline
add\_boxplot & add\_image & add\_segments\\
\hline
add\_choropleth & add\_lines & add\_sf\\
\hline
add\_contour & add\_markers & add\_surface\\
\hline
add\_data & add\_mesh & add\_table\\
\hline
add\_fun & add\_paths & add\_text\\
\hline
add\_heatmap & add\_pie & add\_trace\\
\hline
\end{tabular}
\end{table}

\hypertarget{sec-plotly-bubble}{%
\section{气泡图}\label{sec-plotly-bubble}}

简单图形 scatter，分布图几类，其中 scatter、heatmap、scatterpolar 支持 WebGL 绘图引擎

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://plotly.com/r/bubble{-}charts/}
\NormalTok{dat }\OtherTok{\textless{}{-}}\NormalTok{ diamonds[, .(}
  \AttributeTok{carat =} \FunctionTok{mean}\NormalTok{(carat),}
  \AttributeTok{price =} \FunctionTok{sum}\NormalTok{(price), }
  \AttributeTok{cnt =}\NormalTok{ .N}
\NormalTok{), by }\OtherTok{=}\NormalTok{ .(cut)]}

\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ dat, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{carat, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{price, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cut, }\AttributeTok{size =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cnt,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers"}\NormalTok{,}
  \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{symbol =} \StringTok{"circle"}\NormalTok{, }\AttributeTok{sizemode =} \StringTok{"diameter"}\NormalTok{,}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{width =} \DecValTok{2}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#FFFFFF"}\NormalTok{), }\AttributeTok{opacity =} \FloatTok{0.4}
\NormalTok{  ),}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste}\NormalTok{(}
    \AttributeTok{sep =} \StringTok{" "}\NormalTok{, }\StringTok{"重量："}\NormalTok{, }\FunctionTok{round}\NormalTok{(carat, }\DecValTok{2}\NormalTok{), }\StringTok{"克拉"}\NormalTok{,}
    \StringTok{"\textless{}br\textgreater{}价格:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(price }\SpecialCharTok{/} \DecValTok{10}\SpecialCharTok{\^{}}\DecValTok{6}\NormalTok{, }\DecValTok{2}\NormalTok{), }\StringTok{"百万"}
\NormalTok{  ),}
  \AttributeTok{hoverinfo =} \StringTok{\textquotesingle{}text\textquotesingle{}}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_annotations}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{carat, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{price, }\AttributeTok{text =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cnt,}
    \AttributeTok{showarrow =}\NormalTok{ F, }\AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{family =} \StringTok{"sans"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{hoverformat =} \StringTok{".2f"}\NormalTok{),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{hoverformat =} \StringTok{".0f"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-spline}{%
\section{曲线图}\label{sec-plotly-spline}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{2.2}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\FloatTok{5.3}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{), }
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray40"}\NormalTok{), }
  \AttributeTok{mode =} \StringTok{"markers+lines"}\NormalTok{, }\AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \StringTok{"spline"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_annotations}\NormalTok{(}
    \AttributeTok{x =} \DecValTok{2}\NormalTok{, }\AttributeTok{y =} \DecValTok{6}\NormalTok{, }\AttributeTok{size =} \FunctionTok{I}\NormalTok{(}\DecValTok{100}\NormalTok{),}
    \AttributeTok{text =} \FunctionTok{TeX}\NormalTok{(}\StringTok{"x\_i }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{sim N(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mu, }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{sigma)"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{title =} \FunctionTok{TeX}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{mu"}\NormalTok{)),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{title =} \FunctionTok{TeX}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{alpha"}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{config}\NormalTok{(}\AttributeTok{mathjax =} \StringTok{\textquotesingle{}cdn\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-tozeroy}{%
\section{堆积图}\label{sec-plotly-tozeroy}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ PlantGrowth, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{weight,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{group, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \StringTok{"spline"}\NormalTok{),}
  \AttributeTok{mode =} \StringTok{"lines"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"tozeroy"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-heatmap}{%
\section{热力图}\label{sec-plotly-heatmap}}

其他基础图形

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{z =}\NormalTok{ volcano, }\AttributeTok{type =} \StringTok{\textquotesingle{}heatmap\textquotesingle{}}\NormalTok{, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-map}{%
\section{地图 I}\label{sec-plotly-map}}

\texttt{plot\_mapbox()} 使用 Mapbox 提供的地图服务，因此，需要注册一个账户，获取 MAPBOX\_TOKEN

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"quakes"}\NormalTok{)}
\FunctionTok{plot\_mapbox}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ quakes, }\AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{,}
  \AttributeTok{lon =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag, }\AttributeTok{size =} \DecValTok{2}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"scattermapbox"}\NormalTok{, }
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{,}
  \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{opacity =} \FloatTok{0.5}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Fiji Earthquake"}\NormalTok{,}
    \AttributeTok{mapbox =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{zoom =} \DecValTok{3}\NormalTok{,}
      \AttributeTok{center =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{median}\NormalTok{(lat }\SpecialCharTok{{-}} \DecValTok{5}\NormalTok{),}
        \AttributeTok{lon =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{median}\NormalTok{(long)}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{config}\NormalTok{(}
    \AttributeTok{mapboxAccessToken =} \FunctionTok{Sys.getenv}\NormalTok{(}\StringTok{"MAPBOX\_TOKEN"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ quakes,}
  \AttributeTok{lon =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat,}
  \AttributeTok{type =} \StringTok{"scattergeo"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers"}\NormalTok{,}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}
    \StringTok{"站点："}\NormalTok{, stations, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
    \StringTok{"震级："}\NormalTok{, mag}
\NormalTok{  ),}
  \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag, }
    \AttributeTok{size =} \DecValTok{10}\NormalTok{, }\AttributeTok{opacity =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{width =} \DecValTok{1}\NormalTok{)}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}\AttributeTok{geo =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{showland =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{landcolor =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{toRGB}\NormalTok{(}\StringTok{"gray95"}\NormalTok{),}
    \AttributeTok{subunitcolor =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{toRGB}\NormalTok{(}\StringTok{"gray85"}\NormalTok{),}
    \AttributeTok{countrycolor =}\NormalTok{ plotly}\SpecialCharTok{::}\FunctionTok{toRGB}\NormalTok{(}\StringTok{"gray85"}\NormalTok{),}
    \AttributeTok{countrywidth =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{subunitwidth =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{lonaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{showgrid =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{gridwidth =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\DecValTok{160}\NormalTok{, }\DecValTok{190}\NormalTok{),}
      \AttributeTok{dtick =} \DecValTok{5}
\NormalTok{    ),}
    \AttributeTok{lataxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{showgrid =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{gridwidth =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{40}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{),}
      \AttributeTok{dtick =} \DecValTok{5}
\NormalTok{    )}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(state.x77,}
  \AttributeTok{stats =} \FunctionTok{rownames}\NormalTok{(state.x77),}
  \AttributeTok{stats\_abbr =}\NormalTok{ state.abb}
\NormalTok{)}

\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ dat,}
  \AttributeTok{type =} \StringTok{"choropleth"}\NormalTok{,}
  \AttributeTok{locations =} \SpecialCharTok{\textasciitilde{}}\NormalTok{stats\_abbr,}
  \AttributeTok{locationmode =} \StringTok{"USA{-}states"}\NormalTok{,}
  \AttributeTok{colorscale =} \StringTok{"Viridis"}\NormalTok{,}
  \AttributeTok{z =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Income}
\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{geo =} \FunctionTok{list}\NormalTok{(}\AttributeTok{scope =} \StringTok{"usa"}\NormalTok{),}
    \AttributeTok{title =} \StringTok{"1974年美国各州的人均收入"}\NormalTok{,}
    \AttributeTok{legend =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"收入"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-fitted}{%
\section{拟合图}\label{sec-plotly-fitted}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(economics,}
  \AttributeTok{type =} \StringTok{"scatter"}\NormalTok{,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{date,}
  \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{uempmed,}
  \AttributeTok{name =} \StringTok{"observed unemployment"}\NormalTok{,}
  \AttributeTok{mode =} \StringTok{"markers+lines"}\NormalTok{,}
  \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{color =} \StringTok{"red"}
\NormalTok{  ),}
  \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{color =} \StringTok{"red"}\NormalTok{,}
    \AttributeTok{dash =} \StringTok{"dashed"}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{date,}
    \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\FunctionTok{fitted}\NormalTok{(}\FunctionTok{loess}\NormalTok{(uempmed }\SpecialCharTok{\textasciitilde{}} \FunctionTok{as.numeric}\NormalTok{(date))),}
    \AttributeTok{name =} \StringTok{"fitted unemployment"}\NormalTok{,}
    \AttributeTok{mode =} \StringTok{"markers+lines"}\NormalTok{,}
    \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{color =} \StringTok{"orange"}
\NormalTok{    ),}
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{color =} \StringTok{"orange"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"失业时间"}\NormalTok{,}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{title =} \StringTok{"日期"}\NormalTok{,}
      \AttributeTok{showgrid =}\NormalTok{ F}
\NormalTok{    ),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{title =} \StringTok{"失业时间（周）"}
\NormalTok{    ),}
    \AttributeTok{legend =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\NormalTok{, }\AttributeTok{orientation =} \StringTok{"v"}\NormalTok{,}
      \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{""}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-rasterly}{%
\section{轨迹图}\label{sec-plotly-rasterly}}

\href{https://github.com/plotly/rasterly}{rasterly} 百万量级的散点图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rasterly)}
\FunctionTok{plot\_ly}\NormalTok{(quakes, }\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_rasterly\_heatmap}\NormalTok{()}

\NormalTok{quakes }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rasterly}\NormalTok{(}\AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ long, }\AttributeTok{y =}\NormalTok{ lat)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rasterly\_points}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(plotly)}
\CommentTok{\# 读取数据}
\CommentTok{\# uber 轨迹数据来自 https://github.com/plotly/rasterly}
\NormalTok{ridesDf }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\AttributeTok{file =} \StringTok{\textquotesingle{}data/uber.rds\textquotesingle{}}\NormalTok{)}

\NormalTok{ridesDf }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rasterly}\NormalTok{(}\AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Lat, }\AttributeTok{y =}\NormalTok{ Lon)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rasterly\_points}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=5.19in]{screenshots/rasterly-rides} 

}

\caption{轨迹数据}\label{fig:uber-rides}
\end{figure}

\hypertarget{sec-plotly-3d}{%
\section{三维图 (plotly)}\label{sec-plotly-3d}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{z =} \SpecialCharTok{\textasciitilde{}}\NormalTok{volcano) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_surface}\NormalTok{()}

\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{z =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_mesh}\NormalTok{()}

\CommentTok{\# https://plot.ly/r/reference/\#scatter3d}
\FunctionTok{transform}\NormalTok{(mtcars, }\AttributeTok{am =} \FunctionTok{ifelse}\NormalTok{(am }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\StringTok{"Automatic"}\NormalTok{, }\StringTok{"Manual"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{wt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{hp, }\AttributeTok{z =} \SpecialCharTok{\textasciitilde{}}\NormalTok{qsec, }
          \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{am, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#BF382A"}\NormalTok{, }\StringTok{"\#0C4B8E"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_markers}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{scene =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"Weight"}\NormalTok{),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"Gross horsepower"}\NormalTok{),}
    \AttributeTok{zaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"1/4 mile time"}\NormalTok{)}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-gantt-charts}{%
\section{甘特图}\label{sec-plotly-gantt-charts}}

项目管理必备，如图所示，本项目拆分成7个任务，一共使用3种项目资源

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://plotly.com/r/gantt/}
\CommentTok{\# 项目拆解为一系列任务，每个任务的开始时间，持续时间和资源类型}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{task =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Task"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{),}
  \AttributeTok{start =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \StringTok{"2016{-}01{-}01"}\NormalTok{, }\StringTok{"2016{-}02{-}20"}\NormalTok{, }\StringTok{"2016{-}01{-}01"}\NormalTok{,}
    \StringTok{"2016{-}04{-}10"}\NormalTok{, }\StringTok{"2016{-}06{-}09"}\NormalTok{, }\StringTok{"2016{-}04{-}10"}\NormalTok{,}
    \StringTok{"2016{-}09{-}07"}\NormalTok{, }\StringTok{"2016{-}11{-}26"}
\NormalTok{  )),}
  \AttributeTok{duration =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{10}\NormalTok{),}
  \AttributeTok{resource =} \FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{, }\StringTok{"B"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{end =}\NormalTok{ start }\SpecialCharTok{+}\NormalTok{ duration) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(.))}

\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_segments}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{start, }\AttributeTok{xend =} \SpecialCharTok{\textasciitilde{}}\NormalTok{end,}
    \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{y, }\AttributeTok{yend =} \SpecialCharTok{\textasciitilde{}}\NormalTok{y,}
    \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{resource,}
    \AttributeTok{mode =} \StringTok{"lines"}\NormalTok{,}
    \AttributeTok{colors =} \StringTok{"Greys"}\NormalTok{, }
    \AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{width =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{showlegend =}\NormalTok{ F,}
    \AttributeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste}\NormalTok{(}
      \StringTok{" 任务: "}\NormalTok{, task, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"启动时间: "}\NormalTok{, start, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"周期: "}\NormalTok{, duration, }\StringTok{"天\textless{}br\textgreater{}"}\NormalTok{,}
      \StringTok{"资源: "}\NormalTok{, resource}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{showgrid =}\NormalTok{ F,}
      \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{""}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{showgrid =}\NormalTok{ F,}
      \AttributeTok{title =} \FunctionTok{list}\NormalTok{(}\AttributeTok{text =} \StringTok{""}\NormalTok{),}
      \AttributeTok{tickmode =} \StringTok{"array"}\NormalTok{,}
      \AttributeTok{tickvals =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df),}
      \AttributeTok{ticktext =} \FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{task),}
      \AttributeTok{domain =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.9}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{annotations =} \FunctionTok{list}\NormalTok{(}
      \FunctionTok{list}\NormalTok{(}
        \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{, }\AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
        \AttributeTok{x =} \FloatTok{0.80}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.1}\NormalTok{,}
        \AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}
          \StringTok{"项目周期: "}\NormalTok{, }\FunctionTok{sum}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{duration), }\StringTok{" 天\textless{}br\textgreater{}"}\NormalTok{,}
          \StringTok{"资源类型: "}\NormalTok{, }\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{resource)), }\StringTok{" 个\textless{}br\textgreater{}"}
\NormalTok{        ),}
        \AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
        \AttributeTok{ax =} \DecValTok{0}\NormalTok{, }\AttributeTok{ay =} \DecValTok{0}\NormalTok{,}
        \AttributeTok{align =} \StringTok{"left"}
\NormalTok{      ),}
      \FunctionTok{list}\NormalTok{(}
        \AttributeTok{xref =} \StringTok{"paper"}\NormalTok{, }\AttributeTok{yref =} \StringTok{"paper"}\NormalTok{,}
        \AttributeTok{x =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\NormalTok{,}
        \AttributeTok{xanchor =} \StringTok{"left"}\NormalTok{,}
        \AttributeTok{text =} \StringTok{"项目资源管理"}\NormalTok{,}
        \AttributeTok{font =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
        \AttributeTok{ax =} \DecValTok{0}\NormalTok{, }\AttributeTok{ay =} \DecValTok{0}\NormalTok{,}
        \AttributeTok{align =} \StringTok{"left"}\NormalTok{,}
        \AttributeTok{showarrow =} \ConstantTok{FALSE}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-pareto-charts}{%
\section{帕雷托图}\label{sec-plotly-pareto-charts}}

\href{https://en.wikipedia.org/wiki/Pareto_chart}{帕雷托图} 20/80 法则

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 数据来自 https://github.com/plotly/datasets }
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{complaint =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Small portions"}\NormalTok{, }\StringTok{"Overpriced"}\NormalTok{,}
    \StringTok{"Wait time"}\NormalTok{, }\StringTok{"Food is tasteless"}\NormalTok{, }\StringTok{"No atmosphere"}\NormalTok{, }\StringTok{"Not clean"}\NormalTok{,}
    \StringTok{"Too noisy"}\NormalTok{, }\StringTok{"Food is too salty"}\NormalTok{, }\StringTok{"Unfriendly staff"}\NormalTok{, }\StringTok{"Food not fresh"}
\NormalTok{  ),}
  \AttributeTok{count =} \FunctionTok{c}\NormalTok{( 621L, 789L, 109L, 65L, 45L, 30L, 27L, 15L, 12L, 9L)}
\NormalTok{)}

\NormalTok{dat }\OtherTok{\textless{}{-}}\NormalTok{ dat[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{dat}\SpecialCharTok{$}\NormalTok{count), ] }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{cumulative =} \FunctionTok{round}\NormalTok{(}\DecValTok{100} \SpecialCharTok{*} \FunctionTok{cumsum}\NormalTok{(count) }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(count), }\AttributeTok{digits =} \DecValTok{2}\NormalTok{))}

\CommentTok{\# complaint 按 count 降序排列}
\NormalTok{dat}\SpecialCharTok{$}\NormalTok{complaint }\OtherTok{\textless{}{-}} \FunctionTok{reorder}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{complaint, }\AttributeTok{X =}\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{count, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) }\DecValTok{1}\SpecialCharTok{/}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ x))}

\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_bars}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{complaint, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{count,}
    \AttributeTok{showlegend =}\NormalTok{ F, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray60"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_lines}\NormalTok{(}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{complaint, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{cumulative, }\AttributeTok{yaxis =} \StringTok{"y2"}\NormalTok{,}
    \AttributeTok{showlegend =}\NormalTok{ F, }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray40"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{yaxis2 =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{tickfont =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
      \AttributeTok{overlaying =} \StringTok{"y"}\NormalTok{,}
      \AttributeTok{side =} \StringTok{"right"}\NormalTok{,}
      \AttributeTok{title =} \StringTok{"累积百分比（\%）"}\NormalTok{,}
      \AttributeTok{showgrid =}\NormalTok{ F}
\NormalTok{    ),}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"投诉类型"}\NormalTok{, }\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{showline =}\NormalTok{ F),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"数量"}\NormalTok{, }\AttributeTok{showgrid =}\NormalTok{ F, }\AttributeTok{showline =}\NormalTok{ F)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{rmdtip}{提示}
\texttt{reorder()} 对 complaint 按照降序还是升序由 FUN 函数的单调性决定，单调增对应升序，单调减对应降序

\end{rmdtip}

\hypertarget{sec-plotly-vistime}{%
\section{时间线}\label{sec-plotly-vistime}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(vistime)}

\NormalTok{pres }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Position =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"President"}\NormalTok{, }\StringTok{"Vice"}\NormalTok{), }\AttributeTok{each =} \DecValTok{3}\NormalTok{),}
  \AttributeTok{Name =} \FunctionTok{c}\NormalTok{(}\StringTok{"Washington"}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"Adams"}\NormalTok{, }\StringTok{"Jefferson"}\NormalTok{), }\DecValTok{2}\NormalTok{), }\StringTok{"Burr"}\NormalTok{),}
  \AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\StringTok{"1789{-}03{-}29"}\NormalTok{, }\StringTok{"1797{-}02{-}03"}\NormalTok{, }\StringTok{"1801{-}02{-}03"}\NormalTok{),}
  \AttributeTok{end =} \FunctionTok{c}\NormalTok{(}\StringTok{"1797{-}02{-}03"}\NormalTok{, }\StringTok{"1801{-}02{-}03"}\NormalTok{, }\StringTok{"1809{-}02{-}03"}\NormalTok{),}
  \AttributeTok{color =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#cbb69d"}\NormalTok{, }\StringTok{"\#603913"}\NormalTok{, }\StringTok{"\#c69c6e"}\NormalTok{),}
  \AttributeTok{fontcolor =} \FunctionTok{c}\NormalTok{(}\StringTok{"black"}\NormalTok{, }\StringTok{"white"}\NormalTok{, }\StringTok{"black"}\NormalTok{)}
\NormalTok{)}

\FunctionTok{vistime}\NormalTok{(pres, }\AttributeTok{col.event =} \StringTok{"Position"}\NormalTok{, }\AttributeTok{col.group =} \StringTok{"Name"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-funnel}{%
\section{漏斗图}\label{sec-plotly-funnel}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{category =} \FunctionTok{c}\NormalTok{(}\StringTok{"访问"}\NormalTok{, }\StringTok{"下载"}\NormalTok{, }\StringTok{"潜客"}\NormalTok{, }\StringTok{"报价"}\NormalTok{, }\StringTok{"下单"}\NormalTok{),}
  \AttributeTok{value =} \FunctionTok{c}\NormalTok{(}\DecValTok{39}\NormalTok{, }\FloatTok{27.4}\NormalTok{, }\FloatTok{20.6}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{transform}\NormalTok{(}\AttributeTok{percent =}\NormalTok{ value }\SpecialCharTok{/} \FunctionTok{cumsum}\NormalTok{(value))}

\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{type =} \StringTok{"funnel"}\NormalTok{,}
    \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category,}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{value,}
    \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category, }
    \AttributeTok{colors =} \StringTok{"Set2"}\NormalTok{, }
    \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(value, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{, }\FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.2f\%\%"}\NormalTok{, }\DecValTok{100}\SpecialCharTok{*}\NormalTok{percent)) ,}
    \AttributeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
    \AttributeTok{showlegend =} \ConstantTok{FALSE}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}\AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{categoryarray =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category,}
    \AttributeTok{title =} \StringTok{""}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dat) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{type =} \StringTok{"funnel"}\NormalTok{,}
    \AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category,}
    \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{value,}
    \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =}\NormalTok{ RColorBrewer}\SpecialCharTok{::}\FunctionTok{brewer.pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{5}\NormalTok{, }\AttributeTok{name =} \StringTok{"Set2"}\NormalTok{)),}
    \AttributeTok{textposition =} \StringTok{"auto"}\NormalTok{,}
    \AttributeTok{textinfo =} \StringTok{"value+percent previous"}\NormalTok{,}
    \AttributeTok{hoverinfo =} \StringTok{"none"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}\AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{categoryarray =} \SpecialCharTok{\textasciitilde{}}\NormalTok{category, }\AttributeTok{title =} \StringTok{""}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-radar}{%
\section{雷达图}\label{sec-plotly-radar}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(}
  \AttributeTok{type =} \StringTok{"scatterpolar"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"toself"}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{r =} \FunctionTok{c}\NormalTok{(}\DecValTok{39}\NormalTok{, }\DecValTok{28}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{28}\NormalTok{, }\DecValTok{39}\NormalTok{), }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray40"}\NormalTok{),}
    \AttributeTok{theta =} \FunctionTok{c}\NormalTok{(}\StringTok{"数学"}\NormalTok{, }\StringTok{"物理"}\NormalTok{, }\StringTok{"化学"}\NormalTok{, }\StringTok{"英语"}\NormalTok{, }\StringTok{"生物"}\NormalTok{, }\StringTok{"数学"}\NormalTok{),}
    \AttributeTok{name =} \StringTok{"学生 A"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{r =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{39}\NormalTok{, }\DecValTok{31}\NormalTok{, }\DecValTok{15}\NormalTok{, }\FloatTok{1.5}\NormalTok{), }\AttributeTok{color =} \FunctionTok{I}\NormalTok{(}\StringTok{"gray80"}\NormalTok{),}
    \AttributeTok{theta =} \FunctionTok{c}\NormalTok{(}\StringTok{"数学"}\NormalTok{, }\StringTok{"物理"}\NormalTok{, }\StringTok{"化学"}\NormalTok{, }\StringTok{"英语"}\NormalTok{, }\StringTok{"生物"}\NormalTok{, }\StringTok{"数学"}\NormalTok{),}
    \AttributeTok{name =} \StringTok{"学生 B"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{polar =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{radialaxis =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{visible =}\NormalTok{ T,}
        \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{50}\NormalTok{)}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-waterfall}{%
\section{瀑布图}\label{sec-plotly-waterfall}}

盈亏图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(plotly)}
\FunctionTok{library}\NormalTok{(dplyr)}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"销售"}\NormalTok{, }\StringTok{"咨询"}\NormalTok{, }\StringTok{"净收入"}\NormalTok{,}
    \StringTok{"购买"}\NormalTok{, }\StringTok{"其他费用"}\NormalTok{, }\StringTok{"税前利润"}
\NormalTok{  ),}
  \AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{60}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{10}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{40}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{20}\NormalTok{, }\DecValTok{0}\NormalTok{),}
  \AttributeTok{measure =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"relative"}\NormalTok{, }\StringTok{"relative"}\NormalTok{, }\StringTok{"relative"}\NormalTok{,}
    \StringTok{"relative"}\NormalTok{, }\StringTok{"relative"}\NormalTok{, }\StringTok{"total"}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{text =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    y }\SpecialCharTok{\textgreater{}} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"+"}\NormalTok{, y),}
\NormalTok{    y }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \StringTok{""}\NormalTok{,}
\NormalTok{    y }\SpecialCharTok{\textless{}} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{as.character}\NormalTok{(y)}
\NormalTok{  )) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{x =} \FunctionTok{factor}\NormalTok{(x, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}
    \StringTok{"销售"}\NormalTok{, }\StringTok{"咨询"}\NormalTok{, }\StringTok{"净收入"}\NormalTok{,}
    \StringTok{"购买"}\NormalTok{, }\StringTok{"其他费用"}\NormalTok{, }\StringTok{"税前利润"}
\NormalTok{  )))}

\NormalTok{n\_rows }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(dat)}
\NormalTok{dat[}\FunctionTok{nrow}\NormalTok{(dat), }\StringTok{"text"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"累计"}

\CommentTok{\# measure 取值为 \textquotesingle{}relative\textquotesingle{}/\textquotesingle{}total\textquotesingle{}/\textquotesingle{}absolute\textquotesingle{}}
\NormalTok{plotly}\SpecialCharTok{::}\FunctionTok{plot\_ly}\NormalTok{(dat,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{x, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{y, }\AttributeTok{measure =} \SpecialCharTok{\textasciitilde{}}\NormalTok{measure, }\AttributeTok{type =} \StringTok{"waterfall"}\NormalTok{,}
  \AttributeTok{text =} \SpecialCharTok{\textasciitilde{}}\NormalTok{text, }\AttributeTok{textposition =} \StringTok{"outside"}\NormalTok{, }
  \AttributeTok{name =} \StringTok{"收支"}\NormalTok{, }\AttributeTok{hoverinfo =} \StringTok{"final"}\NormalTok{, }
  \AttributeTok{connector =} \FunctionTok{list}\NormalTok{(}\AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"gray"}\NormalTok{)),}
  \AttributeTok{increasing =} \FunctionTok{list}\NormalTok{(}\AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"\#66C2A5"}\NormalTok{)),}
  \AttributeTok{decreasing =} \FunctionTok{list}\NormalTok{(}\AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"\#FC8D62"}\NormalTok{)),}
  \AttributeTok{totals =} \FunctionTok{list}\NormalTok{(}\AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"\#8DA0CB"}\NormalTok{))}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  plotly}\SpecialCharTok{::}\FunctionTok{layout}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"2018 年收支状态"}\NormalTok{,}
    \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"业务"}\NormalTok{),}
    \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}\AttributeTok{title =} \StringTok{"金额"}\NormalTok{),}
    \AttributeTok{showlegend =} \ConstantTok{FALSE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-plotly-treemap}{%
\section{树状图}\label{sec-plotly-treemap}}

plotly 绘制 treemap 和 sunburst 图比较复杂，接口不友好， \href{https://github.com/yogevherz/plotme}{plotme} 正好弥补不足。

\hypertarget{sec-plotly-sunburst}{%
\section{旭日图}\label{sec-plotly-sunburst}}

\href{https://github.com/yogevherz/plotme}{plotme}

\hypertarget{sec-plotly-color-palette}{%
\section{调色板}\label{sec-plotly-color-palette}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Length, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Width,}
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}\NormalTok{,}
  \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{6}\NormalTok{, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#132B43"}\NormalTok{, }\StringTok{"\#56B1F7"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Length, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Width, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{6}\NormalTok{,}
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}
\NormalTok{)}

\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Length, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Width, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{6}\NormalTok{,}
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{colors =} \StringTok{"Set2"}
\NormalTok{)}

\FunctionTok{plot\_ly}\NormalTok{(iris,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Length, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{Petal.Width, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ Sepal.Length }\SpecialCharTok{\textgreater{}} \DecValTok{6}\NormalTok{,}
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{colors =} \StringTok{"Set1"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

构造 20 个类别 超出 Set1 调色板的范围，会触发警告说 Set1 没有那么多色块，但还是返回足够多的色块，也可以使用 \texttt{viridis}、\texttt{plasma}、\texttt{magma} 或 \texttt{inferno} 调色板

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{dt =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}
    \AttributeTok{from =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2021{-}01{-}01"}\NormalTok{),}
    \AttributeTok{to =} \FunctionTok{as.Date}\NormalTok{(}\StringTok{"2021{-}01{-}31"}\NormalTok{), }\AttributeTok{by =} \StringTok{"day"}
\NormalTok{  ), }\AttributeTok{each =} \DecValTok{20}\NormalTok{),}
  \AttributeTok{bu =} \FunctionTok{rep}\NormalTok{(LETTERS[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{], }\DecValTok{31}\NormalTok{),}
  \AttributeTok{qv =} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \DecValTok{20} \SpecialCharTok{*} \DecValTok{31}\NormalTok{, }\AttributeTok{size =} \DecValTok{10000}\NormalTok{, }\AttributeTok{prob =} \FunctionTok{runif}\NormalTok{(}\DecValTok{20} \SpecialCharTok{*} \DecValTok{31}\NormalTok{))}
\NormalTok{)}
\CommentTok{\# viridis}
\FunctionTok{plot\_ly}\NormalTok{(dat,}
  \AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{dt, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{qv, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{bu, }
  \AttributeTok{mode =} \StringTok{"markers"}\NormalTok{, }\AttributeTok{type =} \StringTok{"scatter"}\NormalTok{, }\AttributeTok{colors =} \StringTok{"viridis"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-export}{%
\section{导出静态图形}\label{sec-export}}

orca (Open-source Report Creator App) 软件针对 plotly.js 库渲染的图形具有很强的导出功能，\href{https://github.com/plotly/orca\#installation}{安装 orca} 后，\texttt{plotly::orca()} 函数可以将基于 htmlwidgets 的 plotly 图形对象导出为 PNG、PDF 和 SVG 等格式的高质量静态图片。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{y =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\AttributeTok{color =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\FunctionTok{orca}\NormalTok{(p, }\StringTok{"plot.svg"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-ggplotly}{%
\section{静态图形转交互图形}\label{sec-ggplotly}}

函数 \texttt{ggplotly()} 将 ggplot 对象转化为交互式 plotly 对象

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gg }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(faithful, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ eruptions, }\AttributeTok{y =}\NormalTok{ waiting)) }\SpecialCharTok{+}
  \FunctionTok{stat\_density\_2d}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ ..level..), }\AttributeTok{geom =} \StringTok{"polygon"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

静态图形

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gg}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{interactive-web-graphics_files/figure-latex/unnamed-chunk-6-1} \end{center}

转化为 plotly 对象

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplotly}\NormalTok{(gg)}
\end{Highlighting}
\end{Shaded}

添加动态点的注释，比如点横纵坐标、坐标文本，整个注释标签的样式（如背景色）

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplotly}\NormalTok{(gg, }\AttributeTok{dynamicTicks =} \StringTok{"y"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{style}\NormalTok{(., }\AttributeTok{hoveron =} \StringTok{"points"}\NormalTok{, }\AttributeTok{hoverinfo =} \StringTok{"x+y+text"}\NormalTok{, }
        \AttributeTok{hoverlabel =} \FunctionTok{list}\NormalTok{(}\AttributeTok{bgcolor =} \StringTok{"white"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-echarts4r-map}{%
\section{地图 II}\label{sec-echarts4r-map}}

\textbf{leaflet} 包制作地图，斐济是太平洋上的一个岛国，处于板块交界处，经常发生地震，如下图所示，展示 1964 年来 1000 次震级大于 4 级的地震活动。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(leaflet)}
\FunctionTok{data}\NormalTok{(quakes)}
\CommentTok{\# Pop 提示}
\NormalTok{quakes}\SpecialCharTok{$}\NormalTok{popup\_text }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}
  \StringTok{"编号:"}\NormalTok{, }\StringTok{"\textless{}strong\textgreater{}"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{stations, }\StringTok{"\textless{}/strong\textgreater{}"}\NormalTok{, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
  \StringTok{"震深:"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{depth, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
  \StringTok{"震级:"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{mag}
\NormalTok{), htmltools}\SpecialCharTok{::}\NormalTok{HTML)}
\CommentTok{\# 构造调色板}
\NormalTok{pal }\OtherTok{\textless{}{-}} \FunctionTok{colorBin}\NormalTok{(}\StringTok{"Spectral"}\NormalTok{, }\AttributeTok{bins =} \FunctionTok{pretty}\NormalTok{(quakes}\SpecialCharTok{$}\NormalTok{mag), }\AttributeTok{reverse =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{leaflet}\NormalTok{(quakes) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addProviderTiles}\NormalTok{(providers}\SpecialCharTok{$}\NormalTok{CartoDB.Positron) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addCircles}\NormalTok{(}\AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{pal}\NormalTok{(mag), }\AttributeTok{label =} \SpecialCharTok{\textasciitilde{}}\NormalTok{popup\_text) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addLegend}\NormalTok{(}\StringTok{"bottomright"}\NormalTok{,}
    \AttributeTok{pal =}\NormalTok{ pal, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag,}
    \AttributeTok{title =} \StringTok{"地震震级"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addScaleBar}\NormalTok{(}\AttributeTok{position =} \FunctionTok{c}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{))}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{screenshots/leaflet-fiji} 

}

\caption{斐济地震带}\label{fig:fiji-quakes-latex}
\end{figure}

将上面的绘图部分保存为独立的 HTML 网页文件

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(htmlwidgets)}
\CommentTok{\# p 就是绘图部分的数据对象}
\FunctionTok{saveWidget}\NormalTok{(p, }\StringTok{"fiji{-}map.html"}\NormalTok{, }\AttributeTok{selfcontained =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(leaflet)}
\FunctionTok{library}\NormalTok{(leaflet.extras)}

\NormalTok{quakes }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{leaflet}\NormalTok{() }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addTiles}\NormalTok{() }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addProviderTiles}\NormalTok{(providers}\SpecialCharTok{$}\NormalTok{OpenStreetMap.DE) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addHeatmap}\NormalTok{(}
    \AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat, }\AttributeTok{intensity =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag,}
    \AttributeTok{max =} \DecValTok{100}\NormalTok{, }\AttributeTok{radius =} \DecValTok{20}\NormalTok{, }\AttributeTok{blur =} \DecValTok{10}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.75\linewidth]{screenshots/leaflet-heatmap} 

}

\caption{斐济地震带热力图}\label{fig:fiji-heatmap-latex}
\end{figure}

\textbf{leafletCN} 提供汉化

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 地图默认放大倍数}
\NormalTok{zoom         }\OtherTok{\textless{}{-}} \DecValTok{4}
\CommentTok{\# 地图可以放大的倍数区间}
\NormalTok{minZoom      }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{maxZoom      }\OtherTok{\textless{}{-}} \DecValTok{18}

\FunctionTok{library}\NormalTok{(leaflet)}
\FunctionTok{library}\NormalTok{(leafletCN)}
\FunctionTok{library}\NormalTok{(maptools)}
\FunctionTok{library}\NormalTok{(leaflet.extras)}

\CommentTok{\# 热力图 heatmap}
\FunctionTok{leaflet}\NormalTok{(res, }\AttributeTok{options =} \FunctionTok{leafletOptions}\NormalTok{(}\AttributeTok{minZoom =}\NormalTok{ minZoom, }\AttributeTok{maxZoom =}\NormalTok{ maxZoom)) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{amap}\NormalTok{() }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \CommentTok{\# setView(lng = mean(data$long), lat = mean(data$lat), zoom = zoom) |\textgreater{}}
  \FunctionTok{setView}\NormalTok{(}\AttributeTok{lng =} \DecValTok{109}\NormalTok{, }\AttributeTok{lat =} \DecValTok{38}\NormalTok{, }\AttributeTok{zoom =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addHeatmap}\NormalTok{(}
    \AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long2, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat2, }\AttributeTok{intensity =} \SpecialCharTok{\textasciitilde{}}\NormalTok{uv, }\AttributeTok{max =} \FunctionTok{max}\NormalTok{(res}\SpecialCharTok{$}\NormalTok{uv),}
    \AttributeTok{blur =}\NormalTok{ blur, }\AttributeTok{minOpacity =}\NormalTok{ minOpacity, }\AttributeTok{radius =}\NormalTok{ radius}
\NormalTok{  )}

\NormalTok{quakes}\SpecialCharTok{$}\NormalTok{popup\_text }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}
  \StringTok{"编号:"}\NormalTok{, }\StringTok{"\textless{}strong\textgreater{}"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{stations, }\StringTok{"\textless{}/strong\textgreater{}"}\NormalTok{, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
  \StringTok{"震深:"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{depth, }\StringTok{"\textless{}br\textgreater{}"}\NormalTok{,}
  \StringTok{"震级:"}\NormalTok{, quakes}\SpecialCharTok{$}\NormalTok{mag}
\NormalTok{), htmltools}\SpecialCharTok{::}\NormalTok{HTML)}
\CommentTok{\# 构造调色板}
\NormalTok{pal }\OtherTok{\textless{}{-}} \FunctionTok{colorBin}\NormalTok{(}\StringTok{"Spectral"}\NormalTok{, }\AttributeTok{bins =} \FunctionTok{pretty}\NormalTok{(quakes}\SpecialCharTok{$}\NormalTok{mag), }\AttributeTok{reverse =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{leaflet}\NormalTok{(quakes) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addProviderTiles}\NormalTok{(providers}\SpecialCharTok{$}\NormalTok{CartoDB.Positron) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addCircles}\NormalTok{(}
    \AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat,}
    \AttributeTok{color =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{pal}\NormalTok{(mag), }\AttributeTok{label =} \SpecialCharTok{\textasciitilde{}}\NormalTok{popup\_text}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{setView}\NormalTok{(}\DecValTok{178}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{20}\NormalTok{, }\DecValTok{5}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addHeatmap}\NormalTok{(}
    \AttributeTok{lng =} \SpecialCharTok{\textasciitilde{}}\NormalTok{long, }\AttributeTok{lat =} \SpecialCharTok{\textasciitilde{}}\NormalTok{lat, }\AttributeTok{intensity =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag,}
    \AttributeTok{blur =} \DecValTok{20}\NormalTok{, }\AttributeTok{max =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{radius =} \DecValTok{15}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addLegend}\NormalTok{(}\StringTok{"bottomright"}\NormalTok{,}
    \AttributeTok{pal =}\NormalTok{ pal, }\AttributeTok{values =} \SpecialCharTok{\textasciitilde{}}\NormalTok{mag,}
    \AttributeTok{title =} \StringTok{"地震震级"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{addScaleBar}\NormalTok{(}\AttributeTok{position =} \FunctionTok{c}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-echarts4r-animation}{%
\section{动画}\label{sec-echarts4r-animation}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# https://d.cosx.org/d/422311}
\FunctionTok{library}\NormalTok{(echarts4r)}

\FunctionTok{data}\NormalTok{(}\StringTok{"gapminder"}\NormalTok{, }\AttributeTok{package =} \StringTok{"gapminder"}\NormalTok{)}

\NormalTok{titles }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{unique}\NormalTok{(gapminder}\SpecialCharTok{$}\NormalTok{year), }\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{text =} \StringTok{"Gapminder"}\NormalTok{,}
    \AttributeTok{left =} \StringTok{"center"}
\NormalTok{  )}
\NormalTok{\})}

\NormalTok{years }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{unique}\NormalTok{(gapminder}\SpecialCharTok{$}\NormalTok{year), }\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{subtext =}\NormalTok{ x,}
    \AttributeTok{left =} \StringTok{"center"}\NormalTok{,}
    \AttributeTok{top =} \StringTok{"center"}\NormalTok{,}
    \AttributeTok{z =} \DecValTok{0}\NormalTok{,}
    \AttributeTok{subtextStyle =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{fontSize =} \DecValTok{100}\NormalTok{,}
      \AttributeTok{color =} \StringTok{"rgb(170, 170, 170, 0.5)"}\NormalTok{,}
      \AttributeTok{fontWeight =} \StringTok{"bolder"}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{\})}

\CommentTok{\# 添加一列颜色，各大洲和颜色的对应关系可自定义，调整 levels 或 labels 里面的顺序即可，也可不指定 levels ，调用其它调色板}
\NormalTok{gapminder }\OtherTok{\textless{}{-}} \FunctionTok{within}\NormalTok{(gapminder, \{}
\NormalTok{  color }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}
\NormalTok{    continent,}
    \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Asia"}\NormalTok{, }\StringTok{"Africa"}\NormalTok{, }\StringTok{"Americas"}\NormalTok{, }\StringTok{"Europe"}\NormalTok{, }\StringTok{"Oceania"}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ RColorBrewer}\SpecialCharTok{::}\FunctionTok{brewer.pal}\NormalTok{(}\AttributeTok{n =} \DecValTok{5}\NormalTok{, }\AttributeTok{name =} \StringTok{"Spectral"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\})}

\NormalTok{gapminder }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(year) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_charts}\NormalTok{(}\AttributeTok{x =}\NormalTok{ gdpPercap, }\AttributeTok{timeline =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_scatter}\NormalTok{(}
    \AttributeTok{serie =}\NormalTok{ lifeExp, }\AttributeTok{size =}\NormalTok{ pop, }\AttributeTok{bind =}\NormalTok{ country,}
    \AttributeTok{symbol\_size =} \DecValTok{5}\NormalTok{, }\AttributeTok{name =} \StringTok{""}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_add}\NormalTok{(}\StringTok{"itemStyle"}\NormalTok{, color) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_y\_axis}\NormalTok{(}
    \AttributeTok{min =} \DecValTok{20}\NormalTok{, }\AttributeTok{max =} \DecValTok{85}\NormalTok{, }\AttributeTok{nameGap =} \DecValTok{30}\NormalTok{,}
    \AttributeTok{name =} \StringTok{"Life Exp"}\NormalTok{, }\AttributeTok{nameLocation =} \StringTok{"center"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_x\_axis}\NormalTok{(}
    \AttributeTok{type =} \StringTok{"log"}\NormalTok{, }\AttributeTok{min =} \DecValTok{100}\NormalTok{, }\AttributeTok{max =} \DecValTok{100000}\NormalTok{,}
    \AttributeTok{nameGap =} \DecValTok{30}\NormalTok{, }\AttributeTok{name =} \StringTok{"GDP / Cap"}\NormalTok{, }\AttributeTok{nameLocation =} \StringTok{"center"}
\NormalTok{  ) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_timeline\_serie}\NormalTok{(}\AttributeTok{title =}\NormalTok{ titles) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_timeline\_serie}\NormalTok{(}\AttributeTok{title =}\NormalTok{ years, }\AttributeTok{index =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_timeline\_opts}\NormalTok{(}\AttributeTok{playInterval =} \DecValTok{1000}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_grid}\NormalTok{(}\AttributeTok{bottom =} \DecValTok{100}\NormalTok{) }\SpecialCharTok{|}\ErrorTok{\textgreater{}}
  \FunctionTok{e\_tooltip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-network-analysis}{%
\section{网络图}\label{sec-network-analysis}}

\href{https://github.com/gephi/gephi}{gephi} 探索和可视化网络图 GraphViz

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# library(igraph)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-networkD3}{%
\subsection{networkD3}\label{subsec-networkD3}}

\href{https://github.com/christophergandrud/networkD3}{networkD3} \href{https://github.com/d3/d3}{D3} 非常适合绘制网络图，如网络、树状、桑基图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(networkD3)}
\FunctionTok{data}\NormalTok{(MisLinks, MisNodes) }\CommentTok{\# 加载数据}
\FunctionTok{head}\NormalTok{(MisLinks) }\CommentTok{\# 边}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   source target value
## 1      1      0     1
## 2      2      0     8
## 3      3      0    10
## 4      3      2     6
## 5      4      0     1
## 6      5      0     1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(MisNodes) }\CommentTok{\# 节点}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              name group size
## 1          Myriel     1   15
## 2        Napoleon     1   20
## 3 Mlle.Baptistine     1   23
## 4    Mme.Magloire     1   30
## 5    CountessdeLo     1   11
## 6        Geborand     1    9
\end{verbatim}

构造网络图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{forceNetwork}\NormalTok{(}
  \AttributeTok{Links =}\NormalTok{ MisLinks, }\AttributeTok{Nodes =}\NormalTok{ MisNodes, }\AttributeTok{Source =} \StringTok{"source"}\NormalTok{,}
  \AttributeTok{Target =} \StringTok{"target"}\NormalTok{, }\AttributeTok{Value =} \StringTok{"value"}\NormalTok{, }\AttributeTok{NodeID =} \StringTok{"name"}\NormalTok{,}
  \AttributeTok{Group =} \StringTok{"group"}\NormalTok{, }\AttributeTok{opacity =} \FloatTok{0.4}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-visNetwork}{%
\subsection{visNetwork}\label{subsec-visNetwork}}

\href{https://github.com/datastorm-open/visNetwork}{visNetwork} 使用 \href{https://github.com/visjs/vis-network}{vis-network.js} 库绘制网络关系图 \url{https://datastorm-open.github.io/visNetwork}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(visNetwork)}
\end{Highlighting}
\end{Shaded}

调用函数 \texttt{visTree()} 可视化分类模型结果

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rpart)}
\FunctionTok{library}\NormalTok{(sparkline) }\CommentTok{\# 函数 visTree 需要导入 sparkline 包}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{rpart}\NormalTok{(Species}\SpecialCharTok{\textasciitilde{}}\NormalTok{., }\AttributeTok{data=}\NormalTok{iris)}
\FunctionTok{visTree}\NormalTok{(res, }\AttributeTok{main =} \StringTok{"鸢尾花分类树"}\NormalTok{, }\AttributeTok{width =} \StringTok{"100\%"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{interactive-web-graphics_files/figure-latex/unnamed-chunk-14-1} \end{center}

节点、边的属性都可以映射数据指标

\hypertarget{subsec-r2d3}{%
\subsection{r2d3}\label{subsec-r2d3}}

\href{https://d3js.org/}{D3} 是非常流行的 JavaScript 库，\href{https://github.com/rstudio/r2d3}{r2d3} 提供了 R 接口

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(r2d3)}
\end{Highlighting}
\end{Shaded}

更加具体的使用介绍，一个复杂的案例，如何从简单配置过来，以条形图为例， D3 是一个相当强大且成熟的库，提供的案例功能要覆盖 plotly

\href{https://github.com/rstudio/r2d3}{r2d3} 提供了两个样例 JS 库 \texttt{baranims.js} 和 \texttt{barchart.js}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{list.files}\NormalTok{(}\FunctionTok{system.file}\NormalTok{(}\StringTok{"examples/"}\NormalTok{, }\AttributeTok{package =} \StringTok{"r2d3"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "baranims.js" "barchart.js"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(r2d3)}
\FunctionTok{r2d3}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.40}\NormalTok{, }\FloatTok{0.20}\NormalTok{),}
  \AttributeTok{script =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"examples/barchart.js"}\NormalTok{, }\AttributeTok{package =} \StringTok{"r2d3"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{r2d3}\NormalTok{(}
  \AttributeTok{data =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.40}\NormalTok{, }\FloatTok{0.20}\NormalTok{),}
  \AttributeTok{script =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"examples/baranims.js"}\NormalTok{, }\AttributeTok{package =} \StringTok{"r2d3"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-web-graphics-session}{%
\section{运行环境}\label{sec-web-graphics-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] sparkline_2.0    rpart_4.1.16     visNetwork_2.1.0 networkD3_0.4   
## [5] r2d3_0.2.6       plotly_4.10.0    ggplot2_3.3.6   
## 
## loaded via a namespace (and not attached):
##  [1] tidyselect_1.1.2  xfun_0.31         purrr_0.3.4       colorspace_2.0-3 
##  [5] vctrs_0.4.1       generics_0.1.2    htmltools_0.5.2   viridisLite_0.4.0
##  [9] yaml_2.3.5        utf8_1.2.2        rlang_1.0.2       isoband_0.2.5    
## [13] pillar_1.7.0      glue_1.6.2        withr_2.5.0       DBI_1.1.2        
## [17] lifecycle_1.0.1   stringr_1.4.0     munsell_0.5.0     gtable_0.3.0     
## [21] htmlwidgets_1.5.4 evaluate_0.15     labeling_0.4.2    knitr_1.39       
## [25] callr_3.7.0       fastmap_1.1.0     ps_1.7.0          curl_4.3.2       
## [29] fansi_1.0.3       scales_1.2.0      webshot_0.5.3     jsonlite_1.8.0   
## [33] sysfonts_0.8.8    farver_2.1.0      png_0.1-7         digest_0.6.29    
## [37] stringi_1.7.6     processx_3.5.3    bookdown_0.26     dplyr_1.0.9      
## [41] grid_4.2.0        cli_3.3.0         tools_4.2.0       magrittr_2.0.3   
## [45] lazyeval_0.2.2    tibble_3.1.7      crayon_1.5.1      tidyr_1.2.0      
## [49] pkgconfig_2.0.3   ellipsis_0.3.2    MASS_7.3-57       data.table_1.14.2
## [53] assertthat_0.2.1  rmarkdown_2.14    httr_1.4.3        rstudioapi_0.13  
## [57] R6_2.5.1          igraph_1.3.1      compiler_4.2.0
\end{verbatim}

\hypertarget{part-ux7edfux8ba1ux8ba1ux7b97}{%
\part{统计计算}\label{part-ux7edfux8ba1ux8ba1ux7b97}}

\hypertarget{chap-statistical-computation}{%
\chapter*{介绍}\label{chap-statistical-computation}}
\addcontentsline{toc}{chapter}{介绍}

统计计算

\hypertarget{chap-numerical-optimization}{%
\chapter{数值优化}\label{chap-numerical-optimization}}

R 语言提供了相当多的优化求解器，比较完整的概览见\href{https://CRAN.R-project.org/view=Optimization}{优化视图}。 本章介绍一些常用的优化算法及其R实现，涵盖线性规划、整数规划、二次规划、非线性规划等。

商业优化求解器的能力都覆盖非线性规划（NLP），线性（LP）、二次（QP）和锥规划（SOCP），混合整数线性规划（MILP），多目标优化，最小二乘和方程求解。此外，还有很多文档介绍， \href{https://www.lindo.com/}{LINGO}提供\href{https://www.lindo.com/downloads/PDF/LINGO.pdf}{用户手册}， \href{https://ww2.mathworks.cn/products/optimization.html}{Matlab 优化工具箱} 提供 \href{https://ww2.mathworks.cn/help/releases/R2021a/pdf_doc/optim/optim.pdf}{Optimization 工具箱使用指南}， \href{https://github.com/MOSEK}{MOSEK} (\url{https://www.mosek.com/}) 提供 \href{https://docs.mosek.com/modeling-cookbook/index.html}{MOSEK 建模食谱}，\href{https://www.localsolver.com/}{LocalSolver} 提供\href{https://www.localsolver.com/docs/last/index.html}{基本使用手册}， \href{https://www.gurobi.com/}{Gurobi} 提供 \href{https://www.gurobi.com/documentation/9.1/refman/index.html}{Gurobi 参考手册}，\href{https://www.ibm.com/cn-zh/products/ilog-cplex-optimization-studio}{CPLEX Optimization Studio}。

开源社区有不少工具，也能求解常见的优化问题，如 Julia 的 \href{https://github.com/jump-dev}{JuMP} (\url{https://jump.dev/})，Octave (\url{https://www.gnu.org/software/octave/}) 内置的优化函数，Python 模块 \href{https://github.com/scipy/scipy}{SciPy} 提供 \href{https://docs.scipy.org/doc/scipy/reference/tutorial/optimize.html}{Optimization 优化求解器}，\href{https://github.com/cvxopt/cvxopt}{cvxopt} 凸优化求解器，主要基于内点法，提供 Julia、Python、Matlab 接口，算法介绍见 \href{http://www.seas.ucla.edu/~vandenbe/publications/coneprog.pdf}{锥优化} \href{http://www.seas.ucla.edu/~vandenbe/publications/mlbook.pdf}{机器学习优化}。 课程见 \href{https://github.com/epfml/OptML_course}{Optimization for Machine Learning}，书籍见\href{https://stanford.edu/~boyd/cvxbook/}{Convex Optimization}，相关综述见\href{https://arxiv.org/pdf/1405.4980.pdf}{Convex Optimization: Algorithms and Complexity}。

Berwin A. Turlach 开发的 \href{https://CRAN.R-project.org/package=quadprog}{quadprog} 主要用于求解二次规划问题。\href{https://web.stanford.edu/~anqif/}{Anqi Fu} 开发的 \href{https://github.com/anqif/CVXR}{CVXR} 可解很多凸优化问题 \citep{CVXR2020}，详见网站 \url{https://cvxr.rbind.io/}，\href{https://www.ucl.ac.uk/~uctpjyy/nloptr.html}{Jelmer Ypma} 开发的 \href{https://github.com/jyypma/nloptr}{nloptr} 可解无约束和有约束的非线性规划问题 \citep{nloptr}，\href{https://github.com/mbinois/GPareto}{GPareto} 求解多目标优化问题，帕雷托前沿优化和估计\citep{GPareto2019}。\href{https://github.com/igraph/igraph/}{igraph} 可以用来解决最短路径、最大网络流、最小生成树等图优化相关的问题。 \url{https://palomar.home.ece.ust.hk/MAFS6010R_lectures/Rsession_solvers.html} 提供了一般的求解器介绍。ROI 包力图统一各个求解器的调用接口，打造一个优化算法的基础设施平台。\citet{ROI2020} 详细介绍了目前优化算法发展情况及 R 社区提供的优化能力。\href{https://github.com/luca-scr/GA}{GA} 包实现了遗传算法，支持连续和离散的空间搜索，可以并行 \citep{GA2013, GA2017}，是求解 TSP 问题的重要方法。NMOF 包实现了差分进化、遗传算法、粒子群算法、模拟退火算法等启发式优化算法，还提供网格搜索和贪婪搜索工具，\citet{NMOF2019} 提供了详细的介绍。\citet{Nash2014} 总结了 R 语言环境下最优化问题的最佳实践。\href{https://github.com/coatless/rcppensmallen}{RcppEnsmallen} 数值优化 通用标准的优化方法，前沿最新的优化方法，包含小批量/全批量梯度下降技术、无梯度优化器，约束优化技术。\href{https://github.com/yixuan/RcppNumerical}{RcppNumerical} 无约束数值优化，一维/多维数值积分。

谷歌开源的运筹优化工具 \href{https://github.com/google/or-tools}{or-tools} 提供了约束优化、线性优化、混合整数优化、装箱和背包算法、TSP（Traveling Salesman Problem）、VRP（Vehicle Routing Problem）、图算法（最短路径、最小成本流、最大流等）等算法和求解器。「运筹OR帷幄」社区开源的 \href{https://github.com/Operations-Research-Science/Ebook-Linear_Programming}{线性规划} 一书值得一看。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 加载 ROI 时不要自动加载插件}
\FunctionTok{Sys.setenv}\NormalTok{(}\AttributeTok{ROI\_LOAD\_PLUGINS =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{library}\NormalTok{(lpSolve)    }\CommentTok{\# 线性规划求解器}
\FunctionTok{library}\NormalTok{(ROI)        }\CommentTok{\# 优化工具箱}
\FunctionTok{library}\NormalTok{(ROI.plugin.alabama)  }\CommentTok{\# 注册 alabama 求解非线性规划}
\FunctionTok{library}\NormalTok{(ROI.plugin.nloptr)   }\CommentTok{\# 注册 nloptr 求解非线性规划}
\FunctionTok{library}\NormalTok{(ROI.plugin.lpsolve)  }\CommentTok{\# 注册 lpsolve 求解线性规划}
\FunctionTok{library}\NormalTok{(ROI.plugin.quadprog) }\CommentTok{\# 注册 quadprog 求解二次规划}
\FunctionTok{library}\NormalTok{(ROI.plugin.scs)      }\CommentTok{\# 注册 scs 求解凸锥规划}
\FunctionTok{library}\NormalTok{(lattice)    }\CommentTok{\# 图形绘制}
\FunctionTok{library}\NormalTok{(kernlab)    }\CommentTok{\# 优化问题和机器学习的关系}

\FunctionTok{library}\NormalTok{(rootSolve)       }\CommentTok{\# 非线性方程}
\FunctionTok{library}\NormalTok{(BB)              }\CommentTok{\# 非线性方程组}
\FunctionTok{library}\NormalTok{(deSolve)         }\CommentTok{\# ODE 常微分方程}
\FunctionTok{library}\NormalTok{(scatterplot3d)   }\CommentTok{\# 三维曲线图}

\FunctionTok{library}\NormalTok{(shape)}
\FunctionTok{library}\NormalTok{(ReacTran)        }\CommentTok{\# PDE 偏微分方程}
\FunctionTok{library}\NormalTok{(PBSddesolve)     }\CommentTok{\# DAE 延迟微分方程}

\FunctionTok{library}\NormalTok{(nlme)              }\CommentTok{\# 混合效应模型}
\CommentTok{\# library(nlmeODE)         \# ODE 应用于混合效应模型}
\CommentTok{\# library(Sim.DiffProc)    \# SDE 随机微分方程 种群 ODE 建模}
\CommentTok{\# library(nlmixr)          \# Population ODE modeling}
\end{Highlighting}
\end{Shaded}

表 \ref{tab:roi-plugin-latex} 对目前的优化器按优化问题做了分类

\begin{table}

\caption{\label{tab:roi-plugin-latex}ROI 插件按优化问题分类}
\centering
\begin{tabular}[t]{>{\raggedright\arraybackslash}p{2cm}>{\raggedright\arraybackslash}p{2cm}>{\raggedright\arraybackslash}p{2cm}>{\raggedright\arraybackslash}p{2cm}>{\raggedright\arraybackslash}p{2cm}}
\toprule
  & Linear & Quadratic & Conic & Functional\\
\midrule
No &  &  &  & \\
Box &  &  &  & optimx\\
Linear & $\mathrm{clp}^\star$, $\mathrm{cbc}^{\star+}$, $\mathrm{glpk}^{\star+}$, $\mathrm{lpsolve}^{\star+}$, $\mathrm{msbinlp}^{\star+}$, $\mathrm{symphony}^{\star+}$ & ipop, $\mathrm{quadprog}^{\star}$, qpoases &  & \\
Quadratic &  & $\mathrm{cplex}^{+}$, $\mathrm{gurobi}^{\star+}$, $\mathrm{mosek}^{\star+}$, $\mathrm{neos}^{+}$ &  & \\
Conic &  &  & $\mathrm{ecos}^{\star+}$, $\mathrm{scs}^{\star}$ & \\
\addlinespace
Functional &  &  &  & alabama, deoptim, nlminb, nloptr\\
\bottomrule
\multicolumn{5}{l}{\rule{0pt}{1em}\textsuperscript{*} 求解器受限于凸优化问题}\\
\multicolumn{5}{l}{\rule{0pt}{1em}\textsuperscript{+} 求解器可以处理整型约束}\\
\end{tabular}
\end{table}

\hypertarget{sec-linear-programming}{%
\section{线性规划}\label{sec-linear-programming}}

\href{https://cran.r-project.org/package=clpAPI}{clpAPI} 线性规划求解器。\href{https://www.gnu.org/software/glpk/}{glpk} 的两个 R 接口 -- \href{https://cran.r-project.org/package=glpkAPI}{glpkAPI} 和 \href{https://CRAN.R-project.org/package=Rglpk}{Rglpk} 提供线性规划和混合整数规划的求解能力。\href{http://lpsolve.sourceforge.net/}{lp\_solve} 的两个 R 接口 -- \href{https://cran.r-project.org/package=lpSolveAPI}{lpSolveAPI} 和 \href{https://github.com/gaborcsardi/lpSolve}{lpSolve} 也提供类似的能力。\href{https://github.com/dirkschumacher/ompr}{ompr} 求解混合整数线性规划问题。

举个例子，如下

\begin{equation*}
\begin{array}{l}
  \min_x \quad -6x_1 -5x_2 \\
    s.t.\left\{ 
    \begin{array}{l}
    x_1  + 4x_2 \leq 16\\
    6x_1 + 4x_2 \leq 28\\
    2x_1 - 5x_2 \leq 6
    \end{array} \right.
\end{array}
\end{equation*}

写成矩阵形式

\begin{equation*}
\begin{array}{l}
\min_x \quad
  \begin{bmatrix}
  -6  \\
  -5
  \end{bmatrix}
  ^{T} x \\
s.t.\left\{ 
 \begin{array}{l}
  \begin{bmatrix}
  1 & 4  \\
  6 & 4  \\
  2 & -5 
  \end{bmatrix}
  x \leq
  \begin{bmatrix}
   16 \\
   28 \\
   6
  \end{bmatrix}
 \end{array} \right.
\end{array} 
\end{equation*}

对应成 R 代码如下

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# lpSolve 添加约束条件}
\FunctionTok{library}\NormalTok{(lpSolve)}
\CommentTok{\# 目标}
\NormalTok{f.obj }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{)}
\CommentTok{\# 约束}
\NormalTok{f.con }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 方向}
\NormalTok{f.dir }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{)}
\CommentTok{\# 右手边}
\NormalTok{f.rhs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{28}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{lp}\NormalTok{(}\StringTok{"min"}\NormalTok{, f.obj, f.con, f.dir, f.rhs)}
\NormalTok{res}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -31.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.4 3.4
\end{verbatim}

\hypertarget{sec-integer-programming}{%
\section{整数规划}\label{sec-integer-programming}}

\hypertarget{common-integer-programming}{%
\subsection{一般整数规划}\label{common-integer-programming}}

\begin{equation*}
\begin{array}{l}
  \max_x \quad 0.2x_1 + 0.6x_2 \\
    s.t.\left\{ 
    \begin{array}{l}
    5x_1  + 3x_2 \leq 250\\
    -3x_1 + 2x_2 \leq 4\\
    x_1,x_2 \geq 0, \quad x_1,x_2 \in \mathbb{Z}
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标}
\NormalTok{f.obj }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.6}\NormalTok{)}
\CommentTok{\# 约束}
\NormalTok{f.con }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 方向}
\NormalTok{f.dir }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{)}
\CommentTok{\# 右手边}
\NormalTok{f.rhs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{250}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\CommentTok{\# 限制两个变量都是整数}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{lp}\NormalTok{(}\StringTok{"max"}\NormalTok{, f.obj, f.con, f.dir, f.rhs, }\AttributeTok{int.vec=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{)}
\NormalTok{res}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 29.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 26 40
\end{verbatim}

\hypertarget{binary-integer-programming}{%
\subsection{0-1 整数规划}\label{binary-integer-programming}}

\begin{equation*}
\begin{array}{l}
  \max_x \quad 0.2x_1 + 0.6x_2 \\
    s.t.\left\{ 
    \begin{array}{l}
    5x_1  + 3x_2 \leq 250\\
    -3x_1 + 2x_2 \leq 4\\
    x_1,x_2 \in \{0,1\}
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标}
\NormalTok{f.obj }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.6}\NormalTok{)}
\CommentTok{\# 约束}
\NormalTok{f.con }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# 方向}
\NormalTok{f.dir }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{)}
\CommentTok{\# 右手边}
\NormalTok{f.rhs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{250}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\CommentTok{\# 限制两个变量都是0{-}1整数}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{lp}\NormalTok{(}\StringTok{"max"}\NormalTok{, f.obj, f.con, f.dir, f.rhs, }\AttributeTok{int.vec=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\AttributeTok{all.bin =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{res}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 1
\end{verbatim}

\hypertarget{mixed-integer-programming}{%
\subsection{混合整数规划}\label{mixed-integer-programming}}

\href{https://cran.r-project.org/package=Rsymphony}{Rsymphony} 是混合整数规划求解器 \href{https://github.com/coin-or/SYMPHONY}{SYMPHONY} 的 R 语言接口\footnote{以 MacOS 为例安装 symphony 软件

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{brew}\NormalTok{ tap coin{-}or{-}tools/coinor}
\ExtensionTok{brew}\NormalTok{ install symphony}
\end{Highlighting}
\end{Shaded}
}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Rsymphony)}
\DocumentationTok{\#\# Simple linear program.}
\DocumentationTok{\#\# maximize: 2 x\_1 + 4 x\_2 + 3 x\_3}
\DocumentationTok{\#\# subject to: 3 x\_1 + 4 x\_2 + 2 x\_3 \textless{}= 60}
\DocumentationTok{\#\# 2 x\_1 + x\_2 + x\_3 \textless{}= 40}
\DocumentationTok{\#\# x\_1 + 3 x\_2 + 2 x\_3 \textless{}= 80}
\DocumentationTok{\#\# x\_1, x\_2, x\_3 are non{-}negative real numbers}

\CommentTok{\# 简单线性规划}
\NormalTok{obj }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{mat }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{3}\NormalTok{)}
\NormalTok{dir }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{)}
\NormalTok{rhs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{60}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{80}\NormalTok{)}
\NormalTok{max }\OtherTok{\textless{}{-}} \ConstantTok{TRUE}
\FunctionTok{Rsymphony\_solve\_LP}\NormalTok{(obj, mat, dir, rhs, }\AttributeTok{max =}\NormalTok{ max)}

\CommentTok{\# 混合整数规划}
\NormalTok{obj }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{mat }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{3}\NormalTok{)}
\NormalTok{dir }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{)}
\NormalTok{rhs }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{max }\OtherTok{\textless{}{-}} \ConstantTok{TRUE}
\NormalTok{types }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"I"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"I"}\NormalTok{)}
\FunctionTok{Rsymphony\_solve\_LP}\NormalTok{(obj, mat, dir, rhs, }\AttributeTok{types =}\NormalTok{ types, }\AttributeTok{max =}\NormalTok{ max)}

\CommentTok{\# 有边界约束的混合整数规划}
\DocumentationTok{\#\# Same as before but with bounds replaced by}
\DocumentationTok{\#\# {-}Inf \textless{} x\_1 \textless{}= 4}
\DocumentationTok{\#\# 0 \textless{}= x\_2 \textless{}= 100}
\DocumentationTok{\#\# 2 \textless{}= x\_3 \textless{} Inf}
\NormalTok{bounds }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{lower =} \FunctionTok{list}\NormalTok{(}\AttributeTok{ind =} \FunctionTok{c}\NormalTok{(1L, 3L), }\AttributeTok{val =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\ConstantTok{Inf}\NormalTok{, }\DecValTok{2}\NormalTok{)),}
  \AttributeTok{upper =} \FunctionTok{list}\NormalTok{(}\AttributeTok{ind =} \FunctionTok{c}\NormalTok{(1L, 2L), }\AttributeTok{val =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{100}\NormalTok{))}
\NormalTok{)}
\FunctionTok{Rsymphony\_solve\_LP}\NormalTok{(obj, mat, dir, rhs,}
  \AttributeTok{types =}\NormalTok{ types, }\AttributeTok{max =}\NormalTok{ max,}
  \AttributeTok{bounds =}\NormalTok{ bounds}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

一部分变量要求是整数

\begin{equation*}
\begin{array}{l}
  \max_x \quad 3x_1 + 7x_2 - 12x_3 \\
    s.t.\left\{ 
    \begin{array}{l}
    5x_1 + 7x_2 + 2x_3 \leq 61\\
    3x_1 + 2x_2 - 9x_3 \leq 35\\
    x_1 + 3x_2 + x_3 \leq 31\\
    x_1,x_2 \geq 0, \quad x_2, x_3 \in \mathbb{Z}, \quad x_3 \in [-10, 10]
    \end{array} \right.
\end{array}
\end{equation*}

矩阵形式如下

\begin{equation*}
\begin{array}{l}
\min_x \quad
  \begin{bmatrix}
  3  \\
  7  \\
  -12
  \end{bmatrix}
  ^{T} x \\
s.t.\left\{ 
 \begin{array}{l}
  \begin{bmatrix}
  5 & 7 & 2 \\
  3 & 2 & -9\\
  1 & 3 & 1
  \end{bmatrix}
  x \leq
  \begin{bmatrix}
   61 \\
   35 \\
   31
  \end{bmatrix}
 \end{array} \right.
\end{array} 
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{L\_objective}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{7}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{12}\NormalTok{)),}
  \CommentTok{\# 指定变量类型：第1个变量是连续值，第2、3个变量是整数}
  \AttributeTok{types =} \FunctionTok{c}\NormalTok{(}\StringTok{"C"}\NormalTok{, }\StringTok{"I"}\NormalTok{, }\StringTok{"I"}\NormalTok{),}
  \AttributeTok{constraints =} \FunctionTok{L\_constraint}\NormalTok{(}
    \AttributeTok{L =} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
      \DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{2}\NormalTok{,}
      \DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{9}\NormalTok{,}
      \DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}
\NormalTok{    ), }\AttributeTok{ncol =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{dir =} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{),}
    \AttributeTok{rhs =} \FunctionTok{c}\NormalTok{(}\DecValTok{61}\NormalTok{, }\DecValTok{35}\NormalTok{, }\DecValTok{31}\NormalTok{)}
\NormalTok{  ),}
  \CommentTok{\# 添加约束：第3个变量的下、上界分别是 {-}10 和 10}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{li =} \DecValTok{3}\NormalTok{, }\AttributeTok{ui =} \DecValTok{3}\NormalTok{, }\AttributeTok{lb =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{ub =} \DecValTok{10}\NormalTok{, }\AttributeTok{nobj =} \DecValTok{3}\NormalTok{),}
  \AttributeTok{maximum =} \ConstantTok{TRUE}
\NormalTok{)}
\NormalTok{op}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ROI Optimization Problem:
## 
## Maximize a linear objective function of length 3 with
## - 1 continuous objective variable,
## - 2 integer objective variables,
## 
## subject to
## - 3 constraints of type linear.
## - 1 lower and 1 upper non-standard variable bound.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"lpsolve"}\NormalTok{)}
\NormalTok{res}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  0.3333333  8.0000000 -2.0000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 81
\end{verbatim}

\hypertarget{sec-quadratic-programming}{%
\section{二次规划}\label{sec-quadratic-programming}}

\hypertarget{sec-strictly-convex-quadratic-program}{%
\subsection{凸二次规划}\label{sec-strictly-convex-quadratic-program}}

在 R 中使用 \textbf{quadprog} \citep{quadprog2019} 包求解二次规划\footnote{\url{https://rwalk.xyz/solving-quadratic-progams-with-rs-quadprog-package/}}，\textbf{quadprogXT} 包用来求解带绝对值约束的二次规划，\textbf{pracma} \citep{pracma2021}包提供 \texttt{quadprog()} 函数就是对 \textbf{quadprog} 包的 \texttt{solve.QP()} 进行封装，调用风格更像 Matlab。\textbf{quadprog} 包实现了 Goldfarb and Idnani (1982, 1983) 提出的对偶方法，主要用来求解带线性约束的严格凸二次规划问题。quadprog 求解的二次型的形式如下：

\[\min_b - d^{\top}b +\frac{1}{2}b^{\top}Db , \quad A^{\top}b \geq b_{0}\]

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{solve.QP}\NormalTok{(Dmat, dvec, Amat, bvec, }\AttributeTok{meq =} \DecValTok{0}\NormalTok{, }\AttributeTok{factorized =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

参数 \texttt{Dmat}、\texttt{dvec}、\texttt{Amat}、\texttt{bvec} 分别对应二次规划问题中的 \(D,d,A,b_{0}\)。下面举个二次规划的具体例子

\[
D = \begin{bmatrix}2 & -1\\
-1 & 2
\end{bmatrix}, \quad
d = (-3,2), \quad
A = \begin{bmatrix}1 & 1\\
-1 & 1 \\
0  & -1
\end{bmatrix}, \quad
b_{0} = (2,-2,-3)
\] 即目标函数 \[Q(x,y) = x^2 + y^2 -xy+3x-2y+4\] 它的可行域如图\ref{fig:feasible-region}所示

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
  \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\FloatTok{5.5}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\FloatTok{3.5}\NormalTok{), }\AttributeTok{type =} \StringTok{"n"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"x"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"y"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Feasible Region"}
\NormalTok{)}
\FunctionTok{polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{), }\AttributeTok{border =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"gray"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/feasible-region-1} 

}

\caption{可行域}\label{fig:feasible-region}
\end{figure}

调用 \textbf{quadprog} 包的 \texttt{solve.QP()} 函数求解此二次规划问题

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(quadprog)}
\NormalTok{Dmat }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{dvec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{A }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{bvec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{)}
\NormalTok{Amat }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(A)}
\NormalTok{sol }\OtherTok{\textless{}{-}} \FunctionTok{solve.QP}\NormalTok{(}\AttributeTok{Dmat =}\NormalTok{ Dmat, }\AttributeTok{dvec =}\NormalTok{ dvec, }\AttributeTok{Amat =}\NormalTok{ Amat, }\AttributeTok{bvec =}\NormalTok{ bvec)}
\NormalTok{sol}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $solution
## [1] 0.1666667 1.8333333
## 
## $value
## [1] -0.08333333
## 
## $unconstrained.solution
## [1] -1.3333333  0.3333333
## 
## $iterations
## [1] 2 0
## 
## $Lagrangian
## [1] 1.5 0.0 0.0
## 
## $iact
## [1] 1
\end{verbatim}

ROI 默认的二次规划的标准形式为 \(\frac{1}{2}x^{\top}Qx + a^{\top}x\)，在传递参数值的时候注意和上面的区别。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ROI)}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{Q\_objective}\NormalTok{(}\AttributeTok{Q =}\NormalTok{ Dmat, }\AttributeTok{L =} \SpecialCharTok{{-}}\NormalTok{dvec),}
  \AttributeTok{constraints =} \FunctionTok{L\_constraint}\NormalTok{(A, }\FunctionTok{rep}\NormalTok{(}\StringTok{"\textgreater{}="}\NormalTok{, }\DecValTok{3}\NormalTok{), bvec),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 默认求最小}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.slsqp"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.08333333
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.1666667 1.8333333
\end{verbatim}

对变量 \(x\) 添加整型约束，原二次规划即变成混合整数二次规划 （Mixed Integer Quadratic Programming，简称 MIQP）

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目前开源的求解器都不能处理 MIQP 问题}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{Q\_objective}\NormalTok{(}\AttributeTok{Q =}\NormalTok{ Dmat, }\AttributeTok{L =} \SpecialCharTok{{-}}\NormalTok{dvec),}
  \AttributeTok{constraints =} \FunctionTok{L\_constraint}\NormalTok{(A, }\FunctionTok{rep}\NormalTok{(}\StringTok{"\textgreater{}="}\NormalTok{, }\DecValTok{3}\NormalTok{), bvec),}
  \AttributeTok{types =} \FunctionTok{c}\NormalTok{(}\StringTok{"I"}\NormalTok{, }\StringTok{"C"}\NormalTok{),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 默认求最小}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.slsqp"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

在可行域上画出等高线，标记目标解的位置，图中红点表示无约束下的解，黄点表示线性约束下的解

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{qp\_sol }\OtherTok{\textless{}{-}}\NormalTok{ sol}\SpecialCharTok{$}\NormalTok{solution }\CommentTok{\# 二次规划的解}
\NormalTok{uc\_sol }\OtherTok{\textless{}{-}}\NormalTok{ sol}\SpecialCharTok{$}\NormalTok{unconstrained.solution }\CommentTok{\# 无约束情况下的解}
\CommentTok{\# 画图}
\FunctionTok{library}\NormalTok{(lattice)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\FloatTok{5.5}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{500}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\FloatTok{3.5}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{500}\NormalTok{)}
\NormalTok{grid }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)}
\CommentTok{\# 二次规划的目标函数}
\NormalTok{grid}\SpecialCharTok{$}\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{with}\NormalTok{(grid, x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x }\SpecialCharTok{{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ y }\SpecialCharTok{+} \DecValTok{4}\NormalTok{)}
\FunctionTok{levelplot}\NormalTok{(z }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y, grid,}
  \AttributeTok{cuts =} \DecValTok{40}\NormalTok{,}
  \AttributeTok{panel =} \ControlFlowTok{function}\NormalTok{(...) \{}
    \FunctionTok{panel.levelplot}\NormalTok{(...)}
    \FunctionTok{panel.polygon}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{),}
      \AttributeTok{border =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{lwd =} \DecValTok{2}\NormalTok{, }\AttributeTok{col =} \StringTok{"transparent"}
\NormalTok{    )}
    \FunctionTok{panel.points}\NormalTok{(}
      \FunctionTok{c}\NormalTok{(uc\_sol[}\DecValTok{1}\NormalTok{], qp\_sol[}\DecValTok{1}\NormalTok{]),}
      \FunctionTok{c}\NormalTok{(uc\_sol[}\DecValTok{2}\NormalTok{], qp\_sol[}\DecValTok{2}\NormalTok{]),}
      \AttributeTok{lwd =} \DecValTok{5}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"red"}\NormalTok{, }\StringTok{"yellow"}\NormalTok{), }\AttributeTok{pch =} \DecValTok{19}
\NormalTok{    )}
\NormalTok{  \},}
  \AttributeTok{colorkey =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{col.regions =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{40}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/quadprog-1} 

}

\caption{无约束和有约束条件下的解}\label{fig:quadprog}
\end{figure}

\hypertarget{subsec-semidefinite-optimization}{%
\subsection{半正定二次优化}\label{subsec-semidefinite-optimization}}

kernlab 提供基于核的机器学习方法，可用于分类、回归、聚类、异常检测、分位回归、降维等场景，包含支撑向量机、谱聚类、核PCA、高斯过程和二次规划求解器，将优化方法用于机器学习，展示二者的关系。

R 包 kernlab 的函数 \texttt{ipop()} 实现内点法可以求解半正定的二次规划问题，对应到上面的例子，就是要求 \(A \geq 0\)，而 R 包 quadprog 只能求解正定的二次规划问题，即要求 \(A > 0\)。

以二分类问题为例，采用 SMO (Sequential Minimization Optimization) 求解器，将 SVM 的二次优化问题分解。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(kernlab)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{120}\NormalTok{), }\DecValTok{60}\NormalTok{, }\DecValTok{2}\NormalTok{), }\FunctionTok{matrix}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\DecValTok{120}\NormalTok{, }\AttributeTok{mean =} \DecValTok{3}\NormalTok{), }\DecValTok{60}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{60}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{60}\NormalTok{)))}
\NormalTok{svp }\OtherTok{\textless{}{-}} \FunctionTok{ksvm}\NormalTok{(x, y, }\AttributeTok{type =} \StringTok{"C{-}svc"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(svp, }\AttributeTok{data =}\NormalTok{ x)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/toy-binary-1} 

}

\caption{二分类问题}\label{fig:toy-binary}
\end{figure}

\hypertarget{sec-nonlinear-programming}{%
\section{非线性规划}\label{sec-nonlinear-programming}}

开源的非线性优化求解器，推荐使用 nloptr，它支持全局优化，同时推荐 ROI，它有统一的接口函数。

\hypertarget{sec-one-dimensional-optimization}{%
\subsection{一元非线性优化}\label{sec-one-dimensional-optimization}}

下面考虑一个稍微复杂的一元函数优化问题，求复合函数的极值

\[
g(x) = \int_{0}^{x} -\sqrt{t}\exp(-t^2) \mathrm{dt}, \quad f(y) = \int_{0}^{y} g(s) \exp(-s) \mathrm{ds}
\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{g }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{integrate}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(t) \{}
    \SpecialCharTok{{-}}\FunctionTok{sqrt}\NormalTok{(t) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{t}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{  \}, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =}\NormalTok{ x)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{\}}

\NormalTok{f }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y) \{}
  \FunctionTok{integrate}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(s) \{}
    \FunctionTok{Vectorize}\NormalTok{(g, }\StringTok{"x"}\NormalTok{)(s) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{s)}
\NormalTok{  \}, }\AttributeTok{lower =} \DecValTok{0}\NormalTok{, }\AttributeTok{upper =}\NormalTok{ y)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{\}}

\FunctionTok{optimize}\NormalTok{(f, }\AttributeTok{interval =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{maximum =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $minimum
## [1] 66.84459
## 
## $objective
## [1] -0.3201572
\end{verbatim}

\begin{rmdtip}{提示}

计算积分的时候，输入了一系列 s 值，参数是向量，而函数 g 只支持输入参数是单个值，\texttt{g(c(1,2))} 会报错，因此上面对函数 \texttt{g()} 用了向量化函数 \texttt{Vectorize()} 操作。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{g}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.453392
\end{verbatim}

类似地，同时计算多个目标函数 \texttt{f(y)} 的值，也需要\texttt{Vectorize()} 实现向量化操作。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Vectorize}\NormalTok{(f, }\StringTok{"y"}\NormalTok{)(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.1103310 -0.2373865
\end{verbatim}

\end{rmdtip}

\hypertarget{sec-nonlinear-unconstrained-optimization}{%
\subsection{多元非线性无约束优化}\label{sec-nonlinear-unconstrained-optimization}}

下面这些用来测试优化算法的函数来自\href{https://en.wikipedia.org/wiki/Test_functions_for_optimization}{维基百科}

\hypertarget{himmelblau}{%
\subsubsection{Himmelblau 函数}\label{himmelblau}}

Himmelblau 函数是一个多摸函数，常用于比较优化算法的优劣。

\[f(x_1,x_2) = (x_1^2 + x_2 -11)^2 + (x_1 + x_2^2 -7)^2\] 它在四个位置取得一样的极小值，分别是 \(f(-3.7793, -3.2832) = 0\)，\(f(-2.8051, 3.1313) = 0\)，\(f(3, 2) = 0\)，\(f(3.5844, -1.8481) = 0\)。函数图像见图 \ref{fig:himmelblau}。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{   (x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{11}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}} \DecValTok{7}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{library}\NormalTok{(lattice)}
\CommentTok{\# 减少三维图形的边空}
\FunctionTok{lattice.options}\NormalTok{(}
  \AttributeTok{layout.widths =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{left.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\NormalTok{.}\DecValTok{6}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{),}
    \AttributeTok{right.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\FloatTok{1.0}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{layout.heights =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{bottom.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\NormalTok{.}\DecValTok{8}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{),}
    \AttributeTok{top.padding =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\FloatTok{1.0}\NormalTok{, }\AttributeTok{units =} \StringTok{"inches"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \SpecialCharTok{{-}}\DecValTok{240}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/himmelblau-1} 

}

\caption{Himmelblau 函数图像}\label{fig:himmelblau}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 梯度函数}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{])) }
\NormalTok{\}}
\FunctionTok{optim}\NormalTok{(}\AttributeTok{par =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =}\NormalTok{ gr, }\AttributeTok{method =} \StringTok{"BFGS"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] -2.805118  3.131313
## 
## $value
## [1] 2.069971e-27
## 
## $counts
## function gradient 
##       42       15 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
\end{verbatim}

\hypertarget{peaks}{%
\subsubsection{Peaks 函数}\label{peaks}}

测试函数

\[
f(x,y) = 3*(1-x)*\mathrm{e}^{-x^2 - (y+1)^2} - 10*(\frac{x}{5} - x^3 - y^5)*\mathrm{e}^{-x^2-y^2} - \frac{1}{3}*\mathrm{e}^{-(x+1)^2-y^2}
\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{peaks }\OtherTok{\textless{}{-}} \FunctionTok{expression}\NormalTok{(}\DecValTok{3}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{x)}\SpecialCharTok{*}\NormalTok{exp}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ (y}\SpecialCharTok{+}\DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{10}\SpecialCharTok{*}\NormalTok{(x}\SpecialCharTok{/}\DecValTok{5} \SpecialCharTok{{-}}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{{-}}\NormalTok{ y}\SpecialCharTok{\^{}}\DecValTok{5}\NormalTok{)}\SpecialCharTok{*}\NormalTok{exp}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{x}\SpecialCharTok{\^{}}\DecValTok{2}\SpecialCharTok{{-}}\NormalTok{y}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}}\DecValTok{1}\SpecialCharTok{/}\DecValTok{3}\SpecialCharTok{*}\NormalTok{exp}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(x}\SpecialCharTok{+}\DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\SpecialCharTok{{-}}\NormalTok{y}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{D}\NormalTok{(peaks, }\StringTok{"x"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## -(3 * (1 - x) * (exp^(-x^2 - (y + 1)^2) * (log(exp) * (2 * x))) + 
##     3 * exp^(-x^2 - (y + 1)^2) + (10 * (1/5 - 3 * x^2) * exp^(-x^2 - 
##     y^2) - 10 * (x/5 - x^3 - y^5) * (exp^(-x^2 - y^2) * (log(exp) * 
##     (2 * x)))) - 1/3 * (exp^(-(x + 1)^2 - y^2) * (log(exp) * 
##     (2 * (x + 1)))))
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{D}\NormalTok{(peaks, }\StringTok{"y"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## -(3 * (1 - x) * (exp^(-x^2 - (y + 1)^2) * (log(exp) * (2 * (y + 
##     1)))) - (10 * (x/5 - x^3 - y^5) * (exp^(-x^2 - y^2) * (log(exp) * 
##     (2 * y))) + 10 * (5 * y^4) * exp^(-x^2 - y^2)) - 1/3 * (exp^(-(x + 
##     1)^2 - y^2) * (log(exp) * (2 * y))))
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Deriv)}
\FunctionTok{Simplify}\NormalTok{(}\FunctionTok{D}\NormalTok{(peaks, }\StringTok{"x"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## -(10 * ((0.2 - 3 * x^2)/exp^(x^2 + y^2)) + 3/exp^((1 + y)^2 + 
##     x^2) + log(exp) * (x * (6 * ((1 - x)/exp^((1 + y)^2 + x^2)) - 
##     20 * ((x * (0.2 - x^2) - y^5)/exp^(x^2 + y^2))) - 0.666666666666667 * 
##     ((1 + x)/exp^((1 + x)^2 + y^2))))
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Simplify}\NormalTok{(}\FunctionTok{D}\NormalTok{(peaks, }\StringTok{"y"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## -((6 * ((1 - x) * (1 + y)/exp^((1 + y)^2 + x^2)) - 0.666666666666667 * 
##     (y/exp^((1 + x)^2 + y^2))) * log(exp) - y * (20 * (log(exp) * 
##     (x * (0.2 - x^2) - y^5)/exp^(x^2 + y^2)) + 50 * (y^3/exp^(x^2 + 
##     y^2))))
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \DecValTok{3} \SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ (x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}}
    \DecValTok{10} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{/} \DecValTok{5} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{5}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}}
    \DecValTok{1} \SpecialCharTok{/} \DecValTok{3} \SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\CommentTok{\# 梯度函数}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]))}
\NormalTok{\}}

\FunctionTok{optim}\NormalTok{(}\AttributeTok{par =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =}\NormalTok{ gr, }\AttributeTok{method =} \StringTok{"BFGS"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] -1.3473958  0.2045192
## 
## $value
## [1] -3.049849
## 
## $counts
## function gradient 
##       28       10 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
\end{verbatim}

在 \((-1.3473958, 0.2045192)\) 处取得极小值

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{library}\NormalTok{(lattice)}
\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]),}
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]),}
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \SpecialCharTok{{-}}\DecValTok{240}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/peaks-1} 

}

\caption{Peaks 多峰图像}\label{fig:peaks}
\end{figure}

函数来自 Octave 内置的 \texttt{peaks()} 函数，它有很多的局部极大值和极小值，可在 \href{https://octave-online.net/}{Octave Online} 上输入命令 \texttt{help\ peaks} 查看其帮助文档。

\hypertarget{rosenbrock}{%
\subsubsection{Rosenbrock 函数}\label{rosenbrock}}

\href{https://en.wikipedia.org/wiki/Rosenbrock_function}{香蕉函数} 定义如下：

\[f(x_1,x_2) = 100 (x_2 -x_1^2)^2 + (1 - x_1)^2\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  (}\DecValTok{100} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{2.5}\NormalTok{, }\FloatTok{2.5}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{2.5}\NormalTok{, }\FloatTok{2.5}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/rosenbrock-1} 

}

\caption{香蕉函数图像}\label{fig:rosenbrock}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{r }\OtherTok{\textless{}{-}}\NormalTok{ raster}\SpecialCharTok{::}\FunctionTok{rasterFromXYZ}\NormalTok{(df, }\AttributeTok{crs =} \FunctionTok{CRS}\NormalTok{(}\StringTok{"+proj=longlat +datum=WGS84"}\NormalTok{))}
\NormalTok{rasterVis}\SpecialCharTok{::}\FunctionTok{vectorplot}\NormalTok{(r, }\AttributeTok{par.settings =} \FunctionTok{RdBuTheme}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 梯度函数}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{])) }
\NormalTok{\}}
\FunctionTok{optim}\NormalTok{(}\AttributeTok{par =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =}\NormalTok{ gr, }\AttributeTok{method =} \StringTok{"BFGS"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] 1 1
## 
## $value
## [1] 9.595012e-18
## 
## $counts
## function gradient 
##      110       43 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 2L, }\AttributeTok{G =}\NormalTok{ gr),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\AttributeTok{ud =} \DecValTok{3}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 2L)}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.lbfgs"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.364878e-17
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 1
\end{verbatim}

\hypertarget{ackley}{%
\subsubsection{Ackley 函数}\label{ackley}}

Ackley 函数是一个非凸函数，有大量局部极小值点，获取全局极小值点是一个比较有挑战的事。它的 \(n\) 维形式如下： \[f(\mathbf{x}) = - a \mathrm{e}^{-b\sqrt{\frac{1}{n}\sum_{i=1}^{n}x_{i}^{2}}} - \mathrm{e}^{\frac{1}{n}\sum_{i=1}^{n}\cos(cx_i)} + a + \mathrm{e}\] 其中，\(a = 20, b = 0.2, c = 2\pi\)，对 \(\forall i = 1,2,\cdots, n\)，\(x_i \in [-10, 10]\)，\(f(\mathbf{x})\) 在 \(\mathbf{x}^{\star} = (0,0,\cdot,0)\) 取得全局最小值 \(f(\mathbf{x}^{\star}) = 0\)，二维图像如图 \ref{fig:ackley}。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{a =} \DecValTok{20}\NormalTok{, }\AttributeTok{b =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{c =} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi) \{}
\NormalTok{  mean1 }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{  mean2 }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(}\FunctionTok{cos}\NormalTok{(c }\SpecialCharTok{*}\NormalTok{ x))}
  \SpecialCharTok{{-}}\NormalTok{a }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{b }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(mean1)) }\SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(mean2) }\SpecialCharTok{+}\NormalTok{ a }\SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/ackley-1} 

}

\caption{二维 Ackley 函数图像}\label{fig:ackley}
\end{figure}

以 10 维的 Ackley 函数为例，先试一下普通的局部优化算法 --- Nelder--Mead 算法，选择初值 \((2,2,\cdots,2)\) ，看下效果，再与全局优化算法比较。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 10L),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{ud =} \DecValTok{10}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 10L)}
\NormalTok{)}

\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.neldermead"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 2 2 2 2 2 2 2 2 2 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6.593599
\end{verbatim}

可以说完全没有优化效果，已经陷入局部极小值。根据\href{https://nlopt.readthedocs.io/en/latest/NLopt_Algorithms/\#global-optimization}{nloptr 全局优化算法}的介绍，这里采用 directL 算法，因为是全局优化，不用选择初值。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 调全局优化器}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.directL"}\NormalTok{)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 0 0 0 0 0 0 0 0 0 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4.440892e-16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6.593599
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6.593599
\end{verbatim}

\hypertarget{radistrigin}{%
\subsubsection{Radistrigin 函数}\label{radistrigin}}

这里，还有另外一个例子，Radistrigin 函数也是多摸函数

\[f(\mathbf{x})= \sum_{i=1}^{n}\big(x_i^2 - 10 \cos(2\pi x_i) + 10\big)\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}} \DecValTok{10} \SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{*}\NormalTok{ x) }\SpecialCharTok{+} \DecValTok{10}\NormalTok{)}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{65}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/radistrigin-1} 

}

\caption{Radistrigin 函数}\label{fig:radistrigin}
\end{figure}

设置 10 维 的优化

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 10L),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\AttributeTok{ud =} \DecValTok{50}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 10L)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调全局优化器求解非凸优化问题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.directL"}\NormalTok{)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 0 0 0 0 0 0 0 0 0 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

\hypertarget{schaffer}{%
\subsubsection{Schaffer 函数}\label{schaffer}}

\[
f(x_1,x_2) = 0.5 + \frac{\sin^2(x_1^2 - x_2^2) - 0.5}{ [1 + 0.001(x_1^2 + x_2^2)]^2}
\] 在 \(\mathbf{x}^\star = (0,0)\) 处取得全局最小值 \(f(\mathbf{x}^\star) = 0\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FloatTok{0.5} \SpecialCharTok{+}\NormalTok{ ((}\FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FloatTok{0.001}\SpecialCharTok{*}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{length =} \DecValTok{201}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{length =} \DecValTok{201}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/schaffer-01-1} 

}

\caption{Schaffer 函数}\label{fig:schaffer-01}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/schaffer-02-1} 

}

\caption{Schaffer 函数}\label{fig:schaffer-02}
\end{figure}

\hypertarget{holder}{%
\subsubsection{Hölder 函数}\label{holder}}

Hölder 桌面函数

\[
f(x_1,x_2) = - | \sin(x_1)\cos(x_2)\exp\big(| 1 - \frac{\sqrt{x_1^2 + x_2^2}}{\pi}|\big) |
\]

在 \((8.05502, 9.66459)\)、\((-8.05502, 9.66459)\)、\((8.05502, -9.66459)\)、\((-8.05502, -9.66459)\) 同时取得最小值 \(-19.2085\)。



\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \SpecialCharTok{{-}}\FunctionTok{abs}\NormalTok{(}\FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\FunctionTok{abs}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{sqrt}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ pi))}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{60}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/holder-1} 

}

\caption{Hölder 函数}\label{fig:holder}
\end{figure}

\hypertarget{trid}{%
\subsubsection{Trid 函数}\label{trid}}

\(n \geq 2\) 维 Trid 函数

\[
f(x) = \sum_{i=1}^{n}(x_i - 1)^2 - \sum_{i=2}^{n}x_i x_{i-1}
\] \(\forall i = 1,2,\cdots, n\)，\(f(x)\) 在 \(x_i = i(n+1-i)\) 处取得全局极小值 \(f(\mathbf{x}^\star)=-n(n+4)(n-1)/6\)，取值区间 \(x \in [-n^2, n^2], \forall i = 1,2,\cdots,n\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(x)}
  \FunctionTok{sum}\NormalTok{((x }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\SpecialCharTok{{-}}\NormalTok{n])}
\NormalTok{\}}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, }\AttributeTok{length =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \SpecialCharTok{{-}}\DecValTok{60}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/trid-1} 

}

\caption{Trid 函数}\label{fig:trid}
\end{figure}

\hypertarget{super-complex-function}{%
\subsubsection{超级复杂函数}\label{super-complex-function}}

有如下复杂的目标函数

\begin{equation*}
\begin{array}{l}
  \min_x \quad \cos(x_1)\cos(x_2) - \sum_{i=1}^{5}\Big( (-1)^i \cdot i \cdot 2 \cdot \exp\big(-500 \cdot ( (x_1 - i \cdot 2)^2 + (x_2 - i\cdot 2)^2 ) \big) \Big) \\
    s.t. \quad -50 \leq x_1, x_2 \leq 50
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{subfun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(i, m) \{}
\NormalTok{  (}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{i }\SpecialCharTok{*}\NormalTok{ i }\SpecialCharTok{*} \DecValTok{2} \SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{500} \SpecialCharTok{*}\NormalTok{ ((m[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ i }\SpecialCharTok{*} \DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (m[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ i }\SpecialCharTok{*} \DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\NormalTok{\}}

\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{cos}\NormalTok{(x[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(x[}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{{-}}
    \FunctionTok{sum}\NormalTok{(}\FunctionTok{mapply}\NormalTok{(}\AttributeTok{FUN =}\NormalTok{ subfun, }\AttributeTok{i =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{m =}\NormalTok{ x)))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

目标函数的图像见图 \ref{fig:super-function}，搜索区域 \([-50, 50] \times [-50, 50]\) 内几乎没有变化的梯度，给寻优过程带来很大困难。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{101}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{101}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{65}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/super-function-1} 

}

\caption{函数图像}\label{fig:super-function}
\end{figure}

将区域 \([0, 12] \times [0, 12]\) 的图像绘制出来，不难发现，有不少局部陷阱。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{12}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{201}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, fn)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{1}\NormalTok{]), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(x[}\DecValTok{2}\NormalTok{]), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(f) }\SpecialCharTok{\textasciitilde{}} \FunctionTok{group}\NormalTok{(}\StringTok{"("}\NormalTok{, }\FunctionTok{list}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]), }\StringTok{")"}\NormalTok{)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{65}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/zoom-super-function-1} 

}

\caption{局部放大函数图像}\label{fig:zoom-super-function}
\end{figure}

最优解在 \((7.999982, 7.999982)\) 取得，目标函数值为 -7.978832。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{7.999982}\NormalTok{, }\FloatTok{7.999982}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -7.978832
\end{verbatim}

面对如此复杂的函数，调用全局优化器

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 2L),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\AttributeTok{ud =} \DecValTok{50}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 2L)}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.directL"}\NormalTok{)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]   0.00000 -21.99115
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1
\end{verbatim}

实际上，还是陷入局部最优解。

\begin{verbatim}
SETS:
P/1..5/;
Endsets
Min=@cos(x1) * @cos(x2) - @Sum(P(j): (-1)^j * j * 2 * @exp(-500 * ((x1 - j * 2)^2 + (x2 - j * 2)^2)));
@Bnd(-50, x1, 50);
@Bnd(-50, x2, 50);
\end{verbatim}

Lingo 18.0 启用全局优化求解器后，在 \((x_1 = 7.999982, x_2 = 7.999982)\) 取得最小值 -7.978832。而默认未启用全局优化求解器的情况下，在 \((x_1 = 18.84956, x_2 = -40.84070)\) 取得局部极小值 -1.000000。

\hypertarget{sec-nonlinear-constrained-optimization}{%
\subsection{多元非线性约束优化}\label{sec-nonlinear-constrained-optimization}}

R 自带的函数 \texttt{nlminb()} 可求解无约束、箱式约束优化问题，\texttt{constrOptim()} 还可求解线性不等式约束优化，其中包括带线性约束的二次规划。\texttt{optim()} 提供一大类优化算法，且包含随机优化算法---模拟退火算法，可求解无约束、箱式约束优化问题。

\hypertarget{box-constrained-optimization}{%
\subsubsection{普通箱式约束}\label{box-constrained-optimization}}

有如下箱式约束优化问题，目标函数和\href{https://en.wikipedia.org/wiki/Rosenbrock_function}{香蕉函数}有些相似。

\begin{equation*}
\begin{array}{l}
  \min_x \quad (x_1 - 1)^2 + 4\sum_{i =1}^{n -1}(x_{i+1} -x_i^2)^2  \\
    s.t. \quad 2 \leq x_1,x_2,\cdots,x_n \leq 4
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(x)}
  \FunctionTok{sum}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{*}\NormalTok{ (x }\SpecialCharTok{{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, x[}\SpecialCharTok{{-}}\NormalTok{n])}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\(n\) 维目标函数是非线性的，给定初值 \((3, 3, \cdots, 3)\)，下面求解 25 维的箱式约束，

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nlminb}\NormalTok{(}\AttributeTok{start =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{objective =}\NormalTok{ fn, }\AttributeTok{lower =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
##  [9] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
## [17] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.109093
## [25] 4.000000
## 
## $objective
## [1] 368.1059
## 
## $convergence
## [1] 0
## 
## $iterations
## [1] 6
## 
## $evaluations
## function gradient 
##       10      177 
## 
## $message
## [1] "relative convergence (4)"
\end{verbatim}

\texttt{nlminb()} 出于历史兼容性的原因尚且存在，最优解的第24个分量没有在可行域的边界上。使用 \texttt{constrOptim()} 函数求解，默认求极小，需将箱式或线性不等式约束写成矩阵形式，即 \(Ax \geq b\) 的形式，参数 ui 是 \(k \times n\) 的约束矩阵 \(A\)，ci 是右侧 \(k\) 维约束向量 \(b\)。以上面的优化问题为例，将箱式约束 \(2 \leq x_1,x_2 \leq 4\) 转化为矩阵形式，约束矩阵和向量分别为：

\[
A = \begin{bmatrix}
1  & 0  \\
0  & 1 \\
-1 & 0 \\
0  & -1
\end{bmatrix}, \quad
b = (2, 2, -4, -4)
\]

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{constrOptim}\NormalTok{(}
  \AttributeTok{theta =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\CommentTok{\# 初始值}
  \AttributeTok{f =}\NormalTok{ fn, }\CommentTok{\# 目标函数}
  \AttributeTok{method =} \StringTok{"Nelder{-}Mead"}\NormalTok{, }\CommentTok{\# 没有提供梯度，则必须用 Nelder{-}Mead 方法}
  \AttributeTok{ui =} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{)), }\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{))),}
  \AttributeTok{ci =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.006142 2.002260 2.003971 2.003967 2.004143 2.004255 2.001178 2.002990
##  [9] 2.003883 2.006029 2.017345 2.009236 2.000949 2.007793 2.025831 2.007896
## [17] 2.004514 2.004381 2.008771 2.015695 2.005803 2.009127 2.017988 2.257782
## [25] 3.999846
## 
## $value
## [1] 378.4208
## 
## $counts
## function gradient 
##    12048       NA 
## 
## $convergence
## [1] 1
## 
## $message
## NULL
## 
## $outer.iterations
## [1] 25
## 
## $barrier.value
## [1] -0.003278963
\end{verbatim}

从求解的结果来看，convergence = 1 意味着迭代次数到达默认的极限 maxit = 500，结合 \texttt{nlminb()} 函数的求解结果来看，实际上还没有收敛。如果没有提供梯度，则必须用 Nelder-Mead 方法，下面增加迭代次数到 1000。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{constrOptim}\NormalTok{(}
  \AttributeTok{theta =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\CommentTok{\# 初始值}
  \AttributeTok{f =}\NormalTok{ fn, }\CommentTok{\# 目标函数}
  \AttributeTok{method =} \StringTok{"Nelder{-}Mead"}\NormalTok{, }
  \AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maxit =} \DecValTok{1000}\NormalTok{),}
  \AttributeTok{ui =} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{)), }\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{))),}
  \AttributeTok{ci =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.000081 2.000142 2.001919 2.000584 2.000007 2.000003 2.001097 2.001600
##  [9] 2.000207 2.000042 2.000250 2.000295 2.000580 2.002165 2.000453 2.000932
## [17] 2.000456 2.000363 2.000418 2.000474 2.009483 2.001156 2.003173 2.241046
## [25] 3.990754
## 
## $value
## [1] 370.8601
## 
## $counts
## function gradient 
##    18036       NA 
## 
## $convergence
## [1] 1
## 
## $message
## NULL
## 
## $outer.iterations
## [1] 19
## 
## $barrier.value
## [1] -0.003366467
\end{verbatim}

还是没有收敛，可见 Nelder-Mead 方法在这个优化问题上收敛速度比较慢。下面考虑调用基于梯度的优化算法 --- BFGS 方法。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 输入 n 维向量，输出 n 维向量}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(x)}
  \FunctionTok{c}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, n }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{))}
  \SpecialCharTok{+}\DecValTok{8} \SpecialCharTok{*} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\SpecialCharTok{{-}}\NormalTok{n]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
  \SpecialCharTok{{-}}\DecValTok{16} \SpecialCharTok{*} \FunctionTok{c}\NormalTok{(x[}\SpecialCharTok{{-}}\NormalTok{n], }\DecValTok{0}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{c}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\SpecialCharTok{{-}}\NormalTok{n]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{\}}

\FunctionTok{constrOptim}\NormalTok{(}
  \AttributeTok{theta =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\CommentTok{\# 初始值}
  \AttributeTok{f =}\NormalTok{ fn, }\CommentTok{\# 目标函数}
  \AttributeTok{grad =}\NormalTok{ gr,}
  \AttributeTok{method =} \StringTok{"BFGS"}\NormalTok{, }
  \AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maxit =} \DecValTok{1000}\NormalTok{),}
  \AttributeTok{ui =} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{)), }\FunctionTok{diag}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{))),}
  \AttributeTok{ci =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
##  [9] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
## [17] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000001
## [25] 3.000000
## 
## $value
## [1] 373
## 
## $counts
## function gradient 
##     3721      464 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
## 
## $outer.iterations
## [1] 3
## 
## $barrier.value
## [1] -0.003327104
\end{verbatim}

相比于 Nelder-Mead 方法，目标值 373 更大，可见已陷入局部最优解，下面通过 ROI 包，分别调用求解器 L-BFGS 和 directL，发现前者同样陷入局部最优解，而后者可以获得与 \texttt{nlminb()} 函数一致的结果。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 调用改进的 BFGS 算法}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(fn, }\AttributeTok{n =}\NormalTok{ 25L, }\AttributeTok{G =}\NormalTok{ gr),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \DecValTok{2}\NormalTok{, }\AttributeTok{ud =} \DecValTok{4}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 25L)}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.lbfgs"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 373
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 调全局优化算法}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.directL"}\NormalTok{)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 368.1059
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000
## [10] 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000 2.00000
## [19] 2.00000 2.00000 2.00000 2.00000 2.00000 2.10913 4.00000
\end{verbatim}

下面再与函数 \texttt{optim()} 提供的 L-BFGS-B 算法比较

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{optim}\NormalTok{(}
  \AttributeTok{par =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{method =} \StringTok{"L{-}BFGS{-}B"}\NormalTok{,}
  \AttributeTok{lower =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
##  [9] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000
## [17] 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.000000 2.109093
## [25] 4.000000
## 
## $value
## [1] 368.1059
## 
## $counts
## function gradient 
##        6        6 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH"
\end{verbatim}

值得注意的是，当提供梯度信息的时候，虽然求解速度提升了，但是最优解变差了。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{optim}\NormalTok{(}
  \AttributeTok{par =} \FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{gr =}\NormalTok{ gr, }\AttributeTok{method =} \StringTok{"L{-}BFGS{-}B"}\NormalTok{,}
  \AttributeTok{lower =} \FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{25}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{25}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
##  [1] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3
## 
## $value
## [1] 373
## 
## $counts
## function gradient 
##        2        2 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: NORM OF PROJECTED GRADIENT <= PGTOL"
\end{verbatim}

\hypertarget{nonlinear-strictly-inequality-constraints}{%
\subsubsection{非线性严格不等式约束}\label{nonlinear-strictly-inequality-constraints}}

第一个例子，目标函数是非线性的，约束条件也是非线性的，非线性不等式约束不包含等号。

\begin{equation*}
\begin{array}{l}
  \min_x \quad (x_1 + 3x_2 + x_3)^2 + 4(x_1 - x_2)^2 \\
    s.t.\left\{ 
    \begin{array}{l}
     x_1 + x_2 + x_3 = 1 \\
     6 x_2 + 4 x_3 - x_1^3 > 3 \\
     x_1, x_2, x_3 > 0
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \DecValTok{4} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{+} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]), }\CommentTok{\# 对 x[1] 求偏导}
    \DecValTok{6} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{{-}} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]), }\CommentTok{\# 对 x[2] 求偏导}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\CommentTok{\# 对 x[3] 求偏导}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 等式约束}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{1} 
\NormalTok{\}}
\CommentTok{\# 等式约束的雅可比矩阵}
\CommentTok{\# 这里只有一个等式约束，所以雅可比矩阵行数为 1}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ncol =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\CommentTok{\# 不等式约束}
\CommentTok{\# 要求必须是严格不等式，不能带等号，方向是 x \textgreater{} 0 }
\NormalTok{hin }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}\DecValTok{6} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+} \DecValTok{4} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{{-}} \DecValTok{3}\NormalTok{, x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{], x[}\DecValTok{3}\NormalTok{])}
\NormalTok{\}}
\CommentTok{\# 不等式约束的雅可比矩阵}
\CommentTok{\# 其实是有 4 个不等式约束，3 个目标变量约束，雅可比矩阵行数是 4}
\NormalTok{hin.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \SpecialCharTok{{-}}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{4}\NormalTok{,}
    \DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{,}
    \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{,}
    \DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}
\NormalTok{  ), }\AttributeTok{ncol =} \DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

调用 \textbf{alabama} 包的求解器

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\CommentTok{\# 初始值}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\CommentTok{\# 求目标函数的极小值}
\NormalTok{ans }\OtherTok{\textless{}{-}}\NormalTok{ alabama}\SpecialCharTok{::}\FunctionTok{constrOptim.nl}\NormalTok{(}
  \AttributeTok{par =}\NormalTok{ p0,}
  \CommentTok{\# 目标函数}
  \AttributeTok{fn =}\NormalTok{ fn,}
  \AttributeTok{gr =}\NormalTok{ gr,}
  \CommentTok{\# 等式约束}
  \AttributeTok{heq =}\NormalTok{ heq,}
  \AttributeTok{heq.jac =}\NormalTok{ heq.jac,}
  \CommentTok{\# 不等式约束}
  \AttributeTok{hin =}\NormalTok{ hin,}
  \AttributeTok{hin.jac =}\NormalTok{ hin.jac,}
  \CommentTok{\# 不显示迭代过程}
  \AttributeTok{control.outer =} \FunctionTok{list}\NormalTok{(}\AttributeTok{trace =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{)}
\NormalTok{ans}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] 7.390292e-04 4.497160e-12 9.992610e-01
## 
## $value
## [1] 1.000002
## 
## $counts
## function gradient 
##     1230      163 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
## 
## $hessian
##           [,1]      [,2]      [,3]
## [1,] 120517098 120517087 120517091
## [2,] 120517087 120517115 120517095
## [3,] 120517091 120517095 120517091
## 
## $outer.iterations
## [1] 13
## 
## $lambda
## [1] 4.481599
## 
## $sigma
## [1] 120517089
## 
## $barrier.value
## [1] 0.003472071
## 
## $K
## [1] 4.269112e-08
\end{verbatim}

ans 是 \texttt{constrOptim.nl()} 返回的一个 list， convergence = 0 表示迭代成功收敛，value 表示目标函数在迭代终止时的取直，par 表示满足约束条件，成功收敛的情况下，目标函数的参数值，counts 表示迭代过程中目标函数及其梯度计算的次数。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 不提供梯度函数，照样可以求解}
\NormalTok{ans }\OtherTok{\textless{}{-}}\NormalTok{ alabama}\SpecialCharTok{::}\FunctionTok{constrOptim.nl}\NormalTok{(}\AttributeTok{par =}\NormalTok{ p0, }\AttributeTok{fn =}\NormalTok{ fn, }\AttributeTok{heq =}\NormalTok{ heq, }\AttributeTok{hin =}\NormalTok{ hin)}
\end{Highlighting}
\end{Shaded}

\begin{rmdtip}{注意}
等式和不等式约束的雅可比矩阵必须以 matrix 数据类型存储，而不能以 vector 类型存储。要注意和后面 ROI 包的调用形式区别。

\end{rmdtip}

实际上，可以用 ROI 调用 alabama 求解器的方式，这种方式可以简化目标函数梯度和约束条件的表示

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \DecValTok{4} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])}\SpecialCharTok{\^{}}\DecValTok{2}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{+} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]),}
    \DecValTok{6} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{{-}} \DecValTok{8} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]),}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{])}
\NormalTok{  )}
\NormalTok{\}}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}
\NormalTok{\}}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{\}}
\NormalTok{hin }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \DecValTok{6} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+} \DecValTok{4} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3}
\NormalTok{\}}
\NormalTok{hin.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
   \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

通过 ROI 调用 alabama 求解器

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\CommentTok{\# 初始值}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 3L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 4 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq =}\NormalTok{ heq, }\AttributeTok{hin =}\NormalTok{ hin),}
    \AttributeTok{dir =} \FunctionTok{c}\NormalTok{(}\StringTok{"=="}\NormalTok{, }\StringTok{"\textgreater{}"}\NormalTok{),}
    \AttributeTok{rhs =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{),}
    \CommentTok{\# 等式和不等式约束的雅可比}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq.jac =}\NormalTok{ heq.jac, }\AttributeTok{hin.jac =}\NormalTok{ hin.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \DecValTok{0}\NormalTok{, }\AttributeTok{ud =} \SpecialCharTok{+}\ConstantTok{Inf}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 3L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"alabama"}\NormalTok{, }\AttributeTok{start =}\NormalTok{ p0)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.674812e-06 9.994336e-08 9.999982e-01
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

\hypertarget{nonlinear-and-box-constrained}{%
\subsubsection{非线性和箱式约束}\label{nonlinear-and-box-constrained}}

与上面的例子不同，下面这个例子的不等式约束包含等号，还有箱式约束，优化问题来源于\href{https://coin-or.github.io/Ipopt/INTERFACES.html}{Ipopt 官网}，提供的初始值为 \(x_0 = (1,5,5,1)\)，最优解为 \(x_{\star} = (1.00000000,4.74299963,3.82114998,1.37940829)\)。优化问题的具体内容如下：

\begin{equation*}
\begin{array}{l}
  \min_x \quad x_1 x_4 (x_1 + x_2 + x_3) + x_3 \\
    s.t.\left\{ 
    \begin{array}{l}
     x_1^2 + x_2^2 + x_3^2 + x_4^2 = 40 \\
     x_1 x_2 x_3 x_4 \geq 25 \\
     1 \leq x_1, x_2, x_3, x_4 \leq 5
    \end{array} \right.
\end{array}
\end{equation*}

考虑用 ROI 调 nloptr 实现，看结果是否和例子一致，nloptr 支持不等式约束包含等号，支持箱式约束。

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 一个 4 维的目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}
\NormalTok{\}}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
\NormalTok{    x[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]), x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{],}
\NormalTok{    x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{])}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 等式约束}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\CommentTok{\# 等式约束的雅可比}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \DecValTok{2} \SpecialCharTok{*} \FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{], x[}\DecValTok{3}\NormalTok{], x[}\DecValTok{4}\NormalTok{])}
\NormalTok{\}}
\CommentTok{\# 不等式约束}
\NormalTok{hin }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{prod}\NormalTok{(x)}
\NormalTok{\}}
\CommentTok{\# 不等式约束的雅可比}
\NormalTok{hin.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]), }\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{]), }\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{]), }\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{]))}
\NormalTok{\}}
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 4L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 4 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq =}\NormalTok{ heq, }\AttributeTok{hin =}\NormalTok{ hin),}
    \AttributeTok{dir =} \FunctionTok{c}\NormalTok{(}\StringTok{"=="}\NormalTok{, }\StringTok{"\textgreater{}="}\NormalTok{),}
    \AttributeTok{rhs =} \FunctionTok{c}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{25}\NormalTok{),}
    \CommentTok{\# 等式和不等式约束的雅可比}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq.jac =}\NormalTok{ heq.jac, }\AttributeTok{hin.jac =}\NormalTok{ hin.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \DecValTok{1}\NormalTok{, }\AttributeTok{ud =} \DecValTok{5}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 4L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数初始值}
\FunctionTok{fn}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数最优值}
\FunctionTok{fn}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{1.00000000}\NormalTok{, }\FloatTok{4.74299963}\NormalTok{, }\FloatTok{3.82114998}\NormalTok{, }\FloatTok{1.37940829}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 17.01402
\end{verbatim}

求解一般的非线性约束问题，求解器 nloptr.mma / nloptr.cobyla 仅支持非线性不等式约束，不支持等式约束，而 nlminb 只支持等式约束，因此，下面分别调用 nloptr.auglag、nloptr.slsqp 和 nloptr.isres 来求解上述优化问题。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.auglag"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.000000 4.743174 3.820922 1.379440
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 17.01402
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.slsqp"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.000000 4.742996 3.821155 1.379408
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 17.01402
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.isres"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.089078 4.536010 4.092079 1.238457
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 17.19836
\end{verbatim}

可以看出，nloptr 提供的优化能力可以覆盖\href{https://github.com/coin-or/Ipopt}{Ipopt 求解器}，推荐使用 nloptr.slsqp 求解器。

\hypertarget{nonlinear-mixed-integer-constrained}{%
\subsubsection{非线性混合整数约束}\label{nonlinear-mixed-integer-constrained}}

\begin{equation*}
\begin{array}{l}
  \max_x \quad 1.5(x_1 - \sin(x_1 - x_2))^2 + 0.5x_2^2 + x_3^2 - x_1 x_2 - 2x_1 + x_2 x_3 \\
    s.t.\left\{ 
    \begin{array}{l}
     -20 < x_1 < 20 \\
     -20 < x_2 < 20 \\
     -10 < x_3 < 10 \\
     x_1, x_2 \in \mathbb{R}, \quad x_3 \in \mathbb{Z}
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FloatTok{1.5} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]))}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \FloatTok{0.5} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}
  \SpecialCharTok{{-}}\NormalTok{x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{]}
\NormalTok{\}}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \DecValTok{3} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{cos}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{,}
    \DecValTok{3} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{3}\NormalTok{],}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}
\NormalTok{  )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

目前 ROI 还解不了

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 初始值}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{2.1}\NormalTok{, }\FloatTok{5.1}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 3L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 3 个目标变量}
  \AttributeTok{types =} \FunctionTok{c}\NormalTok{(}\StringTok{"C"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"I"}\NormalTok{), }\CommentTok{\# 目标变量的类型}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{lb =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{20}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{20}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{), }\AttributeTok{ub =} \FunctionTok{c}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{nobj =}\NormalTok{ 3L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"auto"}\NormalTok{, }\AttributeTok{start =}\NormalTok{ p0)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

目标函数在 \((4.49712, 9.147501, -4)\) 取得最小值 -86.72165

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{4.49712}\NormalTok{, }\FloatTok{9.147501}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -86.72165
\end{verbatim}

\hypertarget{complex-object-function}{%
\subsubsection{含复杂目标函数}\label{complex-object-function}}

下面这个目标函数比较复杂，约束条件也是非线性的

\begin{equation*}
\begin{array}{l}
  \max_x \quad \frac{(\sin(2\pi x_1))^3 \sin(2\pi x_2)}{x_1^3 (x_1 + x_2)} \\
    s.t.\left\{ 
    \begin{array}{l}
     x_1^2 - x_2 + 1 \leq 0 \\
     1 - x_1 + (x_2 - 4)^2 \geq 0 \\
     0 \leq x_1, x_2 \leq 10
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) (}\FunctionTok{sin}\NormalTok{(}\DecValTok{2}\SpecialCharTok{*}\NormalTok{pi}\SpecialCharTok{*}\NormalTok{x[}\DecValTok{1}\NormalTok{]))}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(}\DecValTok{2}\SpecialCharTok{*}\NormalTok{pi}\SpecialCharTok{*}\NormalTok{x[}\DecValTok{2}\NormalTok{])}\SpecialCharTok{/}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3}\SpecialCharTok{*}\NormalTok{(x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]))}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]))}
\NormalTok{\}}

\NormalTok{hin }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
\NormalTok{    x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+} \DecValTok{1}\NormalTok{,}
    \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ (x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{4}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{hin.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{], }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
    \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}
\NormalTok{  ),}
  \AttributeTok{ncol =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{  )}
\NormalTok{\}}

\CommentTok{\# 初始值}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 2L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 2 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{hin =}\NormalTok{ hin),}
    \AttributeTok{dir =} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}="}\NormalTok{, }\StringTok{"\textless{}="}\NormalTok{),}
    \AttributeTok{rhs =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \CommentTok{\# 不等式约束的雅可比}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{hin.jac =}\NormalTok{ hin.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \DecValTok{0}\NormalTok{, }\AttributeTok{ud =} \DecValTok{10}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 2L),}
  \AttributeTok{maximum =} \ConstantTok{TRUE} \CommentTok{\# 求最大}
\NormalTok{)}
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.isres"}\NormalTok{, }\AttributeTok{start =}\NormalTok{ p0)}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.227978 4.245365
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.09582504
\end{verbatim}

下面再给一个来自 \href{https://octave.org/doc/v6.2.0/Nonlinear-Programming.html}{Octave 优化文档} 的示例，该优化问题包含多个非线性的等式约束。

\begin{equation*}
\begin{array}{l}
  \min_x \quad \mathrm{e}^{\prod_{i=1}^{5} x_i} - \frac{1}{2}(x_1^3 + x_2^3 + 1)^2 \\
    s.t.\left\{ 
    \begin{array}{l}
     \sum_{i=1}^{5}x_i^2 - 10 = 0 \\
     x_2 x_3 - 5x_4 x_5 = 0 \\
     x_1^3 + x_2^3 + 1 = 0
    \end{array} \right.
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 一个 5 维的目标函数}
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x)) }\SpecialCharTok{{-}} \FloatTok{0.5} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{\}}
\CommentTok{\# 目标函数的梯度}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{{-}} \DecValTok{3}\SpecialCharTok{*}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{{-}} \DecValTok{3}\SpecialCharTok{*}\NormalTok{(x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{]), }
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{]),}
    \FunctionTok{exp}\NormalTok{(}\FunctionTok{prod}\NormalTok{(x))}\SpecialCharTok{*}\FunctionTok{prod}\NormalTok{(x[}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{])}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 等式约束}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{c}\NormalTok{(}
    \FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{10}\NormalTok{,}
\NormalTok{    x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{5} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ x[}\DecValTok{5}\NormalTok{],}
\NormalTok{    x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{3} \SpecialCharTok{+} \DecValTok{1}
\NormalTok{  )}
\NormalTok{\}}
\CommentTok{\# 等式约束的雅可比}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{], }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{], }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{3}\NormalTok{], }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{], }\DecValTok{2} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{5}\NormalTok{],}
    \DecValTok{0}\NormalTok{, x[}\DecValTok{3}\NormalTok{], x[}\DecValTok{2}\NormalTok{], }\SpecialCharTok{{-}}\DecValTok{5} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{5}\NormalTok{], }\SpecialCharTok{{-}}\DecValTok{5} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{4}\NormalTok{],}
    \DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{3} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{ncol =} \DecValTok{5}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{  )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 5L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 5 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq =}\NormalTok{ heq),}
    \AttributeTok{dir =} \StringTok{"=="}\NormalTok{,}
    \AttributeTok{rhs =} \DecValTok{0}\NormalTok{,}
    \CommentTok{\# 等式的雅可比}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq.jac =}\NormalTok{ heq.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\ConstantTok{Inf}\NormalTok{, }\AttributeTok{ud =} \ConstantTok{Inf}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 5L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调用 SQP（序列二次规划） 求解器

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.slsqp"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.8}\NormalTok{, }\FloatTok{1.7}\NormalTok{, }\FloatTok{1.9}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.8}\NormalTok{,}\SpecialCharTok{{-}}\FloatTok{0.8}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1.7171435  1.5957096  1.8272458 -0.7636431 -0.7636431
\end{verbatim}

计算结果和 Octave 的示例一致。

\hypertarget{complex-constrained-function}{%
\subsubsection{含复杂约束条件}\label{complex-constrained-function}}

\begin{equation*}
\begin{array}{l}
  \min_x \quad \exp(\sin(50\cdot x)) + \sin(60\cdot \exp(y)) + \sin(70\cdot\sin(x)) \\
         \qquad + \sin(\sin(80\cdot y)) - \sin(10\cdot (x +y)) + \frac{(x^2 + y^2)^{\sin(y)}}{4} \\
    s.t. \quad \left\{ 
    \begin{array}{l}
     x - \big((\cos(y))^x - x\big)^y = 0 \\
    -50 \leq x_1,x_2 \leq 50
    \end{array} \right.
\end{array}
\end{equation*}

Lingo 代码如下：

\begin{verbatim}
Min = @exp(@sin(50 * x)) + @sin(60 * @exp(y)) + @sin(70 * @sin(x)) 
      + @sin(@sin(80 * y)) - @sin(10 * (x + y)) + (x^2 + y^2)^@sin(y) / 4;

x - (( @cos(y) )^x - x)^y = 0;

@bnd(-50, x, 50);
@bnd(-50, y, 50);
\end{verbatim}

启用全局优化求解器，求解 14 分钟，在 \((0.08256372, 24.56510)\) 取得极小值 -2.863497。不启用全局优化器就没法解，Lingo 会报错，找不到最优解，勉强找到一个可行解 \((0.06082750, 44.12793)\)，目标值为 -1.29816。

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{exp}\NormalTok{(}\FunctionTok{sin}\NormalTok{(}\DecValTok{50} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{1}\NormalTok{])) }\SpecialCharTok{+} \FunctionTok{sin}\NormalTok{(}\DecValTok{60} \SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{+}
    \FunctionTok{sin}\NormalTok{(}\DecValTok{70} \SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(x[}\DecValTok{1}\NormalTok{])) }\SpecialCharTok{+} \FunctionTok{sin}\NormalTok{(}\FunctionTok{sin}\NormalTok{(}\DecValTok{80} \SpecialCharTok{*}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{{-}}
    \FunctionTok{sin}\NormalTok{(}\DecValTok{10} \SpecialCharTok{*}\NormalTok{ (x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{+}\NormalTok{ (x[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ x[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{(}\FunctionTok{sin}\NormalTok{(x[}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{/} \DecValTok{4}
\NormalTok{\}}
\NormalTok{gr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(fn, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]))}
\NormalTok{\}}
\NormalTok{heq }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ ( (}\FunctionTok{cos}\NormalTok{(x[}\DecValTok{2}\NormalTok{]))}\SpecialCharTok{\^{}}\NormalTok{x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{] )}\SpecialCharTok{\^{}}\NormalTok{x[}\DecValTok{2}\NormalTok{]}
\NormalTok{\}}
\NormalTok{heq.jac }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  numDeriv}\SpecialCharTok{::}\FunctionTok{grad}\NormalTok{(heq, }\FunctionTok{c}\NormalTok{(x[}\DecValTok{1}\NormalTok{], x[}\DecValTok{2}\NormalTok{]))}
\NormalTok{\}}

\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.06082750}\NormalTok{, }\FloatTok{44.12793}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1.29816
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.966877
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.06082750}\NormalTok{, }\FloatTok{44.12793}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.923673e-08
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 定义目标规划}
\NormalTok{op }\OtherTok{\textless{}{-}} \FunctionTok{OP}\NormalTok{(}
  \AttributeTok{objective =} \FunctionTok{F\_objective}\NormalTok{(}\AttributeTok{F =}\NormalTok{ fn, }\AttributeTok{n =}\NormalTok{ 2L, }\AttributeTok{G =}\NormalTok{ gr), }\CommentTok{\# 2 个目标变量}
  \AttributeTok{constraints =} \FunctionTok{F\_constraint}\NormalTok{(}
    \AttributeTok{F =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq =}\NormalTok{ heq),}
    \AttributeTok{dir =} \StringTok{"=="}\NormalTok{,}
    \AttributeTok{rhs =} \DecValTok{0}\NormalTok{,}
    \AttributeTok{J =} \FunctionTok{list}\NormalTok{(}\AttributeTok{heq.jac =}\NormalTok{ heq.jac)}
\NormalTok{  ),}
  \AttributeTok{bounds =} \FunctionTok{V\_bound}\NormalTok{(}\AttributeTok{ld =} \SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\AttributeTok{ud =} \DecValTok{50}\NormalTok{, }\AttributeTok{nobj =}\NormalTok{ 2L),}
  \AttributeTok{maximum =} \ConstantTok{FALSE} \CommentTok{\# 求最小}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

nloptr.auglag 无法求解此优化问题

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.auglag"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

调 nloptr.isres 求解器，每次执行都会得到不同的局部最优解

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp }\OtherTok{\textless{}{-}} \FunctionTok{ROI\_solve}\NormalTok{(op, }\AttributeTok{solver =} \StringTok{"nloptr.isres"}\NormalTok{, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{solution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 11.407437  5.719306
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nlp}\SpecialCharTok{$}\NormalTok{objval}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -2.98445
\end{verbatim}

比如下面三组

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{40.95941}\NormalTok{, }\FloatTok{41.52914}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1.025926
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{40.95941}\NormalTok{, }\FloatTok{41.52914}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NaN
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{21.88091}\NormalTok{, }\FloatTok{28.96994}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -1.467513
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{21.88091}\NormalTok{, }\FloatTok{28.96994}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NaN
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fn}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{49.921967437}\NormalTok{, }\FloatTok{4.8499336803}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -3.466596
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{heq}\NormalTok{(}\AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{49.921967437}\NormalTok{, }\FloatTok{4.8499336803}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -8.515447e+208
\end{verbatim}

\hypertarget{sec-nonlinear-equations}{%
\section{非线性方程}\label{sec-nonlinear-equations}}

\hypertarget{subsec-equation}{%
\subsection{一元非线性方程}\label{subsec-equation}}

\href{https://blog.hamaluik.ca/posts/solving-equations-using-the-newton-raphson-method/}{牛顿-拉弗森方法}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rootSolve)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-equations}{%
\subsection{非线性方程组}\label{subsec-equations}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(BB)}
\end{Highlighting}
\end{Shaded}

二项混合泊松分布的参数最大似然估计

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poissmix.loglik }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p, y) \{}
  \CommentTok{\# Log{-}likelihood for a binary Poisson mixture distribution}
\NormalTok{  i }\OtherTok{\textless{}{-}} \DecValTok{0}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(y) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
  
\NormalTok{  loglik }\OtherTok{\textless{}{-}}\NormalTok{ y }\SpecialCharTok{*} \FunctionTok{log}\NormalTok{(p[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{p[}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{*}\NormalTok{ p[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\^{}}\NormalTok{i }\SpecialCharTok{/} \FunctionTok{exp}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
\NormalTok{    (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ p[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{p[}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{*}\NormalTok{ p[}\DecValTok{3}\NormalTok{]}\SpecialCharTok{\^{}}\NormalTok{i }\SpecialCharTok{/} \FunctionTok{exp}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)))}

  \FunctionTok{sum}\NormalTok{(loglik)}
\NormalTok{\}}
\CommentTok{\# Data from Hasselblad (JASA 1969)}
\CommentTok{\# 介绍实际应用场景}
\NormalTok{poissmix.dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{death =} \DecValTok{0}\SpecialCharTok{:}\DecValTok{9}\NormalTok{, }
                           \AttributeTok{freq =} \FunctionTok{c}\NormalTok{(}\DecValTok{162}\NormalTok{, }\DecValTok{267}\NormalTok{, }\DecValTok{271}\NormalTok{, }\DecValTok{185}\NormalTok{, }\DecValTok{111}\NormalTok{, }\DecValTok{61}\NormalTok{, }\DecValTok{27}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{lo }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{) }\CommentTok{\# lower limits for parameters}
\NormalTok{hi }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\ConstantTok{Inf}\NormalTok{, }\ConstantTok{Inf}\NormalTok{) }\CommentTok{\# upper limits for parameters}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{runif}\NormalTok{(}\DecValTok{3}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{)) }
\CommentTok{\# a randomly generated vector of length 3}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{162}\NormalTok{, }\DecValTok{267}\NormalTok{, }\DecValTok{271}\NormalTok{, }\DecValTok{185}\NormalTok{, }\DecValTok{111}\NormalTok{, }\DecValTok{61}\NormalTok{, }\DecValTok{27}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{)}

\NormalTok{ans1 }\OtherTok{\textless{}{-}} \FunctionTok{spg}\NormalTok{(}
  \AttributeTok{par =}\NormalTok{ p0, }\AttributeTok{fn =}\NormalTok{ poissmix.loglik, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{lower =}\NormalTok{ lo, }\AttributeTok{upper =}\NormalTok{ hi,}
  \AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maximize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{trace =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{)}
\NormalTok{ans2 }\OtherTok{\textless{}{-}} \FunctionTok{BBoptim}\NormalTok{(}
  \AttributeTok{par =}\NormalTok{ p0, }\AttributeTok{fn =}\NormalTok{ poissmix.loglik, }\AttributeTok{y =}\NormalTok{ y,}
  \AttributeTok{lower =}\NormalTok{ lo, }\AttributeTok{upper =}\NormalTok{ hi, }\AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maximize =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## iter:  0  f-value:  -2136.431  pgrad:  236.9752 
## iter:  10  f-value:  -1995.89  pgrad:  2.961353 
## iter:  20  f-value:  -2041.139  pgrad:  2.57697 
## iter:  30  f-value:  -1989.974  pgrad:  0.4742151 
## iter:  40  f-value:  -1989.949  pgrad:  0.2614752 
## iter:  50  f-value:  -1989.946  pgrad:  0.01959506 
## iter:  60  f-value:  -1989.946  pgrad:  0.002494289 
##   Successful convergence.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ans2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $par
## [1] 0.3598829 1.2560906 2.6634011
## 
## $value
## [1] -1989.946
## 
## $gradient
## [1] 0.0001000444
## 
## $fn.reduction
## [1] -146.4848
## 
## $iter
## [1] 68
## 
## $feval
## [1] 170
## 
## $convergence
## [1] 0
## 
## $message
## [1] "Successful convergence"
## 
## $cpar
## method      M 
##      2     50
\end{verbatim}

计算最大似然处的黑塞矩阵以及参数的标准差

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hess }\OtherTok{\textless{}{-}}\NormalTok{ numDeriv}\SpecialCharTok{::}\FunctionTok{hessian}\NormalTok{(}\AttributeTok{x =}\NormalTok{ ans2}\SpecialCharTok{$}\NormalTok{par, }\AttributeTok{func =}\NormalTok{ poissmix.loglik, }\AttributeTok{y =}\NormalTok{ y)}
\CommentTok{\# Note that we have to supplied data vector \textquotesingle{}y\textquotesingle{}}
\NormalTok{hess}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           [,1]      [,2]      [,3]
## [1,] -907.1105  270.2287  341.2543
## [2,]  270.2287 -113.4794  -61.6819
## [3,]  341.2543  -61.6819 -192.7822
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{se }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{solve}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{hess)))}
\NormalTok{se}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.1946836 0.3500308 0.2504769
\end{verbatim}

从不同初始值出发尝试寻找全局最大值，实际找的是一系列局部最大值

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 3 randomly generated starting values}
\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\DecValTok{30}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{8}\NormalTok{)), }\DecValTok{10}\NormalTok{, }\DecValTok{3}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{ans }\OtherTok{\textless{}{-}} \FunctionTok{multiStart}\NormalTok{(}
  \AttributeTok{par =}\NormalTok{ p0, }\AttributeTok{fn =}\NormalTok{ poissmix.loglik, }\AttributeTok{action =} \StringTok{"optimize"}\NormalTok{,}
  \AttributeTok{y =}\NormalTok{ y, }\AttributeTok{lower =}\NormalTok{ lo, }\AttributeTok{upper =}\NormalTok{ hi, }\AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{maximize =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Parameter set :  1 ... 
## iter:  0  f-value:  -2076.377  pgrad:  266.5811 
## iter:  10  f-value:  -1991.788  pgrad:  3.394882 
## iter:  20  f-value:  -1990.932  pgrad:  8.266675 
## iter:  30  f-value:  -1989.958  pgrad:  0.2441652 
## iter:  40  f-value:  -1989.946  pgrad:  0.001411991 
##   Successful convergence.
## Parameter set :  2 ... 
## iter:  0  f-value:  -3999.343  pgrad:  6.350898 
## iter:  10  f-value:  -2015.457  pgrad:  2.400803 
##   Successful convergence.
## Parameter set :  3 ... 
## iter:  0  f-value:  -2526.385  pgrad:  3.959104 
## iter:  10  f-value:  -1997.785  pgrad:  4.651176 
## iter:  20  f-value:  -2041.124  pgrad:  130.6335 
## iter:  30  f-value:  -1989.979  pgrad:  0.4133676 
## iter:  40  f-value:  -1989.953  pgrad:  0.2001525 
## iter:  50  f-value:  -1989.946  pgrad:  0.02953584 
##   Successful convergence.
## Parameter set :  4 ... 
## iter:  0  f-value:  -4036.966  pgrad:  7.725057 
## iter:  10  f-value:  -1993.146  pgrad:  3.356279 
## iter:  20  f-value:  -1992.445  pgrad:  3.162911 
## iter:  30  f-value:  -1999.964  pgrad:  3.124857 
## iter:  40  f-value:  -1990.201  pgrad:  0.9762675 
## iter:  50  f-value:  -1989.962  pgrad:  0.3950169 
## iter:  60  f-value:  -1989.946  pgrad:  0.0507498 
## iter:  70  f-value:  -1989.946  pgrad:  0.0001978151 
##   Successful convergence.
## Parameter set :  5 ... 
## iter:  0  f-value:  -2048.809  pgrad:  2.862445 
## iter:  10  f-value:  -1992.344  pgrad:  2.68979 
## iter:  20  f-value:  -1990.604  pgrad:  7.2791 
## iter:  30  f-value:  -1989.978  pgrad:  0.3772993 
## iter:  40  f-value:  -1989.946  pgrad:  0.004172307 
## iter:  50  f-value:  -1989.946  pgrad:  0.004260983 
##   Successful convergence.
## Parameter set :  6 ... 
## iter:  0  f-value:  -4777.283  pgrad:  7.596832 
## iter:  10  f-value:  -1991.838  pgrad:  11.02078 
## iter:  20  f-value:  -1990.272  pgrad:  0.5307333 
## iter:  30  f-value:  -1989.963  pgrad:  2.230793 
## iter:  40  f-value:  -1989.946  pgrad:  0.008421921 
## iter:  50  f-value:  -1989.946  pgrad:  0.0001841727 
##   Successful convergence.
## Parameter set :  7 ... 
## iter:  0  f-value:  -2019.928  pgrad:  3.485709 
## iter:  10  f-value:  -1990.626  pgrad:  1.833378 
## iter:  20  f-value:  -1989.999  pgrad:  1.098717 
## iter:  30  f-value:  -1989.947  pgrad:  0.3092782 
## iter:  40  f-value:  -1989.946  pgrad:  0.007039489 
##   Successful convergence.
## Parameter set :  8 ... 
## iter:  0  f-value:  -2764.625  pgrad:  4.891128 
## iter:  10  f-value:  -2001.398  pgrad:  2.273737e-06 
##   Successful convergence.
## Parameter set :  9 ... 
## iter:  0  f-value:  -2167.165  pgrad:  195.5499 
## iter:  10  f-value:  -2001.54  pgrad:  2.194864 
## iter:  20  f-value:  -2000.825  pgrad:  0.6559458 
## iter:  30  f-value:  -1992.777  pgrad:  7.064828 
## iter:  40  f-value:  -1991.747  pgrad:  3.357115 
## iter:  50  f-value:  -1989.983  pgrad:  2.772795 
## iter:  60  f-value:  -1989.946  pgrad:  0.03392643 
## iter:  70  f-value:  -1989.946  pgrad:  0.0003728928 
##   Successful convergence.
## Parameter set :  10 ... 
## iter:  0  f-value:  -2100.94  pgrad:  317.5313 
## iter:  10  f-value:  -1991.327  pgrad:  2.7843 
## iter:  20  f-value:  -1990.415  pgrad:  1.435174 
## iter:  30  f-value:  -1990.046  pgrad:  3.248585 
## iter:  40  f-value:  -1989.946  pgrad:  0.06813025 
## iter:  50  f-value:  -1989.946  pgrad:  0.001450644 
##   Successful convergence.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# selecting only converged solutions}
\NormalTok{pmat }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(ans}\SpecialCharTok{$}\NormalTok{fvalue[ans}\SpecialCharTok{$}\NormalTok{conv], ans}\SpecialCharTok{$}\NormalTok{par[ans}\SpecialCharTok{$}\NormalTok{conv, ]), }\DecValTok{4}\NormalTok{)}
\FunctionTok{dimnames}\NormalTok{(pmat) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\ConstantTok{NULL}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"fvalue"}\NormalTok{, }\StringTok{"parameter 1"}\NormalTok{, }\StringTok{"parameter 2"}\NormalTok{, }\StringTok{"parameter 3"}\NormalTok{))}
\NormalTok{pmat[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(pmat), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         fvalue parameter 1 parameter 2 parameter 3
## [1,] -1989.946      0.6401      2.6634      1.2561
## [2,] -1997.263      0.4922      2.4559      1.8567
## [3,] -1989.946      0.3599      1.2561      2.6634
## [4,] -2000.039      0.7931      2.0681      2.4778
## [5,] -1989.946      0.3599      1.2560      2.6634
\end{verbatim}

用一个具体的参数估计问题，求极大似然点，混合正态分布 隐函数方程组 求解非线性方程组 \citep{BB2019}

\hypertarget{sec-multi-objective-optimization}{%
\section{多目标规划}\label{sec-multi-objective-optimization}}

多目标规划的基本想法是将多目标问题转化为单目标问题，常见方法有理想点法、线性加权法、非劣解集法、极大极小法。理想点法是先在给定约束条件下分别求解单个目标的最优值，构造新的单目标函数。线性加权法是给每个目标函数赋予权重系数，各个权重系数之和等于1。非劣解集法是先求解其中一个单目标函数的最优值，然后将其设为等式约束，将其最优值从最小值开始递增，然后求解另一个目标函数的最小值。极大极小法是采用标准的简面体爬山法和通用全局优化法求解多目标优化问题。

R 环境中，\href{https://github.com/mbinois/GPareto}{GPareto} 主要用来求解多目标规划问题。\href{https://bookdown.org/gerhard_krennrich/doe_and_optimization/}{试验设计和过程优化与R语言} 的 \href{https://bookdown.org/gerhard_krennrich/doe_and_optimization/optimization.html\#constrained-optimization}{约束优化} 章节，\href{https://www.stat.umn.edu/geyer/3701/notes/optimize.html}{优化和解方程}。另外，《Search Methodologies: Introductory Tutorials in Optimization and Decision Support Techniques》\citep{Deb2005} 多目标优化方法

\begin{equation*}
\begin{array}{l}
  \min_x \left\{
      \begin{array}{l}  
        f_1(x) = 0.5x_1 + 0.6x_2 + 0.7 \exp(\frac{x_1 + x_3}{10}) \\
        f_2(x) = (x_1 - 2x_2)^2 + (2x_2 - 3x_3)^2 + (5x_3 -x_1)^2
      \end{array} \right. \\
    s.t. \quad x_1 \in [10, 80], x_2 \in [20, 90], x_3 \in [15, 100]
\end{array}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(DiceKriging)}
\FunctionTok{library}\NormalTok{(emoa)}
\FunctionTok{library}\NormalTok{(GPareto)}
\FunctionTok{library}\NormalTok{(DiceDesign)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Ternary)}
\FunctionTok{TernaryPlot}\NormalTok{(}
  \AttributeTok{atip =} \StringTok{"Top"}\NormalTok{, }\AttributeTok{btip =} \StringTok{"Bottom"}\NormalTok{, }\AttributeTok{ctip =} \StringTok{"Right"}\NormalTok{, }
  \AttributeTok{axis.col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{col =} \FunctionTok{rgb}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.8}\NormalTok{)}
\NormalTok{)}
\FunctionTok{HorizontalGrid}\NormalTok{(}\AttributeTok{grid.lines =} \DecValTok{2}\NormalTok{, }\AttributeTok{grid.col =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{grid.lty =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-classic-optimization}{%
\section{经典优化问题}\label{sec-classic-optimization}}

旅行商问题、背包问题、指派问题、选址问题、网络流量问题

规划快递员送餐的路线：从快递员出发地到各个取餐地，再到顾客家里，如何规划路线使得每个顾客下单到拿到餐的时间间隔小于 50 分钟，完成送餐，快递员的总时间最少？

\hypertarget{sec-regression-optimization}{%
\section{回归与优化}\label{sec-regression-optimization}}

简单线性回归

\href{https://cran.r-project.org/package=nlsr}{nlsr}

是否能给大家提供一些思路？

Lasso \citep{lasso1996}

Least Angle Regression \citep{lar2004}

为了解决Lasso的有偏估计问题，自适应 Lasso、松弛 Lasso SCAD (Smoothly Clipped Absolute Deviation)\citep{scad2008} MCP (Minimax Concave Penalty)\citep{mcp2010}

由于缺少高效的求解算法，Lasso 在高维小样本特征选择研究中没有广泛流行，最小角回归(Least Angle Regression, LAR)算法 \citep{lar2004} 的出现有力促进了Lasso在高维小样本数据中的应用

\href{https://github.com/ryantibs/best-subset/}{bestsubset} 最优子集回归

经典的普通最小二乘、广义最小二乘、岭回归、逐步回归、Lasso 回归、最优子集回归都可转化为优化问题，一般形式如下

\[
\underbrace{\hat{\theta}_{\lambda_n}}_{\text{待估参数}} \in \arg \min_{\theta \in \Omega} \left\{ \underbrace{\mathcal{L}(\theta;Z_{1}^{n})}_{\text{损失函数}} + \lambda_n \underbrace{\mathcal{R}(\theta)}_{\text{正则化项}} \right\}.
\]

下面尝试以 nloptr 包的优化器来展示求解过程，并与 Base R、\textbf{glmnet} 和 \textbf{MASS} 实现的回归模型比较。

\[
\arg \min_{\beta,\lambda} ~~ \frac{1}{2} || \mathbf{y} - \mathbf{X} \beta ||_2^2 +  \lambda ||\beta||_1
\] 其中，\(X \in \mathbb{R}^{m\times n}\)， \(y \in \mathbb{R}^m\)，\(\beta \in \mathbb{R}^n\)， \(0 < \lambda \in \mathbb{R}\)

\[y = X\beta + \epsilon\]

\(\hat{\beta} = (X^{\top}X)^{-1}X^{\top}y, \quad \hat{Y} = X(X^{\top}X)^{-1}X^{\top}y\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{200}
\NormalTok{p }\OtherTok{\textless{}{-}} \DecValTok{50}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n }\SpecialCharTok{*}\NormalTok{ p), n)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(n)}
\FunctionTok{lm}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{+} \DecValTok{0}\NormalTok{)}
\CommentTok{\# y 的估计}
\CommentTok{\# 教科书版}
\NormalTok{fit\_base }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  x }\SpecialCharTok{\%*\%} \FunctionTok{solve}\NormalTok{(}\FunctionTok{t}\NormalTok{(x) }\SpecialCharTok{\%*\%}\NormalTok{ x) }\SpecialCharTok{\%*\%} \FunctionTok{t}\NormalTok{(x) }\SpecialCharTok{\%*\%}\NormalTok{ y}
\NormalTok{\}}
\CommentTok{\# 先向量计算，然后矩阵计算}
\NormalTok{fit\_vector }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  x }\SpecialCharTok{\%*\%}\NormalTok{ (}\FunctionTok{solve}\NormalTok{(}\FunctionTok{t}\NormalTok{(x) }\SpecialCharTok{\%*\%}\NormalTok{ x) }\SpecialCharTok{\%*\%}\NormalTok{ (}\FunctionTok{t}\NormalTok{(x) }\SpecialCharTok{\%*\%}\NormalTok{ y))}
\NormalTok{\}}
\CommentTok{\# X\textquotesingle{}X 是对称的，防止求逆}
\NormalTok{fit\_inv }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  x }\SpecialCharTok{\%*\%} \FunctionTok{solve}\NormalTok{(}\FunctionTok{crossprod}\NormalTok{(x), }\FunctionTok{crossprod}\NormalTok{(x, y))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

QR 分解 \(X_{n\times p} = Q_{n\times p} R_{p\times p}\)，\(n > p\)，\(Q^{\top}Q = I\)，\(R\) 是上三角矩阵，\(\hat{Y} = X(X^{\top}X)^{-1}X^{\top}y = QQ^{\top}y\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_qr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  decomp }\OtherTok{\textless{}{-}} \FunctionTok{qr}\NormalTok{(x)}
  \FunctionTok{qr.qy}\NormalTok{(decomp, }\FunctionTok{qr.qty}\NormalTok{(decomp, y))}
\NormalTok{\}}
\FunctionTok{lm.fit}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

若 \(A = X^{\top}X\) 是正定矩阵，则 \(A = LL^{\top}\)，\(L\) 是下三角矩阵

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit\_chol }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, y) \{}
\NormalTok{  decomp }\OtherTok{\textless{}{-}} \FunctionTok{chol}\NormalTok{(}\FunctionTok{crossprod}\NormalTok{(x))}
\NormalTok{  lxy }\OtherTok{\textless{}{-}} \FunctionTok{backsolve}\NormalTok{(decomp, }\FunctionTok{crossprod}\NormalTok{(x, y), }\AttributeTok{transpose =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{backsolve}\NormalTok{(decomp, lxy)}
\NormalTok{  x }\SpecialCharTok{\%*\%}\NormalTok{ b}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Using C/C++}
\FunctionTok{system.time}\NormalTok{(RcppEigen}\SpecialCharTok{::}\FunctionTok{fastLmPure}\NormalTok{(x, y, }\AttributeTok{method =} \DecValTok{1}\NormalTok{)) }\DocumentationTok{\#\# QR}
\FunctionTok{system.time}\NormalTok{(RcppEigen}\SpecialCharTok{::}\FunctionTok{fastLmPure}\NormalTok{(x, y, }\AttributeTok{method =} \DecValTok{2}\NormalTok{)) }\DocumentationTok{\#\# Cholesky}
\FunctionTok{system.time}\NormalTok{(RcppArmadillo}\SpecialCharTok{::}\FunctionTok{fastLmPure}\NormalTok{(x, y, }\AttributeTok{method =} \DecValTok{1}\NormalTok{)) }\DocumentationTok{\#\# QR}
\FunctionTok{system.time}\NormalTok{(RcppArmadillo}\SpecialCharTok{::}\FunctionTok{fastLmPure}\NormalTok{(x, y, }\AttributeTok{method =} \DecValTok{2}\NormalTok{)) }\DocumentationTok{\#\# Cholesky}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-log-likelihood}{%
\section{对数似然}\label{sec-log-likelihood}}

随机变量 X 服从参数为 \(\lambda > 0\) 的指数分布，密度函数 \(p(x)\) 为

\begin{equation*}
\begin{array}{l}
 p(x) = \left\{ 
    \begin{array}{l}
    \lambda\mathrm{e}^{-\lambda x},  x \geq 0\\
    0, \quad x < 0
    \end{array} \right.
\end{array}
\end{equation*}

其中，\(\lambda > 0\)，下面给定一系列模拟样本观察值 \(x_1, x_2, \cdots, x_n\)，估计参数 \(\lambda\)。对数似然函数 \(\ell(\lambda) = \log \prod_{i=1}^{n} f(x_i) = n \log \lambda - \lambda \sum_{i=1}^{n}x_i\)。解此方程即可得到 \(\lambda\) 的极大似然估计 \(\lambda_{mle} = \frac{1}{\bar{X}}\)，极大值 \(\ell(\lambda_{mle}) = - n(1 + \log \bar{X})\)。

根据上述样本，计算样本均值 \((\mu - 1.5*\sigma/\sqrt{n}, \mu + 1.5*\sigma/\sqrt{n})\) 和方差 \((0.8\sigma, 1.5\sigma)\)。 已知正态分布 \(f(x) = \frac{1}{\sqrt{2\pi}\sigma}\mathrm{e}^{- \frac{(x - \mu)^2}{2\sigma^2}}\) 的对数似然形式 \(\ell(\mu,\sigma^2) = \log \prod_{i=1}^{n} f(x_i) = \sum_{i=1}^{n}\log f(x_i)\)。正态分布的密度函数的对数可用 \texttt{dnorm(...,\ log\ =\ TRUE)} 计算。

生成服从指数分布的样本，计算样本的均值和方差，依据均值和方差构造区间，然后将区间网格化，在此网格上绘制正态分布的对数似然函数。绕那么大一个圈子，其实就是绘制正态分布的对数似然函数。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2021}\NormalTok{)}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{20} \CommentTok{\# 随机数的个数}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rexp}\NormalTok{(n, }\AttributeTok{rate =} \DecValTok{5}\NormalTok{) }\CommentTok{\# 服从指数分布的随机数}
\NormalTok{m }\OtherTok{\textless{}{-}} \DecValTok{40} \CommentTok{\# 网格数}

\NormalTok{mu }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}
  \FunctionTok{mean}\NormalTok{(x) }\SpecialCharTok{{-}} \FloatTok{1.5} \SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(x) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n),}
  \FunctionTok{mean}\NormalTok{(x) }\SpecialCharTok{+} \FloatTok{1.5} \SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(x) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n),}
  \AttributeTok{length.out =}\NormalTok{ m}
\NormalTok{)}
\NormalTok{sigma }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.8} \SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(x), }\FloatTok{1.5} \SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(x), }\AttributeTok{length.out =}\NormalTok{ m)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mu, }\AttributeTok{y =}\NormalTok{ sigma)}
\CommentTok{\# 正态分布的对数似然}
\NormalTok{loglik }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(b, x0) }\SpecialCharTok{{-}}\FunctionTok{sum}\NormalTok{(}\FunctionTok{dnorm}\NormalTok{(x0, b[}\DecValTok{1}\NormalTok{], b[}\DecValTok{2}\NormalTok{], }\AttributeTok{log =} \ConstantTok{TRUE}\NormalTok{))}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{fnxy }\OtherTok{=} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, loglik, }\AttributeTok{x0 =}\NormalTok{ x)}

\FunctionTok{wireframe}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ df, fnxy }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x }\SpecialCharTok{*}\NormalTok{ y,}
  \AttributeTok{shade =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{drape =} \ConstantTok{FALSE}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(mu), }
  \AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(sigma), }
  \AttributeTok{zlab =} \FunctionTok{list}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{loglik}\NormalTok{(mu, sigma)), }\AttributeTok{rot =} \DecValTok{90}\NormalTok{),}
  \AttributeTok{scales =} \FunctionTok{list}\NormalTok{(}\AttributeTok{arrows =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
  \AttributeTok{par.settings =} \FunctionTok{list}\NormalTok{(}\AttributeTok{axis.line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)),}
  \AttributeTok{screen =} \FunctionTok{list}\NormalTok{(}\AttributeTok{z =} \DecValTok{120}\NormalTok{, }\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{70}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/log-likelihood-1} 

}

\caption{正态分布参数的负对数似然函数}\label{fig:log-likelihood}
\end{figure}

\hypertarget{sec-non-linear-tseries}{%
\section{微分方程}\label{sec-non-linear-tseries}}

\href{https://blog.hamaluik.ca/posts/solving-systems-of-partial-differential-equations/}{ode45 求解偏微分方程}

\textbf{pracma} 实现了 ode23, ode23s, ode45 等几个自适应的 Runge-Kutta 求解器，\textbf{deSolve} 包求解 ODE（常微分方程）, DAE（微分代数方程）, DDE（延迟微分方程，包含刚性和非刚性方程）和 PDE（偏微分方程），\textbf{bvpSolve}包求解 DAE/ODE 方程的边值问题。\textbf{ReacTran} \citep{ReacTran2012} 可将偏微分方程转为常微分方程组，解决反应运输问题，在笛卡尔、极坐标、圆柱形和球形网格上离散偏微分方程。 \href{https://github.com/LLNL/sundials}{sundials} 提供一系列非线性方程、常微分方程、微分代数方程求解器，Satyaprakash Nayak 开发了相应的 \href{https://github.com/sn248/sundialr}{\textbf{sundialr}} 包。

\hypertarget{subsec-ordinary-differential-equations}{%
\subsection{常微分方程}\label{subsec-ordinary-differential-equations}}

\href{https://en.wikipedia.org/wiki/Lorenz_system}{洛伦兹系统}是一个常微分方程组，系统参数的默认值为 \((\sigma = 10, \rho = 28, \beta = 8/3)\)，初值为 \((-13, -14, 47)\)。

\begin{equation*}
\left\{ 
  \begin{array}{l}
    \frac{\partial x}{\partial t} = \sigma (y - x) \\
    \frac{\partial y}{\partial t} = x(\rho -z) - y \\
    \frac{\partial x}{\partial t} = xy - \beta z
  \end{array} \right.
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(deSolve)}
\CommentTok{\# 参数}
\NormalTok{pars }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{a =} \SpecialCharTok{{-}}\DecValTok{8} \SpecialCharTok{/} \DecValTok{3}\NormalTok{, }\AttributeTok{b =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{c =} \DecValTok{28}\NormalTok{)}
\CommentTok{\# 初值}
\NormalTok{state }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{X =} \DecValTok{1}\NormalTok{, }\AttributeTok{Y =} \DecValTok{1}\NormalTok{, }\AttributeTok{Z =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# 时间间隔}
\NormalTok{times }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.01}\NormalTok{)}
\CommentTok{\# 定义方程组}
\NormalTok{lorenz\_fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t, state, parameters) \{}
  \FunctionTok{with}\NormalTok{(}\FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(state, parameters)), \{}
\NormalTok{    dX }\OtherTok{\textless{}{-}}\NormalTok{ a }\SpecialCharTok{*}\NormalTok{ X }\SpecialCharTok{+}\NormalTok{ Y }\SpecialCharTok{*}\NormalTok{ Z}
\NormalTok{    dY }\OtherTok{\textless{}{-}}\NormalTok{ b }\SpecialCharTok{*}\NormalTok{ (Y }\SpecialCharTok{{-}}\NormalTok{ Z)}
\NormalTok{    dZ }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\NormalTok{X }\SpecialCharTok{*}\NormalTok{ Y }\SpecialCharTok{+}\NormalTok{ c }\SpecialCharTok{*}\NormalTok{ Y }\SpecialCharTok{{-}}\NormalTok{ Z}
    \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(dX, dY, dZ))}
\NormalTok{  \})}
\NormalTok{\}}
\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{ode}\NormalTok{(}
  \AttributeTok{y =}\NormalTok{ state, }\AttributeTok{times =}\NormalTok{ times,}
  \AttributeTok{func =}\NormalTok{ lorenz\_fun, }\AttributeTok{parms =}\NormalTok{ pars}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

调用 \textbf{scatterplot3d} 绘制三维曲线图，如图\ref{fig:ode-lorenz} 所示

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(scatterplot3d)}

\FunctionTok{scatterplot3d}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ out[, }\StringTok{"X"}\NormalTok{], }\AttributeTok{y =}\NormalTok{ out[, }\StringTok{"Y"}\NormalTok{], }\AttributeTok{z =}\NormalTok{ out[, }\StringTok{"Z"}\NormalTok{],}
  \AttributeTok{col.axis =} \StringTok{"black"}\NormalTok{, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{color =} \StringTok{"gray"}\NormalTok{,}
  \AttributeTok{xlab =} \FunctionTok{expression}\NormalTok{(x), }\AttributeTok{ylab =} \FunctionTok{expression}\NormalTok{(y), }\AttributeTok{zlab =} \FunctionTok{expression}\NormalTok{(z),}
  \AttributeTok{col.grid =} \StringTok{"gray"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Lorenz"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/ode-lorenz-1} 

}

\caption{洛伦兹曲线}\label{fig:ode-lorenz}
\end{figure}

\hypertarget{subsec-partial-differential-equations}{%
\subsection{偏微分方程}\label{subsec-partial-differential-equations}}

ReacTran 的几个关键函数介绍

一维热传导方程

\begin{equation*}
\left\{ 
  \begin{array}{l}
    \frac{\partial y}{\partial t} = D \frac{\partial^2 y}{\partial x^2}
  \end{array} \right.
\end{equation*}

参数 \(D = 0.01\)，边界条件 \(y_{t,x=0} = 0, y_{t, x = 1} = 1\)，初始条件 \(y_{t=0,x} = \sin(\pi x)\)。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ReacTran)}

\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{100}
\NormalTok{xgrid }\OtherTok{\textless{}{-}} \FunctionTok{setup.grid.1D}\NormalTok{(}\AttributeTok{x.up =} \DecValTok{0}\NormalTok{, }\AttributeTok{x.down =} \DecValTok{1}\NormalTok{, }\AttributeTok{N =}\NormalTok{ N)}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ xgrid}\SpecialCharTok{$}\NormalTok{x.mid}
\NormalTok{D.coeff }\OtherTok{\textless{}{-}} \FloatTok{0.01}
\NormalTok{Diffusion }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t, Y, parms) \{}
\NormalTok{  tran }\OtherTok{\textless{}{-}} \FunctionTok{tran.1D}\NormalTok{(}
    \AttributeTok{C =}\NormalTok{ Y, }\AttributeTok{C.up =} \DecValTok{0}\NormalTok{, }\AttributeTok{C.down =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{D =}\NormalTok{ D.coeff, }\AttributeTok{dx =}\NormalTok{ xgrid}
\NormalTok{  )}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{dY =}\NormalTok{ tran}\SpecialCharTok{$}\NormalTok{dC, }
    \AttributeTok{flux.up =}\NormalTok{ tran}\SpecialCharTok{$}\NormalTok{flux.up,}
    \AttributeTok{flux.down =}\NormalTok{ tran}\SpecialCharTok{$}\NormalTok{flux.down}
\NormalTok{  )}
\NormalTok{\}}
\NormalTok{yini }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(pi }\SpecialCharTok{*}\NormalTok{ x)}
\NormalTok{times }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{5}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.01}\NormalTok{)}
\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{ode.1D}\NormalTok{(}
  \AttributeTok{y =}\NormalTok{ yini, }\AttributeTok{times =}\NormalTok{ times, }\AttributeTok{func =}\NormalTok{ Diffusion,}
  \AttributeTok{parms =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{dimens =}\NormalTok{ N}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{image}\NormalTok{(out,}
  \AttributeTok{grid =}\NormalTok{ xgrid}\SpecialCharTok{$}\NormalTok{x.mid, }\AttributeTok{xlab =} \StringTok{"times"}\NormalTok{,}
  \AttributeTok{ylab =} \StringTok{"Distance"}\NormalTok{, }\AttributeTok{main =} \StringTok{"PDE"}\NormalTok{, }\AttributeTok{add.contour =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/pde-1d-1} 

}

\caption{一维热传导方程的数值解热力图}\label{fig:pde-1d}
\end{figure}

二维拉普拉斯方程

\begin{equation*}
\left\{ 
  \begin{array}{l}
    \frac{\partial^2 u}{\partial^2 x} + \frac{\partial^2 u}{\partial y^2} = 0
  \end{array} \right.
\end{equation*}

边界条件

\begin{equation*}
\left\{ 
  \begin{array}{l}
    u_{x=0,y} = u_{x=1,y} = 0 \\
    \frac{\partial u_{x, y=0}}{\partial y} = 0 \\
    \frac{\partial u_{x,y=1}}{\partial y} = \pi\sinh(\pi)\sin(\pi x)
  \end{array} \right.
\end{equation*}

它有解析解

\[
u(x,y) = \sin(\pi x)\cosh(\pi y)
\]

其中 \(x \in [0,1], y\in [0,1]\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, y) \{}
  \FunctionTok{sin}\NormalTok{(pi }\SpecialCharTok{*}\NormalTok{ x) }\SpecialCharTok{*} \FunctionTok{cosh}\NormalTok{(pi }\SpecialCharTok{*}\NormalTok{ y)}
\NormalTok{\}}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{101}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{101}\NormalTok{)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{outer}\NormalTok{(x, y, fn)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{image}\NormalTok{(z, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{20}\NormalTok{))}
\FunctionTok{contour}\NormalTok{(z, }\AttributeTok{method =} \StringTok{"flattest"}\NormalTok{, }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/laplace-eq-image-1} 

}

\caption{解析解的二维图像}\label{fig:laplace-eq-image}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{persp}\NormalTok{(z, }
  \AttributeTok{theta =} \DecValTok{30}\NormalTok{, }\AttributeTok{phi =} \DecValTok{20}\NormalTok{, }
  \AttributeTok{r =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{expand =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{ltheta =} \DecValTok{90}\NormalTok{, }\AttributeTok{lphi =} \DecValTok{180}\NormalTok{,}
  \AttributeTok{shade =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{ticktype =} \StringTok{"detailed"}\NormalTok{, }\AttributeTok{nticks =} \DecValTok{5}\NormalTok{, }\AttributeTok{box =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{col =} \FunctionTok{drapecol}\NormalTok{(z, }\AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{20}\NormalTok{)),}
  \AttributeTok{border =} \StringTok{"transparent"}\NormalTok{,}
  \AttributeTok{xlab =} \StringTok{"X"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Y"}\NormalTok{, }\AttributeTok{zlab =} \StringTok{"Z"}\NormalTok{, }
  \AttributeTok{main =} \StringTok{""}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{numerical-optimization_files/figure-latex/laplace-eq-persp-1} 

}

\caption{解析解的三维透视图像}\label{fig:laplace-eq-persp}
\end{figure}

求解 PDE

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dx }\OtherTok{\textless{}{-}} \FloatTok{0.2}
\NormalTok{xgrid }\OtherTok{\textless{}{-}} \FunctionTok{setup.grid.1D}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{dx.1 =}\NormalTok{ dx)}
\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ xgrid}\SpecialCharTok{$}\NormalTok{x.mid}
\NormalTok{N }\OtherTok{\textless{}{-}}\NormalTok{ xgrid}\SpecialCharTok{$}\NormalTok{N}

\NormalTok{uini }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.05} \SpecialCharTok{*}\NormalTok{ x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{vini }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, N)}
\NormalTok{yini }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(uini, vini)}
\NormalTok{times }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{50}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{)}

\NormalTok{wave }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t, y, parms) \{}
\NormalTok{  u1 }\OtherTok{\textless{}{-}}\NormalTok{ y[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{N]}
\NormalTok{  u2 }\OtherTok{\textless{}{-}}\NormalTok{ y[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{N)]}
\NormalTok{  du1 }\OtherTok{\textless{}{-}}\NormalTok{ u2}
\NormalTok{  du2 }\OtherTok{\textless{}{-}} \FunctionTok{tran.1D}\NormalTok{(}\AttributeTok{C =}\NormalTok{ u1, }\AttributeTok{C.up =} \DecValTok{0}\NormalTok{, }\AttributeTok{C.down =} \DecValTok{0}\NormalTok{, }\AttributeTok{D =} \DecValTok{1}\NormalTok{, }\AttributeTok{dx =}\NormalTok{ xgrid)}\SpecialCharTok{$}\NormalTok{dC}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(du1, du2)))}
\NormalTok{\}}

\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{ode.1D}\NormalTok{(}
  \AttributeTok{func =}\NormalTok{ wave, }\AttributeTok{y =}\NormalTok{ yini, }\AttributeTok{times =}\NormalTok{ times, }\AttributeTok{parms =} \ConstantTok{NULL}\NormalTok{,}
  \AttributeTok{nspec =} \DecValTok{2}\NormalTok{, }\AttributeTok{method =} \StringTok{"ode45"}\NormalTok{, }\AttributeTok{dimens =}\NormalTok{ N, }\AttributeTok{names =} \FunctionTok{c}\NormalTok{(}\StringTok{"u"}\NormalTok{, }\StringTok{"v"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsec-delay-differential-equations}{%
\subsection{延迟微分方程}\label{subsec-delay-differential-equations}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(PBSddesolve)    }\CommentTok{\# DAE 延迟微分方程}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/pbs-software/pbs-ddesolve}{\textbf{PBSddesolve}} \citep{PBSddesolve} \textbf{PBSmodelling} \textbf{PBSmapping}

\textbf{nlmeODE} 通过微分方程整合用于混合效应模型的 odesolve 和 nlme 包。

\hypertarget{subsec-stochastic-differential-equations}{%
\subsection{随机微分方程}\label{subsec-stochastic-differential-equations}}

\href{https://github.com/acguidoum/Sim.DiffProc}{Sim.DiffProc}

\href{https://uploads.cosx.org/2008/12/stochastic-differential-equation-with-r.pdf}{随机微分方程入门：基于 R 语言的模拟和推断}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# library(Sim.DiffProc)}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/nlmixrdevelopment/nlmixr}{nlmixr} 借助 \href{https://github.com/nlmixrdevelopment/RxODE/}{RxODE} 求解基于常微分方程的非线性混合效应模型

\hypertarget{sec-numerical-optimization-session}{%
\section{运行环境}\label{sec-numerical-optimization-session}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] Deriv_4.1.3               quadprog_1.5-8           
##  [3] kableExtra_1.3.4          tibble_3.1.7             
##  [5] nlme_3.1-157              PBSddesolve_1.12.6       
##  [7] ReacTran_1.4.3.1          shape_1.4.6              
##  [9] scatterplot3d_0.3-41      deSolve_1.32             
## [11] BB_2019.10-1              rootSolve_1.8.2.3        
## [13] kernlab_0.9-30            lattice_0.20-45          
## [15] ROI.plugin.scs_1.1-1      ROI.plugin.quadprog_1.0-0
## [17] ROI.plugin.lpsolve_1.0-1  ROI.plugin.nloptr_1.0-0  
## [19] ROI.plugin.alabama_1.0-0  ROI_1.0-0                
## [21] lpSolve_5.6.15           
## 
## loaded via a namespace (and not attached):
##  [1] svglite_2.1.0           sysfonts_0.8.8          digest_0.6.29          
##  [4] utf8_1.2.2              slam_0.1-50             R6_2.5.1               
##  [7] alabama_2022.4-1        evaluate_0.15           httr_1.4.3             
## [10] pillar_1.7.0            rlang_1.0.2             curl_4.3.2             
## [13] rstudioapi_0.13         nloptr_2.0.1            rmarkdown_2.14         
## [16] webshot_0.5.3           stringr_1.4.0           munsell_0.5.0          
## [19] compiler_4.2.0          numDeriv_2016.8-1.1     xfun_0.31              
## [22] pkgconfig_2.0.3         systemfonts_1.0.4       htmltools_0.5.2        
## [25] bookdown_0.26           viridisLite_0.4.0       fansi_1.0.3            
## [28] crayon_1.5.1            grid_4.2.0              lifecycle_1.0.1        
## [31] registry_0.5-1          magrittr_2.0.3          scales_1.2.0           
## [34] cli_3.3.0               stringi_1.7.6           xml2_1.3.3             
## [37] ellipsis_0.3.2          vctrs_0.4.1             lpSolveAPI_5.5.2.0-17.7
## [40] tools_4.2.0             glue_1.6.2              fastmap_1.1.0          
## [43] yaml_2.3.5              colorspace_2.0-3        scs_3.0-0              
## [46] rvest_1.0.2             knitr_1.39
\end{verbatim}

\hypertarget{appendix}{%
\appendix}


\hypertarget{chap-linux-command-bash}{%
\chapter{命令行操作}\label{chap-linux-command-bash}}

Bash 文件查找、查看（内容、大小）、移动（重命名）、删除、创建、修改权限

Linux 命令行工具是非常强大的，命令行中的数据科学 \url{https://www.datascienceatthecommandline.com/}，Linux 命令行 \url{https://github.com/jaywcjlove/linux-command}

\href{https://github.com/trevorld/r-optparse}{optparse}、\href{https://github.com/docopt/docopt.R}{docopt} 、\href{https://github.com/eddelbuettel/littler}{littler} 包提供了很多便捷的命令行工具，\href{https://github.com/jeroen/sys}{sys}， \href{https://github.com/r-lib/fs}{fs} 在 R 中运行操作系统命令

如表\ref{tab:r-vs-shell}所示，总结了 R 和 Shell 命令的等价表示，下面以 \texttt{list.files()} 和 \texttt{ls} 为例，介绍其等价的内容

\begin{longtable}[]{@{}lll@{}}
\caption[\label{tab:r-vs-shell} R 和 Shell 命令的等价表示 ]{\label{tab:r-vs-shell} R 和 Shell 命令的等价表示 \footnote{CentOS 系统默认没有安装 tree 软件，需要先安装才能使用此命令 \texttt{sudo\ dnf\ install\ -y\ tree}}}\tabularnewline
\toprule
& R & Shell \\
\midrule
\endfirsthead
\toprule
& R & Shell \\
\midrule
\endhead
查看文件 & \texttt{list.files()} & \texttt{ls} \\
查看目录 & \texttt{list.dirs()} & \texttt{dir} \\
目录层次 & \texttt{fs::dir\_tree()} & \texttt{tree} \\
\bottomrule
\end{longtable}

\hypertarget{sec-ls}{%
\section{查看文件}\label{sec-ls}}

\texttt{ls}/\texttt{mkdir}/\texttt{mv}/\texttt{du}

查看文件

\begin{verbatim}
```bash
ls -a
```

列出目录下所有文件

```bash
ls -1 
```

一行显示一个文件或文件夹

```bash
ls -l 
```

按从 aA-zZ 的顺序列出所有文件以及所属权限

```bash
ls -rl 
```

相比于 `ls -l` 文件是逆序排列

```bash
ls -lh
```

列出文件或文件夹（不包含子文件夹）的大小 

```bash
ls -ld 
```

列出当前目录本身，而不是其所包含的内容
\end{verbatim}

\hypertarget{sec-mkdir}{%
\section{创建文件夹}\label{sec-mkdir}}

\begin{verbatim}
```bash
mkdir images
```

创建文件用 `touch` 如 `touch .Rprofile` 

```bash
# 删除文件夹及子文件夹，递归删除
rm -rf images/
# 删除文件
rm .Rprofile
```
\end{verbatim}

\hypertarget{sec-mv}{%
\section{移动文件}\label{sec-mv}}

\begin{verbatim}
在当前目录下

```bash
# 移动文件夹 images 下的所有文件到 figures 文件夹下
mv images/* figures/
# images 文件夹移动到 figures 文件夹下
mv images/ figures/
# 移动特定的文件
mv images/*.png figures/
```

同一目录下有两个文件 `R-3.5.1.tar.gz` 未下载完整 和 `R-3.5.1.tar.gz.1` 完全下载

```bash
# 删除 R-3.5.1.tar.gz
rm R-3.5.1.tar.gz
# 重命名 R-3.5.1.tar.gz.1 
mv R-3.5.1.tar.gz.1  R-3.5.1.tar.gz
```
\end{verbatim}

\hypertarget{sec-du}{%
\section{查看文件大小}\label{sec-du}}

\begin{verbatim}
当前目录下各文件夹的大小， `-h` 表示人类（相对于机器来说）可读的方式显示，如 Kb、Mb、Gb，`-d` 表示目录深度 `du --human-readable --max-depth=1 ./`

```bash
du -h -d 1 ./
```

```bash
# 对当前目录下的文件/夹 按大小排序
du -sh * | sort -nr
```
\end{verbatim}

\hypertarget{sec-shell}{%
\section{终端模拟器}\label{sec-shell}}

\href{https://ohmyz.sh/}{oh-my-zsh} 是 \href{https://www.zsh.org/}{Z Shell} 扩展，开发在 Github 上 \url{https://github.com/ohmyzsh/ohmyzsh}。

zsh 相比于 bash， 在语法高亮、自动补全等方面有优势

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ zsh}
\FunctionTok{sh} \AttributeTok{{-}c} \StringTok{"}\VariableTok{$(}\ExtensionTok{curl} \AttributeTok{{-}fsSL}\NormalTok{ https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh}\VariableTok{)}\StringTok{"}
\end{Highlighting}
\end{Shaded}

RStudio 集成的终端支持 Zsh，操作路径 Tools -\textgreater{} Global Options -\textgreater{} Terminal， 见图 \ref{fig:zsh-rstudio}

\begin{figure}
\centering
\includegraphics[width=0.75\textwidth,height=\textheight]{screenshots/zsh-rstudio.png}
\caption{\label{fig:zsh-rstudio} RStudio IDE 集成的 Zsh 终端模拟器}
\end{figure}

\hypertarget{sec-tar}{%
\section{压缩和解压缩}\label{sec-tar}}

最常见的压缩文件格式有 \texttt{.tar}、\texttt{.tar.gz}、\texttt{.tar.bz2}、\texttt{.zip} 和 \texttt{.rar}，分别对应于 Tar \url{https://www.gnu.org/software/tar/}、 Gzip \url{https://www.gzip.org/} 、 Bzip2 \url{https://www.bzip.org/} 、 UnZip/Zip \url{http://www.info-zip.org} 和 WinRAR \url{https://www.rarlab.com/}。 Tar 提供了基本的打包和解包工具，Gzip 和 Bzip2 在 Tar 打包的基础上提供了压缩功能， UnZip/Zip 是兼容 Windows 原生压缩/解压缩功能的程序，WinRAR 是广泛流行于 Windows 系统的压缩/解压缩收费软件，除了 WinRAR，其它都是免费甚至开源软件。 下面以 \texttt{.tar.gz} 和\texttt{.tar.bz2} 两种格式的压缩文件为例，介绍文件压缩和解压缩的操作，其它文件格式的操作类似\footnote{zip 格式的文件需要额外安装 zip 和 unzip 两款软件实现压缩和解压缩。}。WinRAR \url{https://www.rarlab.com/} 是收费的压缩和解压缩工具，也支持 Linux 和 macOS 系统，鉴于它是收费软件，这里就不多展开介绍了，详情请见官网。

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ tar gzip zip unzip }
\CommentTok{\# 将目录 \textasciitilde{}/tmp 压缩成文件 filename.tar.gz}
\FunctionTok{tar} \AttributeTok{{-}czf} \PreprocessorTok{**}\NormalTok{.tar.gz \textasciitilde{}/tmp}
\CommentTok{\# 将文件 filename.tar.gz 解压到目录 \textasciitilde{}/tmp}
\FunctionTok{tar} \AttributeTok{{-}xzf} \PreprocessorTok{**}\NormalTok{.tar.gz }\AttributeTok{{-}C}\NormalTok{ \textasciitilde{}/tmp}
\end{Highlighting}
\end{Shaded}

\end{column}

\begin{column}{0.05\textwidth}
~

\end{column}

\begin{column}{0.475\textwidth}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ bzip2}
\CommentTok{\# 将目录 \textasciitilde{}/tmp 压缩成文件 filename.tar.bz2}
\FunctionTok{tar} \AttributeTok{{-}cjf}\NormalTok{ filename.tar.bz2 \textasciitilde{}/tmp}
\CommentTok{\# 将文件 filename.tar.bz2 解压到目录 \textasciitilde{}/tmp}
\FunctionTok{tar} \AttributeTok{{-}xjf}\NormalTok{ filename.tar.bz2 }\AttributeTok{{-}C}\NormalTok{ \textasciitilde{}/tmp}
\end{Highlighting}
\end{Shaded}

\end{column}

解压不带 tar 的 .gz 文件，比如 \href{http://www-cs-faculty.stanford.edu/~knuth/tex.eps.gz}{tex.eps.gz} 解压后变成 tex.eps

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{gzip}\NormalTok{ filename.gz }\AttributeTok{{-}d}\NormalTok{ \textasciitilde{}/tmp}
\end{Highlighting}
\end{Shaded}

\hypertarget{repo-install}{%
\section{从仓库安装 R}\label{repo-install}}

\hypertarget{ubuntu}{%
\subsection{Ubuntu}\label{ubuntu}}

安装 openssh zsh 和 Git

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install zsh openssh{-}server}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:git{-}core/ppa}
\FunctionTok{sudo}\NormalTok{ apt update }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ apt install git}
\FunctionTok{sh} \AttributeTok{{-}c} \StringTok{"}\VariableTok{$(}\ExtensionTok{curl} \AttributeTok{{-}fsSL}\NormalTok{ https://raw.githubusercontent.com/robbyrussell/oh{-}my{-}zsh/master/tools/install.sh}\VariableTok{)}\StringTok{"}
\end{Highlighting}
\end{Shaded}

只考虑最新的 Ubuntu 18.04 因为本书写成的时候，该版本应该已经大规模使用了，默认版本的安装和之前版本的安装就不再展示了。安装最新版 R-3.5.x，无论安装哪个版本，都要先导入密钥

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}key adv }\AttributeTok{{-}{-}keyserver}\NormalTok{ hkp://keyserver.ubuntu.com:80 }\AttributeTok{{-}{-}recv}\NormalTok{ E084DAB9}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\item
  Ubuntu 14.04.5 提供的默认版本 R 3.0.2，安装 R 3.5.x 系列之前的版本，如 R 3.4.4

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}add{-}repository }\AttributeTok{{-}y} \StringTok{"deb http://cran.rstudio.com/bin/linux/ubuntu }\KeywordTok{\textasciigrave{}}\ExtensionTok{lsb\_release} \AttributeTok{{-}cs}\KeywordTok{\textasciigrave{}}\StringTok{/"}
\FunctionTok{sudo}\NormalTok{ apt{-}get install r{-}base{-}dev}
\end{Highlighting}
\end{Shaded}

  添加完仓库后，都需要更新源\texttt{sudo\ apt-get\ update}，安装 R 3.5.x 系列最新版

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}add{-}repository }\AttributeTok{{-}y} \StringTok{"deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu trusty{-}cran35/"}
\end{Highlighting}
\end{Shaded}
\item
  Ubuntu 16.04.5 提供的默认版本 R 3.4.4，这是 R 3.4.x 系列的最新版，安装目前最新的 R 3.5.x 版本需要

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}add{-}repository }\AttributeTok{{-}y} \StringTok{"deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu xenial{-}cran35/"}
\end{Highlighting}
\end{Shaded}
\item
  Ubuntu 18.04.1 提供的默认版本 R 3.4.4，安装目前的最新版本需要

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}add{-}repository }\AttributeTok{{-}y} \StringTok{"deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu bionic{-}cran35/"}
\end{Highlighting}
\end{Shaded}

  接下来安装 R，详细安装指导见 \href{https://cran.r-project.org/bin/linux/debian/index.html}{CRAN 官网}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ r{-}base{-}dev}
\end{Highlighting}
\end{Shaded}

  Michael Rutter 维护了编译好的二进制版本 \url{https://launchpad.net/~marutter}，比如 rstan 包可以通过安装 r-cran-rstan 完成

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# R packages for Ubuntu LTS. Based on CRAN Task Views.}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:marutter/c2d4u3.5}
\FunctionTok{sudo}\NormalTok{ apt{-}get install r{-}cran{-}rstan}
\end{Highlighting}
\end{Shaded}
\end{itemize}

\hypertarget{centos}{%
\subsection{CentOS}\label{centos}}

同样适用于 Fedora

安装指导\footnote{在 CentOS 7 上打造 R 语言编程环境}

\hypertarget{source-install}{%
\section{源码安装}\label{source-install}}

\hypertarget{ubuntu-1}{%
\subsection{Ubuntu}\label{ubuntu-1}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  首先启用源码仓库，否则执行 \texttt{sudo\ apt-get\ build-dep\ r-base} 会报如下错误
\end{enumerate}

\begin{verbatim}
E: You must put some 'source' URIs in your sources.list
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ sed }\AttributeTok{{-}i} \AttributeTok{{-}{-}} \StringTok{\textquotesingle{}s/\#deb{-}src/deb{-}src/g\textquotesingle{}}\NormalTok{ /etc/apt/sources.list }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ sed }\AttributeTok{{-}i} \AttributeTok{{-}{-}} \StringTok{\textquotesingle{}s/\# deb{-}src/deb{-}src/g\textquotesingle{}}\NormalTok{ /etc/apt/sources.list}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  安装编译 R 所需的系统依赖
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get build{-}dep r{-}base{-}dev}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  编译安装 R
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{./configure}
\FunctionTok{make} \KeywordTok{\&\&} \FunctionTok{make}\NormalTok{ install }
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  自定义编译选项
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{./configure} \AttributeTok{{-}{-}help}
\end{Highlighting}
\end{Shaded}

\hypertarget{centos-1}{%
\subsection{CentOS}\label{centos-1}}

基于 CentOS 7 和 GCC 4.8.5，参考 R-admin 手册

\begin{itemize}
\item
  下载源码包

  最新发布的稳定版

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{curl} \AttributeTok{{-}fLo}\NormalTok{ ./R{-}latest.tar.gz https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R{-}latest.tar.gz}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
 10 28.7M   10 3232k    0     0   107k      0  0:04:34  0:00:30  0:04:04  118k
\end{verbatim}
\item
  安装依赖

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install }\AttributeTok{{-}y}\NormalTok{ yum{-}utils epel{-}release }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ yum{-}builddep R{-}devel}
\FunctionTok{sudo}\NormalTok{ dnf update }\KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ dnf builddep R{-}devel }\CommentTok{\# Fedora 30}
\end{Highlighting}
\end{Shaded}
\item
  解压配置

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mkdir}\NormalTok{ R{-}latest }\KeywordTok{\&\&} \FunctionTok{tar} \AttributeTok{{-}xzf}\NormalTok{ ./R{-}latest.tar.gz }\AttributeTok{{-}C}\NormalTok{ ./R{-}latest }\KeywordTok{\&\&} \BuiltInTok{cd}\NormalTok{ R{-}3.5.2}

\ExtensionTok{./configure} \AttributeTok{{-}{-}enable{-}R{-}shlib} \AttributeTok{{-}{-}enable{-}byte{-}compiled{-}packages} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}BLAS{-}shlib} \AttributeTok{{-}{-}enable{-}memory{-}profiling}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R is now configured for x86\_64{-}pc{-}linux{-}gnu}

\NormalTok{  Source directory:          .}
\NormalTok{  Installation directory:    /usr/local}

\NormalTok{  C compiler:                gcc {-}std=gnu99  {-}g {-}O2}
\NormalTok{  Fortran 77 compiler:       gfortran  {-}g {-}O2}

\NormalTok{  Default C++ compiler:      g++   {-}g {-}O2}
\NormalTok{  C++98 compiler:            g++ {-}std=gnu++98 {-}g {-}O2}
\NormalTok{  C++11 compiler:            g++ {-}std=gnu++11 {-}g {-}O2}
\NormalTok{  C++14 compiler:}
\NormalTok{  C++17 compiler:}
\NormalTok{  Fortran 90/95 compiler:    gfortran {-}g {-}O2}
\NormalTok{  Obj{-}C compiler:            gcc {-}g {-}O2 {-}fobjc{-}exceptions}

\NormalTok{  Interfaces supported:      X11, tcltk}
\NormalTok{  External libraries:        readline, curl}
\NormalTok{  Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU}
\NormalTok{  Options enabled:           shared R library, shared BLAS, R profiling, memory profiling}

\NormalTok{  Capabilities skipped:}
\NormalTok{  Options not enabled:}

\NormalTok{  Recommended packages:      yes}
\end{Highlighting}
\end{Shaded}
\item
  编译安装

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{make} \AttributeTok{{-}j}\NormalTok{ 2 all}
\FunctionTok{sudo}\NormalTok{ make install}
\end{Highlighting}
\end{Shaded}
\item
  BLAS 加持（可选）

  BLAS 对于加快矩阵计算至关重要，编译 R 带 \href{https://cran.r-project.org/doc/manuals/r-release/R-admin.html\#BLAS}{BLAS 支持}，添加 OpenBLAS 支持 \texttt{-\/-with-blas="-lopenblas"} 或 ATLAS 支持 \texttt{-\/-with-blas="-L/usr/lib64/atlas\ -lsatlas"}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install }\AttributeTok{{-}y}\NormalTok{ openblas openblas{-}threads openblas{-}openmp }

\ExtensionTok{./configure} \AttributeTok{{-}{-}enable{-}R{-}shlib} \AttributeTok{{-}{-}enable{-}byte{-}compiled{-}packages} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}BLAS{-}shlib} \AttributeTok{{-}{-}enable{-}memory{-}profiling} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}with{-}blas}\OperatorTok{=}\StringTok{"{-}lopenblas"}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R is now configured for x86\_64{-}pc{-}linux{-}gnu}

\NormalTok{Source directory:          .}
\NormalTok{Installation directory:    /usr/local}

\NormalTok{C compiler:                gcc {-}std=gnu99  {-}g {-}O2}
\NormalTok{Fortran 77 compiler:       gfortran  {-}g {-}O2}

\NormalTok{Default C++ compiler:      g++   {-}g {-}O2}
\NormalTok{C++98 compiler:            g++ {-}std=gnu++98 {-}g {-}O2}
\NormalTok{C++11 compiler:            g++ {-}std=gnu++11 {-}g {-}O2}
\NormalTok{C++14 compiler:}
\NormalTok{C++17 compiler:}
\NormalTok{Fortran 90/95 compiler:    gfortran {-}g {-}O2}
\NormalTok{Obj{-}C compiler:            gcc {-}g {-}O2 {-}fobjc{-}exceptions}

\NormalTok{Interfaces supported:      X11, tcltk}
\NormalTok{External libraries:        readline, **BLAS(OpenBLAS)**, curl}
\NormalTok{Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU}
\NormalTok{Options enabled:           shared R library, shared BLAS, R profiling, memory profiling}

\NormalTok{Capabilities skipped:}
\NormalTok{Options not enabled:}

\NormalTok{Recommended packages:      yes}
\end{Highlighting}
\end{Shaded}

  配置成功的标志，如 OpenBLAS

\begin{verbatim}
checking for dgemm_ in -lopenblas... yes
checking whether double complex BLAS can be used... yes
checking whether the BLAS is complete... yes
\end{verbatim}

  ATLAS 加持

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install }\AttributeTok{{-}y}\NormalTok{ atlas}
\ExtensionTok{./configure} \AttributeTok{{-}{-}enable{-}R{-}shlib} \AttributeTok{{-}{-}enable{-}byte{-}compiled{-}packages} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}BLAS{-}shlib} \AttributeTok{{-}{-}enable{-}memory{-}profiling} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}with{-}blas}\OperatorTok{=}\StringTok{"{-}L/usr/lib64/atlas {-}lsatlas"}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R is now configured for x86\_64{-}pc{-}linux{-}gnu}

\NormalTok{Source directory:          .}
\NormalTok{Installation directory:    /usr/local}

\NormalTok{C compiler:                gcc {-}std=gnu99  {-}g {-}O2}
\NormalTok{Fortran 77 compiler:       gfortran  {-}g {-}O2}

\NormalTok{Default C++ compiler:      g++   {-}g {-}O2}
\NormalTok{C++98 compiler:            g++ {-}std=gnu++98 {-}g {-}O2}
\NormalTok{C++11 compiler:            g++ {-}std=gnu++11 {-}g {-}O2}
\NormalTok{C++14 compiler:}
\NormalTok{C++17 compiler:}
\NormalTok{Fortran 90/95 compiler:    gfortran {-}g {-}O2}
\NormalTok{Obj{-}C compiler:            gcc {-}g {-}O2 {-}fobjc{-}exceptions}

\NormalTok{Interfaces supported:      X11, tcltk}
\NormalTok{External libraries:        readline, **BLAS(generic)**, curl}
\NormalTok{Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU}
\NormalTok{Options enabled:           shared R library, shared BLAS, R profiling, memory profiling}

\NormalTok{Capabilities skipped:}
\NormalTok{Options not enabled:}

\NormalTok{Recommended packages:      yes}
\end{Highlighting}
\end{Shaded}

  ATLAS 配置成功

\begin{verbatim}
checking for dgemm_ in -L/usr/lib64/atlas -lsatlas... yes
checking whether double complex BLAS can be used... yes
checking whether the BLAS is complete... yes
\end{verbatim}
\end{itemize}

后续步骤同上

\hypertarget{ninja-install}{%
\section{忍者安装}\label{ninja-install}}

从源码自定义安装：加速 Intel MKL 和 大文件支持

\url{https://software.intel.com/en-us/articles/using-intel-mkl-with-r}

\hypertarget{settings}{%
\section{配置}\label{settings}}

\hypertarget{init-session}{%
\subsection{\texorpdfstring{初始会话 \texttt{.Rprofile}}{初始会话 .Rprofile}}\label{init-session}}

\texttt{.Rprofile} 文件位于 \texttt{\textasciitilde{}/} 目录下或者 R 项目的根目录下

查看帮助 \texttt{?.Rprofile}

更多配置设置 \href{https://github.com/HenrikBengtsson/startup}{startup}

\hypertarget{environ-vars}{%
\subsection{\texorpdfstring{环境变量 \texttt{.Renviron}}{环境变量 .Renviron}}\label{environ-vars}}

\texttt{.Renviron} 文件位于 \texttt{\textasciitilde{}/} 目录下

\hypertarget{make-vars}{%
\subsection{\texorpdfstring{编译选项 \texttt{Makevars}}{编译选项 Makevars}}\label{make-vars}}

\texttt{Makevars} 文件位于 \texttt{\textasciitilde{}/.R/} 目录下

\hypertarget{command-line-arguments}{%
\section{命令行参数}\label{command-line-arguments}}

\texttt{commandArgs} 从终端命令行中传递参数

\begin{itemize}
\tightlist
\item
  \href{https://github.com/mdequeljoe/rdoc}{rdoc} 高亮 R 帮助文档中的 R 函数、关键字 \texttt{NULL}。启用需要在R控制台中执行 \texttt{rdoc::use\_rdoc()}
\item
  \href{https://github.com/randy3k/radian}{radian} 代码自动补全和语法高亮，进入 R 控制台，终端中输入\texttt{radian}
\item
  \href{https://github.com/docopt/docopt.R}{docopt} 提供R命令行工具，如 \href{https://github.com/eddelbuettel/littler}{littler} 包，\href{https://github.com/trevorld/r-getopt}{getopt} 从终端命令行接受参数
\item
  \href{https://github.com/trevorld/r-optparse}{optparse} 命令行选项参数的解析器
\end{itemize}

安装完 R-littler R-littler-examples (centos) 或 littler r-cran-littler (ubuntu) 后，执行

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# centos}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib64/R/library/littler/examples/install.r /usr/bin/install.r }
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib64/R/library/littler/examples/install2.r /usr/bin/install2.r}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib64/R/library/littler/examples/installGithub.r /usr/bin/installGithub.r }
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib64/R/library/littler/examples/testInstalled.r /usr/bin/testInstalled.r}
\CommentTok{\# ubuntu}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib/R/site{-}library/littler/examples/install.r /usr/bin/install.r }
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib/R/site{-}library/littler/examples/install2.r /usr/bin/install2.r}
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib/R/site{-}library/littler/examples/installGithub.r /usr/bin/installGithub.r }
\FunctionTok{sudo}\NormalTok{ ln }\AttributeTok{{-}s}\NormalTok{ /usr/lib/R/site{-}library/littler/examples/testInstalled.r /usr/bin/testInstalled.r}
\end{Highlighting}
\end{Shaded}

这样可以载终端中安装 R 包了

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{install.r docopt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
#!/usr/bin/env Rscript
# 安装 optparse 提供更加灵活的传参方式
# 也可参考 littler https://github.com/eddelbuettel/littler
# if("optparse" %in% .packages(TRUE)) install.packages('optparse',repos = "https://cran.rstudio.com")
# https://cran.r-project.org/doc/manuals/R-intro.html#Invoking-R-from-the-command-line
# http://www.cureffi.org/2014/01/15/running-r-batch-mode-linux/
args = commandArgs(trailingOnly=TRUE)

# 函数功能：在浏览器中同时打开多个 PDF 文档
open_pdf <- function(pdf_path = "./figures/", n = 1) {
  # pdf_path:     PDF文件所在目录
  # n:            默认打开1个PDF文档
  # PDF文档目录
  pdfs <- list.files(pdf_path, pattern = '\\.pdf$')
  # PDF 文档路径
  path_to_pdfs <- paste(pdf_path, pdfs, sep = .Platform$file.sep)
  # 打开 PDF 文档
  invisible(lapply(head(path_to_pdfs, n), browseURL))
}

open_pdf(pdf_path, n = args[1])

# 使用： Rscript --vanilla code/batch-open-pdf.R 20
\end{verbatim}

\hypertarget{sec-build-source-code}{%
\section{从源码安装 R}\label{sec-build-source-code}}

从源码编译 R 的需求大概有以下几点：

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  爱折腾的极客：玩配置，学习 make 相关工具和 Linux 世界的依赖
\item
  追求性能：如 \href{http://users.suse.com/~aj/linux_lfs.html}{LFS 支持} 和 \href{http://dirk.eddelbuettel.com/blog/2018/04/15/\#018_mkl_for_debian_ubuntu}{Intel MKL 加速}
\item
  环境限制：CentOS 或者红帽系统，自带的 R 版本比较落后
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{./configure} \AttributeTok{{-}{-}prefix}\OperatorTok{=}\NormalTok{/opt/R/R{-}devel }\DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}R{-}shlib} \AttributeTok{{-}{-}enable{-}byte{-}compiled{-}packages} \DataTypeTok{\textbackslash{}}
  \AttributeTok{{-}{-}enable{-}BLAS{-}shlib} \AttributeTok{{-}{-}enable{-}memory{-}profiling} \AttributeTok{{-}{-}with{-}blas}\OperatorTok{=}\StringTok{"{-}lopenblas"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
R is now configured for x86_64-pc-linux-gnu

  Source directory:            .
  Installation directory:      /opt/R/R-devel

  C compiler:                  gcc  -g -O2
  Fortran fixed-form compiler: gfortran -fno-optimize-sibling-calls -g -O2

  Default C++ compiler:        g++ -std=gnu++11  -g -O2
  C++14 compiler:              g++ -std=gnu++14  -g -O2
  C++17 compiler:              g++ -std=gnu++17  -g -O2
  C++20 compiler:              g++ -std=gnu++2a  -g -O2
  Fortran free-form compiler:  gfortran -fno-optimize-sibling-calls -g -O2
  Obj-C compiler:               

  Interfaces supported:        X11, tcltk
  External libraries:          pcre2, readline, BLAS(OpenBLAS), curl
  Additional capabilities:     PNG, JPEG, TIFF, NLS, cairo, ICU
  Options enabled:             shared R library, shared BLAS, R profiling, memory profiling

  Capabilities skipped:        
  Options not enabled:         

  Recommended packages:        yes
\end{verbatim}

配置好了以后，可以编译安装了

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{make} \KeywordTok{\&\&} \FunctionTok{sudo}\NormalTok{ make install}
\end{Highlighting}
\end{Shaded}

\href{https://github.com/Enchufa2/r-flexiblas}{flexiblas} 支持多种 BLAS 库自由切换

\hypertarget{install-softwares}{%
\section{安装软件}\label{install-softwares}}

本书在后续章节中陆续用到新的 R 包，其安装过程不会在正文中呈现，下面以在 CentOS 8 上安装 \textbf{sf} 包为例介绍。首先需要安装一些系统依赖，具体安装哪些依赖参见 \textbf{sf} 包开发站点 \url{https://github.com/r-spatial/sf}。

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf config{-}manager }\AttributeTok{{-}{-}set{-}disabled}\NormalTok{ PowerTools }\CommentTok{\# openblas{-}devel}
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y}\NormalTok{ sqlite{-}devel gdal{-}devel }\DataTypeTok{\textbackslash{}}
\NormalTok{  proj{-}devel geos{-}devel udunits2{-}devel}
\end{Highlighting}
\end{Shaded}

然后，在 R 命令行窗口中，执行安装命令：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}sf\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

至此，安装完成。如遇本地未安装的新 R 包，可从其官方文档中找寻安装方式。如果你完全不知道自己应该安装哪些，考虑把下面的依赖都安装上

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf install }\AttributeTok{{-}y} \DataTypeTok{\textbackslash{}}
  \CommentTok{\# magick}
  \ExtensionTok{ImageMagick{-}c++{-}devel} \DataTypeTok{\textbackslash{} }
  \CommentTok{\# pdftools}
  \ExtensionTok{poppler{-}cpp{-}devel} \DataTypeTok{\textbackslash{} }
  \CommentTok{\# gifski}
  \ExtensionTok{cargo} 
\end{Highlighting}
\end{Shaded}

软件包管理器架构图，各个命令分别担负什么样的功能，每个命令学习的一般路径是什么，而不是详细介绍每个命令、每个参数的使用，只需给出一个命令的完整使用即可，其余给出一个查询命令帮助手册

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{dnf}\NormalTok{ copr}
\ExtensionTok{dnf}\NormalTok{ config{-}manager}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-install-r-pkgs}{%
\section{安装 R 包}\label{sec-install-r-pkgs}}

Iñaki Ucar 开发的 \href{https://github.com/Enchufa2/cran2copr}{cran2copr} 项目实现在 Fedora 上安装预编译好的二进制 R 包，项目目的类似 Debian 平台上的 \href{https://github.com/r-builder/cran2deb}{cran2deb}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \href{https://github.com/r-lib/devtools}{devtools} 是开发 R 包的常用工具，同时具有很重的依赖，请看

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(}\StringTok{\textquotesingle{}devtools\textquotesingle{}}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $devtools
##  [1] "usethis"     "callr"       "cli"         "desc"        "ellipsis"   
##  [6] "fs"          "httr"        "lifecycle"   "memoise"     "pkgbuild"   
## [11] "pkgload"     "rcmdcheck"   "remotes"     "rlang"       "roxygen2"   
## [16] "rstudioapi"  "rversions"   "sessioninfo" "stats"       "testthat"   
## [21] "tools"       "utils"       "withr"       "processx"    "R6"         
## [26] "glue"        "rprojroot"   "methods"     "curl"        "jsonlite"   
## [31] "mime"        "openssl"     "cachem"      "crayon"      "prettyunits"
## [36] "digest"      "xopen"       "brew"        "commonmark"  "knitr"      
## [41] "purrr"       "stringi"     "stringr"     "xml2"        "cpp11"      
## [46] "brio"        "evaluate"    "magrittr"    "praise"      "ps"         
## [51] "waldo"       "clipr"       "gert"        "gh"          "rappdirs"   
## [56] "whisker"     "yaml"        "graphics"    "grDevices"   "fastmap"    
## [61] "askpass"     "credentials" "sys"         "zip"         "gitcreds"   
## [66] "ini"         "highr"       "xfun"        "diffobj"     "fansi"      
## [71] "rematch2"    "tibble"      "pillar"      "pkgconfig"   "vctrs"      
## [76] "utf8"
\end{verbatim}

  其中，依赖关系见表 \ref{tab:devtools-sys-dep}

  \begin{longtable}[]{@{}llll@{}}
  \caption{\label{tab:devtools-sys-dep} devtools 的系统依赖}\tabularnewline
  \toprule
  & curl & git2r & openssl \\
  \midrule
  \endfirsthead
  \toprule
  & curl & git2r & openssl \\
  \midrule
  \endhead
  Ubuntu & libcurl-dev\footnote{libcurl-dev 是一个虚包 virtual package，由 libcurl4-openssl-dev 或 libcurl4-nss-dev 或 libcurl4-gnutls-dev 实际提供，选择其中一个安装即可。} & libgit2-dev & libssl-dev \\
  CentOS & libcurl-devel & libgit2-devel & openssl-devel \\
  \bottomrule
  \end{longtable}
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \href{https://github.com/r-spatial/sf}{sf} 是处理空间数据的常用工具

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tools}\SpecialCharTok{::}\FunctionTok{package\_dependencies}\NormalTok{(}\StringTok{\textquotesingle{}sf\textquotesingle{}}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $sf
##  [1] "methods"    "classInt"   "DBI"        "graphics"   "grDevices" 
##  [6] "grid"       "magrittr"   "Rcpp"       "s2"         "stats"     
## [11] "tools"      "units"      "utils"      "e1071"      "class"     
## [16] "KernSmooth" "wk"         "MASS"       "proxy"
\end{verbatim}

  其主要的系统依赖分别是 GEOS 3.5.1, GDAL 2.2.2, PROJ 4.9.2

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:ubuntugis/ubuntugis{-}unstable}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ libudunits2{-}dev libgdal{-}dev libgeos{-}dev libproj{-}dev }
\end{Highlighting}
\end{Shaded}

  这样也同时解决了 \href{https://github.com/pacificclimate/Rudunits2}{udunits2}、 \href{https://r-forge.r-project.org/projects/rgdal/}{rgdal} 和 \href{https://r-forge.r-project.org/projects/rgeos/}{rgeos} 等 3个 R 包的系统依赖，其中 udunits2 使用如下命令安装

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(’udunits2’, }\AttributeTok{configure.args =} \StringTok{\textquotesingle{}{-}{-}with{-}udunits2{-}include=/usr/include/udunits2\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  图形设备支持 cairo png jpeg tiff

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ libcairo2{-}dev libjpeg{-}dev libpng{-}dev libtiff{-}dev }
\end{Highlighting}
\end{Shaded}
\item
  图像处理 \href{https://github.com/dahtah/imager}{imager} 和 \href{https://github.com/ropensci/magick}{magick}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install fftw{-}devel }\CommentTok{\# CentOS}
\FunctionTok{sudo}\NormalTok{ apt{-}get install libfftw3{-}dev }\CommentTok{\# Ubuntu}
\end{Highlighting}
\end{Shaded}

  在 Ubuntu 系统上安装最新的 libmagick++-dev 库

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:opencpu/imagemagick}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ libmagick++{-}dev }
\end{Highlighting}
\end{Shaded}

  在 CentOS 系统上

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install }\AttributeTok{{-}y}\NormalTok{ ImageMagick{-}c++{-}devel}
\end{Highlighting}
\end{Shaded}

  然后安装 R 包 \texttt{install.packages(c(\textquotesingle{}imager\textquotesingle{},\ \textquotesingle{}magick\textquotesingle{}))}
\item
  \href{https://r-forge.r-project.org/projects/rgl/}{rgl} 是绘制真三维图形的重量级 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install libcgal{-}dev libglu1{-}mesa{-}dev libx11{-}dev }\CommentTok{\# Ubuntu}
\FunctionTok{sudo}\NormalTok{ yum install mesa{-}libGLU mesa{-}libGLU{-}devel }\CommentTok{\# CentOS}
\end{Highlighting}
\end{Shaded}

  然后安装 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}rgl\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

  在 Ubuntu 系统上还可以这样安装

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository ppa:marutter/rrutter3.5}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install r{-}cran{-}rgl}
\end{Highlighting}
\end{Shaded}
\item
  \href{https://github.com/s-u/rJava}{rJava} 是 Java 语言和 R 语言之间实现通信交流的桥梁

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ default{-}jdk}
\FunctionTok{sudo}\NormalTok{ R CMD javareconf}
\end{Highlighting}
\end{Shaded}

  然后安装 rJava 包 \texttt{install.packages(’rJava’)}
\item
  \href{https://igraph.org/}{igraph} 是网络数据分析的必备 R 包，为了发挥其最大性能，需要安装三个系统依赖

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install }\AttributeTok{{-}y}\NormalTok{ libgmp{-}dev libxml2{-}dev libglpk{-}dev}
\end{Highlighting}
\end{Shaded}

  然后安装 R 包

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}igraph\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  \href{https://github.com/cdeterman/gpuR}{gpuR} 是基于 GPU 进行矩阵计算的扩展包，依赖 RcppEigen 确保安装 OpenCL 和 RViennaCL 或者 安装 Nvidia 驱动和 CUDA，使用 \href{https://github.com/gpuRcore/gpuRcuda}{gpuRcuda} 和 \href{https://github.com/nullsatz/gputools}{gputools} 扩展包，下面安装指导来自其 Wiki

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Install OpenCL headers}
\FunctionTok{sudo}\NormalTok{ apt{-}get install opencl{-}headers opencv{-}dev}

\CommentTok{\# Install NVIDIA Drivers and CUDA}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}y}\NormalTok{ ppa:xorg{-}edgers/ppa}
\FunctionTok{sudo}\NormalTok{ apt{-}get update}
\FunctionTok{sudo}\NormalTok{ apt{-}get install nvidia{-}346 nvidia{-}settings}
\end{Highlighting}
\end{Shaded}
\item
  \href{https://github.com/jyypma/nloptr}{nloptr} 是 \href{https://github.com/stevengj/NLopt/}{NLopt} 的 R 语言接口，首先安装 NLopt 程序库 \texttt{sudo\ apt-get\ install\ libnlopt-dev} 然后安装 R 包\texttt{install.packages(\textquotesingle{}nloptr\textquotesingle{})}，nloptr 被 700+ R 包依赖，如 \textbf{lme4}， \textbf{spaMM}， \textbf{glmmTMB}， \textbf{rstanarm} 等。
\item
  Rmpfr

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install libmpfr{-}dev}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(’Rmpfr’)}
\end{Highlighting}
\end{Shaded}
\item
  geojson

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install jq{-}devel protobuf{-}devel}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}geojson\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}geojsonio\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}jqr\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}protolite\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}
\item
  lgcp

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install bwidget}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}rpanel\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}lgcp\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}
\item
  ijtiff

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ yum install jbigkit{-}devel}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}ijtiff\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\item
  webshot 包用于截图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt install phantomjs}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(’webshot’)}
\end{Highlighting}
\end{Shaded}
\item
  gifski 包合成 GIF 动图

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install cargo}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{\textquotesingle{}gifski\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

\hypertarget{sec-software-manager}{%
\section{软件包管理器}\label{sec-software-manager}}

\hypertarget{subsec-dnf-yum}{%
\subsection{dnf}\label{subsec-dnf-yum}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  清理升级后的 CentOS 8 系统内核
\end{enumerate}

查找系统安装的内核

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{rpm} \AttributeTok{{-}qa} \KeywordTok{|} \FunctionTok{sort} \KeywordTok{|} \FunctionTok{grep}\NormalTok{ kernel}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
kernel-4.18.0-147.8.1.el8_1.x86_64
kernel-4.18.0-193.6.3.el8_2.x86_64
kernel-core-4.18.0-147.8.1.el8_1.x86_64
kernel-core-4.18.0-193.6.3.el8_2.x86_64
kernel-headers-4.18.0-193.6.3.el8_2.x86_64
kernel-modules-4.18.0-147.8.1.el8_1.x86_64
kernel-modules-4.18.0-193.6.3.el8_2.x86_64
kernel-tools-4.18.0-193.6.3.el8_2.x86_64
kernel-tools-libs-4.18.0-193.6.3.el8_2.x86_64
\end{verbatim}

仅保留一个版本的内核，其它旧的内核都删除掉

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf remove }\VariableTok{$(}\ExtensionTok{dnf}\NormalTok{ repoquery }\AttributeTok{{-}{-}installonly} \AttributeTok{{-}{-}latest{-}limit}\OperatorTok{=}\NormalTok{{-}1 }\AttributeTok{{-}q}\VariableTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
模块依赖问题

 问题 1: conflicting requests
  - nothing provides module(perl:5.26) needed by module perl-DBD-MySQL:4.046:8010020191114030811:073fa5fe-0.x86_64
 问题 2: conflicting requests
  - nothing provides module(perl:5.26) needed by module perl-DBI:1.641:8010020191113222731:16b3ab4d-0.x86_64
 问题 3: conflicting requests
  - nothing provides module(perl:5.26) needed by module perl-YAML:1.24:8010020191114031501:a5949e2e-0.x86_64
依赖关系解决。
=======================================================================================================================
 软件包                        架构                  版本                                 仓库                    大小
=======================================================================================================================
移除:
 kernel                        x86_64                4.18.0-147.8.1.el8_1                 @BaseOS                  0  
 kernel-core                   x86_64                4.18.0-147.8.1.el8_1                 @BaseOS                 58 M
 kernel-modules                x86_64                4.18.0-147.8.1.el8_1                 @BaseOS                 20 M

事务概要
=======================================================================================================================
移除  3 软件包

将会释放空间：78 M
确定吗？[y/N]： y
运行事务检查
事务检查成功。
运行事务测试
事务测试成功。
运行事务
  准备中  :                                                                                                        1/1 
  删除    : kernel-4.18.0-147.8.1.el8_1.x86_64                                                                     1/3 
  运行脚本: kernel-4.18.0-147.8.1.el8_1.x86_64                                                                     1/3 
  删除    : kernel-modules-4.18.0-147.8.1.el8_1.x86_64                                                             2/3 
  运行脚本: kernel-modules-4.18.0-147.8.1.el8_1.x86_64                                                             2/3 
  运行脚本: kernel-core-4.18.0-147.8.1.el8_1.x86_64                                                                3/3 
  删除    : kernel-core-4.18.0-147.8.1.el8_1.x86_64                                                                3/3 
  运行脚本: kernel-core-4.18.0-147.8.1.el8_1.x86_64                                                                3/3 
  验证    : kernel-4.18.0-147.8.1.el8_1.x86_64                                                                     1/3 
  验证    : kernel-core-4.18.0-147.8.1.el8_1.x86_64                                                                2/3 
  验证    : kernel-modules-4.18.0-147.8.1.el8_1.x86_64                                                             3/3 

已移除:
  kernel-4.18.0-147.8.1.el8_1.x86_64                          kernel-core-4.18.0-147.8.1.el8_1.x86_64                 
  kernel-modules-4.18.0-147.8.1.el8_1.x86_64                 

完毕！
\end{verbatim}

\href{https://unix.stackexchange.com/questions/587853/centos-8-modular-dependency-problems}{解决上述模块依赖问题的办法} 是重置三个 Perl 模块

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ dnf module reset perl{-}DBD{-}MySQL perl{-}YAML perl{-}DBI}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
依赖关系解决。
=======================================================================================================================
 软件包                      架构                       版本                         仓库                         大小
=======================================================================================================================
重置模块:
 perl-DBD-MySQL                                                                                                       
 perl-DBI                                                                                                             
 perl-YAML                                                                                                            

事务概要
=======================================================================================================================

确定吗？[y/N]： y
完毕！
\end{verbatim}

\hypertarget{subsec-apt-get}{%
\subsection{apt}\label{subsec-apt-get}}

添加或删除 PPA (Personal Package Archive)，比如在 Ubuntu 20.04 及之前的版本上安装\href{https://inkscape.org/release/inkscape-1.0/gnulinux/ubuntu/ppa/dl/}{新版 Inkscape}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository ppa:inkscape.dev/stable}
\FunctionTok{sudo}\NormalTok{ add{-}apt{-}repository }\AttributeTok{{-}{-}remove}\NormalTok{ ppa:inkscape.dev/stable}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install build{-}essential }\CommentTok{\# 修复依赖问题}
\FunctionTok{sudo}\NormalTok{ apt update }\CommentTok{\# 更新资源列表}
\FunctionTok{sudo}\NormalTok{ apt{-}get upgrade }\CommentTok{\# 更新软件包}
\FunctionTok{sudo}\NormalTok{ apt{-}get autoclean }\CommentTok{\# 删除已卸的软件的备份}
\FunctionTok{sudo}\NormalTok{ apt{-}get clean }\CommentTok{\# 删除已装或已卸的软件的备份}
\FunctionTok{sudo}\NormalTok{ apt{-}get autoremove }\AttributeTok{{-}{-}purge} \PreprocessorTok{*} \CommentTok{\# 推荐卸载软件的方式}
\ExtensionTok{apt{-}get}\NormalTok{ list }\AttributeTok{{-}{-}upgradable} \CommentTok{\# 列出可升级的包}
\end{Highlighting}
\end{Shaded}

找到并删除旧的内核

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{dpkg} \AttributeTok{{-}{-}list} \KeywordTok{|} \FunctionTok{grep}\NormalTok{ linux{-}image}
\FunctionTok{sudo}\NormalTok{ apt{-}get purge linux{-}image{-}3.19.0{-}}\DataTypeTok{\{18}\OperatorTok{,}\DataTypeTok{20}\OperatorTok{,}\DataTypeTok{21}\OperatorTok{,}\DataTypeTok{25\}}
\FunctionTok{sudo}\NormalTok{ update{-}grub2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 搜索}
\ExtensionTok{apt{-}cache}\NormalTok{ search octave }\KeywordTok{|} \FunctionTok{grep}\NormalTok{ octave}
\CommentTok{\# 查询}
\ExtensionTok{apt}\NormalTok{ show octave}
\CommentTok{\# 安装}
\FunctionTok{sudo}\NormalTok{ apt install octave}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt{-}get install lsb{-}core}
\ExtensionTok{lsb\_release} \AttributeTok{{-}a}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{adduser}\NormalTok{ cloud2016 }\CommentTok{\# 添加用户}
\FunctionTok{passwd}\NormalTok{ cloud2016  }\CommentTok{\# 用户密码设为 cloud}
\FunctionTok{whereis}\NormalTok{ sudoers   }\CommentTok{\# 查找文件位置}
\FunctionTok{chmod} \AttributeTok{{-}v}\NormalTok{ u+w /etc/sudoers }\CommentTok{\# 给文件 sudoers 添加写权限}
\ExtensionTok{vim}\NormalTok{ /etc/sudoers }\CommentTok{\# 添加 cloud2016 管理员权限}
\FunctionTok{chmod} \AttributeTok{{-}v}\NormalTok{ u{-}w /etc/sudoers }\CommentTok{\# 收回权限}
\end{Highlighting}
\end{Shaded}

安装确认 openssh-server 服务

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sudo}\NormalTok{ apt install openssh{-}server}
\FunctionTok{sudo}\NormalTok{ /etc/init.d/ssh start}
\FunctionTok{ps} \AttributeTok{{-}aux} \KeywordTok{|} \FunctionTok{grep}\NormalTok{ ssh}
\end{Highlighting}
\end{Shaded}

\backmatter
\printindex

  \bibliography{book.bib,packages.bib}

\end{document}
