# 空间数据分析  {#chap-spatial-analysis}


Robert Hijmans 开发的 [terra](https://github.com/rspatial/terra) 用以替代 [raster](https://github.com/rspatial/raster)，提供栅格数据和向量数据处理，基于回归和机器学习方法的空间差值和预测，能够处理相当大的数据集，包括卫星遥感数据，新的 R 包更加简洁、速度更快、功能更强。Edzer Pebesma 创建的 [r-spatial](https://github.com/r-spatial/) 开源组织提供了一系列非常流行的空间分析相关的 R 包，如 [sp](https://edzer.github.io/sp/)、 [sf](https://github.com/r-spatial/sf)、 [stars](https://github.com/r-spatial/stars)、 [mapedit](https://github.com/r-spatial/mapedit) 和[mapview](https://github.com/r-spatial/mapview)。Edzer Pebesma 长期致力于地理信息和空间统计的软件开发，可以说目前已打造了一个生态。

Timothée Giraud 创建的 [riatelab](https://github.com/riatelab/) 组织开发系列 R 包工具，可以绘制各种类型和风格的地图，专题地图工具已经从 [cartography](https://github.com/riatelab/cartography/) 过渡到 [mapsf](https://github.com/riatelab/mapsf)，它更加友好、轻量和稳健。类似的 R 包还有 [choroplethr](https://github.com/trulia/choroplethr)，只是上次更新在 2015 年。

空间数据可视化常常离不开基础地图数据，不同的 R 包依赖的地图服务有所不同，比如
[RgoogleMaps](https://github.com/markusloecher/rgooglemaps)、[ggmap](https://github.com/dkahle/ggmap) 和 [googleway](https://github.com/SymbolixAU/googleway) 主要依赖谷歌的地图数据。
而 [mapdeck](https://github.com/SymbolixAU/mapdeck) 基于 [deck.gl](https://github.com/visgl/deck.gl) 和 [Mapbox](https://github.com/mapbox/mapbox-gl-js) 支持移动和网页应用，GPU 渲染等。[leaflet](https://github.com/rstudio/leaflet) 则基于开源的[Leaflet](https://github.com/Leaflet/Leaflet)库提供交互式空间数据可视化的能力。


[芝加哥大学空间数据科学中心](https://spatial.uchicago.edu/) 开发的 R 包 [rgeoda](https://github.com/GeoDaCenter/rgeoda) 基于开源的 C++ 库[GeoDa](https://github.com/GeoDaCenter/geoda)，提供一系列空间数据分析能力，包括探索性空间数据分析、空间聚类检测和聚类分析。


Edzer Pebesma 和 Roger Bivand 合著的 [Spatial Data Science with applications in R](https://www.r-spatial.org/book)，Christopher K. Wikle, Andrew Zammit-Mangion 和 Noel Cressie 合著的 [Spatio-Temporal Statistics with R](https://spacetimewithr.org/)。推荐学习 Edzer Pebesma 在几届国际 R 语言大会上的材料，2021 年的[R Spatial](https://edzer.github.io/UseR2021/)，2020 年的[Analyzing and visualising spatial and spatiotemporal data cubes Part I](https://edzer.github.io/UseR2020/)，
2019 年的[Spatial workshop part I](https://edzer.github.io/UseR2019/part1.html) 和 [Spatial workshop part II](https://edzer.github.io/UseR2019/part2.html)，
2017 年的[Spatial Data in R: New Directions](https://edzer.github.io/UseR2017/)
2016 年的[Handling and Analyzing Spatial, Spatiotemporal and Movement Data](https://edzer.github.io/UseR2016/)。


[Spatio-Temporal Kriging in R](https://r-video-tutorial.blogspot.com/2015/08/spatio-temporal-kriging-in-r.html)

[Community-based sensing using wireless sensor network technology to monitor air pollution](https://gitlab.ethz.ch/tec/public/opensense)

[sp Gallery](https://edzer.github.io/sp/)

[Introduction to Kriging in R](https://rpubs.com/nabilabd/118172)

Data Scientists: Switch Your Deskop To Linux
https://milesmcbain.micro.blog/2022/04/02/data-scientists-switch.html

useR! 2020: Analyzing & visualising spatial data cubes (E. Pebesma, M. Tennekes), tutorial
https://www.youtube.com/watch?v=eGUjpqkoBCM&t=592s

Geostats: Kriging in R
https://rstudio-pubs-static.s3.amazonaws.com/80464_9156596afb2e4dcda53e3650a68df82a.html

接下来会陆续用到一些 R 包，读者若要复现本文内容，需要先安装和加载。


## Meuse 河洪泛区土壤数据

```{r}
library(gstat)
library(lattice)
library(latticeExtra)
library(rasterVis)
library(grid)
library(sp)
```

### 数据描述

Ruud van Rijn 和 Mathieu Rikken 最初收集了 Stein 村 Meuse 河洪泛区地表土壤重金属浓度数据，Edzer Pebesma 将数据整理打包后做成 **sp** 内置的数据集 meuse。除了几种重金属浓度，还包含土壤、周围环境相关的变量，共 155 个采样点，14 个观测变量，具体情况：

- x 东西方向坐标，单位米，坐标参照系为 RDH（Rijksdriehoek）荷兰地形。 
- y 南北方向坐标，单位米。
- cadmium 表土**镉**浓度，每千克土壤中镉含量（按毫克计），因此，浓度单位为 ppm，若原始数据中镉浓度为 0，则漂移至 0.2，即最小的镉浓度的一半。
- copper 表土**铜**浓度，单位 ppm。
- lead 表土**铅**浓度，单位 ppm。
- zinc 表土**锌**浓度，单位 ppm。
- elev 以当地河床为水平面，相对高度，单位米。
- dist 采样点至 Meuse 河的距离，距离归一化到 0-1 区间。
- om 每100千克土壤中有机质的占比，百分数。
- ffreq 洪水等级，1 表示两年一次，2 表示十年一次，3 表示 五十年一次。
- soil 土壤类型，按照荷兰 1:50000 的土壤图划分，1 表示 Rd10A （钙质弱发育草甸土，轻质砂质粘土），2 表示 Rd90C/VII （非钙质弱发育草甸土，重砂质粘土至轻质粘土），3 表示 Bkd26/VII
（红砖土、细砂质、粉质轻质粘土）。
- landuse 土地利用类别：Aa 农业/未指定 = ，Ab = Agr/糖用甜菜，Ag = Agr/小谷物，Ah = Agr/??，Am = Agr/玉米，B = 树林，Bw = 牧场中的树木，DEN = ?? , Fh = 高果树，Fl = 矮果树； Fw = 牧场果树，Ga = 家庭花园，SPO = 运动场，STA = 马厩，Tv = ?? , W = 牧场。
- dist.m 采样点到 Meuse 河的距离，单位以米计，数据来自实地调查。

最后，数据集 meuse 中的行名 `row.names` 表示原始的采样点的编号。

```{r}
# 河流边界 空间线图
data("meuse.riv", package = "sp")
# 河流面积 多边形图
data("meuse.area", package = "sp")
# 构造空间多边形数据
meuse.riv <- SpatialPolygons(
  list(Polygons(
    list(Polygon(meuse.riv)), "meuse.riv"
  ))
)
# 指定 CRS 坐标参考系
proj4string(meuse.riv) <- sp::CRS("EPSG:28992")
```



```{r}
# 加载数据集
data(meuse.grid) # 来自 sp
data(meuse) # 来自 sp
data(meuse.alt) # 来自 gstat

# 转化为 SpatialPointsDataFrame 类型
# 观测数据
coordinates(meuse) <- ~ x + y
proj4string(meuse) <- sp::CRS("EPSG:28992")
# 采样网格数据
coordinates(meuse.grid) <- ~ x + y
proj4string(meuse.grid) <- sp::CRS("EPSG:28992")
# 海拔
coordinates(meuse.alt) <- ~ x + y
proj4string(meuse.alt) <- sp::CRS("EPSG:28992")

# 转化为 SpatialPixelsDataFram 类型
gridded(meuse.grid) <- TRUE

# 重编码 soil 变量
meuse.grid$soil <- factor(meuse.grid$soil,
  labels = c("A", "B", "C")
)

# soil 1 2 3 编码成 A B C
meuse$soil <- factor(meuse$soil,
  levels = c("1", "2", "3"),
  labels = c("A", "B", "C")
)
```


```{r}
col_pals <- RColorBrewer::brewer.pal(n = 3, name = "Set1")
# 基础图形
spplot(meuse.grid, "soil",
  sp.layout = list("sp.points", meuse,
    cex = 1, pch = c(2, 3, 4)[meuse$soil],
    col = "black"
  ),
  col.regions = col_pals,
  colorkey = FALSE,
  key = list(
    # 制作图例
    space = "top", # 上方居中
    columns = 3,
    points = list(col = "black", pch = c(2, 3, 4)),
    rect = list(col = col_pals),
    text = list(c("A", "B", "C"))
  )
)
```


```{r}
spplot(meuse.grid, "dist",
  sp.layout = list("sp.points", meuse,
    cex = 1,
    pch = c(2, 3, 4)[meuse$soil], col = "black"
  ),
  colorkey = list(space = "bottom", title = "Distance"),
  scales = list(draw = F, cex = 0.5)
)
```


```{r}
sp.grid <- function(obj, col = 1, alpha = 1, ...) {
  if (is.character(obj)) {
    obj <- get(obj)
  }
  xy <- coordinates(obj)
  if (length(col) != 1 && length(col) != nrow(xy)) {
  }
  gt <- as(getGridTopology(obj), "data.frame")
  grid.rect(
    x = xy[, 1], y = xy[, 2], width = gt$cellsize[1],
    height = gt$cellsize[2], default.units = "native",
    gp = gpar(fill = col, col = NA, alpha = alpha)
  )
}

spplot(meuse.grid, "dist",
  sp.layout = list("sp.grid",
    meuse.grid[meuse.grid$soil == "A", ],
    col = "black", alpha = 0.25
  ),
  colorkey = list(
    space = "bottom", width = 1,
    height = 1, tick.number = 5
  )
)
```


## 日本长崎县长崎市


### 地形图

日本海拔地形图，如图\@ref(fig:jpn-map-elevation)

```{r}
#| label: jpn-map-elevation
#| fig.cap: "日本海拔地形图"
#| fig.width: 6
#| fig.height: 6
#| fig.align: "center"
#| message: false
#| fig.showtext: true
# 日本海拔数据
jpn_map_alt <- raster::getData(name = "alt", country = "JPN", mask = TRUE, path = "data/")
# 县级行政区
jpn_map_adm <- raster::getData("GADM", country = "JPN", level = 1, path = "data/")
library(lattice)
library(rasterVis)
# 绘制日本地形
levelplot(jpn_map_alt,
  margin = FALSE,
  main = "日本海拔地形图",
  xlab = "",
  ylab = "",
  colorkey = list(
    space = "right",
    labels = list(at = 500 * 0:6),
    axis.line = list(col = "black")
  ),
  par.settings = list(
    axis.line = list(col = "transparent")
  ),
  panel = function(x, y, ...) {
    panel.levelplot(x, y, ...)
    sp.polygons(jpn_map_adm, lwd = 0.3, col = "gray")
  },
  scales = list(draw = FALSE),
  col.regions = terrain.colors,
  at = 500 * 0:6
)
```

### 气泡图

气泡图展示各个町村的人口数据

```{r}
#| label: nagasaki-city
#| fig.cap: "日本长崎县长崎市地图"
#| fig.width: 6
#| fig.height: 6
#| fig.align: "center"
#| message: false
#| fig.showtext: true

library(sf)
jpn_map <- raster::getData("GADM", country = "JPN", level = 2, path = "data/", type = "sf")
jpn_map <- sf::st_transform(jpn_map, crs = 4326)
# 提取日本长崎县长崎市地图数据
ngk_city_map <- subset(jpn_map, subset = NAME_1 == "Naoasaki" & NAME_2 == "Nagasaki")
plot(ngk_city_map["NAME_2"], axes = T, main = "Nagasaki City")
```


```{r}
#| eval: false
#| echo: false
library(ggplot2)
ggplot(data = ngk_city_map) +
  geom_sf(
    fill = "forestgreen",
    colour = "grey10",
    size = 0.2
  ) +
  theme_minimal()
```


