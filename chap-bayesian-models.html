<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 29 章 贝叶斯模型 | 现代应用统计与 R 语言</title>
<meta name="author" content="黄湘云">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs/header-attrs.js"></script><script src="libs/jquery/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap/bootstrap.bundle.min.js"></script><script src="libs/bs3compat/tabs.js"></script><script src="libs/bs3compat/bs3compat.js"></script><link href="libs/bs4_book/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book/bs4_book.js"></script><script src="libs/htmlwidgets/htmlwidgets.js"></script><script src="libs/plotly-binding/plotly.js"></script><script src="libs/typedarray/typedarray.min.js"></script><link href="libs/crosstalk/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main/plotly-latest.min.js"></script><script src="libs/proj4js/proj4.js"></script><link href="libs/highcharts/css/motion.css" rel="stylesheet">
<script src="libs/highcharts/highcharts.js"></script><script src="libs/highcharts/highcharts-3d.js"></script><script src="libs/highcharts/highcharts-more.js"></script><script src="libs/highcharts/modules/stock.js"></script><script src="libs/highcharts/modules/map.js"></script><script src="libs/highcharts/modules/annotations.js"></script><script src="libs/highcharts/modules/data.js"></script><script src="libs/highcharts/modules/drilldown.js"></script><script src="libs/highcharts/modules/item-series.js"></script><script src="libs/highcharts/modules/offline-exporting.js"></script><script src="libs/highcharts/modules/overlapping-datalabels.js"></script><script src="libs/highcharts/modules/exporting.js"></script><script src="libs/highcharts/modules/export-data.js"></script><script src="libs/highcharts/modules/funnel.js"></script><script src="libs/highcharts/modules/heatmap.js"></script><script src="libs/highcharts/modules/treemap.js"></script><script src="libs/highcharts/modules/sankey.js"></script><script src="libs/highcharts/modules/dependency-wheel.js"></script><script src="libs/highcharts/modules/organization.js"></script><script src="libs/highcharts/modules/solid-gauge.js"></script><script src="libs/highcharts/modules/streamgraph.js"></script><script src="libs/highcharts/modules/sunburst.js"></script><script src="libs/highcharts/modules/vector.js"></script><script src="libs/highcharts/modules/wordcloud.js"></script><script src="libs/highcharts/modules/xrange.js"></script><script src="libs/highcharts/modules/tilemap.js"></script><script src="libs/highcharts/modules/venn.js"></script><script src="libs/highcharts/modules/gantt.js"></script><script src="libs/highcharts/modules/timeline.js"></script><script src="libs/highcharts/modules/parallel-coordinates.js"></script><script src="libs/highcharts/modules/bullet.js"></script><script src="libs/highcharts/modules/coloraxis.js"></script><script src="libs/highcharts/modules/dumbbell.js"></script><script src="libs/highcharts/modules/lollipop.js"></script><script src="libs/highcharts/modules/series-label.js"></script><script src="libs/highcharts/plugins/motion.js"></script><script src="libs/highcharts/custom/reset.js"></script><script src="libs/highcharts/modules/boost.js"></script><script src="libs/highchart-binding/highchart.js"></script><script src="libs/es6shim/es6shim.js"></script><script src="libs/es7shim/es7shim.js"></script><script src="libs/graphre/graphre.js"></script><script src="libs/nomnoml/nomnoml.js"></script><script src="libs/nomnoml-binding/nomnoml.js"></script><script src="libs/plotly-locale-zh-CN/zh-cn.js"></script><script src="libs/mathjax/cdn.js"></script><link href="libs/dygraphs/dygraph.css" rel="stylesheet">
<script src="libs/dygraphs/dygraph-combined.js"></script><script src="libs/dygraphs/shapes.js"></script><script src="libs/moment/moment.js"></script><script src="libs/moment-timezone/moment-timezone-with-data.js"></script><script src="libs/moment-fquarter/moment-fquarter.min.js"></script><script src="libs/dygraphs-binding/dygraphs.js"></script><script src="libs/Dygraph.Plugins.Unzoom/unzoom.js"></script><script src="libs/echarts4r/echarts-en.min.js"></script><script src="libs/echarts4r/ecStat.min.js"></script><script src="libs/echarts4r/dataTool.min.js"></script><script src="libs/echarts4r-binding/echarts4r.js"></script><script src="libs/echarts-world/world.js"></script><script src="libs/d3/d3.min.js"></script><script src="libs/forceNetwork-binding/forceNetwork.js"></script><link href="libs/vis/vis.css" rel="stylesheet">
<script src="libs/vis/vis.min.js"></script><script src="libs/visNetwork-binding/visNetwork.js"></script><script src="libs/FileSaver/FileSaver.min.js"></script><script src="libs/Blob/Blob.js"></script><script src="libs/canvas-toBlob/canvas-toBlob.js"></script><script src="libs/html2canvas/html2canvas.js"></script><script src="libs/jspdf/jspdf.debug.js"></script><link href="libs/jquery-sparkline/jquery.sparkline.css" rel="stylesheet">
<script src="libs/jquery-sparkline/jquery.sparkline.js"></script><script src="libs/sparkline-binding/sparkline.js"></script><script src="libs/r2d3-render/r2d3-render.js"></script><script src="libs/webcomponents/webcomponents.js"></script><script src="libs/r2d3-binding/r2d3.js"></script><script src="libs/d3v6/d3.min.js"></script><link href="libs/datatables-css/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding/datatables.js"></script><link href="libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core/js/jquery.dataTables.min.js"></script><script src="libs/jszip/jszip.min.js"></script><script src="libs/pdfmake/pdfmake.js"></script><script src="libs/pdfmake/vfs_fonts.js"></script><link href="libs/dt-ext-buttons/css/buttons.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-buttons/js/dataTables.buttons.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.flash.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.html5.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.colVis.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.print.min.js"></script><link href="libs/dt-ext-rowgroup/css/rowGroup.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-rowgroup/js/dataTables.rowGroup.min.js"></script><script src="libs/kePrint/kePrint.js"></script><link href="libs/lightable/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-54GQKWF7VP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-54GQKWF7VP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">现代应用统计与 R 语言</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">欢迎</a></li>
<li><a class="" href="chap-preface.html"><span class="header-section-number">1</span> 前言</a></li>
<li><a class="" href="chap-notations.html"><span class="header-section-number">2</span> 符号说明</a></li>
<li><a class="" href="chap-file-operations.html"><span class="header-section-number">3</span> 文件操作</a></li>
<li><a class="" href="chap-data-structure.html"><span class="header-section-number">4</span> 数据结构</a></li>
<li><a class="" href="chap-data-manipulation.html"><span class="header-section-number">5</span> 数据操作</a></li>
<li><a class="" href="chap-data-transportation.html"><span class="header-section-number">6</span> 数据搬运</a></li>
<li><a class="" href="chap-graphics-foundations.html"><span class="header-section-number">7</span> 图形基础</a></li>
<li><a class="" href="chap-data-visualization.html"><span class="header-section-number">8</span> 数据可视化</a></li>
<li><a class="" href="chap-dynamic-documents.html"><span class="header-section-number">9</span> 动态文档</a></li>
<li><a class="" href="chap-interactive-web-graphics.html"><span class="header-section-number">10</span> 交互图形</a></li>
<li><a class="" href="chap-interactive-data-tables.html"><span class="header-section-number">11</span> 交互表格</a></li>
<li><a class="" href="chap-interactive-shiny-app.html"><span class="header-section-number">12</span> 交互报表</a></li>
<li><a class="" href="chap-string-operations.html"><span class="header-section-number">13</span> 字符串操作</a></li>
<li><a class="" href="chap-regular-expressions.html"><span class="header-section-number">14</span> 正则表达式</a></li>
<li><a class="" href="chap-text-analysis.html"><span class="header-section-number">15</span> 文本分析</a></li>
<li><a class="" href="chap-sampling-distributions.html"><span class="header-section-number">16</span> 抽样分布</a></li>
<li><a class="" href="chap-parameter-estimators.html"><span class="header-section-number">17</span> 参数估计</a></li>
<li><a class="" href="chap-hypothesis-test.html"><span class="header-section-number">18</span> 假设检验</a></li>
<li><a class="" href="chap-power-Analysis.html"><span class="header-section-number">19</span> 功效分析</a></li>
<li><a class="" href="chap-experimental-design.html"><span class="header-section-number">20</span> 试验设计</a></li>
<li><a class="" href="chap-linear-models.html"><span class="header-section-number">21</span> 线性模型</a></li>
<li><a class="" href="chap-generalized-linear-models.html"><span class="header-section-number">22</span> 广义线性模型</a></li>
<li><a class="" href="chap-case-study.html"><span class="header-section-number">23</span> 案例研究</a></li>
<li><a class="" href="chap-data-explorer.html"><span class="header-section-number">24</span> 数据探索</a></li>
<li><a class="" href="chap-survival-analysis.html"><span class="header-section-number">25</span> 生存分析</a></li>
<li><a class="" href="chap-time-series-analysis.html"><span class="header-section-number">26</span> 时序分析</a></li>
<li><a class="" href="chap-spatial-analysis.html"><span class="header-section-number">27</span> 空间分析</a></li>
<li><a class="" href="chap-spatial-modeling.html"><span class="header-section-number">28</span> 空间建模</a></li>
<li><a class="active" href="chap-bayesian-models.html"><span class="header-section-number">29</span> 贝叶斯模型</a></li>
<li><a class="" href="chap-gradient-boosting-machine.html"><span class="header-section-number">30</span> 梯度提升机</a></li>
<li><a class="" href="chap-neural-network.html"><span class="header-section-number">31</span> 神经网络</a></li>
<li><a class="" href="chap-matrix-operations.html"><span class="header-section-number">32</span> 矩阵运算</a></li>
<li><a class="" href="chap-symbolic-computation.html"><span class="header-section-number">33</span> 符号计算</a></li>
<li><a class="" href="chap-numerical-optimization.html"><span class="header-section-number">34</span> 数值优化</a></li>
<li class="book-part">附录</li>
<li><a class="" href="chap-linux-command-bash.html"><span class="header-section-number">A</span> 命令行操作</a></li>
<li><a class="" href="chap-other-softwares.html"><span class="header-section-number">B</span> 其它软件</a></li>
<li><a class="" href="chap-mixed-programming.html"><span class="header-section-number">C</span> 混合编程</a></li>
<li><a class="" href="chap-object-oriented-programming.html"><span class="header-section-number">D</span> 面向对象编程</a></li>
<li><a class="" href="references.html">参考文献</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/XiangyunHuang/masr">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-bayesian-models" class="section level1" number="29">
<h1>
<span class="header-section-number">第 29 章</span> 贝叶斯模型<a class="anchor" aria-label="anchor" href="#chap-bayesian-models"><i class="fas fa-link"></i></a>
</h1>
<p><a href="https://github.com/LaplacesDemonR/LaplacesDemon">LaplacesDemon</a> 支持常见模型的贝叶斯推断，具体可见<a href="https://CRAN.R-project.org/package=LaplacesDemon">网站</a> <span class="citation"><a href="references.html#ref-LaplacesDemon2021" role="doc-biblioref">[86]</a></span>，<a href="https://github.com/stan-dev/shinystan">shinystan</a> 借助 <a href="https://github.com/stan-dev/rstan">rstan</a> 打包了一些 stan 编写的统计模型，提供模型评估的功能。相比于 <a href="https://github.com/stan-dev/rstan">rstan</a>，<a href="https://github.com/paul-buerkner/brms">brms</a> 支持了更加广泛的模型，<a href="https://github.com/fweber144/shinybrms">shinybrms</a> 类似 <a href="https://github.com/stan-dev/shinystan">shinystan</a> 提供可视化的 shiny 前端，方便用户调用模型和评估效果。<a href="https://github.com/stan-dev/rstanarm">rstanarm</a> 基于 stan 语言重写了 <a href="https://github.com/suyusung/arm">arm</a> 里的模型，和 <a href="https://github.com/paul-buerkner/brms">brms</a> 一样，提供类似 <a href="https://github.com/lme4/lme4">lme4</a> 的公式语法，和 Base R 内置的函数 <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> 和 <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> 保持一致，降低用户学习成本。</p>
<p><a href="https://github.com/stan-dev/cmdstanr">cmdstanr</a> 相比于 rstan 将会更加轻量，更快地将 CmdStan 的新功能融入进来，方便用户滚动升级，相比于 <strong>rstan</strong> 包，<strong>cmdstanr</strong> 包的一个巨大优势是和 Stan 软件的更新分离。做贝叶斯计算的软件框架还包括 JAGS 和 WinBUGS，苏毓松开发的 R2jags 包 <span class="citation"><a href="references.html#ref-R2jags" role="doc-biblioref">[87]</a></span> 是 JAGS 的 R 接口。</p>
<p><a href="https://github.com/kaskr/adcomp">TMB</a></p>
<ul>
<li><p>书籍：
<a href="https://xcelab.net/rm/">Richard McElreath</a> 为《Statistical Rethinking》写的 <a href="https://github.com/rmcelreath/rethinking">rethinking</a> 包，参考 Derek S. Young <span class="citation"><a href="references.html#ref-Regression_2017_Young" role="doc-biblioref">[88]</a></span> 和 Michael H. Kutner 等 <span class="citation"><a href="references.html#ref-Kutner_2005_Applied" role="doc-biblioref">[89]</a></span></p></li>
<li><p>论文：
An Introduction to Inductive Statistical Inference: from Parameter Estimation to Decision-Making <a href="https://arxiv.org/abs/1808.10173v2" class="uri">https://arxiv.org/abs/1808.10173v2</a> 固定效应/随机效应广义线性模型：多水平各种模型回归，模型结构和 Stan 代码</p></li>
<li><p>课程：
线性模型的内容主要分为四大块，分别是线性回归模型、方差分析模型、协方差分析模型和线性混合效应模型。国外 David Pollard 的线性模型 <a href="http://www.stat.yale.edu/~pollard/Courses/312.fall2016/">课程内容</a></p></li>
<li><p>会议：
Paul-Christian Bürkner 在 Stan 大会上介绍 brms 和 rstanarm <a href="https://github.com/InsuranceDataScience/StanWorkshop2018" class="uri">https://github.com/InsuranceDataScience/StanWorkshop2018</a></p></li>
</ul>
<div id="sec-stan-setup" class="section level2" number="29.1">
<h2>
<span class="header-section-number">29.1</span> 软件配置<a class="anchor" aria-label="anchor" href="#sec-stan-setup"><i class="fas fa-link"></i></a>
</h2>
<p>从 GitHub 下载最新版的源码包 <a href="https://github.com/stan-dev/cmdstan/releases/latest" class="uri">https://github.com/stan-dev/cmdstan/releases/latest</a>，编译二进制版本</p>
<div class="sourceCode" id="cb2228"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2228-1"><a href="chap-bayesian-models.html#cb2228-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xzf</span> /Users/xiangyun/Desktop/cmdstan-2.26.0.tar.gz <span class="at">-C</span> /opt/</span>
<span id="cb2228-2"><a href="chap-bayesian-models.html#cb2228-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> cmdstan-2.26.0</span>
<span id="cb2228-3"><a href="chap-bayesian-models.html#cb2228-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> build</span></code></pre></div>
<p>设置环境变量 CMDSTAN 指向 CmdStan 安装路径，加载 <strong>cmdstanr</strong> 包会自动检测和加载</p>
<div class="sourceCode" id="cb2229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>CMDSTAN<span class="op">=</span><span class="st">"/opt/cmdstan-2.26.0"</span><span class="op">)</span></code></pre></div>
<p>还可以设置环境变量 <code>CMDSTANR_NO_VER_CHECK=TRUE</code>，让 cmdstanr 不要检查 CmdStan 版本状态，是不是最新版，比如本书将固定下 CmdStan 版本为 2.26.0</p>
<p><strong>cmdstanr</strong> 当前还在开发中，安装方式如下</p>
<div class="sourceCode" id="cb2230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">'stan-dev/cmdstanr'</span><span class="op">)</span>
<span class="co"># 或者</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"cmdstanr"</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"https://mc-stan.org/r-packages/"</span>, <span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"repos"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>另有一篇博文介绍在 <a href="https://www.maxmantei.com/blog/2020-05-16-installing-cmdstanr-on-windows/cmdstanr-windows/">Windows 系统上安装 cmdstanr</a> 的过程，这里不做展开。</p>
<div class="sourceCode" id="cb2231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># rstan</span>
<span class="co"># brms</span>
<span class="co"># rstanarm</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">'rmcelreath/rethinking'</span><span class="op">)</span></code></pre></div>
</div>
<div id="sec-bayesian-normal-distribution" class="section level2" number="29.2">
<h2>
<span class="header-section-number">29.2</span> 正态分布<a class="anchor" aria-label="anchor" href="#sec-bayesian-normal-distribution"><i class="fas fa-link"></i></a>
</h2>
<p>我们以估计正态分布参数为例说明贝叶斯估计方法</p>
<p><span class="math display">\[Y \sim \mathcal{N}(\mu,\sigma^2)\]</span>
已知 <span class="math inline">\(y_1,y_2,\ldots,y_n\)</span> 是来自正态总体 <span class="math inline">\(\mathcal{N}(\mu,\sigma^2)\)</span> 的一个样本，我们需要估计这个正态分布模型的参数 <span class="math inline">\(\mu\)</span> 和 <span class="math inline">\(\sigma^2\)</span>。</p>
<p>最大似然估计，简单推导过程，计算代码；再讲 stan 的计算步骤</p>
<div class="sourceCode" id="cb2232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/cmdstanr">cmdstanr</a></span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html">cmdstan_model</a></span><span class="op">(</span>stan_file <span class="op">=</span> <span class="st">"code/normal_dist.stan"</span>, compile <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>打包观测数据，初始化待估参数值，指定链条数，其中 <code>dataList</code> 必须与 stan 代码中数据块声明保持一致（如变量名称，长度），每条链使用不同的初始值，选择合适的初始值可以有效地提高收敛的速度。</p>
<div class="sourceCode" id="cb2233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 数据准备</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">20190427</span><span class="op">)</span>
<span class="co"># 设置参数</span>
<span class="va">mu</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">sd</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="co"># 样本量</span>
<span class="va">nobs</span> <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="co"># 生成随机数</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">nobs</span>, mean <span class="op">=</span> <span class="va">mu</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>
<span class="co"># 给每条链设置不同的参数初始值</span>
<span class="va">inits_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nchains</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/summarize-generics.html">min</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/summarize-generics.html">max</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,
    sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>将参数初值代入模型，抽样，获取参数的后验分布</p>
<div class="sourceCode" id="cb2234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">normal_fit</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>
  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    N <span class="op">=</span> <span class="va">nobs</span>,
    y <span class="op">=</span> <span class="va">y</span>
  <span class="op">)</span>,
  init <span class="op">=</span> <span class="va">inits_data</span>,
  iter_warmup <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># 每条链预处理迭代次数</span>
  iter_sampling <span class="op">=</span> <span class="fl">2000</span>, <span class="co"># 每条链总迭代次数</span>
  chains <span class="op">=</span> <span class="va">nchains</span>, <span class="co"># 马尔科夫链的数目</span>
  parallel_chains <span class="op">=</span> <span class="fl">1</span>, <span class="co"># 指定 CPU 核心数，可以给每条链分配一个</span>
  show_messages <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># 不显示迭代的中间过程</span>
  refresh <span class="op">=</span> <span class="fl">0</span>, <span class="co"># 不显示采样的进度</span>
  seed <span class="op">=</span> <span class="fl">20190425</span> <span class="co"># 设置随机数种子，不要使用 set.seed() 函数</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Running MCMC with 4 sequential chains...
## 
## Chain 1 finished in 0.1 seconds.
## Chain 2 finished in 0.1 seconds.
## Chain 3 finished in 0.1 seconds.
## Chain 4 finished in 0.1 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 0.1 seconds.
## Total execution time: 0.8 seconds.</code></pre>
<p>检查收敛性，Rhat 决定收敛性，所有待估参数的Rhat必须小于1.1，同时有效样本数量 n_eff 除以抽样总数 N 必须小于0.001，否则收敛性是值得怀疑的。拟合结果及解释如下：</p>
<div class="sourceCode" id="cb2236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 模型参数估计结果</span>
<span class="va">normal_fit</span><span class="op">$</span><span class="fu">cmdstan_summary</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: normal_dist_model
## 4 chains: each with iter=(2000,2000,2000,2000); warmup=(0,0,0,0); thin=(1,1,1,1); 8000 iterations saved.
## 
## Warmup took (0.018, 0.019, 0.018, 0.017) seconds, 0.072 seconds total
## Sampling took (0.059, 0.055, 0.048, 0.049) seconds, 0.21 seconds total
## 
##                 Mean     MCSE  StdDev    5%   50%  95%    N_Eff  N_Eff/s    R_hat
## 
## lp__            -602  1.7e-02     1.0  -604  -601 -601     3591    17020      1.0
## accept_stat__   0.92  3.3e-03    0.11  0.69  0.96  1.0  1.1e+03  5.0e+03  1.0e+00
## stepsize__      0.88  6.9e-02   0.098  0.73  0.90  1.0  2.0e+00  9.5e+00  1.5e+13
## treedepth__      1.9  1.2e-01    0.56   1.0   2.0  3.0  2.1e+01  1.0e+02  1.1e+00
## n_leapfrog__     3.7  3.7e-01     1.8   1.0   3.0  7.0  2.4e+01  1.1e+02  1.0e+00
## divergent__     0.00      nan    0.00  0.00  0.00 0.00      nan      nan      nan
## energy__         603  2.5e-02     1.4   601   602  605  3.3e+03  1.6e+04  1.0e+00
## 
## mu                10  1.2e-03   0.092   9.9    10   10     5732    27166     1.00
## sigma            2.0  7.7e-04   0.064   1.9   2.0  2.1     6885    32630     1.00
## 
## Samples were drawn using hmc with nuts.
## For each parameter, N_Eff is a crude measure of effective sample size,
## and R_hat is the potential scale reduction factor on split chains (at 
## convergence, R_hat=1).</code></pre>
<p>调用 draws 方法 <code>normal_fit$draws()</code>，获得一个由 <strong>posterior</strong> 构造的 <code>draws_array</code> 对象，</p>
<div class="sourceCode" id="cb2238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">draws_array</span> <span class="op">&lt;-</span> <span class="va">normal_fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">draws_array</span><span class="op">)</span></code></pre></div>
<pre><code>##  'draws_array' num [1:2000, 1:4, 1:3] -601 -601 -602 -601 -601 ...
##  - attr(*, "dimnames")=List of 3
##   ..$ iteration: chr [1:2000] "1" "2" "3" "4" ...
##   ..$ chain    : chr [1:4] "1" "2" "3" "4"
##   ..$ variable : chr [1:3] "lp__" "mu" "sigma"</code></pre>
<p>采样结果可以直接传递给 <strong>bayesplot</strong> 包，绘制参数的后验分布和马尔科夫链蒙特卡罗采样的轨迹图（trace plot）。</p>
<div class="sourceCode" id="cb2240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/">bayesplot</a></span><span class="op">)</span>
<span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html">mcmc_trace</a></span><span class="op">(</span><span class="va">normal_fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html">mcmc_hist</a></span><span class="op">(</span><span class="va">normal_fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:mu-sigma-dist"></span>
<img src="bayesian-models_files/figure-html/mu-sigma-dist-1.png" alt="参数 \(\mu, \sigma\) 的迭代轨迹图和后验分布图" width="768"><img src="bayesian-models_files/figure-html/mu-sigma-dist-2.png" alt="参数 \(\mu, \sigma\) 的迭代轨迹图和后验分布图" width="768"><p class="caption">
图 29.1: 参数 <span class="math inline">\(\mu, \sigma\)</span> 的迭代轨迹图和后验分布图
</p>
</div>

</div>
<div id="sec-gaussian-process" class="section level2" number="29.3">
<h2>
<span class="header-section-number">29.3</span> 高斯过程<a class="anchor" aria-label="anchor" href="#sec-gaussian-process"><i class="fas fa-link"></i></a>
</h2>
<p>模拟高斯过程例子来自 Stan 参考手册 <span class="citation"><a href="references.html#ref-Stan_2018_Bayesian" role="doc-biblioref">[90]</a></span></p>
<div class="sourceCode" id="cb2241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html">cmdstan_model</a></span><span class="op">(</span>stan_file <span class="op">=</span> <span class="st">"code/normal_gp.stan"</span><span class="op">)</span></code></pre></div>
<p>stan 库内置了核函数为二次幂指数的实现，因此可以直接调用 <code>cov_exp_quad</code> 函数计算协方差矩阵</p>
<div class="sourceCode" id="cb2242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html">cmdstan_model</a></span><span class="op">(</span>stan_file <span class="op">=</span> <span class="st">"code/compat_gp.stan"</span><span class="op">)</span></code></pre></div>
<p>以 MASS 的 topo 数据集引出高斯过程回归模型问题复杂性</p>
</div>
<div id="sec-hierarchical-normal-models" class="section level2" number="29.4">
<h2>
<span class="header-section-number">29.4</span> 分层正态模型<a class="anchor" aria-label="anchor" href="#sec-hierarchical-normal-models"><i class="fas fa-link"></i></a>
</h2>
<p>Multilevel Models 多水平模型、Hierarchical Models 层次模型</p>
<div id="sec-eight-schools" class="section level3" number="29.4.1">
<h3>
<span class="header-section-number">29.4.1</span> schools 数据<a class="anchor" aria-label="anchor" href="#sec-eight-schools"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb2243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 模型编译</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html">cmdstan_model</a></span><span class="op">(</span>stan_file <span class="op">=</span> <span class="st">"code/eight_schools.stan"</span><span class="op">)</span>

<span class="co"># 模型拟合</span>
<span class="va">eight_schools_fit</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>
  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="co"># 观测数据</span>
    J <span class="op">=</span> <span class="fl">8</span>,
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">8</span>, <span class="op">-</span><span class="fl">3</span>, <span class="fl">7</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">18</span>, <span class="fl">12</span><span class="op">)</span>,
    sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">10</span>, <span class="fl">16</span>, <span class="fl">11</span>, <span class="fl">9</span>, <span class="fl">11</span>, <span class="fl">10</span>, <span class="fl">18</span><span class="op">)</span>
  <span class="op">)</span>,
  iter_warmup <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># 每条链预处理迭代次数</span>
  iter_sampling <span class="op">=</span> <span class="fl">2000</span>, <span class="co"># 每条链总迭代次数</span>
  chains <span class="op">=</span> <span class="fl">4</span>, <span class="co"># 马尔科夫链的数目</span>
  parallel_chains <span class="op">=</span> <span class="fl">1</span>, <span class="co"># 指定 CPU 核心数，可以给每条链分配一个</span>
  show_messages <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># 不显示迭代的中间过程</span>
  refresh <span class="op">=</span> <span class="fl">0</span>, <span class="co"># 不显示采样的进度</span>
  seed <span class="op">=</span> <span class="fl">20190425</span> <span class="co"># 设置随机数种子，不要使用 set.seed() 函数</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Running MCMC with 4 sequential chains...
## 
## Chain 1 finished in 0.1 seconds.
## Chain 2 finished in 0.2 seconds.
## Chain 3 finished in 0.2 seconds.
## Chain 4 finished in 0.2 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 0.2 seconds.
## Total execution time: 0.9 seconds.</code></pre>
<p>模型拟合结果</p>
<div class="sourceCode" id="cb2245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eight_schools_fit</span><span class="op">$</span><span class="fu">cmdstan_summary</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: eight_schools_model
## 4 chains: each with iter=(2000,2000,2000,2000); warmup=(0,0,0,0); thin=(1,1,1,1); 8000 iterations saved.
## 
## Warmup took (0.029, 0.035, 0.029, 0.037) seconds, 0.13 seconds total
## Sampling took (0.10, 0.13, 0.12, 0.12) seconds, 0.47 seconds total
## 
##                     Mean     MCSE  StdDev     5%       50%   95%    N_Eff  N_Eff/s    R_hat
## 
## lp__            -4.0e+01  5.4e-02     2.7    -44  -3.9e+01   -36     2447     5185     1.00
## accept_stat__       0.88  1.5e-02    0.20   0.40      0.96   1.0  1.8e+02  3.9e+02  1.0e+00
## stepsize__          0.34  3.2e-02   0.045   0.28      0.33  0.41  2.0e+00  4.2e+00  1.8e+13
## treedepth__          3.5  1.8e-01    0.54    3.0       4.0   4.0  8.4e+00  1.8e+01  1.1e+00
## n_leapfrog__          12  1.3e+00     4.0    7.0        15    15  9.9e+00  2.1e+01  1.1e+00
## divergent__         0.00      nan    0.00   0.00      0.00  0.00      nan      nan      nan
## energy__              45  7.2e-02     3.5     39        44    51  2.4e+03  5.1e+03  1.0e+00
## 
## mu               8.0e+00  8.1e-02     5.0  0.015   7.9e+00    17     3886     8233      1.0
## tau              6.6e+00  1.0e-01     5.6   0.48   5.3e+00    17     3064     6492      1.0
## eta[1]           3.9e-01  1.1e-02    0.95   -1.2   4.2e-01   1.9     7716    16347     1.00
## eta[2]          -4.0e-04  9.5e-03    0.88   -1.4   2.1e-04   1.4     8427    17853     1.00
## eta[3]          -2.0e-01  1.0e-02    0.94   -1.7  -2.0e-01   1.4     8319    17626      1.0
## eta[4]          -3.0e-02  9.7e-03    0.88   -1.5  -2.8e-02   1.4     8220    17415      1.0
## eta[5]          -3.7e-01  1.0e-02    0.88   -1.8  -3.9e-01   1.1     7355    15583      1.0
## eta[6]          -2.2e-01  9.8e-03    0.90   -1.7  -2.5e-01   1.3     8439    17879      1.0
## eta[7]           3.5e-01  1.0e-02    0.88   -1.1   3.7e-01   1.8     7255    15370      1.0
## eta[8]           5.4e-02  1.1e-02    0.93   -1.5   6.6e-02   1.6     7356    15584     1.00
## theta[1]         1.1e+01  1.1e-01     8.4   0.10   1.0e+01    27     5668    12008     1.00
## theta[2]         7.9e+00  6.8e-02     6.4   -2.5   7.9e+00    18     8940    18941      1.0
## theta[3]         6.2e+00  9.3e-02     7.7   -7.5   6.6e+00    18     6961    14747      1.0
## theta[4]         7.7e+00  7.1e-02     6.5   -3.0   7.7e+00    18     8515    18041      1.0
## theta[5]         5.0e+00  7.0e-02     6.4   -6.4   5.5e+00    14     8218    17410      1.0
## theta[6]         6.1e+00  7.3e-02     6.7   -5.7   6.5e+00    16     8504    18016     1.00
## theta[7]         1.1e+01  8.4e-02     6.8   0.92   1.0e+01    23     6537    13849     1.00
## theta[8]         8.5e+00  1.0e-01     7.8   -3.8   8.2e+00    22     5904    12507      1.0
## 
## Samples were drawn using hmc with nuts.
## For each parameter, N_Eff is a crude measure of effective sample size,
## and R_hat is the potential scale reduction factor on split chains (at 
## convergence, R_hat=1).</code></pre>
<p>4 条马尔可夫链，19 个变量，2000 次迭代，轨迹数据如下</p>
<div class="sourceCode" id="cb2247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eight_schools_fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A draws_array: 2000 iterations, 4 chains, and 19 variables
## , , variable = lp__
## 
##          chain
## iteration   1   2   3   4
##         1 -42 -39 -38 -40
##         2 -37 -40 -37 -42
##         3 -40 -38 -38 -43
##         4 -39 -39 -40 -43
##         5 -38 -45 -38 -40
## 
## , , variable = mu
## 
##          chain
## iteration    1      2    3    4
##         1  9.0 -3.696  8.9  1.9
##         2  5.9 13.895  1.5 13.5
##         3  6.2  0.013  4.2  1.5
##         4 12.0  2.365 10.6 15.5
##         5  5.8 -7.633  5.2 12.2
## 
## , , variable = tau
## 
##          chain
## iteration    1    2     3     4
##         1 3.20 10.3  7.93  4.11
##         2 9.70  1.9 10.70  0.65
##         3 0.38  6.3  4.31  1.18
##         4 7.19  9.2  0.43 11.03
##         5 4.06  5.6  3.36  8.74
## 
## , , variable = eta[1]
## 
##          chain
## iteration     1     2     3     4
##         1  1.10  1.72  1.23  1.10
##         2 -0.30 -0.98  1.19 -0.74
##         3 -0.31  1.28  0.34 -0.85
##         4  0.97  1.53 -0.86  2.02
##         5  1.04  0.75  1.46  1.24
## 
## # ... with 1995 more iterations, and 15 more variables</code></pre>
<p>提取参数 <span class="math inline">\(\mu\)</span> 的四条迭代点列</p>
<div class="sourceCode" id="cb2249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eight_schools_fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="st">"mu"</span><span class="op">)</span></code></pre></div>
<pre><code>## # A draws_array: 2000 iterations, 4 chains, and 1 variables
## , , variable = mu
## 
##          chain
## iteration    1      2    3    4
##         1  9.0 -3.696  8.9  1.9
##         2  5.9 13.895  1.5 13.5
##         3  6.2  0.013  4.2  1.5
##         4 12.0  2.365 10.6 15.5
##         5  5.8 -7.633  5.2 12.2
## 
## # ... with 1995 more iterations</code></pre>
<p><code>eight_schools_fit</code> 是一个 R6 对象，包含整个模型信息</p>
<div class="sourceCode" id="cb2251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">eight_schools_fit</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "CmdStanMCMC" "CmdStanFit"  "R6"</code></pre>
<div class="sourceCode" id="cb2253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">eight_schools_fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Classes 'CmdStanMCMC', 'CmdStanFit', 'R6' &lt;CmdStanMCMC&gt;
##   Inherits from: &lt;CmdStanFit&gt;
##   Public:
##     clone: function (deep = FALSE) 
##     cmdstan_diagnose: function () 
##     cmdstan_summary: function (flags = NULL) 
##     data_file: function () 
##     draws: function (variables = NULL, inc_warmup = FALSE, format = getOption("cmdstanr_draws_format", 
##     init: function () 
##     initialize: function (runset) 
##     inv_metric: function (matrix = TRUE) 
##     latent_dynamics_files: function (include_failed = FALSE) 
##     loo: function (variables = "log_lik", r_eff = TRUE, ...) 
##     lp: function () 
##     metadata: function () 
##     num_chains: function () 
##     num_procs: function () 
##     output: function (id = NULL) 
##     output_files: function (include_failed = FALSE) 
##     print: function (variables = NULL, ..., digits = 2, max_rows = getOption("cmdstanr_max_rows", 
##     profile_files: function (include_failed = FALSE) 
##     profiles: function () 
##     return_codes: function () 
##     runset: CmdStanRun, R6
##     sampler_diagnostics: function (inc_warmup = FALSE, format = getOption("cmdstanr_draws_format", 
##     save_data_file: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
##     save_latent_dynamics_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
##     save_object: function (file, ...) 
##     save_output_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
##     save_profile_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
##     summary: function (variables = NULL, ...) 
##     time: function () 
##   Private:
##     draws_: -42.0125 -37.337 -40.2068 -38.9824 -38.4394 -38.7721 -35 ...
##     init_: NULL
##     inv_metric_: list
##     metadata_: list
##     read_csv_: function (variables = NULL, sampler_diagnostics = NULL, format = getOption("cmdstanr_draws_format", 
##     sampler_diagnostics_: 3 3 4 3 4 3 3 3 3 3 2 3 3 3 3 3 4 3 3 3 3 2 3 3 3 3 3 3  ...
##     warmup_draws_: NULL
##     warmup_sampler_diagnostics_: NULL</code></pre>
<p>模型诊断：查看迭代点列的平稳性</p>
<div class="sourceCode" id="cb2255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html">mcmc_dens</a></span><span class="op">(</span><span class="va">eight_schools_fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"mu"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bayesian-models_files/figure-html/mu-iteration-1.png" width="672" style="display: block; margin: auto;"></div>
<p>分层线性模型之生长曲线模型 <span class="citation"><a href="references.html#ref-Gelfand_1990_JASA" role="doc-biblioref">[91]</a></span></p>
</div>
<div id="subsec-rats" class="section level3" number="29.4.2">
<h3>
<span class="header-section-number">29.4.2</span> rats 数据<a class="anchor" aria-label="anchor" href="#subsec-rats"><i class="fas fa-link"></i></a>
</h3>
<p>贝叶斯分层图</p>
<div class="sourceCode" id="cb2256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 数据准备</span>
<span class="co"># modified code from https://github.com/stan-dev/example-models/tree/master/bugs_examples/vol1/rats</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">30</span>
<span class="cn">T</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span>
  <span class="fl">151</span>, <span class="fl">145</span>, <span class="fl">147</span>, <span class="fl">155</span>, <span class="fl">135</span>, <span class="fl">159</span>, <span class="fl">141</span>, <span class="fl">159</span>, <span class="fl">177</span>, <span class="fl">134</span>,
  <span class="fl">160</span>, <span class="fl">143</span>, <span class="fl">154</span>, <span class="fl">171</span>, <span class="fl">163</span>, <span class="fl">160</span>, <span class="fl">142</span>, <span class="fl">156</span>, <span class="fl">157</span>, <span class="fl">152</span>, <span class="fl">154</span>, <span class="fl">139</span>, <span class="fl">146</span>,
  <span class="fl">157</span>, <span class="fl">132</span>, <span class="fl">160</span>, <span class="fl">169</span>, <span class="fl">157</span>, <span class="fl">137</span>, <span class="fl">153</span>, <span class="fl">199</span>, <span class="fl">199</span>, <span class="fl">214</span>, <span class="fl">200</span>, <span class="fl">188</span>, <span class="fl">210</span>,
  <span class="fl">189</span>, <span class="fl">201</span>, <span class="fl">236</span>, <span class="fl">182</span>, <span class="fl">208</span>, <span class="fl">188</span>, <span class="fl">200</span>, <span class="fl">221</span>, <span class="fl">216</span>, <span class="fl">207</span>, <span class="fl">187</span>, <span class="fl">203</span>, <span class="fl">212</span>,
  <span class="fl">203</span>, <span class="fl">205</span>, <span class="fl">190</span>, <span class="fl">191</span>, <span class="fl">211</span>, <span class="fl">185</span>, <span class="fl">207</span>, <span class="fl">216</span>, <span class="fl">205</span>, <span class="fl">180</span>, <span class="fl">200</span>, <span class="fl">246</span>, <span class="fl">249</span>,
  <span class="fl">263</span>, <span class="fl">237</span>, <span class="fl">230</span>, <span class="fl">252</span>, <span class="fl">231</span>, <span class="fl">248</span>, <span class="fl">285</span>, <span class="fl">220</span>, <span class="fl">261</span>, <span class="fl">220</span>, <span class="fl">244</span>, <span class="fl">270</span>, <span class="fl">242</span>,
  <span class="fl">248</span>, <span class="fl">234</span>, <span class="fl">243</span>, <span class="fl">259</span>, <span class="fl">246</span>, <span class="fl">253</span>, <span class="fl">225</span>, <span class="fl">229</span>, <span class="fl">250</span>, <span class="fl">237</span>, <span class="fl">257</span>, <span class="fl">261</span>, <span class="fl">248</span>,
  <span class="fl">219</span>, <span class="fl">244</span>, <span class="fl">283</span>, <span class="fl">293</span>, <span class="fl">312</span>, <span class="fl">272</span>, <span class="fl">280</span>, <span class="fl">298</span>, <span class="fl">275</span>, <span class="fl">297</span>, <span class="fl">350</span>, <span class="fl">260</span>, <span class="fl">313</span>,
  <span class="fl">273</span>, <span class="fl">289</span>, <span class="fl">326</span>, <span class="fl">281</span>, <span class="fl">288</span>, <span class="fl">280</span>, <span class="fl">283</span>, <span class="fl">307</span>, <span class="fl">286</span>, <span class="fl">298</span>, <span class="fl">267</span>, <span class="fl">272</span>, <span class="fl">285</span>,
  <span class="fl">286</span>, <span class="fl">303</span>, <span class="fl">295</span>, <span class="fl">289</span>, <span class="fl">258</span>, <span class="fl">286</span>, <span class="fl">320</span>, <span class="fl">354</span>, <span class="fl">328</span>, <span class="fl">297</span>, <span class="fl">323</span>, <span class="fl">331</span>, <span class="fl">305</span>,
  <span class="fl">338</span>, <span class="fl">376</span>, <span class="fl">296</span>, <span class="fl">352</span>, <span class="fl">314</span>, <span class="fl">325</span>, <span class="fl">358</span>, <span class="fl">312</span>, <span class="fl">324</span>, <span class="fl">316</span>, <span class="fl">317</span>, <span class="fl">336</span>, <span class="fl">321</span>,
  <span class="fl">334</span>, <span class="fl">302</span>, <span class="fl">302</span>, <span class="fl">323</span>, <span class="fl">331</span>, <span class="fl">345</span>, <span class="fl">333</span>, <span class="fl">316</span>, <span class="fl">291</span>, <span class="fl">324</span>
<span class="op">)</span>, .Dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">8.0</span>, <span class="fl">15.0</span>, <span class="fl">22.0</span>, <span class="fl">29.0</span>, <span class="fl">36.0</span><span class="op">)</span>
<span class="va">xbar</span> <span class="op">&lt;-</span> <span class="fl">22.0</span>


<span class="co"># 模型参数设置</span>
<span class="va">chains</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fl">1000</span>

<span class="va">init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rep.html">rep</a></span><span class="op">(</span><span class="fl">250</span>, <span class="fl">30</span><span class="op">)</span>, beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rep.html">rep</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">30</span><span class="op">)</span>,
  alpha_c <span class="op">=</span> <span class="fl">150</span>, beta_c <span class="op">=</span> <span class="fl">10</span>,
  tausq_c <span class="op">=</span> <span class="fl">1</span>, tausq_alpha <span class="op">=</span> <span class="fl">1</span>,
  tausq_beta <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span><span class="op">)</span>, <span class="va">chains</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html">cmdstan_model</a></span><span class="op">(</span>stan_file <span class="op">=</span> <span class="st">"code/rats.stan"</span><span class="op">)</span>

<span class="va">rats_fit</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>
  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>, T <span class="op">=</span> <span class="cn">T</span>, y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, xbar <span class="op">=</span> <span class="va">xbar</span><span class="op">)</span>,
  init <span class="op">=</span> <span class="va">init</span>,
  iter_warmup <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># 每条链预处理迭代次数</span>
  iter_sampling <span class="op">=</span> <span class="fl">2000</span>, <span class="co"># 每条链总迭代次数</span>
  chains <span class="op">=</span> <span class="va">chains</span>, <span class="co"># 马尔科夫链的数目</span>
  parallel_chains <span class="op">=</span> <span class="fl">1</span>, <span class="co"># 指定 CPU 核心数，可以给每条链分配一个</span>
  show_messages <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># 不显示迭代的中间过程</span>
  refresh <span class="op">=</span> <span class="fl">0</span>, <span class="co"># 不显示采样的进度</span>
  seed <span class="op">=</span> <span class="fl">20190425</span> <span class="co"># 设置随机数种子，不要使用 set.seed() 函数</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Running MCMC with 4 sequential chains...
## 
## Chain 1 finished in 0.8 seconds.
## Chain 2 finished in 0.9 seconds.
## Chain 3 finished in 0.9 seconds.
## Chain 4 finished in 0.8 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 0.9 seconds.
## Total execution time: 3.7 seconds.</code></pre>
</div>
</div>
<div id="sec-nlm-gp" class="section level2" number="29.5">
<h2>
<span class="header-section-number">29.5</span> 非线性模型<a class="anchor" aria-label="anchor" href="#sec-nlm-gp"><i class="fas fa-link"></i></a>
</h2>
<p>高斯过程</p>
<div id="subsec-mcycle" class="section level3" number="29.5.1">
<h3>
<span class="header-section-number">29.5.1</span> mcycle 数据<a class="anchor" aria-label="anchor" href="#subsec-mcycle"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb2259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mcycle</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">times</span>, y<span class="op">=</span> <span class="va">accel</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># geom_smooth() +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Times (ms)"</span>, y <span class="op">=</span> <span class="st">"Acceleration (g)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bayesian-models_files/figure-html/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;"></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="chap-spatial-modeling.html"><span class="header-section-number">28</span> 空间建模</a></div>
<div class="next"><a href="chap-gradient-boosting-machine.html"><span class="header-section-number">30</span> 梯度提升机</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-bayesian-models"><span class="header-section-number">29</span> 贝叶斯模型</a></li>
<li><a class="nav-link" href="#sec-stan-setup"><span class="header-section-number">29.1</span> 软件配置</a></li>
<li><a class="nav-link" href="#sec-bayesian-normal-distribution"><span class="header-section-number">29.2</span> 正态分布</a></li>
<li><a class="nav-link" href="#sec-gaussian-process"><span class="header-section-number">29.3</span> 高斯过程</a></li>
<li>
<a class="nav-link" href="#sec-hierarchical-normal-models"><span class="header-section-number">29.4</span> 分层正态模型</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec-eight-schools"><span class="header-section-number">29.4.1</span> schools 数据</a></li>
<li><a class="nav-link" href="#subsec-rats"><span class="header-section-number">29.4.2</span> rats 数据</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec-nlm-gp"><span class="header-section-number">29.5</span> 非线性模型</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#subsec-mcycle"><span class="header-section-number">29.5.1</span> mcycle 数据</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/XiangyunHuang/masr/blob/master/bayesian-models.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/XiangyunHuang/masr/edit/master/bayesian-models.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>现代应用统计与 R 语言</strong>" was written by 黄湘云. It was last built on 2021-08-08.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
