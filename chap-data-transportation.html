<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 3 章 数据搬运 | 现代应用统计与 R 语言</title>
<meta name="author" content="黄湘云">
<meta name="description" content="导入数据与导出数据，各种数据格式，数据库 处理 Excel 2003 (XLS) 和 Excel 2007 (XLSX) 文件还可以使用 WriteXLS 包，不过它依赖于 Perl，另一个 R 包 xlsx 与之功能类似，依赖 Java 环境。Jennifer Bryan 和 Hadley Wickham 开发的 readxl 包和 Jeroen Ooms 开发的 writexl...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="第 3 章 数据搬运 | 现代应用统计与 R 语言">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/cover.png">
<meta property="og:description" content="导入数据与导出数据，各种数据格式，数据库 处理 Excel 2003 (XLS) 和 Excel 2007 (XLSX) 文件还可以使用 WriteXLS 包，不过它依赖于 Perl，另一个 R 包 xlsx 与之功能类似，依赖 Java 环境。Jennifer Bryan 和 Hadley Wickham 开发的 readxl 包和 Jeroen Ooms 开发的 writexl...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第 3 章 数据搬运 | 现代应用统计与 R 语言">
<meta name="twitter:description" content="导入数据与导出数据，各种数据格式，数据库 处理 Excel 2003 (XLS) 和 Excel 2007 (XLSX) 文件还可以使用 WriteXLS 包，不过它依赖于 Perl，另一个 R 包 xlsx 与之功能类似，依赖 Java 环境。Jennifer Bryan 和 Hadley Wickham 开发的 readxl 包和 Jeroen Ooms 开发的 writexl...">
<meta name="twitter:image" content="/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs/header-attrs.js"></script><script src="libs/jquery/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap/bootstrap.bundle.min.js"></script><script src="libs/bs3compat/transition.js"></script><script src="libs/bs3compat/tabs.js"></script><script src="libs/bs3compat/bs3compat.js"></script><link href="libs/bs4_book/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book/bs4_book.js"></script><script src="libs/htmlwidgets/htmlwidgets.js"></script><script src="libs/plotly-binding/plotly.js"></script><script src="libs/typedarray/typedarray.min.js"></script><link href="libs/crosstalk/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main/plotly-latest.min.js"></script><script src="libs/proj4js/proj4.js"></script><link href="libs/highcharts/css/motion.css" rel="stylesheet">
<script src="libs/highcharts/highcharts.js"></script><script src="libs/highcharts/highcharts-3d.js"></script><script src="libs/highcharts/highcharts-more.js"></script><script src="libs/highcharts/modules/stock.js"></script><script src="libs/highcharts/modules/map.js"></script><script src="libs/highcharts/modules/annotations.js"></script><script src="libs/highcharts/modules/data.js"></script><script src="libs/highcharts/modules/drilldown.js"></script><script src="libs/highcharts/modules/item-series.js"></script><script src="libs/highcharts/modules/offline-exporting.js"></script><script src="libs/highcharts/modules/overlapping-datalabels.js"></script><script src="libs/highcharts/modules/exporting.js"></script><script src="libs/highcharts/modules/export-data.js"></script><script src="libs/highcharts/modules/funnel.js"></script><script src="libs/highcharts/modules/heatmap.js"></script><script src="libs/highcharts/modules/treemap.js"></script><script src="libs/highcharts/modules/sankey.js"></script><script src="libs/highcharts/modules/dependency-wheel.js"></script><script src="libs/highcharts/modules/organization.js"></script><script src="libs/highcharts/modules/solid-gauge.js"></script><script src="libs/highcharts/modules/streamgraph.js"></script><script src="libs/highcharts/modules/sunburst.js"></script><script src="libs/highcharts/modules/vector.js"></script><script src="libs/highcharts/modules/wordcloud.js"></script><script src="libs/highcharts/modules/xrange.js"></script><script src="libs/highcharts/modules/tilemap.js"></script><script src="libs/highcharts/modules/venn.js"></script><script src="libs/highcharts/modules/gantt.js"></script><script src="libs/highcharts/modules/timeline.js"></script><script src="libs/highcharts/modules/parallel-coordinates.js"></script><script src="libs/highcharts/modules/bullet.js"></script><script src="libs/highcharts/modules/coloraxis.js"></script><script src="libs/highcharts/modules/dumbbell.js"></script><script src="libs/highcharts/modules/lollipop.js"></script><script src="libs/highcharts/modules/series-label.js"></script><script src="libs/highcharts/plugins/motion.js"></script><script src="libs/highcharts/custom/reset.js"></script><script src="libs/highcharts/modules/boost.js"></script><script src="libs/highchart-binding/highchart.js"></script><script src="libs/plotly-locale-zh-CN/zh-cn.js"></script><script src="libs/mathjax/cdn.js"></script><link href="libs/dygraphs/dygraph.css" rel="stylesheet">
<script src="libs/dygraphs/dygraph-combined.js"></script><script src="libs/dygraphs/shapes.js"></script><script src="libs/moment/moment.js"></script><script src="libs/moment-timezone/moment-timezone-with-data.js"></script><script src="libs/moment-fquarter/moment-fquarter.min.js"></script><script src="libs/dygraphs-binding/dygraphs.js"></script><script src="libs/Dygraph.Plugins.Unzoom/unzoom.js"></script><script src="libs/echarts4r/echarts-en.min.js"></script><script src="libs/echarts4r/ecStat.min.js"></script><script src="libs/echarts4r/dataTool.min.js"></script><script src="libs/echarts4r-binding/echarts4r.js"></script><script src="libs/d3/d3.min.js"></script><script src="libs/forceNetwork-binding/forceNetwork.js"></script><link href="libs/vis/vis.css" rel="stylesheet">
<script src="libs/vis/vis.min.js"></script><script src="libs/visNetwork-binding/visNetwork.js"></script><script src="libs/FileSaver/FileSaver.min.js"></script><script src="libs/Blob/Blob.js"></script><script src="libs/canvas-toBlob/canvas-toBlob.js"></script><script src="libs/html2canvas/html2canvas.js"></script><script src="libs/jspdf/jspdf.debug.js"></script><link href="libs/jquery-sparkline/jquery.sparkline.css" rel="stylesheet">
<script src="libs/jquery-sparkline/jquery.sparkline.js"></script><script src="libs/sparkline-binding/sparkline.js"></script><script src="libs/r2d3-render/r2d3-render.js"></script><script src="libs/webcomponents/webcomponents.js"></script><script src="libs/r2d3-binding/r2d3.js"></script><script src="libs/d3v6/d3.min.js"></script><script src="libs/es6shim/es6shim.js"></script><script src="libs/es7shim/es7shim.js"></script><script src="libs/graphre/graphre.js"></script><script src="libs/nomnoml/nomnoml.js"></script><script src="libs/nomnoml-binding/nomnoml.js"></script><link href="libs/datatables-css/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding/datatables.js"></script><link href="libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core/js/jquery.dataTables.min.js"></script><script src="libs/jszip/jszip.min.js"></script><script src="libs/pdfmake/pdfmake.js"></script><script src="libs/pdfmake/vfs_fonts.js"></script><link href="libs/dt-ext-buttons/css/buttons.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-buttons/js/dataTables.buttons.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.flash.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.html5.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.colVis.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.print.min.js"></script><link href="libs/dt-ext-rowgroup/css/rowGroup.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-rowgroup/js/dataTables.rowGroup.min.js"></script><script src="libs/kePrint/kePrint.js"></script><link href="libs/lightable/lightable.css" rel="stylesheet">
<script src="libs/echarts-world/world.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-54GQKWF7VP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-54GQKWF7VP');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Modern Applied Statistics with R">现代应用统计与 R 语言</a>:
        <small class="text-muted">Modern Applied Statistics with R</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">欢迎</a></li>
<li><a class="" href="chap-preface.html"><span class="header-section-number">1</span> 前言</a></li>
<li class="book-part">数据整理</li>
<li><a class="" href="chap-data-wrangling.html">介绍</a></li>
<li><a class="" href="chap-data-structure.html"><span class="header-section-number">2</span> 数据结构</a></li>
<li><a class="active" href="chap-data-transportation.html"><span class="header-section-number">3</span> 数据搬运</a></li>
<li><a class="" href="chap-string-operations.html"><span class="header-section-number">4</span> 字符串操作</a></li>
<li><a class="" href="chap-regular-expressions.html"><span class="header-section-number">5</span> 正则表达式</a></li>
<li><a class="" href="chap-data-manipulation.html"><span class="header-section-number">6</span> 数据操作</a></li>
<li class="book-part">统计图形</li>
<li><a class="" href="chap-statistical-graphics.html">介绍</a></li>
<li><a class="" href="chap-graphics-foundations.html"><span class="header-section-number">7</span> 图形基础</a></li>
<li><a class="" href="chap-data-visualization.html"><span class="header-section-number">8</span> 数据可视化</a></li>
<li><a class="" href="chap-interactive-web-graphics.html"><span class="header-section-number">9</span> 交互图形</a></li>
<li class="book-part">动态文档</li>
<li><a class="" href="chap-dynamic-documents.html">介绍</a></li>
<li><a class="" href="chap-document-elements.html"><span class="header-section-number">10</span> 文档元素</a></li>
<li><a class="" href="chap-portable-document.html"><span class="header-section-number">11</span> 便携式文档</a></li>
<li><a class="" href="chap-web-documents.html"><span class="header-section-number">12</span> 网页文档</a></li>
<li><a class="" href="chap-office-document.html"><span class="header-section-number">13</span> 办公文档</a></li>
<li><a class="" href="chap-reproducible-workflows.html"><span class="header-section-number">14</span> 工作流</a></li>
<li><a class="" href="chap-advanced-documents.html"><span class="header-section-number">15</span> 高级文档</a></li>
<li class="book-part">数据产品</li>
<li><a class="" href="chap-data-product.html">介绍</a></li>
<li><a class="" href="chap-interactive-data-tables.html"><span class="header-section-number">16</span> 交互表格</a></li>
<li><a class="" href="chap-interactive-shiny-app.html"><span class="header-section-number">17</span> 交互报表</a></li>
<li class="book-part">统计基础</li>
<li><a class="" href="chap-statistical-foundations.html">介绍</a></li>
<li><a class="" href="chap-sampling-distributions.html"><span class="header-section-number">18</span> 抽样分布</a></li>
<li><a class="" href="chap-parameter-estimators.html"><span class="header-section-number">19</span> 参数估计</a></li>
<li><a class="" href="chap-hypothesis-test.html"><span class="header-section-number">20</span> 假设检验</a></li>
<li><a class="" href="chap-power-Analysis.html"><span class="header-section-number">21</span> 功效分析</a></li>
<li><a class="" href="chap-experimental-design.html"><span class="header-section-number">22</span> 试验设计</a></li>
<li class="book-part">统计模型</li>
<li><a class="" href="chap-statistical-models.html">介绍</a></li>
<li><a class="" href="chap-linear-models.html"><span class="header-section-number">23</span> 线性模型</a></li>
<li><a class="" href="chap-generalized-linear-models.html"><span class="header-section-number">24</span> 广义线性模型</a></li>
<li><a class="" href="chap-bayesian-models.html"><span class="header-section-number">25</span> 贝叶斯模型</a></li>
<li class="book-part">数据建模</li>
<li><a class="" href="chap-data-modeling.html">介绍</a></li>
<li><a class="" href="chap-text-analysis.html"><span class="header-section-number">26</span> 文本分析</a></li>
<li><a class="" href="chap-survival-analysis.html"><span class="header-section-number">27</span> 生存分析</a></li>
<li><a class="" href="chap-time-series-analysis.html"><span class="header-section-number">28</span> 时序分析</a></li>
<li class="book-part">时空数据</li>
<li><a class="" href="chap-spatio-temporal-data.html">介绍</a></li>
<li><a class="" href="chap-spatial-analysis.html"><span class="header-section-number">29</span> 空间数据分析</a></li>
<li><a class="" href="chap-spatial-modeling.html"><span class="header-section-number">30</span> 空间数据建模</a></li>
<li><a class="" href="chap-spatial-viz.html"><span class="header-section-number">31</span> 空间数据可视化</a></li>
<li><a class="" href="chap-case-study.html"><span class="header-section-number">32</span> 案例研究</a></li>
<li><a class="" href="chap-data-explorer.html"><span class="header-section-number">33</span> 数据探索</a></li>
<li class="book-part">机器学习</li>
<li><a class="" href="chap-machine-learning.html">介绍</a></li>
<li><a class="" href="chap-gradient-boosting-machine.html"><span class="header-section-number">34</span> 梯度提升机</a></li>
<li><a class="" href="chap-numerical-optimization.html"><span class="header-section-number">35</span> 数值优化</a></li>
<li class="book-part">附录</li>
<li><a class="" href="chap-linux-command-bash.html"><span class="header-section-number">A</span> 命令行操作</a></li>
<li><a class="" href="chap-matrix-operations.html"><span class="header-section-number">B</span> 矩阵运算</a></li>
<li><a class="" href="chap-symbolic-computation.html"><span class="header-section-number">C</span> 符号计算</a></li>
<li><a class="" href="chap-mixed-programming.html"><span class="header-section-number">D</span> 混合编程</a></li>
<li><a class="" href="chap-object-oriented-programming.html"><span class="header-section-number">E</span> 面向对象编程</a></li>
<li><a class="" href="chap-file-operations.html"><span class="header-section-number">F</span> 文件操作</a></li>
<li><a class="" href="chap-other-softwares.html"><span class="header-section-number">G</span> 其它软件</a></li>
<li><a class="" href="chap-notations.html"><span class="header-section-number">H</span> 符号说明</a></li>
<li><a class="" href="references.html">参考文献</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/XiangyunHuang/masr">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-data-transportation" class="section level1" number="3">
<h1>
<span class="header-section-number">第 3 章</span> 数据搬运<a class="anchor" aria-label="anchor" href="#chap-data-transportation"><i class="fas fa-link"></i></a>
</h1>
<p>导入数据与导出数据，各种数据格式，数据库</p>
<p>处理 Excel 2003 (XLS) 和 Excel 2007 (XLSX) 文件还可以使用 <a href="https://github.com/marcschwartz/WriteXLS">WriteXLS</a> 包，不过它依赖于 Perl，另一个 R 包 <a href="https://github.com/dragua/rexcel">xlsx</a> 与之功能类似，依赖 Java 环境。Jennifer Bryan 和 Hadley Wickham 开发的 <a href="https://github.com/tidyverse/readxl">readxl</a> 包和 Jeroen Ooms 开发的 <a href="https://github.com/ropensci/writexl">writexl</a> 包专门处理 xlsx 格式并且无任何系统依赖。</p>
<div id="import-data" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> 导入数据<a class="anchor" aria-label="anchor" href="#import-data"><i class="fas fa-link"></i></a>
</h2>
<p>Base R 针对不同的数据格式文件，提供了大量的数据导入和导出函数，不愧是专注数据分析20余年的优秀统计软件。 除了函数 <code>write.ftable</code> 和 <code>read.ftable</code> 来自 stats 包，都来自 base 和 utils 包</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 当前环境的搜索路径</span>
<span class="fu"><a href="https://rdrr.io/r/base/search.html">searchpaths</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] ".GlobalEnv"                          
## [2] "/opt/R/4.1.1/lib/R/library/stats"    
## [3] "/opt/R/4.1.1/lib/R/library/graphics" 
## [4] "/opt/R/4.1.1/lib/R/library/grDevices"
## [5] "/opt/R/4.1.1/lib/R/library/utils"    
## [6] "/opt/R/4.1.1/lib/R/library/datasets" 
## [7] "/opt/R/4.1.1/lib/R/library/methods"  
## [8] "Autoloads"                           
## [9] "/opt/R/4.1.1/lib/R/library/base"</code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 返回匹配结果及其所在路径的编号</span>
<span class="fu"><a href="https://rdrr.io/r/utils/apropos.html">apropos</a></span><span class="op">(</span><span class="st">"^(read|write)"</span>, where <span class="op">=</span> <span class="cn">TRUE</span>, mode <span class="op">=</span> <span class="st">"function"</span><span class="op">)</span></code></pre></div>
<pre><code>##                  5                  5                  9                  5 
##         "read.csv"        "read.csv2"         "read.dcf"       "read.delim" 
##                  5                  5                  5                  2 
##      "read.delim2"         "read.DIF"     "read.fortran"      "read.ftable" 
##                  5                  5                  5                  9 
##         "read.fwf"      "read.socket"       "read.table"          "readBin" 
##                  9                  5                  9                  9 
##         "readChar" "readCitationFile"         "readline"        "readLines" 
##                  9                  9                  9                  5 
##          "readRDS"     "readRenviron"            "write"        "write.csv" 
##                  5                  9                  2                  5 
##       "write.csv2"        "write.dcf"     "write.ftable"     "write.socket" 
##                  5                  9                  9                  9 
##      "write.table"         "writeBin"        "writeChar"       "writeLines"</code></pre>
<div id="scan-file" class="section level3" number="3.1.1">
<h3>
<span class="header-section-number">3.1.1</span> <code>scan</code><a class="anchor" aria-label="anchor" href="#scan-file"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">""</span>, what <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="op">)</span>, nmax <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, n <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, sep <span class="op">=</span> <span class="st">""</span>,
     quote <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">sep</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span> <span class="st">""</span> <span class="kw">else</span> <span class="st">"'\""</span>, dec <span class="op">=</span> <span class="st">"."</span>,
     skip <span class="op">=</span> <span class="fl">0</span>, nlines <span class="op">=</span> <span class="fl">0</span>, na.strings <span class="op">=</span> <span class="st">"NA"</span>,
     flush <span class="op">=</span> <span class="cn">FALSE</span>, fill <span class="op">=</span> <span class="cn">FALSE</span>, strip.white <span class="op">=</span> <span class="cn">FALSE</span>,
     quiet <span class="op">=</span> <span class="cn">FALSE</span>, blank.lines.skip <span class="op">=</span> <span class="cn">TRUE</span>, multi.line <span class="op">=</span> <span class="cn">TRUE</span>,
     comment.char <span class="op">=</span> <span class="st">""</span>, allowEscapes <span class="op">=</span> <span class="cn">FALSE</span>,
     fileEncoding <span class="op">=</span> <span class="st">""</span>, encoding <span class="op">=</span> <span class="st">"unknown"</span>, <span class="va">text</span>, skipNul <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>首先让我们用 <code>cat</code> 函数创建一个练习数据集 <code>ex.data</code></p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"TITLE extra line"</span>, <span class="st">"2 3 5 7"</span>, <span class="st">"11 13 17"</span><span class="op">)</span></code></pre></div>
<pre><code>## TITLE extra line 2 3 5 7 11 13 17</code></pre>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"TITLE extra line"</span>, <span class="st">"2 3 5 7"</span>, <span class="st">"11 13 17"</span>, file <span class="op">=</span> <span class="st">"data/ex.data"</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></code></pre></div>
<p>以此练习数据集，介绍 <code>scan</code> 函数最常用的参数</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span><span class="op">(</span><span class="st">"data/ex.data"</span><span class="op">)</span></code></pre></div>
<pre><code>## Error in scan("data/ex.data"): scan() expected 'a real', got 'TITLE'</code></pre>
<p>从上面的报错信息，我们发现 <code>scan</code> 函数只能读取同一类型的数据，如布尔型 logical， 整型 integer，数值型 numeric(double)， 复数型 complex，字符型 character，raw 和列表 list。所以我们设置参数 <code>skip = 1</code> 把第一行跳过，就成功读取了数据</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span><span class="op">(</span><span class="st">"data/ex.data"</span>, skip <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1]  2  3  5  7 11 13 17</code></pre>
<p>如果设置参数 <code>quiet = TRUE</code> 就不会报告读取的数据量</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span><span class="op">(</span><span class="st">"data/ex.data"</span>, skip <span class="op">=</span> <span class="fl">1</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1]  2  3  5  7 11 13 17</code></pre>
<p>参数 <code>nlines = 1</code> 表示只读取一行数据</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span><span class="op">(</span><span class="st">"data/ex.data"</span>, skip <span class="op">=</span> <span class="fl">1</span>, nlines <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># only 1 line after the skipped one</span></code></pre></div>
<pre><code>## [1] 2 3 5 7</code></pre>
<p>默认参数 <code>flush = TRUE</code> 表示读取最后一个请求的字段后，刷新到行尾，下面对比一下读取的结果</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span><span class="op">(</span><span class="st">"data/ex.data"</span>, what <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="co"># flush is F -&gt; read "7"</span></code></pre></div>
<pre><code>## Warning in scan("data/ex.data", what = list("", "", "")): number of items read
## is not a multiple of the number of columns</code></pre>
<pre><code>## [[1]]
## [1] "TITLE" "2"     "7"     "17"   
## 
## [[2]]
## [1] "extra" "3"     "11"    ""     
## 
## [[3]]
## [1] "line" "5"    "13"   ""</code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span><span class="op">(</span><span class="st">"data/ex.data"</span>, what <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span><span class="op">)</span>, flush <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
## [1] "TITLE" "2"     "11"   
## 
## [[2]]
## [1] "extra" "3"     "13"   
## 
## [[3]]
## [1] "line" "5"    "17"</code></pre>
<p>临时文件 ex.data 用完了，我们调用 <code>unlink</code> 函数将其删除，以免留下垃圾文件</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"data/ex.data"</span><span class="op">)</span> <span class="co"># tidy up</span></code></pre></div>
</div>
<div id="read-write-table" class="section level3" number="3.1.2">
<h3>
<span class="header-section-number">3.1.2</span> <code>read.table</code><a class="anchor" aria-label="anchor" href="#read-write-table"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="va">file</span>,
  header <span class="op">=</span> <span class="cn">FALSE</span>, sep <span class="op">=</span> <span class="st">""</span>, quote <span class="op">=</span> <span class="st">"\"'"</span>,
  dec <span class="op">=</span> <span class="st">"."</span>, numerals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"allow.loss"</span>, <span class="st">"warn.loss"</span>, <span class="st">"no.loss"</span><span class="op">)</span>,
  <span class="va">row.names</span>, <span class="va">col.names</span>, as.is <span class="op">=</span> <span class="op">!</span><span class="va">stringsAsFactors</span>,
  na.strings <span class="op">=</span> <span class="st">"NA"</span>, colClasses <span class="op">=</span> <span class="cn">NA</span>, nrows <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,
  skip <span class="op">=</span> <span class="fl">0</span>, check.names <span class="op">=</span> <span class="cn">TRUE</span>, fill <span class="op">=</span> <span class="op">!</span><span class="va">blank.lines.skip</span>,
  strip.white <span class="op">=</span> <span class="cn">FALSE</span>, blank.lines.skip <span class="op">=</span> <span class="cn">TRUE</span>,
  comment.char <span class="op">=</span> <span class="st">"#"</span>,
  allowEscapes <span class="op">=</span> <span class="cn">FALSE</span>, flush <span class="op">=</span> <span class="cn">FALSE</span>,
  stringsAsFactors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">default.stringsAsFactors</a></span><span class="op">(</span><span class="op">)</span>,
  fileEncoding <span class="op">=</span> <span class="st">""</span>, encoding <span class="op">=</span> <span class="st">"unknown"</span>, <span class="va">text</span>, skipNul <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="va">file</span>,
  header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">","</span>, quote <span class="op">=</span> <span class="st">"\""</span>,
  dec <span class="op">=</span> <span class="st">"."</span>, fill <span class="op">=</span> <span class="cn">TRUE</span>, comment.char <span class="op">=</span> <span class="st">""</span>, <span class="va">...</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv2</a></span><span class="op">(</span><span class="va">file</span>,
  header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">";"</span>, quote <span class="op">=</span> <span class="st">"\""</span>,
  dec <span class="op">=</span> <span class="st">","</span>, fill <span class="op">=</span> <span class="cn">TRUE</span>, comment.char <span class="op">=</span> <span class="st">""</span>, <span class="va">...</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.delim</a></span><span class="op">(</span><span class="va">file</span>,
  header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">"\t"</span>, quote <span class="op">=</span> <span class="st">"\""</span>,
  dec <span class="op">=</span> <span class="st">"."</span>, fill <span class="op">=</span> <span class="cn">TRUE</span>, comment.char <span class="op">=</span> <span class="st">""</span>, <span class="va">...</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.delim2</a></span><span class="op">(</span><span class="va">file</span>,
  header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">"\t"</span>, quote <span class="op">=</span> <span class="st">"\""</span>,
  dec <span class="op">=</span> <span class="st">","</span>, fill <span class="op">=</span> <span class="cn">TRUE</span>, comment.char <span class="op">=</span> <span class="st">""</span>, <span class="va">...</span>
<span class="op">)</span></code></pre></div>
<p>变量名是不允许以下划线开头的，同样在数据框里，列名也不推荐使用下划线开头。默认情况下，<code>read.table</code> 都会通过参数 <code>check.names</code> 检查列名的有效性，该参数实际调用了函数 <code>make.names</code> 去检查。如果想尽量保持数据集原来的样子可以设置参数 <code>check.names = FALSE, stringsAsFactors = FALSE</code>。 默认情形下，<code>read.table</code> 还会将字符串转化为因子变量，这是 R 的历史原因，作为一门统计学家的必备语言，在统计模型中，字符常用来描述类别，而类别变量在 R 环境中常用因子类型来表示，而且大量内置的统计模型也是将它们视为因子变量，如 <code>lm</code> 、<code>glm</code> 等</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, check.names <span class="op">=</span> <span class="cn">TRUE</span>, text <span class="op">=</span> <span class="st">"
_a _b _c
1 2 a1
3 4 a2
"</span><span class="op">)</span>
<span class="va">dat1</span></code></pre></div>
<pre><code>##   X_a X_b X_c
## 1   1   2  a1
## 2   3   4  a2</code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, check.names <span class="op">=</span> <span class="cn">FALSE</span>, text <span class="op">=</span> <span class="st">"
_a _b _c
1 2 a1
3 4 a2
"</span><span class="op">)</span>
<span class="va">dat2</span></code></pre></div>
<pre><code>##   _a _b _c
## 1  1  2 a1
## 2  3  4 a2</code></pre>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, check.names <span class="op">=</span> <span class="cn">FALSE</span>,
  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>, text <span class="op">=</span> <span class="st">"
_a _b _c
1 2 a1
3 4 a2
"</span>
<span class="op">)</span>
<span class="va">dat3</span></code></pre></div>
<pre><code>##   _a _b _c
## 1  1  2 a1
## 2  3  4 a2</code></pre>
</div>
<div id="read-write-lines" class="section level3" number="3.1.3">
<h3>
<span class="header-section-number">3.1.3</span> <code>readLines</code><a class="anchor" aria-label="anchor" href="#read-write-lines"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span>con <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/showConnections.html">stdin</a></span><span class="op">(</span><span class="op">)</span>, n <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span>, ok <span class="op">=</span> <span class="cn">TRUE</span>, warn <span class="op">=</span> <span class="cn">TRUE</span>,
          encoding <span class="op">=</span> <span class="st">"unknown"</span>, skipNul <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>让我们折腾一波，读进来又写出去，只有 R 3.5.3 以上才能保持原样的正确输入输出，因为这里有一个之前版本包含的 BUG</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"DESCRIPTION"</span>, package <span class="op">=</span> <span class="st">"splines"</span><span class="op">)</span><span class="op">)</span>, <span class="st">"data/DESCRIPTION"</span><span class="op">)</span>
<span class="co"># 比较一下</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"DESCRIPTION"</span>, package <span class="op">=</span> <span class="st">"splines"</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="st">"data/DESCRIPTION"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>这次我们创建一个真的临时文件，因为重新启动 R 这个文件和文件夹就没有了，回收掉了</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fil</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".data"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"TITLE extra line"</span>, <span class="st">"2 3 5 7"</span>, <span class="st">""</span>, <span class="st">"11 13 17"</span>, file <span class="op">=</span> <span class="va">fil</span>,
    sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span>
<span class="va">fil</span></code></pre></div>
<pre><code>## [1] "/tmp/RtmpYm0Mmo/fileb5983560b4bb.data"</code></pre>
<p>设置参数 <code>n = -1</code> 表示将文件 fil 的内容从头读到尾</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">fil</span>, n <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "TITLE extra line" "2 3 5 7"          ""                 "11 13 17"</code></pre>
<p>作为拥有良好习惯的 R 用户，这种垃圾文件最好用后即焚</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">fil</span><span class="op">)</span> <span class="co"># tidy up</span></code></pre></div>
<p>再举个例子，我们创建一个新的临时文件 <code>fil</code>，文件内容只有</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"123\nabc"</span><span class="op">)</span></code></pre></div>
<pre><code>## 123
## abc</code></pre>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fil</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="st">"test"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"123\nabc\n"</span>, file <span class="op">=</span> <span class="va">fil</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fil</span></code></pre></div>
<pre><code>## [1] "/tmp/RtmpYm0Mmo/testb598780f18fd"</code></pre>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">fil</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "123" "abc"</code></pre>
<p>这次读取文件的过程给出了警告，原因是 fil 没有以空行结尾，<code>warn = TRUE</code> 表示这种情况要给出警告，如果设置参数 <code>warn = FALSE</code> 就没有警告。我们还是建议大家尽量遵循规范。</p>
<p>再举一个例子，从一个连接读取数据，建立连接的方式有很多，参见 <code><a href="https://rdrr.io/r/base/connections.html">?file</a></code>，下面设置参数 <code>blocking</code></p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html">file</a></span><span class="op">(</span><span class="va">fil</span>, <span class="st">"r"</span>, blocking <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "123" "abc"</code></pre>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">" def\n"</span>, file <span class="op">=</span> <span class="va">fil</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] " def"</code></pre>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 关闭连接</span>
<span class="fu"><a href="https://rdrr.io/r/base/connections.html">close</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span>
<span class="co"># 清理垃圾文件</span>
<span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">fil</span><span class="op">)</span></code></pre></div>
</div>
<div id="read-save-rds" class="section level3" number="3.1.4">
<h3>
<span class="header-section-number">3.1.4</span> <code>readRDS</code><a class="anchor" aria-label="anchor" href="#read-save-rds"><i class="fas fa-link"></i></a>
</h3>
<p>序列化数据操作，Mark Klik 开发的 <a href="https://github.com/fstpackage/fst">fst</a> 和 <a href="https://travers.im/">Travers Ching</a> 开发的 <a href="https://github.com/traversc/qs">qs</a>， Hadley Wickham 开发的 <a href="https://github.com/wesm/feather/tree/master/R">feather</a> 包实现跨语言环境快速的读写数据</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:fst-vs-others">表 3.1: </span> fst 序列化数据框对象性能比较 BaseR、 data.table 和 feather <a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://www.fstpackage.org/" class="uri"&gt;https://www.fstpackage.org/&lt;/a&gt;&lt;/p&gt;'><sup>7</sup></a>
</caption>
<thead><tr class="header">
<th align="left">Method</th>
<th align="left">Format</th>
<th align="left">Time (ms)</th>
<th align="left">Size (MB)</th>
<th align="left">Speed (MB/s)</th>
<th align="left">N</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">readRDS</td>
<td align="left">bin</td>
<td align="left">1577</td>
<td align="left">1000</td>
<td align="left">633</td>
<td align="left">112</td>
</tr>
<tr class="even">
<td align="left">saveRDS</td>
<td align="left">bin</td>
<td align="left">2042</td>
<td align="left">1000</td>
<td align="left">489</td>
<td align="left">112</td>
</tr>
<tr class="odd">
<td align="left">fread</td>
<td align="left">csv</td>
<td align="left">2925</td>
<td align="left">1038</td>
<td align="left">410</td>
<td align="left">232</td>
</tr>
<tr class="even">
<td align="left">fwrite</td>
<td align="left">csv</td>
<td align="left">2790</td>
<td align="left">1038</td>
<td align="left">358</td>
<td align="left">241</td>
</tr>
<tr class="odd">
<td align="left">read_feather</td>
<td align="left">bin</td>
<td align="left">3950</td>
<td align="left">813</td>
<td align="left">253</td>
<td align="left">112</td>
</tr>
<tr class="even">
<td align="left">write_feather</td>
<td align="left">bin</td>
<td align="left">1820</td>
<td align="left">813</td>
<td align="left">549</td>
<td align="left">112</td>
</tr>
<tr class="odd">
<td align="left"><strong>read_fst</strong></td>
<td align="left"><strong>bin</strong></td>
<td align="left"><strong>457</strong></td>
<td align="left"><strong>303</strong></td>
<td align="left"><strong>2184</strong></td>
<td align="left"><strong>282</strong></td>
</tr>
<tr class="even">
<td align="left"><strong>write_fst</strong></td>
<td align="left"><strong>bin</strong></td>
<td align="left"><strong>314</strong></td>
<td align="left"><strong>303</strong></td>
<td align="left"><strong>3180</strong></td>
<td align="left"><strong>291</strong></td>
</tr>
</tbody>
</table></div>
<p>目前比较好的是 qs 和 fst 包</p>
</div>
</div>
<div id="other-data-source" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> 其它数据格式<a class="anchor" aria-label="anchor" href="#other-data-source"><i class="fas fa-link"></i></a>
</h2>
<p>来自其它格式的数据形式，如 JSON、XML、YAML 需要转化清理成 R 中数据框的形式 data.frame</p>
<ol style="list-style-type: decimal">
<li><a href="https://www.carlboettiger.info/2017/12/11/data-rectangling-with-jq/">Data Rectangling with jq</a></li>
<li>
<a href="https://jeroen.github.io/mongolite/">Mongolite User Manual</a> introduction to using MongoDB with the mongolite client in R</li>
</ol>
<p><a href="https://github.com/jeroen/jsonlite">jsonlite</a> 读取 <code>*.json</code> 格式的文件，<code><a href="https://rdrr.io/pkg/jsonlite/man/read_json.html">jsonlite::write_json</a></code> 函数将 R对象保存为 JSON 文件，<code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">jsonlite::fromJSON</a></code> 将 json 字符串或文件转化为 R 对象，<code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">jsonlite::toJSON</a></code> 函数正好与之相反</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805">jsonlite</a></span><span class="op">)</span>
<span class="co"># 从 json 格式的文件导入</span>
<span class="co"># jsonlite::read_json(path = "path/to/filename.json")</span>
<span class="co"># A JSON array of primitives</span>
<span class="va">json</span> <span class="op">&lt;-</span> <span class="st">'["Mario", "Peach", null, "Bowser"]'</span>

<span class="co"># 简化为原子向量atomic vector</span>
<span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Mario"  "Peach"  NA       "Bowser"</code></pre>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 默认返回一个列表</span>
<span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json</span>, simplifyVector <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
## [1] "Mario"
## 
## [[2]]
## [1] "Peach"
## 
## [[3]]
## NULL
## 
## [[4]]
## [1] "Bowser"</code></pre>
<p>yaml 包读取 <code>*.yml</code> 格式文件，返回一个列表，<code><a href="https://rdrr.io/pkg/yaml/man/write_yaml.html">yaml::write_yaml</a></code> 函数将 R 对象写入 yaml 格式</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/viking/r-yaml/">yaml</a></span><span class="op">)</span>
<span class="fu">yaml</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/yaml/man/read_yaml.html">read_yaml</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'_bookdown.yml'</span><span class="op">)</span></code></pre></div>
<pre><code>## $book_filename
## [1] "masr"
## 
## $delete_merged_file
## [1] TRUE
## 
## $language
## $language$label
## $language$label$fig
## [1] "图 "
## 
## $language$label$tab
## [1] "表 "
## 
## 
## $language$ui
## $language$ui$edit
## [1] "编辑"
## 
## $language$ui$chapter_name
## [1] "第 " " 章"
## 
## $language$ui$appendix_name
## [1] "附录 "
## 
## 
## 
## $new_session
## [1] TRUE
## 
## $before_chapter_script
## [1] "_common.R"
## 
## $rmd_files
##  [1] "index.Rmd"                       "preface.Rmd"                    
##  [3] "data-wrangling.Rmd"              "data-structure.Rmd"             
##  [5] "data-transportation.Rmd"         "string-operations.Rmd"          
##  [7] "regular-expressions.Rmd"         "data-manipulation.Rmd"          
##  [9] "statistical-graphics.Rmd"        "graphics-foundations.Rmd"       
## [11] "data-visualization.Rmd"          "interactive-web-graphics.Rmd"   
## [13] "dynamic-documents.Rmd"           "document-elements.Rmd"          
## [15] "portable-documents.Rmd"          "web-documents.Rmd"              
## [17] "office-documents.Rmd"            "reproducible-workflows.Rmd"     
## [19] "advanced-documents.Rmd"          "data-product.Rmd"               
## [21] "interactive-data-tables.Rmd"     "interactive-shiny-app.Rmd"      
## [23] "statistical-foundations.Rmd"     "sampling-distributions.Rmd"     
## [25] "parameter-estimators.Rmd"        "hypothesis-test.Rmd"            
## [27] "power-analysis.Rmd"              "experimental-design.Rmd"        
## [29] "statistical-models.Rmd"          "linear-models.Rmd"              
## [31] "generalized-linear-models.Rmd"   "bayesian-models.Rmd"            
## [33] "data-modeling.Rmd"               "text-analysis.Rmd"              
## [35] "survival-analysis.Rmd"           "time-series-analysis.Rmd"       
## [37] "spatio-temporal-data.Rmd"        "spatial-analysis.Rmd"           
## [39] "spatial-modeling.Rmd"            "spatial-viz.Rmd"                
## [41] "case-study.Rmd"                  "data-explorer.Rmd"              
## [43] "machine-learning.Rmd"            "gradient-boosting-machine.Rmd"  
## [45] "numerical-optimization.Rmd"      "appendix.Rmd"                   
## [47] "matrix-operations.Rmd"           "symbolic-computation.Rmd"       
## [49] "mixed-programming.Rmd"           "object-oriented-programming.Rmd"
## [51] "file-operations.Rmd"             "other-softwares.Rmd"            
## [53] "notations.Rmd"                   "references.Rmd"</code></pre>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:other-softwares">表 3.2: </span> 导入来自其它数据分析软件产生的数据集</caption>
<thead><tr class="header">
<th align="left">统计软件</th>
<th align="left">R函数</th>
<th align="left">R包</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ERSI ArcGIS</td>
<td align="left"><code>read.shapefile</code></td>
<td align="left">shapefiles</td>
</tr>
<tr class="even">
<td align="left">Matlab</td>
<td align="left"><code>readMat</code></td>
<td align="left">R.matlab</td>
</tr>
<tr class="odd">
<td align="left">minitab</td>
<td align="left"><code>read.mtp</code></td>
<td align="left">foreign</td>
</tr>
<tr class="even">
<td align="left">SAS (permanent data)</td>
<td align="left"><code>read.ssd</code></td>
<td align="left">foreign</td>
</tr>
<tr class="odd">
<td align="left">SAS (XPORT format)</td>
<td align="left"><code>read.xport</code></td>
<td align="left">foreign</td>
</tr>
<tr class="even">
<td align="left">SPSS</td>
<td align="left"><code>read.spss</code></td>
<td align="left">foreign</td>
</tr>
<tr class="odd">
<td align="left">Stata</td>
<td align="left"><code>read.dta</code></td>
<td align="left">foreign</td>
</tr>
<tr class="even">
<td align="left">Systat</td>
<td align="left"><code>read.systat</code></td>
<td align="left">foreign</td>
</tr>
<tr class="odd">
<td align="left">Octave</td>
<td align="left"><code>read.octave</code></td>
<td align="left">foreign</td>
</tr>
</tbody>
</table></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:other-read-functions">表 3.3: </span> 导入来自其它格式的数据集</caption>
<thead><tr class="header">
<th align="left">文件格式</th>
<th align="left">R函数</th>
<th align="left">R包</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">列联表数据</td>
<td align="left"><code>read.ftable</code></td>
<td align="left">stats</td>
</tr>
<tr class="even">
<td align="left">二进制数据</td>
<td align="left"><code>readBin</code></td>
<td align="left">base</td>
</tr>
<tr class="odd">
<td align="left">字符串数据</td>
<td align="left"><code>readChar</code></td>
<td align="left">base</td>
</tr>
<tr class="even">
<td align="left">剪贴板数据</td>
<td align="left"><code>readClipboard</code></td>
<td align="left">utils</td>
</tr>
</tbody>
</table></div>
<p><code>read.dcf</code> 函数读取 Debian 控制格式文件，这种类型的文件以人眼可读的形式在存储数据，如 R 包的 DESCRIPTION 文件或者包含所有 CRAN 上 R 包描述的文件 <a href="https://cran.r-project.org/src/contrib/PACKAGES" class="uri">https://cran.r-project.org/src/contrib/PACKAGES</a></p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dcf.html">read.dcf</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"DESCRIPTION"</span>, package <span class="op">=</span> <span class="st">"splines"</span><span class="op">)</span>,
              fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Package"</span>, <span class="st">"Version"</span>, <span class="st">"Title"</span><span class="op">)</span><span class="op">)</span>
<span class="va">x</span></code></pre></div>
<pre><code>##      Package   Version Title                                    
## [1,] "splines" "4.1.1" "Regression Spline Functions and Classes"</code></pre>
<p>最后要提及拥有瑞士军刀之称的 <a href="https://github.com/leeper/rio">rio</a> 包，它集合了当前 R 可以读取的所有统计分析软件导出的数据。</p>
</div>
<div id="import-large-dataset" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> 导入大数据集<a class="anchor" aria-label="anchor" href="#import-large-dataset"><i class="fas fa-link"></i></a>
</h2>
<p>在不使用数据库的情况下，从命令行导入大数据集，如几百 M 或几个 G 的 csv 文件。利用 data.table 包的 <code>fread</code> 去读取</p>
<p><a href="https://stackoverflow.com/questions/1727772/" class="uri">https://stackoverflow.com/questions/1727772/</a></p>
</div>
<div id="import-data-from-database" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> 从数据库导入<a class="anchor" aria-label="anchor" href="#import-data-from-database"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://rstudio-education.github.io/hopr">Hands-On Programming with R</a> 数据读写章节<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://rstudio-education.github.io/hopr/dataio.html" class="uri"&gt;https://rstudio-education.github.io/hopr/dataio.html&lt;/a&gt;&lt;/p&gt;'><sup>8</sup></a> 以及 <a href="https://smithjd.github.io/sql-pet/">R, Databases and Docker</a></p>
<p>将大量的 txt 文本存进 MySQL 数据库中，通过操作数据库来聚合文本，极大降低内存消耗 <a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://brucezhaor.github.io/blog/2016/08/04/batch-process-txt-to-mysql" class="uri"&gt;https://brucezhaor.github.io/blog/2016/08/04/batch-process-txt-to-mysql&lt;/a&gt;&lt;/p&gt;'><sup>9</sup></a>，而 ODBC 与 DBI 包是其它数据库接口的基础，knitr 提供了一个支持 SQL 代码的引擎，它便是基于 DBI，因此可以在 R Markdown 文档中直接使用 SQL 代码块 <a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://bookdown.org/yihui/rmarkdown/language-engines.html#sql" class="uri"&gt;https://bookdown.org/yihui/rmarkdown/language-engines.html#sql&lt;/a&gt;
[rstudio-spark]: &lt;a href="https://spark.rstudio.com/" class="uri"&gt;https://spark.rstudio.com/&lt;/a&gt;
[rmarkdown-teaching-demo]: &lt;a href="https://stackoverflow.com/questions/35459166" class="uri"&gt;https://stackoverflow.com/questions/35459166&lt;/a&gt;&lt;/p&gt;'><sup>10</sup></a>。这里制作一个归纳表格，左边数据库右边对应其 R 接口，两边都包含链接，如表 <a href="chap-data-transportation.html#tab:dbi">3.4</a> 所示</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:dbi">表 3.4: </span>数据库接口</caption>
<colgroup>
<col width="13%">
<col width="33%">
<col width="11%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th align="left">数据库</th>
<th align="left">官网</th>
<th align="left">R接口</th>
<th align="left">开发仓</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">MySQL</td>
<td align="left"><a href="https://www.mysql.com/" class="uri">https://www.mysql.com/</a></td>
<td align="left">RMySQL</td>
<td align="left"><a href="https://github.com/r-dbi/RMySQL" class="uri">https://github.com/r-dbi/RMySQL</a></td>
</tr>
<tr class="even">
<td align="left">SQLite</td>
<td align="left"><a href="https://www.sqlite.org" class="uri">https://www.sqlite.org</a></td>
<td align="left">RSQLite</td>
<td align="left"><a href="https://github.com/r-dbi/RSQLite" class="uri">https://github.com/r-dbi/RSQLite</a></td>
</tr>
<tr class="odd">
<td align="left">PostgreSQL</td>
<td align="left"><a href="https://www.postgresql.org/" class="uri">https://www.postgresql.org/</a></td>
<td align="left">RPostgres</td>
<td align="left"><a href="https://github.com/r-dbi/RPostgres" class="uri">https://github.com/r-dbi/RPostgres</a></td>
</tr>
<tr class="even">
<td align="left">MariaDB</td>
<td align="left"><a href="https://mariadb.org/" class="uri">https://mariadb.org/</a></td>
<td align="left">RMariaDB</td>
<td align="left"><a href="https://github.com/r-dbi/RMariaDB" class="uri">https://github.com/r-dbi/RMariaDB</a></td>
</tr>
</tbody>
</table></div>
<div id="postgresql" class="section level3" number="3.4.1">
<h3>
<span class="header-section-number">3.4.1</span> PostgreSQL<a class="anchor" aria-label="anchor" href="#postgresql"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://github.com/r-dbi/odbc">odbc</a> 可以支持很多数据库，下面以连接 <a href="https://www.postgresql.org/">PostgreSQL</a> 数据库为例介绍其过程</p>
<p>首先在某台机器上，拉取 PostgreSQL 的 Docker 镜像</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb102-1"><a href="chap-data-transportation.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull postgres</span></code></pre></div>
<p>在 Docker 上运行 PostgreSQL，主机端口号 8181 映射给数据库 PostgreSQL 的默认端口号 5432（或其它你的 DBA 分配给你的端口）</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb103-1"><a href="chap-data-transportation.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> psql <span class="at">-d</span> <span class="at">-p</span> 8181:5432 <span class="at">-e</span> ROOT=TRUE <span class="dt">\</span></span>
<span id="cb103-2"><a href="chap-data-transportation.html#cb103-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">-e</span> USER=xiangyun <span class="at">-e</span> PASSWORD=cloud postgres</span></code></pre></div>
<p>在主机 Ubuntu 上配置</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb104-1"><a href="chap-data-transportation.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install unixodbc unixodbc-dev odbc-postgresql</span></code></pre></div>
<p>端口 5432 是分配给 PostgreSQL 的默认端口，<code>host</code> 可以是云端的地址，如 你的亚马逊账户下的 PostgreSQL 数据库地址 <code>&lt;ec2-54-83-201-96.compute-1.amazonaws.com&gt;</code>，也可以是本地局域网IP地址，如<code>&lt;192.168.1.200&gt;</code>。通过参数 <code>dbname</code> 连接到指定的 PostgreSQL 数据库，如 Heroku，这里作为演示就以默认的数据库 <code>postgres</code> 为例</p>
<p>查看配置系统文件路径</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb105-1"><a href="chap-data-transportation.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="ex">odbcinst</span> <span class="at">-j</span> </span></code></pre></div>
<pre><code>unixODBC 2.3.6
DRIVERS............: /etc/odbcinst.ini
SYSTEM DATA SOURCES: /etc/odbc.ini
FILE DATA SOURCES..: /etc/ODBCDataSources
USER DATA SOURCES..: /root/.odbc.ini
SQLULEN Size.......: 8
SQLLEN Size........: 8
SQLSETPOSIROW Size.: 8</code></pre>
<p>不推荐修改全局配置文件，可设置 <code>ODBCSYSINI</code> 环境变量指定配置文件路径，如 <code>ODBCSYSINI=~/ODBC</code> <a href="http://www.unixodbc.org/odbcinst.html" class="uri">http://www.unixodbc.org/odbcinst.html</a></p>
<p>安装完驱动程序，<code>/etc/odbcinst.ini</code> 文件内容自动更新，我们可以不必修改，如果你想自定义不妨手动修改，我们查看在 R 环境中注册的数据库，可以看到 PostgreSQL 的驱动已经配置好</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">odbc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/odbc/man/odbcListDrivers.html">odbcListDrivers</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>                 name   attribute                                    value
1     PostgreSQL ANSI Description    PostgreSQL ODBC driver (ANSI version)
2     PostgreSQL ANSI      Driver                             psqlodbca.so
3     PostgreSQL ANSI       Setup                          libodbcpsqlS.so
4     PostgreSQL ANSI       Debug                                        0
5     PostgreSQL ANSI     CommLog                                        1
6     PostgreSQL ANSI  UsageCount                                        1
7  PostgreSQL Unicode Description PostgreSQL ODBC driver (Unicode version)
8  PostgreSQL Unicode      Driver                             psqlodbcw.so
9  PostgreSQL Unicode       Setup                          libodbcpsqlS.so
10 PostgreSQL Unicode       Debug                                        0
11 PostgreSQL Unicode     CommLog                                        1
12 PostgreSQL Unicode  UsageCount                                        1</code></pre>
<p>系统配置文件 <code>/etc/odbcinst.ini</code> 已经包含有 PostgreSQL 的驱动配置，无需再重复配置</p>
<pre><code>[PostgreSQL ANSI]
Description=PostgreSQL ODBC driver (ANSI version)
Driver=psqlodbca.so
Setup=libodbcpsqlS.so
Debug=0
CommLog=1
UsageCount=1

[PostgreSQL Unicode]
Description=PostgreSQL ODBC driver (Unicode version)
Driver=psqlodbcw.so
Setup=libodbcpsqlS.so
Debug=0
CommLog=1
UsageCount=1</code></pre>
<p>只需将如下内容存放在 <code>~/.odbc.ini</code> 文件中，</p>
<pre><code>[PostgreSQL]
Driver              = PostgreSQL Unicode
Database            = postgres
Servername          = 172.17.0.1
UserName            = postgres
Password            = default
Port                = 8080</code></pre>
<p>最后，一行命令 DNS 配置连接 <a href="https://github.com/r-dbi/odbc" class="uri">https://github.com/r-dbi/odbc</a> 这样就实现了代码中无任何敏感信息，这里为了展示这个配置过程故而把相关信息公开。</p>
<blockquote>
<p>注意下面的内容需要在容器中运行， Windows 环境下的配置 PostgreSQL 的驱动有点麻烦就不搞了，意义也不大，现在数据库基本都是跑在 Linux 系统上</p>
</blockquote>
<p><code>docker-machine.exe ip default</code> 可以获得本地 Docker 的 IP，比如 192.168.99.101。 Travis 上 <code>ip addr</code> 可以查看 Docker 的 IP，如 172.17.0.1</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span>
<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">RPostgres</span><span class="fu">::</span><span class="fu">Postgres</span><span class="op">(</span><span class="op">)</span>,
  dbname <span class="op">=</span> <span class="st">"postgres"</span>,
  host <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_on_travis</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"DOCKER_HOST_IP"</span><span class="op">)</span>, <span class="st">"192.168.99.101"</span><span class="op">)</span>,
  port <span class="op">=</span> <span class="fl">8080</span>,
  user <span class="op">=</span> <span class="st">"postgres"</span>,
  password <span class="op">=</span> <span class="st">"default"</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span>
<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">odbc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/odbc/man/odbc.html">odbc</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"PostgreSQL"</span><span class="op">)</span></code></pre></div>
<p>列出数据库中的所有表</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbListTables.html">dbListTables</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></code></pre></div>
<p>第一次启动从 Docker Hub 上下载的镜像，默认的数据库是 postgres 里面没有任何表，所以将 R 环境中的 mtcars 数据集写入 postgres 数据库</p>
<p>将数据集 mtcars 写入 PostgreSQL 数据库中，基本操作，写入表的操作也不能缓存，即不能缓存数据库中的表 mtcars</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"mtcars"</span>, <span class="va">mtcars</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>现在可以看到数据表 mtcars 的各个字段</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbListFields.html">dbListFields</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"mtcars"</span><span class="op">)</span></code></pre></div>
<p>最后执行一条 SQL 语句</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT * FROM mtcars WHERE cyl = 4"</span><span class="op">)</span> <span class="co"># 发送 SQL 语句</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="co"># 获取查询结果</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="co"># 清理查询通道</span></code></pre></div>
<p>或者一条命令搞定</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT * FROM mtcars WHERE cyl = 4"</span><span class="op">)</span></code></pre></div>
<p>再复杂一点的 SQL 查询操作</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT cyl, AVG(mpg) AS mpg FROM mtcars GROUP BY cyl ORDER BY cyl"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span>, data <span class="op">=</span> <span class="va">mtcars</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<p>得益于 knitr <span class="citation"><a href="#ref-xie2015" role="doc-biblioref">[10]</a></span> 开发的钩子，这里直接写 SQL 语句块，值得注意的是 SQL 代码块不能启用缓存，数据库连接通道也不能缓存，如果数据库中还没有写入表，那么写入表的操作也不能缓存， <code>tab.cap = "表格标题"</code> 输出的内容是一个表格</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb119-1"><a href="chap-data-transportation.html#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> cyl, <span class="fu">AVG</span>(mpg) <span class="kw">AS</span> mpg <span class="kw">FROM</span> mtcars <span class="kw">GROUP</span> <span class="kw">BY</span> cyl <span class="kw">ORDER</span> <span class="kw">BY</span> cyl</span></code></pre></div>
<p>如果将查询结果导出到变量，在 Chunk 设置 <code>output.var = "agg_cyl"</code> 可以使用缓存，下面将 mpg 按 cyl 分组聚合的结果打印出来，<code>ref.label = "mtcars"</code> 引用上一个 SQL 代码块的内容</p>
<p>这种基于 odbc 的方式的好处就不需要再安装 R 包 RPostgres 和相关系统依赖，最后关闭连接通道</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></code></pre></div>
</div>
<div id="mysql" class="section level3" number="3.4.2">
<h3>
<span class="header-section-number">3.4.2</span> MySQL<a class="anchor" aria-label="anchor" href="#mysql"><i class="fas fa-link"></i></a>
</h3>
<p>MySQL 是一个很常见，应用也很广泛的数据库，数据分析的常见环境是在一个R Notebook 里，我们可以在正文之前先设定数据库连接信息</p>
<pre><code>```{r setup}
library(DBI)
# 指定数据库连接信息
db &lt;- dbConnect(RMySQL::MySQL(),
  dbname = 'dbtest',
  username = 'user_test',
  password = 'password',
  host = '10.10.101.10',
  port = 3306
)
# 创建默认连接
knitr::opts_chunk$set(connection = 'db')
# 设置字符编码，以免中文查询乱码
DBI::dbSendQuery(db, 'SET NAMES utf8')
# 设置日期变量，以运用在SQL中
idate &lt;- '2019-05-03'
```</code></pre>
<p>SQL 代码块中使用 R 环境中的变量，并将查询结果输出为R环境中的数据框</p>
<pre><code>```{sql, output.var='data_output'}
SELECT * FROM user_table where date_format(created_date,'%Y-%m-%d')&gt;=?idate
```</code></pre>
<p>以上代码会将 SQL 的运行结果存在 <code>data_output</code> 这是数据库中，idate 取之前设置的日期<code>2019-05-03</code>，<code>user_table</code> 是 MySQL 数据库中的表名，<code>created_date</code> 是创建<code>user_table</code>时，指定的日期名。</p>
<p>如果 SQL 比较长，为了代码美观，把带有变量的 SQL 保存为<code>demo.sql</code>脚本，只需要在 SQL 的 chunk 中直接读取 SQL 文件<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://d.cosx.org/d/419974" class="uri"&gt;https://d.cosx.org/d/419974&lt;/a&gt;&lt;/p&gt;'><sup>11</sup></a>。</p>
<pre><code>```{sql, code=readLines('demo.sql'), output.var='data_output'}
```</code></pre>
<p>如果我们需要每天或者按照指定的日期重复地运行这个 R Markdown 文件，可以在 YAML 部分引入参数<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://bookdown.org/yihui/rmarkdown/params-knit.html" class="uri"&gt;https://bookdown.org/yihui/rmarkdown/params-knit.html&lt;/a&gt;&lt;/p&gt;'><sup>12</sup></a></p>
<div class="sourceCode" id="cb124"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb124-1"><a href="chap-data-transportation.html#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb124-2"><a href="chap-data-transportation.html#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="an">params:</span></span>
<span id="cb124-3"><a href="chap-data-transportation.html#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co">  date: "2019-05-03"  # 参数化日期</span></span>
<span id="cb124-4"><a href="chap-data-transportation.html#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span></code></pre></div>
<pre><code>```{r setup, include=FALSE}
idate = params$date # 将参数化日期传递给 idate 变量
```</code></pre>
<p>我们将这个 Rmd 文件命名为 <code>MyDocument.Rmd</code>，运行这个文件可以从 R 控制台执行或在 RStudio 点击 knit。</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/render.html">render</a></span><span class="op">(</span><span class="st">"MyDocument.Rmd"</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  date <span class="op">=</span> <span class="st">"2019-05-03"</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<p>如果在文档的 YAML 位置已经指定日期，这里可以不指定。注意在这里设置日期会覆盖 YAML 处指定的参数值，这样做的好处是可以批量化操作。</p>
</div>
<div id="spark" class="section level3" number="3.4.3">
<h3>
<span class="header-section-number">3.4.3</span> Spark<a class="anchor" aria-label="anchor" href="#spark"><i class="fas fa-link"></i></a>
</h3>
<p>当数据分析报告遇上 Spark 时，就需要 <a href="https://github.com/apache/spark/tree/master/R">SparkR</a>、 <a href="https://github.com/rstudio/sparklyr">sparklyr</a>、 <a href="https://github.com/apache/arrow/tree/master/r">arrow</a> 或 <a href="https://github.com/h2oai/sparkling-water/tree/master/r">rsparking</a> 接口了， Javier Luraschi 写了一本书 <a href="https://therinspark.com/">The R in Spark: Learning Apache Spark with R</a> 详细介绍了相关扩展和应用</p>
<p>首先安装 sparklyr 包，RStudio 公司 Javier Lurasch 开发了 sparklyr 包，作为 Spark 与 R 语言之间的接口，安装完 sparklyr 包，还是需要 Spark 和 Hadoop 环境</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'sparklyr'</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://spark.rstudio.com/">sparklyr</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark_install.html">spark_install</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># Installing Spark 2.4.0 for Hadoop 2.7 or later.</span>
<span class="co"># Downloading from:</span>
<span class="co"># - 'https://archive.apache.org/dist/spark/spark-2.4.0/spark-2.4.0-bin-hadoop2.7.tgz'</span>
<span class="co"># Installing to:</span>
<span class="co"># - '~/spark/spark-2.4.0-bin-hadoop2.7'</span>
<span class="co"># trying URL 'https://archive.apache.org/dist/spark/spark-2.4.0/spark-2.4.0-bin-hadoop2.7.tgz'</span>
<span class="co"># Content type 'application/x-gzip' length 227893062 bytes (217.3 MB)</span>
<span class="co"># ==================================================</span>
<span class="co"># downloaded 217.3 MB</span>
<span class="co"># </span>
<span class="co"># Installation complete.</span></code></pre></div>
<p>既然 sparklyr 已经安装了 Spark 和 Hadoop 环境，安装 SparkR 后，只需配置好路径，就可以加载 SparkR 包</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'SparkR'</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>SPARK_HOME <span class="op">=</span> <span class="st">"~/spark/spark-2.4.0-bin-hadoop2.7"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SparkR</span>, lib.loc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span>, <span class="st">"R"</span>, <span class="st">"lib"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">sparkR.session</span><span class="op">(</span>master <span class="op">=</span> <span class="st">"local[*]"</span>, sparkConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>spark.driver.memory <span class="op">=</span> <span class="st">"2g"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><a href="https://github.com/dbdahl/rscala">rscala</a> 架起了 R 和 Scala 两门语言之间交流的桥梁，使得彼此之间可以互相调用</p>
<blockquote>
<p>是否存在这样的可能， Spark 提供了大量的 MLib 库的调用接口，R 的功能支持是最少的，Java/Scala 是原生的，那么要么自己开发新的功能整合到 SparkR 中，要么借助 rscala 将 scala 接口代码封装进来</p>
</blockquote>
<p>在本地，Windows 主机上，可以在 <code>.Rprofile</code> 中给 Spark 添加环境变量 <code>SPARK_HOME</code> 指定其安装路径，</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Windows 平台默认安装路径</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>SPARK_HOME <span class="op">=</span> <span class="st">"C:/Users/XiangYun/AppData/Local/spark/spark-2.4.3-bin-hadoop2.7"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://spark.rstudio.com/">sparklyr</a></span><span class="op">)</span>
<span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark-connections.html">spark_connect</a></span><span class="op">(</span>master <span class="op">=</span> <span class="st">"local"</span>, version <span class="op">=</span> <span class="st">"2.4"</span><span class="op">)</span></code></pre></div>
<p>将 R 环境中的数据集 mtcars 传递到 Spark 上</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/copy_to.html">copy_to</a></span><span class="op">(</span><span class="va">sc</span>, <span class="va">mtcars</span><span class="op">)</span>
<span class="va">cars</span></code></pre></div>
<pre><code># Source: spark&lt;mtcars&gt; [?? x 11]
    mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  21       6   160   110  3.9   2.62  16.5     0     1     4     4
2  21       6   160   110  3.9   2.88  17.0     0     1     4     4
3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1
4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1
5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1
# ... with more rows</code></pre>
<p>监控和分析命令执行的情况，可以在浏览器中，见图 <a href="chap-data-transportation.html#fig:spark-web">3.1</a></p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark_web.html">spark_web</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:spark-web"></span>
<img src="screenshots/spark-start.png" alt="Spark Web 接口" width="960"><p class="caption">
图 3.1: Spark Web 接口
</p>
</div>
<p>传递 SQL 查询语句，比如数据集 mtcars 有多少行</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT count(*) FROM mtcars"</span><span class="op">)</span></code></pre></div>
<pre><code>  count(1)
1       32</code></pre>
<p>进一步地，我们可以调用 dplyr 包来写数据操作，避免写复杂逻辑的 SQL 语句，</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(dplyr) # 数据操作</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="co"># 提供更多功能，包括数据可视化</span>
<span class="fu">count</span><span class="op">(</span><span class="va">cars</span><span class="op">)</span></code></pre></div>
<p>再举一个稍复杂的操作，先从数据集 cars 中选择两个字段 hp 和 mpg</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/select.html">select</a></span><span class="op">(</span><span class="va">cars</span>, <span class="va">hp</span>, <span class="va">mpg</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">sample_n</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># 随机选择 100 行</span>
  <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/collect.html">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># 执行 SQL 查询，将结果返回到本地</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">hp</span>, <span class="va">mpg</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># 绘图</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>数据查询和结果可视化，见图 <a href="chap-data-transportation.html#fig:spark-mtcars">3.2</a></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:spark-mtcars"></span>
<img src="screenshots/spark-mtcars.png" alt="数据聚合和可视化" width="240"><p class="caption">
图 3.2: 数据聚合和可视化
</p>
</div>
<p>用完要记得关闭连接</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark-connections.html">spark_disconnect</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span></code></pre></div>
<div class="rmdwarning">
<p>不要使用 SparkR 接口，要使用 sparklyr， 后者的功能已经全面覆盖前者，生态方面更是更是已经远远超越，它有大厂 RStudio 支持，是公司支持的旗舰项目。但是 sparklyr 的版本稍微比最新的 Spark 低一两个版本，这是开发周期和出于稳定性的考虑，无伤大雅！</p>
</div>
<p>Spark 提供了官方 R 语言接口 SparkR。Spark JVM 和 SparkR 包版本要匹配，比如从 CRAN 上安装了最新版的 SparkR，比如版本 2.4.4 就要去 Spark 官网下载最新版的预编译文件 spark-2.4.4-bin-hadoop2.7，解压到本地磁盘，比如 <code>D:/spark-2.4.4-bin-hadoop2.7</code></p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>SPARK_HOME <span class="op">=</span> <span class="st">"D:/spark-2.4.4-bin-hadoop2.7"</span><span class="op">)</span>
<span class="co"># Sys.setenv(R_HOME = "C:/Program Files/R/R-3.6.1/")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SparkR</span>, lib.loc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span>, <span class="st">"R"</span>, <span class="st">"lib"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">sparkR.session</span><span class="op">(</span>master <span class="op">=</span> <span class="st">"local[*]"</span>, 
               sparkConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>spark.driver.memory <span class="op">=</span> <span class="st">"4g"</span><span class="op">)</span>, 
               enableHiveSupport <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>从数据集 mtcars（数据类型是 R 的 data.frame） 创建 Spark 的 DataFrame 类型数据</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cars</span> <span class="op">&lt;-</span> <span class="fu">as.DataFrame</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>
<span class="co"># 显示 SparkDataFrame 的前几行</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cars</span><span class="op">)</span></code></pre></div>
<pre><code> mpg cyl disp  hp drat    wt  qsec vs am gear carb
1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
<p>打印数据集 cars 的 schema 各个字段的</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">printSchema</span><span class="op">(</span><span class="va">cars</span><span class="op">)</span></code></pre></div>
<pre><code>root
 |-- mpg: double (nullable = true)
 |-- cyl: double (nullable = true)
 |-- disp: double (nullable = true)
 |-- hp: double (nullable = true)
 |-- drat: double (nullable = true)
 |-- wt: double (nullable = true)
 |-- qsec: double (nullable = true)
 |-- vs: double (nullable = true)
 |-- am: double (nullable = true)
 |-- gear: double (nullable = true)
 |-- carb: double (nullable = true)</code></pre>
<p>从本地 JSON 文件创建 DataFrame</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span>, <span class="st">"examples/src/main/resources/people.json"</span><span class="op">)</span>
<span class="va">peopleDF</span> <span class="op">&lt;-</span> <span class="fu">read.json</span><span class="op">(</span><span class="va">path</span><span class="op">)</span>
<span class="fu">printSchema</span><span class="op">(</span><span class="va">peopleDF</span><span class="op">)</span></code></pre></div>
<pre><code>root
 |-- age: long (nullable = true)
 |-- name: string (nullable = true)</code></pre>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">peopleDF</span></code></pre></div>
<pre><code>SparkDataFrame[age:bigint, name:string]</code></pre>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">showDF</span><span class="op">(</span><span class="va">peopleDF</span><span class="op">)</span></code></pre></div>
<pre><code>+----+-------+
| age|   name|
+----+-------+
|null|Michael|
|  30|   Andy|
|  19| Justin|
+----+-------+</code></pre>
<p>peopleDF 转成 Hive 中的表 people</p>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">createOrReplaceTempView</span><span class="op">(</span><span class="va">peopleDF</span>, <span class="st">"people"</span><span class="op">)</span></code></pre></div>
<p>调用 <code>sql</code> 传递 SQL 语句查询数据，启动 <code>sparkR.session</code> 时，设置 <code>enableHiveSupport = TRUE</code>，就是执行不出来，报错，不知道哪里配置存在问题</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">teenagers</span> <span class="op">&lt;-</span> <span class="fu">SparkR</span><span class="fu">::</span><span class="fu">sql</span><span class="op">(</span><span class="st">"SELECT name FROM people WHERE age &gt;= 13 AND age &lt;= 19"</span><span class="op">)</span>
<span class="fu">show</span><span class="op">(</span><span class="va">people</span><span class="op">)</span></code></pre></div>
<pre><code>Error in handleErrors(returnStatus, conn) : 
  org.apache.spark.sql.AnalysisException: java.lang.RuntimeException: java.io.IOException: (null) entry in command string: null chmod 0733 F:\tmp\hive;
    at org.apache.spark.sql.hive.HiveExternalCatalog.withClient(HiveExternalCatalog.scala:106)
    at org.apache.spark.sql.hive.HiveExternalCatalog.databaseExists(HiveExternalCatalog.scala:214)
    at org.apache.spark.sql.internal.SharedState.externalCatalog$lzycompute(SharedState.scala:114)
    at org.apache.spark.sql.internal.SharedState.externalCatalog(SharedState.scala:102)
    at org.apache.spark.sql.internal.SharedState.globalTempViewManager$lzycompute(SharedState.scala:141)
    at org.apache.spark.sql.internal.SharedState.globalTempViewManager(SharedState.scala:136)
    at org.apache.spark.sql.hive.HiveSessionStateBuilder$$anonfun$2.apply(HiveSessionStateBuilder.scala:55)
    at org.apache.spark.sql.hive.HiveSessionStateBuilder$$anonfun$2.apply(HiveSessionStateBuilder.scala:55)
    at org.apache.spark.sql.catalyst.catalog.SessionCatalog.gl</code></pre>
<p>调用 <code>collect</code> 函数执行查询，并将结果返回到本地 <code>data.frame</code> 类型</p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">teenagersLocalDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/collect.html">collect</a></span><span class="op">(</span><span class="va">teenagers</span><span class="op">)</span></code></pre></div>
<p>查看数据集 teenagersLocalDF 的属性</p>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">teenagersLocalDF</span><span class="op">)</span></code></pre></div>
<p>最后，关闭 SparkSession 会话</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">sparkR.session.stop</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="batch-import-data" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> 批量导入数据<a class="anchor" aria-label="anchor" href="#batch-import-data"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">read_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">list_of_datasets</span>, <span class="va">read_func</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">read_and_assign</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span>, <span class="va">read_func</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">dataset_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.name</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>
    <span class="va">dataset_name</span> <span class="op">&lt;-</span> <span class="fu">read_func</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="co"># invisible is used to suppress the unneeded output</span>
  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">list_of_datasets</span>,
      <span class="va">read_and_assign</span>,
      read_func <span class="op">=</span> <span class="va">read_func</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span>, USE.NAMES <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
  <span class="op">)</span>

  <span class="co"># Remove the extension at the end of the data set names</span>
  <span class="va">names_of_datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">list_of_datasets</span>, <span class="st">"[.]"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">names_of_datasets</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>批量导入文件扩展名为 <code>.csv</code> 的数据文件，即逗号分割的文件</p>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"path/to/csv/dir"</span>,
                         pattern <span class="op">=</span> <span class="st">".csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">data_files</span><span class="op">)</span></code></pre></div>
<p>相比于 Base R 提供的 <code>read.csv</code> 函数，使用 readr 包的 <code>read_csv</code> 函数可以更快地读取csv格式文件，特别是在读取GB级数据文件时，效果特别明显。</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">list_of_data_sets</span> <span class="op">&lt;-</span> <span class="fu">read_list</span><span class="op">(</span><span class="va">data_files</span>, <span class="fu">readr</span><span class="fu">::</span><span class="va"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">)</span></code></pre></div>
<p>使用 tibble 包的<code>glimpse</code>函数可以十分方便地对整个数据集有一个大致的了解，展示方式和信息量相当于 <code>str</code> 加 <code>head</code> 函数</p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">list_of_data_sets</span><span class="op">)</span></code></pre></div>
</div>
<div id="batch-export-data" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> 批量导出数据<a class="anchor" aria-label="anchor" href="#batch-export-data"><i class="fas fa-link"></i></a>
</h2>
<p>假定我们有一个列表，其每个元素都是一个数据框，现在要把每个数据框分别存入 xlsx 表的工作薄中，以 mtcars 数据集为例，将其按分类变量 cyl 分组拆分，获得一个列表 list</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span>
<span class="va">dat</span></code></pre></div>
<pre><code>## $`4`
##                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Datsun 710     22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## Merc 240D      24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## Merc 230       22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## Fiat 128       32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## Honda Civic    30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## Toyota Corolla 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## Toyota Corona  21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## Fiat X1-9      27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## Porsche 914-2  26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## Lotus Europa   30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## Volvo 142E     21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
## 
## $`6`
##                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4      21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag  21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## Hornet 4 Drive 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## Valiant        18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## Merc 280       19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## Merc 280C      17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## Ferrari Dino   19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
## 
## $`8`
##                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
## Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8</code></pre>
<p>将 xlsx 表格初始化，创建空白的工作薄， <a href="https://github.com/awalker89/openxlsx">openxlsx</a> 包不依赖 Java 环境，读写效率也高</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 加载 openxlsx 包</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ycphs.github.io/openxlsx/index.html">openxlsx</a></span><span class="op">)</span>
<span class="co">## 创建空白的工作薄</span>
<span class="va">wb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/createWorkbook.html">createWorkbook</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>将列表里的每张表分别存入 xlsx 表格的每个 worksheet，worksheet 的名字就是分组变量的名字</p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">name</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/addWorksheet.html">addWorksheet</a></span><span class="op">(</span><span class="va">wb</span>, <span class="va">name</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/writeData.html">writeData</a></span><span class="op">(</span><span class="va">wb</span>, <span class="va">name</span>, <span class="va">data</span><span class="op">)</span>
 
<span class="op">}</span>, <span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/names.html">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>最后保存数据到磁盘，见图 <a href="chap-data-transportation.html#fig:batch-export-xlsx">3.3</a></p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/saveWorkbook.html">saveWorkbook</a></span><span class="op">(</span><span class="va">wb</span>, file <span class="op">=</span> <span class="st">"data/matcars.xlsx"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:batch-export-xlsx"></span>
<img src="screenshots/dm-batch-export-xlsx.png" alt="批量导出数据" width="614"><p class="caption">
图 3.3: 批量导出数据
</p>
</div>
</div>
<div id="export-data" class="section level2" number="3.7">
<h2>
<span class="header-section-number">3.7</span> 导出数据<a class="anchor" aria-label="anchor" href="#export-data"><i class="fas fa-link"></i></a>
</h2>
<div id="export-output" class="section level3" number="3.7.1">
<h3>
<span class="header-section-number">3.7.1</span> 导出运行结果<a class="anchor" aria-label="anchor" href="#export-output"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="va">...</span>, file <span class="op">=</span> <span class="cn">NULL</span>, append <span class="op">=</span> <span class="cn">FALSE</span>,
               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"output"</span>, <span class="st">"message"</span><span class="op">)</span>, split <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><code>capture.output</code> 将一段R代码执行结果，保存到文件，参数为表达式。<code>capture.output</code> 和 <code>sink</code> 的关系相当于 <code>with</code> 和 <code>attach</code> 的关系。</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">glmout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">case</span> <span class="op">~</span> <span class="va">spontaneous</span> <span class="op">+</span> <span class="va">induced</span>,
  data <span class="op">=</span> <span class="va">infert</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">"data/capture.txt"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">2</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "[1] 2" "[1] 4"</code></pre>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="fl">2</span> <span class="op">+</span> <span class="fl">2</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "[1] 4"</code></pre>
<p><code>sink</code> 函数将控制台输出结果保存到文件，只将 <code>outer</code> 函数运行的结果保存到 <code>ex-sink.txt</code> 文件，outer 函数计算的是直积，在这里相当于 <code>seq(10) %*% t(seq(10))</code>，而在 R 语言中，更加有效的计算方式是 <code><a href="https://rdrr.io/r/base/crossprod.html">tcrossprod(seq(10),seq(10))</a></code></p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sink.html">sink</a></span><span class="op">(</span><span class="st">"data/ex-sink.txt"</span><span class="op">)</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
<span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">i</span>, <span class="st">"*"</span><span class="op">)</span> </code></pre></div>
<pre><code>##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
##  [1,]    1    2    3    4    5    6    7    8    9    10
##  [2,]    2    4    6    8   10   12   14   16   18    20
##  [3,]    3    6    9   12   15   18   21   24   27    30
##  [4,]    4    8   12   16   20   24   28   32   36    40
##  [5,]    5   10   15   20   25   30   35   40   45    50
##  [6,]    6   12   18   24   30   36   42   48   54    60
##  [7,]    7   14   21   28   35   42   49   56   63    70
##  [8,]    8   16   24   32   40   48   56   64   72    80
##  [9,]    9   18   27   36   45   54   63   72   81    90
## [10,]   10   20   30   40   50   60   70   80   90   100</code></pre>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sink.html">sink</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<!-- 记得删除文件 capture.txt 和 ex-sink.txt -->
</div>
<div id="export-data-object" class="section level3" number="3.7.2">
<h3>
<span class="header-section-number">3.7.2</span> 导出数据对象<a class="anchor" aria-label="anchor" href="#export-data-object"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="va">file</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">...</span>, list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,
     file <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"'file' must be specified"</span><span class="op">)</span>,
     ascii <span class="op">=</span> <span class="cn">FALSE</span>, version <span class="op">=</span> <span class="cn">NULL</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span><span class="op">(</span><span class="op">)</span>,
     compress <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="op">!</span><span class="va">ascii</span><span class="op">)</span>, <span class="va">compression_level</span>,
     eval.promises <span class="op">=</span> <span class="cn">TRUE</span>, precheck <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">".RData"</span>, version <span class="op">=</span> <span class="cn">NULL</span>, ascii <span class="op">=</span> <span class="cn">FALSE</span>,
           compress <span class="op">=</span> <span class="op">!</span><span class="va">ascii</span>, safe <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><code>load</code> 和<code>save</code> 函数加载或保存包含工作环境信息的数据对象，<code>save.image</code> 保存当前工作环境到磁盘，即保存工作空间中所有数据对象，数据格式为 <code>.RData</code>，即相当于</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span>all.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">".RData"</span>, envir <span class="op">=</span> <span class="va">.GlobalEnv</span><span class="op">)</span></code></pre></div>
<p><code>dump</code> 保存数据对象 AirPassengers 到文件 <code>AirPassengers.txt</code>，文件内容是 R 命令，可把<code>AirPassengers.txt</code>看作代码文档执行，dput 保存数据对象内容到文件<code>AirPassengers.dat</code>，文件中不包含变量名 AirPassengers。注意到 <code>dump</code> 输入是一个字符串，而 <code>dput</code> 要求输入数据对象的名称，<code>source</code> 函数与 <code>dump</code> 对应，而 <code>dget</code> 与 <code>dput</code>对应。</p>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 加载数据</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">AirPassengers</span>, package <span class="op">=</span> <span class="st">"datasets"</span><span class="op">)</span>
<span class="co"># 将数据以R代码块的形式保存到文件</span>
<span class="fu"><a href="https://rdrr.io/r/base/dump.html">dump</a></span><span class="op">(</span><span class="st">'AirPassengers'</span>, file <span class="op">=</span> <span class="st">'data/AirPassengers.txt'</span><span class="op">)</span> 
<span class="co"># source(file = 'data/AirPassengers.txt')</span></code></pre></div>
<p>接下来，我们读取 <code>AirPassengers.txt</code> 的文件内容，可见它是一段完整的 R 代码，可以直接复制到 R 的控制台中运行，并且得到一个与原始 AirPassengers 变量一样的结果</p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="st">'data/AirPassengers.txt'</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></code></pre></div>
<pre><code>## AirPassengers &lt;-
## structure(c(112, 118, 132, 129, 121, 135, 148, 148, 136, 119, 
## 104, 118, 115, 126, 141, 135, 125, 149, 170, 170, 158, 133, 114, 
## 140, 145, 150, 178, 163, 172, 178, 199, 199, 184, 162, 146, 166, 
## 171, 180, 193, 181, 183, 218, 230, 242, 209, 191, 172, 194, 196, 
## 196, 236, 235, 229, 243, 264, 272, 237, 211, 180, 201, 204, 188, 
## 235, 227, 234, 264, 302, 293, 259, 229, 203, 229, 242, 233, 267, 
## 269, 270, 315, 364, 347, 312, 274, 237, 278, 284, 277, 317, 313, 
## 318, 374, 413, 405, 355, 306, 271, 306, 315, 301, 356, 348, 355, 
## 422, 465, 467, 404, 347, 305, 336, 340, 318, 362, 348, 363, 435, 
## 491, 505, 404, 359, 310, 337, 360, 342, 406, 396, 420, 472, 548, 
## 559, 463, 407, 362, 405, 417, 391, 419, 461, 472, 535, 622, 606, 
## 508, 461, 390, 432), .Tsp = c(1949, 1960.9166666666699, 12), class = "ts")</code></pre>
<p><code>dput</code> 函数类似 <code>dump</code> 函数，保存数据对象到磁盘文件</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 将 R 对象保存/导出到磁盘</span>
<span class="fu"><a href="https://rdrr.io/r/base/dput.html">dput</a></span><span class="op">(</span><span class="va">AirPassengers</span>, file <span class="op">=</span> <span class="st">'data/AirPassengers.dat'</span><span class="op">)</span>
<span class="va">AirPassengers</span></code></pre></div>
<pre><code>     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
1949 112 118 132 129 121 135 148 148 136 119 104 118
1950 115 126 141 135 125 149 170 170 158 133 114 140
1951 145 150 178 163 172 178 199 199 184 162 146 166
1952 171 180 193 181 183 218 230 242 209 191 172 194
1953 196 196 236 235 229 243 264 272 237 211 180 201
1954 204 188 235 227 234 264 302 293 259 229 203 229
1955 242 233 267 269 270 315 364 347 312 274 237 278
1956 284 277 317 313 318 374 413 405 355 306 271 306
1957 315 301 356 348 355 422 465 467 404 347 305 336
1958 340 318 362 348 363 435 491 505 404 359 310 337
1959 360 342 406 396 420 472 548 559 463 407 362 405
1960 417 391 419 461 472 535 622 606 508 461 390 432</code></pre>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dget 作用与 dput 相反</span>
<span class="va">AirPassengers2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dput.html">dget</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'data/AirPassengers.dat'</span><span class="op">)</span>
<span class="va">AirPassengers2</span></code></pre></div>
<pre><code>     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
1949 112 118 132 129 121 135 148 148 136 119 104 118
1950 115 126 141 135 125 149 170 170 158 133 114 140
1951 145 150 178 163 172 178 199 199 184 162 146 166
1952 171 180 193 181 183 218 230 242 209 191 172 194
1953 196 196 236 235 229 243 264 272 237 211 180 201
1954 204 188 235 227 234 264 302 293 259 229 203 229
1955 242 233 267 269 270 315 364 347 312 274 237 278
1956 284 277 317 313 318 374 413 405 355 306 271 306
1957 315 301 356 348 355 422 465 467 404 347 305 336
1958 340 318 362 348 363 435 491 505 404 359 310 337
1959 360 342 406 396 420 472 548 559 463 407 362 405
1960 417 391 419 461 472 535 622 606 508 461 390 432</code></pre>
<p>同样地，现在我们观察 <code>dput</code> 函数保存的文件 <code>AirPassengers.dat</code> 内容，和<code>dump</code> 函数保存的文件 <code>AirPassengers.txt</code>相比，就缺一个赋值变量</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="st">'data/AirPassengers.dat'</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></code></pre></div>
<pre><code><a href="https://rdrr.io/r/base/structure.html">structure(c(112, 118, 132, 129, 121, 135, 148, 148, 136, 119, 
104, 118, 115, 126, 141, 135, 125, 149, 170, 170, 158, 133, 114, 
140, 145, 150, 178, 163, 172, 178, 199, 199, 184, 162, 146, 166, 
171, 180, 193, 181, 183, 218, 230, 242, 209, 191, 172, 194, 196, 
196, 236, 235, 229, 243, 264, 272, 237, 211, 180, 201, 204, 188, 
235, 227, 234, 264, 302, 293, 259, 229, 203, 229, 242, 233, 267, 
269, 270, 315, 364, 347, 312, 274, 237, 278, 284, 277, 317, 313, 
318, 374, 413, 405, 355, 306, 271, 306, 315, 301, 356, 348, 355, 
422, 465, 467, 404, 347, 305, 336, 340, 318, 362, 348, 363, 435, 
491, 505, 404, 359, 310, 337, 360, 342, 406, 396, 420, 472, 548, 
559, 463, 407, 362, 405, 417, 391, 419, 461, 472, 535, 622, 606, 
508, 461, 390, 432), .Tsp = c(1949, 1960.91666666667, 12), class = "ts")</a></code></pre>
<!-- 记得删除文件 AirPassengers.txt 和 AirPassengers.dat -->
<p><a href="https://github.com/ycphs/openxlsx">openxlsx</a> 可以读写 XLSX 文档</p>
<p>美团使用的大数据工具有很多，最常用的 Hive、Spark、Kylin、Impala、Presto 等，详见 <a href="https://tech.meituan.com/2018/08/02/mt-r-practice.html" class="uri">https://tech.meituan.com/2018/08/02/mt-r-practice.html</a>。下面主要介绍如何在 R 中连接 MySQL、Presto 和 Spark。</p>
<p><a href="https://github.com/r-spark/sparklyr.flint">sparklyr.flint</a> 支持 Spark 的时间序列库 <a href="https://github.com/twosigma/flint">flint</a>，<a href="https://github.com/rstudio/sparkxgb">sparkxgb</a> 为 Spark 上的 XGBoost 提供 R 接口，<a href="https://github.com/r-spark/sparkwarc">sparkwarc</a> 支持加载 Web ARChive 文件到 Spark 里
<a href="https://github.com/chezou/sparkavro">sparkavro</a> 支持从 Apache Avro (<a href="https://avro.apache.org/" class="uri">https://avro.apache.org/</a>) 读取文件到 Spark 里，<a href="https://github.com/miraisolutions/sparkbq">sparkbq</a> 是一个 sparkly 扩展包，集成 Google BigQuery 服务，<a href="https://github.com/harryprince/geospark">geospark</a> 提供 GeoSpark 库的 R 接口，并且以 sf 的数据操作方式，<a href="https://github.com/h2oai/sparkling-water/tree/master/r">rsparkling</a> H2O Sparkling Water 机器学习库的 R 接口。</p>
<p>Spark 性能优化，参考三篇博文</p>
<ul>
<li><a href="https://tech.meituan.com/2016/03/31/spark-in-meituan.html">Spark在美团的实践</a></li>
<li><a href="https://tech.meituan.com/2016/04/29/spark-tuning-basic.html">Spark性能优化指南——基础篇</a></li>
<li><a href="https://tech.meituan.com/2016/05/12/spark-tuning-pro.html">Spark性能优化指南——高级篇</a></li>
</ul>
<p>其他材料</p>
<ul>
<li>朱俊晖收集的 Spark 资源列表 <a href="https://github.com/harryprince/awesome-sparklyr" class="uri">https://github.com/harryprince/awesome-sparklyr</a>，推荐使用 sparklyr <a href="https://github.com/sparklyr/sparklyr" class="uri">https://github.com/sparklyr/sparklyr</a> 连接 Spark</li>
<li>Spark 与 R 语言 <a href="https://docs.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/" class="uri">https://docs.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/</a>
</li>
<li>Mastering Spark with R <a href="https://therinspark.com/" class="uri">https://therinspark.com/</a>
</li>
</ul>
</div>
</div>
<div id="sec-spark-with-r" class="section level2" number="3.8">
<h2>
<span class="header-section-number">3.8</span> Spark 与 R 语言<a class="anchor" aria-label="anchor" href="#sec-spark-with-r"><i class="fas fa-link"></i></a>
</h2>
<div id="subsec-sparklyr" class="section level3" number="3.8.1">
<h3>
<span class="header-section-number">3.8.1</span> sparklyr<a class="anchor" aria-label="anchor" href="#subsec-sparklyr"><i class="fas fa-link"></i></a>
</h3>
<div class="rmdwarn">
<p>Spark 依赖特定版本的 Java、Hadoop，三者之间的版本应该要相融。</p>
</div>
<p>在 MacOS 上配置 Java 环境，注意 Spark 仅支持 Java 8 至 11，所以安装指定版本的 Java 开发环境</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb184-1"><a href="chap-data-transportation.html#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 安装 openjdk 11</span></span>
<span id="cb184-2"><a href="chap-data-transportation.html#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install openjdk@11</span>
<span id="cb184-3"><a href="chap-data-transportation.html#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 全局设置 JDK 11</span></span>
<span id="cb184-4"><a href="chap-data-transportation.html#cb184-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-sfn</span> /usr/local/opt/openjdk@11/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-11.jdk</span>
<span id="cb184-5"><a href="chap-data-transportation.html#cb184-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Java 11 JDK 添加到 .zshrc </span></span>
<span id="cb184-6"><a href="chap-data-transportation.html#cb184-6" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">CPPFLAGS</span><span class="op">=</span><span class="st">"-I/usr/local/opt/openjdk@11/include"</span></span>
<span id="cb184-7"><a href="chap-data-transportation.html#cb184-7" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span><span class="st">"/usr/local/opt/openjdk@11/bin:</span><span class="va">$PATH</span><span class="st">"</span></span></code></pre></div>
<p>配置 R 环境，让 R 能够识别 Java 环境，再安装 <strong>rJava</strong> 包</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb185-1"><a href="chap-data-transportation.html#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 配置</span></span>
<span id="cb185-2"><a href="chap-data-transportation.html#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> R CMD javareconf</span>
<span id="cb185-3"><a href="chap-data-transportation.html#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 系统软件依赖</span></span>
<span id="cb185-4"><a href="chap-data-transportation.html#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install pcre2</span>
<span id="cb185-5"><a href="chap-data-transportation.html#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 安装 rJava</span></span>
<span id="cb185-6"><a href="chap-data-transportation.html#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">'install.packages("rJava", type="source")'</span></span></code></pre></div>
<p>最后安装 <strong>sparklyr</strong> 包，以及 Spark 环境，可以借助 <code><a href="https://rdrr.io/pkg/sparklyr/man/spark_install.html">spark_install()</a></code> 安装 Spark，比如下面 Spark 3.0 连同 hadoop 2.7 一起安装。</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'sparklyr'</span><span class="op">)</span>
<span class="fu">sparklyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark_install.html">spark_install</a></span><span class="op">(</span>version <span class="op">=</span> <span class="st">'3.0'</span>, hadoop_version <span class="op">=</span> <span class="st">'2.7'</span><span class="op">)</span></code></pre></div>
<p>也可以先手动下载 Spark 软件环境，建议选择就近镜像站点下载，比如在北京选择清华站点
<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/spark/spark-3.0.1/spark-3.0.1-bin-hadoop2.7.tgz" class="uri">https://mirrors.tuna.tsinghua.edu.cn/apache/spark/spark-3.0.1/spark-3.0.1-bin-hadoop2.7.tgz</a>，此环境自带 R 和 Python 接口。为了供 sparklyr 调用，先设置 <code>SPARK_HOME</code> 环境变量指向 Spark 安装位置，再连接单机版 Spark。</p>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 排错 https://github.com/sparklyr/sparklyr/issues/2827</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>sparklyr.log.console <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># 连接 Spark </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://spark.rstudio.com/">sparklyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark-connections.html">spark_connect</a></span><span class="op">(</span>
  master <span class="op">=</span> <span class="st">"local"</span>,
  <span class="co"># config = list(sparklyr.gateway.address = "127.0.0.1"),</span>
  spark_home <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span>
<span class="op">)</span>
<span class="co"># diamonds 数据集导入 Spark</span>
<span class="va">diamonds_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/copy_to.html">copy_to</a></span><span class="op">(</span><span class="va">sc</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">diamonds</a></span>, <span class="st">"diamonds"</span><span class="op">)</span></code></pre></div>
<p>做数据的聚合统计，有两种方式。一种是使用用 R 包 dplyr 提供的数据操作语法，下面以按 cut 分组统计钻石的数量为例，说明 dplyr 提供的数据操作方式。</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co"># 列出数据源下所有的表 tbls</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/src_tbls.html">src_tbls</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span>

<span class="va">diamonds_tbl</span> <span class="op">&lt;-</span> <span class="va">diamonds_tbl</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cut</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>cnt <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">collect</span></code></pre></div>
<p>另一种是使用结构化查询语言 SQL，这自不必说，大多数情况下，使用和一般的 SQL 没什么两样。</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span>
<span class="va">diamonds_preview</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT count(*) as cnt, cut FROM diamonds GROUP BY cut"</span><span class="op">)</span>
<span class="va">diamonds_preview</span></code></pre></div>
<pre><code>##     cnt       cut
## 1 21551     Ideal
## 2 13791   Premium
## 3  4906      Good
## 4  1610      Fair
## 5 12082 Very Good</code></pre>
<div class="columns">
<div class="column" style="width:47.5%;">
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># SQL 中的 AVG 和 R 中的 mean 函数是类似的</span>
<span class="va">diamonds_price</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT AVG(price) as mean_price, cut FROM diamonds GROUP BY cut"</span><span class="op">)</span>
<span class="va">diamonds_price</span></code></pre></div>
<pre><code>##   mean_price       cut
## 1   3457.542     Ideal
## 2   4584.258   Premium
## 3   3928.864      Good
## 4   4358.758      Fair
## 5   3981.760 Very Good</code></pre>
</div>
<div class="column" style="width:5%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div>
<div class="column" style="width:47.5%;">
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="va">diamonds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span>
<span class="va">diamonds</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>mean_price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">price</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cut</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##          cut mean_price
## 1:     Ideal   3457.542
## 2:   Premium   4584.258
## 3:      Good   3928.864
## 4: Very Good   3981.760
## 5:      Fair   4358.758</code></pre>
</div>
</div>
<p>将结果数据用 ggplot2 呈现出来</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">diamonds_preview</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">cnt</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="data-transportation_files/figure-html/unnamed-chunk-75-1.png" width="672" style="display: block; margin: auto;"></div>
<p>diamonds 数据集总共 53940 条数据，下面用 BUCKET 分桶抽样，将原数据随机分成 1000 个桶，取其中的一个桶，由于是随机分桶，所以每次的结果都不一样，解释详见<a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-sampling.html" class="uri">https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-sampling.html</a></p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT * FROM diamonds TABLESAMPLE (BUCKET 1 OUT OF 1000) LIMIT 6"</span><span class="op">)</span>
<span class="va">diamonds_sample</span></code></pre></div>
<pre><code>##   carat       cut color clarity depth table price    x    y    z
## 1  0.70      Good     F     VS1  62.8    61  2810 5.57 5.61 3.51
## 2  0.79   Premium     E     VS2  59.4    60  3230 6.08 6.05 3.60
## 3  0.80     Ideal     E     SI1  61.5    58  3362 5.96 6.00 3.68
## 4  1.01   Premium     H     SI1  59.2    58  3417 6.58 6.56 3.89
## 5  0.75     Ideal     E     VS1  62.5    57  3555 5.80 5.85 3.64
## 6  0.91 Very Good     I     VS2  61.0    57  3664 6.20 6.26 3.80</code></pre>
<p>将抽样的结果用窗口函数 <code>RANK()</code> 排序，详见 <a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html" class="uri">https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html</a></p>
<p>窗口函数 <a href="https://www.cnblogs.com/ZackSun/p/9713435.html" class="uri">https://www.cnblogs.com/ZackSun/p/9713435.html</a></p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds_rank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"
  SELECT cut, price, RANK() OVER (PARTITION BY cut ORDER BY price) AS rank 
  FROM diamonds TABLESAMPLE (BUCKET 1 OUT OF 1000)
  LIMIT 6
"</span><span class="op">)</span>
<span class="va">diamonds_rank</span></code></pre></div>
<pre><code>##    cut price rank
## 1 Fair   938    1
## 2 Fair  1799    2
## 3 Fair  3105    3
## 4 Good   761    1
## 5 Good  1408    2
## 6 Good  1915    3</code></pre>
<p>LATERAL VIEW 把一列拆成多行</p>
<p><a href="https://liam.page/2020/03/09/LATERAL-VIEW-in-Hive-SQL/" class="uri">https://liam.page/2020/03/09/LATERAL-VIEW-in-Hive-SQL/</a>
<a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-lateral-view.html" class="uri">https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-lateral-view.html</a></p>
<p>创建数据集</p>
<div class="sourceCode" id="cb200"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 先删除存在的表 person</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"DROP TABLE IF EXISTS person"</span><span class="op">)</span>
<span class="co"># 创建表 person</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"CREATE TABLE IF NOT EXISTS person (id INT, name STRING, age INT, class INT, address STRING)"</span><span class="op">)</span>
<span class="co"># 插入数据到表 person</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"
INSERT INTO person VALUES
    (100, 'John', 30, 1, 'Street 1'),
    (200, 'Mary', NULL, 1, 'Street 2'),
    (300, 'Mike', 80, 3, 'Street 3'),
    (400, 'Dan', 50, 4, 'Street 4')
"</span><span class="op">)</span></code></pre></div>
<p>查看数据集</p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT * FROM person"</span><span class="op">)</span></code></pre></div>
<pre><code>##    id name age class  address
## 1 100 John  30     1 Street 1
## 2 200 Mary  NA     1 Street 2
## 3 300 Mike  80     3 Street 3
## 4 400  Dan  50     4 Street 4</code></pre>
<p>行列转换 <a href="https://www.cnblogs.com/kimbo/p/6208973.html" class="uri">https://www.cnblogs.com/kimbo/p/6208973.html</a>，LATERAL VIEW 展开</p>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>,<span class="st">"
SELECT * FROM person
    LATERAL VIEW EXPLODE(ARRAY(30, 60)) tabelName AS c_age
    LATERAL VIEW EXPLODE(ARRAY(40, 80)) AS d_age
LIMIT 6
"</span><span class="op">)</span></code></pre></div>
<pre><code>##    id name age class  address c_age d_age
## 1 100 John  30     1 Street 1    30    40
## 2 100 John  30     1 Street 1    30    80
## 3 100 John  30     1 Street 1    60    40
## 4 100 John  30     1 Street 1    60    80
## 5 200 Mary  NA     1 Street 2    30    40
## 6 200 Mary  NA     1 Street 2    30    80</code></pre>
<p>日期相关的函数 <a href="https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html#date-and-timestamp-functions" class="uri">https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html#date-and-timestamp-functions</a></p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 今天</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"select current_date"</span><span class="op">)</span></code></pre></div>
<pre><code>##   current_date()
## 1     2021-09-06</code></pre>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 昨天</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"select date_sub(current_date, 1)"</span><span class="op">)</span></code></pre></div>
<pre><code>##   date_sub(current_date(), 1)
## 1                  2021-09-05</code></pre>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 本月最后一天 current_date 所属月份的最后一天</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"select last_day(current_date)"</span><span class="op">)</span></code></pre></div>
<pre><code>##   last_day(current_date())
## 1               2021-09-30</code></pre>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 星期几</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"select dayofweek(current_date)"</span><span class="op">)</span></code></pre></div>
<pre><code>##   dayofweek(current_date())
## 1                         2</code></pre>
<p>最后，使用完记得关闭 Spark 连接</p>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark-connections.html">spark_disconnect</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span></code></pre></div>
</div>
<div id="subsec-sparkr" class="section level3" number="3.8.2">
<h3>
<span class="header-section-number">3.8.2</span> SparkR<a class="anchor" aria-label="anchor" href="#subsec-sparkr"><i class="fas fa-link"></i></a>
</h3>
<div class="rmdnote">
<p>考虑到和第<a href="chap-data-transportation.html#subsec-sparklyr">3.8.1</a>节的重合性，以及 sparklyr 的优势，本节代码都不会执行，仅作为补充信息予以描述。完整的介绍见 <a href="https://spark.apache.org/docs/latest/sparkr.html#running-sql-queries-from-sparkr">SparkR 包</a></p>
</div>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>SPARK_HOME <span class="op">=</span> <span class="st">"/opt/spark/spark-3.0.1-bin-hadoop2.7"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SparkR</span>, lib.loc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span>, <span class="st">"R"</span>, <span class="st">"lib"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">sparkR.session</span><span class="op">(</span>master <span class="op">=</span> <span class="st">"local[*]"</span>, sparkConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>spark.driver.memory <span class="op">=</span> <span class="st">"2g"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="rmdwarn">
<p><strong>SparkR</strong> 要求 Java 版本满足：大于等于8，而小于12，本地 MacOS 安装高版本，比如 oracle-jdk 16.0.1 会报不兼容的错误。</p>
<pre><code>Spark package found in SPARK_HOME: /opt/spark/spark-3.1.1-bin-hadoop3.2
Error in checkJavaVersion() : 
  Java version, greater than or equal to 8 and less than 12, is required for this package; found version: 16.0.1</code></pre>
</div>
<p><code>sparkConfig</code> 有哪些参数可以传递</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">Property Name</th>
<th align="left">Property group</th>
<th align="left">
<code>spark-submit</code> equivalent</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>spark.master</code></td>
<td align="left">Application Properties</td>
<td align="left"><code>--master</code></td>
</tr>
<tr class="even">
<td align="left"><code>spark.kerberos.keytab</code></td>
<td align="left">Application Properties</td>
<td align="left"><code>--keytab</code></td>
</tr>
<tr class="odd">
<td align="left"><code>spark.kerberos.principal</code></td>
<td align="left">Application Properties</td>
<td align="left"><code>--principal</code></td>
</tr>
<tr class="even">
<td align="left"><code>spark.driver.memory</code></td>
<td align="left">Application Properties</td>
<td align="left"><code>--driver-memory</code></td>
</tr>
<tr class="odd">
<td align="left"><code>spark.driver.extraClassPath</code></td>
<td align="left">Runtime Environment</td>
<td align="left"><code>--driver-class-path</code></td>
</tr>
<tr class="even">
<td align="left"><code>spark.driver.extraJavaOptions</code></td>
<td align="left">Runtime Environment</td>
<td align="left"><code>--driver-java-options</code></td>
</tr>
<tr class="odd">
<td align="left"><code>spark.driver.extraLibraryPath</code></td>
<td align="left">Runtime Environment</td>
<td align="left"><code>--driver-library-path</code></td>
</tr>
</tbody>
</table></div>
<p>将 data.frame 转化为 SparkDataFrame</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">faithful_sdf</span> <span class="op">&lt;-</span> <span class="fu">as.DataFrame</span><span class="op">(</span><span class="va">faithful</span><span class="op">)</span></code></pre></div>
<p>SparkDataFrame</p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">faithful_sdf</span><span class="op">)</span></code></pre></div>
<p>查看结构</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">faithful_sdf</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="sec-database-with-r" class="section level2" number="3.9">
<h2>
<span class="header-section-number">3.9</span> 数据库与 R 语言<a class="anchor" aria-label="anchor" href="#sec-database-with-r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/prestodb/presto">Presto</a> 的 R 接口 <a href="https://github.com/prestodb/RPresto" class="uri">https://github.com/prestodb/RPresto</a> 和文档 <a href="https://prestodb.io/docs/current/index.html" class="uri">https://prestodb.io/docs/current/index.html</a>，Presto 数据库</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'RPresto'</span><span class="op">)</span></code></pre></div>
<p>MySQL 为例介绍 odbc 的连接和使用，详见 <a href="https://cosx.org/2020/06/connect-mysql-from-r/">从 R 连接 MySQL</a></p>
<div class="sourceCode" id="cb220"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb220-1"><a href="chap-data-transportation.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- !preview conn=DBI::dbConnect(odbc::odbc(),  driver = "MariaDB", database = "demo", </span></span>
<span id="cb220-2"><a href="chap-data-transportation.html#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="co">--                              uid = "root", pwd = "cloud", host = "localhost", port = 3306)</span></span>
<span id="cb220-3"><a href="chap-data-transportation.html#cb220-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-4"><a href="chap-data-transportation.html#cb220-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mtcars</span>
<span id="cb220-5"><a href="chap-data-transportation.html#cb220-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span></span></code></pre></div>
<p>我的系统已经安装了多款数据库的 ODBC 驱动</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb221-1"><a href="chap-data-transportation.html#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dnf</span> install <span class="at">-y</span> unixODBC unixODBC-devel mariadb mariadb-server mariadb-devel mariadb-connector-odbc</span></code></pre></div>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">odbc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/odbc/man/odbcListDrivers.html">odbcListDrivers</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code># Driver from the mariadb-connector-odbc package
# Setup from the unixODBC package
[MariaDB]
Description     = ODBC for MariaDB
Driver          = /usr/lib/libmaodbc.so
Driver64        = /usr/lib64/libmaodbc.so
FileUsage       = 1</code></pre>
</div>
<div id="sec-batch-import-csv" class="section level2" number="3.10">
<h2>
<span class="header-section-number">3.10</span> 批量读取 csv 文件<a class="anchor" aria-label="anchor" href="#sec-batch-import-csv"><i class="fas fa-link"></i></a>
</h2>
<p>iris 数据转化为 data.table 类型，按照 Species 分组拆成单独的 csv 文件，各个文件的文件名用鸢尾花的类别名表示</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 批量分组导出</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fwrite.html">fwrite</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/user_"</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">Species</span><span class="op">)</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">Species</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>读取文件夹 <code>data/</code> 所有 csv 数据文件</p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="va">merged_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"*.csv"</span>, path <span class="op">=</span> <span class="st">"data/"</span><span class="op">)</span>, <span class="va">fread</span> <span class="op">)</span> <span class="op">)</span>
<span class="co"># 或者</span>
<span class="va">merged_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"*.csv"</span>, path <span class="op">=</span> <span class="st">"data/"</span><span class="op">)</span>, <span class="va">fread</span> <span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xdf</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>
<span class="va">xdf</span><span class="op">$</span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">$</span><span class="va">ts</span><span class="op">)</span>, origin <span class="op">=</span> <span class="st">"1978-01-01"</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/split.html">split</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">$</span><span class="va">ts</span><span class="op">)</span>, <span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">$</span><span class="va">study</span>, <span class="va">xdf</span><span class="op">$</span><span class="va">port</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">.x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="op">]</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Filter</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>
  <span class="op">}</span>, <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind.data.frame</span>, <span class="va">.</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="va">xdf</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,
    ts <span class="op">=</span> <span class="fu">anytime</span><span class="fu">::</span><span class="fu">anytime</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">study</span>, <span class="va">port</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>

<span class="va">mtcars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>

<span class="va">mtcars</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">16</span>, width <span class="op">=</span> <span class="fl">69</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 32 × 11
##      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
##  2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
##  3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
##  4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
##  5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
##  6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
##  7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
##  8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
##  9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
## 10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
## 11  17.8     6  168.   123  3.92  3.44  18.9     1     0     4     4
## 12  16.4     8  276.   180  3.07  4.07  17.4     0     0     3     3
## 13  17.3     8  276.   180  3.07  3.73  17.6     0     0     3     3
## 14  15.2     8  276.   180  3.07  3.78  18       0     0     3     3
## 15  10.4     8  472    205  2.93  5.25  18.0     0     0     3     4
## 16  10.4     8  460    215  3     5.42  17.8     0     0     3     4
## # … with 16 more rows</code></pre>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">.</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 32 × 11
##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
## 2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
## 3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
## 4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
## 5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
## 6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
## 7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
## 8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
## # … with 24 more rows</code></pre>
</div>
<div id="sec-batch-export-xlsx" class="section level2" number="3.11">
<h2>
<span class="header-section-number">3.11</span> 批量导出 xlsx 文件<a class="anchor" aria-label="anchor" href="#sec-batch-export-xlsx"><i class="fas fa-link"></i></a>
</h2>
<p>将 R 环境中的数据集导出为 xlsx 表格</p>
<div class="sourceCode" id="cb231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 加载 openxlsx 包</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ycphs.github.io/openxlsx/index.html">openxlsx</a></span><span class="op">)</span>
<span class="co">## 创建空白的工作薄，标题为鸢尾花数据集</span>
<span class="va">wb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/createWorkbook.html">createWorkbook</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"鸢尾花数据集"</span><span class="op">)</span>
<span class="co">## 添加 sheet 页</span>
<span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/addWorksheet.html">addWorksheet</a></span><span class="op">(</span><span class="va">wb</span>, sheetName <span class="op">=</span> <span class="st">"iris"</span><span class="op">)</span>
<span class="co"># 将数据写进 sheet 页</span>
<span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/writeData.html">writeData</a></span><span class="op">(</span><span class="va">wb</span>, sheet <span class="op">=</span> <span class="st">"iris"</span>, x <span class="op">=</span> <span class="va">iris</span>, colNames <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># 导出数据到本地</span>
<span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/saveWorkbook.html">saveWorkbook</a></span><span class="op">(</span><span class="va">wb</span>, file <span class="op">=</span> <span class="st">"iris.xlsx"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ycphs.github.io/openxlsx/index.html">openxlsx</a></span><span class="op">)</span>
<span class="va">xlsxFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"readTest.xlsx"</span>, package <span class="op">=</span> <span class="st">"openxlsx"</span><span class="op">)</span>
<span class="co"># 导入</span>
<span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/read.xlsx.html">read.xlsx</a></span><span class="op">(</span>xlsxFile <span class="op">=</span> <span class="va">xlsxFile</span><span class="op">)</span>
<span class="co"># 导出</span>
<span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/write.xlsx.html">write.xlsx</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">xlsxfile</span><span class="op">)</span></code></pre></div>
</div>
<div id="dm-session-info" class="section level2" number="3.12">
<h2>
<span class="header-section-number">3.12</span> 运行环境<a class="anchor" aria-label="anchor" href="#dm-session-info"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">xfun</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xfun/man/session_info.html">session_info</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   askpass_1.1        assertthat_0.2.1   base64enc_0.1-3    blob_1.2.2        
##   bookdown_0.24      brio_1.1.2         bslib_0.3.0        cli_3.0.1         
##   codetools_0.2.18   colorspace_2.0-2   compiler_4.1.1     config_0.3.1      
##   cpp11_0.3.1        crayon_1.4.1       curl_4.3.2         data.table_1.14.0 
##   DBI_1.1.1          dbplyr_2.1.1       digest_0.6.27      downlit_0.2.1     
##   dplyr_1.0.7        ellipsis_0.3.2     evaluate_0.14      fansi_0.5.0       
##   farver_2.1.0       fastmap_1.1.0      forge_0.2.0        fs_1.5.0          
##   generics_0.1.0     ggplot2_3.3.5      globals_0.14.0     glue_1.4.2        
##   graphics_4.1.1     grDevices_4.1.1    grid_4.1.1         gtable_0.3.0      
##   highr_0.9          htmltools_0.5.2    htmlwidgets_1.5.3  httr_1.4.2        
##   isoband_0.2.5      jquerylib_0.1.4    jsonlite_1.7.2     knitr_1.33        
##   labeling_0.4.2     lattice_0.20.44    lifecycle_1.0.0    magrittr_2.0.1    
##   markdown_1.1       MASS_7.3.54        Matrix_1.3.4       methods_4.1.1     
##   mgcv_1.8.36        mime_0.11          munsell_0.5.0      nlme_3.1.152      
##   openssl_1.4.5      parallel_4.1.1     pillar_1.6.2       pkgconfig_2.0.3   
##   png_0.1-7          purrr_0.3.4        r2d3_0.2.5         R6_2.5.1          
##   rappdirs_0.3.3     RColorBrewer_1.1.2 rlang_0.4.11       rmarkdown_2.10    
##   rprojroot_2.0.2    rstudioapi_0.13    sass_0.4.0         scales_1.1.1      
##   sparklyr_1.7.1     splines_4.1.1      stats_4.1.1        stringi_1.7.4     
##   stringr_1.4.0      sys_3.4            tibble_3.1.4       tidyr_1.1.3       
##   tidyselect_1.1.1   tinytex_0.33       tools_4.1.1        utf8_1.2.2        
##   utils_4.1.1        uuid_0.1.4         vctrs_0.3.8        viridisLite_0.4.0 
##   withr_2.4.2        xfun_0.25          xml2_1.3.2         yaml_2.2.1</code></pre>

</div>
</div>
<h3>参考文献</h3>
<div id="refs" class="references csl-bib-body">
<div id="ref-xie2015" class="csl-entry">
<div class="csl-left-margin">[10] </div>
<div class="csl-right-inline">Y. Xie, <em>Dynamic documents with <span>R</span> and knitr</em>, 2nd ed. Boca Raton, Florida: Chapman; Hall/CRC, 2015.Available: <a href="https://yihui.org/knitr/">https://yihui.org/knitr/</a>
</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="chap-data-structure.html"><span class="header-section-number">2</span> 数据结构</a></div>
<div class="next"><a href="chap-string-operations.html"><span class="header-section-number">4</span> 字符串操作</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-data-transportation"><span class="header-section-number">3</span> 数据搬运</a></li>
<li>
<a class="nav-link" href="#import-data"><span class="header-section-number">3.1</span> 导入数据</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#scan-file"><span class="header-section-number">3.1.1</span> scan</a></li>
<li><a class="nav-link" href="#read-write-table"><span class="header-section-number">3.1.2</span> read.table</a></li>
<li><a class="nav-link" href="#read-write-lines"><span class="header-section-number">3.1.3</span> readLines</a></li>
<li><a class="nav-link" href="#read-save-rds"><span class="header-section-number">3.1.4</span> readRDS</a></li>
</ul>
</li>
<li><a class="nav-link" href="#other-data-source"><span class="header-section-number">3.2</span> 其它数据格式</a></li>
<li><a class="nav-link" href="#import-large-dataset"><span class="header-section-number">3.3</span> 导入大数据集</a></li>
<li>
<a class="nav-link" href="#import-data-from-database"><span class="header-section-number">3.4</span> 从数据库导入</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#postgresql"><span class="header-section-number">3.4.1</span> PostgreSQL</a></li>
<li><a class="nav-link" href="#mysql"><span class="header-section-number">3.4.2</span> MySQL</a></li>
<li><a class="nav-link" href="#spark"><span class="header-section-number">3.4.3</span> Spark</a></li>
</ul>
</li>
<li><a class="nav-link" href="#batch-import-data"><span class="header-section-number">3.5</span> 批量导入数据</a></li>
<li><a class="nav-link" href="#batch-export-data"><span class="header-section-number">3.6</span> 批量导出数据</a></li>
<li>
<a class="nav-link" href="#export-data"><span class="header-section-number">3.7</span> 导出数据</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#export-output"><span class="header-section-number">3.7.1</span> 导出运行结果</a></li>
<li><a class="nav-link" href="#export-data-object"><span class="header-section-number">3.7.2</span> 导出数据对象</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec-spark-with-r"><span class="header-section-number">3.8</span> Spark 与 R 语言</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#subsec-sparklyr"><span class="header-section-number">3.8.1</span> sparklyr</a></li>
<li><a class="nav-link" href="#subsec-sparkr"><span class="header-section-number">3.8.2</span> SparkR</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec-database-with-r"><span class="header-section-number">3.9</span> 数据库与 R 语言</a></li>
<li><a class="nav-link" href="#sec-batch-import-csv"><span class="header-section-number">3.10</span> 批量读取 csv 文件</a></li>
<li><a class="nav-link" href="#sec-batch-export-xlsx"><span class="header-section-number">3.11</span> 批量导出 xlsx 文件</a></li>
<li><a class="nav-link" href="#dm-session-info"><span class="header-section-number">3.12</span> 运行环境</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/XiangyunHuang/masr/blob/devel/data-transportation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/XiangyunHuang/masr/edit/devel/data-transportation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>现代应用统计与 R 语言</strong>: Modern Applied Statistics with R" was written by 黄湘云. It was last built on 2021-09-06.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
