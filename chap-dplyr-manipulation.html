<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 9 章 净土化操作 | 现代应用统计与 R 语言</title>
<meta name="author" content="黄湘云">
<meta name="description" content="常用操作和高频问题需要合并进之前的 data-manipulation，本章只介绍向量化计算 以 dplyr 为核心的 tidyverse 风数据操作 管道风操作 在不同规模的数据集上，Base R，dplyr 和 data.table 的处理性能应该属于低、中、高档搭配的情形 更加高级的数据变形操作，特别是数据类型的一致性，方便后续的可视化和建模，引入...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="第 9 章 净土化操作 | 现代应用统计与 R 语言">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/cover.png">
<meta property="og:description" content="常用操作和高频问题需要合并进之前的 data-manipulation，本章只介绍向量化计算 以 dplyr 为核心的 tidyverse 风数据操作 管道风操作 在不同规模的数据集上，Base R，dplyr 和 data.table 的处理性能应该属于低、中、高档搭配的情形 更加高级的数据变形操作，特别是数据类型的一致性，方便后续的可视化和建模，引入...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第 9 章 净土化操作 | 现代应用统计与 R 语言">
<meta name="twitter:description" content="常用操作和高频问题需要合并进之前的 data-manipulation，本章只介绍向量化计算 以 dplyr 为核心的 tidyverse 风数据操作 管道风操作 在不同规模的数据集上，Base R，dplyr 和 data.table 的处理性能应该属于低、中、高档搭配的情形 更加高级的数据变形操作，特别是数据类型的一致性，方便后续的可视化和建模，引入...">
<meta name="twitter:image" content="/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap/bootstrap.bundle.min.js"></script><script src="libs/bs3compat/transition.js"></script><script src="libs/bs3compat/tabs.js"></script><script src="libs/bs3compat/bs3compat.js"></script><link href="libs/bs4_book/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book/bs4_book.js"></script><script src="libs/htmlwidgets/htmlwidgets.js"></script><script src="libs/plotly-binding/plotly.js"></script><script src="libs/typedarray/typedarray.min.js"></script><link href="libs/crosstalk/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main/plotly-latest.min.js"></script><script src="libs/plotly-locale-zh-CN/zh-cn.js"></script><script src="libs/mathjax/cdn.js"></script><script src="libs/echarts4r/echarts-en.min.js"></script><script src="libs/echarts4r/ecStat.min.js"></script><script src="libs/echarts4r/dataTool.min.js"></script><script src="libs/echarts4r-binding/echarts4r.js"></script><script src="libs/d3/d3.min.js"></script><script src="libs/forceNetwork-binding/forceNetwork.js"></script><link href="libs/vis/vis-network.min.css" rel="stylesheet">
<script src="libs/vis/vis-network.min.js"></script><script src="libs/visNetwork-binding/visNetwork.js"></script><script src="libs/FileSaver/FileSaver.min.js"></script><script src="libs/Blob/Blob.js"></script><script src="libs/canvas-toBlob/canvas-toBlob.js"></script><script src="libs/html2canvas/html2canvas.js"></script><script src="libs/jspdf/jspdf.debug.js"></script><link href="libs/jquery-sparkline/jquery.sparkline.css" rel="stylesheet">
<script src="libs/jquery-sparkline/jquery.sparkline.js"></script><script src="libs/sparkline-binding/sparkline.js"></script><script src="libs/r2d3-render/r2d3-render.js"></script><script src="libs/webcomponents/webcomponents.js"></script><script src="libs/r2d3-binding/r2d3.js"></script><script src="libs/d3v6/d3.min.js"></script><script src="libs/kePrint/kePrint.js"></script><link href="libs/lightable/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-54GQKWF7VP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-54GQKWF7VP');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Modern Applied Statistics with R">现代应用统计与 R 语言</a>:
        <small class="text-muted">Modern Applied Statistics with R</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">欢迎</a></li>
<li><a class="" href="chap-preface.html"><span class="header-section-number">1</span> 前言</a></li>
<li class="book-part">数据整理</li>
<li><a class="" href="chap-data-wrangling.html">介绍</a></li>
<li><a class="" href="chap-data-structure.html"><span class="header-section-number">2</span> 数据结构</a></li>
<li><a class="" href="chap-data-transportation.html"><span class="header-section-number">3</span> 数据搬运</a></li>
<li><a class="" href="chap-string-operations.html"><span class="header-section-number">4</span> 字符串操作</a></li>
<li><a class="" href="chap-regular-expressions.html"><span class="header-section-number">5</span> 正则表达式</a></li>
<li><a class="" href="chap-data-manipulation.html"><span class="header-section-number">6</span> 数据操作</a></li>
<li><a class="" href="chap-advanced-manipulation.html"><span class="header-section-number">7</span> 高级数据操作</a></li>
<li><a class="" href="chap-parallel-manipulation.html"><span class="header-section-number">8</span> 并行化操作</a></li>
<li><a class="active" href="chap-dplyr-manipulation.html"><span class="header-section-number">9</span> 净土化操作</a></li>
<li class="book-part">统计图形</li>
<li><a class="" href="chap-statistical-graphics.html">介绍</a></li>
<li><a class="" href="chap-graphics-foundations.html"><span class="header-section-number">10</span> 图形基础</a></li>
<li><a class="" href="chap-data-visualization.html"><span class="header-section-number">11</span> 数据可视化</a></li>
<li><a class="" href="chap-interactive-web-graphics.html"><span class="header-section-number">12</span> 交互图形</a></li>
<li><a class="" href="chap-numerical-optimization.html"><span class="header-section-number">13</span> 数值优化</a></li>
<li class="book-part">附录</li>
<li><a class="" href="chap-linux-command-bash.html"><span class="header-section-number">A</span> 命令行操作</a></li>
<li><a class="" href="references.html">参考文献</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/XiangyunHuang/masr">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-dplyr-manipulation" class="section level1" number="9">
<h1>
<span class="header-section-number">第 9 章</span> 净土化操作<a class="anchor" aria-label="anchor" href="#chap-dplyr-manipulation"><i class="fas fa-link"></i></a>
</h1>
<blockquote>
<p>常用操作和高频问题需要合并进之前的 data-manipulation，本章只介绍向量化计算
以 dplyr 为核心的 tidyverse 风数据操作 管道风操作</p>
</blockquote>
<p>在不同规模的数据集上，Base R，dplyr 和 data.table 的处理性能应该属于低、中、高档搭配的情形</p>
<div class="sidebar">
<p>更加高级的数据变形操作，特别是数据类型的一致性，方便后续的可视化和建模，引入 tidyverse，数据处理或者叫特征工程 Base R vs data.table vs dplyr 它们各有优点，所以都加以介绍 参考 <a href="https://jozef.io/categories/rcase4base/">Jozef Hajnala</a> 博文。</p>
<p>关于 tidyverse 提供的数据操作不要移动到 Base R 对应的章节，这二者已经越行越远，本章主要讲并行或分布式数据操作工具，如 sparklyr 针对大数据集上的操</p>
<p>Base R 的数据操作的一致性问题参见统计之都帖子 <a href="https://d.cosx.org/d/420763" class="uri">https://d.cosx.org/d/420763</a></p>
<p><a href="https://malco.io/">Malcolm Barrett</a> 以幻灯片的形式呈现 <a href="https://malco.io/slides/hs_dplyr/">dplyr</a> 和 <a href="https://malco.io/slides/hs_purrr/">purrr</a> 的基础用法</p>
<p>Charlotte Wickham 的课程 A introduction to purrr <a href="https://github.com/cwickham/purrr-tutorial">purrr-tutorial</a></p>
<p>关于引用 <a href="https://github.com/cwickham/quotation">quotation</a></p>
<p>相比于 SQL， dplyr 在数据库操作的不足，这是一些比较难的部分 <a href="https://dbi.r-dbi.org/articles/dbi-1#sec:open-issues" class="uri">https://dbi.r-dbi.org/articles/dbi-1#sec:open-issues</a></p>
</div>
<p>函数式编程 Functional Programming Languages 用于数据处理</p>
<ul>
<li>
<a href="https://github.com/smartinsightsfromdata/rpivotTable">rpivotTable</a> 动态数据透视表</li>
<li>
<a href="https://github.com/dgrtwo/fuzzyjoin">fuzzyjoin</a> Join tables together on inexact matching</li>
<li>
<a href="https://github.com/hadley/dtplyr">dtplyr</a> dtplyr is the data.table backend for dplyr. It provides S3 methods for data.table objects so that dplyr works the way you expect.</li>
<li>
<a href="https://github.com/yonicd/bplyr">bplyr</a> basic dplyr and tidyr functionality without the tidyverse dependencies</li>
<li>
<a href="https://github.com/OHDSI/SqlRender">SqlRender</a> 基于 Java 语言，借助 rJava 包支持参数化的 SQL 语句，并且可以将一种 SQL 语句（如 Microsoft SQL Server）转化为多种SQL语句（如Oracle, PostgreSQL, Amazon RedShift, Impala, IBM Netezza, Google BigQuery, Microsoft PDW, and SQLite）</li>
<li>
<a href="https://github.com/wch/fastmap">fastmap</a> 实现键值存储，提供新的数据结构</li>
<li>
<a href="https://github.com/RoaringBitmap/CRoaring">Roaring bitmaps</a> Bitsets, also called bitmaps, are commonly used as fast data structures.</li>
</ul>
<div class="sourceCode" id="cb1267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<p>数据操作的语法</p>
<p>第一代</p>
<ol style="list-style-type: decimal">
<li>Base R 数据操作已在第 <a href="chap-data-manipulation.html#chap-data-manipulation">6</a> 章详细介绍</li>
</ol>
<p>第二代</p>
<ol style="list-style-type: decimal">
<li>reshape （退休）使用函数 <code>melt</code> 和 <code>cast</code> 重构(restructure)和聚合(aggregate)数据</li>
<li>reshape2 （退休）是 reshape 的继任者，功能和 reshape 类似，提供两个函数 <code>melt</code> 和 <code>cast</code> 聚合数据，因此不再介绍 reshape，而鉴于 reshape2 还在活跃使用中，故而以它为例介绍 <code>melt</code> 和 <code>cast</code> 函数</li>
<li>plyr （退休）统一拆分(split)，计算(apply)，合并(combine)的数据处理流，由 dplyr（用于data.frame） 和 purrr （用于 list）继任</li>
</ol>
<p>第三代</p>
<ol style="list-style-type: decimal">
<li>dplyr 操作数据的语法及其扩展</li>
<li>sparklyr 给 dplyr 提供 Spark 接口支持</li>
<li>dbplyr 给 dplyr 提供 DBI 数据库接口支持</li>
<li>dtplyr 给 dplyr 提供 data.table 支持</li>
<li>tidyr 提供 <code>spread</code> 和 <code>gather</code> 两个函数清洗数据</li>
</ol>
<p>Garrett Grolemund 在 RStudio 主要从事教育教学，参考 <a href="https://github.com/rstudio-education/teach-tidy">Materials for the Tidyverse Train-the-trainer workshop</a> 和 <a href="https://rstudio-education.github.io/tidyverse-cookbook/">The Tidyverse Cookbook</a></p>
<p>Dirk Eddelbuettel 的 <a href="https://github.com/eddelbuettel/gsir-te">Getting Started in R – Tinyverse Edition</a></p>
<div id="common-operations" class="section level2" number="9.1">
<h2>
<span class="header-section-number">9.1</span> 常用操作<a class="anchor" aria-label="anchor" href="#common-operations"><i class="fas fa-link"></i></a>
</h2>
<p>dplyr 由 Hadley Wickham 主要由开发和维护，是Rstudio公司开源的用于数据处理的一大利器，该包号称“数据操作的语法”，与 ggplot2 对应，也就是说数据处理那一套已经建立完整的和SQL一样的功能。它们都遵循同样的处理逻辑，只不过一个用SQL写，一个用R语言写，处理效率差不多，R语言写的 SQL 会被翻译为 SQL 语句，再传至数据库查询，当然它也支持内存内的数据操作。目前 dplyr 以 dbplyr 为后端支持的数据库有：MySQL、PostgreSQL，SQLite等，完整的支持列表请看 <a href="https://dplyr.tidyverse.org">这里</a>，连接特定数据库，都是基于 DBI，DBI 即 Database Interface， 是使用C/C++开发的底层数据库接口，是一个统一的关系型数据库连接框架，需要根据不同的具体的数据库进行实例化，才可使用。</p>
<p>dplyr 常用的函数是 7 个： <code>arrange</code> 排序 <code>filter</code> 过滤行 <code>select</code> 选择列 <code>mutate</code> 变换 <code>summarise</code> 汇总 <code>group_by</code> 分组 <code>distinct</code> 去重</p>
<p>以 ggplot2 包自带的钻石数据集 diamonds 为例介绍</p>
<div id="tibble-show" class="section level3" number="9.1.1">
<h3>
<span class="header-section-number">9.1.1</span> 查看<a class="anchor" aria-label="anchor" href="#tibble-show"><i class="fas fa-link"></i></a>
</h3>
<p>除了直接打印数据集的前几行，tibble 包还提供 glimpse 函数查看数据集，而 Base R 默认查看方式是调用 str 函数</p>
<div class="sourceCode" id="cb1268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds</span></code></pre></div>
<pre><code>## # A tibble: 53,940 × 10
##    carat cut       color clarity depth table price     x     y     z
##    &lt;dbl&gt; &lt;ord&gt;     &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  0.23 Ideal     E     SI2      61.5    55   326  3.95  3.98  2.43
##  2  0.21 Premium   E     SI1      59.8    61   326  3.89  3.84  2.31
##  3  0.23 Good      E     VS1      56.9    65   327  4.05  4.07  2.31
##  4  0.29 Premium   I     VS2      62.4    58   334  4.2   4.23  2.63
##  5  0.31 Good      J     SI2      63.3    58   335  4.34  4.35  2.75
##  6  0.24 Very Good J     VVS2     62.8    57   336  3.94  3.96  2.48
##  7  0.24 Very Good I     VVS1     62.3    57   336  3.95  3.98  2.47
##  8  0.26 Very Good H     SI1      61.9    55   337  4.07  4.11  2.53
##  9  0.22 Fair      E     VS2      65.1    61   337  3.87  3.78  2.49
## 10  0.23 Very Good H     VS1      59.4    61   338  4     4.05  2.39
## # … with 53,930 more rows</code></pre>
<div class="sourceCode" id="cb1270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 53,940
## Columns: 10
## $ carat   &lt;dbl&gt; 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.…
## $ cut     &lt;ord&gt; Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver…
## $ color   &lt;ord&gt; E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,…
## $ clarity &lt;ord&gt; SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, …
## $ depth   &lt;dbl&gt; 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64…
## $ table   &lt;dbl&gt; 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58…
## $ price   &lt;int&gt; 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34…
## $ x       &lt;dbl&gt; 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.…
## $ y       &lt;dbl&gt; 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.…
## $ z       &lt;dbl&gt; 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.…</code></pre>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:dplyr-object-type">表 9.1: </span> dplyr 定义的数据对象类型</caption>
<thead><tr class="header">
<th align="left">类型</th>
<th align="left">含义</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">int</td>
<td align="left">整型 integer</td>
</tr>
<tr class="even">
<td align="left">dbl</td>
<td align="left">（单）双精度浮点类型</td>
</tr>
<tr class="odd">
<td align="left">chr</td>
<td align="left">字符（串）类型</td>
</tr>
<tr class="even">
<td align="left">dttm</td>
<td align="left">data-time 类型</td>
</tr>
<tr class="odd">
<td align="left">lgl</td>
<td align="left">布尔类型</td>
</tr>
<tr class="even">
<td align="left">fctr</td>
<td align="left">因子类型 factor</td>
</tr>
<tr class="odd">
<td align="left">date</td>
<td align="left">日期类型</td>
</tr>
</tbody>
</table></div>
<p>表 <a href="chap-dplyr-manipulation.html#tab:dplyr-object-type">9.1</a> 中 dttm 和 date 类型代指 lubridate 包指定的日期对象 POSIXct、 POSIXlt、 Date、 chron、 yearmon、 yearqtr、 zoo、 zooreg、 timeDate、 xts、 its、 ti、 jul、 timeSeries 和 fts。</p>
</div>
<div id="dplyr-filter" class="section level3" number="9.1.2">
<h3>
<span class="header-section-number">9.1.2</span> 筛选<a class="anchor" aria-label="anchor" href="#dplyr-filter"><i class="fas fa-link"></i></a>
</h3>
<p>按条件筛选数据的子集，按行筛选</p>
<div class="sourceCode" id="cb1272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cut</span> <span class="op">==</span> <span class="st">"Ideal"</span> , <span class="va">carat</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 4 × 10
##   carat cut   color clarity depth table price     x     y     z
##   &lt;dbl&gt; &lt;ord&gt; &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  3.22 Ideal I     I1       62.6    55 12545  9.49  9.42  5.92
## 2  3.5  Ideal H     I1       62.8    57 12587  9.65  9.59  6.03
## 3  3.01 Ideal J     SI2      61.7    58 16037  9.25  9.2   5.69
## 4  3.01 Ideal J     I1       65.4    60 16538  8.99  8.93  5.86</code></pre>
<p>先按行，再按列筛选</p>
<div class="sourceCode" id="cb1274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">carat</span> <span class="op">&gt;=</span> <span class="fl">3</span>, <span class="va">color</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">carat</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 16 × 2
##    cut       carat
##    &lt;ord&gt;     &lt;dbl&gt;
##  1 Premium    3.01
##  2 Fair       3.02
##  3 Good       3   
##  4 Ideal      3.22
##  5 Premium    4.01
##  6 Very Good  3.04
##  7 Very Good  4   
##  8 Premium    3.67
##  9 Premium    3   
## 10 Fair       3   
## 11 Premium    3.01
## 12 Fair       3.01
## 13 Fair       3.01
## 14 Good       3.01
## 15 Good       3.01
## 16 Premium    3.04</code></pre>
</div>
<div id="dplyr-arrange" class="section level3" number="9.1.3">
<h3>
<span class="header-section-number">9.1.3</span> 排序<a class="anchor" aria-label="anchor" href="#dplyr-arrange"><i class="fas fa-link"></i></a>
</h3>
<p>arrange 默认升序排列，按钻石重量升序，按价格降序</p>
<div class="sourceCode" id="cb1276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cut</span> <span class="op">==</span> <span class="st">"Ideal"</span> , <span class="va">carat</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">carat</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">price</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 4 × 10
##   carat cut   color clarity depth table price     x     y     z
##   &lt;dbl&gt; &lt;ord&gt; &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  3.01 Ideal J     I1       65.4    60 16538  8.99  8.93  5.86
## 2  3.01 Ideal J     SI2      61.7    58 16037  9.25  9.2   5.69
## 3  3.22 Ideal I     I1       62.6    55 12545  9.49  9.42  5.92
## 4  3.5  Ideal H     I1       62.8    57 12587  9.65  9.59  6.03</code></pre>
</div>
<div id="dplyr-summarise" class="section level3" number="9.1.4">
<h3>
<span class="header-section-number">9.1.4</span> 聚合<a class="anchor" aria-label="anchor" href="#dplyr-summarise"><i class="fas fa-link"></i></a>
</h3>
<p>分组求和，求平均，计数</p>
<div class="sourceCode" id="cb1278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">carat</span> <span class="op">&gt;</span> <span class="fl">3</span>, <span class="va">color</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">clarity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>sum_carat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">carat</span><span class="op">)</span>, mean_carat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">carat</span><span class="op">)</span>, n_count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 8 × 5
## # Groups:   cut [5]
##   cut       clarity sum_carat mean_carat n_count
##   &lt;ord&gt;     &lt;ord&gt;       &lt;dbl&gt;      &lt;dbl&gt;   &lt;int&gt;
## 1 Fair      I1           3.02       3.02       1
## 2 Fair      SI2          6.02       3.01       2
## 3 Good      SI2          6.02       3.01       2
## 4 Very Good I1           4          4          1
## 5 Very Good SI2          3.04       3.04       1
## 6 Premium   I1          10.7        3.56       3
## 7 Premium   SI2          6.05       3.02       2
## 8 Ideal     I1           3.22       3.22       1</code></pre>
</div>
<div id="dplyr-merge" class="section level3" number="9.1.5">
<h3>
<span class="header-section-number">9.1.5</span> 合并<a class="anchor" aria-label="anchor" href="#dplyr-merge"><i class="fas fa-link"></i></a>
</h3>
<p>按行合并</p>
<div class="sourceCode" id="cb1280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2018</span><span class="op">)</span>
<span class="va">one</span> <span class="op">&lt;-</span> <span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">color</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="va">two</span> <span class="op">&lt;-</span> <span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">color</span> <span class="op">==</span> <span class="st">"J"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co"># 按行合并数据框 one 和 two</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">one</span>, <span class="va">two</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 10
##    carat cut       color clarity depth table price     x     y     z
##    &lt;dbl&gt; &lt;ord&gt;     &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  0.42 Ideal     I     VVS1     62.5  57     884  4.77  4.8   2.99
##  2  0.3  Ideal     I     VVS2     62.5  53.6   532  4.29  4.33  2.69
##  3  2.02 Good      I     VS1      57.9  63   17533  8.13  8.21  4.73
##  4  0.9  Premium   I     VS2      61.9  58    3398  6.18  6.23  3.84
##  5  1.98 Very Good I     VS2      62.7  60   15083  7.9   7.96  4.98
##  6  1.51 Very Good J     VVS2     62.6  63    8706  7.29  7.24  4.55
##  7  0.7  Very Good J     SI1      61.7  57    1979  5.65  5.69  3.5 
##  8  1.16 Premium   J     VS2      62.2  59    4702  6.74  6.69  4.18
##  9  1.5  Premium   J     VVS2     61.8  60    8760  7.36  7.33  4.54
## 10  1.51 Premium   J     SI1      60.4  62    6680  7.42  7.32  4.45</code></pre>
<p>按列合并</p>
<div class="sourceCode" id="cb1282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2018</span><span class="op">)</span>
<span class="va">three</span> <span class="op">&lt;-</span> <span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">carat</span>, <span class="va">color</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="va">four</span> <span class="op">&lt;-</span> <span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">carat</span>, <span class="va">color</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="va">three</span>, <span class="va">four</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 5 × 4
##   carat...1 color...2 carat...3 color...4
##       &lt;dbl&gt; &lt;ord&gt;         &lt;dbl&gt; &lt;ord&gt;    
## 1      0.33 H              0.52 F        
## 2      1.09 F              0.51 F        
## 3      1.52 I              0.5  G        
## 4      0.95 G              0.38 E        
## 5      0.35 E              0.51 J</code></pre>
</div>
<div id="dplyr-mutate" class="section level3" number="9.1.6">
<h3>
<span class="header-section-number">9.1.6</span> 变换<a class="anchor" aria-label="anchor" href="#dplyr-mutate"><i class="fas fa-link"></i></a>
</h3>
<p>添加一列，新的列或者改变原来的列</p>
<div class="sourceCode" id="cb1284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">carat</span> <span class="op">&gt;</span> <span class="fl">3</span>, <span class="va">color</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">carat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>vol <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">carat</span> <span class="op">&gt;</span> <span class="fl">3.5</span>, <span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 13 × 3
##    cut       carat vol  
##    &lt;ord&gt;     &lt;dbl&gt; &lt;chr&gt;
##  1 Premium    3.01 B    
##  2 Fair       3.02 B    
##  3 Ideal      3.22 B    
##  4 Premium    4.01 A    
##  5 Very Good  3.04 B    
##  6 Very Good  4    A    
##  7 Premium    3.67 A    
##  8 Premium    3.01 B    
##  9 Fair       3.01 B    
## 10 Fair       3.01 B    
## 11 Good       3.01 B    
## 12 Good       3.01 B    
## 13 Premium    3.04 B</code></pre>
</div>
<div id="dplyr-duplicated" class="section level3" number="9.1.7">
<h3>
<span class="header-section-number">9.1.7</span> 去重<a class="anchor" aria-label="anchor" href="#dplyr-duplicated"><i class="fas fa-link"></i></a>
</h3>
<p>数据去重在 dplyr 中的实现<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://stackoverflow.com/questions/22959635/" class="uri"&gt;https://stackoverflow.com/questions/22959635/&lt;/a&gt;&lt;/p&gt;'><sup>32</sup></a>。</p>
<div class="sourceCode" id="cb1286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
  z <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
<span class="op">)</span>
<span class="va">df</span></code></pre></div>
<pre><code>##    x y  z
## 1  0 1  1
## 2  0 1  2
## 3  0 1  3
## 4  1 0  4
## 5  0 1  5
## 6  1 0  6
## 7  1 1  7
## 8  1 0  8
## 9  0 0  9
## 10 0 0 10</code></pre>
<p>去掉列重复的数据点 (x, y)</p>
<div class="sourceCode" id="cb1288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 4 × 3
## # Groups:   x, y [4]
##       x     y     z
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     0     1     1
## 2     1     0     4
## 3     1     1     7
## 4     0     0     9</code></pre>
<div class="sourceCode" id="cb1290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 此处不对，没有了 z </span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
<pre><code>##   x y
## 1 0 1
## 2 1 0
## 3 1 1
## 4 0 0</code></pre>
<div class="sourceCode" id="cb1292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 应该为</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>##   x y z
## 1 0 1 1
## 2 1 0 4
## 3 1 1 7
## 4 0 0 9</code></pre>
</div>
</div>
<div id="common-dataframe-operations" class="section level2" number="9.2">
<h2>
<span class="header-section-number">9.2</span> 高频问题<a class="anchor" aria-label="anchor" href="#common-dataframe-operations"><i class="fas fa-link"></i></a>
</h2>
<p>常用的数据操作包含</p>
<ol style="list-style-type: decimal">
<li>创建空的数据框或者说初始化一个数据框，</li>
<li>按指定的列对数据框排序，</li>
<li>选择特定的一些列，复杂情况是可能需要正则表达式从列名或者值中筛选</li>
<li>合并两个数据框，分为 (inner outer left right) 四种情况</li>
<li>宽格式和长格式互相转换，即重塑操作 reshape，单独的 tidyr 包操作，是 reshape2 包的进化版，提供 <code>spread</code> 和 <code>gather</code> 两个主要函数</li>
</ol>
<div id="create-empty-dataframe" class="section level3" number="9.2.1">
<h3>
<span class="header-section-number">9.2.1</span> 初始化数据框<a class="anchor" aria-label="anchor" href="#create-empty-dataframe"><i class="fas fa-link"></i></a>
</h3>
<p>创建空的数据框，就是不包含任何行、记录</p>
<div class="sourceCode" id="cb1294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">empty_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  Doubles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="op">)</span>,
  Ints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="op">)</span>,
  Factors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span>,
  Logicals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html">logical</a></span><span class="op">(</span><span class="op">)</span>,
  Characters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,
  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">empty_df</span><span class="op">)</span></code></pre></div>
<pre><code>## 'data.frame':    0 obs. of  5 variables:
##  $ Doubles   : num 
##  $ Ints      : int 
##  $ Factors   : Factor w/ 0 levels: 
##  $ Logicals  : logi 
##  $ Characters: chr</code></pre>
<p>如果数据框 df 包含数据，现在要依据它创建一个空的数据框</p>
<div class="sourceCode" id="cb1296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">empty_df</span> <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="cn">FALSE</span>,<span class="op">]</span></code></pre></div>
<p>还可以使用 structure 构造一个数据框，并且我们发现它的效率更高</p>
<div class="sourceCode" id="cb1297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    Date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
    File <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,
    User <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>,
  class <span class="op">=</span> <span class="st">"data.frame"</span>
  <span class="op">)</span>
<span class="va">d</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    Date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
    File <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,
    User <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,
    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
<span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">s</span><span class="op">(</span><span class="op">)</span>, <span class="fu">d</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Unit: microseconds
##  expr   min     lq    mean median     uq    max neval
##   s()  19.5  23.65  59.536  28.60  32.05 2905.9   100
##   d() 211.7 218.50 252.934 222.75 227.50 2877.0   100</code></pre>
</div>
<div id="remove-missing-values" class="section level3" number="9.2.2">
<h3>
<span class="header-section-number">9.2.2</span> 移除缺失记录<a class="anchor" aria-label="anchor" href="#remove-missing-values"><i class="fas fa-link"></i></a>
</h3>
<p>只要行中包含缺失值，我们就把这样的行移除出去</p>
<div class="sourceCode" id="cb1299"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     Ozone Solar.R Wind Temp Month Day
## 1      41     190  7.4   67     5   1
## 2      36     118  8.0   72     5   2
## 3      12     149 12.6   74     5   3
## 4      18     313 11.5   62     5   4
## 7      23     299  8.6   65     5   7
....</code></pre>
</div>
<div id="coerce-data-type" class="section level3" number="9.2.3">
<h3>
<span class="header-section-number">9.2.3</span> 数据类型转化<a class="anchor" aria-label="anchor" href="#coerce-data-type"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">PlantGrowth</span><span class="op">)</span></code></pre></div>
<pre><code>## 'data.frame':    30 obs. of  2 variables:
##  $ weight: num  4.17 5.58 5.18 6.11 4.5 4.61 5.17 4.53 5.33 5.14 ...
##  $ group : Factor w/ 3 levels "ctrl","trt1",..: 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
<div class="sourceCode" id="cb1303"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bob</span> <span class="op">&lt;-</span> <span class="va">PlantGrowth</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">bob</span>, <span class="va">is.factor</span><span class="op">)</span>
<span class="va">bob</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">bob</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">as.character</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">bob</span><span class="op">)</span></code></pre></div>
<pre><code>## 'data.frame':    30 obs. of  2 variables:
##  $ weight: num  4.17 5.58 5.18 6.11 4.5 4.61 5.17 4.53 5.33 5.14 ...
##  $ group : chr  "ctrl" "ctrl" "ctrl" "ctrl" ...</code></pre>
</div>
<div id="cross-group-by" class="section level3" number="9.2.4">
<h3>
<span class="header-section-number">9.2.4</span> 跨列分组求和<a class="anchor" aria-label="anchor" href="#cross-group-by"><i class="fas fa-link"></i></a>
</h3>
<p>输入是一个数据框 data.frame，按照其中某一变量分组，然后计算任意数量的变量的行和和列和。</p>
<p>空气质量数据集 airquality 按月份 Month 分组，然后求取满足条件的列的和</p>
<div class="sourceCode" id="cb1305"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">$</span><span class="va">Month</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">gv</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">subdta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">airquality</span>, subset <span class="op">=</span> <span class="va">Month</span> <span class="op">==</span> <span class="va">gv</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    Colsum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">subdta</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"[mM]"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>,
    Month <span class="op">=</span> <span class="va">gv</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    Colsum Month
## 1    2032     5
## 2     155     5
## 3    2373     6
## 4     180     6
## 5    2601     7
## 6     217     7
## 7    2603     8
## 8     248     8
## 9    2307     9
## 10    270     9</code></pre>
<p>什么是函数式编程，R 语言环境下的函数式编程是如何操作的</p>
</div>
</div>
<div id="pipe-manipulation" class="section level2" number="9.3">
<h2>
<span class="header-section-number">9.3</span> 管道操作<a class="anchor" aria-label="anchor" href="#pipe-manipulation"><i class="fas fa-link"></i></a>
</h2>
<p><a href="http://stefanbache.dk/">Stefan Milton Bache</a> 开发了 <a href="https://github.com/tidyverse/magrittr">magrittr</a> 包实现管道操作，增加代码的可读性和维护性，但是这个 R 包的名字取的太奇葩，因为 <a href="https://d.cosx.org/d/420697/21">记不住</a>，它其实是一个复杂的<a href="https://magrittr.tidyverse.org/articles/magrittr.html">法语发音</a>，中式英语就叫它马格里特吧！这下应该好记多了吧！</p>
<p>我要查看是否需要新添加一个 R 包依赖，假设该 R 包是 reticulate 没有出现在 DESCRIPTION 文件中，但是可能已经被其中某（个）些 R 包依赖了</p>
<div class="sourceCode" id="cb1307"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="st">"reticulate"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/package_dependencies.html">package_dependencies</a></span><span class="op">(</span><span class="fu">desc</span><span class="fu">::</span><span class="fu"><a href="http://r-lib.github.io/desc/reference/desc_get_deps.html">desc_get_deps</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">package</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>安装 pkg 的依赖</p>
<div class="sourceCode" id="cb1309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"bookdown"</span>,
  <span class="st">"e1071"</span>,
  <span class="st">"formatR"</span>,
  <span class="st">"lme4"</span>,
  <span class="st">"mvtnorm"</span>,
  <span class="st">"prettydoc"</span>, <span class="st">"psych"</span>,
  <span class="st">"reticulate"</span>, <span class="st">"rstan"</span>, <span class="st">"rstanarm"</span>, <span class="st">"rticles"</span>,
  <span class="st">"svglite"</span>,
  <span class="st">"TMB"</span>, <span class="st">"glmmTMB"</span>
<span class="op">)</span>
<span class="co"># 获取 pkg 的所有依赖</span>
<span class="va">dep_pkg</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/package_dependencies.html">package_dependencies</a></span><span class="op">(</span><span class="va">pkg</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># 将列表 list 合并为向量 vector</span>
<span class="va">merge_pkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="va">dep_pkg</span>, accumulate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># 所有未安装的 R 包</span>
<span class="va">miss_pkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">merge_pkg</span><span class="op">)</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/zpackages.html">.packages</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># 除了 pkg 外，未安装的 R 包，安装 pkg 的依赖</span>
<span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="va">miss_pkg</span>, <span class="va">pkg</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "mnormt"  "tmvnsim"</code></pre>
<p>转化为管道操作，增加可读性</p>
<blockquote>
<p>再举一个关于数据模拟的例子</p>
</blockquote>
<p>模拟 0-1 序列，</p>
<div class="sourceCode" id="cb1311"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2019</span><span class="op">)</span>
<span class="va">binom_sample</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">n</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.2</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">n</span>
<span class="op">}</span>
<span class="co"># 频率估计概率</span>
<span class="va">one_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span>, <span class="va">binom_sample</span><span class="op">)</span>
<span class="co"># 估计的误差</span>
<span class="va">one_abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">one_prob</span> <span class="op">-</span> <span class="fl">0.2</span><span class="op">)</span>
<span class="va">one_abs</span></code></pre></div>
<pre><code>## [1] 1.000e-01 1.000e-02 1.100e-02 4.400e-03 1.460e-03 3.980e-04 4.700e-06
## [8] 9.552e-05</code></pre>
<p>似然估计</p>
</div>
<div id="dm-dplyr-rsession" class="section level2" number="9.4">
<h2>
<span class="header-section-number">9.4</span> 运行环境<a class="anchor" aria-label="anchor" href="#dm-dplyr-rsession"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb1313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">xfun</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xfun/man/session_info.html">session_info</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R version 4.2.0 (2022-04-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.4 LTS
## 
## Locale:
##   LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##   LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##   LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##   LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##   LC_ADDRESS=C               LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## Package version:
##   askpass_1.1          assertthat_0.2.1     backports_1.4.1     
##   base64enc_0.1.3      bit_4.0.4            bit64_4.0.5         
##   blob_1.2.3           bookdown_0.26        brio_1.1.3          
##   broom_0.8.0          bslib_0.3.1          cachem_1.0.6        
##   callr_3.7.0          cellranger_1.1.0     cli_3.3.0           
##   clipr_0.8.0          colorspace_2.0-3     compiler_4.2.0      
##   cpp11_0.4.2          crayon_1.5.1         curl_4.3.2          
##   data.table_1.14.2    DBI_1.1.2            dbplyr_2.1.1        
##   desc_1.4.1           digest_0.6.29        downlit_0.4.0       
##   dplyr_1.0.9          dtplyr_1.2.1         ellipsis_0.3.2      
##   evaluate_0.15        fansi_1.0.3          farver_2.1.0        
##   fastmap_1.1.0        forcats_0.5.1        fs_1.5.2            
##   gargle_1.2.0         generics_0.1.2       ggplot2_3.3.6       
##   glue_1.6.2           googledrive_2.0.0    googlesheets4_1.0.0 
##   graphics_4.2.0       grDevices_4.2.0      grid_4.2.0          
##   gtable_0.3.0         haven_2.5.0          highr_0.9           
##   hms_1.1.1            htmltools_0.5.2      httr_1.4.3          
##   ids_1.0.1            isoband_0.2.5        jquerylib_0.1.4     
##   jsonlite_1.8.0       knitr_1.39           labeling_0.4.2      
##   lattice_0.20.45      lifecycle_1.0.1      lubridate_1.8.0     
##   magrittr_2.0.3       MASS_7.3.57          Matrix_1.4.1        
##   memoise_2.0.1        methods_4.2.0        mgcv_1.8.40         
##   microbenchmark_1.4.9 mime_0.12            modelr_0.1.8        
##   munsell_0.5.0        nlme_3.1.157         openssl_2.0.1       
##   pillar_1.7.0         pkgconfig_2.0.3      prettyunits_1.1.1   
##   processx_3.5.3       progress_1.2.2       ps_1.7.0            
##   purrr_0.3.4          R6_2.5.1             rappdirs_0.3.3      
##   RColorBrewer_1.1.3   readr_2.1.2          readxl_1.4.0        
##   rematch_1.0.1        rematch2_2.1.2       reprex_2.0.1        
##   rlang_1.0.2          rmarkdown_2.14       rprojroot_2.0.3     
##   rstudioapi_0.13      rvest_1.0.2          sass_0.4.1          
##   scales_1.2.0         selectr_0.4.2        splines_4.2.0       
##   stats_4.2.0          stringi_1.7.6        stringr_1.4.0       
##   sys_3.4              sysfonts_0.8.8       tibble_3.1.7        
##   tidyr_1.2.0          tidyselect_1.1.2     tidyverse_1.3.1     
##   tinytex_0.39         tools_4.2.0          tzdb_0.3.0          
##   utf8_1.2.2           utils_4.2.0          uuid_1.1.0          
##   vctrs_0.4.1          viridisLite_0.4.0    vroom_1.5.7         
##   withr_2.5.0          xfun_0.31            xml2_1.3.3          
##   yaml_2.3.5</code></pre>

</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="chap-parallel-manipulation.html"><span class="header-section-number">8</span> 并行化操作</a></div>
<div class="next"><a href="chap-statistical-graphics.html">介绍</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-dplyr-manipulation"><span class="header-section-number">9</span> 净土化操作</a></li>
<li>
<a class="nav-link" href="#common-operations"><span class="header-section-number">9.1</span> 常用操作</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#tibble-show"><span class="header-section-number">9.1.1</span> 查看</a></li>
<li><a class="nav-link" href="#dplyr-filter"><span class="header-section-number">9.1.2</span> 筛选</a></li>
<li><a class="nav-link" href="#dplyr-arrange"><span class="header-section-number">9.1.3</span> 排序</a></li>
<li><a class="nav-link" href="#dplyr-summarise"><span class="header-section-number">9.1.4</span> 聚合</a></li>
<li><a class="nav-link" href="#dplyr-merge"><span class="header-section-number">9.1.5</span> 合并</a></li>
<li><a class="nav-link" href="#dplyr-mutate"><span class="header-section-number">9.1.6</span> 变换</a></li>
<li><a class="nav-link" href="#dplyr-duplicated"><span class="header-section-number">9.1.7</span> 去重</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#common-dataframe-operations"><span class="header-section-number">9.2</span> 高频问题</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#create-empty-dataframe"><span class="header-section-number">9.2.1</span> 初始化数据框</a></li>
<li><a class="nav-link" href="#remove-missing-values"><span class="header-section-number">9.2.2</span> 移除缺失记录</a></li>
<li><a class="nav-link" href="#coerce-data-type"><span class="header-section-number">9.2.3</span> 数据类型转化</a></li>
<li><a class="nav-link" href="#cross-group-by"><span class="header-section-number">9.2.4</span> 跨列分组求和</a></li>
</ul>
</li>
<li><a class="nav-link" href="#pipe-manipulation"><span class="header-section-number">9.3</span> 管道操作</a></li>
<li><a class="nav-link" href="#dm-dplyr-rsession"><span class="header-section-number">9.4</span> 运行环境</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/XiangyunHuang/masr/blob/devel/other-manipulation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/XiangyunHuang/masr/edit/devel/other-manipulation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>现代应用统计与 R 语言</strong>: Modern Applied Statistics with R" was written by 黄湘云. It was last built on 2022-05-29.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
